/*! genome-viewer June 22, 2016 15:43:59 */
/*! lib June 22, 2016 15:43:57 */
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

var Utils = {
    //properties
    characters: "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",

    number: {
        sign: function (x) {
            return x ? x < 0 ? -1 : 1 : 0;
        }
    },
    //Methods
    formatNumber: function (position) {
        return position.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
    },
    formatText: function (text, spaceChar) {
        text = text.replace(new RegExp(spaceChar, "gi"), " ");
        text = text.charAt(0).toUpperCase() + text.slice(1);
        return text;
    },
    titleCase: function (str) {
        return str.charAt(0).toUpperCase() + str.slice(1);;
    },
    camelCase: function (str) {
        return str.toLowerCase().replace(/[.-_\s](.)/g, function (match, group1) {
            return group1.toUpperCase();
        })
    },
    camelToSpace: function (str) {
        var result = str.replace(/([A-Z])/g, ' $1').toLowerCase().trim();
        return result.charAt(0).toUpperCase() + result.slice(1);
    },
    closest: function (element, selector) {
        var matches = (element.matches) ? 'matches' : 'msMatchesSelector';
        while (element) {
            if (element[matches](selector)) {
                break;
            }
            element = element.parentElement;
        }
        return element;
    },
    isFunction: function (s) {
        return typeof (s) === 'function' || s instanceof Function;
    },
    parseDate: function (strDate) {
        return strDate.substring(4, 6) + "/" + strDate.substring(6, 8) + "/" + strDate.substring(0, 4) + " " + strDate.substring(8, 10) + ":" + strDate.substring(10, 12) + ":" + strDate.substring(12, 14);
    },
    genId: function (prefix) {
        prefix = prefix || '';
        prefix = prefix.length == 0 ? prefix : prefix + '-';
        return prefix + this.randomString(4) + this.getRandomInt(1000, 9999);
    },
    randomString: function (length) {
        length = length || 10;
        var str = "";
        for (var i = 0; i < length; i++) {
            str += this.characters.charAt(this.getRandomInt(0, this.characters.length - 1));
        }
        return str;
    },
    getRandomInt: function (min, max) {
        // https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Math/random
        // Using Math.round() will give you a non-uniform distribution!
        return Math.floor(Math.random() * (max - min + 1)) + min;
    },
    endsWithIgnoreCase: function (str, test) {
        var regex = new RegExp('^.*\\.(' + test + ')$', 'i');
        return regex.test(str);
    },
    endsWith: function (str, test) {
        return str.length >= test.length && str.substr(str.length - test.length) == test;
    },
    addQueryParamtersToUrl: function (paramsWS, url) {
        var chr = "?";
        if (url.indexOf("?") != -1) {
            chr = "&";
        }
        var query = Utils.queryString(paramsWS);
        if (query != "")
            query = chr + query;
        return url + query;
    },
    queryString: function (obj) {
        var items = [];
        for (var key in obj) {
            if (obj[key] != null && obj[key] != undefined) {
                items.push(key + '=' + encodeURIComponent(obj[key]));
            }
        }
        return items.join('&');
    },
    randomColor: function () {
        var color = "";
        for (var i = 0; i < 6; i++) {
            color += ([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 'a', 'b', 'c', 'd', 'e', 'f'][Math.floor(Math.random() * 16)]);
        }
        return "#" + color;
    },
    colorLuminance: function (hex, lum) {
        // validate hex string
        hex = String(hex).replace(/[^0-9a-f]/gi, '');
        hex = String(hex).replace(/#/gi, '');
        if (hex.length < 6) {
            hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
        }
        lum = lum || 0;

        // convert to decimal and change luminosity
        var rgb = "#",
            c, i;
        for (i = 0; i < 3; i++) {
            c = parseInt(hex.substr(i * 2, 2), 16);
            c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
            rgb += ("00" + c).substr(c.length);
        }

        return rgb;
    },
    getSpeciesFromAvailable: function (availableSpecies, speciesCode) {
        for (var phylos in availableSpecies) {
            for (var i = 0; i < availableSpecies[phylos].length; i++) {
                var species = availableSpecies[phylos][i];
                if (species.id === speciesCode || species.scientificName.toLowerCase() === speciesCode.toLowerCase()) {
                    return species;
                }
            }
        }
    },
    getSpeciesCode: function (speciesName) {
        var pair = speciesName.split(" ");
        var code;
        if (pair.length < 3) {
            code = (pair[0].charAt(0) + pair[1]).toLowerCase();
        } else {
            code = (pair[0].charAt(0) + pair[1] + pair[pair.length - 1].replace(/[/_().\-]/g, '')).toLowerCase();

        }
        return code;
    },
    basicValidationForm: function (scope) {
        var validated = true;
        var msg = "";
        if (scope.$.outdir.selectedFile === undefined || scope.$.outdir.selectedFile.type != "FOLDER") {
            msg += "Error: Please select an output folder.\n";
            validated = false;
        }
        if (scope.$.inputFile.selectedFile === undefined || scope.$.inputFile.selectedFile.type != "FILE") {
            msg += "Error: Please select an input file.\n";
            validated = false;
        }
        if (scope.$.jobName.value == "") {
            msg += "Error: Please add a job name.\n";
            validated = false;
        }
        if (!validated) {
            alert(msg)
        }
        return validated;
    },
    getUrl: function (fileId) {
        return OpencgaManager.files.download({
            id: fileId,
            query: {
                sid: Cookies("bioinfo_sid")
            },
            request: {
                url: true
            }
        });
    },
    getFileContent: function (callback, fileId) {
        OpencgaManager.files.content({
            id: fileId,
            query: {
                sid: Cookies("bioinfo_sid")
            },
            request: {
                success: function (response) {
                    callback(response);
                },
                error: function () {
                    this.message = 'Server error, try again later.';
                }
            }
        })
    },
    loadExampleFile: function (callback, toolName, exampleFileName) {

        var me = this;
        OpencgaManager.files.contentExample({
            query: {
                toolName: toolName,
                fileName: exampleFileName
            },
            request: {
                //method: 'POST',
                success: function (response) {
                    callback(response);
                    //                            debugger
                    //                            me.loadedMainSelectChanged(false,true);
                },
                error: function () {
                    console.log('utils.js223:Server error, try again later.');
                }
            }
        })
    },
    downloadExampleFile: function (toolName, fileName) {
        var url = OpencgaManager.files.downloadExample({
            query: {
                toolName: toolName,
                fileName: fileName
            },
            request: {
                url: true
            }
        });
        var link = document.createElement('a');
        link.href = url;
        //link.setAttribute("download", "download.zip");
        var event = new MouseEvent('click', {
            'view': window,
            'bubbles': true,
            'cancelable': true
        });
        link.dispatchEvent(event);
    },
    argsParser: function (form, args) {
        if (form.toolName == args.tool) {
            for (var key in args) {
                if (typeof (args[key]) == "object") {
                    if (form.$[key] !== undefined)
                        form.$[key].selectedFile = args[key];
                } else {
                    var elems = form.shadowRoot.querySelectorAll('input[name="' + key + '"]');
                    if (form.$[key] !== undefined) {
                        switch (form.$[key].type) {
                        case "checkbox":
                            form.$[key].checked = args[key];
                        default:
                            form.$[key].value = args[key];
                        }
                    }
                    for (var i = 0; i < elems.length; i++) {
                        var elem = elems[i];
                        if (elem.value == args[key])
                            elem.checked = true;
                    }

                }
            }
        }
    },
    getLinks: function (terms) {
        var links = [];
        for (var i = 0; i < terms.length; i++) {
            var term = terms[i];
            links.push(Utils.getLink(term));
        }
        return links;
    },
    getLink: function (term) {
        var link = "http://www.ebi.ac.uk/QuickGO/GTerm?id=";
        if (term.indexOf("(") >= 0) {
            var id = term.split("(");
            if (id.length > 1)
                id = id[1];
            id = id.split(")")[0];

        } else
            id = term;
        if (id.indexOf("IPR") == 0)
            link = "http://www.ebi.ac.uk/interpro/entry/";
        link = link + id;
        return link;
    },
    myRound: function (value, decimals) {
        decimals = typeof decimals !== 'undefined' ? decimals : 2;
        value = parseFloat(value);
        /** rounding **/
        if (Math.abs(value) >= 1)
            value = value.toFixed(decimals);
        else
            value = value.toPrecision(decimals);
        value = parseFloat(value);
        return value;
    },
    formatNumber: function (value, decimals) {
        value = Utils.myRound(value, decimals);

        if (Math.abs(value) > 0 && Math.abs(value) < 0.001)
            value = value.toExponential();
        return value;
    },
    getSpecies: function (specieValue, species) {
        for (var i = 0; i < species.length; i++) {
            var specie = species[i];
            if (specie.value == specieValue) {
                return specie;
            }
        }
        return null;
    },
    test: function () {
        return this;
    },
    cancelFullscreen: function () {
        if (document.cancelFullScreen) {
            document.cancelFullScreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.webkitCancelFullScreen) {
            document.webkitCancelFullScreen();
        }
    },
    launchFullScreen: function (element) {
        if (element.requestFullScreen) {
            element.requestFullScreen();
        } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if (element.webkitRequestFullScreen) {
            element.webkitRequestFullScreen();
        }
    },
    parseJobCommand: function (item) {
        var commandObject = {};
        var commandArray = item.commandLine.split(/ -{1,2}/g);
        var tableHtml = '<table cellspacing="0" style="max-width:400px;border-collapse: collapse;border:1px solid #ccc;"><tbody>';
        tableHtml += '<tr style="border-collapse: collapse;border:1px solid #ccc;font-weight:bold;">';
        tableHtml += '<td style="min-width:50px;border-collapse: collapse;border:1px solid #ccc;padding: 5px;background-color: whiteSmoke;">Parameter</td>';
        tableHtml += '<td style="border-collapse: collapse;border:1px solid #ccc;padding: 5px;background-color: whiteSmoke;">Value</td>';
        tableHtml += '</tr>';
        for (var i = 1; i < commandArray.length; i++) {
            //ignore first argument
            var paramenter = commandArray[i];
            var paramenterArray = paramenter.split(/ {1}/g);
            var name = '';
            var value = '';
            if (paramenterArray.length < 2) {
                name = paramenterArray[0];
                value = '<span color:darkgray;font-weight:bold;>This paramenter is a flag</span>';
            } else {
                name = paramenterArray[0];
                value = paramenterArray[1];
            }
            commandObject[name] = value;
            /* clean values for viz*/
            value = value.replace(/\/httpd\/bioinfo\/opencga\/analysis\/.+\/examples\//, '');
            value = value.replace('/httpd/bioinfo/opencga/accounts/', '');
            value = value.replace(/,/g, ", ");

            tableHtml += '<tr style="border-collapse: collapse;border:1px solid #ccc;">';
            tableHtml += '<td style="border-collapse: collapse;border:1px solid #ccc;padding: 5px;background-color: whiteSmoke;color:steelblue;font-weight:bold;white-space: nowrap;">' + name + '</td>';
            tableHtml += '<td style="border-collapse: collapse;border:1px solid #ccc;padding: 5px;background-color: whiteSmoke;">' + value + '</td>';
            tableHtml += '</tr>';
        }
        tableHtml += '</tbody></table>';
        return {
            html: tableHtml,
            data: commandObject
        };
    },
    htmlTable: function (object) {
        var tableHtml = '';
        tableHtml += '<table cellspacing="0" style="border-collapse: collapse;border:1px solid #ccc;"><tbody>';
        for (var key in object) {
            tableHtml += '<tr style="border-collapse: collapse;border:1px solid #ccc;">';
            tableHtml += '<td style="border-collapse: collapse;border:1px solid #ccc;padding: 5px;background-color: whiteSmoke;color:steelblue;font-weight:bold;white-space: nowrap;">' + key + '</td>';
            tableHtml += '<td style="border-collapse: collapse;border:1px solid #ccc;padding: 5px;background-color: whiteSmoke;">' + object[key] + '</td>';
            tableHtml += '</tr>';
        }
        tableHtml += '</tbody></table>';
        return tableHtml;
    },
    msg: function (title, msg) {
        var div = document.createElement('div');
        div.classList.add('jso-msg-hidden');
        var titleDiv = document.createElement('div');
        titleDiv.textContent = title;
        var msgDiv = document.createElement('div');
        msgDiv.textContent = msg;
        div.appendChild(titleDiv);
        div.appendChild(msgDiv);
        document.body.appendChild(div);
        div.addEventListener('click', function () {
            document.body.removeChild(div);
            div = null;
        });
        setTimeout(function () {
            div.classList.add('jso-msg-shown');
        }, 10);
        setTimeout(function () {
            if (div) {
                div.classList.remove('jso-msg-shown');
            }
        }, 4000);
        setTimeout(function () {
            if (div) {
                document.body.removeChild(div);
                div = null;
            }
        }, 4400);
    },
    repeat: function (string, count) {
        if (string == null) {
            throw new TypeError('can\'t convert ' + string + ' to object');
        }
        var str = '' + string;
        count = +count;
        if (count != count) {
            count = 0;
        }
        if (count < 0) {
            throw new RangeError('repeat count must be non-negative');
        }
        if (count == Infinity) {
            throw new RangeError('repeat count must be less than infinity');
        }
        count = Math.floor(count);
        if (str.length == 0 || count == 0) {
            return '';
        }
        // Ensuring count is a 31-bit integer allows us to heavily optimize the
        // main part. But anyway, most current (august 2014) browsers can't handle
        // strings 1 << 28 chars or longer, so:
        if (str.length * count >= 1 << 28) {
            throw new RangeError('repeat count must not overflow maximum string size');
        }
        var rpt = '';
        for (;;) {
            if ((count & 1) == 1) {
                rpt += str;
            }
            count >>>= 1;
            if (count == 0) {
                break;
            }
            str += str;
        }
        return rpt;

    },
    clone: function (obj) {
        return JSON.parse(JSON.stringify(obj));
    },
    timeDiff: function (timeStart, timeEnd) {
        var ts = new Date(Date.parse(timeStart));
        var te = new Date(Date.parse(timeEnd));

        if (isNaN(ts) || isNaN(te)) {
            return "";
        }

        if (ts < te) {
            var milisec_diff = te - ts;
        } else {
            var milisec_diff = ts - te;
        }

        var days = Math.floor(milisec_diff / 1000 / 60 / (60 * 24));
        var daysMessage = days + " Days ";
        if (days === 0) {
            daysMessage = '';
        }
        var date_diff = new Date(milisec_diff);
        var hours = date_diff.getHours() - 1;
        var hoursMessage = hours + " hour";
        var minutesMessage = date_diff.getMinutes() + " minute";
        var secondsMessage = date_diff.getSeconds() + " second";
        if (hours !== 1) {
            hoursMessage += 's ';
        } else {
            hoursMessage += ' ';
        }
        if (date_diff.getMinutes() !== 1) {
            minutesMessage += 's ';
        } else {
            minutesMessage += ' ';
        }
        if (date_diff.getSeconds() !== 1) {
            secondsMessage += 's ';
        } else {
            secondsMessage += ' ';
        }
        if (hours === 0) {
            hoursMessage = '';
        }
        if (date_diff.getMinutes() === 0) {
            minutesMessage = '';
        }
        if (date_diff.getSeconds() === 0) {
            secondsMessage = '';
        }
        return daysMessage + hoursMessage + minutesMessage + secondsMessage;
    },
    deleteIndexedDB: function () {
        window.indexedDB.webkitGetDatabaseNames().onsuccess = function (sender, args) {
            var r = sender.target.result;
            for (var i in r) {
                indexedDB.deleteDatabase(r[i]);
            }
        };
    },
    subsetArray: function (array, from, to) {
        var aux = [];
        from = (from < 0) ? 0 : from;
        to = (to >= array.length) ? array.length : to;

        for (var i = from; i < to; i++) {
            aux.push(array[i]);
        }

        return aux;
    },
    applyFunctionBatch: function (array, batchsize, callback) {

        var end = batchsize;
        var auxArray = this.subsetArray(array, 0, end);

        while (auxArray.length > 0) {
            callback(auxArray);
            auxArray = this.subsetArray(array, end, end + batchsize);
            end += batchsize;
        }
    }

};

Utils.images = {
    add: "data:image/gif;base64,R0lGODlhEAAQAIcAAD2GNUKNNkOPOESMO0WNPEmPP0iNQUmPQlOVTFWWTVCZQVeeRV6cVmGeWGSgVWSgV2aiWGejW2WrVWirU2uqWGqsW2yqWm61WG+1WG+1WXS3W3S3XHC4WXK5W3O6XHG+X3asZ3iuaHe8YHi0ZH+yany6ZH28Zn2+Z3m9bn25an25a3+5bUD/QHDBY3nBZHrGa3zDa37BaX7Hb4K1boO1boa3cYi4d4y7doq5eYm+eI2+e5O/f4HMdYbJeobJfIXNeYrCeY/CfYnIf4rPfZW/gozLgY7MhI7Sg5LFgJXAgpfHhZfMhZPNiJjLhpjMh5jMipvBl5vBmJTTipbTiZXUipbUi5fVi5nRi53YkqTOlKbPlqbQlqDZlaDZlqXbm6rUnavUnKbIoKfJoa/fpa/fprPZpbTZpbTaprLbqLPdqbXbqLfaqrTdqrXfrLbdrLjVr7jdr7vcr7rWsbfgr77itr3ktsTcuMXducXowMvmw87pydTrz9fu0tzx2ODy3P///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAMAACwALAAAAAAQABAAAAi/AFkIHEiwoME7SWrMwCHH4MAdWfLs0QNnRQiHN+L4qeOlyxg8QCAU3LGmDxYmRqpQOTJHRYSBdpTw4SJFyJ8/P2DIaLNAjEAibsgU8YHiZgURHq4gaSCQBh0rPW5K/cMhxpcCAkmkGcJj6k0OJ8AMEGjjyZQXLSR85dBhiY4EAt9MYOPig4ivFzacEQBlIIgUaJByyIBBQxkLBwo6GKHGiYkSTcxQAODwgYIgW7TkCGDAocAwDAoQQBDFs2mCAQEAOw==",
    del: "data:image/gif;base64,R0lGODlhEAAQAIcAAED/QLpSNL9TOr5WOb5cQL9cQMFNM8RQNMBVPcBZP8xSPNBPPttWS9ddUcJnTMRkTMdrVM1gUc5iVMxmVclrVs1oWNZgVNZuZNtpZdxraN5ratxuadRxZd14c955dOZWTOZYTOZZTulZTelbT+ZWUOZaUuddWepcUOxfVOBlXO5mUuljW+pmXO5qXvBkVvNzXeNrYeNuY+FvcOJwZuJ7deR4ceJ5eeN4eeJ/feN/fOl7cOh6del/ePJ3Y/N5Y+qDfe6Efe+Gfu6KdfaCaPaEbPCFcPCDe/CMd/GOeviGcPiMdvCRf/eRfveTfvmSfvqTf/iUf9ymltynl+6Mge2Tju6Sj/SOgfqah/qdi/GclvGdluGpnvSgnvSinvWjn/qjkfupnPqrneGroOqwrOuzr/Ono/WmoferofarovWsofWvpfKtqvivpPS0qvi2qPm5r/q6rvC1tfC2tvjDvvzHuvnLxPnTzPzUzf3b1P3c2P///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAMAAAAALAAAAAAQABAAAAi6AAEIHEiwoEE5ODRk8EDG4EAbVObYqdNmxgWHMtbkgfMFCxg6OiQUvFEGz5UlSKA4UeImRoWBcX7cwdJECJGbRHywWSBGYA41YY6gGEq0hxUeFARuePOkiJ6nUEW00IJAIIYzSYZAjcoiywCBHaYweSGirNkRRmg8EDiGARoXKsyKAFHCy4EoAznASIPihIgQH0h0sVCgYIQUZoKsMAGES4MADico2FGlSg0DBBwK3AIhgQAHUjSLJhgQADs=",
    enable: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAKfSURBVDjLpZPrS1NhHMf9O3bOdmwDCWREIYKEUHsVJBI7mg3FvCxL09290jZj2EyLMnJexkgpLbPUanNOberU5taUMnHZUULMvelCtWF0sW/n7MVMEiN64AsPD8/n83uucQDi/id/DBT4Dolypw/qsz0pTMbj/WHpiDgsdSUyUmeiPt2+V7SrIM+bSss8ySGdR4abQQv6lrui6VxsRonrGCS9VEjSQ9E7CtiqdOZ4UuTqnBHO1X7YXl6Daa4yGq7vWO1D40wVDtj4kWQbn94myPGkCDPdSesczE2sCZShwl8CzcwZ6NiUs6n2nYX99T1cnKqA2EKui6+TwphA5k4yqMayopU5mANV3lNQTBdCMVUA9VQh3GuDMHiVcLCS3J4jSLhCGmKCjBEx0xlshjXYhApfMZRP5CyYD+UkG08+xt+4wLVQZA1tzxthm2tEfD3JxARH7QkbD1ZuozaggdZbxK5kAIsf5qGaKMTY2lAU/rH5HW3PLsEwUYy+YCcERmIjJpDcpzb6l7th9KtQ69fi09ePUej9l7cx2DJbD7UrG3r3afQHOyCo+V3QQzE35pvQvnAZukk5zL5qRL59jsKbPzdheXoBZc4saFhBS6AO7V4zqCpiawuptwQG+UAa7Ct3UT0hh9p9EnXT5Vh6t4C22QaUDh6HwnECOmcO7K+6kW49DKqS2DrEZCtfuI+9GrNHg4fMHVSO5kE7nAPVkAxKBxcOzsajpS4Yh4ohUPPWKTUh3PaQEptIOr6BiJjcZXCwktaAGfrRIpwblqOV3YKdhfXOIvBLeREWpnd8ynsaSJoyESFphwTtfjN6X1jRO2+FxWtCWksqBApeiFIR9K6fiTpPiigDoadqCEag5YUFKl6Yrciw0VOlhOivv/Ff8wtn0KzlebrUYwAAAABJRU5ErkJggg==",
    warning: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAIsSURBVDjLpVNLSJQBEP7+h6uu62vLVAJDW1KQTMrINQ1vPQzq1GOpa9EppGOHLh0kCEKL7JBEhVCHihAsESyJiE4FWShGRmauu7KYiv6Pma+DGoFrBQ7MzGFmPr5vmDFIYj1mr1WYfrHPovA9VVOqbC7e/1rS9ZlrAVDYHig5WB0oPtBI0TNrUiC5yhP9jeF4X8NPcWfopoY48XT39PjjXeF0vWkZqOjd7LJYrmGasHPCCJbHwhS9/F8M4s8baid764Xi0Ilfp5voorpJfn2wwx/r3l77TwZUvR+qajXVn8PnvocYfXYH6k2ioOaCpaIdf11ivDcayyiMVudsOYqFb60gARJYHG9DbqQFmSVNjaO3K2NpAeK90ZCqtgcrjkP9aUCXp0moetDFEeRXnYCKXhm+uTW0CkBFu4JlxzZkFlbASz4CQGQVBFeEwZm8geyiMuRVntzsL3oXV+YMkvjRsydC1U+lhwZsWXgHb+oWVAEzIwvzyVlk5igsi7DymmHlHsFQR50rjl+981Jy1Fw6Gu0ObTtnU+cgs28AKgDiy+Awpj5OACBAhZ/qh2HOo6i+NeA73jUAML4/qWux8mt6NjW1w599CS9xb0mSEqQBEDAtwqALUmBaG5FV3oYPnTHMjAwetlWksyByaukxQg2wQ9FlccaK/OXA3/uAEUDp3rNIDQ1ctSk6kHh1/jRFoaL4M4snEMeD73gQx4M4PsT1IZ5AfYH68tZY7zv/ApRMY9mnuVMvAAAAAElFTkSuQmCC",
    edit: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB80lEQVR42o2T30tTURzArb8ioiAI6kHoZeF7CGE/IISCUDNCqAeL3rIWPfSwByskYUEJIhSChBhJFAiNqMVYPqRuc4tcW3NLt3C7u3d3d3c/+nS+0GRK0134cC6c8/ncc+7ltgFt6jqgcCg6duGQYq84deoBR6lU0iqVSq1arfI/1Dxut3u0Htke6BC5UChgmuYm+XyeXC5HOp1GIsnQNJHJi3x/7WJh/CSLT9r7Rd4jAVlgWRa2bSOjYBgGmqaRyWQwkq9Y8wyhLb0BI0VuaRrfo671xoDIwmakWCyi6zrr36bILt/HXp1l7cNDioEZqnEvgYmr1paAOgYy1u/l3NrqHNngPWpFL8XodTa+3CD8YoCvz/o078i5o1sC29FT78kG7lCzfJgrl7ESvejLThLPuxk8fbhP3KaBVFCdeX7on9yP9bOHfPAu0bEzmKkg4jQNpEKzhOduqW1/xIoNUEpcQlM7WXl6Cj39Q9Y0D4Q/TRJ662Tx3WOS/guYsV42Fm4THe/G/B2T97Jz4OVwJ+hxImPn8Tj381k91TfShfErIvLuAde1Y9g+N7Z/FL/rBDODR8gmgpTL5To7B3o69zF8pR3Pg7PMT90kn47LJ22kaeCPghapidP4Lxy3bduUiVZktdaQH7AxcFAiUm0Rhzji/gUhbp0s2Zf2xwAAAABJRU5ErkJggg==",
    info: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAJ1SURBVHjafJJdSJNhFMd/z3QzLWdZrnQmSA2DPqRCK4KuhIq66kLoAy/qoqCguqqL6JsgLwoKKhCMSIy6CDKKRFZZYYQRVhJl02nWmG5uc19u7/vuPV0lW7QOnIsHnt+P8z/Pg4gw26aZ0263uzEUCn2IxWJjXq/3JqBETLIZ8gkePLhfKyKy/Z5HHJf7xe0Jic/n65mejizPK0inUiSTKUSE0dHRhxf6JoSDb4Rjr4QDz0REJBgMtmczFrJKKYVSCjCYnPR/W1FuAwQSGjbHXAA0LRXKZnIm0NJpgAKvd/hSOBz2iIj0eiPS2vtDYsmUPH/uPg9YshklIrOyCb+/eUG5ve3au5C99W2AqGbgKivk8R4X1lSkv2pJZaNmmBQVWWeZnAiGoa+3KovdyBjsW2kn/SvK4Jcgtaf7cDqrGkQMUDkBcgXVS2tOHjp8dG2jOXT1yo5lYOpgFTB0wKTAOqdQMlqOoDD7EE8kREwGXr/oWTg4HjxONAklBayuKSUeT/hFTxrwnwlAMa8I1qyrP3H95RiQgUiC/RsWM+wZ6jIME0M38wtSM0mmojM4nc6mzr5xKDQgnWb/pmoedT29EU3pTMUS+QVKKerq6kqnI3EVHwmAplO8qBh7WTFnzpz9bOg6FovlfxGEixfOrfT6YxCOQ1rDUaIAG4EJ38+PAwNb/95Bzj8ITAZwLHbMT0yHw3N33YVwEnQDqss41VzPkaalX6Iz+m6Xy/Xp34JAAICR7187nLWuvbe6h9C0DA2uRTTVV9J++87OlpaWJxUVFf9+xj+1cfOWls6OO93Nq1zblMVm9flG3pcvXNPm90+E/777ewB+UIqdqtYXHAAAAABJRU5ErkJggg==",
    //    bucket: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB90BCg4hBcbCoOMAAABsSURBVDjLY2RgYFBjYGCIZCAPLGeBam4g0wAGJgYKARMDA8NZCvSfZYQy6sk0oJEFiUNqODRQLQxGDYCAb2To/YZswEsyDHiJbMAHMgz4gO6F5aTkQpgXYElZkoGBgZeEbL2cgYHhMwMDw3MA93ARk+mSg4gAAAAASUVORK5CYII=",
    bucket: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QkQDC8RTstxRAAAAGBJREFUOMtjYBgswIWBgeE/idiFgYGBgRFqwH8GBoYGEi1tYGBgYGRBE9QjUvMlGANmgCsDA8NuElzRANXDwAQV2ENGuO1BNoBsMGoAlQ3wJTIdNEDVYgU+ROQBH6rmQgAWgB19xco60wAAAABJRU5ErkJggg==",
    //    dir: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsSAAALEgHS3X78AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAKNJREFUeNrEk7sNwkAQBefQ5m6BTiAAQssZiMh0QFUIMrAEpKYD8ynAJeD4nXQEkJHgu4CXv9GsdteFEEjJgMQ4gPli+aWx227cLwAD8FK8QZ4XTyCL6B6qal+YlzLgCpSn87HpbTCdzAKwAkpg1Bdgn/nbmDLQmby6hC3W5qUGGEcCGpNUJwBq09tgHdO+Pe61eamNvIMLgEkaxuoDuL9/42sAM20/EZafbV8AAAAASUVORK5CYII=",
    dir: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpDNzU0RUNBNzU3OEIxMUUyOEM3QzkxOEZDOTU1RTdFMCIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpDNzU0RUNBODU3OEIxMUUyOEM3QzkxOEZDOTU1RTdFMCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkM3NTRFQ0E1NTc4QjExRTI4QzdDOTE4RkM5NTVFN0UwIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkM3NTRFQ0E2NTc4QjExRTI4QzdDOTE4RkM5NTVFN0UwIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+S/WxbAAAAERJREFUeNpi/P//PwMlgJFSA1g2bNiAzYQLQOwIxB8IGcCEQ9wAiPcDsQBBF+CRAxnynlwXEA1GDRg1gCqZiWIDAAIMADidE0PBoGsZAAAAAElFTkSuQmCC",
    r: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB90CDRIvNbHTpbwAAADjSURBVDjLpZFBbsIwEEUfVRZYahcVK3qKXoauMFK5C91nkyUB+xC5BqeAA7SKq1B5ugl2EiC04UkjayzN17NnROTRWvvJFbTWL8CBHqbGWOlSlqVkWSbGWAGm3aGHZiMiAByPP6FOd1rP2W7NvhvSCvDe10E+VJPFQpPnm1ZIcsmgPgJVVZGmaejX63y/XL4/AV/JJYPTCeDcN7PZWyuwKAqA8wARqSsGKDVGqXGjV8H07AnRQPq21TK8+YSBAQMN4hb6Df7wB/5eA+4zmEyehxk451itPrhFksSxUeP+lf+z+wXwdayJk/mqtgAAAABJRU5ErkJggg==",
    box: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wMHAwRAVvTmTAAAAK/SURBVDjLpZM9bFxFGEXPNzPvZ+39sb2xHceREjDQBwlDCqqIiiotokAghYKEjvSkQkKJkEiB0lOkoAHaBAokFCQKUATIIOLIMbHWrHfX+7zvvZk3MzQODUgU3PJK5+g2F/5n5N/Kb66/1NNK3hAxr4HcFqVuvfju18V/Cu58sPmMVnJZ4K32Qr+t8za+KnCz4kCUuiGibm5euTv5h+CL958/nxj1XivVF+e6C9TVhPmFdbROgEhwNU1d4m09UaJuInLjhct3DgDUh5ee7j14PLxulLvYP/0seadPkub88Wib0eB3bDkmxgbRoFPpxeCuKvjsyQIzOyqImT7/y8Mh++NveW7jLFmrx6m1NlWxz6PHA7otQ7tloAmYJE9isOeeCJRtIrULLLUTjsqG7+//xs72z7jZgCTNONlVJKEiuobW0jqSaoiet19dFQATJcc2FSFEciNoLYwOHcPDASvdjM5cQntxlbR9gqacoFSK84VsnOrkH11Zdmp0FFXjobSeCFgXSDS0Eo11ge7yGXSaU092UUlCaEpC8FK4tDcu4rzZ2a/S+bWI94HSAgFigDQD24Cvp4gIOp0juBJvC2L07B1Uc/Mtg9k7sHMbywZrA3lLECV4AtaCpAp79CcmzXHlhOBrAJrGyNbOVBY7qTO1C9r5EKyPSttAiJEs01SuQStFkrdp6gKd5AzHjixVxCDxp+1paZRUxoc4Kp36bndYbS53U5WlCq0CMYIPMY7GI0mNpiqmGK0oK4jIveGkPgRqfTBt3A8Pqtvrq52HtglnGh9XIaKUkCQ6nj6RyWBsmdXCtFI/bu2Fq5c+3roGzIAgWokCDNACOhfOLb781Ip+vd+RC2dXWibROkxKvvp1z376yZe7d4HpMdz8/YVjiQYyoA30Ti6la2++0n/n83vTW/e3ix1gcgzXgPchBoC/AFu/UBF5InryAAAAAElFTkSuQmCC",
    bluebox: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wMHAwTE5pcivoAAALsSURBVDjLXZPPaxxlGMc/77wz+3N2k822tWsTIrQFe/BWEKxKCV5UohdFhJ60p6rgUfpP6C0K4kHx0ENEkV7aElHwUikhFVosRGoTm83+3pnZnXfed2beHtItIQ98+Z6+H57nga8AsNYKDkYcEofcHvKZEEJYcSTszPzqL3fmf3+w/+a51tytby9d6D0N5UecGeBZ8MPv/jh9fy/6dKzMpVPHmvWdbl/XCvKn5Wbl6+ufrNwGssMgYa2VgFj58sZr7VB/LqX3zlKrydJzTTzXxdqcx90hO+0Bk2l8Z74i1z6+cOba5VfOqGeAb3579M/NR53T40xwrDGHFALPEUjn4LoMi0ktwWTKXqCIqAVrbyycvHj2hHYBR+bO8Q/Ov0imEzZ2xrRDRalQwC9LLBalUgaJQy+tU6gvIBJbv3j2RA4IFxDdICFa9ulMCrz/UgOs5kEwpeh57I4Nt/dzsmLOYlEThgFjUePp33IHoD9SJAbuTVyudRweixJvnVtg3/i00wpLPiwQ0hkO6YYKawWj0UjONqAfKHwDkxTqqeW/RHA3hO2+Zqk05e5wTD9KmOqMKDEUqoLNzU0PyF2AQaBoaIhiw0h6TIwgUDCODb5NiWJNlKREyhAozXwOW1tbFSmlcAHbD2KaytCdGgyWglfEs4LeNKeaa4axYRgpwlgTTTXVDDqdTslaewAYh4kNlKUbZsTGonOwCYwm1vq5Ft1AMYgU08SQR5o0gziOcRxHuoCNtdl6uPHX6/Vmi3Yyh9I5IoEgMdkgT9x+qJhEGrdQo77cJMuy+4DJskwLa60DOCtf3HhZpfZKtVx+L3x+sfCv8CFxTINd72HfodQ4aQp5fP24/v/Hd4Nf/5RSJmma6lkXZn1wPvvq5qndsbhS9esf/Zy/UEtzxnURfn8+/fuHV7m353mecV1XSym1lDI72kaxvr5e3N7eruyP0tpG/e3LK/rW2mLNUb7vm3K5nFarVdNqtbJer2dXV1fzJ6cDpboAZRAGAAAAAElFTkSuQmCC",
    refresh: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAAK8AAACvABQqw0mAAAAAd0SU1FB90CFA8bKScXIjIAAAJ1SURBVDjLlVJdSJNRGH7es+/7NlduWFLTKAskwjJqZYiBglJhLKguqou6EFkFIkLQH9IPBFI3BsouzMJupGYRajcqmeBFhWBU5oUgpZikrSnzZ9v3nW/ndKEbziXUAwfOOe/7Puc9z/MCq1DwMmB1NX/rzfCNnsc/gK08lPgnnT8Cs33BULg0HI4YKdkHX9DqKwKArXXv1bTMTFcoyruC89E8MxaDw659t6rKhIUwRBLdP2t2v/5bBwQA+5pH8ibnIj3BucgWIQRASw8RERTGYFUtsGmWYUXKmqmr7t4UAnal54GQ8lq8MBlyOU0CEnA67MiwqfvHbhZ+Smgg6o9eV2L8Nhk6wI2lZeggrpvE+TTjxgxxQ4IbmJsJYSa00JQiotnguacJ8zIZOmDosAnzTpowt8tGj0s0ejZqprnDKmPHSNebjHDkUPatt4cTTbZ+LsmO79XK52dZxTNp9/ovAEDnaM62lo8HHrd9SVfiOelVryrSq9vrEx0s8sW2tuEzDgDgT875bcIsjy6owwAwHhjnYT5bGTL29PiHyuwAMO873aL/Ct5PiPjwXe5vq7KJW2hdJxENMFInGCkhIblLj80WRoyxGxZmh1XJGlSIlV8s6A8kuVDXn+MF6JHC7GBkBSNlOSRgiihMsQhAgJGGNNU1atc2HPG6O8YSBABwt2/nGyFlGSCSB4UIBMuyoQKMFNiUjIApRH5t8YfpFOOrO/JrhZBVUiJLxq2ipIkY8Z36uivpC6txqb3YbhqhIingFlLmxmLSKyXAGAaYqh13aFjfcHJwfE2ClSitK9psc85PMVC3M999orX4Kcf/wuPb27VW7A+O2QVVA1M1CQAAAABJRU5ErkJggg==",
    newitem: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAtxJREFUeNqM0llIVHEUBvDv3vlfZ8ac6zZtWpmamtliUUHRDlFJWlEYLdBLtG/QBlFJQUTSU089RZRlG4EvkS9NlqkpldHyYLk1OurcOzp30vHO/y6nBwsSIvzgvBw+fpyHA8MwwDmHbdsjQwSbCACkYDBYp6pqU3Fxcfyf/Z+eYRjQOQf+Bnw+30IiIsMwhizL4n3lV6mn7BzZtm1yzn8SETU0NKz+J2ARobe3t85/+SI1506j9hOHqTEO9FYEtR/ZTx/n5FDH6eOkquoni2g00NjUtEzTtBYioneLCulVHKg2yUkNmelUn5VOtUlueu0SqDE/m4iIIpFI64fm5vU65xAMIlicR9rOn/UEKytgmQbYuARAEDAqRLCiQxBFhtTNWzDzxk1LcjgkFhuKIhLR2qJKcN5Al/q7reF/cXUHoA0MtA9Gh4klJIxz6ro+PZiVC0uOw1jimJEDWZbTDhw8lCi0+/3PtUeV696ePIPUnIwxAf3fOjG/7AK8e/e9ZH2K0uWdPRdivANm3NguED1OJBYWQunvDwgAXIqifO54+CC7/tSxMQELL11B/r6D3cnJybniQDis25Ikfn1wD2GdQLIMISkF5JFhudwgjwySkyCkpILkRER0wpf7d2FJkqSoapQRRPCYjoLDR+EY70VXbS2YxCC4nAARbAAQBJBlwTIMZJRsQN7W7eA6t9O8XkE0jRhWLV2y+Gdm9q0dT6rMhLw8dPn7EAoEMBSLIcpjCPUEEPD3gU1Kw+6qZ6TPKrizq3TbAjUUIkFRVYAIkkfG99bWp4P1b7Z0vq5BXtFGPN6zE6Zuo7SiAh01PkycV4jJRRt96VOmrOHhMESHiBEAgMkNlGwqmXC78mG1DXtQdruTgx/eF5g6x9Tly1pCmtYjMSnxatnFTeXXyn8wxiCMAgxz5EmcTjCXCynxblf1C9910eFwrl254nh/dDhqcQ5zeBgAwBiDIAr4NQAWJarVjshqqgAAAABJRU5ErkJggg=="
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//Element.prototype.addChildSVG = function(elementName, attributes, index){
//	var el = document.createElementNS('http://www.w3.org/2000/svg', elementName);
//	for ( var key in attributes){
//		el.setAttribute(key, attributes[key]);
//	}
//	
//	// insert child at requested index, or as last child if index is too high or no index is specified
//    if ( null == index ) {
//      this.appendChild( el );
//    }
//    else {
//      var targetIndex = index + 1;
//      if ( 0 == index ) {
//        targetIndex = 0;
//      }
//      var targetEl = this.childNodes[ targetIndex ];
//      if ( targetEl ) {
//        this.insertBefore( el, targetEl ); 
//      }
//      else {
//        this.appendChild( el );
//      }
//    }
//    return el;
//};
//Element.prototype.initSVG = function(attributes){
//	return this.addChildSVG("svg", attributes);
//};

var SVG = {
	
	create : function (elementName, attributes){
		var el = document.createElementNS('http://www.w3.org/2000/svg', elementName);
		for ( var key in attributes){
			el.setAttribute(key, attributes[key]);
		}
		return el;
	},

	addChild : function (parent, elementName, attributes, index){
		var el = document.createElementNS('http://www.w3.org/2000/svg', elementName);
		for ( var key in attributes){
			el.setAttribute(key, attributes[key]);
		}
		return this._insert(parent, el, index);
	},
	
	addChildImage : function (parent, attributes, index){
		var el = document.createElementNS('http://www.w3.org/2000/svg', "image");
		for ( var key in attributes){
			if(key == "xlink:href"){
				el.setAttributeNS('http://www.w3.org/1999/xlink','href',attributes[key]);
			}else{
			    el.setAttribute(key, attributes[key]);
            }
		}
		return this._insert(parent, el, index);
	},
	
	_insert : function (parent, el, index){
		// insert child at requested index, or as last child if index is too high or no index is specified
	    if ( null == index ) {
	    	parent.appendChild( el );
	    }
	    else {
	      var targetIndex = index + 1;
	      if ( 0 == index ) {
	        targetIndex = 0;
	      }
	      var targetEl = parent.childNodes[ targetIndex ];
	      if ( targetEl ) {
	    	  parent.insertBefore( el, targetEl ); 
	      }
	      else {
	    	  parent.appendChild( el );
	      }
	    }
	    return el;
	},

	init : function (parent, attributes){
		return this.addChild(parent, "svg", attributes);
	},



    //
    /* Functions to generate arcs with PATH element  */
    //

    _polarToCartesian : function (centerX, centerY, radius, angleInDegrees) {
        var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;

        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    },

    describeArc : function (x, y, radius, startAngle, endAngle) {

        var start = this._polarToCartesian(x, y, radius, endAngle);
        var end = this._polarToCartesian(x, y, radius, startAngle);

        var arcSweep = endAngle - startAngle <= 180 ? "0" : "1";
        var d = [
            "M", start.x, start.y,
            "A", radius, radius, 0, arcSweep, 0, end.x, end.y
        ].join(" ");

        return d;
    }
};

//createSVG = function(elementName, attributes){
//	var el = document.createElementNS('http://www.w3.org/2000/svg', elementName);
//	for ( var key in attributes){
//		el.setAttribute(key, attributes[key]);
//	}
//	return el;
//};



//var SVG =
//{
//		svgns : 'http://www.w3.org/2000/svg',
//		xlinkns : "http://www.w3.org/1999/xlink",
//
////	createSVGCanvas: function(parentNode, attributes)
////	{
//////		attributes['xmlns'] = SVG.svgns;
//////		attributes['xmlns:xlink'] = SVG.xlinkns;
//////		attributes.push( ['xmlns', SVG.svgns], ['xmlns:xlink', 'http://www.w3.org/1999/xlink']);
////		var svg = document.createElementNS(SVG.svgns, "svg");
////		
////		for ( var key in attributes){
////			svg.setAttribute(key, attributes[key]);
////		}
////		
////		parentNode.appendChild(svg);
////		return svg;
////	}, 
//	
//	//Shape types : rect, circle, ellipse, line, polyline, polygon , path
//	createElement : function (svgNode, shapeName, attributes) {
//		try{
//			if(attributes.width < 0){
//				console.log("BIOINFO Warn: on SVG.createRectangle: width is negative, will be set to 0");
//				attributes.width=0;
//			}
//			if(attributes.height < 0){
//				console.log("BIOINFO Warn: on SVG.createRectangle: height is negative, will be set to 0");
//				attributes.height=0;
//			}
//			
//			var shape = document.createElementNS('http://www.w3.org/2000/svg', shapeName);
//			for ( var key in attributes){
//				shape.setAttribute(key, attributes[key]);
//			}
//			svgNode.appendChild(shape);
//		}
//		catch(e){
//			console.log("-------------------- ");
//			console.log("Error on drawRectangle " + e);
//			console.log(attributes);
//			console.log("-------------------- ");
//		}
//		return shape;
//	}
//};
//
//
//
//var CanvasToSVG = {
//		
//	convert: function(sourceCanvas, targetSVG, x, y, id, attributes) {
//		
//		var img = this._convert(sourceCanvas, targetSVG, x, y, id);
//		
//		for (var i=0; i< attributes.length; i++)
//		{
//			img.setAttribute(attributes[i][0], attributes[i][1]);
//		}
//	},
//	
//	_convert: function(sourceCanvas, targetSVG, x, y, id) {
//		var svgNS = "http://www.w3.org/2000/svg";
//		var xlinkNS = "http://www.w3.org/1999/xlink";
//		// get base64 encoded png from Canvas
//		var image = sourceCanvas.toDataURL();
//
//		// must be careful with the namespaces
//		var svgimg = document.createElementNS(svgNS, "image");
//
//		svgimg.setAttribute('id', id);
//	
//		//svgimg.setAttribute('class', class);
//		//svgimg.setAttribute('xlink:href', image);
//		svgimg.setAttributeNS(xlinkNS, 'xlink:href', image);
//		
//
//		svgimg.setAttribute('x', x ? x : 0);
//		svgimg.setAttribute('y', y ? y : 0);
//		svgimg.setAttribute('width', sourceCanvas.width);
//		svgimg.setAttribute('height', sourceCanvas.height);
//		//svgimg.setAttribute('cursor', 'pointer');
//		svgimg.imageData = image;
//	
//		targetSVG.appendChild(svgimg);
//		return svgimg;
//	},
//	
//	importSVG: function(sourceSVG, targetCanvas) {
//	    svg_xml = sourceSVG;//(new XMLSerializer()).serializeToString(sourceSVG);
//	    var ctx = targetCanvas.getContext('2d');
//
//	    var img = new Image();
//	    img.src = "data:image/svg+xml;base64," + btoa(svg_xml);
////	    img.onload = function() {
//	        ctx.drawImage(img, 0, 0);
////	    };
//	}
//	
//};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function Region(args) {

    this.chromosome = null;
    this.start = null;
    this.end = null;

    if (_.isObject(args)) {
        this.load(args);
    } else if (_.isString(args)) {
        this.parse(args);
    }
}

Region.prototype = {
    load: function (obj) {
        if (_.isString(obj)) {
            return this.parse(obj);
        }
        this.chromosome = this._checkChromosomeAlias(obj) || this.chromosome;

        if (typeof obj.position !== 'undefined') {
            obj.start = parseInt(obj.position);
            obj.end = obj.start;
        }

        (_.isUndefined(obj.start)) ? this.start = parseInt(this.start) : this.start = parseInt(obj.start);
        (_.isUndefined(obj.end)) ? this.end = parseInt(this.end) : this.end = parseInt(obj.end);
    },

    parse: function (str) {
        if (_.isObject(str)) {
            this.load(obj);
        }
        var pattern = /^([a-zA-Z0-9_])+\:([0-9])+\-([0-9])+$/;
        var pattern2 = /^([a-zA-Z0-9_])+\:([0-9])+$/;
        if (pattern.test(str) || pattern2.test(str)) {
            var splitDots = str.split(":");
            if (splitDots.length == 2) {
                var splitDash = splitDots[1].split("-");
                this.chromosome = splitDots[0];
                this.start = parseInt(splitDash[0]);
                if (splitDash.length == 2) {
                    this.end = parseInt(splitDash[1]);
                } else {
                    this.end = this.start;
                }
            }
            return true
        } else {
            return false;
        }
    },

    multiParse: function (str) {
        if (_.isObject(str)) {
            this.load(obj);
        }
        var pattern = /^([a-zA-Z0-9_])+\:([0-9])+\-([0-9])+(,([a-zA-Z0-9_])+\:([0-9])+\-([0-9])+)*$/;
        var pattern2 = /^\[([a-zA-Z0-9_])+\:([0-9])+\-([0-9])+(,([a-zA-Z0-9_])+\:([0-9])+\-([0-9])+)*\]$/;

        var withoutBrackets = str;
        if (pattern2.test(str)) {
            withoutBrackets = str.slice(1, str.length - 1);
        }

        var regions = [];
        if (pattern.test(withoutBrackets)) {
            var splitRegions = withoutBrackets.split(",");
            for (var i = 0; i < splitRegions.length; i++) {
                regions.push(new Region(splitRegions[i]));
            }
        }
        return regions;
    },

    center: function () {
        return this.start + Math.floor((this.length()) / 2);
    },

    length: function () {
        return this.end - this.start + 1;
    },

    equals: function (r) {
        if (this.chromosome === r.chromosome && this.start === r.start && this.end === r.end) {
            return true;
        }
        return false;
    },

    toString: function (formated) {
        var str;
        if (formated == true) {
            str = this.chromosome + ":" + Utils.formatNumber(this.start) + "-" + Utils.formatNumber(this.end);
        } else {
            str = this.chromosome + ":" + this.start + "-" + this.end;
        }
        return str;
    },

    _checkChromosomeAlias: function (obj) {
        for (var i = 0; i < Region.chromosomeAlias.length; i++) {
            var alias = Region.chromosomeAlias[i];
            if(alias in obj){
                return obj[alias];
            }
        }
    }
};

Region.chromosomeAlias = ['chromosome','sequenceName'];


function Grid(args) {
    _.extend(this, Backbone.Events);

    // Default values
    this.id = Utils.genId("Grid");
    this.grid = null;
    this.store = null;
    this.model = null;

    _.extend(this, args);

}

Grid.prototype = {

    getPanel: function () {
        return this.grid;
    },
    getStore: function () {
        return this.store;
    },
    loadData: function (data) {
        this.store.loadData(data);
    },
    remove: function (record) {
        this.store.remove(record);
    },
    removeAll: function () {
        this.store.removeAll();
    },
    clear: function () {
        this.store.removeAll();
    },
    add: function (value) {
        this.store.add(value);
    },
    count: function () {
        return this.store.count();
    },
    getAt: function (pos) {
        if (pos >= 0) {
            return this.store.getAt(pos);
        }
    },
    refresh: function () {
        this.grid.getView().refresh();
    },
    getData: function () {
        var res = [];

        for (var i = 0; i < this.count(); i++) {
            res.push(this.getAt(i));
        }

        return res;
    },
    addAll: function (value) {
        for (var i = 0; i < value.length; i++) {
            this.add(value[i]);
        }
    },
    insert: function (pos, value) {
        this.store.insert(pos, value);
    },
    addColumn: function (attrName, attrType, columnName) {
        //debugger
        var fields = this.model.getFields();

        for (var i = 0; i < fields.length; i++) {
            if (fields.name == attrName && fields[i].type.type == attrType) {
                return false;
            }
        }

        var attr = new Ext.create('Ext.data.Field', {
            name: "prueba",
            type: "auto"
        });

        var col = new Ext.create('Ext.grid.column.Column', {
            text: "Prueba",
            dataIndex: "prueba",
            //flex:1,
            //sortable:true
        });

        fields.push(attr);
        this.model.setFields(fields);
        console.log(this.model.getFields());
        this.grid.columns.push(col);

    },
    createModel: function (name, attributes) {
        this.model = Ext.define(name, {
            extend: 'Ext.data.Model',
            fields: attributes
        });
    },
    createStore: function () {
        this.store = Ext.create('Ext.data.Store', {
            model: this.model,
            data: [],
            autoLoad: false
        });
    },
    setLoading: function (loading) {
        this.grid.setLoading(loading);
    }


};

/*
 * Binary Search Tree implementation in JavaScript
 * Copyright (c) 2009 Nicholas C. Zakas
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

/**
 * A binary search tree implementation in JavaScript. This implementation
 * does not allow duplicate values to be inserted into the tree, ensuring
 * that there is just one instance of each value.
 * @class BinarySearchTree
 * @constructor
 */
function FeatureBinarySearchTree() {
    
    /**
     * Pointer to root node in the tree.
     * @property _root
     * @type Object
     * @private
     */
    this._root = null;
}

FeatureBinarySearchTree.prototype = {

    //restore constructor
    constructor: FeatureBinarySearchTree,
    
    //-------------------------------------------------------------------------
    // Private members
    //-------------------------------------------------------------------------
    
    /**
     * Appends some data to the appropriate point in the tree. If there are no
     * nodes in the tree, the data becomes the root. If there are other nodes
     * in the tree, then the tree must be traversed to find the correct spot
     * for insertion. 
     * @param {variant} value The data to add to the list.
     * @return {Void}
     * @method add
     */
    add: function (v){
        //create a new item object, place data in
        var node = { 
                value: v, 
                left: null,
                right: null 
            },
            
            //used to traverse the structure
            current;
    
        //special case: no items in the tree yet
        if (this._root === null){
            this._root = node;
            return true;
        } 
        	//else
            current = this._root;
            
            while(true){
            
                //if the new value is less than this node's value, go left
                if (node.value.end < current.value.start){
                
                    //if there's no left, then the new node belongs there
                    if (current.left === null){
                        current.left = node;
                        return true;
//                        break;
                    } 
                    	//else                  
                        current = current.left;
                    
                //if the new value is greater than this node's value, go right
                } else if (node.value.start > current.value.end){
                
                    //if there's no right, then the new node belongs there
                    if (current.right === null){
                        current.right = node;
                        return true;
//                        break;
                    } 
                    	//else
                        current = current.right;
 
                //if the new value is equal to the current one, just ignore
                } else {
                	return false;
//                    break;
                }
            }        
        
    },
    
    contains: function (v){
        var node = { 
                value: v, 
                left: null,
                right: null 
            },
    	found = false,
    	current = this._root;
          
      //make sure there's a node to search
      while(!found && current){
      
          //if the value is less than the current node's, go left
          if (node.value.end < current.value.start){
              current = current.left;
              
          //if the value is greater than the current node's, go right
          } else if (node.value.start > current.value.end){
              current = current.right;
              
          //values are equal, found it!
          } else {
              found = true;
          }
      }
      
      //only proceed if the node was found
      return found;   
        
    }
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

var CellBaseManager = {
    host: (typeof window.CELLBASE_HOST === 'undefined') ? 'http://bioinfo.hpc.cam.ac.uk/cellbase' : window.CELLBASE_HOST,
    version: (typeof window.CELLBASE_VERSION === 'undefined') ? 'v3' : window.CELLBASE_VERSION,
    get: function(args) {
        var success = args.success;
        var error = args.error;
        var async = (args.async == false) ? false: true;

        // remove XMLHttpRequest keys
        var ignoreKeys = ['success', 'error', 'async'];
        var urlConfig = {};
        for (var prop in args) {
            if (hasOwnProperty.call(args, prop) && args[prop] != null && ignoreKeys.indexOf(prop) == -1) {
                urlConfig[prop] = args[prop];
            }
        }

        var url = CellBaseManager.url(urlConfig);
        if (typeof url === 'undefined') {
            return;
        }

        if (window.CELLBASE_LOG != null && CELLBASE_LOG === true) {
            console.log(url);
        }

        var d;
        var request = new XMLHttpRequest();
        request.onload = function() {
            var contentType = this.getResponseHeader('Content-Type');
            if (contentType === 'application/json') {
                var parsedResponse = JSON.parse(this.response);
                if (typeof success === "function") success(parsedResponse);
                d = parsedResponse;
            } else {
                console.log('Cellbase returned a non json object or list, please check the url.');
                console.log(url);
                console.log(this.response)
            }
        };
        request.onerror = function() {
            console.log("CellBaseManager: Ajax call returned " + this.statusText);
            if (typeof error === "function") error(this);
        };
        request.open("GET", url, async);
        request.send();
        return d;

    },
    url: function(args) {
        if (args == null) {
            args = {};
        }
        if (args.params == null) {
            args.params = {};
        }

        var version = this.version;
        if (args.version != null) {
            version = args.version
        }

        var host = this.host;
        if (args.host != null) {
            host = args.host;
        }

        delete args.host;
        delete args.version;

        var config = {
            host: host,
            version: version
        };

        for (var prop in args) {
            if (hasOwnProperty.call(args, prop) && args[prop] != null) {
                config[prop] = args[prop];
            }
        }

        var query = '';
        if (config.query != null) {
            query = '/' + config.query.toString();
        }

        //species can be the species code(String) or an object with text attribute
        if (config.species && config.species.id != null) {
            if (config.species.assembly != null) {
                config.params["assembly"] = config.species.assembly.name;
            }
            // TODO Remove temporary fix
            if (config.subCategory === 'chromosome') {
                delete config.params["assembly"]
            }
            config.species = Utils.getSpeciesCode(config.species.scientificName);
        }

        var url;
        if (config.category === 'meta') {
            url = config.host + '/webservices/rest/' + config.version + '/' + config.category + '/' + config.subCategory;
        } else {
            url = config.host + '/webservices/rest/' + config.version + '/' + config.species + '/' + config.category + '/' + config.subCategory + query + '/' + config.resource;
        }


        url = Utils.addQueryParamtersToUrl(config.params, url);
        return url;
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 *
 */

/**
 * Composes an url with the given parameters.
 * resourceType: any of OpencgaManager.resourceTypes.
 * resourceId: id of the resource in catalog.
 * action: all actions are in OpencgaManager.actions, but some methods don't allow every action.
 * queryParams: Object with the query parameters.
 * args: Object with extra arguments, like the success callback function, or host override.
 *
 * examples of use:
 *
 * OpencgaManager.users.create({
 *      query:{
 *          userId: 'user1',
 *          name: 'User One',
 *          email: 'user@example.com',
 *          password: 'password_one'
 *      },
 *      request:{
 *          success:function(response){
 *              console.log(response);
 *          },
 *          error:function(){
 *              console.log('Server error');
 *          }
 *      }
 * });
 *
 * OpencgaManager.users.login({
 *      id:'user1',
 *      query:{
 *          password: 'password_one'
 *      },
 *      request:{
 *          success:function(response){
 *              console.log(response);
 *          },
 *          error:function(){
 *              console.log('Server error');
 *          }
 *      }
 * });
 *
 * OpencgaManager.users.info({
 *      id:'user1',
 *      query:{
 *          sid: Cookies('bioinfo_sid'),
 *          lastActivity: 'lastActivity'
 *      },
 *      request:{
 *          success:function(response){
 *              console.log(response);
 *          },
 *          error:function(){
 *              console.log('Server error');
 *          }
 *      }
 * });
 *
 *    http://cafetal:8080/opencga/rest/files/3/fetch?region=20:100-200&sid=nsrblm
 *    http://cafetal:8080/opencga/rest/files/17/fetch?sid=eUZtTdnA9EU89vjACyAe&region=20%3A80000-82000&view_as_pairs=false&include_coverage=true&process_differences=false
 *    http://cafetal:8080/opencga/rest/files/17/fetch?sid=eUZtTdnA9EU89vjACyAe&region=20%3A80000-82000&view_as_pairs=false&include_coverage=true&process_differences=false
 */
var OpencgaManager = {
    host: (typeof window.OPENCGA_HOST === 'undefined') ? 'http://ws1.babelomics.org/opencga-0.7' : window.OPENCGA_HOST,
    version: (typeof window.OPENCGA_VERSION === 'undefined') ? 'v1' : window.OPENCGA_VERSION,

    users: {
        login: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'login');
        },
        logout: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'logout');
        },
        read: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'info');
        },
        update: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'update');
        },
        updateEmail: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'change-email');
        },
        updatePassword: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'change-password');
        },
        resetPassword: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'reset-password');
        },
        create: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'create');
        },
        delete: function (args) {
            return OpencgaManager._doRequest(args, 'users', 'delete');
        }
    },

    projects: {
        list: function (args) {
            return OpencgaManager._doRequest(args, 'projects', 'all-projects');
        },
        read: function (args) {
            return OpencgaManager._doRequest(args, 'projects', 'info');
        },
        update: function (args) {
            return OpencgaManager._doRequest(args, 'projects', 'update');
        },
        create: function (args) {
            return OpencgaManager._doRequest(args, 'projects', 'create');
        },
        delete: function (args) {
            return OpencgaManager._doRequest(args, 'projects', 'delete');
        },
        studies: function (args) {
            return OpencgaManager._doRequest(args, 'projects', 'studies');
        }
    },

    studies: {
        list: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'all-studies');
        },
        read: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'info');
        },
        update: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'update');
        },
        create: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'create');
        },
        delete: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'delete');
        },
        analysis: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'analysis');
        },
        jobs: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'jobs');
        },
        samples: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'samples');
        },
        variants: function (args) {
            return OpencgaManager._doRequest(args, 'studies', 'variants');
        },
        files: function (args){
          return OpencgaManager._doRequest(args, 'studies', 'files');
        }
    },
    cohorts: {
        create: function (args) {
            return OpencgaManager._doRequest(args, 'cohorts', 'create');
        },
        update: function (args) {
            return OpencgaManager._doRequest(args, 'cohorts', 'update');
        }
    },

    files: {
        list: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'list');
        },
        fetch: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'fetch');
        },
        alignments: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'alignments');
        },
        variants: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'variants');
        },
        read: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'info');
        },
        info: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'info');
        },
        delete: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'delete');
        },
        index: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'index');
        },
        search: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'search');
        },
        filesByFolder: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'files');
        },
        content: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'content');
        },
        contentGrep: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'content-grep');
        },
        createFolder: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'create-folder');
        },
        setHeader: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'set-header');
        },
        contentExample: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'content-example');
        },
        downloadExample: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'download-example');
        },
        update: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'update');
        },
        download: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'download');
        },
        upload: function (args) {
            return OpencgaManager._doRequest(args, 'files', 'upload');
        },
        upload2: function (args) {
            /** Check if exists a file with the same name **/
            var query = {
                sid: Cookies('bioinfo_sid'),
                studyId: args.studyId,
            };
            // if (window.OPENCGA_OLD_URL_FORMAT != null && OPENCGA_OLD_URL_FORMAT === true) {
            //     var splitIndex = args.relativeFilePath.lastIndexOf("/") + 1;
            //     query.name = args.relativeFilePath.substring(splitIndex);
            //     query.directory = args.relativeFilePath.substring(0, splitIndex);
            // } else {
            // }
            query.path = args.relativeFilePath;
            OpencgaManager.files.search({
                query: query,
                request: {
                    success: function (response) {
                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                            if (response.response[0].result.length == 0) {

                                /** No file found with the same name -> start upload **/
                                var url = OpencgaManager._url({
                                    query: {
                                        sid: args.sid
                                    },
                                    request: {}
                                }, 'files', 'upload');
                                args.url = url;
                                OpencgaManager._uploadFile(args);

                            } else {
                                args.error('File already exists', response.response[0].result);
                            }
                        } else {
                            args.error(response.response[0].errorMsg);
                        }
                    },
                    error: function () {
                        args.error('Server error, try again later.');
                    }
                }
            });
        }

    },
    jobs: {
        create: function (args) {
            return OpencgaManager._doRequest(args, 'jobs', 'create');
        },
        delete: function (args) {
            return OpencgaManager._doRequest(args, 'jobs', 'delete');
        },
        info: function (args) {
            return OpencgaManager._doRequest(args, 'jobs', 'info');
        }
    },
    samples: {
        info: function (args) {
            return OpencgaManager._doRequest(args, 'samples', 'info');
        },
        search: function (args) {
            return OpencgaManager._doRequest(args, 'samples', 'search');
        },
        update: function (args) {
            return OpencgaManager._doRequest(args, 'samples', 'update');
        }
    },
    util: {
        proxy: function (args) {
            return OpencgaManager._doRequest(args, 'util', 'proxy');
        }
    },
    tools: {
        search: function (args) {
            return OpencgaManager._doRequest(args, 'tools', 'search');
        },
        info: function (args) {
            return OpencgaManager._doRequest(args, 'tools', 'info');
        },
        help: function (args) {
            return OpencgaManager._doRequest(args, 'tools', 'help');
        },
        update: function (args) {
            return OpencgaManager._doRequest(args, 'tools', 'update');
        },
        delete: function (args) {
            return OpencgaManager._doRequest(args, 'tools', 'delete');
        }
    },
    //analysis: {
    //    jobs: function (args) {
    //        return OpencgaManager._doRequest(args, 'analysis', 'jobs');
    //    },
    //    create: function (args) {
    //        return OpencgaManager._doRequest(args, 'analysis', 'create');
    //},
    _url: function (args, api, action) {
        var host = OpencgaManager.host;
        if (typeof args.request.host !== 'undefined' && args.request.host != null) {
            host = args.request.host;
        }
        var version = OpencgaManager.version;
        if (typeof args.request.version !== 'undefined' && args.request.version != null) {
            version = args.request.version;
        }
        var id = '';
        if (typeof args.id !== 'undefined' && args.id != null) {
            id = '/' + args.id;
        }

        var url = host + '/webservices/rest/' + version + '/' + api + id + '/' + action;
        // if (window.OPENCGA_OLD_URL_FORMAT != null && OPENCGA_OLD_URL_FORMAT === true) {
        //     if (action == 'jobs') {
        //         action = 'job'
        //     }
        //     if (api == 'jobs') {
        //         api = 'job'
        //     }
        //     url = host + '/rest/' + api + id + '/' + action;
        // }
        url = Utils.addQueryParamtersToUrl(args.query, url);
        return url;
    },

    _doRequest: function (args, api, action) {
        var url = OpencgaManager._url(args, api, action);
        if (args.request.url === true) {
            return url;
        } else {
            var method = 'GET';
            if (typeof args.request.method !== 'undefined' && args.request.method != null) {
                method = args.request.method;
            }
            var async = true;
            if (typeof args.request.async !== 'undefined' && args.request.async != null) {
                async = args.request.async;
            }

            if (window.OPENCGA_LOG != null && OPENCGA_LOG === true) {
                console.log(url);
            }
            var request = new XMLHttpRequest();
            request.onload = function () {
                var contentType = this.getResponseHeader('Content-Type');
                if (contentType === 'application/json') {
                    var json = JSON.parse(this.response);
                    if (json.error === '' || json.error == null) {
                        args.request.success(json, this);
                    } else {
                        if (window.OPENCGA_LOG != null && OPENCGA_LOG === true) {
                            console.log('! ----    OpencgaManager -------');
                            console.log(json.error);
                            console.log(json);
                            console.log('! ----    OpencgaManager -------');
                        }
                        args.request.error(json, this);
                    }
                } else {
                    args.request.success(this.response, this);
                }
            };
            request.onerror = function (e) {
                args.request.error({
                    error: 'Request error.',
                    errorEvent: e
                }, this);
            };
            request.open(method, url, async);
            request.send();
            return url;
        }
    },
    _uploadFile: function (args) {
        var url = args.url;
        var inputFile = args.inputFile;
        var fileName = args.fileName;
        var userId = args.userId;
        var studyId = args.studyId;
        var relativeFilePath = args.relativeFilePath;
        var fileFormat = args.fileFormat;
        var bioFormat = args.bioFormat;
        var description = args.description;
        var callbackProgress = args.callbackProgress;

        /**/
        var resume = true;
        var resumeInfo = {};
        var chunkMap = {};
        var chunkId = 0;
        var blob = inputFile;
        var BYTES_PER_CHUNK = 2 * 1024 * 1024;
        var SIZE = blob.size;
        var NUM_CHUNKS = Math.max(Math.ceil(SIZE / BYTES_PER_CHUNK), 1);
        var start;
        var end;

        var getResumeInfo = function (formData) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, false); //false = sync call
            xhr.send(formData);
            var response = JSON.parse(xhr.responseText);
            return response.response[0];
        };
        var checkChunk = function (id, size, resumeInfo) {
            if (typeof resumeInfo[id] === 'undefined') {
                return false;
            } else if (resumeInfo[id].size != size /*|| resumeInfo[id].hash != hash*/ ) {
                return false;
            }
            return true;
        };
        var processChunk = function (c) {
            var chunkBlob = blob.slice(c.start, c.end);

            if (checkChunk(c.id, chunkBlob.size, resumeInfo) == false) {
                var formData = new FormData();
                formData.append('chunk_content', chunkBlob);
                formData.append('chunk_id', c.id);
                formData.append('chunk_size', chunkBlob.size);
                /*formData.append('chunk_hash', hash);*/
                formData.append("filename", fileName);
                formData.append('userId', userId);
                formData.append('studyId', studyId);
                formData.append('relativeFilePath', relativeFilePath);
                /*formData.append('chunk_gzip', );*/
                if (c.last) {
                    formData.append("last_chunk", true);
                    formData.append("total_size", SIZE);
                    formData.append("fileFormat", fileFormat);
                    formData.append("bioFormat", bioFormat);
                    console.log(bioFormat);
                    formData.append("description", description);
                }
                uploadChunk(formData, c, function (chunkResponse) {
                    /* FIX--------- Remove this "FIX block" after the server fix */
                    /* Bioformat is modified on server due to BioformatDetector bug */
                    /* https://github.com/opencb/opencga/blob/develop/opencga-analysis/src/main/java/org/opencb/opencga/analysis/files/FileMetadataReader.java#L123 */
                    /* Remove this ASAP, Server bioformatDetector should be invoked if no bioformat is provided. */
                    OpencgaManager.__fix_fileBioformat(chunkResponse, bioFormat, function (f) {
                        callbackProgress(c, NUM_CHUNKS, f);
                    });
                    /* FIX-END----- Remove this "FIX block" after the server fix */

                    /* SAVE the next line!! Uncomment this line after the FIX!!! */
                    // callbackProgress(c, NUM_CHUNKS, chunkResponse);
                    if (!c.last) {
                        processChunk(chunkMap[(c.id + 1)]);
                    } else {

                    }
                });
            } else {
                callbackProgress(c, NUM_CHUNKS);
                if (!c.last) {
                    processChunk(chunkMap[(c.id + 1)]);
                } else {

                }
            }

        };
        var uploadChunk = function (formData, chunk, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            xhr.onload = function (e) {
                chunk.done = true;
                console.log("chunk done");
                callback(JSON.parse(xhr.responseText));
            };
            xhr.send(formData);
        };

        /**/
        /**/

        if (resume) {
            var resumeFormData = new FormData();
            resumeFormData.append('resume_upload', resume);
            resumeFormData.append('filename', fileName);
            resumeFormData.append('userId', userId);
            resumeFormData.append('studyId', studyId);
            resumeFormData.append('relativeFilePath', relativeFilePath);
            resumeInfo = getResumeInfo(resumeFormData);
        }

        start = 0;
        end = BYTES_PER_CHUNK;
        while (start < SIZE) {
            var last = false;
            if (chunkId == (NUM_CHUNKS - 1)) {
                last = true;
            }
            chunkMap[chunkId] = {
                id: chunkId,
                start: start,
                end: end,
                done: false,
                last: last
            };
            start = end;
            end = start + BYTES_PER_CHUNK;
            chunkId++;
        }
        processChunk(chunkMap[0]);

    },
    __fix_fileBioformat: function (chunkResponse, bioFormat, cb) {
        // THIS IS A TEMPORAL FIX, REMOVE THIS FUNCTION ASAP
        if (chunkResponse.response[0].result != null) {
            var file = chunkResponse.response[0].result[0];
            OpencgaManager.files.update({
                id: file.id,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    bioformat: bioFormat
                },
                request: {
                    success: function (response) {
                        var f = response.response[0].result[0];
                        chunkResponse.response[0].result[0] = f;
                        cb(chunkResponse);
                    },
                    error: function (response) {}
                }
            });
        } else {
            cb(chunkResponse);
        }
    }
};

/**/
/**/
/**/
/**/
/**/
/**/
/**/
/**/
/**/
/**/
/**/
// resourceTypes: {
//     USERS: "users",
//     PROJECTS: "projects",
//     STUDIES: "studies",
//     FILES: "files",
//     ANALYSES: "analyses",
//     JOBS: "jobs"
// },
// actions: {
//     LOGIN: "login",
//     LOGOUT: "logout",
//     CREATE: "create",
//     UPLOAD: "upload",
//     INFO: "info",
//     LIST: "list",
//     FETCH: "fetch",
//     UPDATE: "update",
//     DELETE: "delete"
// },
// httpMethods: {}, // defined after OpencgaManager
//
// /**
//  * @param queryParams required: password, sid (sessionId)
//  * @return sid (sessionId)
//  */
// login: function(userId, queryParams, args) {
//     this._call(this.resourceTypes.USERS, userId, this.actions.LOGIN, queryParams, args);
// },
// /**
//  * @param queryParams required: sid (sessionId)
//  */
// logout: function(userId, queryParams, args) {
//     this._call(this.resourceTypes.USERS, "", this.actions.LOGOUT, queryParams, args);
// },
// /**
//  * @param queryParams required: {resource}Id, password, sid (sessionId)
//  */
// create: function(resourceType, queryParams, args) {
//     this._call(resourceType, "", this.actions.CREATE, queryParam, args);
// },
// /**
//  * @param queryParams required: sid (sessionId)
//  */
// upload: function(resourceType, queryParams, args) {
//     this._call(resourceType, "", this.actions.UPLOAD, queryParams, args);
// },
// /**
//  * @param action restricted to OpencgaManager.actions.INFO, OpencgaManager.actions.FETCH
//  * @param queryParams required: sid (sessionId)
//  */
// get: function(resourceType, resourceId, action, queryParams, args) {
//     //        resourceId = "7";
//     _.extend(queryParams, {
//         sid: "RNk4P0ttFGHyqLA3YGS8",
//         view_as_pairs: 'false',
//         include_coverage: 'true',
//         process_differences: 'false'
//     });
//     this._call(resourceType, resourceId, action, queryParams, args);
// },
// /**
//  * @param queryParams required: sid (sessionId)
//  */
// list: function(resourceType, queryParams, args) {
//     this._call(resourceType, "", this.actions.LIST, queryParams, args);
// },
// /**
//  * @param queryParams required: sid (sessionId)
//  */
// update: function(resourceType, resourceId, queryParams, args) {
//     this._call(resourceType, resourceId, this.actions.UPDATE, queryParams, args);
// },
// /**
//  * @param queryParams required: sid (sessionId)
//  */
// delete: function(resourceType, resourceId, queryParams, args) {
//     this._call(resourceType, resourceId, this.actions.DELETE, queryParams, args);
// },
//
// _call: function(resourceType, resourceId, action, queryParams, args) {
//     var url = this._url(resourceType, resourceId, action, queryParams, args);
//
//     if (typeof url === 'undefined' || url == null) {
//         return;
//     }
//     console.log(url);
//     var async = (_.isUndefined(args.async) || _.isNull(args.async)) ? true: args.async;
//     var success = args.success;
//     var error = args.error;
//
//     var d;
//     $.ajax({
//         type: OpencgaManager.httpMethods[resourceType],
//         url: url,
//         dataType: 'json', //still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//         async: async,
//         success: function(data, textStatus, jqXHR) {
//             if ($.isPlainObject(data) || $.isArray(data)) {
//                 //                    data.params = args.params;
//                 //                    data.resource = args.resource;
//                 //                    data.category = args.category;
//                 //                    data.subCategory = args.subCategory;
//                 if (_.isFunction(success)) {
//                     success(data);
//                 }
//                 d = data;
//             } else {
//                 console.log('Cellbase returned a non json object or list, please check the url.');
//                 console.log(url);
//                 console.log(data)
//             }
//         },
//         error: function(jqXHR, textStatus, errorThrown) {
//             console.log("CellBaseManager: Ajax call returned : " + errorThrown + '\t' + textStatus + '\t' + jqXHR.statusText + " END");
//             if (_.isFunction(error)) {
//                 error(jqXHR, textStatus, errorThrown);
//             }
//         }
//     });
//     return url;
// },
//
// _url2: function(resourceType, resourceId, action, queryParams, args) {
//     if (resourceId == undefined || resourceId == null) {
//         resourceId = "";
//     } else {
//         resourceId = resourceId + "/";
//     }
//     var host = this.host;
//     if (typeof args.host !== 'undefined' && args.host != null) {
//         host = args.host;
//     }
//     var opencga = this.opencga;
//     if (typeof args.opencga !== 'undefined' && args.opencga != null) {
//         opencga = args.opencga;
//     }
//     /* still no version in the REST api
//      var version = this.version;
//      if(typeof args.version !== 'undefined' && args.version != null){
//      version = args.version
//      }
//      */
//     var url = host + opencga + resourceType + '/' + resourceId + action;
//     /*
//      _.extend(queryParams, {
//      sid: 'RNk4P0ttFGHyqLA3YGS8',
//      view_as_pairs: 'false',
//      include_coverage: 'true',
//      process_differences: 'false'
//      });*/
//
//     url = Utils.addQueryParamtersToUrl(queryParams, url);
//     return url;
// }

/*
 get: function (args) {
 var success = args.success;
 var error = args.error;
 var async = (_.isUndefined(args.async) || _.isNull(args.async) ) ? true : args.async;
 var urlConfig = _.omit(args, ['success', 'error', 'async']);

 var url = OpencgaManager.url(urlConfig);
 if(typeof url === 'undefined'){
 return;
 }
 console.log(url);

 var d;
 $.ajax({
 type: "GET",
 url: url,
 dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
 async: async,
 success: function (data, textStatus, jqXHR) {
 if($.isPlainObject(data) || $.isArray(data)){
 //                    data.params = args.params;
 //                    data.resource = args.resource;
 //                    data.category = args.category;
 //                    data.subCategory = args.subCategory;
 if (_.isFunction(success)) {
 success(data);
 }
 d = data;
 }else{
 console.log('Cellbase returned a non json object or list, please check the url.');
 console.log(url);
 console.log(data)
 }
 },
 error: function (jqXHR, textStatus, errorThrown) {
 console.log("CellBaseManager: Ajax call returned : " + errorThrown + '\t' + textStatus + '\t' + jqXHR.statusText + " END");
 if (_.isFunction(error)) error(jqXHR, textStatus, errorThrown);
 }
 });
 return d;
 },*/
//////// old version
//    host: (typeof OPENCGA_HOST === 'undefined') ? 'http://ws.bioinfo.cipf.es/opencga/rest' : OPENCGA_HOST,
//    getHost: function () {
//        return OpencgaManager.host;
//    },
//    setHost: function (hostUrl) {
//        OpencgaManager.host = hostUrl;
//    },
//    doGet: function (url, successCallback, errorCallback) {
//        $.ajax({
//            type: "GET",
//            url: url,
//            success: successCallback,
//            error: errorCallback
//        });
//    },
//    doPost: function (url, formData, successCallback, errorCallback) {
//        $.ajax({
//            type: "POST",
//            url: url,
//            data: formData,
//            processData: false,  // tell jQuery not to process the data
//            contentType: false,  // tell jQuery not to set contentType
//            success: successCallback,
//            error: errorCallback
//        });
//    },
//    getQuery: function (paramsWS) {
//        var query = "";
//        for (var key in paramsWS) {
//            if (paramsWS[key] != null)
//                query += key + '=' + paramsWS[key] + '&';
//        }
//        if (query != '')
//            query = "?" + query.slice(0, -1);
//        return query;
//    },
//
//
//    getAccountUrl: function (accountId) {
//        return OpencgaManager.getHost() + '/account/' + accountId;
//    },
//    getStorageUrl: function (accountId) {
//        return OpencgaManager.getAccountUrl(accountId) + '/storage';
//    },
//    getAdminProfileUrl: function (accountId) {
//        return OpencgaManager.getAccountUrl(accountId) + '/admin/profile';
//    },
//    getAdminBucketUrl: function (accountId, bucketId) {
//        return OpencgaManager.getAccountUrl(accountId) + '/admin/bucket/' + bucketId;
//    },
//    getAdminProjectUrl: function (accountId, projectId) {
//        return OpencgaManager.getAccountUrl(accountId) + '/admin/project/' + projectId;
//    },
//    getBucketUrl: function (accountId, bucketId) {
//        return OpencgaManager.getStorageUrl(accountId) + '/' + bucketId;
//    },
//    getObjectUrl: function (accountId, bucketId, objectId) {
//        return OpencgaManager.getStorageUrl(accountId) + '/' + bucketId + '/' + objectId;
//    },
//    getAnalysisUrl: function (accountId, analysis) {
//        return OpencgaManager.getAccountUrl(accountId) + '/analysis/' + analysis;
//    },
//    getJobAnalysisUrl: function (accountId, jobId) {
//        return OpencgaManager.getAccountUrl(accountId) + '/analysis/job/' + jobId;
//    },
//    getUtilsUrl: function () {
//        return OpencgaManager.getHost() + '/utils';
//    },
//    /*ACCOUNT METHODS*/
//    createAccount: function (args) {
////      accountId, email, name, password, suiteId
//        var queryParams = {
//            'name': args.name,
//            'email': args.email,
//            'password': args.password,
//            'suiteid': args.suiteId
//        };
//        var url = OpencgaManager.getAccountUrl(args.accountId) + '/create' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    login: function (args) {
////        accountId, password, suiteId
//        var queryParams = {
//            'password': args.password,
//            'suiteid': args.suiteId
//        };
//        var url = OpencgaManager.getAccountUrl(args.accountId) + '/login' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    logout: function (args) {
////        accountId, sessionId
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getAccountUrl(args.accountId) + '/logout' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    getAccountInfo: function (args) {
////        accountId, sessionId, lastActivity
////        console.log(args.lastActivity)
//        var queryParams = {
//            'last_activity': args.lastActivity,
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getAccountUrl(args.accountId) + '/info' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                if (data.response.errorMsg === '') {
//                    args.success(data.response.result[0]);
//                } else {
//                    $.cookie('bioinfo_sid', null);
//                    $.cookie('bioinfo_sid', null, {path: '/'});
//                    $.cookie('bioinfo_account', null);
//                    $.cookie('bioinfo_account', null, {path: '/'});
//                    console.log(data);
//                }
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    changePassword: function (args) {
////        accountId, sessionId, old_password, new_password1, new_password2
//        var queryParams = {
//            'old_password': args.old_password,
//            'new_password1': args.new_password1,
//            'new_password2': args.new_password2,
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getAdminProfileUrl(args.accountId) + '/change_password' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    resetPassword: function (args) {
////        accountId, email
//        var queryParams = {
//            'email': args.email
//        };
//        var url = OpencgaManager.getAdminProfileUrl(args.accountId) + '/reset_password' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    changeEmail: function (args) {
////        accountId, sessionId, new_email
//        var queryParams = {
//            'new_email': args.new_email,
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getAdminProfileUrl(args.accountId) + '/change_email' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//    /* BUCKET METHODS */
//    getBuckets: function () {
//        return 'TODO';
//    },
//
//    createBucket: function (args) {
////        bucketId, description, accountId, sessionId
//        var queryParams = {
//            'description': args.description,
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getAdminBucketUrl(args.accountId, args.bucketId) + '/create' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//    refreshBucket: function (args) {
////        accountId, bucketId, sessionId
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getAdminBucketUrl(args.accountId, args.bucketId) + '/refresh' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//    renameBucket: function (args) {
////        accountId, bucketId, newBucketId, sessionId
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getAdminBucketUrl(args.accountId, args.bucketId) + '/rename/' + args.newBucketId + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    deleteBucket: 'TODO',
//    shareBucket: 'TODO',
//
//    uploadObjectToBucket: function (args) {
////        accountId, sessionId, bucketId, objectId, formData, parents
//        var queryParams = {
//            'parents': (args.parents || false),
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getObjectUrl(args.accountId, args.bucketId, args.objectId) + '/upload' + OpencgaManager.getQuery(queryParams);
//        $.ajax({
//            type: "POST",
//            url: url,
//            data: args.formData,
//            processData: false,  // tell jQuery not to process the data
//            contentType: false,  // tell jQuery not to set contentType
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    createDirectory: function (args) {
////        accountId, sessionId, bucketId, objectId, parents
//        args.objectId = args.objectId.replace(new RegExp("/", "gi"), ":");
//        var queryParams = {
//            'parents': (args.parents || false),
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getObjectUrl(args.accountId, args.bucketId, args.objectId) + '/create_directory' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    deleteObjectFromBucket: function (args) {
////        accountId, sessionId, bucketId, objectId
//        args.objectId = args.objectId.replace(new RegExp("/", "gi"), ":");
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getObjectUrl(args.accountId, args.bucketId, args.objectId) + '/delete' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    pollObject: function (args) {
////       accountId, sessionId, bucketId, objectId
//        var queryParams = {
//            'start': args.start,
//            'limit': args.limit,
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getObjectUrl(args.accountId, args.bucketId, args.objectId) + '/poll' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            async: args.async,
//            success: function (data, textStatus, jqXHR) {
//                args.success(data);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    grepObject: function (args) {
////       accountId, sessionId, bucketId, objectId
//        var queryParams = {
//            'pattern': encodeURIComponent(args.pattern),
//            'ignoreCase': args.ignoreCase,
//            'multi': args.multi,
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getObjectUrl(args.accountId, args.bucketId, args.objectId) + '/grep' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            async: args.async,
//            success: function (data, textStatus, jqXHR) {
//                args.success(data);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//    region: function (args) {
////        accountId, sessionId, bucketId, objectId, region, queryParams
//        args.objectId = args.objectId.replace(new RegExp("/", "gi"), ":");
//        args.queryParams["sessionid"] = args.sessionId;
//        args.queryParams["region"] = args.region;
//        args.queryParams["cellbasehost"] = CELLBASE_HOST + '/' + CELLBASE_VERSION;
//
//        if (OpencgaManager.host.indexOf("localhost") != -1) {
//            args.queryParams["region"] = args.region;
//            args.queryParams["filepath"] = args.objectId;
//            var url = OpencgaManager.host + '/storage/fetch' + OpencgaManager.getQuery(args.queryParams);
//        } else {
//            var url = OpencgaManager.getObjectUrl(args.accountId, args.bucketId, args.objectId) + '/fetch' + OpencgaManager.getQuery(args.queryParams);
//        }
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
////                args.success(data.response);
//
////               TODO fix
//                if (!(data.substr(0, 5).indexOf('ERROR') != -1)) {
//                    var jsonData = JSON.parse(data);
//                    var r = {response: []};
//                    for (var i = 0; i < args.region.length; i++) {
//                        var result = jsonData[i];
//                        // TODO temporal fix
//                        r.response.push({
//                            id: args.region[i],
//                            result: jsonData[i]
//                        });
//                    }
//                    args.success(r);
////                args.success({resource: args.queryParams["category"], response: JSON.parse(data), filename: args.objectId, query: args.region, params: args.queryParams});
//                }
//
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//
//        function success(data) {
//
//        }
//    },
//
//    /* JOB METHODS */
//    jobResult: function (args) {
////        accountId, sessionId, jobId, format
//        //@Path("/{accountid}/{bucketname}/job/{jobid}/result.{format}")
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/result.js' + OpencgaManager.getQuery(queryParams);
//        //var url = OpencgaManager.getHost() + '/job/'+jobId+'/result.'+format+'?incvisites=true&sessionid='+sessionId;
//
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//
////        function success(data) {
////            args.success(data);
////        }
////
////        function error(data) {
////            if (_.isFunction(args.error)) args.error(data);
////        }
////
////        OpencgaManager.doGet(url, success, error);
////        console.log(url);
//    },
//    jobResultUrl: function (args) {
////        accountId, sessionId, jobId, format
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        return OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/result.js' + OpencgaManager.getQuery(queryParams);
//    },
//    jobStatus: function (args) {
////        accountId, sessionId, jobId
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/status' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//    table: function (args) {
////        accountId, sessionId, jobId, filename, colNames, colVisibility
//        var queryParams = {
//            'filename': args.filename,
//            'colNames': args.colNames,
//            'colVisibility': args.colVisibility,
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/table' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//    tableurl: function (args) {
////        accountId, sessionId, jobId, filename, colNames, colVisibility
//        var queryParams = {
//            'filename': args.filename,
//            'colNames': args.colNames,
//            'colVisibility': args.colVisibility,
//            'sessionid': args.sessionId
//        };
//        return OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/table' + OpencgaManager.getQuery(queryParams);
//    },
//
//    poll: function (args) {
////        accountId, sessionId, jobId, filename, zip
//        var queryParams = {
//            'filename': args.filename,
//            'sessionid': args.sessionId
//        };
//        var url;
//        if (args.zip == true) {
//            url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/poll' + OpencgaManager.getQuery(queryParams);
//            open(url);
//        } else {
//            queryParams['zip'] = false;
//            url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/poll' + OpencgaManager.getQuery(queryParams);
//
//            $.ajax({
//                type: "GET",
//                url: url,
//                async: args.async,
//                success: function (data, textStatus, jqXHR) {
//                    args.success(data);
//                },
//                error: function (jqXHR, textStatus, errorThrown) {
//                    if (_.isFunction(args.error)) args.error(jqXHR);
//                }
//            });
//        }
//    },
//
//    jobFileGrep: function (args) {
////        accountId, sessionId, jobId, filename, zip
//        var queryParams = {
//            'pattern': encodeURIComponent(args.pattern),
//            'ignoreCase': args.ignoreCase,
//            'multi': args.multi,
//            'filename': args.filename,
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/grep' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            async: args.async,
//            success: function (data, textStatus, jqXHR) {
//                args.success(data);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//
//    pollurl: function (args) {
////        accountId, sessionId, jobId, filename
//        var queryParams = {
//            'filename': args.filename,
//            'sessionid': args.sessionId,
//            'zip': false
//        };
//        return OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/poll' + OpencgaManager.getQuery(queryParams);
//        //debugger
//    },
//
//    deleteJob: function (args) {
////        accountId, sessionId, jobId
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/delete' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//    downloadJob: function (args) {
////        accountId, sessionId, jobId
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        open(OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/download' + OpencgaManager.getQuery(queryParams));
//    },
//
//    jobInfo: function (args) {
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/info' + OpencgaManager.getQuery(queryParams);
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//
//    /* ANALYSIS */
//    runAnalysis: function (args) {
////        analysis, paramsWS
//        var accountId = args.paramsWS.accountid;
//        var queryParams = {
////            'projectId':'default'
//        };
//        var url = OpencgaManager.getAnalysisUrl(accountId, args.analysis) + '/run' + OpencgaManager.getQuery(queryParams);
//        console.log(url);
//
//        $.ajax({
//            type: "POST",
//            url: url,
//            data: args.paramsWS,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    indexer: function (args) {
////        accountId, sessionId, bucketId, objectId
//        var queryParams = {
//            'sessionid': args.sessionId
//        };
//        var url = OpencgaManager.getObjectUrl(args.accountId, args.bucketId, args.objectId) + '/index' + OpencgaManager.getQuery(queryParams);
//        $.ajax({
//            type: "GET",
//            url: url,
//            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
//            success: function (data, textStatus, jqXHR) {
//                args.success(data.response);
//            },
//            error: function (jqXHR, textStatus, errorThrown) {
//                if (_.isFunction(args.error)) args.error(jqXHR);
//            }
//        });
//    },
//    indexerStatus: function (args) {
////        accountId, sessionId, bucketId, objectId, indexerId
//        var queryParams = {
//            'sessionid': args.sessionId,
//            'indexerid': args.indexerId
//        };
//        var url = OpencgaManager.getObjectUrl(args.accountId, args.bucketId, args.objectId) + '/index_status' + OpencgaManager.getQuery(queryParams);
//        console.log(url);
//
//        function success(data) {
//            args.success(data);
//        }
//
//        function error(data) {
//            if (_.isFunction(args.error)) args.error(data);
//        }
//
//        OpencgaManager.doGet(url, success, error);
//    },
//
//    localFileList: function (args) {
//
//        var url = OpencgaManager.host + '/getdirs';
//        console.log(url);
//
//        function success(data) {
//            args.success(data);
//        }
//
//        function error(data) {
//            if (_.isFunction(args.error)) args.error(data);
//        }
//
//        OpencgaManager.doGet(url, success, error);
//    },
//
//
//    /********/
//    /********/
//    /********/
//    /********/
//    /********/
//    // variation
//    variantsUrl: function (args) {
////        accountId, jobId
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/variantsMongo'
//        return url
//    },
//    variantInfoMongo: function (args) {
////        accountId, sessionId, jobId, filename
//        var queryParams = {
//            'sessionid': args.sessionId
////            'filename': args.filename
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/variantInfoMongo' + OpencgaManager.getQuery(queryParams);
//
//        function success(data) {
//            console.log(data);
//            args.success(data);
//        }
//
//        function error(data) {
//            if (_.isFunction(args.error)) args.error(data);
//        }
//
//        $.ajax({
//            type: "GET",
//            url: url,
//            async: args.async,
//            success: success,
//            error: error
//        });
//        //	console.log(url);
//    },
//
//
//    variant_effects: function (args) {
////        accountId, sessionId, jobId, filename
//        var queryParams = {
//            'sessionid': args.sessionId,
//            'filename': args.filename
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/variant_effects' + OpencgaManager.getQuery(queryParams);
//
//        function success(data) {
//            args.success(data);
//        }
//
//        function error(data) {
//            if (_.isFunction(args.error)) args.error(data);
//        }
//
//        $.ajax({
//            type: "POST",
//            url: url,
//            data: args.formData,
//            dataType: 'json',
//            success: success,
//            error: error
//        });
//
////        OpencgaManager.doPost(url, args.formData ,success, error);
//        //	console.log(url);
//    },
//    variantInfo: function (args) {
////        accountId, sessionId, jobId, filename
//        var queryParams = {
//            'sessionid': args.sessionId,
//            'filename': args.filename
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/variant_info' + OpencgaManager.getQuery(queryParams);
//
//        function success(data) {
//            console.log(data);
//            args.success(data);
//        }
//
//        function error(data) {
//            if (_.isFunction(args.error)) args.error(data);
//        }
//
//        OpencgaManager.doGet(url, success, error);
//        //	console.log(url);
//    },
//    variantStats: function (args) {
////        accountId, sessionId, jobId, filename
//        var queryParams = {
//            'sessionid': args.sessionId,
//            'filename': args.fileName
//        };
//        var url = OpencgaManager.getJobAnalysisUrl(args.accountId, args.jobId) + '/variant_stats' + OpencgaManager.getQuery(queryParams);
//
//        function success(data) {
//            args.success(data);
//        }
//
//        function error(data) {
//            if (_.isFunction(args.error)) args.error(data);
//        }
//
//        $.ajax({
//            type: "POST",
//            url: url,
//            data: args.formData,
//            dataType: 'json',
//            success: success,
//            error: error
//        });
//
////        OpencgaManager.doPost(url, args.formData ,success, error);
//        //	console.log(url);
//    }
// };

// OpencgaManager.httpMethods[OpencgaManager.actions.LOGIN] = "GET";
// OpencgaManager.httpMethods[OpencgaManager.actions.LOGOUT] = "GET";
// OpencgaManager.httpMethods[OpencgaManager.actions.CREATE] = "GET";
// OpencgaManager.httpMethods[OpencgaManager.actions.UPLOAD] = "POST";
// OpencgaManager.httpMethods[OpencgaManager.actions.INFO] = "GET";
// OpencgaManager.httpMethods[OpencgaManager.actions.LIST] = "GET";
// OpencgaManager.httpMethods[OpencgaManager.actions.FETCH] = "GET";
// OpencgaManager.httpMethods[OpencgaManager.actions.UPDATE] = "GET";
// OpencgaManager.httpMethods[OpencgaManager.actions.DELETE] = "GET";

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

var EnsemblManager = {
    host : 'http://beta.rest.ensembl.org',
//    http://beta.rest.ensembl.org/feature/region/human/7:140424943-140624564?feature=gene;feature=transcript;feature=exon;content-type=application/json
    get: function (args) {
        var success = args.success;
        var error = args.error;
        var async = (_.isUndefined(args.async) || _.isNull(args.async) ) ? true : args.async;
        var urlConfig = _.omit(args, ['success', 'error', 'async']);

        var url = EnsemblManager.url(urlConfig);
        if(typeof url === 'undefined'){
            return;
        }
        console.log(url);

        var d;
        $.ajax({
            type: "GET",
            url: url,
            dataType: 'json',//still firefox 20 does not auto serialize JSON, You can force it to always do the parsing by adding dataType: 'json' to your call.
            async: async,
            success: function (data, textStatus, jqXHR) {
                if($.isPlainObject(data) || $.isArray(data)){
//                    data.params = args.params;
//                    data.resource = args.resource;
//                    data.category = args.category;
//                    data.subCategory = args.subCategory;
                    if (_.isFunction(success)) success(data);
                    d = data;
                }else{
                    console.log('Cellbase returned a non json object or list, please check the url.');
                    console.log(url);
                    console.log(data)
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log("CellBaseManager: Ajax call returned : " + errorThrown + '\t' + textStatus + '\t' + jqXHR.statusText + " END");
                if (_.isFunction(error)) error(jqXHR, textStatus, errorThrown);
            }
        });
        return d;
    },
    url: function (args) {
        if (!$.isPlainObject(args)) args = {};
        if (!$.isPlainObject(args.params)) args.params = {};

        var host = EnsemblManager.host;
        if (typeof args.host !== 'undefined') {
            host =  args.host;
        }
        if(typeof host === 'undefined'){
            console.log("CELLBASE_HOST is not configured");
            return;
        }

        delete args.host;

        var config = {
            host: host
        };

        var params = {
            'content-type':'application/json'
        };

        _.extend(config, args);
        _.extend(config.params, params);

        //species can be the species code(String) or an object with text attribute
        if ($.isPlainObject(config.species)) {
            config.species = Utils.getSpeciesCode(config.species.text);
        }

        var url = config.host + '/' + config.category + '/' + config.subCategory + '/' + config.species + '/' +  config.query;
        url = Utils.addQueryParamtersToUrl(config.params, url);
        return url;
    }
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function FileWidget(args){
	var _this=this;

    _.extend(this, Backbone.Events);

    this.id = Utils.genId("FileWidget");
	this.targetId;
	this.wum = true;
	this.tags = [];
    this.viewer;
    this.title;
	this.dataAdapter;

    this.args = args;

    _.extend(this, args);


    this.on(this.handlers);

//	this.browserData = new BrowserDataWidget();
	/** Events i listen **/
//	this.browserData.onSelect.addEventListener(function (sender, data){
//		_this.trackNameField.setValue(data.filename);
//		_this.fileNameLabel.setText('<span class="emph">'+ data.filename +'</span> <span class="info">(server)</span>',false);
//		_this.panel.setLoading();
//	});
//    this.browserData.adapter.onReadData.addEventListener(function (sender, data){
//    	console.log(data)
//    	_this.trackNameField.setValue(data.filename);
//    	_this.fileNameLabel.setText('<span class="emph">'+ data.filename +'</span> <span class="info">(server)</span>',false);
//    	_this.loadFileFromServer(data);
//    	_this.panel.setLoading(false);
//	});
    
//    this.chartWidgetByChromosome = new ChartWidget({height:200,width:570});
};

FileWidget.prototype.getTitleName = function(){
	return this.trackNameField.getValue();
};


FileWidget.prototype.getFileFromServer = function(){
	//abstract method
};

FileWidget.prototype.loadFileFromLocal = function(){
	//abstract method
};

//FileWidget.prototype.getChartItems = function(){
//	return [this.chartWidgetByChromosome.getChart(["features","chromosome"])];
//};

FileWidget.prototype.getFileUpload = function(){
	var _this = this;
	this.uploadField = Ext.create('Ext.form.field.File', {
		msgTarget : 'side',
		flex:1,
        padding:1,
//		width:75,
		emptyText: 'Choose a file',
        allowBlank: false,
        anchor: '100%',
		buttonText : 'Browse local',
//		buttonOnly : true,
		listeners : {
			change : {
				fn : function() {
					_this.panel.setLoading();
					var file = document.getElementById(_this.uploadField.fileInputEl.id).files[0];

					_this.trackNameField.setValue(file.name);
					_this.fileNameLabel.setText('<span class="emph">'+ file.name +'</span> <span class="info">(local)</span>',false);
					_this.loadFileFromLocal(file);
					_this.panel.setLoading(false);

				}
			}
		}
	});
	return this.uploadField;
};


FileWidget.prototype.draw = function(){
	var _this = this;
	
	if (this.openDialog == null){
	
		/** Bar for the chart **/
		var featureCountBar = Ext.create('Ext.toolbar.Toolbar');
		this.featureCountLabel = Ext.create('Ext.toolbar.TextItem', {
			text:'<span class="dis">No file loaded</span>'
		});
		featureCountBar.add([this.featureCountLabel]);
		
		/** Bar for the file upload browser **/
		var browseBar = Ext.create('Ext.toolbar.Toolbar');
		browseBar.add(this.getFileUpload());
		
		this.panel = Ext.create('Ext.panel.Panel', {
			border: false,
	//		padding: "0 0 10 0",
			height:230,
			title: "Previsualization",
//		    items : this.getChartItems(),
		    bbar:featureCountBar
		});
		
	//	var colorPicker = Ext.create('Ext.picker.Color', {
	//	    value: '993300',  // initial selected color
	//	    listeners: {
	//	        select: function(picker, selColor) {
	//	            alert(selColor);
	//	        }
	//	    }
	//	});
		this.trackNameField = Ext.create('Ext.form.field.Text',{
			name: 'file',
            fieldLabel: 'Track Name',
            allowBlank: false,
            value: 'New track from '+this.title+' file',
            emptyText: 'Choose a name',
            flex:1
		});
		
		var panelSettings = Ext.create('Ext.panel.Panel', {
			border: false,
			layout: 'hbox',
			bodyPadding: 10,
		    items : [this.trackNameField]	 
		});
		
		
		if(this.wum){
//			this.btnBrowse = Ext.create('Ext.button.Button', {
//		        text: 'Browse server',
//		        disabled:true,
////		        iconCls:'icon-local',
////		        cls:'x-btn-default-small',
//		        handler: function (){
//	    	   		_this.browserData.draw($.cookie('bioinfo_sid'),_this.tags);
//	       		}
//			});
			
//			browseBar.add(this.btnBrowse);
			
			if(Cookies('bioinfo_sid') != null){
				this.sessionInitiated();
			}else{
				this.sessionFinished();
			}
		}
		
		this.fileNameLabel = Ext.create('Ext.toolbar.TextItem', {
//			text:'<span class="emph">Select a <span class="info">local</span> file or a <span class="info">server</span> file from your account.</span>'
		});
//		browseBar.add(['->',this.fileNameLabel]);
		
		
		
		this.btnOk = Ext.create('Ext.button.Button', {
			text:'Ok',
			disabled:true,
			handler: function(){
				_this.trigger('okButton:click',{fileName:_this.file.name, adapter:_this.adapter});
				_this.openDialog.close();
			}
		});
		
		this.openDialog = Ext.create('Ext.window.Window', {
			title : 'Open '+this.title+' file',
//			taskbar:Ext.getCmp(this.args.viewer.id+'uxTaskbar'),
			width : 600,
	//		bodyPadding : 10,
			resizable:false,
			items : [browseBar, /*this.panel,*/ panelSettings],
			buttons:[this.btnOk, 
			         {text:'Cancel', handler: function(){_this.openDialog.close();}}],
			listeners: {
			    	scope: this,
			    	minimize:function(){
						this.openDialog.hide();
			       	},
			      	destroy: function(){
			       		delete this.openDialog;
			      	}
		    	}
		});
		
	}
	this.openDialog.show();
};

//FileWidget.prototype._loadChartInfo = function(){
//
//	var datastore = new Array();
// 	for ( var chromosome in this.adapter.featuresByChromosome) {
//		datastore.push({ features: this.adapter.featuresByChromosome[chromosome], chromosome: chromosome });
//	}
// 	this.chartWidgetByChromosome.getStore().loadData(datastore);
//
// 	this.panel.setLoading(false);
// 	this.featureCountLabel.setText("Features count: " + this.adapter.featuresCount, false);
//};



FileWidget.prototype.sessionInitiated = function (){
//	if(this.btnBrowse!=null){
//		this.btnBrowse.enable();
//	}
};
FileWidget.prototype.sessionFinished = function (){
//	if(this.btnBrowse!=null){
//		this.btnBrowse.disable();
//	}
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

BEDFileWidget.prototype.getTitleName = FileWidget.prototype.getTitleName;
BEDFileWidget.prototype.getFileUpload = FileWidget.prototype.getFileUpload;
BEDFileWidget.prototype.draw = FileWidget.prototype.draw;
BEDFileWidget.prototype.sessionInitiated = FileWidget.prototype.sessionInitiated;
BEDFileWidget.prototype.sessionFinished = FileWidget.prototype.sessionFinished;
BEDFileWidget.prototype.getChartItems = FileWidget.prototype.getChartItems;
BEDFileWidget.prototype._loadChartInfo = FileWidget.prototype._loadChartInfo;

function BEDFileWidget(args){
	if (args == null){
		args = new Object();
	}
	args.title = "BED";
	args.tags = ["bed"];
	FileWidget.prototype.constructor.call(this, args);
	
};


BEDFileWidget.prototype.loadFileFromLocal = function(file){
	var _this = this;
	this.file = file;
	this.adapter = new BEDDataAdapter(new FileDataSource({file:file}),{species:this.viewer.species});
    this.adapter.on('file:load',function(e){
//		_this._loadChartInfo();
    });
	_this.btnOk.enable();
};


BEDFileWidget.prototype.loadFileFromServer = function(data){
	this.file = {name:data.filename};
	this.adapter = new BEDDataAdapter(new StringDataSource(data.data),{async:false,species:this.viewer.species});
	this._loadChartInfo();
	this.btnOk.enable();
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

GFFFileWidget.prototype.getTitleName = FileWidget.prototype.getTitleName;
GFFFileWidget.prototype.getFileUpload = FileWidget.prototype.getFileUpload;
GFFFileWidget.prototype.draw = FileWidget.prototype.draw;
GFFFileWidget.prototype.sessionInitiated = FileWidget.prototype.sessionInitiated;
GFFFileWidget.prototype.sessionFinished = FileWidget.prototype.sessionFinished;
GFFFileWidget.prototype.getChartItems = FileWidget.prototype.getChartItems;
GFFFileWidget.prototype._loadChartInfo = FileWidget.prototype._loadChartInfo;

function GFFFileWidget(args){
	if (args == null){
		args = {};
	}
	this.version = "2";
    if (args.version!= null){
    	this.version = args.version;       
    }
	args.title = "GFF"+this.version;
	args.tags = ["gff"];
	FileWidget.prototype.constructor.call(this, args);
};



GFFFileWidget.prototype.loadFileFromLocal = function(file){
	var _this = this;
	this.file = file;
	switch(this.version){
	case "2":
	case 2:
		this.adapter = new GFF2DataAdapter(new FileDataSource({file:file}),{species:this.viewer.species});
		break;
	case "3":
	case 3:
		this.adapter = new GFF3DataAdapter(new FileDataSource({file:file}),{species:this.viewer.species});
		break;
	default :
		this.adapter = new GFF2DataAdapter(new FileDataSource({file:file}),{species:this.viewer.species});
		break;
	}
	
	this.adapter.on('file:load',function(e){
//		_this._loadChartInfo();
	});
	_this.btnOk.enable();
};


GFFFileWidget.prototype.loadFileFromServer = function(data){
	this.file = {name:data.filename};
	switch(this.version){
	case "2":
	case 2:
		this.adapter = new GFF2DataAdapter(new StringDataSource(data.data),{async:false,species:this.viewer.species});
		break;
	case "3":
	case 3:
		this.adapter = new GFF3DataAdapter(new StringDataSource(data.data),{async:false,species:this.viewer.species});
		break;
	default :
		this.adapter = new GFF2DataAdapter(new StringDataSource(data.data),{async:false,species:this.viewer.species});
		break;
	}
	
	this._loadChartInfo();
	this.btnOk.enable();
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

GTFFileWidget.prototype.getTitleName = FileWidget.prototype.getTitleName;
GTFFileWidget.prototype.getFileUpload = FileWidget.prototype.getFileUpload;
GTFFileWidget.prototype.draw = FileWidget.prototype.draw;
GTFFileWidget.prototype.sessionInitiated = FileWidget.prototype.sessionInitiated;
GTFFileWidget.prototype.sessionFinished = FileWidget.prototype.sessionFinished;
GTFFileWidget.prototype.getChartItems = FileWidget.prototype.getChartItems;
GTFFileWidget.prototype._loadChartInfo = FileWidget.prototype._loadChartInfo;

function GTFFileWidget(args){
	if (args == null){
		args = new Object();
	}
	args.title = "GTF";
	args.tags = ["gtf"];
	FileWidget.prototype.constructor.call(this, args);
	
};

GTFFileWidget.prototype.loadFileFromLocal = function(file){
	var _this = this;
	this.file = file;
	this.adapter = new GTFDataAdapter(new FileDataSource({file:file}),{species:this.viewer.species});
	this.adapter.onLoad.addEventListener(function(sender){
		console.log(_this.adapter.featuresByChromosome);
		_this._loadChartInfo();
	});
	_this.btnOk.enable();
};


GTFFileWidget.prototype.loadFileFromServer = function(data){
	this.file = {name:data.filename};
	this.adapter = new GTFDataAdapter(new StringDataSource(data.data),{async:false,species:this.viewer.species});
	this._loadChartInfo();
	this.btnOk.enable();
};


/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function TrackSettingsWidget(args) {
	this.id = "TrackSettingsWidget"+ Math.round(Math.random()*10000);


    if (typeof args != 'undefined') {
        this.trackSvg = args.trackSvg || this.trackSvg;
        this.treeRecord = args.treeRecord || this.treeRecord;
	}


	this.filtersConfig = this.trackSvg.getFiltersConfig();
	this.filters = this.trackSvg.getFilters();
	if(this.filtersConfig != null){
		this.draw();
	}
}

TrackSettingsWidget.prototype = {
    setFilters : function(filters){
        this.trackSvg.setFilters(filters);
    },

    draw : function(){
        var _this = this;
        var items = [];
        var stores = [];

        for(var i = 0; i < this.filtersConfig.length; i++){
            var rootText = this.filtersConfig[i].text;
            var rootName = this.filtersConfig[i].name;

            var children = [];
            var checked;
            this.filters[rootName] != null ? checked=false : checked=true;
            for(var j = 0; j < this.filtersConfig[i].values.length; j++){
                children.push({text: this.filtersConfig[i].values[j], leaf: true, checked:checked, iconCls:"icon-blue-box"});
            }

            var root = {
                text:rootName,
                expanded: true,
                checked:checked,
                iconCls:"icon-box",
                children:children
            };
            var st = Ext.create('Ext.data.TreeStore',{root:root,fields:['text', 'name']});
            items.push({
                xtype:"treepanel",
                useArrows:true,
                //rootVisible: false,
                bodyPadding:"10 0 10 0",
                title : rootText,
                border:false,
                store:st,
                listeners:{
                    checkchange:function(node, checked, eOpts ){
                        if(node.isRoot()){
                            node.eachChild(function(n){
                                n.set("checked", checked);
                            });
                        }
                    },
                    afterrender:function(este){
                        //restore previous filter config
                        var node = este.getStore().getRootNode();
                        var name = node.get("text");
                        if(_this.filters[name] != null){
                            for(var i = 0; i < _this.filters[name].length; i++){
                                var child = node.findChild("text",_this.filters[name][i]);
                                child.set("checked",true);
                                child.save;
                            }
                        }
                    }
                }
            });

            stores.push(st);
        }

        var displaySettingsPanel = Ext.create('Ext.panel.Panel', {
            title: "Display settings",
            bodyPadding:10,
            items: [{
                xtype:'textfield',
                value: _this.trackSvg.getTitle(),
                fieldLabel:'TrackName',
                allowBlank: false,
                listeners:{
                    change:function(este, newValue){
                        if(este.isValid()){
                            _this.trackSvg.setTitle(newValue);
                            _this.treeRecord.set('text',newValue);
                            _this.treeRecord.save();
                        }
                    }
                }
            }
            ]
        });
        var tabFilter = Ext.create('Ext.tab.Panel', {
            title: "Filters",
            items: items
        });

        Ext.create('Ext.window.Window', {
            id:this.id+"window",
            title: 'Settings',
            width: 500,
            modal:true,
            items: [displaySettingsPanel, tabFilter],
            buttons:[{text:'Ok',id:this.id+"okButton", handler: function(){
                var filters = {};
                for(var i = 0; i < stores.length; i++){
                    var root = stores[i].getRootNode();
                    var name = root.get("text");
                    var checkValues = [];
                    var nodesLength = 0;
                    root.eachChild(function(node){
                        nodesLength++;
                        if(node.data.checked){
                            checkValues.push(node.get("text"));
                        }
                    });
                    //all check is the same as none checked
                    if(checkValues.length == nodesLength){
                        checkValues = [];
                    }
                    //if(checkValues.length > 0){
                    filters[name]=checkValues;
                    //}
                }
                console.log(filters)
                _this.setFilters(filters);
                Ext.getCmp(_this.id+"window").destroy();
            }
            },
                {text:'Cancel', handler: function(){
                    _this.trackSvg.setTitle(originalValue);
                    _this.treeRecord.set('text',originalValue);
                    _this.treeRecord.save();
                    Ext.getCmp(_this.id+"window").destroy();
                }}
            ]
        }).show();

        var originalValue = _this.trackSvg.getTitle();
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function UrlWidget(args) {
    var _this = this;

    _.extend(this, Backbone.Events);

    this.id = Utils.genId("UrlWidget");

    this.targetId = null;
    this.title = "Custom url";
    this.width = 500;
    this.height = 400;

    _.extend(this, args);
    this.on(this.handlers);

};

UrlWidget.prototype.draw = function () {
    if (this.panel == null) {
        this.render();
    }
    this.panel.show();
};

UrlWidget.prototype.render = function () {
    var _this = this;

    this.urlField = Ext.create('Ext.form.field.Text', {
        margin: "0 2 2 0",
        labelWidth: 30,
        width: this.width - 55,
        fieldLabel: 'URL',
        emptyText: 'enter a valid url',
//		value : "http://das.sanger.ac.uk/das/grc_region_GRCh37/features",
        value: "http://www.ensembl.org/das/Homo_sapiens.GRCh37.gene/features",
        listeners: { change: {fn: function () {
            var dasName = this.value.split('/das/')[1].split('/')[0];
            _this.trackNameField.setValue(dasName);
        }}
        }
    });
    this.checkButton = Ext.create('Ext.button.Button', {
        text: 'Check',
        handler: function () {
            _this.form.setLoading();
//			var dasDataAdapter = new DasRegionDataAdapter({
//				url : _this.urlField.getValue()
//			});
//			dasDataAdapter.successed.addEventListener(function() {
//				_this.contentArea.setValue(dasDataAdapter.xml);
//				_this.form.setLoading(false);
//			});
//
//			dasDataAdapter.onError.addEventListener(function() {
//				_this.contentArea.setValue("XMLHttpRequest cannot load. This server is not allowed by Access-Control-Allow-Origin");
//				_this.form.setLoading(false);
//			});
//			dasDataAdapter.fill(1, 1, 1);

            var dasAdapter = new DasAdapter({
                url: _this.urlField.getValue(),
                featureCache: {
                    gzip: false,
                    chunkSize: 10000
                },
                handlers: {
                    'url:check': function (event) {
                        console.log(event.data);
                        _this.contentArea.setValue(event.data);
                        _this.form.setLoading(false);

                    },
                    'error': function () {
                        _this.contentArea.setValue("XMLHttpRequest cannot load. This server is not allowed by Access-Control-Allow-Origin");
                        _this.form.setLoading(false);

                    }
                }
            });

            dasAdapter.checkUrl();
        }
    });
    this.trackNameField = Ext.create('Ext.form.field.Text', {
        name: 'file',
//        fieldLabel: 'Track name',
        allowBlank: false,
        value: _this.urlField.value.split('/das/')[1].split('/')[0],
        emptyText: 'Choose a name',
        flex: 1
    });
    this.panelSettings = Ext.create('Ext.panel.Panel', {
        layout: 'hbox',
        border: false,
        title: 'Track name',
        cls: "panel-border-top",
        bodyPadding: 10,
        width: this.width - 2,
        items: [this.trackNameField]
    });
    this.contentArea = Ext.create('Ext.form.field.TextArea', {
        margin: "-1",
        width: this.width,
        height: this.height
    });
    this.infobar = Ext.create('Ext.toolbar.Toolbar', {
        height: 28,
        cls: "bio-border-false",
        items: [this.urlField, this.checkButton]
    });
    this.form = Ext.create('Ext.panel.Panel', {
        border: false,
        items: [this.infobar, this.contentArea, this.panelSettings]
    });

    this.panel = Ext.create('Ext.ux.Window', {
        title: this.title,
        layout: 'fit',
        resizable: false,
        items: [this.form],
        buttons: [
            {
                text: 'Add',
                handler: function () {
                    _this.trigger('addButton:click', {name: _this.trackNameField.getValue(), url: _this.urlField.getValue()});
                    _this.panel.close();
                }
            },
            {text: 'Cancel', handler: function () {
                _this.panel.close();
            }}
        ],
        listeners: {
            destroy: function () {
                delete _this.panel;
            }
        }
    });
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

VCFFileWidget.prototype.getTitleName = FileWidget.prototype.getTitleName;
VCFFileWidget.prototype.getFileUpload = FileWidget.prototype.getFileUpload;
VCFFileWidget.prototype.draw = FileWidget.prototype.draw;
VCFFileWidget.prototype.sessionInitiated = FileWidget.prototype.sessionInitiated;
VCFFileWidget.prototype.sessionFinished = FileWidget.prototype.sessionFinished;
VCFFileWidget.prototype.getChartItems = FileWidget.prototype.getChartItems;
VCFFileWidget.prototype._loadChartInfo = FileWidget.prototype._loadChartInfo;

function VCFFileWidget(args){
	if (args == null){
		args = new Object();
	}
	args.title = "VCF";
	args.tags = ["vcf"];
	FileWidget.prototype.constructor.call(this, args);
};

VCFFileWidget.prototype.loadFileFromLocal = function(file){
	var _this = this;
	this.file = file;
	this.adapter = new VCFDataAdapter(new FileDataSource({file:file}),{species:this.viewer.species});
	this.adapter.on('file:load',function(sender){
		console.log(_this.adapter.featuresByChromosome);
//		_this._loadChartInfo();
	});
	_this.btnOk.enable();
};

VCFFileWidget.prototype.loadFileFromServer = function(data){
	this.file = {name:data.filename};
	this.adapter = new VCFDataAdapter(new StringDataSource(data.data),{async:false,species:this.viewer.species});
//	this._loadChartInfo();
	this.btnOk.enable();
};


/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function InfoWidget(targetId, species, args){
	this.id = "InfoWidget_" + Math.round(Math.random()*10000000);
	this.targetId = null;
	
	this.species=species;
	
	this.title = null;
	this.featureId = null;
	this.width = 800;
	this.height = 460;
	
	this.feature = null;
	this.query = null;
	this.adapter = null;
	
	
	if (targetId!= null){
		this.targetId = targetId;       
	}
	if (args != null){
        if (args.title!= null){
        	this.title = args.title;       
        }
        if (args.width!= null){
        	this.width = args.width;       
        }
        if (args.height!= null){
        	this.height = args.height;       
        }
    }
	
	switch (Utils.getSpeciesCode(species.text)){
	case "hsapiens":
		this.ensemblSpecie = "Homo_sapiens"; 
		this.reactomeSpecie = "48887"; 
		this.wikipathwaysSpecie = "Homo+sapiens"; 
		this.omimSpecie = ""; 
		this.uniprotSpecie = ""; 
		this.intactSpecie = ""; 
		this.dbsnpSpecie = ""; 
		this.haphapSpecie = ""; 
//		this.Specie = ""; 
		break;
	case "mmusculus":
		this.ensemblSpecies = "Mus_musculus"; 
		this.reactomeSpecies = "48892";
		this.wikipathwaysSpecie = "Mus+musculus"; 
		this.omimSpecie = ""; 
		this.uniprotSpecie = ""; 
		this.intactSpecie = ""; 
		this.dbsnpSpecie = ""; 
		this.haphapSpecie = ""; 
//		this.Specie = ""; 
		break;
	case "drerio":
		this.ensemblSpecie = "Danio_rerio"; 
		this.reactomeSpecie = "68323"; 
		this.wikipathwaysSpecie = "Danio+rerio"; 
		this.omimSpecie = ""; 
		this.uniprotSpecie = ""; 
		this.intactSpecie = ""; 
		this.dbsnpSpecie = ""; 
		this.haphapSpecie = ""; 
//		this.Specie = ""; 
		break;
	}
	
	this.notFoundPanel = Ext.create('Ext.panel.Panel',{
		id:this.id+"notFoundPanel",
		cls:'ocb-border-left-lightgrey',
		border:false,
		flex:3,
		bodyPadding:'40',
		html:'No results found'
	});
	
};

InfoWidget.prototype.draw = function (args){
	console.log(args);
//	this.featureId = feature.id;
	this.query = args.query;
	this.feature = args.feature;
	this.adapter = args.adapter;
//	if(feature.getName()==null){
//		console.log("getName not defined");
////		var feature = new Object();
////		feature.getName = function(){return feature;};
//	}	
	
//	console.log(feature.getName());
//	this.feature.getName = function(){return "a";};
	
	this.panel=Ext.getCmp(this.title +" "+ this.query);
	if (this.panel == null){
		//the order is important
		this.render();
		this.panel.show();
		this.getData();
	}else{
		this.panel.show();
	}
};

InfoWidget.prototype.render = function (){
		/**MAIN PANEL**/
		this.panel = Ext.create('Ext.window.Window', {
		    title: this.title +" "+ this.query,
		    id : this.title +" "+ this.query,
//		    resizable: false,
		    minimizable :true,
			constrain:true,
		    closable:true,
		    height:this.height,
		    width:this.width,
//		    modal:true,
//			layout: {type: 'table',columns: 2},
		    layout: { type: 'hbox',align: 'stretch'},
		    items: [this.getTreePanel()],
		    buttonAlign:'right',
//		    buttons:[],
		    listeners: {
			       scope: this,
			       minimize:function(){
			       		this.panel.hide();
			       },
			       destroy: function(){
			       		delete this.panel;
			       }
	        }
		});
};

InfoWidget.prototype.getTreePanel = function (){
		var dataTypes = this.getdataTypes();
	   	this.checkDataTypes(dataTypes);
	        
		var treeStore = Ext.create('Ext.data.TreeStore', {
		    root: {
		        expanded: true,
		        text: "Options",
		        children: dataTypes
		    }
		});
		
		var treePan = Ext.create('Ext.tree.Panel', {
		    title: 'Detailed information',
		    bodyPadding:10,
		    flex:1,
		   	border:false,
		    store: treeStore,
		    useArrows: true,
		    rootVisible: false,
		    listeners : {
			    	scope: this,
			    	itemclick : function (este,record){
			    		this.optionClick(record.data);
		    		}
			}
		});
		return treePan;
};



InfoWidget.prototype.doGrid = function (columns,fields,modelName,groupField){
		var groupFeature = Ext.create('Ext.grid.feature.Grouping',{
			groupHeaderTpl: '{[values.name]} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})',
			startCollapsed: true
	    });
		var filters = [];
		for(var i=0; i<fields.length; i++){
			filters.push({type:'string', dataIndex:fields[i]});
		}
		var filters = {
				ftype: 'filters',
				local: true, // defaults to false (remote filtering)
				filters: filters
		};
	    Ext.define(modelName, {
		    extend: 'Ext.data.Model',
	    	fields:fields
		});
	   	var store = Ext.create('Ext.data.Store', {
			groupField: groupField,
			model:modelName
	    });
		var grid = Ext.create('Ext.grid.Panel', {
			id: this.id+modelName,
	        store: store,
	        title : modelName,
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,        
	        features: [groupFeature,filters],
	        viewConfig: {
//	            stripeRows: true,
	            enableTextSelection: true
	        },
	        columns: columns,
	        bbar  : ['->', {
	            text:'Clear Grouping',
	            handler : function(){
	                groupFeature.disable();
	            }
	        }]
	    });
    return grid;
};


InfoWidget.prototype.checkDataTypes = function (dataTypes){
	for (var i = 0; i<dataTypes.length; i++){
		if(dataTypes[i]["children"]!=null){
			dataTypes[i]["iconCls"] ='icon-box';
			dataTypes[i]["expanded"] =true;
			this.checkDataTypes(dataTypes[i]["children"]);
		}else{
			dataTypes[i]["iconCls"] ='icon-blue-box';
			dataTypes[i]["leaf"]=true;
		}
	}
};

InfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return [];
};
InfoWidget.prototype.optionClick = function (){
	//Abstract method
};
InfoWidget.prototype.getData = function (){
	//Abstract method
};

InfoWidget.prototype.getGeneTemplate = function (){
	return  new Ext.XTemplate(
		    '<div><span class="panel-border-bottom"><span class="ssel s130">{name}</span> &nbsp; <span class="emph s120"> {id} </span></span>',
			' &nbsp; <a target="_blank" href="http://www.ensembl.org/'+this.ensemblSpecie+'/Location/View?g={id}">Ensembl</a>',
			' &nbsp; <a target="_blank" href="http://wikipathways.org//index.php?query={externalName}&species='+this.wikipathwaysSpecie+'&title=Special%3ASearchPathways&doSearch=1">Wikipathways</a>',
			'</div><br>',
		    '<div><span class="w75 infokey s90">Location: </span> <span class="">{chromosome}:{start}-{end} </span><span style="margin-left:50px" class=" infokey s90">Strand: </span> {strand}</div>',
		    '<div><span class="w75 infokey s90">Biotype: </span> {biotype}</div>',
		    '<div><span class="w75 infokey s90">Description: </span> <span><tpl if="description == &quot;&quot;">No description available</tpl>{description}</span></div>',
		    '<div><span class="w75 infokey s90">Source: </span> <span class="s110">{source}</span></div>',
//		    '<div><span class="w75 infokey s90">External DB: </span> {externalDb}</div>',
		    '<div><span class="w75 infokey s90">Status: </span> {status}</div>' // +  '<br>'+str
	);
};
InfoWidget.prototype.getTranscriptTemplate = function (){
	return new Ext.XTemplate(
		    '<div><span class="panel-border-bottom"><span class="ssel s130">{name}</span> &nbsp; <span class="emph s120"> {id} </span></span>',
		    ' &nbsp; <a target="_blank" href="http://www.ensembl.org/'+this.ensemblSpecie+'/Transcript/Transcript?t={id}">Ensembl</a>',
		    ' &nbsp; <a target="_blank" href="http://wikipathways.org//index.php?query={externalName}&species='+this.wikipathwaysSpecie+'&title=Special%3ASearchPathways&doSearch=1">Wikipathways</a>',
		    '</div><br>',
		    '<div><span class="w100 infokey s90">Location: </span> <span class="">{chromosome}:{start}-{end} </span><span style="margin-left:50px" class=" infokey s90">Strand: </span> {strand}</div>',
		    '<div><span class="w100 infokey s90">Biotype: </span> {biotype}</div>',
		    '<div><span class="w100 infokey s90">Description: </span> <span><tpl if="description == &quot;&quot;">No description available</tpl>{description}</span></div>',
		    '',
		    '<div><span class="w100 infokey s90">CDS &nbsp; (start-end): </span> {genomicCodingStart}-{genomicCodingEnd} <span style="margin-left:50px" class="w100 infokey s90">CDNA (start-end): </span> {cdnaCodingStart}-{cdnaCodingEnd}</div>',
            '<div><span class="w100 infokey s90">Protein: </span> {proteinID}</div>',
		    '<div><span class="w100 infokey s90">External DB: </span> {externalDb}</div>',
		    '<div><span class="w100 infokey s90">Status: </span> {status}</div><br>'// +  '<br>'+str
		);
};
InfoWidget.prototype.getSnpTemplate = function (){

//
//    alleleString: "C/T"
//    alternate: "T"
//    assembly: ""
//    chromosome: "13"
//    end: 32889669
//    featureAlias: "featureAlias"
//    featureId: "featureId"
//    id: "rs55880202"
//    populationFrequencies: null
//    reference: "C"
//    samples: Array[0]
//    source: ""
//    species: ""
//    start: 32889669
//    strand: "1"
//    transcriptVariations: Array[6]
//    type: "SNV"
//    validationStatus: "freq,1000Genome"
//    variantFreq: "variantFreq"
//    version: ""
//    xrefs: Array[0]

	return new Ext.XTemplate(
		    '<div><span class="panel-border-bottom"><span class="ssel s130">{id}</span></span>',
		    ' &nbsp; <a target="_blank" href="http://www.ensembl.org/'+this.ensemblSpecie+'/Variation/Summary?v={id}">Ensembl</a>',
		    '</div><br>',
		    '<div><span class="w140 infokey s90">Location: </span> <span class="">{chromosome}:{start}-{end} </span><span style="margin-left:50px" class=" infokey s90">Strand: </span> {strand}</div>',
		    '<div><span class="w140 infokey s90">Source: </span> <span class="s110">{source}</span></div>',
		    '<div><span class="w140 infokey s90">Type: </span> <span class="s110">{type}</span></div>',
		    '<div><span class="w140 infokey s90">Allele string: </span> {alleleString}</div>',
		    '<div><span class="w140 infokey s90">Ancestral allele: </span> {ancestralAllele}</div>',
		    '<div><span class="w140 infokey s90">Display SO consequence type: </span> {displayConsequenceType}</div>',
		    '<div><span class="w140 infokey s90">SO consequence types: </span> {consequenceTypes}</div>'
//		    '<div><span class="w140 infokey s90">Xrefs: </span> {xrefs}</div>'
//		    '<div><span class="w140 infokey s90">Sequence: </span> {sequence}</div>' // +  '<br>'+str
		);
};

InfoWidget.prototype.getExonTemplate = function (){
	return new Ext.XTemplate(
			'<span><span class="panel-border-bottom"><span class="ssel s110">{id}</span></span></span><br><br>',
			'<span><span class="infokey s90"> Location: </span> <span class="">{chromosome}:{start}-{end} </span></span><br>',
			'<span><span class="infokey s90"> Genomic coding (start-end) : </span> <span class="">{genomicCodingStart}-{genomicCodingEnd} </span></span><br>',
			'<span><span class="infokey s90"> cDNA (start-end) : </span> <span class="">{cdnaCodingStart}-{cdnaCodingEnd} </span></span><br>',
			'<span><span class="infokey s90"> CDS (start-end) : </span> <span class="">{cdsStart}-{cdsEnd} </span></span><br>',
			'<span><span class="infokey s90"> Phase: </span> {phase}</span><br>'
		);
};

InfoWidget.prototype.getProteinTemplate = function (){
	return new Ext.XTemplate(
			 '<div><span class="panel-border-bottom"><span class="ssel s130">{name}</span> &nbsp; <span class="emph s120"> {primaryAccession} </span></span></div>',
			 '<br>',
			 '<div><span class="w100 infokey s90">Full name: </span> <span class="">{fullName}</span></div>',
			 '<div><span class="w100 infokey s90">Gene name: </span> <span class="">{geneName}</span></div>',
			 '<div><span class="w100 infokey s90">Organism: </span> <span class="">{organism}</span></div>'
		);
};


InfoWidget.prototype.getVCFVariantTemplate = function (){
	return new Ext.XTemplate(
			'<div><span><span class="panel-border-bottom"><span class="ssel s130">{chromosome}:{start}-{alternate}</span> &nbsp; <span class="emph s120"> {id} </span></span></span></div><br>',
			'<div><span class="w75 infokey s90">Alt: </span> {alternate}</div>',
			'<div><span class="w75 infokey s90">Ref: </span> {reference}</div>',
			'<div><span class="w75 infokey s90">Quality: </span> {quality}</div>',
			'<div><span class="w75 infokey s90">Format: </span> {format}</div>',
			'<div><span class="w75 infokey s90">Samples: </span> {samples}</div>',
			'<div><span class="w75 infokey s90">Info: <br></span> {info}</div>'
		);
};

InfoWidget.prototype.getPWMTemplate = function (){
	return new Ext.XTemplate(
			 '<div><span class="panel-border-bottom"><span class="ssel s130">{accession}</span> &nbsp; <span class="emph s120"> {tfName} </span></span></div>',
			 '<br>',
			 '<div><span class="w100 infokey s90">Type: </span> <span class="">{source}</span></div>',
			 '<div><span class="w100 infokey s90">Source: </span> <span class="">{type}</span></div>',
			 '<div><span class="w100 infokey s90">Description: </span> <span class="">{description}</span></div>',
			 '<div><span class="w100 infokey s90">Length: </span> <span class="">{length}</span></div>',
			 '<div><span class="w100 infokey s90">Frequencies: </span> <span class="">{[this.parseFrequencies(values.frequencies)]}</span></div>',
			 {
				 parseFrequencies: function(values){
					 return '<div>'+values.replace(/,/gi, '<br>')+"</div>";
				 }
			 }
		);
};

InfoWidget.prototype.getProteinXrefTemplate = function (){
	return new Ext.XTemplate(
			'<div><span class="w75 emph s100">{[values.source.toUpperCase()]}</span> &nbsp; <span class="emph w125 s100"> {[this.generateLink(values)]} <span class="info">&raquo;</span> </span></div>',
			{
				generateLink: function(values){
					if(values.source!=null){
						switch(values.source.toUpperCase()){
						case "GO": 	return 		'<a TARGET="_blank" href="http://amigo.geneontology.org/cgi-bin/amigo/term_details?term='+values.name+'">'+values.name+'</a>'; break;
						case "REACTOME": return '<a TARGET="_blank" href="http://www.reactome.org/cgi-bin/eventbrowser_st_id?ST_ID='+values.name+'">'+values.name+'</a>'; break;
						case "KEGG": return 	'<a TARGET="_blank" href="http://www.genome.jp/dbget-bin/www_bget?'+values.name+'">'+values.name+'</a>'; break;
						case "INTACT": return 	'<a TARGET="_blank" href="http://www.ebi.ac.uk/intact/pages/interactions/interactions.xhtml?query='+values.name+'">'+values.name+'</a>'; break;
						case "MINT": return 	'<a TARGET="_blank" href="http://mint.bio.uniroma2.it/mint/search/search.do?queryType=protein&interactorAc='+values.name+'">'+values.name+'</a>'; break;
						case "DIP": return 		'<a TARGET="_blank" href="http://dip.doe-mbi.ucla.edu/dip/Browse.cgi?ID='+values.name+'">'+values.name+'</a>'; break;
						case "STRING": return 	'<a TARGET="_blank" href="http://string-db.org/newstring_cgi/show_network_section.pl?identifier=P51587">'+values.name+'</a>'; break;
						case "MIM": return 		'<a TARGET="_blank" href="http://www.omim.org/entry/'+values.name+'">'+values.name+'</a>'; break;
						case "PHARMGKB": return '<a TARGET="_blank" href="http://www.pharmgkb.org/do/serve?objId='+values.name+'&objCls=Gene">'+values.name+'</a>'; break;
						case "ORPHANET": return '<a TARGET="_blank" href="http://www.orpha.net/consor/cgi-bin/OC_Exp.php?lng=EN&Expert='+values.name+'">'+values.name+'</a>'; break;
						}
					}
					else{
						return "";
					}
				}
			}
		);
};

InfoWidget.prototype.getSnpTranscriptTemplate = function (){
//    alleleString: "C/T"
//    cdnEnd: 0
//    cdnaStart: 0
//    cdsEnd: 0
//    cdsStart: 0
//    codonAlleleString: ""
//    consequenceTypes: Array[1]
//    distanceToTranscript: 188
//    hgvsGenomic: "13:g.32889669C>T"
//    hgvsProtein: ""
//    hgvsTranscript: ""
//    peptideAlleleString: ""
//    polyphenPrediction: ""
//    polyphenScore: 0
//    siftPrediction: ""
//    siftScore: 0
//    somatic: "0"
//    transcriptId: "ENST00000533490"
//    translationEnd: 0
//    translationStart: 0

	return new Ext.XTemplate(
		    '<div><span class="panel-border-bottom"><span class="ssel s130">{[this.getStableId(values)]}</span></span>',
		    ' &nbsp; <a target="_blank" href="http://www.ensembl.org/'+this.ensemblSpecie+'/Transcript/Transcript?t={[this.getStableId(values)]}">Ensembl</a>',
		    '</div><br>',
		    '<div><span class="w140 infokey s90">CDS &nbsp; (start - end): </span> {cdsStart} - {cdsEnd} <span style="margin-left:50px" class="w100 infokey s90">cDNA (start - end): </span> {cdnaStart} - {cdnaEnd}</div>',
		    '<div><span class="w140 infokey s90">Translation (start - end): </span> {translationStart} - {translationEnd}</div>',
		    '<div><span class="w140 infokey s90">Peptide allele: </span> {peptideAlleleString}</div>',
//		    '<div><span class="w140 infokey s90">Alt. peptide allele: </span> {alternativePeptideAlleleString}</div>',
			'<div><span class="w140 infokey s90">Codon: </span> {codonAlleleString}</div>',

            '<div><span class="w140 infokey s90">HGVS Genomic: </span> {hgvsGenomic}',
            '<div><span class="w140 infokey s90">HGVS Protein: </span> {hgvsProtein}',
            '<div><span class="w140 infokey s90">HGVS Transcript: </span> {hgvsTranscript}',

//			'<div><span class="w140 infokey s90">Reference codon: </span> {referenceCodon}</div>',
			'<div><span class="w140 infokey s90">Polyphen prediction: </span> {polyphenPrediction}',
			'<span style="margin-left:50px" class="w140 infokey s90">Polyphen score: </span> {polyphenScore}</div>',
			'<div><span class="w140 infokey s90">Sift prediction: </span> {siftPrediction}',
			'<span style="margin-left:50px" class="w140 infokey s90">Sift score: </span> {siftScore}</div>',
            '<div><span class="w140 infokey s90">SO consequence types: </span> {consequenceTypes}</div><br>',
		    {
		    	getStableId: function(values){
		    		if(values.transcriptId!=""){
		    			return values.transcriptId;
		    		}
		    		return "Intergenic SNP";
		    	}
		    }
		);
};


InfoWidget.prototype.getConsequenceTypeTemplate = function (){
	return new Ext.XTemplate(
		    '<div><span class="panel-border-bottom"><span class="ssel s130">{transcriptId}</span> &nbsp; </span></div><br>',
		    '<div><span class="w140 infokey s90">SO consequence types: </span> {consequenceTypes}</div><br>'
//		    '<div><span class="w100 infokey s90">SO term: </span> {consequenceType.soTerm}</div>',
//		    '<div><span class="w100 infokey s90">Feature So term: </span> {consequenceType.featureSoTerm}</div>',
//		    '<div><span class="w100 infokey s90">NCBI term: </span> {consequenceType.ncbiTerm}</div>',
//		    '<div><span class="w100 infokey s90">Rank: </span> {consequenceType.rank}</div><br>'
		);
};


InfoWidget.prototype.getPhenotypeTemplate = function (){
	return new Ext.XTemplate(
		    '<div><span class="panel-border-bottom"><span class="ssel s130">{phenotypeDescription}</span> &nbsp; <span class="emph s120"> {source} </span></span></div><br>',
			'<div><span class="w150 infokey s90">PValue: </span>{PValue}</div>',
			'<div><span class="w150 infokey s90">Assoc. gene name: </span>{associatedGeneName}</div>',
			'<div><span class="w150 infokey s90">Assoc. variant risk allele: </span>{associatedVariantRiskAllele}</div>',
			'<div><span class="w150 infokey s90">Phenotype description: </span>{phenotypeDescription}</div>',
			'<div><span class="w150 infokey s90">Phenotype name: </span>{phenotypeName}</div>',
			'<div><span class="w150 infokey s90">Risk allele freq in controls: </span>{riskAlleleFrequencyInControls}</div>',
			'<div><span class="w150 infokey s90">Source: </span>{source}</div>',
			'<div><span class="w150 infokey s90">Study name: </span>{studyName}</div>',
			'<div><span class="w150 infokey s90">Study type: </span>{studyType}</div>',
			'<div><span class="w150 infokey s90">Study URL: </span>{studyUrl}</div>',
			'<div><span class="w150 infokey s90">Study description: </span>{studyDescription}</div>'
		);
};

InfoWidget.prototype.getPopulationTemplate = function (){
	return new Ext.XTemplate(
		    '<div><span class="panel-border-bottom"><span class="ssel s130">{population}</span> &nbsp; <span class="emph s120"> {source} </span></span></div><br>',
		    '<div><span class="w140 infokey s90">Ref allele:  </span>{refAllele} ({refAlleleFrequency})</div>',
		    '<div><span class="w140 infokey s90">Other allele:  </span>{otherAllele} ({otherAlleleFrequency})</div>',
		    '<div><span class="w140 infokey s90">Ref allele homozygote:  </span>{refAlleleHomozygote} ({refAlleleHomozygoteFrequency})</div>',
		    '<div><span class="w140 infokey s90">Allele heterozygote:  </span>{alleleHeterozygote} ({alleleHeterozygoteFrequency})</div>',
			 '<div><span class="w140 infokey s90">Other allele homozygote:  </span>{otherAlleleHomozygote} ({otherAlleleHeterozygoteFrequency})</div>',
//			 'TODO cuidado <div><span class="w140 infokey s90">other allele heterozygote Frequency:  </span>{otherAlleleHeterozygoteFrequency}</div>',
			 '<div><span class="w140 infokey s90">Source:  </span>{source}</div>',
			 '<div><span class="w140 infokey s90">Population:  </span>{population}</div>'
		);
};

//not used
InfoWidget.prototype.getVariantEffectTemplate = function (){
		
	return new Ext.XTemplate(
		    '<div><span class="panel-border-bottom"><span class="ssel s130">{consequenceTypeObo}</span> &nbsp; <span class="emph s120"> {featureBiotype} </span></span></div><br>'
		);
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

GeneInfoWidget.prototype.draw = InfoWidget.prototype.draw;
GeneInfoWidget.prototype.render = InfoWidget.prototype.render;
GeneInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
GeneInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
GeneInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;
GeneInfoWidget.prototype.getGeneTemplate = InfoWidget.prototype.getGeneTemplate;
GeneInfoWidget.prototype.getTranscriptTemplate = InfoWidget.prototype.getTranscriptTemplate;

function GeneInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "Gene Info";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

GeneInfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return dataTypes=[
	            { text: "Genomic", children: [
	                { text: "Information"},
	                { text: "Transcripts"},
                    { text: "Xrefs"}
	            ] },
	            { text: "Functional information", children: [
	                { text: "GO"},
	                { text: "Reactome"},
	                { text: "Interpro"}
	            ] },
//	            { text: "Regulatory", children: [
//	                { text: "TFBS"}
//	                { text: "miRNA targets"}
//	            ]},
	            { text:"Protein", children: [
	                { text: "Features"},//protein profile
	                { text: "3D structure"}
	            ]}	     
	        ];
};

GeneInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "Information": this.panel.add(this.getGenePanel(this.data).show()); break;
			case "Transcripts": this.panel.add(this.getTranscriptPanel(this.data.transcripts).show());  break;
			case "Xrefs": this.panel.add(this.getXrefGrid(this.data.transcripts, 'Xref', 'transcript').show());  break;
//			case "GO": this.panel.add(this.getGoGrid().show()); break;
			case "GO": this.panel.add(this.getXrefGrid(this.data.transcripts, 'GO', 'transcript').show());  break;
			case "Interpro": this.panel.add(this.getXrefGrid(this.data.transcripts, 'Interpro', 'transcript').show());  break;
			case "Reactome": this.panel.add(this.getXrefGrid(this.data.transcripts, 'Reactome', 'transcript').show());  break;
//			case "TFBS": this.panel.add(this.getTfbsGrid(this.data.transcripts).show());  break;
//			case "miRNA targets": this.panel.add(this.getMirnaTargetGrid(this.data.mirnaTargets).show());  break;
			case "Features": this.panel.add(this.getProteinFeaturesGrid(this.data.proteinFeatures).show());  break;
			case "3D structure": this.panel.add(this.get3Dprotein(this.data.snps).show());  break;
		}
	}
};

GeneInfoWidget.prototype.getGenePanel = function(data){
	if(data==null){
		return this.notFoundPanel;
	}
    if(this.genePanel==null){
    	var tpl = this.getGeneTemplate();
    	
		this.genePanel = Ext.create('Ext.panel.Panel',{
			title:"Gene information",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,
			bodyPadding:10,
			data:data,
			tpl:tpl
		});
    }
    return this.genePanel;
};


GeneInfoWidget.prototype.getTranscriptPanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.transcriptGrid==null){
    	
    	var tpl = this.getTranscriptTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var transcriptPanel = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(transcriptPanel);
    	}
		this.transcriptGrid = Ext.create('Ext.panel.Panel',{
			title:"Transcripts ("+i+")",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.transcriptGrid;
};


GeneInfoWidget.prototype.getXrefGrid = function(transcripts, dbname, groupField){
    var data = [];
    for(var i = 0; i<transcripts.length; i++){
        for(var j = 0; j<transcripts[i].xrefs.length; j++){
            var xref = transcripts[i].xrefs[j];
            if(dbname == 'Xref'){
                var xrefName  = xref.dbName.toLowerCase();
                if(xrefName != 'go' && xrefName != 'interpro' && xrefName != 'reactome'){
                    xref.transcript = transcripts[i].id;
                    data.push(xref);
                }
            }else{
                if(xref.dbName.toLowerCase() == dbname.toLowerCase()){
                    xref.transcript = transcripts[i].id;
                    data.push(xref);
                }
            }
        }
    }
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this[dbname+"Grid"]==null){
    	var groupField = groupField;
    	var modelName = dbname;
    	var fields = ['description','id', 'dbName', 'transcript'];
    	var columns = [
    	               {header : 'Display Id',dataIndex: 'id',flex:1},
    	               {header : 'DB name',dataIndex: 'dbName',flex:1},
    	               {header : 'Description',dataIndex: 'description',flex:3}
    	               ];
    	this[dbname+"Grid"] = this.doGrid(columns,fields,modelName,groupField);
    	this[dbname+"Grid"].store.loadData(data);
    }
    return this[dbname+"Grid"];
};

//GeneInfoWidget.prototype.getGoGrid = function(){
//    var _this = this;
//    if(this.goGrid==null){
//    	var groupField = 'namespace';
//    	var modelName = 'GO';
//	    var fields = ['id','name','description','level','directNumberOfGenes','namespace','parents','propagatedNumberOfGenes','score'];
//		var columns = [ {header : 'Database id',dataIndex: 'id',flex:2},
//						{header : 'Name',dataIndex: 'name',flex:1},
//						{header : 'Description',dataIndex: 'description',flex:2},
//		                {
//		                	xtype: 'actioncolumn',
//		                	header : '+info',
//		                    flex:1,
//		                    items: [{
//		                        iconCls: 'icon-blue-box',  // Use a URL in the icon config
//		                        tooltip: '+info',    
//		                        handler: function(grid, rowIndex, colIndex) {
//		                            var rec = _this.goStore.getAt(rowIndex);
//		                            Ext.Msg.alert(rec.get('name'), rec.get('description'));
//		                        }
//		                    }]
//		                 },
//		                {header : 'Direct genes',dataIndex: 'directNumberOfGenes',flex:2},
//						{header : 'Level',dataIndex: 'level',flex:1},
//						{header : 'Namespace',dataIndex: 'namespace',flex:2},
//						{header : 'Propagated genes',dataIndex: 'propagatedNumberOfGenes',flex:2.5}
//		             ];
//		this.goGrid = this.doGrid(columns,fields,modelName,groupField);
//		
//    }
//    return this.goGrid;
//};


GeneInfoWidget.prototype.getTfbsGrid = function(data){
    if(data.length<=0){
		return this.notFoundPanel;
	}
    var groupField = '';
    //check data are transcripts or tfbss

    if(data[0].id != null){
        var data2 = [];
        groupField = 'transcriptId';
        for(var i = 0; i<data.length; i++){
            transcript = data[i];
            if(transcript.tfbs != null){
                for(var j = 0; j<transcript.tfbs.length; j++){
                    transcript.tfbs[j].transcriptId = transcript.id;
                }
                data2 = data2.concat(transcript.tfbs);
            }
        }
        data = data2;
    }

    if(this.tfbsGrid==null){
    	var groupField = groupField;
    	var modelName = "TFBS";
	    var fields = ["chromosome","start","end","strand","tfName","relativeStart","relativeEnd","targetGeneName","score","sequence","transcriptId"];
		var columns = [
		                {header : 'Name',dataIndex: 'tfName',flex:1},
		            	{header : 'Location: chr:start-end (strand)', xtype:'templatecolumn', tpl:'{chromosome}:{start}-{end} ({strand})',flex:2.5},
		            	{header : 'Relative (start-end)',xtype:'templatecolumn',tpl:'{relativeStart}-{relativeEnd}',flex:1.5},
						{header : 'Target gene',dataIndex: 'targetGeneName',flex:1},
						{header : 'Score',dataIndex: 'score',flex:1},
						{header : 'Sequence',dataIndex: 'sequence',flex:1}
		             ];
		this.tfbsGrid = this.doGrid(columns,fields,modelName,groupField);
		this.tfbsGrid.store.loadData(data);
    }
    return this.tfbsGrid;
};

GeneInfoWidget.prototype.getMirnaTargetGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.mirnaTargetGrid==null){
    	var groupField = "";
    	var modelName = "miRNA targets";
	    var fields = ["chromosome","start","end","strand","mirbaseId","score","experimentalMethod","source"];
		var columns = [
		                {header : 'Id',dataIndex: 'mirbaseId',flex:1},
		            	{header : 'Location: chr:start-end (strand)', xtype:'templatecolumn', tpl:'{chromosome}:{start}-{end} ({strand})',flex:2},
						{header : 'Score',dataIndex: 'score',flex:1},
						{header : 'Exp. Method',dataIndex: 'experimentalMethod',flex:1},
						{header : 'source',dataIndex: 'source',flex:1}
		             ];
		this.mirnaTargetGrid = this.doGrid(columns,fields,modelName,groupField);
		this.mirnaTargetGrid.store.loadData(data);
    }
    return this.mirnaTargetGrid;
};

GeneInfoWidget.prototype.getProteinFeaturesGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.proteinFeaturesGrid==null){
    	var groupField = '';
    	var modelName = "Protein features";
	    var fields = ["identifier","start","end","original","type","description"];
		var columns = [
		                {header : 'Identifier',dataIndex: 'identifier',flex:1},
		               	{header : 'Location: (start-end)', xtype:'templatecolumn', tpl:'{start}-{end}',flex:1.2},
		               	{header : 'Original',dataIndex: 'original',flex:1},
						{header : 'Type',dataIndex: 'type',flex:1},
						{header : 'Description',dataIndex: 'description',flex:1.5}
		             ];
		this.proteinFeaturesGrid = this.doGrid(columns,fields,modelName,groupField);
		this.proteinFeaturesGrid.store.loadData(data);
    }
    return this.proteinFeaturesGrid;
};


GeneInfoWidget.prototype.getProteinFeaturesGrid = function(data){
    debugger
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.proteinFeaturesGrid==null){
    	var groupField = '';
    	var modelName = 'Protein features';
	    var fields = ["identifier","start","end","original","type","description"];
		var columns = [
		                {header : 'Identifier',dataIndex: 'identifier',flex:1},
		               	{header : 'Location: (start-end)', xtype:'templatecolumn', tpl:'{start}-{end}',flex:1.2},
		               	{header : 'Original',dataIndex: 'original',flex:1},
						{header : 'Type',dataIndex: 'type',flex:1},
						{header : 'Description',dataIndex: 'description',flex:1.5}
		             ];
		this.proteinFeaturesGrid = this.doGrid(columns,fields,modelName,groupField);
		this.proteinFeaturesGrid.store.loadData(data);
    }
    return this.proteinFeaturesGrid;
};

GeneInfoWidget.prototype.get3Dprotein = function(data){
	var _this=this;
    if(this.p3dProtein==null){
    	//ws
//    	
      	this.p3dProtein = Ext.create('Ext.tab.Panel',{
      		title:"3D Protein Viewer",
      		border:false,
      		cls:'ocb-border-left-lightgrey',
      		flex:3,
//    		bodyPadding:5,
      		autoScroll:true
//      		items:items
      	});
    	
    	var pdbs = [];

    	$.ajax({
//    		  url: 'http://ws.bioinfo.cipf.es/celldb/rest/v1/hsa/feature/id/brca2/xref?dbname=pdb',
    		  url:new CellBaseManager().host+'/v3/'+_this.species+'/feature/id/'+this.query+'/xref?dbname=pdb&of=json',
//    		  data: data,
//    		  dataType: dataType,
    		  async:false,
    		  success: function(data){
    			if(data!=""){
//      	    		console.log(data.trim());
      	    		pdbs = data[0];
//      	    		console.log(pdbs);
      	    		
      	    		for ( var i = 0; i < pdbs.length; i++) {
      	    			var pdb_name=pdbs[i].id;
      	    			var pan = Ext.create('Ext.panel.Panel',{
      	    				title:pdb_name,
      	    				bodyCls:'ocb-background-black',
      	    				html:'<canvas class="ChemDoodleWebComponent" id="pdb_canvas_'+pdb_name+'" width="600" height="600" style="width: 600px; height: 600px; ">This browser does not support HTML5/Canvas.</canvas>',
      	    				listeners:{
      	    					afterrender:function(este){
      	    						// JavaScript Document
      	    						var pdb_name=este.title;
      	    						
      	    				    	ChemDoodle.default_backgroundColor = '#000000';
      	    				    	
      	    				    	var pdb = new ChemDoodle.TransformCanvas3D('pdb_canvas_'+pdb_name, 300, 300);
      	    				    	if(!pdb.gl){
      	    				    	  pdb.emptyMessage = 'Your browser does not support WebGL';
      	    				    	  pdb.displayMessage();
      	    				    	}else{
      	    					    	pdb.specs.set3DRepresentation('Ball and Stick');
      	    					    	pdb.specs.proteins_ribbonCartoonize = true;
      	    					    	pdb.handle = null;
      	    					    	pdb.timeout = 15;
      	    					    	pdb.startAnimation = ChemDoodle._AnimatorCanvas.prototype.startAnimation;
      	    					    	pdb.stopAnimation = ChemDoodle._AnimatorCanvas.prototype.stopAnimation;
      	    					    	pdb.isRunning = ChemDoodle._AnimatorCanvas.prototype.isRunning;
      	    					    	pdb.dblclick = ChemDoodle.RotatorCanvas.prototype.dblclick;
      	    					    	pdb.nextFrame = function(delta){
      	    					    		var matrix = [];
      	    					    		mat4.identity(matrix);
      	    					    		var change = delta/1000;
      	    					    	        var increment = Math.PI/15;
      	    					    		mat4.rotate(matrix, increment*change, [ 1, 0, 0 ]);
      	    					    		mat4.rotate(matrix, increment*change, [ 0, 1, 0 ]);
      	    					    		mat4.rotate(matrix, increment*change, [ 0, 0, 1 ]);
      	    					    		mat4.multiply(this.rotationMatrix, matrix);
      	    					    	};
      	    					    	
//      	    					    	http://ws.bioinfo.cipf.es/celldb/rest/v1/hsa/feature/id/brca2/xref?dbname=pdb
//      	    				    	var mol = ChemDoodle.readPDB('HEADER    PLANT SEED PROTEIN                      30-APR-81   1CRN                                                                       \nDBREF  1CRN A    1    46  UNP    P01542   CRAM_CRAAB       1     46             \nSEQRES   1 A   46  THR THR CYS CYS PRO SER ILE VAL ALA ARG SER ASN PHE          \nSEQRES   2 A   46  ASN VAL CYS ARG LEU PRO GLY THR PRO GLU ALA ILE CYS          \nSEQRES   3 A   46  ALA THR TYR THR GLY CYS ILE ILE ILE PRO GLY ALA THR          \nSEQRES   4 A   46  CYS PRO GLY ASP TYR ALA ASN                                  \nHELIX    1  H1 ILE A    7  PRO A   19  13/10 CONFORMATION RES 17,19       13    \nHELIX    2  H2 GLU A   23  THR A   30  1DISTORTED 3/10 AT RES 30           8    \nSHEET    1  S1 2 THR A   1  CYS A   4  0                                        \nSHEET    2  S1 2 CYS A  32  ILE A  35 -1                                        \nSSBOND   1 CYS A    3    CYS A   40                          1555   1555  2.00  \nSSBOND   2 CYS A    4    CYS A   32                          1555   1555  2.04  \nSSBOND   3 CYS A   16    CYS A   26                          1555   1555  2.05  \nCRYST1   40.960   18.650   22.520  90.00  90.77  90.00 P 1 21 1      2          \nORIGX1      1.000000  0.000000  0.000000        0.00000                         \nORIGX2      0.000000  1.000000  0.000000        0.00000                         \nORIGX3      0.000000  0.000000  1.000000        0.00000                         \nSCALE1      0.024414  0.000000 -0.000328        0.00000                         \nSCALE2      0.000000  0.053619  0.000000        0.00000                         \nSCALE3      0.000000  0.000000  0.044409        0.00000                         \nATOM      1  N   THR A   1      17.047  14.099   3.625  1.00 13.79           N  \nATOM      2  CA  THR A   1      16.967  12.784   4.338  1.00 10.80           C  \nATOM      3  C   THR A   1      15.685  12.755   5.133  1.00  9.19           C  \nATOM      4  O   THR A   1      15.268  13.825   5.594  1.00  9.85           O  \nATOM      5  CB  THR A   1      18.170  12.703   5.337  1.00 13.02           C  \nATOM      6  OG1 THR A   1      19.334  12.829   4.463  1.00 15.06           O  \nATOM      7  CG2 THR A   1      18.150  11.546   6.304  1.00 14.23           C  \nATOM      8  N   THR A   2      15.115  11.555   5.265  1.00  7.81           N  \nATOM      9  CA  THR A   2      13.856  11.469   6.066  1.00  8.31           C  \nATOM     10  C   THR A   2      14.164  10.785   7.379  1.00  5.80           C  \nATOM     11  O   THR A   2      14.993   9.862   7.443  1.00  6.94           O  \nATOM     12  CB  THR A   2      12.732  10.711   5.261  1.00 10.32           C  \nATOM     13  OG1 THR A   2      13.308   9.439   4.926  1.00 12.81           O  \nATOM     14  CG2 THR A   2      12.484  11.442   3.895  1.00 11.90           C  \nATOM     15  N   CYS A   3      13.488  11.241   8.417  1.00  5.24           N  \nATOM     16  CA  CYS A   3      13.660  10.707   9.787  1.00  5.39           C  \nATOM     17  C   CYS A   3      12.269  10.431  10.323  1.00  4.45           C  \nATOM     18  O   CYS A   3      11.393  11.308  10.185  1.00  6.54           O  \nATOM     19  CB  CYS A   3      14.368  11.748  10.691  1.00  5.99           C  \nATOM     20  SG  CYS A   3      15.885  12.426  10.016  1.00  7.01           S  \nATOM     21  N   CYS A   4      12.019   9.272  10.928  1.00  3.90           N  \nATOM     22  CA  CYS A   4      10.646   8.991  11.408  1.00  4.24           C  \nATOM     23  C   CYS A   4      10.654   8.793  12.919  1.00  3.72           C  \nATOM     24  O   CYS A   4      11.659   8.296  13.491  1.00  5.30           O  \nATOM     25  CB  CYS A   4      10.057   7.752  10.682  1.00  4.41           C  \nATOM     26  SG  CYS A   4       9.837   8.018   8.904  1.00  4.72           S  \nATOM     27  N   PRO A   5       9.561   9.108  13.563  1.00  3.96           N  \nATOM     28  CA  PRO A   5       9.448   9.034  15.012  1.00  4.25           C  \nATOM     29  C   PRO A   5       9.288   7.670  15.606  1.00  4.96           C  \nATOM     30  O   PRO A   5       9.490   7.519  16.819  1.00  7.44           O  \nATOM     31  CB  PRO A   5       8.230   9.957  15.345  1.00  5.11           C  \nATOM     32  CG  PRO A   5       7.338   9.786  14.114  1.00  5.24           C  \nATOM     33  CD  PRO A   5       8.366   9.804  12.958  1.00  5.20           C  \nATOM     34  N   SER A   6       8.875   6.686  14.796  1.00  4.83           N  \nATOM     35  CA  SER A   6       8.673   5.314  15.279  1.00  4.45           C  \nATOM     36  C   SER A   6       8.753   4.376  14.083  1.00  4.99           C  \nATOM     37  O   SER A   6       8.726   4.858  12.923  1.00  4.61           O  \nATOM     38  CB  SER A   6       7.340   5.121  15.996  1.00  5.05           C  \nATOM     39  OG  SER A   6       6.274   5.220  15.031  1.00  6.39           O  \nATOM     40  N   ILE A   7       8.881   3.075  14.358  1.00  4.94           N  \nATOM     41  CA  ILE A   7       8.912   2.083  13.258  1.00  6.33           C  \nATOM     42  C   ILE A   7       7.581   2.090  12.506  1.00  5.32           C  \nATOM     43  O   ILE A   7       7.670   2.031  11.245  1.00  6.85           O  \nATOM     44  CB  ILE A   7       9.207   0.677  13.924  1.00  8.43           C  \nATOM     45  CG1 ILE A   7      10.714   0.702  14.312  1.00  9.78           C  \nATOM     46  CG2 ILE A   7       8.811  -0.477  12.969  1.00 11.70           C  \nATOM     47  CD1 ILE A   7      11.185  -0.516  15.142  1.00  9.92           C  \nATOM     48  N   VAL A   8       6.458   2.162  13.159  1.00  5.02           N  \nATOM     49  CA  VAL A   8       5.145   2.209  12.453  1.00  6.93           C  \nATOM     50  C   VAL A   8       5.115   3.379  11.461  1.00  5.39           C  \nATOM     51  O   VAL A   8       4.664   3.268  10.343  1.00  6.30           O  \nATOM     52  CB  VAL A   8       3.995   2.354  13.478  1.00  9.64           C  \nATOM     53  CG1 VAL A   8       2.716   2.891  12.869  1.00 13.85           C  \nATOM     54  CG2 VAL A   8       3.758   1.032  14.208  1.00 11.97           C  \nATOM     55  N   ALA A   9       5.606   4.546  11.941  1.00  3.73           N  \nATOM     56  CA  ALA A   9       5.598   5.767  11.082  1.00  3.56           C  \nATOM     57  C   ALA A   9       6.441   5.527   9.850  1.00  4.13           C  \nATOM     58  O   ALA A   9       6.052   5.933   8.744  1.00  4.36           O  \nATOM     59  CB  ALA A   9       6.022   6.977  11.891  1.00  4.80           C  \nATOM     60  N   ARG A  10       7.647   4.909  10.005  1.00  3.73           N  \nATOM     61  CA  ARG A  10       8.496   4.609   8.837  1.00  3.38           C  \nATOM     62  C   ARG A  10       7.798   3.609   7.876  1.00  3.47           C  \nATOM     63  O   ARG A  10       7.878   3.778   6.651  1.00  4.67           O  \nATOM     64  CB  ARG A  10       9.847   4.020   9.305  1.00  3.95           C  \nATOM     65  CG  ARG A  10      10.752   3.607   8.149  1.00  4.55           C  \nATOM     66  CD  ARG A  10      11.226   4.699   7.244  1.00  5.89           C  \nATOM     67  NE  ARG A  10      12.143   5.571   8.035  1.00  6.20           N  \nATOM     68  CZ  ARG A  10      12.758   6.609   7.443  1.00  7.52           C  \nATOM     69  NH1 ARG A  10      12.539   6.932   6.158  1.00 10.68           N  \nATOM     70  NH2 ARG A  10      13.601   7.322   8.202  1.00  9.48           N  \nATOM     71  N   SER A  11       7.186   2.582   8.445  1.00  5.19           N  \nATOM     72  CA  SER A  11       6.500   1.584   7.565  1.00  4.60           C  \nATOM     73  C   SER A  11       5.382   2.313   6.773  1.00  4.84           C  \nATOM     74  O   SER A  11       5.213   2.016   5.557  1.00  5.84           O  \nATOM     75  CB  SER A  11       5.908   0.462   8.400  1.00  5.91           C  \nATOM     76  OG  SER A  11       6.990  -0.272   9.012  1.00  8.38           O  \nATOM     77  N   ASN A  12       4.648   3.182   7.446  1.00  3.54           N  \nATOM     78  CA  ASN A  12       3.545   3.935   6.751  1.00  4.57           C  \nATOM     79  C   ASN A  12       4.107   4.851   5.691  1.00  4.14           C  \nATOM     80  O   ASN A  12       3.536   5.001   4.617  1.00  5.52           O  \nATOM     81  CB  ASN A  12       2.663   4.677   7.748  1.00  6.42           C  \nATOM     82  CG  ASN A  12       1.802   3.735   8.610  1.00  8.25           C  \nATOM     83  OD1 ASN A  12       1.567   2.613   8.165  1.00 12.72           O  \nATOM     84  ND2 ASN A  12       1.394   4.252   9.767  1.00  9.92           N  \nATOM     85  N   PHE A  13       5.259   5.498   6.005  1.00  3.43           N  \nATOM     86  CA  PHE A  13       5.929   6.358   5.055  1.00  3.49           C  \nATOM     87  C   PHE A  13       6.304   5.578   3.799  1.00  3.40           C  \nATOM     88  O   PHE A  13       6.136   6.072   2.653  1.00  4.07           O  \nATOM     89  CB  PHE A  13       7.183   6.994   5.754  1.00  5.48           C  \nATOM     90  CG  PHE A  13       7.884   8.006   4.883  1.00  5.57           C  \nATOM     91  CD1 PHE A  13       8.906   7.586   4.027  1.00  6.99           C  \nATOM     92  CD2 PHE A  13       7.532   9.373   4.983  1.00  6.52           C  \nATOM     93  CE1 PHE A  13       9.560   8.539   3.194  1.00  8.20           C  \nATOM     94  CE2 PHE A  13       8.176  10.281   4.145  1.00  6.34           C  \nATOM     95  CZ  PHE A  13       9.141   9.845   3.292  1.00  6.84           C  \nATOM     96  N   ASN A  14       6.900   4.390   3.989  1.00  3.64           N  \nATOM     97  CA  ASN A  14       7.331   3.607   2.791  1.00  4.31           C  \nATOM     98  C   ASN A  14       6.116   3.210   1.915  1.00  3.98           C  \nATOM     99  O   ASN A  14       6.240   3.144   0.684  1.00  6.22           O  \nATOM    100  CB  ASN A  14       8.145   2.404   3.240  1.00  5.81           C  \nATOM    101  CG  ASN A  14       9.555   2.856   3.730  1.00  6.82           C  \nATOM    102  OD1 ASN A  14      10.013   3.895   3.323  1.00  9.43           O  \nATOM    103  ND2 ASN A  14      10.120   1.956   4.539  1.00  8.21           N  \nATOM    104  N   VAL A  15       4.993   2.927   2.571  1.00  3.76           N  \nATOM    105  CA  VAL A  15       3.782   2.599   1.742  1.00  3.98           C  \nATOM    106  C   VAL A  15       3.296   3.871   1.004  1.00  3.80           C  \nATOM    107  O   VAL A  15       2.947   3.817  -0.189  1.00  4.85           O  \nATOM    108  CB  VAL A  15       2.698   1.953   2.608  1.00  4.71           C  \nATOM    109  CG1 VAL A  15       1.384   1.826   1.806  1.00  6.67           C  \nATOM    110  CG2 VAL A  15       3.174   0.533   3.005  1.00  6.26           C  \nATOM    111  N   CYS A  16       3.321   4.987   1.720  1.00  3.79           N  \nATOM    112  CA  CYS A  16       2.890   6.285   1.126  1.00  3.54           C  \nATOM    113  C   CYS A  16       3.687   6.597  -0.111  1.00  3.48           C  \nATOM    114  O   CYS A  16       3.200   7.147  -1.103  1.00  4.63           O  \nATOM    115  CB  CYS A  16       3.039   7.369   2.240  1.00  4.58           C  \nATOM    116  SG  CYS A  16       2.559   9.014   1.649  1.00  5.66           S  \nATOM    117  N   ARG A  17       4.997   6.227  -0.100  1.00  3.99           N  \nATOM    118  CA  ARG A  17       5.895   6.489  -1.213  1.00  3.83           C  \nATOM    119  C   ARG A  17       5.738   5.560  -2.409  1.00  3.79           C  \nATOM    120  O   ARG A  17       6.228   5.901  -3.507  1.00  5.39           O  \nATOM    121  CB  ARG A  17       7.370   6.507  -0.731  1.00  4.11           C  \nATOM    122  CG  ARG A  17       7.717   7.687   0.206  1.00  4.69           C  \nATOM    123  CD  ARG A  17       7.949   8.947  -0.615  1.00  5.10           C  \nATOM    124  NE  ARG A  17       9.212   8.856  -1.337  1.00  4.71           N  \nATOM    125  CZ  ARG A  17       9.537   9.533  -2.431  1.00  5.28           C  \nATOM    126  NH1 ARG A  17       8.659  10.350  -3.032  1.00  6.67           N  \nATOM    127  NH2 ARG A  17      10.793   9.491  -2.899  1.00  6.41           N  \nATOM    128  N   LEU A  18       5.051   4.411  -2.204  1.00  4.70           N  \nATOM    129  CA  LEU A  18       4.933   3.431  -3.326  1.00  5.46           C  \nATOM    130  C   LEU A  18       4.397   4.014  -4.620  1.00  5.13           C  \nATOM    131  O   LEU A  18       4.988   3.755  -5.687  1.00  5.55           O  \nATOM    132  CB  LEU A  18       4.196   2.184  -2.863  1.00  6.47           C  \nATOM    133  CG  LEU A  18       4.960   1.178  -1.991  1.00  7.43           C  \nATOM    134  CD1 LEU A  18       3.907   0.097  -1.634  1.00  8.70           C  \nATOM    135  CD2 LEU A  18       6.129   0.606  -2.768  1.00  9.39           C  \nATOM    136  N   PRO A  19       3.329   4.795  -4.543  1.00  4.28           N  \nATOM    137  CA  PRO A  19       2.792   5.376  -5.797  1.00  5.38           C  \nATOM    138  C   PRO A  19       3.573   6.540  -6.322  1.00  6.30           C  \nATOM    139  O   PRO A  19       3.260   7.045  -7.422  1.00  9.62           O  \nATOM    140  CB  PRO A  19       1.358   5.766  -5.472  1.00  5.87           C  \nATOM    141  CG  PRO A  19       1.223   5.694  -3.993  1.00  6.47           C  \nATOM    142  CD  PRO A  19       2.421   4.941  -3.408  1.00  6.45           C  \nATOM    143  N   GLY A  20       4.565   7.047  -5.559  1.00  4.94           N  \nATOM    144  CA  GLY A  20       5.366   8.191  -6.018  1.00  5.39           C  \nATOM    145  C   GLY A  20       5.007   9.481  -5.280  1.00  5.03           C  \nATOM    146  O   GLY A  20       5.535  10.510  -5.730  1.00  7.34           O  \nATOM    147  N   THR A  21       4.181   9.438  -4.262  1.00  4.10           N  \nATOM    148  CA  THR A  21       3.767  10.609  -3.513  1.00  3.94           C  \nATOM    149  C   THR A  21       5.017  11.397  -3.042  1.00  3.96           C  \nATOM    150  O   THR A  21       5.947  10.757  -2.523  1.00  5.82           O  \nATOM    151  CB  THR A  21       2.992  10.188  -2.225  1.00  4.13           C  \nATOM    152  OG1 THR A  21       2.051   9.144  -2.623  1.00  5.45           O  \nATOM    153  CG2 THR A  21       2.260  11.349  -1.551  1.00  5.41           C  \nATOM    154  N   PRO A  22       4.971  12.703  -3.176  1.00  5.04           N  \nATOM    155  CA  PRO A  22       6.143  13.513  -2.696  1.00  4.69           C  \nATOM    156  C   PRO A  22       6.400  13.233  -1.225  1.00  4.19           C  \nATOM    157  O   PRO A  22       5.485  13.061  -0.382  1.00  4.47           O  \nATOM    158  CB  PRO A  22       5.703  14.969  -2.920  1.00  7.12           C  \nATOM    159  CG  PRO A  22       4.676  14.893  -3.996  1.00  7.03           C  \nATOM    160  CD  PRO A  22       3.964  13.567  -3.811  1.00  4.90           C  \nATOM    161  N   GLU A  23       7.728  13.297  -0.921  1.00  5.16           N  \nATOM    162  CA  GLU A  23       8.114  13.103   0.500  1.00  5.31           C  \nATOM    163  C   GLU A  23       7.427  14.073   1.410  1.00  4.11           C  \nATOM    164  O   GLU A  23       7.036  13.682   2.540  1.00  5.11           O  \nATOM    165  CB  GLU A  23       9.648  13.285   0.660  1.00  6.16           C  \nATOM    166  CG  GLU A  23      10.440  12.093   0.063  1.00  7.48           C  \nATOM    167  CD  GLU A  23      11.941  12.170   0.391  1.00  9.40           C  \nATOM    168  OE1 GLU A  23      12.416  13.225   0.681  1.00 10.40           O  \nATOM    169  OE2 GLU A  23      12.539  11.070   0.292  1.00 13.32           O  \nATOM    170  N   ALA A  24       7.212  15.334   0.966  1.00  4.56           N  \nATOM    171  CA  ALA A  24       6.614  16.317   1.913  1.00  4.49           C  \nATOM    172  C   ALA A  24       5.212  15.936   2.350  1.00  4.10           C  \nATOM    173  O   ALA A  24       4.782  16.166   3.495  1.00  5.64           O  \nATOM    174  CB  ALA A  24       6.605  17.695   1.246  1.00  5.80           C  \nATOM    175  N   ILE A  25       4.445  15.318   1.405  1.00  4.37           N  \nATOM    176  CA  ILE A  25       3.074  14.894   1.756  1.00  5.44           C  \nATOM    177  C   ILE A  25       3.085  13.643   2.645  1.00  4.32           C  \nATOM    178  O   ILE A  25       2.315  13.523   3.578  1.00  4.72           O  \nATOM    179  CB  ILE A  25       2.204  14.637   0.462  1.00  6.42           C  \nATOM    180  CG1 ILE A  25       1.815  16.048  -0.129  1.00  7.50           C  \nATOM    181  CG2 ILE A  25       0.903  13.864   0.811  1.00  7.65           C  \nATOM    182  CD1 ILE A  25       0.756  16.761   0.757  1.00  7.80           C  \nATOM    183  N   CYS A  26       4.032  12.764   2.313  1.00  3.92           N  \nATOM    184  CA  CYS A  26       4.180  11.549   3.187  1.00  4.37           C  \nATOM    185  C   CYS A  26       4.632  11.944   4.596  1.00  3.95           C  \nATOM    186  O   CYS A  26       4.227  11.252   5.547  1.00  4.74           O  \nATOM    187  CB  CYS A  26       5.038  10.518   2.539  1.00  4.63           C  \nATOM    188  SG  CYS A  26       4.349   9.794   1.022  1.00  5.61           S  \nATOM    189  N   ALA A  27       5.408  13.012   4.694  1.00  3.89           N  \nATOM    190  CA  ALA A  27       5.879  13.502   6.026  1.00  4.43           C  \nATOM    191  C   ALA A  27       4.696  13.908   6.882  1.00  4.26           C  \nATOM    192  O   ALA A  27       4.528  13.422   8.025  1.00  5.44           O  \nATOM    193  CB  ALA A  27       6.880  14.615   5.830  1.00  5.36           C  \nATOM    194  N   THR A  28       3.827  14.802   6.358  1.00  4.53           N  \nATOM    195  CA  THR A  28       2.691  15.221   7.194  1.00  5.08           C  \nATOM    196  C   THR A  28       1.672  14.132   7.434  1.00  4.62           C  \nATOM    197  O   THR A  28       0.947  14.112   8.468  1.00  7.80           O  \nATOM    198  CB  THR A  28       1.986  16.520   6.614  1.00  6.03           C  \nATOM    199  OG1 THR A  28       1.664  16.221   5.230  1.00  7.19           O  \nATOM    200  CG2 THR A  28       2.914  17.739   6.700  1.00  7.34           C  \nATOM    201  N   TYR A  29       1.621  13.190   6.511  1.00  5.01           N  \nATOM    202  CA  TYR A  29       0.715  12.045   6.657  1.00  6.60           C  \nATOM    203  C   TYR A  29       1.125  11.125   7.815  1.00  4.92           C  \nATOM    204  O   TYR A  29       0.286  10.632   8.545  1.00  7.13           O  \nATOM    205  CB  TYR A  29       0.755  11.229   5.322  1.00  9.66           C  \nATOM    206  CG  TYR A  29      -0.203  10.044   5.354  1.00 11.56           C  \nATOM    207  CD1 TYR A  29      -1.547  10.337   5.645  1.00 12.85           C  \nATOM    208  CD2 TYR A  29       0.193   8.750   5.100  1.00 14.44           C  \nATOM    209  CE1 TYR A  29      -2.496   9.329   5.673  1.00 16.61           C  \nATOM    210  CE2 TYR A  29      -0.801   7.705   5.156  1.00 17.11           C  \nATOM    211  CZ  TYR A  29      -2.079   8.031   5.430  1.00 19.99           C  \nATOM    212  OH  TYR A  29      -3.097   7.057   5.458  1.00 28.98           O  \nATOM    213  N   THR A  30       2.470  10.984   7.995  1.00  5.31           N  \nATOM    214  CA  THR A  30       2.986   9.994   8.950  1.00  5.70           C  \nATOM    215  C   THR A  30       3.609  10.505  10.230  1.00  6.28           C  \nATOM    216  O   THR A  30       3.766   9.715  11.186  1.00  8.77           O  \nATOM    217  CB  THR A  30       4.076   9.103   8.225  1.00  6.55           C  \nATOM    218  OG1 THR A  30       5.125  10.027   7.824  1.00  6.57           O  \nATOM    219  CG2 THR A  30       3.493   8.324   7.035  1.00  7.29           C  \nATOM    220  N   GLY A  31       3.984  11.764  10.241  1.00  4.99           N  \nATOM    221  CA  GLY A  31       4.769  12.336  11.360  1.00  5.50           C  \nATOM    222  C   GLY A  31       6.255  12.243  11.106  1.00  4.19           C  \nATOM    223  O   GLY A  31       7.037  12.750  11.954  1.00  6.12           O  \nATOM    224  N   CYS A  32       6.710  11.631   9.992  1.00  4.30           N  \nATOM    225  CA  CYS A  32       8.140  11.694   9.635  1.00  4.89           C  \nATOM    226  C   CYS A  32       8.500  13.141   9.206  1.00  5.50           C  \nATOM    227  O   CYS A  32       7.581  13.949   8.944  1.00  5.82           O  \nATOM    228  CB  CYS A  32       8.504  10.686   8.530  1.00  4.66           C  \nATOM    229  SG  CYS A  32       8.048   8.987   8.881  1.00  5.33           S  \nATOM    230  N   ILE A  33       9.793  13.410   9.173  1.00  6.02           N  \nATOM    231  CA  ILE A  33      10.280  14.760   8.823  1.00  5.24           C  \nATOM    232  C   ILE A  33      11.346  14.658   7.743  1.00  5.16           C  \nATOM    233  O   ILE A  33      11.971  13.583   7.552  1.00  7.19           O  \nATOM    234  CB  ILE A  33      10.790  15.535  10.085  1.00  5.49           C  \nATOM    235  CG1 ILE A  33      12.059  14.803  10.671  1.00  6.85           C  \nATOM    236  CG2 ILE A  33       9.684  15.686  11.138  1.00  6.45           C  \nATOM    237  CD1 ILE A  33      12.733  15.676  11.781  1.00  8.94           C  \nATOM    238  N   ILE A  34      11.490  15.773   7.038  1.00  5.52           N  \nATOM    239  CA  ILE A  34      12.552  15.877   6.036  1.00  6.82           C  \nATOM    240  C   ILE A  34      13.590  16.917   6.560  1.00  6.92           C  \nATOM    241  O   ILE A  34      13.168  18.006   6.945  1.00  9.22           O  \nATOM    242  CB  ILE A  34      11.987  16.360   4.681  1.00  8.11           C  \nATOM    243  CG1 ILE A  34      10.914  15.338   4.163  1.00  9.59           C  \nATOM    244  CG2 ILE A  34      13.131  16.517   3.629  1.00  9.73           C  \nATOM    245  CD1 ILE A  34      10.151  16.024   2.938  1.00 13.41           C  \nATOM    246  N   ILE A  35      14.856  16.493   6.536  1.00  7.06           N  \nATOM    247  CA  ILE A  35      15.930  17.454   6.941  1.00  7.52           C  \nATOM    248  C   ILE A  35      16.913  17.550   5.819  1.00  6.63           C  \nATOM    249  O   ILE A  35      17.097  16.660   4.970  1.00  7.90           O  \nATOM    250  CB  ILE A  35      16.622  16.995   8.285  1.00  8.07           C  \nATOM    251  CG1 ILE A  35      17.360  15.651   8.067  1.00  9.41           C  \nATOM    252  CG2 ILE A  35      15.592  16.974   9.434  1.00  9.46           C  \nATOM    253  CD1 ILE A  35      18.298  15.206   9.219  1.00  9.85           C  \nATOM    254  N   PRO A  36      17.664  18.669   5.806  1.00  8.07           N  \nATOM    255  CA  PRO A  36      18.635  18.861   4.738  1.00  8.78           C  \nATOM    256  C   PRO A  36      19.925  18.042   4.949  1.00  8.31           C  \nATOM    257  O   PRO A  36      20.593  17.742   3.945  1.00  9.09           O  \nATOM    258  CB  PRO A  36      18.945  20.364   4.783  1.00  9.67           C  \nATOM    259  CG  PRO A  36      18.238  20.937   5.908  1.00 10.15           C  \nATOM    260  CD  PRO A  36      17.371  19.900   6.596  1.00  9.53           C  \nATOM    261  N   GLY A  37      20.172  17.730   6.217  1.00  8.48           N  \nATOM    262  CA  GLY A  37      21.452  16.969   6.513  1.00  9.20           C  \nATOM    263  C   GLY A  37      21.143  15.478   6.427  1.00 10.41           C  \nATOM    264  O   GLY A  37      20.138  15.023   5.878  1.00 12.06           O  \nATOM    265  N   ALA A  38      22.055  14.701   7.032  1.00  9.24           N  \nATOM    266  CA  ALA A  38      22.019  13.242   7.020  1.00  9.24           C  \nATOM    267  C   ALA A  38      21.944  12.628   8.396  1.00  9.60           C  \nATOM    268  O   ALA A  38      21.869  11.387   8.435  1.00 13.65           O  \nATOM    269  CB  ALA A  38      23.246  12.697   6.275  1.00 10.43           C  \nATOM    270  N   THR A  39      21.894  13.435   9.436  1.00  8.70           N  \nATOM    271  CA  THR A  39      21.936  12.911  10.809  1.00  9.46           C  \nATOM    272  C   THR A  39      20.615  13.191  11.521  1.00  8.32           C  \nATOM    273  O   THR A  39      20.357  14.317  11.948  1.00  9.89           O  \nATOM    274  CB  THR A  39      23.131  13.601  11.593  1.00 10.72           C  \nATOM    275  OG1 THR A  39      24.284  13.401  10.709  1.00 11.66           O  \nATOM    276  CG2 THR A  39      23.340  12.935  12.962  1.00 11.81           C  \nATOM    277  N   CYS A  40      19.827  12.110  11.642  1.00  7.64           N  \nATOM    278  CA  CYS A  40      18.504  12.312  12.298  1.00  8.05           C  \nATOM    279  C   CYS A  40      18.684  12.451  13.784  1.00  7.63           C  \nATOM    280  O   CYS A  40      19.533  11.718  14.362  1.00  9.64           O  \nATOM    281  CB  CYS A  40      17.582  11.117  11.996  1.00  7.80           C  \nATOM    282  SG  CYS A  40      17.199  10.929  10.237  1.00  7.30           S  \nATOM    283  N   PRO A  41      17.880  13.266  14.426  1.00  8.00           N  \nATOM    284  CA  PRO A  41      17.924  13.421  15.877  1.00  8.96           C  \nATOM    285  C   PRO A  41      17.392  12.206  16.594  1.00  9.06           C  \nATOM    286  O   PRO A  41      16.652  11.368  16.033  1.00  8.82           O  \nATOM    287  CB  PRO A  41      17.076  14.658  16.145  1.00 10.39           C  \nATOM    288  CG  PRO A  41      16.098  14.689  14.997  1.00 10.99           C  \nATOM    289  CD  PRO A  41      16.859  14.150  13.779  1.00 10.49           C  \nATOM    290  N   GLY A  42      17.728  12.124  17.884  1.00  7.55           N  \nATOM    291  CA  GLY A  42      17.334  10.956  18.691  1.00  8.00           C  \nATOM    292  C   GLY A  42      15.875  10.688  18.871  1.00  7.22           C  \nATOM    293  O   GLY A  42      15.434   9.550  19.166  1.00  8.41           O  \nATOM    294  N   ASP A  43      15.036  11.747  18.715  1.00  5.54           N  \nATOM    295  CA  ASP A  43      13.564  11.573  18.836  1.00  5.85           C  \nATOM    296  C   ASP A  43      12.936  11.227  17.470  1.00  5.87           C  \nATOM    297  O   ASP A  43      11.720  11.040  17.428  1.00  7.29           O  \nATOM    298  CB  ASP A  43      12.933  12.737  19.580  1.00  6.72           C  \nATOM    299  CG  ASP A  43      13.140  14.094  18.958  1.00  8.59           C  \nATOM    300  OD1 ASP A  43      14.109  14.303  18.212  1.00  9.59           O  \nATOM    301  OD2 ASP A  43      12.267  14.963  19.265  1.00 11.45           O  \nATOM    302  N   TYR A  44      13.725  11.174  16.425  1.00  5.22           N  \nATOM    303  CA  TYR A  44      13.257  10.745  15.081  1.00  5.56           C  \nATOM    304  C   TYR A  44      14.275   9.687  14.612  1.00  4.61           C  \nATOM    305  O   TYR A  44      14.930   9.862  13.568  1.00  6.04           O  \nATOM    306  CB  TYR A  44      13.200  11.914  14.071  1.00  5.41           C  \nATOM    307  CG  TYR A  44      12.000  12.819  14.399  1.00  5.34           C  \nATOM    308  CD1 TYR A  44      12.119  13.853  15.332  1.00  6.59           C  \nATOM    309  CD2 TYR A  44      10.775  12.617  13.762  1.00  5.94           C  \nATOM    310  CE1 TYR A  44      11.045  14.675  15.610  1.00  5.97           C  \nATOM    311  CE2 TYR A  44       9.676  13.433  14.048  1.00  5.17           C  \nATOM    312  CZ  TYR A  44       9.802  14.456  14.996  1.00  5.96           C  \nATOM    313  OH  TYR A  44       8.740  15.265  15.269  1.00  8.60           O  \nATOM    314  N   ALA A  45      14.342   8.640  15.422  1.00  4.76           N  \nATOM    315  CA  ALA A  45      15.445   7.667  15.246  1.00  5.89           C  \nATOM    316  C   ALA A  45      15.171   6.533  14.280  1.00  6.67           C  \nATOM    317  O   ALA A  45      16.093   5.705  14.039  1.00  7.56           O  \nATOM    318  CB  ALA A  45      15.680   7.099  16.682  1.00  6.82           C  \nATOM    319  N   ASN A  46      13.966   6.502  13.739  1.00  5.80           N  \nATOM    320  CA  ASN A  46      13.512   5.395  12.878  1.00  6.15           C  \nATOM    321  C   ASN A  46      13.311   5.853  11.455  1.00  6.61           C  \nATOM    322  O   ASN A  46      13.733   6.929  11.026  1.00  7.18           O  \nATOM    323  CB  ASN A  46      12.266   4.769  13.501  1.00  7.27           C  \nATOM    324  CG  ASN A  46      12.538   4.304  14.922  1.00  7.98           C  \nATOM    325  OD1 ASN A  46      11.982   4.849  15.886  1.00 11.00           O  \nATOM    326  ND2 ASN A  46      13.407   3.298  15.015  1.00 10.32           N  \nATOM    327  OXT ASN A  46      12.703   4.973  10.746  1.00  7.86           O  \nTER     328      ASN A  46                                                      \nCONECT   20  282                                                                \nCONECT   26  229                                                                \nCONECT  116  188                                                                \nCONECT  188  116                                                                \nCONECT  229   26                                                                \nCONECT  282   20                                                                \nMASTER      227    0    0    2    2    1    0    6  327    1    6    4          \nEND                                                                             \n', 1);
      						    		$.get('http://www.rcsb.org/pdb/files/'+pdb_name+'.pdb', function(data) {			
      						    			var mol = ChemDoodle.readPDB(data);
      						    			pdb.loadMolecule(mol);
      						    			pdb.startAnimation();
      						    		});
      	    				    	}
      	    					}
      	    				}
      	    			});
      	    			
      	    			_this.p3dProtein.add(pan);
      	    		}
    			}
    			else{
    				_this.p3dProtein.setTitle('No proteins found');
    			}


  	    	}
    	});
    	
//    	$.get('http://ws.bioinfo.cipf.es/celldb/rest/v1/hsa/feature/id/brca2/xref?dbname=pdb', 
    	
    	
    	
    	
//    	http://www.rcsb.org/pdb/files/1A17.pdb
    	
//    	http://www.rcsb.org/pdb/files/AAAA.pdb
    	
//		var pan = Ext.create('Ext.panel.Panel',{
//			title:"3D Protein Viewer",
//	        border:false,
//	        cls:'ocb-border-left-lightgrey',
//			flex:3,
//			bodyPadding:5,
//			autoScroll:true,
//			html:'<canvas class="ChemDoodleWebComponent" id="pdb_canvas_prueba" width="600" height="600" style="width: 600px; height: 600px; ">This browser does not support HTML5/Canvas.</canvas>',
//
//		});

    }
    return this.p3dProtein;

};




GeneInfoWidget.prototype.getEnsembleId = function (){

};


GeneInfoWidget.prototype.getData = function (){
	var _this = this;
	this.panel.disable();
	this.panel.setLoading("Getting information...");
//	category, subcategory, query, resource, callbackFunction
	CellBaseManager.get({
        species:this.species,
        category:'feature',
        subCategory:'gene',
        query:this.query,
        resource:"info",
        success:function(data){
            _this.dataReceived(data.response[0].result[0]);
        }
    });
};
GeneInfoWidget.prototype.dataReceived = function (data){
	this.data=data;
	console.log(this.data);
	this.optionClick({"text":"Information","leaf":"true"});
	this.panel.enable();
	this.panel.setLoading(false);
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

GeneOrangeInfoWidget.prototype.draw = InfoWidget.prototype.draw;
GeneOrangeInfoWidget.prototype.render = InfoWidget.prototype.render;
GeneOrangeInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
GeneOrangeInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
GeneOrangeInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;
GeneOrangeInfoWidget.prototype.getGeneTemplate = InfoWidget.prototype.getGeneTemplate;
GeneOrangeInfoWidget.prototype.getTranscriptTemplate = InfoWidget.prototype.getTranscriptTemplate;

function GeneOrangeInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "Gene Info";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

GeneOrangeInfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return dataTypes=[
	            { text: "Genomic", children: [
	                { text: "Information"},
	                { text: "Transcripts"}
	            ] },
	            { text: "Functional information", children: [
	                { text: "GO"},
	                { text: "KEGG"},
	                { text: "Interpro"}
	            ] }
	        ];
};

GeneOrangeInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "Information": this.panel.add(this.getGenePanel(this.data).show()); break;
			case "Transcripts": this.panel.add(this.getTranscriptPanel(this.data.transcripts).show());  break;
//			case "GO": this.panel.add(this.getGoGrid().show()); break;
			case "GO": this.panel.add(this.getXrefGrid(this.data.go, "GO").show());  break;
			case "Interpro": this.panel.add(this.getXrefGrid(this.data.interpro, "Interpro").show());  break;
			case "KEGG": this.panel.add(this.getXrefGrid(this.data.kegg, "KEGG").show());  break;
		}
	}
};

GeneOrangeInfoWidget.prototype.getGenePanel = function(data){
	if(data==null){
		return this.notFoundPanel;
	}
    if(this.genePanel==null){
    	var tpl = this.getGeneTemplate();
    	
		this.genePanel = Ext.create('Ext.panel.Panel',{
			title:"Gene information",
	        border:false,
	        cls:'panel-border-left',
			flex:3,
			bodyPadding:10,
			data:data,
			tpl:tpl
		});
    }
    return this.genePanel;
};


GeneOrangeInfoWidget.prototype.getTranscriptPanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.transcriptGrid==null){
    	
    	var tpl = this.getTranscriptTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var transcriptPanel = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(transcriptPanel);
    	}
		this.transcriptGrid = Ext.create('Ext.panel.Panel',{
			title:"Transcripts ("+i+")",
			border:false,
			cls:'panel-border-left',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.transcriptGrid;
};


GeneOrangeInfoWidget.prototype.getXrefGrid = function(data, dbname){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this[dbname+"Grid"]==null){
    	var groupField = '';
    	var modelName = dbname;
    	var fields = ['description','displayId'];
    	var columns = [
    	               {header : 'Display Id',dataIndex: 'displayId',flex:1},
    	               {header : 'Description',dataIndex: 'description',flex:3}
    	               ];
    	this[dbname+"Grid"] = this.doGrid(columns,fields,modelName,groupField);
    	this[dbname+"Grid"].store.loadData(data);
    }
    return this[dbname+"Grid"];
};

//GeneOrangeInfoWidget.prototype.getGoGrid = function(){
//    var _this = this;
//    if(this.goGrid==null){
//    	var groupField = 'namespace';
//    	var modelName = 'GO';
//	    var fields = ['id','name','description','level','directNumberOfGenes','namespace','parents','propagatedNumberOfGenes','score'];
//		var columns = [ {header : 'Database id',dataIndex: 'id',flex:2},
//						{header : 'Name',dataIndex: 'name',flex:1},
//						{header : 'Description',dataIndex: 'description',flex:2},
//		                {
//		                	xtype: 'actioncolumn',
//		                	header : '+info',
//		                    flex:1,
//		                    items: [{
//		                        iconCls: 'icon-blue-box',  // Use a URL in the icon config
//		                        tooltip: '+info',    
//		                        handler: function(grid, rowIndex, colIndex) {
//		                            var rec = _this.goStore.getAt(rowIndex);
//		                            Ext.Msg.alert(rec.get('name'), rec.get('description'));
//		                        }
//		                    }]
//		                 },
//		                {header : 'Direct genes',dataIndex: 'directNumberOfGenes',flex:2},
//						{header : 'Level',dataIndex: 'level',flex:1},
//						{header : 'Namespace',dataIndex: 'namespace',flex:2},
//						{header : 'Propagated genes',dataIndex: 'propagatedNumberOfGenes',flex:2.5}
//		             ];
//		this.goGrid = this.doGrid(columns,fields,modelName,groupField);
//		
//    }
//    return this.goGrid;
//};


GeneOrangeInfoWidget.prototype.getTfbsGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.tfbsGrid==null){
    	var groupField = "";
    	var modelName = "TFBS";
	    var fields = ["chromosome","start","end","strand","tfName","relativeStart","relativeEnd","targetGeneName","score","sequence"];
		var columns = [
		                {header : 'Name',dataIndex: 'tfName',flex:1},
		            	{header : 'Location: chr:start-end (strand)', xtype:'templatecolumn', tpl:'{chromosome}:{start}-{end} ({strand})',flex:2.5},
		            	{header : 'Relative (start-end)',xtype:'templatecolumn',tpl:'{relativeStart}-{relativeEnd}',flex:1.5},
						{header : 'Target gene',dataIndex: 'targetGeneName',flex:1},
						{header : 'Score',dataIndex: 'score',flex:1},
						{header : 'Sequence',dataIndex: 'sequence',flex:1}
		             ];
		this.tfbsGrid = this.doGrid(columns,fields,modelName,groupField);
		this.tfbsGrid.store.loadData(data);
    }
    return this.tfbsGrid;
};

GeneOrangeInfoWidget.prototype.getMirnaTargetGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.mirnaTargetGrid==null){
    	var groupField = "";
    	var modelName = "miRNA targets";
	    var fields = ["chromosome","start","end","strand","mirbaseId","score","experimentalMethod","source"];
		var columns = [
		                {header : 'Id',dataIndex: 'mirbaseId',flex:1},
		            	{header : 'Location: chr:start-end (strand)', xtype:'templatecolumn', tpl:'{chromosome}:{start}-{end} ({strand})',flex:2},
						{header : 'Score',dataIndex: 'score',flex:1},
						{header : 'Exp. Method',dataIndex: 'experimentalMethod',flex:1},
						{header : 'source',dataIndex: 'source',flex:1}
		             ];
		this.mirnaTargetGrid = this.doGrid(columns,fields,modelName,groupField);
		this.mirnaTargetGrid.store.loadData(data);
    }
    return this.mirnaTargetGrid;
};

GeneOrangeInfoWidget.prototype.getProteinFeaturesGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.proteinFeaturesGrid==null){
    	var groupField = '';
    	var modelName = "Protein features";
	    var fields = ["identifier","start","end","original","type","description"];
		var columns = [
		                {header : 'Identifier',dataIndex: 'identifier',flex:1},
		               	{header : 'Location: (start-end)', xtype:'templatecolumn', tpl:'{start}-{end}',flex:1.2},
		               	{header : 'Original',dataIndex: 'original',flex:1},
						{header : 'Type',dataIndex: 'type',flex:1},
						{header : 'Description',dataIndex: 'description',flex:1.5}
		             ];
		this.proteinFeaturesGrid = this.doGrid(columns,fields,modelName,groupField);
		this.proteinFeaturesGrid.store.loadData(data);
    }
    return this.proteinFeaturesGrid;
};


GeneOrangeInfoWidget.prototype.getProteinFeaturesGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.proteinFeaturesGrid==null){
    	var groupField = '';
    	var modelName = 'Protein features';
	    var fields = ["identifier","start","end","original","type","description"];
		var columns = [
		                {header : 'Identifier',dataIndex: 'identifier',flex:1},
		               	{header : 'Location: (start-end)', xtype:'templatecolumn', tpl:'{start}-{end}',flex:1.2},
		               	{header : 'Original',dataIndex: 'original',flex:1},
						{header : 'Type',dataIndex: 'type',flex:1},
						{header : 'Description',dataIndex: 'description',flex:1.5}
		             ];
		this.proteinFeaturesGrid = this.doGrid(columns,fields,modelName,groupField);
		this.proteinFeaturesGrid.store.loadData(data);
    }
    return this.proteinFeaturesGrid;
};

GeneOrangeInfoWidget.prototype.get3Dprotein = function(data){
	var _this=this;
    if(this.p3dProtein==null){
    	//ws
//    	
      	this.p3dProtein = Ext.create('Ext.tab.Panel',{
      		title:"3D Protein Viewer",
      		border:false,
      		cls:'panel-border-left',
      		flex:3,
//    		bodyPadding:5,
      		autoScroll:true
//      		items:items
      	});
    	
//		$.get('http://ws.bioinfo.cipf.es/celldb/rest/v1/hsa/feature/id/'+_this.feature.feature.stableId+'/xref?dbname=pdb', function(data){
    
    	var pdbs = [];
    	$.ajax({
//    		  url: 'http://ws.bioinfo.cipf.es/celldb/rest/v1/hsa/feature/id/brca2/xref?dbname=pdb',
    		  url: 'http://ws.bioinfo.cipf.es/cellbase/rest/v1/hsa/feature/id/'+this.query+'/xref?dbname=pdb',
//    		  data: data,
//    		  dataType: dataType,
    		  async:false,
    		  success: function(data){
    			if(data!=""){
//      	    		console.log(data.trim());
      	    		pdbs = data.trim().split("\n");
//      	    		console.log(pdbs);
      	    		
      	    		for ( var i = 0; i < pdbs.length; i++) {
      	    			var pdb_name=pdbs[i].trim();
      	    			var pan = Ext.create('Ext.panel.Panel',{
      	    				title:pdb_name,
      	    				bodyCls:'ocb-background-black',
      	    				html:'<canvas class="ChemDoodleWebComponent" id="pdb_canvas_'+pdb_name+'" width="600" height="600" style="width: 600px; height: 600px; ">This browser does not support HTML5/Canvas.</canvas>',
      	    				listeners:{
      	    					afterrender:function(este){
      	    						// JavaScript Document
      	    						var pdb_name=este.title;
      	    						
      	    				    	ChemDoodle.default_backgroundColor = '#000000';
      	    				    	
      	    				    	var pdb = new ChemDoodle.TransformCanvas3D('pdb_canvas_'+pdb_name, 300, 300);
      	    				    	if(!pdb.gl){
      	    				    	  pdb.emptyMessage = 'Your browser does not support WebGL';
      	    				    	  pdb.displayMessage();
      	    				    	}else{
      	    					    	pdb.specs.set3DRepresentation('Ball and Stick');
      	    					    	pdb.specs.proteins_ribbonCartoonize = true;
      	    					    	pdb.handle = null;
      	    					    	pdb.timeout = 15;
      	    					    	pdb.startAnimation = ChemDoodle._AnimatorCanvas.prototype.startAnimation;
      	    					    	pdb.stopAnimation = ChemDoodle._AnimatorCanvas.prototype.stopAnimation;
      	    					    	pdb.isRunning = ChemDoodle._AnimatorCanvas.prototype.isRunning;
      	    					    	pdb.dblclick = ChemDoodle.RotatorCanvas.prototype.dblclick;
      	    					    	pdb.nextFrame = function(delta){
      	    					    		var matrix = [];
      	    					    		mat4.identity(matrix);
      	    					    		var change = delta/1000;
      	    					    	        var increment = Math.PI/15;
      	    					    		mat4.rotate(matrix, increment*change, [ 1, 0, 0 ]);
      	    					    		mat4.rotate(matrix, increment*change, [ 0, 1, 0 ]);
      	    					    		mat4.rotate(matrix, increment*change, [ 0, 0, 1 ]);
      	    					    		mat4.multiply(this.rotationMatrix, matrix);
      	    					    	};
      	    					    	
//      	    					    	http://ws.bioinfo.cipf.es/celldb/rest/v1/hsa/feature/id/brca2/xref?dbname=pdb
//      	    				    	var mol = ChemDoodle.readPDB('HEADER    PLANT SEED PROTEIN                      30-APR-81   1CRN                                                                       \nDBREF  1CRN A    1    46  UNP    P01542   CRAM_CRAAB       1     46             \nSEQRES   1 A   46  THR THR CYS CYS PRO SER ILE VAL ALA ARG SER ASN PHE          \nSEQRES   2 A   46  ASN VAL CYS ARG LEU PRO GLY THR PRO GLU ALA ILE CYS          \nSEQRES   3 A   46  ALA THR TYR THR GLY CYS ILE ILE ILE PRO GLY ALA THR          \nSEQRES   4 A   46  CYS PRO GLY ASP TYR ALA ASN                                  \nHELIX    1  H1 ILE A    7  PRO A   19  13/10 CONFORMATION RES 17,19       13    \nHELIX    2  H2 GLU A   23  THR A   30  1DISTORTED 3/10 AT RES 30           8    \nSHEET    1  S1 2 THR A   1  CYS A   4  0                                        \nSHEET    2  S1 2 CYS A  32  ILE A  35 -1                                        \nSSBOND   1 CYS A    3    CYS A   40                          1555   1555  2.00  \nSSBOND   2 CYS A    4    CYS A   32                          1555   1555  2.04  \nSSBOND   3 CYS A   16    CYS A   26                          1555   1555  2.05  \nCRYST1   40.960   18.650   22.520  90.00  90.77  90.00 P 1 21 1      2          \nORIGX1      1.000000  0.000000  0.000000        0.00000                         \nORIGX2      0.000000  1.000000  0.000000        0.00000                         \nORIGX3      0.000000  0.000000  1.000000        0.00000                         \nSCALE1      0.024414  0.000000 -0.000328        0.00000                         \nSCALE2      0.000000  0.053619  0.000000        0.00000                         \nSCALE3      0.000000  0.000000  0.044409        0.00000                         \nATOM      1  N   THR A   1      17.047  14.099   3.625  1.00 13.79           N  \nATOM      2  CA  THR A   1      16.967  12.784   4.338  1.00 10.80           C  \nATOM      3  C   THR A   1      15.685  12.755   5.133  1.00  9.19           C  \nATOM      4  O   THR A   1      15.268  13.825   5.594  1.00  9.85           O  \nATOM      5  CB  THR A   1      18.170  12.703   5.337  1.00 13.02           C  \nATOM      6  OG1 THR A   1      19.334  12.829   4.463  1.00 15.06           O  \nATOM      7  CG2 THR A   1      18.150  11.546   6.304  1.00 14.23           C  \nATOM      8  N   THR A   2      15.115  11.555   5.265  1.00  7.81           N  \nATOM      9  CA  THR A   2      13.856  11.469   6.066  1.00  8.31           C  \nATOM     10  C   THR A   2      14.164  10.785   7.379  1.00  5.80           C  \nATOM     11  O   THR A   2      14.993   9.862   7.443  1.00  6.94           O  \nATOM     12  CB  THR A   2      12.732  10.711   5.261  1.00 10.32           C  \nATOM     13  OG1 THR A   2      13.308   9.439   4.926  1.00 12.81           O  \nATOM     14  CG2 THR A   2      12.484  11.442   3.895  1.00 11.90           C  \nATOM     15  N   CYS A   3      13.488  11.241   8.417  1.00  5.24           N  \nATOM     16  CA  CYS A   3      13.660  10.707   9.787  1.00  5.39           C  \nATOM     17  C   CYS A   3      12.269  10.431  10.323  1.00  4.45           C  \nATOM     18  O   CYS A   3      11.393  11.308  10.185  1.00  6.54           O  \nATOM     19  CB  CYS A   3      14.368  11.748  10.691  1.00  5.99           C  \nATOM     20  SG  CYS A   3      15.885  12.426  10.016  1.00  7.01           S  \nATOM     21  N   CYS A   4      12.019   9.272  10.928  1.00  3.90           N  \nATOM     22  CA  CYS A   4      10.646   8.991  11.408  1.00  4.24           C  \nATOM     23  C   CYS A   4      10.654   8.793  12.919  1.00  3.72           C  \nATOM     24  O   CYS A   4      11.659   8.296  13.491  1.00  5.30           O  \nATOM     25  CB  CYS A   4      10.057   7.752  10.682  1.00  4.41           C  \nATOM     26  SG  CYS A   4       9.837   8.018   8.904  1.00  4.72           S  \nATOM     27  N   PRO A   5       9.561   9.108  13.563  1.00  3.96           N  \nATOM     28  CA  PRO A   5       9.448   9.034  15.012  1.00  4.25           C  \nATOM     29  C   PRO A   5       9.288   7.670  15.606  1.00  4.96           C  \nATOM     30  O   PRO A   5       9.490   7.519  16.819  1.00  7.44           O  \nATOM     31  CB  PRO A   5       8.230   9.957  15.345  1.00  5.11           C  \nATOM     32  CG  PRO A   5       7.338   9.786  14.114  1.00  5.24           C  \nATOM     33  CD  PRO A   5       8.366   9.804  12.958  1.00  5.20           C  \nATOM     34  N   SER A   6       8.875   6.686  14.796  1.00  4.83           N  \nATOM     35  CA  SER A   6       8.673   5.314  15.279  1.00  4.45           C  \nATOM     36  C   SER A   6       8.753   4.376  14.083  1.00  4.99           C  \nATOM     37  O   SER A   6       8.726   4.858  12.923  1.00  4.61           O  \nATOM     38  CB  SER A   6       7.340   5.121  15.996  1.00  5.05           C  \nATOM     39  OG  SER A   6       6.274   5.220  15.031  1.00  6.39           O  \nATOM     40  N   ILE A   7       8.881   3.075  14.358  1.00  4.94           N  \nATOM     41  CA  ILE A   7       8.912   2.083  13.258  1.00  6.33           C  \nATOM     42  C   ILE A   7       7.581   2.090  12.506  1.00  5.32           C  \nATOM     43  O   ILE A   7       7.670   2.031  11.245  1.00  6.85           O  \nATOM     44  CB  ILE A   7       9.207   0.677  13.924  1.00  8.43           C  \nATOM     45  CG1 ILE A   7      10.714   0.702  14.312  1.00  9.78           C  \nATOM     46  CG2 ILE A   7       8.811  -0.477  12.969  1.00 11.70           C  \nATOM     47  CD1 ILE A   7      11.185  -0.516  15.142  1.00  9.92           C  \nATOM     48  N   VAL A   8       6.458   2.162  13.159  1.00  5.02           N  \nATOM     49  CA  VAL A   8       5.145   2.209  12.453  1.00  6.93           C  \nATOM     50  C   VAL A   8       5.115   3.379  11.461  1.00  5.39           C  \nATOM     51  O   VAL A   8       4.664   3.268  10.343  1.00  6.30           O  \nATOM     52  CB  VAL A   8       3.995   2.354  13.478  1.00  9.64           C  \nATOM     53  CG1 VAL A   8       2.716   2.891  12.869  1.00 13.85           C  \nATOM     54  CG2 VAL A   8       3.758   1.032  14.208  1.00 11.97           C  \nATOM     55  N   ALA A   9       5.606   4.546  11.941  1.00  3.73           N  \nATOM     56  CA  ALA A   9       5.598   5.767  11.082  1.00  3.56           C  \nATOM     57  C   ALA A   9       6.441   5.527   9.850  1.00  4.13           C  \nATOM     58  O   ALA A   9       6.052   5.933   8.744  1.00  4.36           O  \nATOM     59  CB  ALA A   9       6.022   6.977  11.891  1.00  4.80           C  \nATOM     60  N   ARG A  10       7.647   4.909  10.005  1.00  3.73           N  \nATOM     61  CA  ARG A  10       8.496   4.609   8.837  1.00  3.38           C  \nATOM     62  C   ARG A  10       7.798   3.609   7.876  1.00  3.47           C  \nATOM     63  O   ARG A  10       7.878   3.778   6.651  1.00  4.67           O  \nATOM     64  CB  ARG A  10       9.847   4.020   9.305  1.00  3.95           C  \nATOM     65  CG  ARG A  10      10.752   3.607   8.149  1.00  4.55           C  \nATOM     66  CD  ARG A  10      11.226   4.699   7.244  1.00  5.89           C  \nATOM     67  NE  ARG A  10      12.143   5.571   8.035  1.00  6.20           N  \nATOM     68  CZ  ARG A  10      12.758   6.609   7.443  1.00  7.52           C  \nATOM     69  NH1 ARG A  10      12.539   6.932   6.158  1.00 10.68           N  \nATOM     70  NH2 ARG A  10      13.601   7.322   8.202  1.00  9.48           N  \nATOM     71  N   SER A  11       7.186   2.582   8.445  1.00  5.19           N  \nATOM     72  CA  SER A  11       6.500   1.584   7.565  1.00  4.60           C  \nATOM     73  C   SER A  11       5.382   2.313   6.773  1.00  4.84           C  \nATOM     74  O   SER A  11       5.213   2.016   5.557  1.00  5.84           O  \nATOM     75  CB  SER A  11       5.908   0.462   8.400  1.00  5.91           C  \nATOM     76  OG  SER A  11       6.990  -0.272   9.012  1.00  8.38           O  \nATOM     77  N   ASN A  12       4.648   3.182   7.446  1.00  3.54           N  \nATOM     78  CA  ASN A  12       3.545   3.935   6.751  1.00  4.57           C  \nATOM     79  C   ASN A  12       4.107   4.851   5.691  1.00  4.14           C  \nATOM     80  O   ASN A  12       3.536   5.001   4.617  1.00  5.52           O  \nATOM     81  CB  ASN A  12       2.663   4.677   7.748  1.00  6.42           C  \nATOM     82  CG  ASN A  12       1.802   3.735   8.610  1.00  8.25           C  \nATOM     83  OD1 ASN A  12       1.567   2.613   8.165  1.00 12.72           O  \nATOM     84  ND2 ASN A  12       1.394   4.252   9.767  1.00  9.92           N  \nATOM     85  N   PHE A  13       5.259   5.498   6.005  1.00  3.43           N  \nATOM     86  CA  PHE A  13       5.929   6.358   5.055  1.00  3.49           C  \nATOM     87  C   PHE A  13       6.304   5.578   3.799  1.00  3.40           C  \nATOM     88  O   PHE A  13       6.136   6.072   2.653  1.00  4.07           O  \nATOM     89  CB  PHE A  13       7.183   6.994   5.754  1.00  5.48           C  \nATOM     90  CG  PHE A  13       7.884   8.006   4.883  1.00  5.57           C  \nATOM     91  CD1 PHE A  13       8.906   7.586   4.027  1.00  6.99           C  \nATOM     92  CD2 PHE A  13       7.532   9.373   4.983  1.00  6.52           C  \nATOM     93  CE1 PHE A  13       9.560   8.539   3.194  1.00  8.20           C  \nATOM     94  CE2 PHE A  13       8.176  10.281   4.145  1.00  6.34           C  \nATOM     95  CZ  PHE A  13       9.141   9.845   3.292  1.00  6.84           C  \nATOM     96  N   ASN A  14       6.900   4.390   3.989  1.00  3.64           N  \nATOM     97  CA  ASN A  14       7.331   3.607   2.791  1.00  4.31           C  \nATOM     98  C   ASN A  14       6.116   3.210   1.915  1.00  3.98           C  \nATOM     99  O   ASN A  14       6.240   3.144   0.684  1.00  6.22           O  \nATOM    100  CB  ASN A  14       8.145   2.404   3.240  1.00  5.81           C  \nATOM    101  CG  ASN A  14       9.555   2.856   3.730  1.00  6.82           C  \nATOM    102  OD1 ASN A  14      10.013   3.895   3.323  1.00  9.43           O  \nATOM    103  ND2 ASN A  14      10.120   1.956   4.539  1.00  8.21           N  \nATOM    104  N   VAL A  15       4.993   2.927   2.571  1.00  3.76           N  \nATOM    105  CA  VAL A  15       3.782   2.599   1.742  1.00  3.98           C  \nATOM    106  C   VAL A  15       3.296   3.871   1.004  1.00  3.80           C  \nATOM    107  O   VAL A  15       2.947   3.817  -0.189  1.00  4.85           O  \nATOM    108  CB  VAL A  15       2.698   1.953   2.608  1.00  4.71           C  \nATOM    109  CG1 VAL A  15       1.384   1.826   1.806  1.00  6.67           C  \nATOM    110  CG2 VAL A  15       3.174   0.533   3.005  1.00  6.26           C  \nATOM    111  N   CYS A  16       3.321   4.987   1.720  1.00  3.79           N  \nATOM    112  CA  CYS A  16       2.890   6.285   1.126  1.00  3.54           C  \nATOM    113  C   CYS A  16       3.687   6.597  -0.111  1.00  3.48           C  \nATOM    114  O   CYS A  16       3.200   7.147  -1.103  1.00  4.63           O  \nATOM    115  CB  CYS A  16       3.039   7.369   2.240  1.00  4.58           C  \nATOM    116  SG  CYS A  16       2.559   9.014   1.649  1.00  5.66           S  \nATOM    117  N   ARG A  17       4.997   6.227  -0.100  1.00  3.99           N  \nATOM    118  CA  ARG A  17       5.895   6.489  -1.213  1.00  3.83           C  \nATOM    119  C   ARG A  17       5.738   5.560  -2.409  1.00  3.79           C  \nATOM    120  O   ARG A  17       6.228   5.901  -3.507  1.00  5.39           O  \nATOM    121  CB  ARG A  17       7.370   6.507  -0.731  1.00  4.11           C  \nATOM    122  CG  ARG A  17       7.717   7.687   0.206  1.00  4.69           C  \nATOM    123  CD  ARG A  17       7.949   8.947  -0.615  1.00  5.10           C  \nATOM    124  NE  ARG A  17       9.212   8.856  -1.337  1.00  4.71           N  \nATOM    125  CZ  ARG A  17       9.537   9.533  -2.431  1.00  5.28           C  \nATOM    126  NH1 ARG A  17       8.659  10.350  -3.032  1.00  6.67           N  \nATOM    127  NH2 ARG A  17      10.793   9.491  -2.899  1.00  6.41           N  \nATOM    128  N   LEU A  18       5.051   4.411  -2.204  1.00  4.70           N  \nATOM    129  CA  LEU A  18       4.933   3.431  -3.326  1.00  5.46           C  \nATOM    130  C   LEU A  18       4.397   4.014  -4.620  1.00  5.13           C  \nATOM    131  O   LEU A  18       4.988   3.755  -5.687  1.00  5.55           O  \nATOM    132  CB  LEU A  18       4.196   2.184  -2.863  1.00  6.47           C  \nATOM    133  CG  LEU A  18       4.960   1.178  -1.991  1.00  7.43           C  \nATOM    134  CD1 LEU A  18       3.907   0.097  -1.634  1.00  8.70           C  \nATOM    135  CD2 LEU A  18       6.129   0.606  -2.768  1.00  9.39           C  \nATOM    136  N   PRO A  19       3.329   4.795  -4.543  1.00  4.28           N  \nATOM    137  CA  PRO A  19       2.792   5.376  -5.797  1.00  5.38           C  \nATOM    138  C   PRO A  19       3.573   6.540  -6.322  1.00  6.30           C  \nATOM    139  O   PRO A  19       3.260   7.045  -7.422  1.00  9.62           O  \nATOM    140  CB  PRO A  19       1.358   5.766  -5.472  1.00  5.87           C  \nATOM    141  CG  PRO A  19       1.223   5.694  -3.993  1.00  6.47           C  \nATOM    142  CD  PRO A  19       2.421   4.941  -3.408  1.00  6.45           C  \nATOM    143  N   GLY A  20       4.565   7.047  -5.559  1.00  4.94           N  \nATOM    144  CA  GLY A  20       5.366   8.191  -6.018  1.00  5.39           C  \nATOM    145  C   GLY A  20       5.007   9.481  -5.280  1.00  5.03           C  \nATOM    146  O   GLY A  20       5.535  10.510  -5.730  1.00  7.34           O  \nATOM    147  N   THR A  21       4.181   9.438  -4.262  1.00  4.10           N  \nATOM    148  CA  THR A  21       3.767  10.609  -3.513  1.00  3.94           C  \nATOM    149  C   THR A  21       5.017  11.397  -3.042  1.00  3.96           C  \nATOM    150  O   THR A  21       5.947  10.757  -2.523  1.00  5.82           O  \nATOM    151  CB  THR A  21       2.992  10.188  -2.225  1.00  4.13           C  \nATOM    152  OG1 THR A  21       2.051   9.144  -2.623  1.00  5.45           O  \nATOM    153  CG2 THR A  21       2.260  11.349  -1.551  1.00  5.41           C  \nATOM    154  N   PRO A  22       4.971  12.703  -3.176  1.00  5.04           N  \nATOM    155  CA  PRO A  22       6.143  13.513  -2.696  1.00  4.69           C  \nATOM    156  C   PRO A  22       6.400  13.233  -1.225  1.00  4.19           C  \nATOM    157  O   PRO A  22       5.485  13.061  -0.382  1.00  4.47           O  \nATOM    158  CB  PRO A  22       5.703  14.969  -2.920  1.00  7.12           C  \nATOM    159  CG  PRO A  22       4.676  14.893  -3.996  1.00  7.03           C  \nATOM    160  CD  PRO A  22       3.964  13.567  -3.811  1.00  4.90           C  \nATOM    161  N   GLU A  23       7.728  13.297  -0.921  1.00  5.16           N  \nATOM    162  CA  GLU A  23       8.114  13.103   0.500  1.00  5.31           C  \nATOM    163  C   GLU A  23       7.427  14.073   1.410  1.00  4.11           C  \nATOM    164  O   GLU A  23       7.036  13.682   2.540  1.00  5.11           O  \nATOM    165  CB  GLU A  23       9.648  13.285   0.660  1.00  6.16           C  \nATOM    166  CG  GLU A  23      10.440  12.093   0.063  1.00  7.48           C  \nATOM    167  CD  GLU A  23      11.941  12.170   0.391  1.00  9.40           C  \nATOM    168  OE1 GLU A  23      12.416  13.225   0.681  1.00 10.40           O  \nATOM    169  OE2 GLU A  23      12.539  11.070   0.292  1.00 13.32           O  \nATOM    170  N   ALA A  24       7.212  15.334   0.966  1.00  4.56           N  \nATOM    171  CA  ALA A  24       6.614  16.317   1.913  1.00  4.49           C  \nATOM    172  C   ALA A  24       5.212  15.936   2.350  1.00  4.10           C  \nATOM    173  O   ALA A  24       4.782  16.166   3.495  1.00  5.64           O  \nATOM    174  CB  ALA A  24       6.605  17.695   1.246  1.00  5.80           C  \nATOM    175  N   ILE A  25       4.445  15.318   1.405  1.00  4.37           N  \nATOM    176  CA  ILE A  25       3.074  14.894   1.756  1.00  5.44           C  \nATOM    177  C   ILE A  25       3.085  13.643   2.645  1.00  4.32           C  \nATOM    178  O   ILE A  25       2.315  13.523   3.578  1.00  4.72           O  \nATOM    179  CB  ILE A  25       2.204  14.637   0.462  1.00  6.42           C  \nATOM    180  CG1 ILE A  25       1.815  16.048  -0.129  1.00  7.50           C  \nATOM    181  CG2 ILE A  25       0.903  13.864   0.811  1.00  7.65           C  \nATOM    182  CD1 ILE A  25       0.756  16.761   0.757  1.00  7.80           C  \nATOM    183  N   CYS A  26       4.032  12.764   2.313  1.00  3.92           N  \nATOM    184  CA  CYS A  26       4.180  11.549   3.187  1.00  4.37           C  \nATOM    185  C   CYS A  26       4.632  11.944   4.596  1.00  3.95           C  \nATOM    186  O   CYS A  26       4.227  11.252   5.547  1.00  4.74           O  \nATOM    187  CB  CYS A  26       5.038  10.518   2.539  1.00  4.63           C  \nATOM    188  SG  CYS A  26       4.349   9.794   1.022  1.00  5.61           S  \nATOM    189  N   ALA A  27       5.408  13.012   4.694  1.00  3.89           N  \nATOM    190  CA  ALA A  27       5.879  13.502   6.026  1.00  4.43           C  \nATOM    191  C   ALA A  27       4.696  13.908   6.882  1.00  4.26           C  \nATOM    192  O   ALA A  27       4.528  13.422   8.025  1.00  5.44           O  \nATOM    193  CB  ALA A  27       6.880  14.615   5.830  1.00  5.36           C  \nATOM    194  N   THR A  28       3.827  14.802   6.358  1.00  4.53           N  \nATOM    195  CA  THR A  28       2.691  15.221   7.194  1.00  5.08           C  \nATOM    196  C   THR A  28       1.672  14.132   7.434  1.00  4.62           C  \nATOM    197  O   THR A  28       0.947  14.112   8.468  1.00  7.80           O  \nATOM    198  CB  THR A  28       1.986  16.520   6.614  1.00  6.03           C  \nATOM    199  OG1 THR A  28       1.664  16.221   5.230  1.00  7.19           O  \nATOM    200  CG2 THR A  28       2.914  17.739   6.700  1.00  7.34           C  \nATOM    201  N   TYR A  29       1.621  13.190   6.511  1.00  5.01           N  \nATOM    202  CA  TYR A  29       0.715  12.045   6.657  1.00  6.60           C  \nATOM    203  C   TYR A  29       1.125  11.125   7.815  1.00  4.92           C  \nATOM    204  O   TYR A  29       0.286  10.632   8.545  1.00  7.13           O  \nATOM    205  CB  TYR A  29       0.755  11.229   5.322  1.00  9.66           C  \nATOM    206  CG  TYR A  29      -0.203  10.044   5.354  1.00 11.56           C  \nATOM    207  CD1 TYR A  29      -1.547  10.337   5.645  1.00 12.85           C  \nATOM    208  CD2 TYR A  29       0.193   8.750   5.100  1.00 14.44           C  \nATOM    209  CE1 TYR A  29      -2.496   9.329   5.673  1.00 16.61           C  \nATOM    210  CE2 TYR A  29      -0.801   7.705   5.156  1.00 17.11           C  \nATOM    211  CZ  TYR A  29      -2.079   8.031   5.430  1.00 19.99           C  \nATOM    212  OH  TYR A  29      -3.097   7.057   5.458  1.00 28.98           O  \nATOM    213  N   THR A  30       2.470  10.984   7.995  1.00  5.31           N  \nATOM    214  CA  THR A  30       2.986   9.994   8.950  1.00  5.70           C  \nATOM    215  C   THR A  30       3.609  10.505  10.230  1.00  6.28           C  \nATOM    216  O   THR A  30       3.766   9.715  11.186  1.00  8.77           O  \nATOM    217  CB  THR A  30       4.076   9.103   8.225  1.00  6.55           C  \nATOM    218  OG1 THR A  30       5.125  10.027   7.824  1.00  6.57           O  \nATOM    219  CG2 THR A  30       3.493   8.324   7.035  1.00  7.29           C  \nATOM    220  N   GLY A  31       3.984  11.764  10.241  1.00  4.99           N  \nATOM    221  CA  GLY A  31       4.769  12.336  11.360  1.00  5.50           C  \nATOM    222  C   GLY A  31       6.255  12.243  11.106  1.00  4.19           C  \nATOM    223  O   GLY A  31       7.037  12.750  11.954  1.00  6.12           O  \nATOM    224  N   CYS A  32       6.710  11.631   9.992  1.00  4.30           N  \nATOM    225  CA  CYS A  32       8.140  11.694   9.635  1.00  4.89           C  \nATOM    226  C   CYS A  32       8.500  13.141   9.206  1.00  5.50           C  \nATOM    227  O   CYS A  32       7.581  13.949   8.944  1.00  5.82           O  \nATOM    228  CB  CYS A  32       8.504  10.686   8.530  1.00  4.66           C  \nATOM    229  SG  CYS A  32       8.048   8.987   8.881  1.00  5.33           S  \nATOM    230  N   ILE A  33       9.793  13.410   9.173  1.00  6.02           N  \nATOM    231  CA  ILE A  33      10.280  14.760   8.823  1.00  5.24           C  \nATOM    232  C   ILE A  33      11.346  14.658   7.743  1.00  5.16           C  \nATOM    233  O   ILE A  33      11.971  13.583   7.552  1.00  7.19           O  \nATOM    234  CB  ILE A  33      10.790  15.535  10.085  1.00  5.49           C  \nATOM    235  CG1 ILE A  33      12.059  14.803  10.671  1.00  6.85           C  \nATOM    236  CG2 ILE A  33       9.684  15.686  11.138  1.00  6.45           C  \nATOM    237  CD1 ILE A  33      12.733  15.676  11.781  1.00  8.94           C  \nATOM    238  N   ILE A  34      11.490  15.773   7.038  1.00  5.52           N  \nATOM    239  CA  ILE A  34      12.552  15.877   6.036  1.00  6.82           C  \nATOM    240  C   ILE A  34      13.590  16.917   6.560  1.00  6.92           C  \nATOM    241  O   ILE A  34      13.168  18.006   6.945  1.00  9.22           O  \nATOM    242  CB  ILE A  34      11.987  16.360   4.681  1.00  8.11           C  \nATOM    243  CG1 ILE A  34      10.914  15.338   4.163  1.00  9.59           C  \nATOM    244  CG2 ILE A  34      13.131  16.517   3.629  1.00  9.73           C  \nATOM    245  CD1 ILE A  34      10.151  16.024   2.938  1.00 13.41           C  \nATOM    246  N   ILE A  35      14.856  16.493   6.536  1.00  7.06           N  \nATOM    247  CA  ILE A  35      15.930  17.454   6.941  1.00  7.52           C  \nATOM    248  C   ILE A  35      16.913  17.550   5.819  1.00  6.63           C  \nATOM    249  O   ILE A  35      17.097  16.660   4.970  1.00  7.90           O  \nATOM    250  CB  ILE A  35      16.622  16.995   8.285  1.00  8.07           C  \nATOM    251  CG1 ILE A  35      17.360  15.651   8.067  1.00  9.41           C  \nATOM    252  CG2 ILE A  35      15.592  16.974   9.434  1.00  9.46           C  \nATOM    253  CD1 ILE A  35      18.298  15.206   9.219  1.00  9.85           C  \nATOM    254  N   PRO A  36      17.664  18.669   5.806  1.00  8.07           N  \nATOM    255  CA  PRO A  36      18.635  18.861   4.738  1.00  8.78           C  \nATOM    256  C   PRO A  36      19.925  18.042   4.949  1.00  8.31           C  \nATOM    257  O   PRO A  36      20.593  17.742   3.945  1.00  9.09           O  \nATOM    258  CB  PRO A  36      18.945  20.364   4.783  1.00  9.67           C  \nATOM    259  CG  PRO A  36      18.238  20.937   5.908  1.00 10.15           C  \nATOM    260  CD  PRO A  36      17.371  19.900   6.596  1.00  9.53           C  \nATOM    261  N   GLY A  37      20.172  17.730   6.217  1.00  8.48           N  \nATOM    262  CA  GLY A  37      21.452  16.969   6.513  1.00  9.20           C  \nATOM    263  C   GLY A  37      21.143  15.478   6.427  1.00 10.41           C  \nATOM    264  O   GLY A  37      20.138  15.023   5.878  1.00 12.06           O  \nATOM    265  N   ALA A  38      22.055  14.701   7.032  1.00  9.24           N  \nATOM    266  CA  ALA A  38      22.019  13.242   7.020  1.00  9.24           C  \nATOM    267  C   ALA A  38      21.944  12.628   8.396  1.00  9.60           C  \nATOM    268  O   ALA A  38      21.869  11.387   8.435  1.00 13.65           O  \nATOM    269  CB  ALA A  38      23.246  12.697   6.275  1.00 10.43           C  \nATOM    270  N   THR A  39      21.894  13.435   9.436  1.00  8.70           N  \nATOM    271  CA  THR A  39      21.936  12.911  10.809  1.00  9.46           C  \nATOM    272  C   THR A  39      20.615  13.191  11.521  1.00  8.32           C  \nATOM    273  O   THR A  39      20.357  14.317  11.948  1.00  9.89           O  \nATOM    274  CB  THR A  39      23.131  13.601  11.593  1.00 10.72           C  \nATOM    275  OG1 THR A  39      24.284  13.401  10.709  1.00 11.66           O  \nATOM    276  CG2 THR A  39      23.340  12.935  12.962  1.00 11.81           C  \nATOM    277  N   CYS A  40      19.827  12.110  11.642  1.00  7.64           N  \nATOM    278  CA  CYS A  40      18.504  12.312  12.298  1.00  8.05           C  \nATOM    279  C   CYS A  40      18.684  12.451  13.784  1.00  7.63           C  \nATOM    280  O   CYS A  40      19.533  11.718  14.362  1.00  9.64           O  \nATOM    281  CB  CYS A  40      17.582  11.117  11.996  1.00  7.80           C  \nATOM    282  SG  CYS A  40      17.199  10.929  10.237  1.00  7.30           S  \nATOM    283  N   PRO A  41      17.880  13.266  14.426  1.00  8.00           N  \nATOM    284  CA  PRO A  41      17.924  13.421  15.877  1.00  8.96           C  \nATOM    285  C   PRO A  41      17.392  12.206  16.594  1.00  9.06           C  \nATOM    286  O   PRO A  41      16.652  11.368  16.033  1.00  8.82           O  \nATOM    287  CB  PRO A  41      17.076  14.658  16.145  1.00 10.39           C  \nATOM    288  CG  PRO A  41      16.098  14.689  14.997  1.00 10.99           C  \nATOM    289  CD  PRO A  41      16.859  14.150  13.779  1.00 10.49           C  \nATOM    290  N   GLY A  42      17.728  12.124  17.884  1.00  7.55           N  \nATOM    291  CA  GLY A  42      17.334  10.956  18.691  1.00  8.00           C  \nATOM    292  C   GLY A  42      15.875  10.688  18.871  1.00  7.22           C  \nATOM    293  O   GLY A  42      15.434   9.550  19.166  1.00  8.41           O  \nATOM    294  N   ASP A  43      15.036  11.747  18.715  1.00  5.54           N  \nATOM    295  CA  ASP A  43      13.564  11.573  18.836  1.00  5.85           C  \nATOM    296  C   ASP A  43      12.936  11.227  17.470  1.00  5.87           C  \nATOM    297  O   ASP A  43      11.720  11.040  17.428  1.00  7.29           O  \nATOM    298  CB  ASP A  43      12.933  12.737  19.580  1.00  6.72           C  \nATOM    299  CG  ASP A  43      13.140  14.094  18.958  1.00  8.59           C  \nATOM    300  OD1 ASP A  43      14.109  14.303  18.212  1.00  9.59           O  \nATOM    301  OD2 ASP A  43      12.267  14.963  19.265  1.00 11.45           O  \nATOM    302  N   TYR A  44      13.725  11.174  16.425  1.00  5.22           N  \nATOM    303  CA  TYR A  44      13.257  10.745  15.081  1.00  5.56           C  \nATOM    304  C   TYR A  44      14.275   9.687  14.612  1.00  4.61           C  \nATOM    305  O   TYR A  44      14.930   9.862  13.568  1.00  6.04           O  \nATOM    306  CB  TYR A  44      13.200  11.914  14.071  1.00  5.41           C  \nATOM    307  CG  TYR A  44      12.000  12.819  14.399  1.00  5.34           C  \nATOM    308  CD1 TYR A  44      12.119  13.853  15.332  1.00  6.59           C  \nATOM    309  CD2 TYR A  44      10.775  12.617  13.762  1.00  5.94           C  \nATOM    310  CE1 TYR A  44      11.045  14.675  15.610  1.00  5.97           C  \nATOM    311  CE2 TYR A  44       9.676  13.433  14.048  1.00  5.17           C  \nATOM    312  CZ  TYR A  44       9.802  14.456  14.996  1.00  5.96           C  \nATOM    313  OH  TYR A  44       8.740  15.265  15.269  1.00  8.60           O  \nATOM    314  N   ALA A  45      14.342   8.640  15.422  1.00  4.76           N  \nATOM    315  CA  ALA A  45      15.445   7.667  15.246  1.00  5.89           C  \nATOM    316  C   ALA A  45      15.171   6.533  14.280  1.00  6.67           C  \nATOM    317  O   ALA A  45      16.093   5.705  14.039  1.00  7.56           O  \nATOM    318  CB  ALA A  45      15.680   7.099  16.682  1.00  6.82           C  \nATOM    319  N   ASN A  46      13.966   6.502  13.739  1.00  5.80           N  \nATOM    320  CA  ASN A  46      13.512   5.395  12.878  1.00  6.15           C  \nATOM    321  C   ASN A  46      13.311   5.853  11.455  1.00  6.61           C  \nATOM    322  O   ASN A  46      13.733   6.929  11.026  1.00  7.18           O  \nATOM    323  CB  ASN A  46      12.266   4.769  13.501  1.00  7.27           C  \nATOM    324  CG  ASN A  46      12.538   4.304  14.922  1.00  7.98           C  \nATOM    325  OD1 ASN A  46      11.982   4.849  15.886  1.00 11.00           O  \nATOM    326  ND2 ASN A  46      13.407   3.298  15.015  1.00 10.32           N  \nATOM    327  OXT ASN A  46      12.703   4.973  10.746  1.00  7.86           O  \nTER     328      ASN A  46                                                      \nCONECT   20  282                                                                \nCONECT   26  229                                                                \nCONECT  116  188                                                                \nCONECT  188  116                                                                \nCONECT  229   26                                                                \nCONECT  282   20                                                                \nMASTER      227    0    0    2    2    1    0    6  327    1    6    4          \nEND                                                                             \n', 1);
      						    		$.get('http://www.rcsb.org/pdb/files/'+pdb_name+'.pdb', function(data) {			
      						    			var mol = ChemDoodle.readPDB(data);
      						    			pdb.loadMolecule(mol);
      						    			pdb.startAnimation();
      						    		});
      	    				    	}
      	    					}
      	    				}
      	    			});
      	    			
      	    			_this.p3dProtein.add(pan);
      	    		}
    			}
    			else{
    				_this.p3dProtein.setTitle('No proteins found');
    			}


  	    	}
    	});
    	
//    	$.get('http://ws.bioinfo.cipf.es/celldb/rest/v1/hsa/feature/id/brca2/xref?dbname=pdb', 
    	
    	
    	
    	
//    	http://www.rcsb.org/pdb/files/1A17.pdb
    	
//    	http://www.rcsb.org/pdb/files/AAAA.pdb
    	
//		var pan = Ext.create('Ext.panel.Panel',{
//			title:"3D Protein Viewer",
//	        border:false,
//	        cls:'panel-border-left',
//			flex:3,
//			bodyPadding:5,
//			autoScroll:true,
//			html:'<canvas class="ChemDoodleWebComponent" id="pdb_canvas_prueba" width="600" height="600" style="width: 600px; height: 600px; ">This browser does not support HTML5/Canvas.</canvas>',
//
//		});

    }
    return this.p3dProtein;

};




GeneOrangeInfoWidget.prototype.getEnsembleId = function (){

};


GeneOrangeInfoWidget.prototype.getData = function (){
	var _this = this;
	this.panel.disable();
	this.panel.setLoading("Getting information...");
//	category, subcategory, query, resource, callbackFunction
	var cellBaseManager = new CellBaseManager(this.species);
	cellBaseManager.success.addEventListener(function(sender,data){
		_this.dataReceived(JSON.parse(data.result));//TODO
	});
	cellBaseManager.get("feature","gene", this.query, "fullinfo");
};
GeneOrangeInfoWidget.prototype.dataReceived = function (data){
	this.data=data[0][0];
	console.log(this.data);
	this.optionClick({"text":"Information","leaf":"true"});
	this.panel.enable();
	this.panel.setLoading(false);
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

MirnaInfoWidget.prototype.draw = InfoWidget.prototype.draw;
MirnaInfoWidget.prototype.render = InfoWidget.prototype.render;
MirnaInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
MirnaInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
MirnaInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;
MirnaInfoWidget.prototype.getTranscriptTemplate = InfoWidget.prototype.getTranscriptTemplate;
MirnaInfoWidget.prototype.getGeneTemplate = InfoWidget.prototype.getGeneTemplate;


function MirnaInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "miRNA Information";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

MirnaInfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return dataTypes=[
	            { text: "Information", children: [
	                { text: "miRNA"},
	                { text: "Transcript"}, 
	                { text: "Gene"} 
	            ] },
	            { text: "Regulatory", children: [
  	                { text: "Target Genes"}
  	            ] },
  	            { text: "Disease", children: [
  	              { text: "Related Diseases"}
  	            ] }
	        ];
};
MirnaInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "miRNA":  this.panel.add(this.getMirnaPanel(this.data.mirna).show()); break;
			case "Transcript": this.panel.add(this.getTranscriptPanel(this.data.transcripts).show()); break;
			case "Gene": this.panel.add(this.getGenePanel(this.data.genes).show()); break;
			case "Target Genes": this.panel.add(this.getTargetGenesGrid(this.data.targetGenes).show()); break;
			case "Related Diseases": this.panel.add(this.getMirnaDiseasesGrid(this.data.mirnaDiseases).show()); break;
		}
	}
};

MirnaInfoWidget.prototype.getMirnaPanel = function(data){
	if(data.mirnaMature.length<=0 && data.mirnaGenes.length<=0){
		return this.notFoundPanel;
	}
    if(this.mirnaPanel==null){
    	
    	
    	var tplMature = this.getMirnaMatureTemplate();
    	var tplGene = this.getMirnaGeneTemplate();

    	var panels = [];
    	for ( var i = 0; i < data.mirnaMature.length; i++) {
			var maturePan = Ext.create('Ext.container.Container',{
				padding:5,
				data:data.mirnaMature[i],
				tpl:tplMature
			});
			panels.push(maturePan);
    	}
    	
    	for ( var i = 0; i < data.mirnaGenes.length; i++) {
			var genePan = Ext.create('Ext.container.Container',{
				padding:5,
				data:data.mirnaGenes[i],
				tpl:tplGene
			});
			panels.push(genePan);
    	}
		this.mirnaPanel = Ext.create('Ext.panel.Panel',{
			title:"miRNA",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.mirnaPanel;
};


MirnaInfoWidget.prototype.getTranscriptPanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.transcriptGrid==null){
    	
    	var tpl = this.getTranscriptTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var transcriptPanel = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(transcriptPanel);
    	}
		this.transcriptGrid = Ext.create('Ext.panel.Panel',{
			title:"Transcripts ("+i+")",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.transcriptGrid;
};

MirnaInfoWidget.prototype.getGenePanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.genePanel==null){
    	
    	var tpl = this.getGeneTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var genePan = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(genePan);
    	}
		this.genePanel = Ext.create('Ext.panel.Panel',{
			title:"Genes ("+i+")",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.genePanel;
};

MirnaInfoWidget.prototype.getTargetGenesGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.targetGenesGrid==null){
//    	console.log(data);
    	var groupField = '';
    	var modelName = "targetGenes";
    	var fields = ['externalName','stableId','biotype','chromosome','start','end','strand','description'];
    	var columns = [
    	               {header : 'Name',dataIndex: 'externalName',flex:1},
    	               {header : 'Stable Id',dataIndex: 'stableId',flex:2},
    	               {header : 'Biotype',dataIndex: 'biotype',flex:1.5},
    	               {header : 'Chr',dataIndex: 'chromosome',flex:0.5},
    	               {header : 'Start',dataIndex: 'start',flex:1},
    	               {header : 'End',dataIndex: 'end',flex:1},
    	               {header : 'Strand',dataIndex: 'strand',flex:0.5},
    	               {header : 'Description',dataIndex: 'description',flex:1}
    	               ];
    	this.targetGenesGrid = this.doGrid(columns,fields,modelName,groupField);
    	this.targetGenesGrid.store.loadData(data);
    }
    return this.targetGenesGrid;
};

MirnaInfoWidget.prototype.getMirnaDiseasesGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.mirnaDiseasesGrid==null){
//    	console.log(data);
    		var groupField = '';
    		var modelName = "mirnaDiseases";
    		var fields = ['mirnaDiseaseId','mirnaGene','mirbaseId','diseaseName','pubmedId','description'];
    		var columns = [
    		               {header : 'Name',dataIndex: 'mirbaseId',flex:1.5},
    		               {header : 'Disease',dataIndex: 'diseaseName',flex:1.5},
    		               {header : 'PubMed id',dataIndex: 'pubmedId',flex:1},
    		               {header : 'Description',dataIndex: 'description',flex:3}
    		               ];
    		this.mirnaDiseasesGrid = this.doGrid(columns,fields,modelName,groupField);
    		this.mirnaDiseasesGrid.store.loadData(data);
    }
    return this.mirnaDiseasesGrid;
};


MirnaInfoWidget.prototype.getData = function (){
	var _this = this;
	this.panel.disable();
	this.panel.setLoading("Getting information...");
//	category, subcategory, query, resource, callbackFunction
	var cellBaseDataAdapter = new CellBaseDataAdapter(this.species);
	cellBaseDataAdapter.successed.addEventListener(function (evt){
		_this.dataReceived(cellBaseDataAdapter.toJSON());
	});
	cellBaseDataAdapter.fill("regulatory","mirna_mature", this.feature.getName(), "fullinfo");
	console.log(this.feature.getName());
};
MirnaInfoWidget.prototype.dataReceived = function (data){
	var parseData = JSON.parse(data);
	this.data=parseData[0];
	console.log(this.data);
	this.optionClick({"text":"miRNA","leaf":"true"});
	this.panel.enable();
	this.panel.setLoading(false);
};

MirnaInfoWidget.prototype.getMirnaMatureTemplate = function (){
	return new Ext.XTemplate(
			 '<p><span class="panel-border-bottom"><span class="ssel s130">miRNA mature</span> &nbsp; <span class="emph s120"> {mirbaseId} </span></span></p>',
			 '<br>',
			 '<p><span class="w140 dis s90">miRBase Accession: </span> <span class="">{mirbaseAcc}</span></p>',
			 '<span class="w140 dis s90">Sequence: </span> <span class="">{sequence}</span>'
		);
};

MirnaInfoWidget.prototype.getMirnaGeneTemplate = function (){
	return new Ext.XTemplate(
			 '<p><span class="panel-border-bottom"><span class="ssel s130">miRNA gene</span> &nbsp; <span class="emph s120"> {mirbaseId} </span></span></p>',
			 '<br>',
			 '<p><span class="w140 dis s90">miRBase Accession: </span> <span class="">{mirbaseAcc}</span></p>',
			 '<span class="w140 dis s90">Sequence: </span> <span class="">{sequence}</span>',
			 '<p><span class="w140 dis s90">Status: </span> <span class="">{status}</span></p>'
		);
};



/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

ProteinInfoWidget.prototype.draw = InfoWidget.prototype.draw;
ProteinInfoWidget.prototype.render = InfoWidget.prototype.render;
ProteinInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
ProteinInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
ProteinInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;

function ProteinInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "Protein Info";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

ProteinInfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return dataTypes=[
	            { text: "Sumary", children: [
	                { text: "Long"},
	                { text: "Seq"}
	            ] },
	            { text: "Functional information", children: [
	                { text: "GO"},
	                { text: "Reactome"},
	                { text: "Interpro"}
	            ] },
	            { text: "Interactions"},
	            { text: "Variations"}
	           
	        ];
};
ProteinInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "":  break;
			case "":  break;
//			case "GO": this.panel.add(this.getGoGrid().show()); break;
			case "Reactome": break;
			case "Interpro": break;
			case "": break;
			case "": break;
			case "": break;
		}
	}
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

SnpInfoWidget.prototype.draw = InfoWidget.prototype.draw;
SnpInfoWidget.prototype.render = InfoWidget.prototype.render;
SnpInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
SnpInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
SnpInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;
SnpInfoWidget.prototype.getSnpTemplate = InfoWidget.prototype.getSnpTemplate;
SnpInfoWidget.prototype.getSnpTranscriptTemplate = InfoWidget.prototype.getSnpTranscriptTemplate;
SnpInfoWidget.prototype.getConsequenceTypeTemplate = InfoWidget.prototype.getConsequenceTypeTemplate;
SnpInfoWidget.prototype.getPhenotypeTemplate = InfoWidget.prototype.getPhenotypeTemplate;
SnpInfoWidget.prototype.getPopulationTemplate = InfoWidget.prototype.getPopulationTemplate;

function SnpInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "SNP Info";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

SnpInfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return dataTypes=[
	            { text: "Genomic", children: [
	                { text: "Information"},
	                { text: "Transcripts"}
	            ] },
	            { text: "Consequence type"},
	            { text: "Annotated phenotype"}
//	            { text: "Population frequency"}
	           
	        ];
};
SnpInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "Information":  this.panel.add(this.getInfoPanel(this.data).show()); break;
			case "Transcripts": this.panel.add(this.getSnpTranscriptPanel(this.data.transcriptVariations).show()); break;
			case "Consequence type": this.panel.add(this.getConsequenceTypePanel(this.data.transcriptVariations).show()); break;
			case "Annotated phenotype": this.panel.add(this.getPhenotypePanel(this.data.phenotype).show()); break;
//			case "Population frequency": this.panel.add(this.getPopulationPanel(this.data.population).show()); break;
		}
	}
};

SnpInfoWidget.prototype.getInfoPanel = function(data){
	if(data==null){
		return this.notFoundPanel;
	}
    if(this.infoPanel==null){
    	var tpl = this.getSnpTemplate();

		this.infoPanel = Ext.create('Ext.panel.Panel',{
			title:"Information",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:10,
			data:data,
			tpl:tpl
		});

    }
    return this.infoPanel;
};


SnpInfoWidget.prototype.getSnpTranscriptPanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.snpTranscriptGrid==null){
    	var tpl = this.getSnpTranscriptTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var snpTranscriptPanel = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(snpTranscriptPanel);
    	}
		this.snpTranscriptGrid = Ext.create('Ext.panel.Panel',{
			title:"Transcripts ("+i+")",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.snpTranscriptGrid;
};

SnpInfoWidget.prototype.getConsequenceTypePanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.consequencePanel==null){
    	var tpl = this.getConsequenceTypeTemplate();


        var data2 = [];
        for(var i = 0; i<data.length; i++){
            for(var j = 0; j<data[i].consequenceTypes.length; j++){
                var consequenceType = data[i].consequenceTypes[j];
                data[i].consequenceType = consequenceType;
                data2.push(data[i]);
            }
        }

        var groupField = 'consequenceType';
        var modelName = 'transcriptVariation';
        var fields = ['transcriptId','consequenceType'];
        var columns = [
            {header : 'Transcript id',dataIndex: 'transcriptId',flex:1},
            {header : 'Consequence type',dataIndex: 'consequenceType',flex:1}
        ];
        this.consequencePanel = this.doGrid(columns,fields,modelName,groupField);
        this.consequencePanel.store.loadData(data2);

//    	var panels = [];
//    	for ( var i = 0; i < data.length; i++) {
//			var consPanel = Ext.create('Ext.container.Container',{
//				padding:5,
//				data:data[i],
//				tpl:tpl
//			});
//			panels.push(consPanel);
//    	}
//		this.consequencePanel = Ext.create('Ext.panel.Panel',{
//			title:"Consequence type ("+i+")",
//			border:false,
//			cls:'ocb-border-left-lightgrey',
//			flex:3,
//			bodyPadding:5,
//			autoScroll:true,
//			items:panels
//		});
    }
    return this.consequencePanel;
};


SnpInfoWidget.prototype.getPhenotypePanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.phenotypePanel==null){
    	var tpl = this.getPhenotypeTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var pan = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(pan);
    	}
		this.phenotypePanel = Ext.create('Ext.panel.Panel',{
			title:"Phenotype ("+i+")",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.phenotypePanel;
};



SnpInfoWidget.prototype.getPopulationPanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.populationPanel==null){
    	var tpl = this.getPopulationTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var pan = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(pan);
    	}
		this.populationPanel = Ext.create('Ext.panel.Panel',{
			title:"Population ("+i+")",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.populationPanel;
};


SnpInfoWidget.prototype.getData = function (){
	var _this = this;
	this.panel.disable();
	this.panel.setLoading("Getting information...");

    CellBaseManager.get({
        species:this.species,
        category:'feature',
        subCategory:'snp',
        query:this.query,
        resource:"info",
        success:function(data){
            _this.dataReceived(data.response[0].result[0]);
        }
    });

};
SnpInfoWidget.prototype.dataReceived = function (data){
//	var mappedSnps = data[0];
//	for ( var i = 0; i < mappedSnps.length; i++) {
//		if (mappedSnps[i].chromosome == this.feature.chromosome && mappedSnps[i].start == this.feature.start && mappedSnps[i].end == this.feature.end ){
//			this.data=mappedSnps[i];
//			console.log(mappedSnps[i]);
//		}
//	}
    this.data=data;
    console.log(this.data);
	this.optionClick({"text":"Information","leaf":"true"});
	this.panel.enable();
	this.panel.setLoading(false);
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

TFInfoWidget.prototype.draw = InfoWidget.prototype.draw;
TFInfoWidget.prototype.render = InfoWidget.prototype.render;
TFInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
TFInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
TFInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;
TFInfoWidget.prototype.getTranscriptTemplate = InfoWidget.prototype.getTranscriptTemplate;
TFInfoWidget.prototype.getProteinTemplate =InfoWidget.prototype.getProteinTemplate;
TFInfoWidget.prototype.getGeneTemplate = InfoWidget.prototype.getGeneTemplate;
TFInfoWidget.prototype.getPWMTemplate = InfoWidget.prototype.getPWMTemplate;
TFInfoWidget.prototype.getProteinXrefTemplate = InfoWidget.prototype.getProteinXrefTemplate;

function TFInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "Transcription Factor Info";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

TFInfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return dataTypes=[
	            { text: "Information", children: [
	                { text: "Protein"},
	                { text: "Transcript"}, 
	                { text: "Gene"} 
	            ] },
	            { text: "Regulatory", children: [
  	                { text: "PWM"},//position weight matrix (PWM)
  	                { text: "Target Genes"}
  	            ] },
  	            { text: "Protein Features", children: [
  	              { text: "Protein profile"},//position weight matrix (PWM)
  	              { text: "Mutation sites"},
  	              { text: "Pathways"},
  	              { text: "Protein interactions"},
  	              { text: "Related Diseases"}
  	            ] }
	        ];
};
TFInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "Protein":  this.panel.add(this.getProteinPanel(this.data.proteins).show()); break;
			case "Transcript": this.panel.add(this.getTranscriptPanel(this.data.transcripts).show()); break;
			case "Gene": this.panel.add(this.getGenePanel(this.data.gene).show()); break;
			case "PWM": this.panel.add(this.getPWMPanel(this.data.pwm).show()); break;
			case "Target Genes": this.panel.add(this.getTargetGenesGrid(this.data.targetGenes).show()); break;
			case "Protein profile": this.panel.add(this.getProteinFeatureGrid(this.data.protein_feature, "Protein profile").show());  break;
			case "Mutation sites": this.panel.add(this.getProteinFeatureGrid(this.data.protein_feature, "Mutation sites").show());  break;
			case "Pathways": this.panel.add(this.getProteinXrefPanel(this.data.protein_xref, "Pathway").show()); break;
			case "Protein interactions": this.panel.add(this.getProteinXrefPanel(this.data.protein_xref, "Interaction").show()); break;
			case "Related Diseases": this.panel.add(this.getProteinXrefPanel(this.data.protein_xref, "Disease").show()); break;
		}
	}
};

TFInfoWidget.prototype.getProteinPanel = function(data){
	if(data==null){
		return this.notFoundPanel;
	}
    if(this.proteinPanel==null){

    	var tpl = this.getProteinTemplate();

		this.proteinPanel = Ext.create('Ext.panel.Panel',{
			title:"Protein",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:10,
			data:data[0],
			tpl:tpl
		});

    }
    return this.proteinPanel;
};


TFInfoWidget.prototype.getTranscriptPanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.transcriptGrid==null){
    	
    	var tpl = this.getTranscriptTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var transcriptPanel = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(transcriptPanel);
    	}
		this.transcriptGrid = Ext.create('Ext.panel.Panel',{
			title:"Transcripts ("+i+")",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.transcriptGrid;
};

TFInfoWidget.prototype.getGenePanel = function(data){
	if(data==null){
		return this.notFoundPanel;
	}
    if(this.genePanel==null){
    	
    	var tpl = this.getGeneTemplate();
    	
		this.genePanel = Ext.create('Ext.panel.Panel',{
			title:"Gene information",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,
			bodyPadding:10,
			data:data,
			tpl:tpl
		});

    }
    return this.genePanel;
};

TFInfoWidget.prototype.getPWMPanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.pwmPanel==null){
    	var tpl = this.getPWMTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var pwmPan = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(pwmPan);
    	}
		this.pwmPanel = Ext.create('Ext.panel.Panel',{
			title:"PWM ("+i+")",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.pwmPanel;
};

TFInfoWidget.prototype.getTargetGenesGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.targetGenesGrid==null){
//    	console.log(data);
    	
    	var groupField = '';
    	var modelName = "targetGenes";
    	var fields = ['externalName','stableId','biotype','chromosome','start','end','strand','description'];
    	var columns = [
    	               {header : 'Name',dataIndex: 'externalName',flex:1},
    	               {header : 'Stable Id',dataIndex: 'stableId',flex:2},
    	               {header : 'Biotype',dataIndex: 'biotype',flex:1.5},
    	               {header : 'Chr',dataIndex: 'chromosome',flex:0.5},
    	               {header : 'Start',dataIndex: 'start',flex:1},
    	               {header : 'End',dataIndex: 'end',flex:1},
    	               {header : 'Strand',dataIndex: 'strand',flex:0.5},
    	               {header : 'Description',dataIndex: 'description',flex:1}
    	               ];
    	this.targetGenesGrid = this.doGrid(columns,fields,modelName,groupField);
    	this.targetGenesGrid.store.loadData(data);
    }
    return this.targetGenesGrid;
};


TFInfoWidget.prototype.getProteinFeatureGrid = function(data, type){
//	console.log(data.length)
    if(this[type+"Grid"]==null){
//    	console.log(data);
    	
    	//Filtering Mutagenesis
		var notMutaData = new Array();
		var mutaData = new Array();
		for ( var i = 0; i < data.length; i++) {
			if(data[i].type=="mutagenesis site"){
				mutaData.push(data[i]);
			}else{
				notMutaData.push(data[i]);
			}
		}    	
		
    	if(type!=null){
    		if(type=="Protein profile"){
    			var data = notMutaData;
    		}
    		if(type=="Mutation sites"){
    			var data = mutaData;
    		}
    	}
    	if(data.length<=0){
    		return this.notFoundPanel;
    	}
    	
    	var groupField = '';
    	var modelName = type;
    	var fields = ['type','start','end','original','variation','description'];
    	var columns = [
    	               {header : 'Type',dataIndex: 'type',flex:1.5},
    	               {header : 'Start',dataIndex: 'start',flex:0.5},
    	               {header : 'End',dataIndex: 'end',flex:0.5},
    	               {header : 'Original',dataIndex: 'original',flex:0.7},
    	               {header : 'Variation',dataIndex: 'variation',flex:0.7},
    	               {header : 'Description',dataIndex: 'description',flex:3}
    	               ];
    	this[type+"Grid"] = this.doGrid(columns,fields,modelName,groupField);
    	this[type+"Grid"].store.loadData(data);
    }
    return this[type+"Grid"];
};

TFInfoWidget.prototype.getProteinXrefPanel = function(data, type){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this[type+"panel"]==null){
    	var tpl = this.getProteinXrefTemplate();
    	
    	//Filtering Xref
		var pathwayData = new Array();
		var interacData = new Array();
		var diseaseData = new Array();
		
		for ( var i = 0; i < data.length; i++) {
			var src = data[i].source;
			if(src=="Go" || src=="Reactome" || src=="KEGG"){
				pathwayData.push(data[i]);
			}
			if(src=="IntAct" || src=="MINT" || src=="DIP" || src=="String"){
				interacData.push(data[i]);
			}
			if(src=="MIN" || src=="PharmGKB" || src=="Orphanet"){
				diseaseData.push(data[i]);
			}
		}
		
    	if(type!=null){
    		switch(type){
    		case "Pathway":data = pathwayData;break;
    		case "Interaction":data = interacData;break;
    		case "Disease":data = diseaseData;break;
    		}
    	}
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var pan = Ext.create('Ext.panel.Panel',{
		        border:false,
				bodyPadding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(pan);
    	}
    	this[type+"panel"] = Ext.create('Ext.panel.Panel',{
			title:type+" ("+i+")",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this[type+"panel"];
};


TFInfoWidget.prototype.getData = function (){
	var _this = this;
	this.panel.disable();
	this.panel.setLoading("Getting information...");
//	category, subcategory, query, resource, callbackFunction
	var cellBaseDataAdapter = new CellBaseDataAdapter(this.species);
	cellBaseDataAdapter.successed.addEventListener(function (evt){
		_this.dataReceived(cellBaseDataAdapter.toJSON());
	});
	cellBaseDataAdapter.fill("regulatory","tf", this.feature.getName(), "fullinfo");
	console.log(this.feature.getName());
};
TFInfoWidget.prototype.dataReceived = function (data){
	var parseData = JSON.parse(data);
	this.data=parseData[0];
	console.log(this.data);
	this.optionClick({"text":"Protein","leaf":"true"});
	this.panel.enable();
	this.panel.setLoading(false);
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

TranscriptInfoWidget.prototype.draw = InfoWidget.prototype.draw;
TranscriptInfoWidget.prototype.render = InfoWidget.prototype.render;
TranscriptInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
TranscriptInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
TranscriptInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;
TranscriptInfoWidget.prototype.getGeneTemplate = InfoWidget.prototype.getGeneTemplate;
TranscriptInfoWidget.prototype.getTranscriptTemplate = InfoWidget.prototype.getTranscriptTemplate;
TranscriptInfoWidget.prototype.getExonTemplate = InfoWidget.prototype.getExonTemplate;
//shared with gene
TranscriptInfoWidget.prototype.get3Dprotein = GeneInfoWidget.prototype.get3Dprotein;
TranscriptInfoWidget.prototype.getGenePanel = GeneInfoWidget.prototype.getGenePanel;
TranscriptInfoWidget.prototype.getXrefGrid = GeneInfoWidget.prototype.getXrefGrid;
TranscriptInfoWidget.prototype.getTfbsGrid = GeneInfoWidget.prototype.getTfbsGrid;
TranscriptInfoWidget.prototype.getMirnaTargetGrid = GeneInfoWidget.prototype.getMirnaTargetGrid;
TranscriptInfoWidget.prototype.getProteinFeaturesGrid = GeneInfoWidget.prototype.getProteinFeaturesGrid;

function TranscriptInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "Transcript";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

TranscriptInfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return dataTypes=[
	            { text: "Genomic", children: [
	                 { text: "Information"},
	                 { text: "Gene"},
	                 { text: "Exons"},
	                 { text: "Xrefs"}
	            ] },
	            { text: "Functional information", children: [
	                  { text: "GO"},
	                  { text: "Reactome"},
	                  { text: "Interpro"}
	            ] },
	            { text: "Variation", children: [
	                  { text: "SNPs"},
	                  { text: "Mutations"}
	            ] },
	            { text: "Regulatory", children: [
	                  { text: "TFBS"},
	                  { text: "miRNA targets"}                   
	            ]},
	            { text:"Protein", children: [
	                  { text: "Features"},//protein profile
	                  { text: "3D structure"}
	            ]}	            
	        ];
};
TranscriptInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "Information": this.panel.add(this.getInfoPanel(this.data).show()); break;
			case "Gene": this.panel.add(this.getGenePanel(this.data.gene).show());  break;
			case "Exons": this.panel.add(this.getExonsGrid(this.data.exons).show());  break;
			case "Xrefs": this.panel.add(this.getXrefGrid([this.data], "Xref", 'dbName').show());  break;
			case "GO": this.panel.add(this.getXrefGrid([this.data], "GO").show());  break;
			case "Interpro": this.panel.add(this.getXrefGrid([this.data], "Interpro").show());  break;
			case "Reactome": this.panel.add(this.getXrefGrid([this.data], "Reactome").show());  break;
			case "SNPs": this.panel.add(this.getSnpsGrid(this.data.snps).show());  break;
			case "Mutations": this.panel.add(this.getMutationsGrid(this.data.mutations).show());  break;
			case "TFBS": this.panel.add(this.getTfbsGrid(this.data.tfbs).show());  break;
			case "miRNA targets": this.panel.add(this.getMirnaTargetGrid(this.data.mirnaTargets).show());  break;
			case "Features": this.panel.add(this.getProteinFeaturesGrid(this.data.proteinFeatures).show());  break;
			case "3D structure": this.panel.add(this.get3Dprotein(this.data.snps).show());  break;
		}
	}
};

TranscriptInfoWidget.prototype.getInfoPanel = function(data){
	if(data==null){
		return this.notFoundPanel;
	}
	if(this.infoPanel==null){
		
    	var tpl = this.getTranscriptTemplate();
    	
		this.infoPanel = Ext.create('Ext.panel.Panel',{
			title:"Information",
			border:false,
			cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:10,
			autoScroll:true,
			data:data,//para el template
			tpl:tpl
		});
	}
	return this.infoPanel;
};


TranscriptInfoWidget.prototype.getExonsGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.exonsGrid==null){

    	var tpl = this.getExonTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var exonPanel = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(exonPanel);
    	}
		this.exonsGrid = Ext.create('Ext.panel.Panel',{
			title:"Exons ("+i+")",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.exonsGrid;
};



//TODO hay muchos y tarda
TranscriptInfoWidget.prototype.getSnpsGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.snpsGrid==null){
    	var groupField = '';
    	var modelName = 'SNPs';
	    var fields = ['chromosome','start','end','name',"strand","alleleString","displaySoConsequence"];
		var columns = [
		               	{header : 'Name',dataIndex: 'name',flex:2},
		               	{header : 'Location: chr:start-end (strand)', xtype:'templatecolumn', tpl:'{chromosome}:{start}-{end} ({strand})',flex:2},
						{header : 'Alleles',dataIndex: 'alleleString',flex:0.7},
						{header : 'Most severe SO term',dataIndex: 'displaySoConsequence',flex:2}
		             ];
		this.snpsGrid = this.doGrid(columns,fields,modelName,groupField);
		this.snpsGrid.store.loadData(data);
    }
    return this.snpsGrid;
};

TranscriptInfoWidget.prototype.getMutationsGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.mutationsGrid==null){
    	var groupField = '';
    	var modelName = 'Mutations';
	    var fields = ["chromosome","start","end","mutationAa","mutationCds","primaryHistology","source"];
		var columns = [
		                {header : 'Mutation AA',dataIndex: 'mutationAa',flex:1},
		               	{header : 'Mutation CDS',dataIndex: 'mutationCds',flex:1.5},
		               	{header : 'Location: chr:start-end', xtype:'templatecolumn', tpl:'{chromosome}:{start}-{end}',flex:1.7},
						{header : 'Primary histology',dataIndex: 'primaryHistology',flex:1},
						{header : 'Source',dataIndex: 'source',flex:1}
		             ];
		this.mutationsGrid = this.doGrid(columns,fields,modelName,groupField);
		this.mutationsGrid.store.loadData(data);
    }
    return this.mutationsGrid;
};


TranscriptInfoWidget.prototype.getData = function (){
    debugger
	var _this = this;
	this.panel.disable();
	this.panel.setLoading("Getting information...");
//	category, subcategory, query, resource, callbackFunction

    CellBaseManager.get({
        species:this.species,
        category:'feature',
        subCategory:'transcript',
        query:this.query,
        resource:"info",
        success:function(data){
            _this.dataReceived(data.response[0].result[0].transcripts);
        }
    });

};
TranscriptInfoWidget.prototype.dataReceived = function (data){
	this.data=data;
	console.log(this.data);
	this.optionClick({"text":"Information","leaf":"true"});
	this.panel.enable();
	this.panel.setLoading(false);
};




/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

TranscriptOrangeInfoWidget.prototype.draw = InfoWidget.prototype.draw;
TranscriptOrangeInfoWidget.prototype.render = InfoWidget.prototype.render;
TranscriptOrangeInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
TranscriptOrangeInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
TranscriptOrangeInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;
TranscriptOrangeInfoWidget.prototype.getGeneTemplate = InfoWidget.prototype.getGeneTemplate;
TranscriptOrangeInfoWidget.prototype.getTranscriptTemplate = InfoWidget.prototype.getTranscriptTemplate;
TranscriptOrangeInfoWidget.prototype.getExonTemplate = InfoWidget.prototype.getExonTemplate;
//shared with gene
//TranscriptOrangeInfoWidget.prototype.get3Dprotein = GeneInfoWidget.prototype.get3Dprotein;
TranscriptOrangeInfoWidget.prototype.getGenePanel = GeneOrangeInfoWidget.prototype.getGenePanel;
TranscriptOrangeInfoWidget.prototype.getXrefGrid = GeneOrangeInfoWidget.prototype.getXrefGrid;
//TranscriptOrangeInfoWidget.prototype.getTfbsGrid = GeneOrangeInfoWidget.prototype.getTfbsGrid;
//TranscriptOrangeInfoWidget.prototype.getMirnaTargetGrid = GeneOrangeInfoWidget.prototype.getMirnaTargetGrid;
//TranscriptOrangeInfoWidget.prototype.getProteinFeaturesGrid = GeneInfoWidget.prototype.getProteinFeaturesGrid;

function TranscriptOrangeInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "Transcript";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

TranscriptOrangeInfoWidget.prototype.getdataTypes = function (){
	//Abstract method
	return dataTypes=[
	            { text: "Genomic", children: [
	                 { text: "Information"},
	                 { text: "Gene"},
	                 { text: "Exons"}
	            ] },
	            { text: "Functional information", children: [
	                  { text: "GO"},
	                  { text: "KEGG"},
	                  { text: "Interpro"}
	            ] }	            
	        ];
};
TranscriptOrangeInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "Information": this.panel.add(this.getInfoPanel(this.data).show()); break;
			case "Gene": this.panel.add(this.getGenePanel(this.data.gene).show());  break;
			case "Exons": this.panel.add(this.getExonsGrid(this.data.exons).show());  break;
			case "GO": this.panel.add(this.getXrefGrid(this.data.go, "GO").show());  break;
			case "Interpro": this.panel.add(this.getXrefGrid(this.data.interpro, "Interpro").show());  break;
			case "KEGG": this.panel.add(this.getXrefGrid(this.data.kegg, "KEGG").show());  break;
//			case "SNPs": this.panel.add(this.getSnpsGrid(this.data.snps).show());  break;
//			case "Mutations": this.panel.add(this.getMutationsGrid(this.data.mutations).show());  break;
//			case "TFBS": this.panel.add(this.getTfbsGrid(this.data.tfbs).show());  break;
//			case "miRNA targets": this.panel.add(this.getMirnaTargetGrid(this.data.mirnaTargets).show());  break;
//			case "Features": this.panel.add(this.getProteinFeaturesGrid(this.data.proteinFeatures).show());  break;
//			case "3D structure": this.panel.add(this.get3Dprotein(this.data.snps).show());  break;
		}
	}
};

TranscriptOrangeInfoWidget.prototype.getInfoPanel = function(data){
	if(data==null){
		return this.notFoundPanel;
	}
	if(this.infoPanel==null){
		
    	var tpl = this.getTranscriptTemplate();
    	
		this.infoPanel = Ext.create('Ext.panel.Panel',{
			title:"Information",
			border:false,
			cls:'panel-border-left',
			flex:3,    
			bodyPadding:10,
			autoScroll:true,
			data:data,//para el template
			tpl:tpl
		});
	}
	return this.infoPanel;
};


TranscriptOrangeInfoWidget.prototype.getExonsGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.exonsGrid==null){

    	var tpl = this.getExonTemplate();
    	
    	var panels = [];
    	for ( var i = 0; i < data.length; i++) {	
			var exonPanel = Ext.create('Ext.container.Container',{
				padding:5,
				data:data[i],
				tpl:tpl
			});
			panels.push(exonPanel);
    	}
		this.exonsGrid = Ext.create('Ext.panel.Panel',{
			title:"Exons ("+i+")",
	        border:false,
	        cls:'panel-border-left',
			flex:3,
			bodyPadding:5,
			autoScroll:true,
			items:panels
		});
    }
    return this.exonsGrid;
};



//TODO hay muchos y tarda
TranscriptOrangeInfoWidget.prototype.getSnpsGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.snpsGrid==null){
    	var groupField = '';
    	var modelName = 'SNPs';
	    var fields = ['chromosome','start','end','name',"strand","alleleString","displaySoConsequence"];
		var columns = [
		               	{header : 'Name',dataIndex: 'name',flex:2},
		               	{header : 'Location: chr:start-end (strand)', xtype:'templatecolumn', tpl:'{chromosome}:{start}-{end} ({strand})',flex:2},
						{header : 'Alleles',dataIndex: 'alleleString',flex:0.7},
						{header : 'Most severe SO term',dataIndex: 'displaySoConsequence',flex:2}
		             ];
		this.snpsGrid = this.doGrid(columns,fields,modelName,groupField);
		this.snpsGrid.store.loadData(data);
    }
    return this.snpsGrid;
};

TranscriptOrangeInfoWidget.prototype.getMutationsGrid = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
    if(this.mutationsGrid==null){
    	var groupField = '';
    	var modelName = 'Mutations';
	    var fields = ["chromosome","start","end","mutationAa","mutationCds","primaryHistology","source"];
		var columns = [
		                {header : 'Mutation AA',dataIndex: 'mutationAa',flex:1},
		               	{header : 'Mutation CDS',dataIndex: 'mutationCds',flex:1.5},
		               	{header : 'Location: chr:start-end', xtype:'templatecolumn', tpl:'{chromosome}:{start}-{end}',flex:1.7},
						{header : 'Primary histology',dataIndex: 'primaryHistology',flex:1},
						{header : 'Source',dataIndex: 'source',flex:1}
		             ];
		this.mutationsGrid = this.doGrid(columns,fields,modelName,groupField);
		this.mutationsGrid.store.loadData(data);
    }
    return this.mutationsGrid;
};


TranscriptOrangeInfoWidget.prototype.getData = function (){
	var _this = this;
	this.panel.disable();
	this.panel.setLoading("Getting information...");
//	category, subcategory, query, resource, callbackFunction
	
	var cellBaseManager = new CellBaseManager(this.species);
	cellBaseManager.success.addEventListener(function(sender,data){
		_this.dataReceived(JSON.parse(data.result));//TODO
	});
	cellBaseManager.get("feature","transcript", this.query, "fullinfo");
};
TranscriptOrangeInfoWidget.prototype.dataReceived = function (data){
	this.data=data[0];
	console.log(this.data);
	this.optionClick({"text":"Information","leaf":"true"});
	this.panel.enable();
	this.panel.setLoading(false);
};




/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

VCFVariantInfoWidget.prototype.draw = InfoWidget.prototype.draw;
VCFVariantInfoWidget.prototype.render = InfoWidget.prototype.render;
VCFVariantInfoWidget.prototype.getTreePanel = InfoWidget.prototype.getTreePanel;
VCFVariantInfoWidget.prototype.checkDataTypes = InfoWidget.prototype.checkDataTypes;
VCFVariantInfoWidget.prototype.doGrid = InfoWidget.prototype.doGrid;
VCFVariantInfoWidget.prototype.getVCFVariantTemplate = InfoWidget.prototype.getVCFVariantTemplate;
VCFVariantInfoWidget.prototype.getVariantEffectTemplate = InfoWidget.prototype.getVariantEffectTemplate;

function VCFVariantInfoWidget(targetId, species, args){
	if (args == null){
		args = new Object();
	}
	args.title = "VCF variant Info";
	InfoWidget.prototype.constructor.call(this, targetId, species, args);
};

VCFVariantInfoWidget.prototype.getdataTypes = function (){
	return dataTypes=[
	            { text: "Genomic", children: [
	                { text: "Information"},
	                { text: "Variant effect"},
	                { text: "Header"},
	                { text: "Samples"}
	            ] }
	        ];
};
VCFVariantInfoWidget.prototype.optionClick = function (item){
	//Abstract method
	if (item.leaf){
		if(this.panel.getComponent(1)!=null){
			this.panel.getComponent(1).hide();
			this.panel.remove(1,false);
		}
		switch (item.text){
			case "Information":  this.panel.add(this.getInfoPanel(this.data.feature).show()); break;
			case "Variant effect":this.panel.add(this.getEffectPanel(this.data.consequenceType).show()); break;
			case "Header":this.panel.add(this.getHeaderPanel(this.data.header).show()); break;
			case "Samples":this.panel.add(this.getSamplesGrid(this.data.feature.sampleData,this.data.samples,this.data.feature.format).show()); break;
			case "Population": break;
		}
	}
};

VCFVariantInfoWidget.prototype.getInfoPanel = function(data){
	if(data==null){
		return this.notFoundPanel;
	}
    if(this.infoPanel==null){

    	var tpl = this.getVCFVariantTemplate();

		this.infoPanel = Ext.create('Ext.panel.Panel',{
			title:"Information",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:10,
			data:data,
			tpl:tpl
		});

    }
    return this.infoPanel;
};

VCFVariantInfoWidget.prototype.getEffectPanel = function(data){
	if(data.length<=0){
		return this.notFoundPanel;
	}
	for ( var i = 0; i < data.length; i++) {
		data[i].consequence = data[i].consequenceType+" - "+data[i].consequenceTypeObo;
		if(data[i].featureName == ""){data[i].featureName="-";}
		if(data[i].geneId == ""){data[i].geneId="-";}
		if(data[i].transcriptId == ""){data[i].transcriptId="-";}
		if(data[i].featureBiotype == ""){data[i].featureBiotype="-";}
		if(data[i].aaPosition == ""){data[i].aaPosition="-";}
		if(data[i].aminoacidChange == ""){data[i].aminoacidChange="-";}

	}

    if(this.effectGrid==null){
    	var groupField = 'consequence';
    	var modelName = "effectGridModel";
    	var fields = ['featureName','geneId','transcriptId','featureBiotype','aaPosition','aminoacidChange','consequence'];
    	var columns = [
    	               {header : 'Feature',dataIndex: 'featureName',flex:1},
    	               {header : 'Gene Id',dataIndex: 'geneId',flex:1.5},
    	               {header : 'Transcript Id',dataIndex: 'transcriptId',flex:1.5},
    	               {header : 'Feat.Biotype',dataIndex: 'featureBiotype',flex:1},
    	               {header : 'aa Position',dataIndex: 'aaPosition',flex:1},
    	               {header : 'aa Change',dataIndex: 'aminoacidChange',flex:1}
    	               ];
    	this.effectGrid = this.doGrid(columns,fields,modelName,groupField);
    	this.effectGrid.store.loadData(data);
    }
    return this.effectGrid;
	
//    if(this.effectPanel==null){
//    	var tpl = this.getVariantEffectTemplate();
//    	//sort by consequenceTypeObo
//    	data.sort(function(a,b){
//    		if(a.consequenceTypeObo == b.consequenceTypeObo){return 0;}
//    		return (a.consequenceTypeObo < b.consequenceTypeObo) ? -1 : 1;
//    	});
//    	
//    	
//    	var panels = [];
//    	for ( var i = 0; i < data.length; i++) {
//			var transcriptPanel = Ext.create('Ext.container.Container',{
//				padding:5,
//				data:data[i],
//				tpl:tpl
//			});
//			panels.push(transcriptPanel);
//    	}
//		this.effectPanel = Ext.create('Ext.panel.Panel',{
//			title:"Effects ("+i+")",
//			border:false,
//			cls:'ocb-border-left-lightgrey',
//			flex:3,    
//			bodyPadding:5,
//			autoScroll:true,
//			items:panels
//		});
//    }
//    return this.effectPanel;
};

VCFVariantInfoWidget.prototype.getHeaderPanel = function(data){
	if(data==""){
		return this.notFoundPanel;
	}
    if(this.headerPanel==null){

		this.headerPanel = Ext.create('Ext.panel.Panel',{
			title:"Information",
	        border:false,
	        cls:'ocb-border-left-lightgrey',
			flex:3,    
			bodyPadding:10,
			html:data
		});

    }
    return this.headerPanel;
};

VCFVariantInfoWidget.prototype.getSamplesGrid = function(samplesData,samples,format){
	var sData = samplesData.split("\t").slice(9);
	if(sData.length<=0){
		return this.notFoundPanel;
	}
	var data = new Array(samples.length);
	for ( var i = 0, li = data.length; i < li; i++) {
		data[i] = {id:samples[i],info:sData[i]};
	}
	
    if(this.samplesGrid==null){
    	var groupField = '';
    	var modelName = 'VCF samples';
	    var fields = ["id","info"];
		var columns = [
		                {header : 'Identifier',dataIndex: 'id',flex:1},
		                {header : format,dataIndex: 'info',flex:5}
		             ];
		this.samplesGrid = this.doGrid(columns,fields,modelName,groupField);
		this.samplesGrid.store.loadData(data);
    }
    return this.samplesGrid;
};

VCFVariantInfoWidget.prototype.getData = function (){
	var _this = this;
	this.panel.disable();
	this.panel.setLoading("Getting information...");
	var query = this.feature.chromosome+":"+this.feature.start+":"+this.feature.reference+":"+this.feature.alternate;
    CellBaseManager.get({
        host : 'http://ws-beta.bioinfo.cipf.es/cellbase/rest',
        version : 'v2',
        species:Utils.getSpeciesCode(this.species.text).substring(0,3),
        category:'genomic',
        subCategory:'variant',
        query:query,
        resource:'consequence_type',
        success:function(data){
            _this.dataReceived(data);
        }
    });
};

VCFVariantInfoWidget.prototype.dataReceived = function (data){
    debugger
	this.data = new Object();
	this.data["header"] = this.adapter.header;
	this.data["samples"] = this.adapter.samples;
	this.data["feature"] = this.feature;
	this.data["consequenceType"] = data;
	this.optionClick({"text":"Information","leaf":"true"});
	this.panel.enable();
	this.panel.setLoading(false);
};

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function ConsequenceTypeFilterFormPanel(args) {
    _.extend(this, Backbone.Events);

    //set default args
    this.id = Utils.genId("ConsequenceTypeFilterFormPanel");
    this.target;
    this.height = 400;
    this.title = "Consequence Type";
    this.border = false;
    this.autoRender = true;
    this.collapsible = true;
    this.titleCollapse = false;
    this.collapsed = false;
    this.headerConfig;
    this.consequenceTypes = [];
    this.fields = [
        {name: 'name', type: 'string'},
        {name: 'acc', type: 'string'}
    ];
    this.columns = [
        {
            xtype: 'treecolumn',
            flex: 2,
            sortable: false,
            dataIndex: 'name',
            tooltipType: 'qtip'
        },
        {
            text: '',
            flex: 1,
            dataIndex: 'acc',
            renderer: function (value, meta, record) {
                var link = "http://www.sequenceontology.org/miso/current_release/term/" + value;
                return ' <a href=' + link + ' target="_blank">' + value + '</a>';
            }

        }
    ];

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }

}

ConsequenceTypeFilterFormPanel.prototype = {
    render: function () {
        var _this = this;
        console.log("Initializing " + this.id);

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();
    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.panel.render(this.div);
    },
    clear: function () {
        var node = this.panel.getRootNode();
        node.cascadeBy(function (n) {
            n.set('checked', false);
        });
    },
    getValues: function () {
        var node = this.panel.getRootNode();
        var consequence_types = [];
        node.cascadeBy(function (n) {
            if (n.get('checked') && n.isLeaf()) {
                consequence_types.push(n.get('name'));
            }
        });
        if (consequence_types.length > 0) {
            return {conseq_type: consequence_types};
        } else {
            return {};
        }
    },
    _createPanel: function () {

        Ext.define('Tree Model', {
            extend: 'Ext.data.Model',
            fields: this.fields
        });

        var store = Ext.create('Ext.data.TreeStore', {
            model: 'Tree Model',
            proxy: {
                type: 'memory',
                data: this.consequenceTypes,
                reader: {
                    type: 'json'
                }
            }
        });

        var treePanel = Ext.create('Ext.tree.Panel', {
            title: this.title,
            border: this.border,
            useArrows: true,
            rootVisible: false,
            store: store,
            multiSelect: true,
            singleExpand: true,
            hideHeaders: true,
            height: this.height,
            collapsible: this.collapsible,
            titleCollapse: this.titleCollapse,
            collapsed: this.collapsed,
            header: this.headerConfig,
            columns: this.columns,
            listeners: {
                'checkchange': function (node, checked) {
                    node.cascadeBy(function (n) {
                        n.set('checked', checked);
                    });
                }
            }
        });

        return treePanel;
    },
    getPanel: function () {
        return this.panel;
    }
}

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function FormPanel(args) {
    _.extend(this, Backbone.Events);

    //set default args
    this.id = Utils.genId("FormPanel");
    this.target;
    this.autoRender = true;
    this.height;
    this.width;
    this.title;
    this.collapsible = false;
    this.titleCollapse = false;
    this.submitButtonId = 'submit-btn';
    this.submitButtonText = 'Search';
    this.clearButtonText = 'Clear';
    this.barItems = [];
    this.border = true;
    this.filters = [];
    this.mode = 'accordion';
    this.toolbarPosition = 'top';
    this.headerConfig;

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }
}

FormPanel.prototype = {
    render: function () {
        var _this = this;
        console.log("Initializing " + this.id);

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        var filters = [];

        for (var i = 0; i < this.filters.length; i++) {
            var filter = this.filters[i];
            filters.push(filter.getPanel());
        }

        this.panel = this._createPanel();
        this.filtersPanel.add(filters);
        if (this.mode == 'tabs') {
            this.filtersPanel.setActiveTab(0);
        }

    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.panel.render(this.div);

    },
    clear: function () {
        for (var i = 0; i < this.filters.length; i++) {
            var filter = this.filters[i];
            filter.clear();
        }
    },
    getValues: function () {
        var values = {};
        for (var i = 0; i < this.filters.length; i++) {
            var filter = this.filters[i];
            _.extend(values, filter.getValues());
        }
        return values;
    },
    update: function () {
        if (this.panel) {
            this.panel.update();
        }
    },
    _createPanel: function () {
        var _this = this;

        var barItems = [
            {
                xtype: 'button',
                text: this.clearButtonText,
                tooltip: this.clearButtonText,
                handler: function () {
                    _this.clear();
                    Utils.msg('Clear', 'Successful');
                }
            },
            {
                xtype: 'button',
                id:this.submitButtonId,
                text: this.submitButtonText,
                tooltip: this.submitButtonText,
                formBind: true,
                flex:1,
                handler: function () {
                    _this.trigger('submit', {values: _this.getValues(), sender: _this});
//                            console.log(values);
//
//                            for (var i = 0; i < _this.filters.length; i++) {
//                                var filter = _this.filters[i];
//                                var form = filter.filter.getForm();
//                                _.extend(values, form);
//
//                            }

                }
            }
        ];
        barItems = barItems.concat(this.barItems);


        var pan;
        switch (this.mode) {
            case 'tabs':
                this.filtersPanel = Ext.create('Ext.tab.Panel', {
                    border: false,
                    plain: true
                });
                break;
            case 'accordion':
                this.filtersPanel = Ext.create('Ext.container.Container', {
                    layout: {
                        type: 'accordion',
                        titleCollapse: true,
                        multi: true
                    }
                });
                break;
            case 'vbox':
                this.filtersPanel = Ext.create('Ext.container.Container', {
                    margin: '5 0 0 0',
                    layout: {
                        type: 'vbox',
                        align: 'stretch'
                    },
                    defaults: {
                        margin: '5 0 0 0'
                    }
                });
                break;
        }

        var form = Ext.create('Ext.form.Panel', {
            border: this.border,
            height: this.height,
            width: this.width,
            title: this.title,
            header: this.headerConfig,
            collapsible: this.collapsible,
            titleCollapse: this.titleCollapse,
            margin: '0 20 0 0',
            autoScroll: true,
            items: [
                {
                    xtype: 'container',
                    width: '100%',
                    bodyPadding: 5,
                    defaults: {
                        margin: '10'
                    },
                    layout: {
                        type: 'hbox'
                    },
                    items: barItems
                },
                this.filtersPanel
            ]
//            dockedItems: [
//                {
//                    xtype: 'toolbar',
//                    dock: this.toolbarPosition,
//                    width: '100%',
//                    height: 45,
////                border:false,
//                    items: barItems
//                }
//            ]
        });
        return form;

    }
}

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function GoFilterFormPanel(args) {
    _.extend(this, Backbone.Events);

    //set default args
    this.id = Utils.genId("GoFilterFormPanel");
    this.target;
    this.autoRender = true;
    this.title = "Go";
    this.border = false;
    this.collapsible = true;
    this.titleCollapse = false;
    this.headerConfig;
    this.testRegion = "";

    this.fields = [
        {name: 'name', type: 'string'},
        {name: 'acc', type: 'string'}
    ];

    this.columns = [
        {
            xtype: 'treecolumn',
            flex: 2,
            sortable: false,
            dataIndex: 'name',
            tooltipType: 'qtip'
        },
        {
            text: '',
            flex: 1,
            dataIndex: 'acc'
//            renderer: function (value, meta, record) {
//                var link = "http://www.sequenceontology.org/miso/current_release/term/" + value;
//                return ' <a href=' + link + ' target="_blank">' + value + '</a>';
//            }

        }
    ];
    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }
}

GoFilterFormPanel.prototype = {
    render: function () {
        var _this = this;
        console.log("Initializing " + this.id);

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();
    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.panel.render(this.div);
    },
    _createPanel: function () {

//        Ext.define('Tree Model', {
//            extend: 'Ext.data.Model',
//            fields: this.fields
//        });
//        var store = Ext.create('Ext.data.TreeStore', {
//            root: {
//                expanded: true,
//                children: [
//                    { text: "SLC10A5", leaf: true, checked: false },
//                    { text: "UTP6", expanded: true, checked: false, children: [
//                        { text: "CALR3", leaf: true, checked: false },
//                        { text: "RDH8", leaf: true, checked: false}
//                    ] },
//                    { text: "NOTCH4", leaf: true, checked: false }
//                ]
//            }
//        });
//
//        var treePanel = Ext.create('Ext.tree.Panel', {
//            title: this.title,
//            border: this.border,
//            useArrows: true,
//            rootVisible: false,
//            store: store,
//            multiSelect: true,
//            singleExpand: true,
//            hideHeaders: true,
//            height: this.height,
//            collapsible: this.collapsible,
//            titleCollapse: this.titleCollapse,
//            collapsed: this.collapsed,
//            header: this.headerConfig,
//            //columns: this.columns,
//            listeners: {
//                'checkchange': function (node, checked) {
//                    node.cascadeBy(function (n) {
//                        n.set('checked', checked);
//                    });
//                }
//            }
//        });
//
//        return treePanel;
        var goField = Ext.create('Ext.form.field.TextArea', {
            id: this.id + "go",
            name: "go",
            margin: '0 0 0 5',
            //allowBlank: true,
            width: '100%',
            fieldLabel: 'Go Term',
            labelAlign: 'top'
        });

        return Ext.create('Ext.form.Panel', {
            bodyPadding: "5",
            margin: "0 0 5 0",
            buttonAlign: 'center',
            layout: 'vbox',
            title: this.title,
            border: this.border,
            collapsible: this.collapsible,
            titleCollapse: this.titleCollapse,
            header: this.headerConfig,
            allowBlank: false,
            items: goField
        });
    },
    getPanel: function () {
        return this.panel;
    },
    getValues: function () {
//        var node = this.panel.getRootNode();
//        var go_selection = [];
//        node.cascadeBy(function (n) {
//            if (n.get('checked') && n.isLeaf()) {
//                go_selection.push(n.get('text'));
//            }
//        });
//        debugger
//        if (go_selection.length > 0) {
//            return {genes: go_selection};
//        } else {
//            return {};
//        }
        var values = this.panel.getValues();
        for (key in values) {
            if (values[key] == '') {
                delete values[key]
            }
        }
        return values;
    },
    clear: function () {
        this.panel.reset();
    }
}

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function MafFilterFormPanel(args) {
    _.extend(this, Backbone.Events);

    //set default args
    this.id = Utils.genId("MafFilterFormPanel");
    this.target;
    this.autoRender = true;
    this.title = "MAF";
    this.border = false;
    this.collapsible = true;
    this.titleCollapse = false;
    this.headerConfig;
    this.testRegion = "";

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }
}

MafFilterFormPanel.prototype = {
    render: function () {
        var _this = this;
        console.log("Initializing " + this.id);

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();
    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.panel.render(this.div);
    },
    _createPanel: function () {


        var thousandContainer = Ext.create('Ext.form.FieldContainer', {
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            items: [
                {
                    xtype: 'textfield',
                    labelAlign: 'right',
                    fieldLabel: '1000G MAF < ',
                    name: 'maf_1000g_controls',
                    labelWidth: 110
                },
                {
                    xtype: 'textfield',
                    labelAlign: 'right',
                    fieldLabel: 'EVS MAF < ',
                    labelWidth: 110,
                    name: 'maf_evs_controls'

                }
            ]
        });

        var populationsContainer = Ext.create('Ext.form.FieldContainer', {
//            fieldLabel: '<span style="color:gray">1000G Populations</span>',
//            labelAlign: 'top',
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            items: [
                {
                    xtype: 'box',
                    margin:'0 20 0 0',
                    html: '<span style="color:gray">1000G Populations</span>'
                },
                {
                    xtype: 'textfield',
                    labelAlign: 'right',
                    fieldLabel: 'African MAF < ',
                    labelWidth: 110,
                    name: 'maf_1000g_afr_controls'
                },
                {
                    xtype: 'textfield',
                    labelAlign: 'right',
                    fieldLabel: 'American MAF < ',
                    labelWidth: 110,
                    name: 'maf_1000g_ame_controls'
                },
                {
                    xtype: 'textfield',
                    labelAlign: 'right',
                    fieldLabel: 'Asian MAF < ',
                    labelWidth: 110,
                    name: 'maf_1000g_asi_controls'
                },
                {
                    xtype: 'textfield',
                    labelAlign: 'right',
                    fieldLabel: 'European MAF < ',
                    labelWidth: 110,
                    name: 'maf_1000g_eur_controls'
                }
            ]
        });

        return Ext.create('Ext.form.Panel', {
            title: this.title,
            border: this.border,
            collapsible: this.collapsible,
            titleCollapse: this.titleCollapse,
            header: this.headerConfig,
            bodyPadding: 5,
            margin: "0 0 5 0",
            buttonAlign: 'center',
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            allowBlank: false,
            items: [thousandContainer, populationsContainer ]
        });

    },
    getPanel: function () {
        return this.panel;
    },
    getValues: function () {
        var values = this.panel.getValues();
        for (key in values) {
            if (values[key] == '') {
                delete values[key]
            }
        }
        return values;
    },
    clear: function () {
        this.panel.reset();
    }
}

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function PositionFilterFormPanel(args) {
    _.extend(this, Backbone.Events);

    //set default args
    this.id = Utils.genId("PositionFilterFormPanel");
    this.target;
    this.autoRender = true;
    this.title = "Position";
    this.border = false;
    this.collapsible = true;
    this.titleCollapse = false;
    this.headerConfig;
    this.testRegion = "";
    this.emptyText = '1:1-1000000,2:1-1000000';

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }
}

PositionFilterFormPanel.prototype = {
    render: function () {
        var _this = this;
        console.log("Initializing " + this.id);

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();
    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.panel.render(this.div);
    },
    _createPanel: function () {
        var snp = Ext.create('Ext.form.field.TextArea', {
            id: this.id + "snp",
            name: "snp",
            margin: '0 0 0 5',
            //allowBlank: true,
            width: '100%',
            fieldLabel: 'SNP id',
            labelAlign: 'top',
            regex: /^[rs]s\d+$/
        });

        var regionList = Ext.create('Ext.form.field.TextArea', {
            id: this.id + "region",
            name: "region",
            emptyText:  this.emptyText,
            margin: '0 0 0 5',
            //allowBlank: true,
            width: '100%',
            fieldLabel: 'Chromosomal Location',
            labelAlign: 'top',
            value: this.testRegion
        });

        var gene = Ext.create('Ext.form.field.TextArea', {
            id: this.id + "gene",
            name: "gene",
            margin: '0 0 0 5',
            //allowBlank: true,
            width: '100%',
            fieldLabel: 'Gene / Transcript',
            labelAlign: 'top'
        });

        return Ext.create('Ext.form.Panel', {
            bodyPadding: "5",
            margin: "0 0 5 0",
            buttonAlign: 'center',
            layout: 'vbox',
            title: this.title,
            border: this.border,
            collapsible: this.collapsible,
            titleCollapse: this.titleCollapse,
            header: this.headerConfig,
            allowBlank: false,
            items: [snp, regionList, gene]
        });

    },
    getPanel: function () {
        return this.panel;
    },
    getValues: function () {
        var values = this.panel.getValues();
        for (key in values) {
            if (values[key] == '') {
                delete values[key]
            }
        }
        return values;
    },
    clear: function () {
        this.panel.reset();
    }
}

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function SegregationFilterFormPanel(args) {
    _.extend(this, Backbone.Events);

    //set default args
    this.id = Utils.genId("SegregationFilterFormPanel");
    this.target;
    this.autoRender = true;
    this.title = "Segregation";
    this.border = false;
    this.collapsible = true;
    this.titleCollapse = false;
    this.headerConfig;
    this.testRegion = "";

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }
}

SegregationFilterFormPanel.prototype = {
    render: function () {
        var _this = this;
        console.log("Initializing " + this.id);

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();
    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.panel.render(this.div);
    },
    _createPanel: function () {


        var header = Ext.create('Ext.form.FieldContainer', {
            margin: '0 0 0 100',
            flex: 1,
            layout: {
                type: 'hbox',
                align: 'stretch'
            },
            items: [
                { xtype: 'label', text: '0/0', flex: 1},
                { xtype: 'label', text: '0/1', flex: 1},
                { xtype: 'label', text: '1/1', flex: 1},
                { xtype: 'label', text: './.', flex: 1},
            ]
        });

        var items = [header];

        for (var i = 0; i < this.samples.length; i++) {
            var name = this.samples[i];

            items.push(
                Ext.create('Ext.form.FieldContainer', {
                    fieldLabel: name,
                    labelWidth: 100,
                    flex: 1,
                    layout: {
                        type: 'hbox',
                        align: 'stretch'
                    },
                    items: [
                        {xtype: 'checkbox', name: "sampleGT_" + name, inputValue: '0/0,0|0', flex: 1},
                        {xtype: 'checkbox', name: "sampleGT_" + name, inputValue: '0/1,1/0,0|1,1|0', flex: 1},
                        {xtype: 'checkbox', name: "sampleGT_" + name, inputValue: '1/1,1|1', flex: 1},
                        {xtype: 'checkbox', name: "sampleGT_" + name, inputValue: './.,.|.', flex: 1}
                    ]
                })
            );
        }


        return Ext.create('Ext.form.Panel', {
            title: this.title,
            border: this.border,
            collapsible: this.collapsible,
            titleCollapse: this.titleCollapse,
            header: this.headerConfig,
            bodyPadding: "5",
            margin: "0 0 5 0",
            buttonAlign: 'center',
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            allowBlank: false,
            items: items
        });

    },
    getPanel: function () {
        return this.panel;
    },
    getValues: function () {
        var values = this.panel.getValues();
        for (key in values) {
            if (values[key] == '') {
                delete values[key]
            }
        }
        return values;
    },
    clear: function () {
        this.panel.reset();
    }
}

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function StudyFilterFormPanel(args) {
    _.extend(this, Backbone.Events);

    //set default args
    this.id = Utils.genId("StudyFilterFormPanel");
    this.target;
    this.autoRender = true;
    this.title = "Select Studies";
//    this.studies = [];
//    this.studiesStore;
    this.border = true;
    this.height = 300;
    this.collapsed = false;
    this.studyFilterTpl = '<tpl><div class="ocb-study-filter">{studyName}</div></tpl>';


    /**
     * TO BE REMOVED!
     * @type {Ext.data.Store}
     */
    this.studiesStore = Ext.create('Ext.data.Store', {
        pageSize: 50,
        proxy: {
            type: 'memory'
        },
        fields: [
            {name: 'studyName', type: 'string'},
            {name: 'studyId', type: 'string'}
        ],
        autoLoad: false
    });



    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);


    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }

}

StudyFilterFormPanel.prototype = {
    render: function () {
        var _this = this;
        console.log("Initializing " + this.id);

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();
    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.panel.render(this.div);
    },
    _createPanel: function () {
        var _this = this;
//        var store = Ext.create('Ext.data.Store', {
//            fields: [
//                {name: 'studyName', type: 'string'},
//                {name: 'studyId', type: 'string'}
//            ],
//            storeId: this.id + 'ConsequenceTypeSelectorStore',
//            data: []
//        });

//        var cbg = Ext.create('Ext.form.CheckboxGroup', {
////            layout: 'hbox',
//            autoScroll: true,
//            defaultType: 'checkboxfield'
//        });
//
//        var cbgItems = [];
//
//        for (var i = 0; i < this.studies.length; i++) {
//            var study = this.studies[i];
//            cbgItems.push(Ext.create('Ext.form.field.Checkbox', {
//                boxLabel: study.studyName,
//                name: 'studies',
//                inputValue: study.studyId,
//                margin: '0 0 0 5',
//                checked: false
//            }));
//        }
//
//        cbg.add(cbgItems);

//        this.tagField = Ext.create('Ext.form.field.Tag', {
////            fieldLabel: 'Select a study',
////                    labelAlign: 'top',
//            store: this.studiesStore,
//            reference: this.id + 'ConsequenceTypeSelectorStore',
//            displayField: 'studyName',
//            valueField: 'studyId',
//            filterPickList: true,
//            queryMode: 'local',
//            publishes: 'value',
//            flex: 1,
//            grow: false,
//            autoScroll: true,
//            name: 'studies',
//            listeners: {
//                change: function () {
//                    var form = this.up();
//                    if (form) {
//                        form.update();
//                    }
//                }
//            }
//        });

//
//        this.studiesStore = Ext.create('Ext.data.Store', {
//            pageSize: 50,
//            proxy: {
//                type: 'memory'
//            },
//            fields: [
//                {name: 'studyName', type: 'string'},
//                {name: 'studyId', type: 'string'}
//            ],
//            autoLoad: false
//        });

        var studySearchField = Ext.create('Ext.form.field.Text', {
            emptyText: 'search',
            listeners: {
                change: function () {
                    var value = this.getValue();
                    if (value == "") {
                        _this.studiesStore.clearFilter();
                    } else {
                        var regex = new RegExp(value, "i");
                        _this.studiesStore.filterBy(function (e) {
                            return regex.test(e.get('studyName'));
                        });
                    }
                }
            }
        });

        var grid = Ext.create('Ext.grid.Panel', {
                store: this.studiesStore,
            autoScroll:true,
                border: this.border,
                loadMask: true,
                hideHeaders: false,
                enableColumnHide:false,
                plugins: 'bufferedrenderer',
                features: [
                    {ftype: 'summary'}
                ],
//                height: this.height - 70,
//                minHeight: 250,
//                maxHeight: this.height,
                height: this.height,
                viewConfig: {
                    emptyText: 'No studies found',
                    enableTextSelection: true,
                    markDirty: false,
                    listeners: {
                        itemclick: function (este, record) {
                        },
                        itemcontextmenu: function (este, record, item, index, e) {

                        }
                    }
                },
                selModel: {
                    listeners: {
                        'selectionchange': function (selModel, selectedRecord) {

                        }
                    }
                },
                columns: [
                    {
//                        text: 'Active',
                        xtype: 'checkcolumn',
                        dataIndex: 'uiactive',
                        width: 50,
                        sortable : false
                    },
                    {
                        text: "Name",
                        dataIndex: 'studyName',
                        flex: 10,
//                        width: 500,
                        xtype: 'templatecolumn',
                        tpl:this.studyFilterTpl,
                        sortable : true


                    }
//                    {
//                        text: "ID",
//                        dataIndex: 'studyId',
//                        flex: 3
//                    }
                ]
            }
        );


        var form = Ext.create('Ext.form.Panel', {
            bodyPadding: "5",
            margin: "0 0 5 0",
            buttonAlign: 'center',
            border: false,
            title: this.title,
            height: this.height,
            collapsed: this.collapsed,
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            items: [
                studySearchField,
                grid
            ]
        });

        return form;
    },
    getPanel: function () {
        return this.panel;
    },
    getValues: function () {
        var values = [];
        var records = this.studiesStore.query().items;
        for (var i = 0; i < records.length; i++) {
            var record = records[i];
            var active = record.get('uiactive');
            if (active) {
                values.push(record.get('studyId'))
            }
        }
        var res = {};
        if (values.length > 0) {
            res['studies'] = values;
        }
        return res;
    },
    clear: function () {
        this.panel.reset();
    }
}

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function VariantBrowserGrid(args) {
    _.extend(this, Backbone.Events);

    //set default args
    this.id = Utils.genId("Widget");
    this.target;
    this.data = [];
    this.dataParser;
    this.responseParser;
    this.columns;
    this.attributes;
    this.type;
    this.height = 400;
    this.pageSize = 10;
    this.title = "VariantBrowserGrid";
    this.autoRender = true;
    this.border = false;
    this.responseRoot = "response[0].result";
    this.responseTotal = "response[0].numTotalResults";
    this.startParam = "skip";
    this.plugins = 'bufferedrenderer';
    this.viewConfigListeners = '';

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }

}

VariantBrowserGrid.prototype = {
    render: function () {
        var _this = this;
        console.log("Initializing " + this.id);

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);


        this.panel = this._createPanel();
    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);
        this.panel.render(this.div);
    },
    _createPanel: function () {

        var _this = this;

        this.model = Ext.define('Variant', {
            extend: 'Ext.data.Model',
            idProperty: 'iid',
            fields: this.attributes
        });



        this.store = Ext.create('Ext.data.Store', {
                pageSize: this.pageSize,
                model: this.model,
                remoteSort: true,
                proxy: {
                    type: 'memory',
                    enablePaging: true
                },
                listeners: {
                    beforeload: function (store, operation, eOpts) {
                        _this.trigger("variant:clear", {sender: _this});
                    }
                }

            }
        );

        for (var i = 0; i < this.samples.length; i++) {
            var sampleName = this.samples[i];
            this._addSampleColumn(sampleName);
        }


        this.paging = Ext.create('Ext.PagingToolbar', {
            store: _this.store,
            id: _this.id + "_pagingToolbar",
            pageSize: _this.pageSize,
            displayInfo: true,
            displayMsg: 'Variants {0} - {1} of {2}',
            emptyMsg: "No variants to display"
        });

        var grid = Ext.create('Ext.grid.Panel', {
                title: this.title,
                store: this.store,
                border: this.border,
                header: this.headerConfig,
                loadMask: true,
                columns: this.columns,
                plugins: this.plugins,
                animCollapse: false,
                height: this.height,
                overflowX:true,
                features: [
                    {ftype: 'summary'}
                ],
                viewConfig: {
                    emptyText: 'No records to display',
                    enableTextSelection: true,
                    listeners:this.viewConfigListeners
                },
                tbar: this.paging
            }
        );

        grid.getSelectionModel().on('selectionchange', function (sm, selectedRecord) {
            if (selectedRecord.length) {
                var row = selectedRecord[0].data;
                _this.trigger("variant:change", {sender: _this, args: row});
            }
        });

        this.grid = grid;
        return grid;
    },
    load: function (data) {
        var _this = this;
        this.store.destroy();

        if (typeof this.dataParser !== 'undefined') {
            this.dataParser(data)
        } else {
            this._parserFunction(data);

        }

        this.store = Ext.create('Ext.data.Store', {
            pageSize: this.pageSize,
            model: this.model,
            data: data,
            remoteSort: true,
            proxy: {
                type: 'memory',
                enablePaging: true

            },
            listeners: {
                beforeload: function (store, operation, eOpts) {
                    _this.trigger("variant:clear", {sender: _this});
                },
                load: function (store, records, successful, operation, eOpts) {
                    _this.setLoading(false);
                }
            }
        });
        this.grid.reconfigure(this.store, this.columnsGrid);
        this.paging.bindStore(this.store);
        this.paging.doRefresh();
    },
    loadUrl: function (baseUrl, filterParams) {
        var _this = this;
        this.store.destroy();

        console.log("filter");
        console.log(filterParams)

        this.store = Ext.create('Ext.data.Store', {
            pageSize: this.pageSize,
            model: this.model,
            remoteSort: true,
            proxy: {
                url: baseUrl,
                type: 'ajax',
                startParam: this.startParam,
                useDefaultXhrHeader: false,
                reader: {
                    root: this.responseRoot,
                    totalProperty: this.responseTotal,
                    transform: function (response) {
                        var data = [];
                        if (typeof _this.responseParser !== 'undefined') {
                            data = _this.responseParser(response);
                        }
                        if (typeof _this.dataParser !== 'undefined') {
                            _this.dataParser(data);
                        } else {
                            _this._parserFunction(data);
                        }
                        return response;
                    }
                },
                extraParams: filterParams,
                actionMethods: {create: 'GET', read: 'GET', update: 'GET', destroy: 'GET'}
            },
            listeners: {
                load: function (store, records, successful, operation, eOpts) {

                    if (typeof this.dataParser !== 'undefined') {
                        _this.dataParser(records);
                    } else if(!_.isNull(records)){
                        _this._parserFunction(records);
                        _this.grid.getSelectionModel().select(0, true);
                    }

                    _this.setLoading(false);
                },
                beforeload: function (store, operation, eOpts) {
                    _this.trigger("variant:clear", {sender: _this});
                }
            }

        });

        this.grid.reconfigure(this.store, this.columnsGrid);
        this.paging.bindStore(this.store);
        this.store.load();

    },
    _parserFunction: function (data) {
        for (var i = 0; i < data.length; i++) {
            var variant = data[i];

            if (variant.hgvs && variant.hgvs.genomic && variant.hgvs.genomic.length > 0) {
                variant.hgvs_name = variant.hgvs.genomic[0];
            }
        }

    },
    setLoading: function (loading) {
        this.panel.setLoading(loading);
    },
    _addSampleColumn: function (sampleName) {

        var _this = this;

        for (var i = 0; i < _this.attributes.length; i++) {
            if (_this.attributes[i].name == sampleName) {
                return false;
            }
        }

        _this.attributes.push({
            "name": sampleName,
            "type": "string"
        });

        for (var i = 0; i < _this.columns.length; i++) {
            var col = _this.columns[i];

            if (col['text'] == "Samples") {
                col["columns"].push({
                    "text": sampleName,
                    "dataIndex": sampleName,
                    "flex": 1,
                    "sortable": false
                });
            }
        }
        this.store.setFields(this.attributes);
    }
};

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function VariantEffectGrid(args) {
    _.extend(this, Backbone.Events);
    this.id = Utils.genId("VariantEffectGrid");

    this.target;
    this.autoRender = true;
    this.storeConfig = {};
    this.gridConfig = {};
    this.headerConfig;

    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }

}

VariantEffectGrid.prototype = {
    render: function () {
        var _this = this;

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.chartDiv = document.createElement('div');
        $(this.chartDiv).css({
            'height': '200px'
        });

        this.panel = this._createPanel();

    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);
        this.panel.render(this.div);
    },

    clear: function () {
        this.store.removeAll();
        this._updateChart([], []);
    },
    load: function (data) {

        var _this = this;

        var effects = _this._prepareEffectData(data);

        _this.grid.setLoading(true);
        _this.clear();
        this.store.loadData(effects);


        var populations = [];
        var values = [];
        //TODO
//        for (key in data.controls) {
//            values.push(data.controls[key].maf);
//            populations.push(key);
//        }
        this._updateChart(populations, values);


        this.trigger("load:finish", {sender: _this})
        this.grid.setLoading(false);

    },
    _updateChart: function (populations, values) {
        var chart = $(this.chartDiv).highcharts();
        if (chart) {
            chart.xAxis[0].setCategories(populations, false);
            chart.series[0].setData(values, false);
            chart.redraw();
        }
    },
    _createPanel: function () {
        var _this = this;

        var storeArgs = {
            storeId: "EffectStore",
            groupField: 'featureId',
            pageSize: 10,
            fields: [
                {name: 'position', type: 'string'},
                { name: 'allele', type: 'string'},
                { name: 'cDnaPosition', type: 'int'},
                { name: 'canonical', type: 'boolean'},
                { name: 'cdsPosition', type: 'int'},
                { name: 'consequenceTypes', type: 'string'},
                { name: 'featureBiotype', type: 'string'},
                { name: 'featureId', type: 'string'},
                { name: 'featureStrand', type: 'string'},
                { name: 'featureType', type: 'string'},
                { name: 'geneId', type: 'string'},
                { name: 'geneName', type: 'string'},
                { name: 'geneNameSource', type: 'string'},
                { name: 'proteinPosition', type: 'int'},
                { name: 'variantToTranscriptDistance', type: 'int'},
                { name: 'polyphenScore', type: 'number'},
                { name: 'siftScore', type: 'number'}
            ],
            data: [],
            autoLoad: false,
            proxy: {type: 'memory'}
        }

        _.extend(storeArgs, this.storeConfig);

        this.store = Ext.create("Ext.data.Store", storeArgs);


        var gridArgs = {
            title: 'Effects',
            store: this.store,
            loadMask: true,
            border: true,
            //height: this.height,
            height: 200,
            header: this.headerConfig,
            viewConfig: {
                emptyText: 'No records to display',
                enableTextSelection: true
            },
            plugins: ["bufferedrenderer"],
            columns: [
                { text: "Location", dataIndex: "position", flex: 1},
                //{ text: "cDnaPosition"                , dataIndex: "cDnaPosition", flex: 1},
                //{ text: "canonical"                   , dataIndex: "canonical", flex: 1},
                //{ text: "cdsPosition"                 , dataIndex: "cdsPosition", flex: 1},
                { text: "Conseq. Types", dataIndex: "consequenceTypes", flex: 1},
                {text: "Feature", columns: [
                    { text: "Id", dataIndex: "featureId", flex: 1},
                    { text: "Strand", dataIndex: "featureStrand", flex: 1},
                    { text: "Biotype", dataIndex: "featureBiotype", flex: 1},
                    { text: "Type", dataIndex: "featureType", flex: 1}
                ]},
                {text: 'Genes',
                    columns: [
                        { text: "Id", dataIndex: "geneId", flex: 1},
                        { text: "Name", dataIndex: "geneName", flex: 1},
                        { text: "Source", dataIndex: "geneNameSource", flex: 1}
                    ]},
                { text: "Protein Position", dataIndex: "proteinPosition", flex: 1},
                { text: "Distance to Transcript", dataIndex: "variantToTranscriptDistance", flex: 1},
                { text: "Scores",
                    columns: [
                        { text: "Polyphen", dataIndex: "polyphenScore", flex: 1},
                        { text: "SIFT", dataIndex: "siftScore", flex: 1}
                    ]
                }
            ],
            viewConfig: {
                emptyText: 'No records to display'
            }
        }

        _.extend(gridArgs, this.gridConfig);

        this.grid = Ext.create('Ext.grid.Panel', gridArgs);

        $(this.chartDiv).highcharts({
            chart: {
                type: 'bar'
            },
            title: {
                text: null
            },
            xAxis: {
//                categories: populations,
//                categories: [],
                title: {
                    text: 'Populations',
                    align: 'high'
                }
            },
            yAxis: {
                min: 0,
                max: 1,
                title: {
                    text: 'Minimum Allele Frequency',
                    align: 'high'
                },
                labels: {
                    overflow: 'justify'
                }
            },
            plotOptions: {
                bar: {
                    dataLabels: {
                        enabled: true
                    }
                }
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: -40,
                y: 100,
                floating: true,
                borderWidth: 1,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor || '#FFFFFF'),
                shadow: true
            },
            credits: {
                enabled: false
            },
            series: [
                {
                    name: 'MAF',
//                    data: []
//                    data: data
                }
            ]
        });

        var panel = Ext.create('Ext.container.Container', {
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            overflowY: true,
            padding: 10,
            items: [
                this.grid,
                {
                    xtype: 'panel',
                    margin: '10 0 0 0',
                    border: false,
                    title: 'Population Frequencies',
                    header: this.headerConfig,
                    contentEl: this.chartDiv
                }
            ],
            height: this.height
        });
        return panel;


    },
    _prepareEffectData: function (data) {

        var finalData = [];
        var chromosome = data.chromosome;
        var position = data.start;
        var reference = data.referenceAllele;

        console.log(data);
        for (var key in data.effects) {

            for (var i = 0, l = data.effects[key].length; i < l; i++) {
                var v = data.effects[key][i];
                v.position = chromosome + ":" + position + " " + reference + " > " + key;
                v.consequenceTypes = v.consequenceTypes.join(",");
                v.polyphenScore = data.proteinSubstitutionScores.polyphenScore;
                v.siftScore = data.proteinSubstitutionScores.siftScore;

                finalData.push(v);
            }

        }

        return finalData;
    },
    _prepareFrequencyData: function (data) {

        var finalData = [];

        finalData.push({ name: "maf1000G", maf: Math.random()});
        finalData.push({ name: "maf1000GAfrican", maf: Math.random()});
        finalData.push({ name: "maf1000GAmerican", maf: Math.random()});
        finalData.push({ name: "maf1000GAsian", maf: Math.random()});
        finalData.push({ name: "maf1000GEuropean", maf: Math.random()});
        finalData.push({ name: "mafNhlbiEspAfricanAmerican", maf: Math.random()});
        finalData.push({ name: "mafNhlbiEspEuropeanAmerican", maf: Math.random()});

        return finalData;
    }
}



/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function VariantFileBrowserPanel(args) {
    _.extend(this, Backbone.Events);
    this.id = Utils.genId("VariantFileBrowserPanel");

    this.target;
    this.title = "File Browser";
    this.height = 800;
    this.autoRender = true;
    this.studies = [];

    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;

    if (this.autoRender) {
        this.render();
    }
}

VariantFileBrowserPanel.prototype = {
    render: function () {
        var _this = this;

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();

    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }

        this.targetDiv.appendChild(this.div);
        this.panel.render(this.div);

    },
    load: function (studies) {
        this.panel.removeAll(true);
        var studiesPanels = [];
        for (var i = 0; i < studies.length; i++) {
            var study = studies[i];
            studiesPanels.push(this._createStudyPanel(study));
        }
        this.panel.add(studiesPanels);
    },
    _createPanel: function () {
        var panel = Ext.create('Ext.container.Container', {
            layout: {
                type: 'vbox',
                align: 'stretch'
            }
        });
        if (this.studies.length > 0) {
            this.load(this.studies);
        }

        return panel;
    },
    _createStudyPanel: function (study) {


        var filePanels = [];
        for (var i = 0; i < study.files.length; i++) {
            var file = study.files[i];
            filePanels.push(this._createFilePanel(file));
        }

        var filesContainer = Ext.create('Ext.container.Container', {
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            overflowY: true,
            padding: 10,
            items: filePanels

        });

        var studyPanel = Ext.create('Ext.container.Container', {
            items: [
                {
                    xtype: 'box',
                    cls: 'eva-header-3',
                    overCls:'eva-pointer eva-underline',
                    html: study.studyName,
                    listeners: {
                        afterrender: function () {
                            this.getEl().on('click', function () {
                                if (filesContainer.isHidden()) {
                                    filesContainer.show();
                                } else {
                                    filesContainer.hide();
                                }
                            });
                        }
                    }
                },
                filesContainer
            ]
        });
        return studyPanel;

    },
    _createFilePanel: function (file) {

        var filePanel = Ext.create('Ext.container.Container', {
            layout: 'vbox',
            items: [
                {
                    xtype: 'box',
                    cls: 'eva-header-5',
                    margin: '5 5 5 10',
                    html: file.fileName
                },
                {
                    xtype: 'container',
                    layout: 'hbox',
                    items: [
//                        {
//                            xtype: 'container',
//                            data: file,
//                            tpl: new Ext.XTemplate(
//                                    '<table class="eva-stats-table">' +
//                                    '<tr>' +
//                                    '<td class="header">File name:</td>' +
//                                    '<td>{fileName}</td>' +
//                                    '</tr>',
//                                    '<tr>' +
//                                    '<td class="header">Study name:</td>' +
//                                    '<td>{studyName}</td>' +
//                                    '</tr>',
//                                '</table>'
//                            ),
//                            margin: '5 5 5 10'
//                        },
                        {
                            xtype: 'container',
                            data: file.stats,
                            tpl: new Ext.XTemplate(
                                    '<table class="eva-stats-table">' +
                                    '<tr>' +
                                    '<td class="header">Variants count:</td>' +
                                    '<td>{variantsCount}</td>' +
                                    '</tr>',
                                    '<tr>' +
                                    '<td class="header">Samples count:</td>' +
                                    '<td>{samplesCount}</td>' +
                                    '</tr>',
                                    '<tr>' +
                                    '<td class="header">SNPs count:</td>' +
                                    '<td>{snpsCount}</td>' +
                                    '</tr>',
                                    '<tr>' +
                                    '<td class="header">Indels count:</td>' +
                                    '<td>{indelsCount}</td>' +
                                    '</tr>',
                                    '<tr>' +
                                    '<td class="header">Pass count:</td>' +
                                    '<td>{passCount}</td>' +
                                    '</tr>',
                                    '<tr>' +
                                    '<td class="header">Ti/Tv Ratio:</td>' +
                                    '<td>{[this.titv(values)]}</td>' +
                                    '</tr>',
                                    '<tr>' +
                                    '<td class="header">Mean quality:</td>' +
                                    '<td>{meanQuality}</td>' +
                                    '</tr>',
                                '</table>', {
                                    titv: function (values) {
                                        var res = values.transitionsCount / values.transversionsCount;
                                        return res.toFixed(2);
                                    }
                                }
                            ),
                            margin: '5 5 5 10'
                        },
                    ]
                },

            ]
        });

        return filePanel;

    },
    setLoading: function(loading){
        this.panel.setLoading(loading);
    }
};

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function VariantGenotypeGrid(args) {
    _.extend(this, Backbone.Events);
    this.id = Utils.genId("VariantGenotypeGrid");

    this.autoRender = true;
    this.storeConfig = {};
    this.gridConfig = {};
    this.height = 500;
    this.target;
    this.columns = [
        {
            text: "Sample",
            dataIndex: "sample",
            flex: 1
        },
        {
            text: "Genotype",
            dataIndex: "genotype",
            flex: 1
        },
        {
            text: "Sex",
            dataIndex: "sex",
            flex: 1
        },
        {
            text: "Phenotype",
            dataIndex: "phenotype",
            flex: 1
        }
    ];

    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;

    if (this.autoRender) {
        this.render(this.targetId);
    }
}

VariantGenotypeGrid.prototype = {
    render: function () {
        var _this = this;

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();

    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);
        this.panel.render(this.div);
    },
    clear: function () {
        this.studiesContainer.removeAll(true);
    },
    load: function (data) {
        this.clear();
        var panels = [];
        for (var key in data) {
            var study = data[key];
//            if (Object.keys(study.samplesData).length > 0) {
                panels.push(this._createStudyPanel(study));
//            }
        }
        this.studiesContainer.add(panels);

    },
    _createPanel: function () {
        this.studiesContainer = Ext.create('Ext.container.Container', {
            layout: {
                type: 'accordion',
                titleCollapse: true,
//                fill: false,
                multi: true
            }
        });

        var panel = Ext.create('Ext.container.Container', {
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            overflowY: true,
            padding: 10,
            items: [
                {
                    xtype: 'box',
                    cls: 'ocb-header-4',
                    html: '<h4>Studies</h4s>',
                    margin: '5 0 10 10'
                },
                this.studiesContainer
            ],
            height: this.height
        });
        return panel;
    },
    _createStudyPanel: function (data) {
        var stats = (data.stats) ? data.stats : {};
        var samples = (data.samplesData) ? data.samplesData : {};

        var finalData = [];
        for (var key in samples) {
            var s = samples[key];
            finalData.push({
                sample: key,
                genotype: s.GT
            });
        }
        console.log(finalData);
        if(_.isEmpty(finalData)){
            var grid = {
                xtype: 'container',
                html: '<p>No Genotypes available</p>',
                margin: '5 0 10 10'
            }
        }else{
            var store = Ext.create("Ext.data.Store", {
                //storeId: "GenotypeStore",
                pageSize: 10,
                fields: [
                    {name: "sample", type: "string" },
                    {name: "genotype", type: "string"},
                    {name: "sex", type: "string"},
                    {name: "phenotype", type: "string"}
                ],
                data: finalData,
                proxy: {type: 'memory'}
            });

            var grid = Ext.create('Ext.grid.Panel', {
                store: store,
                loadMask: true,
                width: 400,
                height: 300,
                margin: 20,
                viewConfig: {
                    emptyText: 'No records to display',
                    enableTextSelection: true
                },
                plugins: ["bufferedrenderer"],
                columns: this.columns
            });

            var gts = this._getGenotypeCount(stats.genotypesCount);

            var genotypeChart;
            if (gts.length > 0) {
                var store = Ext.create('Ext.data.Store', {
                    fields: ['genotype', 'count'],
                    data: gts
                });

//                genotypeChart = Ext.create('Ext.chart.Chart', {
//                    xtype: 'chart',
//                    width: 200,
//                    height: 130,
//                    store: store,
//                    animate: true,
//                    shadow: true,
//                    legend: {
//                        position: 'right'
//                    },
//                    theme: 'Base:gradients',
//                    //insetPadding: 60,
//                    series: [
//                        {
//                            type: 'pie',
//                            field: 'count',
//                            showInLegend: true,
//                            tips: {
//                                trackMouse: true,
//                                renderer: function (storeItem, item) {
//                                    var name = storeItem.get('genotype');
//                                    this.setTitle(name + ': ' + storeItem.get('count'));
//                                }
//                            },
//                            highlight: {
//                                segment: {
//                                    margin: 20
//                                }
//                            },
//                            label: {
//                                field: 'genotype',
//                                display: 'rotate',
//                                contrast: true,
//                                font: '10px Arial'
//                            }
//
//                        }
//                    ]
//                });
            }
        }


        //TO BE REMOVED
        var study_title;
        if(projects){
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].studyId === data.studyId) {
                    study_title = '<a href="?eva-study='+projects[i].studyId+'" target="_blank">'+projects[i].studyName+'</a> ('+ projects[i].studyId +')';
                }
            }
        }else{
            study_title = '<a href="?eva-study='+data.studyId+'" target="_blank">'+data.studyId+'</a>';
        }


        var studyPanel = Ext.create('Ext.panel.Panel', {
            title: study_title,
            border: true,
            layout: {
                type: 'hbox',
                align: 'stretch'
            },
            items: [
                grid,
                genotypeChart
            ]
        });

        return studyPanel;

    },
    _getGenotypeCount: function (gc) {
        var res = [];
        for (var key in gc) {
            res.push({
                genotype: key,
                count: gc[key]
            })
        }
        return res;
    }
};

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */
function VariantStatsPanel(args) {
    _.extend(this, Backbone.Events);
    this.id = Utils.genId("VariantStatsPanel");

    this.target;
    this.title = "Stats";
    this.height = 500;
    this.autoRender = true;
    this.statsTpl = new Ext.XTemplate(
                        '<table class="ocb-stats-table">' +
                            '<tr>' +
                            '<td class="header">Minor Allele Frequency:</td>' +
                            '<td>{maf} ({mafAllele})</td>' +
                            '</tr>',
                        '<tr>' +
                            '<td class="header">Minor Genotype Frequency:</td>' +
                            '<td>{mgf} ({mgfAllele})</td>' +
                            '</tr>',
                        '<tr>' +
                            '<td class="header">Mendelian Errors:</td>' +
                            '<td>{mendelianErrors}</td>' +
                            '</tr>',
                        '<tr>' +
                            '<td class="header">Missing Alleles:</td>' +
                            '<td>{missingAlleles}</td>' +
                            '</tr>',
                        '<tr>' +
                            '<td class="header">Missing Genotypes:</td>' +
                            '<td>{missingGenotypes}</td>' +
                            '</tr>',
                        '</table>'
                    );

    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;

    if (this.autoRender) {
        this.render();
    }
}

VariantStatsPanel.prototype = {
    render: function () {
        var _this = this;

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.panel = this._createPanel();

    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }

        this.targetDiv.appendChild(this.div);
        this.panel.render(this.div);

    },
    clear: function () {
        this.studiesContainer.removeAll(true);
    },
    load: function (data) {
        this.clear();

        var panels = [];

        for (var key in data) {
            var study = data[key];
            var studyPanel = this._createStudyPanel(study);
            panels.push(studyPanel);

        }

        this.studiesContainer.add(panels);
    },
    _createPanel: function () {
        this.studiesContainer = Ext.create('Ext.container.Container', {
            layout: {
                type: 'accordion',
                titleCollapse: true,
//                fill: false,
                multi: true
            }
        });

        var panel = Ext.create('Ext.container.Container', {
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            overflowY: true,
            padding: 10,
            items: [
                {
                    xtype: 'box',
                    cls: 'ocb-header-4',
                    html: '<h4>Studies</h4>',
                    margin: '5 0 10 10'
                },
                this.studiesContainer
            ],
            height: this.height
        });
        return panel;
    },
    _createStudyPanel: function (data) {

        var stats = (data.stats) ? data.stats : {};
        var attributes = (data.attributes) ? data.attributes : {};
        // removing src from attributes
        var attributesData = {};
        _.extend(attributesData,attributes);
        delete attributesData['src'];
        delete attributesData['ACC'];

        //TO BE REMOVED
        var study_title;
        if(projects){
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].studyId === data.studyId) {
                    study_title = '<a href="?eva-study='+projects[i].studyId+'" target="_blank">'+projects[i].studyName+'</a> ('+ projects[i].studyId +')';
                }
            }
        }else{
            study_title = '<a href="?eva-study='+data.studyId+'" target="_blank">'+data.studyId+'</a>';
        }

        var studyPanel = Ext.create('Ext.panel.Panel', {
            title: study_title,
            border: false,
            layout: 'vbox',
            overflowX: true,
            items: [
                {
                    xtype: 'container',
                    data: attributesData,
                    tpl: new Ext.XTemplate(
                        '<table class="ocb-attributes-table"><tr>',
                        '<tpl foreach=".">',
                        '<td class="header">{$}</td>', // the special **`{$}`** variable contains the property name
                            '</tpl>' +
                            '</tr><tr>',
                        '<tpl foreach=".">',
                        '<td>{.}</td>', // within the loop, the **`{.}`** variable is set to the property value
                        '</tpl>',
                        '</tr></table>'
                    ),
                    margin: '10 5 5 10'
                },
                {
                    xtype: 'box',
                    cls: 'ocb-header-5',
                    margin: '5 5 5 10',
                    html: '<h5>Stats</h5>'
                },
                {
                    xtype: 'container',
                    layout: 'hbox',
                    items: [
                        {
                            xtype: 'container',
                            data: stats,
                            tpl: this.statsTpl,
                            margin: '5 5 5 10'
                        }
                    ]
                }

            ]
        });

        var gts = this._getGenotypeCount(stats.genotypesCount);

        if (gts.length > 0) {
            var store = Ext.create('Ext.data.Store', {
                fields: ['genotype', 'count'],
                data: gts
            });

//            var genotypeChart = Ext.create('Ext.chart.Chart', {
//                xtype: 'chart',
//                width: 200,
//                height: 130,
//                store: store,
//                animate: true,
//                shadow: true,
//                legend: {
//                    position: 'right'
//                },
//                theme: 'Base:gradients',
//                series: [
//                    {
//                        type: 'pie',
//                        field: 'count',
//                        showInLegend: true,
//                        tips: {
//                            trackMouse: true,
//                            renderer: function (storeItem, item) {
//                                var name = storeItem.get('genotype');
//                                this.setTitle(name + ': ' + storeItem.get('count'));
//                            }
//                        },
//                        highlight: {
//                            segment: {
//                                margin: 20
//                            }
//                        },
//                        label: {
//                            field: 'genotype',
//                            display: 'rotate',
//                            contrast: true,
//                            font: '10px Arial'
//                        }
//
//                    }
//                ]
//            });
//            studyPanel.down().nextSibling().nextSibling().add(genotypeChart);
        }

        return studyPanel;
    },
    _getGenotypeCount: function (gc) {
        var res = [];
        for (var key in gc) {
            res.push({
                genotype: key,
                count: gc[key]
            })
        }
        return res;
    }
};

/*
 * Copyright (c) 2014 Francisco Salavert (SGL-CIPF)
 * Copyright (c) 2014 Alejandro Alemán (SGL-CIPF)
 * Copyright (c) 2014 Ignacio Medina (EBI-EMBL)
 *
 * This file is part of JSorolla.
 *
 * JSorolla is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JSorolla is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JSorolla. If not, see <http://www.gnu.org/licenses/>.
 */

function VariantWidget(args) {

    _.extend(this, Backbone.Events);

    this.id = Utils.genId("VariantWidget");

    //set default args
    this.target;
    this.width;
    this.height;
    this.autoRender = true;
    this.data = [];
    this.host;
    this.closable = true;
    this.filters = {
        segregation: true,
        maf: true,
        effect: true,
        region: true,
        gene: true
    };
    this.headerConfig;
    this.attributes = [];
    this.columns = [];
    this.samples = [];
    this.defaultToolConfig = {
        headerConfig: {
            baseCls: 'ocb-title-2'
        },
        effect: true,
        genomeViewer: true,
        genotype: true,
        stats: true
    };
    this.tools = [];
    this.dataParser;
    this.responseParser;

    this.responseRoot = "response[0].result";
    this.responseTotal = "response[0].numTotalResults";
    this.startParam = "skip";

    this.browserGridConfig = {
        title: 'variant browser grid',
        border: false
    };
    this.toolPanelConfig = {
        title: 'Variant data',
        border: false
    };
    this.toolsConfig = {
        headerConfig: {
            baseCls: 'ocb-title-2'
        }
    };


    _.extend(this.filters, args.filters);
    _.extend(this.browserGridConfig, args.browserGridConfig);
    _.extend(this.defaultToolConfig, args.defaultToolConfig);

    delete args.filters;
    delete args.defaultToolConfig;

//set instantiation args, must be last
    _.extend(this, args);

    this.selectedToolDiv;

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }

}

VariantWidget.prototype = {
    render: function () {
        var _this = this;

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);

        this.variantBrowserGridDiv = document.createElement('div');
        this.variantBrowserGridDiv.setAttribute('class', 'ocb-variant-widget-grid');
        this.div.appendChild(this.variantBrowserGridDiv);

        this.variantBrowserGrid = this._createVariantBrowserGrid(this.variantBrowserGridDiv);

        this.tabPanelDiv = document.createElement('div');
        this.tabPanelDiv.setAttribute('class', 'ocb-variant-tab-panel');
        this.div.appendChild(this.tabPanelDiv);

        this.toolTabPanel = Ext.create("Ext.tab.Panel", {
            title: this.toolPanelConfig.title,
            border: this.toolPanelConfig.border,
            margin: '10 0 0 0',
            plain: true,
            animCollapse: false,
            header: this.toolPanelConfig.headerConfig,
            collapseDirection: Ext.Component.DIRECTION_BOTTOM,
            titleCollapse: true,
            overlapHeader: true,
            defaults: {
                hideMode: 'offsets',
                autoShow: true
            },
            listeners: {
                tabchange: function (tabPanel, newTab, oldTab, eOpts) {
                    _this.selectedToolDiv = newTab.contentEl;
                    if (_this.lastVariant) {
                        _this.trigger('variant:change', {variant: _this.lastVariant, sender: _this});
                    }
                }
            }
        });

        var tabPanelItems = [];

        if (this.defaultToolConfig.stats) {
            this.variantStatsPanelDiv = document.createElement('div');
            this.variantStatsPanelDiv.setAttribute('class', 'ocb-variant-stats-panel');
            this.variantStatsPanel = this._createVariantStatsPanel(this.variantStatsPanelDiv);
            tabPanelItems.push({
                title: 'File and Stats',
//                border: 0,
                contentEl: this.variantStatsPanelDiv
            });
        }

        if (this.defaultToolConfig.effect) {
            this.variantEffectGridDiv = document.createElement('div');
            this.variantEffectGridDiv.setAttribute('class', 'ocb-variant-effect-grid');
            this.variantEffectGrid = this._createVariantEffectGrid(this.variantEffectGridDiv);
            tabPanelItems.push({
                title: 'Effect and Annotation',
                contentEl: this.variantEffectGridDiv
            });
        }

        if (this.defaultToolConfig.genotype) {
            this.variantGenotypeGridDiv = document.createElement('div');
            this.variantGenotypeGridDiv.setAttribute('class', 'ocb-variant-genotype-grid');
            this.variantGenotypeGrid = this._createVariantGenotypeGrid(this.variantGenotypeGridDiv);
            tabPanelItems.push({
                title: 'Genotype',
//                border: 0,
                contentEl: this.variantGenotypeGridDiv
            });
        }

        if (this.defaultToolConfig.genomeViewer) {
            this.genomeViewerDiv = document.createElement('div');
            this.genomeViewerDiv.setAttribute('class', 'ocb-gv');
            $(this.genomeViewerDiv).css({border: '1px solid lightgray'});
            this.genomeViewer = this._createGenomeViewer(this.genomeViewerDiv);
            tabPanelItems.push({
                title: 'Genomic Context',
                border: 0,
                contentEl: this.genomeViewerDiv
            });
        }

        for (var i = 0; i < this.tools.length; i++) {
            var tool = this.tools[i];
            var toolDiv = document.createElement('div');

            tool.tool.target = toolDiv;

            tabPanelItems.push({
                title: tool.title,
                contentEl: toolDiv
            });
        }

        this.toolTabPanel.add(tabPanelItems);

        this.rendered = true;
    },
    draw: function () {
        var _this = this;
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.variantBrowserGrid.draw();

        this.toolTabPanel.render(this.tabPanelDiv);


        for (var i = 0; i < this.toolTabPanel.items.items.length; i++) {
            this.toolTabPanel.setActiveTab(i);
        }

        if (this.defaultToolConfig.effect) {

            this.variantEffectGrid.draw();
        }

        if (this.defaultToolConfig.genotype) {

            this.variantGenotypeGrid.draw();
        }

        if (this.defaultToolConfig.genomeViewer) {
            this.genomeViewer.draw();
        }

        if (this.defaultToolConfig.stats) {
            this.variantStatsPanel.draw();
        }

        for (var i = 0; i < this.tools.length; i++) {
            var tool = this.tools[i];
            tool.tool.draw();
        }

        this.toolTabPanel.setActiveTab(0);
    },
    _createVariantBrowserGrid: function (target) {
        var _this = this;


        var variantBrowserGrid = new VariantBrowserGrid({
            title: this.browserGridConfig.title,
            target: target,
            data: this.data,
            border: this.browserGridConfig.border,
            dataParser: this.dataParser,
            responseRoot: this.responseRoot,
            responseTotal: this.responseTotal,
            responseParser: this.responseParser,
            startParam: this.startParam,
            attributes: this.attributes,
            columns: this.columns,
            samples: this.samples,
            headerConfig: this.headerConfig,
            handlers: {
                "variant:change": function (e) {
                    _this.lastVariant = e.args;
                    _this.trigger('variant:change', {variant: _this.lastVariant, sender: _this});
                },
                "variant:clear": function (e) {
                    //_this.lastVariant = e.args;
                    _this.trigger('variant:clear', {sender: _this});
                }
            }
        });
        return variantBrowserGrid;
    },

    _createVariantEffectGrid: function (target) {
        var _this = this;
        var variantEffectGrid = new VariantEffectGrid({
            target: target,
            headerConfig: this.defaultToolConfig.headerConfig,
            gridConfig: {
                flex: 1,
                layout: {
                    align: 'stretch'
                }
            },
            handlers: {
                "load:finish": function (e) {
                }
            }
        });

        this.variantBrowserGrid.on("variant:clear", function (e) {
            variantEffectGrid.clear(true);
        });

        this.on("variant:change", function (e) {
            if (target === _this.selectedToolDiv) {
                var variant = e.variant;

                var effectData = _this._loadExampleData();

                variantEffectGrid.load(effectData);
            }

        });
        return variantEffectGrid;
    },
    _createVariantStatsPanel: function (target) {
        var _this = this;
        var variantStatsPanel = new VariantStatsPanel({
            target: target,
            headerConfig: this.defaultToolConfig.headerConfig,
            handlers: {
                "load:finish": function (e) {
//                    _this.grid.setLoading(false);
                }
            }
        });

        this.variantBrowserGrid.on("variant:clear", function (e) {
            variantStatsPanel.clear(true);
        });

        this.on("variant:change", function (e) {
            if (target === _this.selectedToolDiv) {
                var variant = e.variant;
                if (variant.files) {
                    variantStatsPanel.load(variant.files);
                }
            }
        });
        return variantStatsPanel;
    },
    _createVariantGenotypeGrid: function (target) {
        var _this = this;
        var variantGenotypeGrid = new VariantGenotypeGrid({
            target: target,
            headerConfig: this.defaultToolConfig.headerConfig,
            gridConfig: {
                flex: 1,
                layout: {
                    align: 'stretch'
                }
            },
            handlers: {
                "load:finish": function (e) {

                }
            }
        });

        this.variantBrowserGrid.on("variant:clear", function (e) {
            variantGenotypeGrid.clear(true);
        });

        _this.on("variant:change", function (e) {
            if (target === _this.selectedToolDiv) {
                var variant = e.variant;
                if (variant.files) {
                    variantGenotypeGrid.load(variant.files);
                }
            }
        });
        return variantGenotypeGrid;
    },


    _createGenomeViewer: function (target) {
        var _this = this;


        var region = new Region({
            chromosome: "13",
            start: 32889611,
            end: 32889611
        });

        var genomeViewer = new GenomeViewer({
            sidePanel: false,
            target: target,
            border: false,
            resizable: true,
            width: this.width,
            region: region,
            trackListTitle: '',
            drawNavigationBar: true,
            drawKaryotypePanel: false,
            drawChromosomePanel: false,
            drawRegionOverviewPanel: true,
            overviewZoomMultiplier: 50,
            navigationBarConfig: {
                componentsConfig: {
                    restoreDefaultRegionButton: false,
                    regionHistoryButton: false,
                    speciesButton: false,
                    chromosomesButton: false,
                    karyotypeButton: false,
                    chromosomeButton: false,
                    regionButton: false,
//                    zoomControl: false,
                    windowSizeControl: false,
//                    positionControl: false,
//                    moveControl: false,
//                    autoheightButton: false,
//                    compactButton: false,
//                    searchControl: false
                }
            }
        });


        var renderer = new FeatureRenderer(FEATURE_TYPES.gene);
        renderer.on({
            'feature:click': function (event) {
                // feature click event example
                console.log(event)
            }
        });
        var geneOverview = new FeatureTrack({
//        title: 'Gene overview',
            minHistogramRegionSize: 20000000,
            maxLabelRegionSize: 10000000,
            height: 100,

            renderer: renderer,

            dataAdapter: new CellBaseAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "gene",
                params: {
                    exclude: 'transcripts,chunkIds'
                },
                species: genomeViewer.species,
                cacheConfig: {
                    chunkSize: 100000
                }
            })
        });


        var sequence = new SequenceTrack({
//        title: 'Sequence',
            height: 30,
            visibleRegionSize: 200,

            renderer: new SequenceRenderer(),

            dataAdapter: new SequenceAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "sequence",
                species: genomeViewer.species
            })
        });


        var gene = new GeneTrack({
            title: 'Gene',
            minHistogramRegionSize: 20000000,
            maxLabelRegionSize: 10000000,
            minTranscriptRegionSize: 200000,
            height: 140,

            renderer: new GeneRenderer(),

            dataAdapter: new CellBaseAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "gene",
                species: genomeViewer.species,
                params: {
                    exclude: 'transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence'
                },
                cacheConfig: {
                    chunkSize: 100000
                }
            })
        });

        var snp = new FeatureTrack({
            title: 'SNP',
            featureType: 'SNP',
            minHistogramRegionSize: 10000,
            maxLabelRegionSize: 3000,
            height: 100,

            renderer: new FeatureRenderer(FEATURE_TYPES.snp),

            dataAdapter: new CellBaseAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "snp",
                params: {
                    exclude: 'transcriptVariations,xrefs,samples'
                },
                species: genomeViewer.species,
                cacheConfig: {
                    chunkSize: 10000
                }
            })
        });

        genomeViewer.addOverviewTrack(geneOverview);
        genomeViewer.addTrack([sequence, gene, snp]);


        this.on("variant:change", function (e) {
            if (target === _this.selectedToolDiv) {
                var variant = e.variant;
                var region = new Region(variant);
                if (!_.isUndefined(genomeViewer)) {
                    genomeViewer.setRegion(region);
                }
            }
        });

        return genomeViewer;
    },
    retrieveData: function (baseUrl, filterParams) {
        this.variantBrowserGrid.loadUrl(baseUrl, filterParams);
    },
    setLoading: function (loading) {
        this.variantBrowserGrid.setLoading(loading);
    },
    _loadExampleData: function () {
        var data = {"chromosome": "1", "start": 10001, "end": 10001, "referenceAllele": "T", "genes": [], "effects": {"G": [
                {"allele": "G", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000456328", "featureType": "Transcript", "featureBiotype": "processed_transcript", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": true, "variantToTranscriptDistance": 1868},
                {"allele": "G", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000488147", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4403},
                {"allele": "G", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000541675", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4362},
                {"allele": "G", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000450305", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 2009},
                {"allele": "G", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000515242", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 1871},
                {"allele": "G", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000538476", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4410},
                {"allele": "G", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000518655", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 1873},
                {"allele": "G", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000438504", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": true, "variantToTranscriptDistance": 4362},
                {"allele": "G", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000423562", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4362},
                {"allele": "G", "featureId": "ENSR00000668495", "featureType": "RegulatoryFeature", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1566], "canonical": false, "variantToTranscriptDistance": -1}
            ], "A": [
                {"allele": "A", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000456328", "featureType": "Transcript", "featureBiotype": "processed_transcript", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": true, "variantToTranscriptDistance": 1868},
                {"allele": "A", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000488147", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4403},
                {"allele": "A", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000541675", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4362},
                {"allele": "A", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000450305", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 2009},
                {"allele": "A", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000515242", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 1871},
                {"allele": "A", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000538476", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4410},
                {"allele": "A", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000518655", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 1873},
                {"allele": "A", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000438504", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": true, "variantToTranscriptDistance": 4362},
                {"allele": "A", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000423562", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4362},
                {"allele": "A", "featureId": "ENSR00000668495", "featureType": "RegulatoryFeature", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1566], "canonical": false, "variantToTranscriptDistance": -1}
            ], "C": [
                {"allele": "C", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000456328", "featureType": "Transcript", "featureBiotype": "processed_transcript", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": true, "variantToTranscriptDistance": 1868},
                {"allele": "C", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000488147", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4403},
                {"allele": "C", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000541675", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4362},
                {"allele": "C", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000450305", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 2009},
                {"allele": "C", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000515242", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 1871},
                {"allele": "C", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000538476", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4410},
                {"allele": "C", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000518655", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 1873},
                {"allele": "C", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000438504", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": true, "variantToTranscriptDistance": 4362},
                {"allele": "C", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000423562", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4362},
                {"allele": "C", "featureId": "ENSR00000668495", "featureType": "RegulatoryFeature", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1566], "canonical": false, "variantToTranscriptDistance": -1}
            ], "-": [
                {"allele": "-", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000456328", "featureType": "Transcript", "featureBiotype": "processed_transcript", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": true, "variantToTranscriptDistance": 1868},
                {"allele": "-", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000488147", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4403},
                {"allele": "-", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000541675", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4362},
                {"allele": "-", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000450305", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 2009},
                {"allele": "-", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000515242", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 1871},
                {"allele": "-", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000538476", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4410},
                {"allele": "-", "geneId": "ENSG00000223972", "geneName": "DDX11L1", "geneNameSource": "HGNC", "featureId": "ENST00000518655", "featureType": "Transcript", "featureBiotype": "transcribed_unprocessed_pseudogene", "featureStrand": "1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1631], "canonical": false, "variantToTranscriptDistance": 1873},
                {"allele": "-", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000438504", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": true, "variantToTranscriptDistance": 4362},
                {"allele": "-", "geneId": "ENSG00000227232", "geneName": "WASH7P", "geneNameSource": "HGNC", "featureId": "ENST00000423562", "featureType": "Transcript", "featureBiotype": "unprocessed_pseudogene", "featureStrand": "-1", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1632], "canonical": false, "variantToTranscriptDistance": 4362},
                {"allele": "-", "featureId": "ENSR00000668495", "featureType": "RegulatoryFeature", "cDnaPosition": -1, "cdsPosition": -1, "proteinPosition": -1, "consequenceTypes": [1566], "canonical": false, "variantToTranscriptDistance": -1}
            ]}, "frequencies": {"maf1000G": 0.6, "maf1000GAfrican": 0.5, "maf1000GAmerican": 0.4, "maf1000GAsian": 0.3, "maf1000GEuropean": 0.2, "mafNhlbiEspAfricanAmerican": 0.1, "mafNhlbiEspEuropeanAmerican": 0.2}, "proteinSubstitutionScores": {"polyphenScore": -1.0, "siftScore": -1.0}, "regulatoryEffect": {"motifPosition": 0, "motifScoreChange": 0.0, "highInformationPosition": false}}
            ;
        return data
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function CheckBrowser(appName){

    if(Ext.isIE){
        //console.time implementation for IE
        if(window.console && typeof(window.console.time) == "undefined") {
            console.time = function(name, reset){
                if(!name) { return; }
                var time = new Date().getTime();
                if(!console.timeCounters) { console.timeCounters = {} };
                var key = "KEY" + name.toString();
                if(!reset && console.timeCounters[key]) { return; }
                console.timeCounters[key] = time;
            };

            console.timeEnd = function(name){
                var time = new Date().getTime();
                if(!console.timeCounters) { return; }
                var key = "KEY" + name.toString();
                var timeCounter = console.timeCounters[key];
                if(timeCounter) {
                    var diff = time - timeCounter;
                    var label = name + ": " + diff + "ms";
                    console.info(label);
                    delete console.timeCounters[key];
                }
                return diff;
            };
        }
    }

	var browserOk = false;
	switch (appName){
	case "renato":
		if(Ext.chromeVersion>=16){
			browserOk = true;
		}
		if(Ext.safariVersion>=5){
			browserOk = true;
		}
		if(Ext.firefoxVersion>=10){
			browserOk = true;
		}
		break;
	case "variant":
		if(Ext.chromeVersion>=16){
			browserOk = true;
		}
		if(Ext.safariVersion>=5){
			browserOk = true;
		}
		if(Ext.firefoxVersion>=10){
			browserOk = true;
		}
		break;
	default:
		if(Ext.chromeVersion>=40){
			browserOk = true;
		}
		if(Ext.safariVersion>=5){
			browserOk = true;
		}
		if(Ext.firefoxVersion>=37){
			browserOk = true;
		}
		if(Ext.operaVersion>=29){
			browserOk = true;
		}
	}
//if(Ext.operaVersion<=0){
//	browserOk = true;
//}
//if(Ext.firefoxVersion<=0){
//	browserOk = true;
//}
	if(browserOk==false){
		console.log("--------------------------------------------"+browserOk)
//		Ext.create("Ext.window.Window",{
//			title:'Supported browsers',
//		modal:true,
//		resizable:false,
//		bodyStyle:"background:#ffffff;",
//		bodyPadding:15,
//		width:330,
//		height:200,
//			html:'<p>This release makes an intensive use of new web technologies and standards like HTML5, so the browsers that are fully supported from now on are:</p>'+ 
//			'<br><p class="emph">Chrome 14+</p>'+ 
//			'<p class="emph">Safari 5+</p>'+ 
//			'<br>Other browsers or may rise some errors.'
//		}).show();
		$("#checkBrowser")
//		.html('<p>This release makes an intensive use of new web technologies and standards like HTML5 and SVG, so the browsers that are fully supported and will provide the best user experience are:</p>'+ 
//				'<p class="emph">Google Chrome 14+</p>'+ 
//				'<p class="emph">Apple Safari 5+</p>'+ 
//				'Other browsers may rise some errors. Firefox11+ works very slow on Linux and Windows 7 and the usage it is not recommended. Internet Explorer 9 is not supported since they not support many of the features of HTML5, Internet Explorer 10 Consumer Preview works fine.')
		.html('This application provides the best user experience with Google Chrome and Apple Safari, otherwise some latencies may be experienced when browsing due to some problems in Firefox.')
		.css('width','540px')
		.css('height','40px')
		.css('position','absolute')
		.css('margin-left','300px')
		.css('margin-top','26px')
		.css('padding','5px')
		.css('border','1px solid #F1D031')
		.css('background','#FFFFA3')
		.css('color','#555')
		.css('position','absolute')
		.css('z-index','50000')
		.click(function(){
			$("#checkBrowser").fadeOut(function (){ $(this).remove(); });  
		});
	}
}

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function GenericFormPanel(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    this.analysis;
    this.form = null;
    this.paramsWS = {};
    this.testing = false;
    this.closable = true;
    this.minimizable = true;
    this.labelWidth = 150;

    this.type;
    this.style;
    this.title;
    this.resizable;
    this.width = 500;
    this.height = 600;
    this.border = true;
    this.formBorder = true;
    this.taskbar;
    this.bodyPadding;
    this.headerConfig;
    this.buttonConfig = {
        width: 200,
        height: 30
    };

    _.extend(this, args);


    this.runAnalysisSuccess = function (response) {
        if (response.errorMsg !== '') {
            Ext.Msg.show({
                title: "Error",
                msg: response.errorMsg,
                buttons: Ext.Msg.OK,
                icon: Ext.Msg.ERROR
            });
        } else {
            Utils.msg('Job Launched', 'It will be listed soon');
            if (!_this.testing) {
                _this.clean();
            }
            console.log(response);
            if (_this.type == "window") {
                _this.panel.hide();
            }
        }
    };
    //events attachments
    this.on(this.handlers);

}

GenericFormPanel.prototype.draw = function () {
    var _this = this;
    if (this.panel == null) {
        if (this.type == "window") {
            this.panel = Ext.create('Ext.window.Window', {
                title: this.title,
                closable: this.closable,
                minimizable: this.minimizable,
                resizable: this.resizable,
//                bodyStyle: 'background:white;',
//                overflowY: 'auto',
//                taskbar: this.taskbar,
                layout: 'fit',
                items: {
                    border: 0,
                    items: [this.getForm()]
                },
                listeners: {
                    minimize: function () {
                        this.hide();
                    },
                    close: function () {
                        this.hide();
                    }
                }
            });
        }
        else {
            this.panel = Ext.create('Ext.panel.Panel', {
                title: this.title,
                closable: this.closable,
//                defaults: {margin: 30},
                style: this.style,
                overflowY: 'auto',
                items: [this.getForm()],
                border: this.border,
                bodyPadding: this.bodyPadding,
                header: this.headerConfig,
                listeners: {
                    beforeclose: function () {
                        _this.panel.up().remove(_this.panel, false);
                        console.log('closing');
                        return false;
                    }
                }
            });
        }
        this.panelId = this.panel.getId();
    }
    return this.panel;
};


GenericFormPanel.prototype.show = function () {
    if (typeof this.panel !== 'undefined') {
        this.panel.show();
    }
};

GenericFormPanel.prototype.hide = function () {
    if (typeof this.panel !== 'undefined') {
        this.panel.hide();
    }
};

GenericFormPanel.prototype.getForm = function () {
    if (this.form == null) {
        var items = this.getPanels();
        items.push(this.getJobPanel());

        this.form = Ext.create('Ext.form.Panel', {
            border: 0,
            width: this.width,
            height: this.height,
            autoScroll:true,
            trackResetOnLoad: true,
            bodyPadding: 5,
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            items: items,
            bbar: {
                layout: {
                    pack: 'end'
                },
                items: [
                    this.getRunButton()
                ]
            }
        });
    }

    return this.form;
};

GenericFormPanel.prototype.getPanels = function () {
    // To be implemented in inner class
};

GenericFormPanel.prototype.getJobPanel = function () {
    var _this = this;
    this.jobNameField = Ext.create('Ext.form.field.Text', {
        id: this.id + "jobname",
        name: "jobname",
        fieldLabel: 'Name',
        labelWidth: this.labelWidth,
        emptyText: "Job name",
        allowBlank: false
    });

    this.jobDescriptionField = Ext.create('Ext.form.field.TextArea', {
        id: this.id + "jobdescription",
        name: "jobdescription",
        labelWidth: this.labelWidth,
        fieldLabel: 'Description',
        emptyText: "Description"
    });

//	var bucketList= Ext.create('Ext.data.Store', {
//		fields: ['value', 'name'],
//		data : [
//		        {"value":"default", "name":"Default"}
//		       ]
//	});
//	var jobDestinationBucket = this.createCombobox("jobdestinationbucket", "Destination bucket", bucketList, 0, 100);
    var jobFolder = this.createOpencgaBrowserCmp({
        id: Utils.genId('jobFolder'),
        fieldLabel: 'Folder',
        dataParamName: 'outdir',
        mode: 'folderSelection',
        defaultFileLabel: 'Default job folder',
        allowBlank: true
    });

    var jobPanel = Ext.create('Ext.panel.Panel', {
        title: 'Job information',
        header: this.headerFormConfig,
        border: this.formBorder,
        bodyPadding: 10,
        defaults: {margin: '5 0 0 0'},
        buttonAlign: 'center',
        items: [this.jobNameField, this.jobDescriptionField/*, jobFolder*/] //TODO Job folder is not fully supported,
    });

    return jobPanel;
};

GenericFormPanel.prototype.getRunButton = function () {
    var _this = this;
    return Ext.create('Ext.button.Button', {
        text: 'Run',
        width: this.buttonConfig.width,
        height: this.buttonConfig.height,
        disabled: true,
        cls: 'btn btn-default',
        formBind: true, // only enabled if the form is valid
        handler: function () {
            _this.paramsWS = {};
            var formParams = _this.getForm().getForm().getValues();
            for (var param in formParams) {
                _this.paramsWS[param] = formParams[param];
            }
            _this.beforeRun();
            _this.run();
        }
    });
};

GenericFormPanel.prototype.setAccountParams = function () {
    this.paramsWS["sessionid"] = $.cookie('bioinfo_sid');
    this.paramsWS["accountid"] = $.cookie('bioinfo_account');
};

GenericFormPanel.prototype.beforeRun = function () {
    // To be implemented in inner class

};

GenericFormPanel.prototype.run = function () {

    delete this.paramsWS['browseFieldLabel'];

    this.setAccountParams();

    if (this.paramsWS['outdir'] === '') {
        delete this.paramsWS['outdir']
    }

    if (!this.testing) {
        OpencgaManager.runAnalysis({
            analysis: this.analysis,
            paramsWS: this.paramsWS,
            success: this.runAnalysisSuccess
        });
        this.trigger('after:run', {sender: this});
    } else {
        console.log("@@ Watch out!!! testing flag is on, so job will not launched.")
    }
    //debug
    console.log("@@ Form paramsWS")
    console.log(this.paramsWS);

};

GenericFormPanel.prototype.clean = function () {
    var items = this.form.query('field');
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        item.reset();
    }
};


/////////////////////////////////////////
/////////////////////////////////////////
//Functions to create sencha components//
/////////////////////////////////////////
/////////////////////////////////////////
GenericFormPanel.prototype.createCombobox = function (name, label, data, defaultValue, labelWidth, margin) {
    return Ext.create('Ext.form.field.ComboBox', {
        id: name,
        name: name,
        fieldLabel: label,
        store: data,
        queryMode: 'local',
        displayField: 'name',
        valueField: 'value',
        value: data.getAt(defaultValue).get('value'),
        labelWidth: labelWidth,
        margin: margin,
        editable: false,
        allowBlank: false
    });
};

GenericFormPanel.prototype.createCheckBox = function (name, label, checked, margin, disabled, handler) {
    return Ext.create('Ext.form.field.Checkbox', {
        id: name,
        name: name,
        boxLabel: label,
        checked: (checked || false),
        disabled: disabled,
        margin: (margin || '0 0 0 0')
    });
};

GenericFormPanel.prototype.createRadio = function (name, group, checked, hidden) {
    var cb = Ext.create('Ext.form.field.Radio', {
        id: name + "_" + this.id,
        boxLabel: name,
        inputValue: name,
        checked: checked,
        name: group,
        hidden: hidden
    });
    return cb;
};

GenericFormPanel.prototype.createLabel = function (text, margin) {
    var label = Ext.create('Ext.form.Label', {
        id: text + "_" + this.id,
        margin: (margin || "15 0 0 0"),
        html: '<span class="emph">' + text + '</span>'
    });
    return label;
};
GenericFormPanel.prototype.createTextFields = function (name) {
    var tb = Ext.create('Ext.form.field.Text', {
        id: name + "_" + this.id,
        fieldLabel: name,
        name: name
//		allowBlank: false
    });
    return tb;
};


GenericFormPanel.prototype.createOpencgaBrowserCmp = function (args) {//fieldLabel, dataParamName, mode, btnMargin, defaultFileLabel
    var _this = this;

    var field = Ext.create('Ext.form.field.Text', {
        id: args.id,
        fieldLabel: args.fieldLabel,
        labelAlign: args.labelAlign,
        labelWidth: _this.labelWidth,
        width:args.width,
        editable: false,
        name: 'browseFieldLabel',
        value: args.defaultFileLabel || "browse file...",
        allowBlank: (args.allowBlank || false),
        listeners: {
            focus: function () {
                if (args.beforeClick != null) {
                    args.beforeClick(args);
                }
                _this.opencgaBrowserWidget.once('select', function (response) {
                    if (typeof response !== 'undefined') {
                        field.setValue(response.id);
                        hiddenField.setValue(response.pathQuery);//this is send to the ws
                        if (args.onSelect) {
                            args.onSelect(response);
                        }
                    }
                });
                _this.opencgaBrowserWidget.show({mode: args.mode, allowedTypes: args.allowedTypes});
            }
        }
    });

    //not shown, just for validation
    var hiddenField = Ext.create('Ext.form.field.Text', {
        id: args.id + 'hidden',
        editable: false,
        hidden: true,
        name: args.dataParamName,
        value: "",
        allowBlank: (args.allowBlank || false)
    });

    return Ext.create('Ext.form.FieldContainer', {
        hidden: args.hidden,
        items: [
            field,
            hiddenField
        ]
    });
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function HeaderWidget(args) {

    _.extend(this, Backbone.Events);

    var _this = this;
    this.id = Utils.genId("HeaderWidget");

    this.target;
    this.autoRender = true;
    this.userData;

    this.appname = "My new App";
    this.description = '';
    this.suiteId = -1;
    this.checkTimeInterval = 5000;
    this.version = '';
    this.allowLogin = true;
    this.allowJobs = true;
    this.width;
    this.height = 60;
    this.chunkedUpload = false;
    this.enableTextModeUW = true; // Enable Text Mode in the Upload Widget

    this.applicationMenuEl;

    this.homeLink = ".";
    this.helpLink = ".";
    this.tutorialLink = ".";
    this.aboutHTML = ".";


    //set instantiation args, must be last
    _.extend(this, args);

    this.els = {};

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }
}

HeaderWidget.prototype = {
    render: function () {
        var _this = this;

        var appLi = '';
        if (this.applicationMenuEl) {
//            appLi = '<li id="appMenu" class="menu"> &#9776; </li>';
            appLi = '<li id="appMenu" class="menu">&nbsp;<i class="fa fa-chevron-right"></i>&nbsp; <span class="">Menu</span></li>';
        }
        var jobsLi = '';
        if (this.allowJobs) {
            jobsLi = '<li id="jobs" class="right hidden"><i class="fa fa-tasks"></i> &nbsp;jobs</li>';
        }

        var navgationHtml = '' +
            '   <ul class="ocb-header">' +
            appLi +
            '       <li class="title"> &nbsp; ' + this.appname +
            '       </li>' +
            '       <li id="description" class="description">' + this.description +
            '       </li>' +
            '       <li id="support" class="right"> &nbsp; <i class="fa fa-support"></i>&nbsp;' +
            '       </li>' +
            '       <li id="signin" class="right"><i class="fa fa-sign-in"></i> &nbsp;sign in' +
            '       </li>' +
            appLi +
            '       <li id="profile" class="right hidden"><i class="fa fa-user"></i> &nbsp;profile' +
            '       </li>' +
            '       <li id="upload" class="right hidden"><i class="fa fa-cloud-upload"></i> &nbsp;upload & manage' +
            '       </li>' +
            //'       <li id="projects" class="right hidden"><i class="fa fa-folder"></i> &nbsp;projects' +
            //'       </li>' +
            '       <li id="logout" class="right hidden"><i class="fa fa-sign-out"></i> &nbsp;logout' +
            '       </li>' +
            '       <li id="user" class="right hidden text">' +
            '       </li>' +
            '   </ul>'
        ' ';

        var menuHtml = '' +
            '   <ul class="ocb-help-menu unselectable">' +
            '       <li id="homeHelp" class="right"><i class="fa fa-home"></i> &nbsp;home' +
            '       </li>' +
            '       <li id="documentation" class="right"><i class="fa fa-book"></i> &nbsp;documentation' +
            '       </li>' +
            '       <li id="tutorial" class="right"><i class="fa fa-list-alt"></i> &nbsp;tutorial' +
            '       </li>' +
            '       <li id="about" class="right"><i class="fa fa-info"></i> &nbsp; about' +
            '       </li>' +
            '   </ul>'
        '';


        this.div = $('<div class="ocb-header-widget unselectable">' + navgationHtml + '</div>')[0];
        $(this.div).css({
            height: this.height + 'px',
            position: 'relative'
        });

        this.supportMenuEl = $(menuHtml)[0];
        $(this.div).append(this.supportMenuEl);
//        $(this.supportMenuEl).mouseleave(function(){
//            $(_this.supportMenuEl).removeClass('ocb-help-menu-shown');
//        });

        if (this.applicationMenuEl) {
            $(this.div).append(this.applicationMenuEl);
//            $(this.applicationMenuDiv).mouseleave(function(){
//                $(_this.applicationMenuDiv).removeClass('ocb-app-menu-shown');
//            });

        }

        var els = $(this.div).find('ul').children();
        for (var i = 0; i < els.length; i++) {
            var elid = els[i].getAttribute('id');
            if (elid) {
                this.els[elid] = els[i];
            }
        }

        $(this.div).mouseleave(function () {
            _this.toogleSupportMenu(false);
        });
        $(this.div).click(function (e) {
            if (e.target === _this.els.support || e.target.parentNode === _this.els.support) {
                _this.toogleSupportMenu();
            } else {
                _this.toogleSupportMenu(false);
            }
        });

        $(this.els.appMenu).click(function () {
            _this.toogleAppMenu();
        });

        $(this.els.homeHelp).click(function () {
            window.location.href = _this.homeLink;
        });
        $(this.els.documentation).click(function () {
            window.open(_this.helpLink);
        });
        $(this.els.tutorial).click(function () {
            window.open(_this.tutorialLink);
        });
        $(this.els.about).click(function () {
            _this.trigger('about:click', {sender: _this});

//            Ext.create('Ext.window.Window', {
//                id: _this.id + "aboutWindow",
//                bodyStyle: 'background:#fff; color:#333;',
//                bodyPadding: 10,
//                title: 'About',
//                height: 340,
//                width: 500,
//                modal: true,
//                layout: 'fit',
//                html: _this.aboutText
//            }).show();
        });


        /* Element handlers */
        //TODO check !this.allowLogin,
        $(this.els.signin).click(function () {
            _this.loginWidget.show();
        });
        $(this.els.logout).click(function () {
            OpencgaManager.users.logout({
                id: Cookies('bioinfo_user'),
                query: {
                    sid: Cookies('bioinfo_sid')
                },
                request: {
                    success: _this.logoutSuccess,
                    error: _this.logoutSuccess
                }
            });

            //Delete all cookies
            Cookies.expire('bioinfo_sid');
            Cookies.expire('bioinfo_user');
            _this.sessionFinished();
            _this.trigger('logout', {sender: this});

        });
        $(this.els.profile).click(function () {
            _this.profileWidget.show();
        });
        $(this.els.upload).click(function () {
            _this.opencgaBrowserWidget.show({mode: "manager"});
        });
        $(this.els.jobs).click(function () {
            _this.trigger('jobs:click', {sender: _this});
//            $(_this.els.jobs).toggleClass('active');
        });
        $(this.els.projects).click(function () {
            _this.trigger('projects:click', {sender: _this});
//            $(_this.els.jobs).toggleClass('active');
        });
        /****************************************/
        this.logoutSuccess = function (response) {
            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                console.log(response);
            }
        };

        this.getUserInfoSuccess = function (response) {
            if ((response.response[0].errorMsg === '' || response.response[0].errorMsg == null) && response.response[0].result.length > 0) {
                _this.setUserData(response.response[0].result[0]);
                _this.trigger('user:change', {sender: this, response: response.response[0].result[0]});
                console.log("userData has been modified since last call");
            }
        };
        /****************************************/

        /* Login Widget */
        this.loginWidget = this._createLoginWidget();

        /* Profile Widget */
        this.profileWidget = this._createProfileWidget();

        /* Opencga Browser Widget */
        this.opencgaBrowserWidget = this._createOpencgaBrowserWidget();

        this.projectBrowser = this._createProjectBrowser();

        this.rendered = true;
    },
    draw: function () {
        var _this = this;
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }

        this.targetDiv.appendChild(this.div);

        this.loginWidget.draw();
        this.profileWidget.draw();
        this.opencgaBrowserWidget.draw();

        if (Cookies('bioinfo_sid') != null) {
            this.sessionInitiated();
        } else {
            this.sessionFinished();
        }

    },
    getHeight: function () {
        return this.height;
    },
    toogleAppMenu: function (value) {
        if (this.applicationMenuEl) {
            if (value === true) {
                $(this.applicationMenuEl).addClass('ocb-app-menu-shown');
                $(this.els.appMenu).children('i').removeClass('fa-chevron-right');
                $(this.els.appMenu).children('i').addClass('fa-chevron-left');
            } else if (value === false) {
                $(this.applicationMenuEl).removeClass('ocb-app-menu-shown');
                $(this.els.appMenu).children('i').addClass('fa-chevron-right');
                $(this.els.appMenu).children('i').removeClass('fa-chevron-left');
            } else {
                $(this.applicationMenuEl).toggleClass('ocb-app-menu-shown');
                $(this.els.appMenu).children('i').toggleClass('fa-chevron-right');
                $(this.els.appMenu).children('i').toggleClass('fa-chevron-left');
            }

        }
    },
    toogleSupportMenu: function (value) {
        if (this.supportMenuEl) {
            if (value === true) {
                $(this.supportMenuEl).addClass('ocb-help-menu-shown');
            } else if (value === false) {
                $(this.supportMenuEl).removeClass('ocb-help-menu-shown');
            } else {
                $(this.supportMenuEl).toggleClass('ocb-help-menu-shown');
            }

        }
    },
    _createLoginWidget: function () {
        var _this = this;
        var loginWidget = new LoginWidget({
            suiteId: this.suiteId,
            autoRender: true,
            handlers: {
                'session:initiated': function () {
                    _this.sessionInitiated();
                    _this.trigger('login', {sender: this});
                }
            }
        });
        return loginWidget;
    },
    _createProfileWidget: function () {
        var profileWidget = new ProfileWidget({
            autoRender: true
        });
        return profileWidget;
    },
    _createOpencgaBrowserWidget: function () {
        var _this = this;
        var opencgaBrowserWidget = new OpencgaBrowserWidget({
            suiteId: this.suiteId,
            chunkedUpload: this.chunkedUpload,
            enableTextModeUW: this.enableTextModeUW,
            autoRender: true,
            handlers: {
                'need:refresh': function () {
                    _this.getUserInfo();
                }
            }
        });
        return opencgaBrowserWidget;
    },
    _createProjectBrowser: function () {
        var projectBrowser = document.createElement('jso-project-browser');
        return projectBrowser;
    },


//    _createPanel: function (targetId) {
//        var _this = this;
//        switch (this.suiteId) {
//            case 11://Renato
//                this.homeLink = "http://renato.bioinfo.cipf.es";
//                this.helpLink = "http://bioinfo.cipf.es/docs/renato/";
//                this.tutorialLink = "http://bioinfo.cipf.es/docs/renato/tutorial";
//                this.aboutText = '';
//                break;
//            case 6://Variant
//                this.homeLink = "http://variant.bioinfo.cipf.es";
//                this.helpLink = "http://docs.bioinfo.cipf.es/projects/variant";
//                this.tutorialLink = "http://docs.bioinfo.cipf.es/projects/variant/wiki/Tutorial";
//                this.aboutText = '';
//                break;
//            case 9://GenomeMaps
//                this.homeLink = "http://www.genomemaps.org";
//                this.helpLink = "http://wiki.opencb.org/projects/visualization/doku.php?id=genome-maps:overview";
//                this.tutorialLink = "http://wiki.opencb.org/projects/visualization/doku.php?id=genome-maps:tutorial";
//                this.aboutText = 'Genome Maps is built with open and free technologies like HTML5 and SVG inline, ' +
//                    'so no plug-in is needed in modern internet browsers. We’ve focused on providing the ' +
//                    'best user experience possible with a modern drag navigation and many features included.<br><br>' +
//                    'Genome Maps project has been developed in the <b>Computational Biology Unit</b> led by <b>Ignacio Medina</b>, at <b>Computational Genomic' +
//                    ' Institute</b> led by <b>Joaquin Dopazo</b> at CIPF. Two people from my lab deserve special mention for their fantastic job done: ' +
//                    '<br><b>Franscisco Salavert</b> and <b>Alejandro de Maria</b>.<br><br>' +
//                    'Genome Maps has been designed to be easily be embedded in any project with a couple of lines of code,' +
//                    ' and it has been implemented as a plugin framework to extend the standard features.<br><br>' +
//                    'Supported browsers include: Google Chrome 14+, Apple Safari 5+, Opera 12+ and Mozilla Firefox 14+ ' +
//                    '(works slower than in the other browsers). Internet Explorer 10 is under RC and seems to work properly.<br><br>' +
//                    'For more information or suggestions about Genome Maps please contact <br><b>Ignacio Medina</b>:  <span class="info">imedina@cipf.es</span>'
//                break;
//            case 10://CellBrowser
//                this.homeLink = "http://www.cellbrowser.org";
//                this.helpLink = "http://docs.bioinfo.cipf.es/projects/cellbrowser";
//                this.tutorialLink = "http://docs.bioinfo.cipf.es/projects/cellbrowser/wiki/Tutorial";
//                this.aboutText = '';
//                break;
//            case 12://UNTBgen
//                this.homeLink = "http://bioinfo.cipf.es/apps/untbgen";
//                this.helpLink = "http://bioinfo.cipf.es/ecolopy/";
//                this.tutorialLink = "http://bioinfo.cipf.es/ecolopy/";
//                this.aboutText = '';
//                break;
//            case 22://Pathiways
//                this.homeLink = "http://pathiways.bioinfo.cipf.es";
//                this.helpLink = "http://bioinfo.cipf.es/pathiways";
//                this.tutorialLink = "http://bioinfo.cipf.es/pathiways/tutorial";
//                this.aboutText = 'PATHiWAYS is built with open and free technologies like HTML5 and SVG inline, ' +
//                    'so no plug-in is needed in modern internet browsers<br><br>' +
//                    'PATHiWAYS project has been developed in the <b>Computational Biology Unit</b>, at <b>Computational Medicine' +
//                    ' Institute</b> at CIPF in Valencia, Spain.<br><br>' +
//                    'For more information please visit our web page  <span class="info"><a target="_blank" href="http://bioinfo.cipf.es">bioinfo.cipf.es</a></span>';
//                break;
//            case 85: //BierApp
//                this.homeLink = "http://bioinfo.cipf.es/apps/bierapp/";
//                this.helpLink = "https://github.com/babelomics/bierapp/wiki";
//                this.tutorialLink = "https://github.com/babelomics/bierapp/wiki/Tutorial";
//                this.aboutText = 'BiERApp is an interactive tool that allows finding genes affected by deleterious variants that segregate along family pedigrees, case-controls or sporadic samples. BiERApp has built with open and free technologies like HTML5 and Javascript.<br><br>' +
//                    'BierApp project is a joint development of the <b>BiER</b> and the <b>Computational Biology Unit</b>, in the <b>Computational Genomics Department</b> at CIPF in Valencia, Spain.<br><br>' + 'For more information please visit our web page  <span class="info"><a target="_blank" href="http://bioinfo.cipf.es">bioinfo.cipf.es</a></span> <br><br>' +
//                    '<img width="25%" src="http://bioinfo.cipf.es/bierwiki/lib/tpl/arctic/images/logobier.jpg">'
//                ;
//                break;
//
//            case 86: // TEAM
//                this.homeLink = "http://bioinfo.cipf.es/apps/team/";
//                this.helpLink = "https://github.com/babelomics/team/wiki";
//                this.tutorialLink = "https://github.com/babelomics/team/wiki/Tutorial";
//                this.aboutText = 'TEAM (Targeted Enrichment Analysis and Management) is an open web-based tool for the design and management of panels of genes for targeted enrichment and massive sequencing for diagnostic applications. <br> TEAM has been built with open and free technologies like HTML5 and Javascript.<br><br>' +
//                    'TEAM project is a joint development of the <b>BiER</b> and the <b>Computational Biology Unit</b>, in the <b>Computational Genomics Department</b> at CIPF in Valencia, Spain.<br><br>' + 'For more information please visit our web page  <span class="info"><a target="_blank" href="http://bioinfo.cipf.es">bioinfo.cipf.es</a></span> <br><br>' +
//                    '<img width="25%" src="http://bioinfo.cipf.es/bierwiki/lib/tpl/arctic/images/logobier.jpg">'
//                ;
//                break;
//
//            default:
//                this.homeLink = "http://docs.bioinfo.cipf.es";
//                this.helpLink = "http://docs.bioinfo.cipf.es";
//                this.tutorialLink = "http://docs.bioinfo.cipf.es";
//                this.aboutText = '';
//        }
//
//        if (typeof HEADER_HOME_LINK !== 'undefined') {
//            this.homeLink = HEADER_HOME_LINK;
//        }
//        if (typeof HEADER_HELP_LINK !== 'undefined') {
//            this.helpLink = HEADER_HELP_LINK;
//        }
//        if (typeof HEADER_TUTORIAL_LINK !== 'undefined') {
//            this.tutorialLink = HEADER_TUTORIAL_LINK;
//        }
//        if (typeof HEADER_ABOUT_HTML !== 'undefined') {
//            this.aboutText = HEADER_ABOUT_HTML;
//        }
//
//        var linkbar = new Ext.create('Ext.toolbar.Toolbar', {
//            id: this.id + 'linkbar',
//            dock: 'top',
//            cls: 'bio-linkbar',
//            height: 40,
//            minHeight: 40,
//            maxHeight: 40,
//            items: [
//                {
//                    xtype: 'tbtext',
//                    id: this.id + "speciesTextItem",
//                    text: ''
//                },
//                {
//                    xtype: 'tbtext',
//                    id: this.id + "assemblyTextItem",
//                    text: ''
//                },
//                '->',
////                {
////                    id: this.id + "homeButton",
////                    text: 'home',
////                    handler: function () {
////                        window.location.href = _this.homeLink;
////                    }
////                },
////                {
////                    id: this.id + "helpButton",
////                    text: 'documentation',
////                    handler: function () {
////                        window.open(_this.helpLink);
////                    }
////                },
////                {
////                    id: this.id + "tutorialButton",
////                    text: 'tutorial',
////                    handler: function () {
////                        window.open(_this.tutorialLink);
////                    }
////                },
////                {
////                    id: this.id + "aboutButton",
////                    text: 'about',
////                    handler: function () {
////                        Ext.create('Ext.window.Window', {
////                            id: _this.id + "aboutWindow",
////                            bodyStyle: 'background:#fff; color:#333;',
////                            bodyPadding: 10,
////                            title: 'About',
////                            height: 340,
////                            width: 500,
////                            modal: true,
////                            layout: 'fit',
////                            html: _this.aboutText
////                        }).show();
////                    }
////                }
//            ]
//        });
//
//        var userbar = new Ext.create('Ext.toolbar.Toolbar', {
//            id: this.id + 'userbar',
//            dock: 'top',
//            border: false,
////                cls:'bio-userbar',
//            cls: 'gm-login-bar',
//            height: 27,
//            minHeight: 27,
//            maxHeight: 27,
//            layout: 'hbox',
//            items: [
//                {
//                    xtype: 'tbtext',
//                    id: this.id + 'textNews',
//                    text: this.news
//                },
//                '->',
//                {
//                    xtype: 'tbtext',
//                    id: this.id + 'textUser',
//                    text: ''
//                },
////                    {
////                        id: this.id + 'btnOpencga',
////                        text: '<span class="emph">Upload & Manage</span>',
////                        iconCls: 'icon-project-manager',
////                        handler: function () {
////                            _this.opencgaBrowserWidget.show({mode: "manager"});
////                        }
////                    },
////                {
////                    id: this.id + 'btnSignin',
////                    disabled: !this.allowLogin,
////                    text: '<span class="emph">sign in</span>',
////                    handler: function () {
////                        _this.loginWidget.show();
////                    }
////                },
////                    {
////                        id: this.id + 'btnEdit',
////                        text: '<span class="emph">profile</span>',
////                        handler: function () {
////                            _this.profileWidget.show();
////                        }
////                    },
////                {
////                    id: this.id + 'btnLogout',
////                    text: '<span class="emph">logout</span>',
////                    handler: function () {
////                        OpencgaManager.logout({
////                            userId: $.cookie('bioinfo_user'),
////                            sessionId: $.cookie('bioinfo_sid'),
////                            success: _this.logoutSuccess,
////                            error: _this.logoutSuccess
////                        });
////                    }
////                }
//            ]
//        });
//
//        var panel = Ext.create('Ext.panel.Panel', {
//            id: this.id + "panel",
//            region: 'north',
//            border: false,
//            renderTo: targetId,
//            height: this.height,
//            minHeight: this.height,
//            maxHeigth: this.height,
//            width: this.width,
//            layout: 'hbox',
//            items: [
//                {
//                    xtype: 'container',
////                    flex:1,
//                    items: [
//                        {
//                            id: this.id + "appTextItem",
//                            xtype: 'tbtext',
//                            margin: '25 0 0 20',
//                            //		        	html: '<span class="appName">Vitis vinifera&nbsp; '+this.args.appname +'</span> <span class="appDesc">'+this.args.description+'</span>&nbsp;&nbsp;&nbsp;&nbsp;<span><img height="30" src="http://www.demeter.es/imagenes/l_demeter.gif"></span>',
//                            text: '<span class="appName">' + this.appname + '</span> ' +
//                                '<span id="' + this.id + 'description" class="appDesc">' + this.description + '</span>' +
//                                '<span id="' + this.id + 'version" class="appVersion"></span>' +
//                                '',
//                            padding: '0 0 0 10',
//                            listeners: {
//                                afterrender: function () {
//                                    $("#" + _this.id + "appTextItem").qtip({
//                                        content: '<span class="info">' + _this.version + '</span>',
//                                        position: {my: "bottom center", at: "top center", adjust: { y: 12, x: -25 }}
//
//                                    });
//                                }
//                            }
//                        }
//                    ]
//                },
//                {
//                    xtype: 'container',
//                    flex: 2,
//                    layout: {type: 'vbox', align: 'right'},
//                    items: [userbar, linkbar]
//                }
//            ]
//        });
//        return panel;
//    },

    setUserData: function (data) {
        this.userData = data;
        this.opencgaBrowserWidget.setUserData(data);
        console.log(data)
        this.projectBrowser.projectList = data.projects;
    },
    getUserInfo: function () {
        var lastActivity = null;
        if (this.userData != null) {
            lastActivity = this.userData.lastActivity;
        }
        var user = Cookies('bioinfo_user');
        if (!user) {
            console.log('cookie: bioinfo_user, is not set, session will be finished...');
            this.sessionFinished();
        } else {
            OpencgaManager.users.read({
                id: user,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    lastActivity: lastActivity
                },
                request: {
                    success: this.getUserInfoSuccess,
                    error: this.logoutSuccess
                }
            });
        }

    },
    _getUserText: function () {
        var nameToShow = Cookies('bioinfo_user');
        if (nameToShow.indexOf('anonymous_') != -1) {
            nameToShow = 'anonymous';
        }
        return '<span style="color:darkred">' + nameToShow + '</span>'
    },
    sessionInitiated: function () {
        var _this = this;
        this.els.user.innerHTML = this._getUserText();
//        /**HIDE**/
        this.loginWidget.hide();
        $(this.els.signin).addClass('hidden');
//        /**SHOW**/
        $(this.els.logout).removeClass('hidden');
        $(this.els.profile).removeClass('hidden');
        $(this.els.upload).removeClass('hidden');
        $(this.els.projects).removeClass('hidden');
        $(this.els.user).removeClass('hidden');
        $(this.els.jobs).removeClass('hidden');


        /**START OPENCGA CHECK**/
        if (!this.userInfoInterval) {
            this.getUserInfo();//first call
            this.userInfoInterval = setInterval(function () {
                _this.getUserInfo();
            }, this.checkTimeInterval);
        }
    },
    sessionFinished: function () {
//        /**HIDE**/
        $(this.els.logout).addClass('hidden');
        $(this.els.profile).addClass('hidden');
        $(this.els.upload).addClass('hidden');
        $(this.els.projects).addClass('hidden');
        $(this.els.user).addClass('hidden');
        $(this.els.jobs).addClass('hidden');
//        /**SHOW**/
        $(this.els.signin).removeClass('hidden');
        $(this.els.user).html('');
        $(this.els.user).removeClass('hidden');
//        /**CLEAR OPENCGA**/
        clearInterval(this.userInfoInterval);
        delete this.userInfoInterval;

        this.profileWidget.hide();
        this.opencgaBrowserWidget.hide();
        this.opencgaBrowserWidget.removeUserData();
    },
    setDescription: function (text) {
        $(this.els.description).html(text);
    },
    setWidth: function (width) {
        this.width = width;
    }

};



/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function JobListWidget(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    this.id = Utils.genId("JobListWidget");

    this.target;
    this.autoRender = true;

    this.RUNING_COLOR = '#298c63';
    this.QUEUED_COLOR = 'Darkorange';
    this.FINISHED_COLOR = '#0068cc';
    this.ERROR_COLOR = '#b30000';

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.buttonFilterFunction = null;
    this.textFilterFunction = function (item) {
        var str = _this.searchField.getValue().toLowerCase();
        if (item.data.name.toLowerCase().indexOf(str) < 0) {
            return false;
        }
        return true;
    };

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }
};


JobListWidget.prototype = {
    render: function () {
        var _this = this;
        this.div = $('<div></div>')[0];

        this.panel = this._createPanel();

    },
    draw: function () {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.panel.render(this.div);
    },
    show: function () {
        this.panel.show()
    },
    hide: function () {
        this.panel.hide();
    },
    toggle: function () {
        if (this.panel.isVisible()) {
            this.panel.hide();
        } else {
            this.panel.show();
        }
    },
    setAccountData: function (data) {
        this.accountData = data;
        var jobs = [];
        var job;
        for (var i = 0; i < this.accountData.projects.length; i++) {
            for (var j = 0; j < this.accountData.projects[i].jobs.length; j++) {
                job = this.accountData.projects[i].jobs[j];
                if (typeof this.tools[job.toolName] !== 'undefined') {
                    job.date = Utils.parseDate(job.date);
                    jobs.push(job);
                }

            }
        }
        this.store.loadData(jobs);
        this._updateButtons(jobs);
    },
    _createPanel: function () {
        var _this = this;
        var tpl = new Ext.XTemplate([
            '<tpl for=".">',
            '<div class="ocb-job-list-widget-item">',

            '<div style="color:#596F8F">{[ this.getNewIcon(values) ]} {name}</div>',
                '<div> ' +
                '<span class="{[ this.getClass(values) ]}">{toolName}{execution} </span> ' +
                '</div>',
                '<div>' +
                '<span style="color: {[ this.getStatusColor(values) ]};">{status}</span> ' +
                '<span style="color: dimgray;font-size:12px;"> &nbsp; &nbsp; {date} </span> ' +
                '</div>',
            '</div>',
            '</tpl>',
            {
                getStatusColor: function (item) {
                    var color = '#000000';
                    switch (item.status) {
                        case 'running':
                            color = _this.RUNING_COLOR;
                            break;
                        case 'finished':
                            color = _this.FINISHED_COLOR;
                            break;
                        case 'queued':
                            color = _this.QUEUED_COLOR;
                            break;
                        case 'execution_error':
                        case 'queue_error':
                            color = _this.ERROR_COLOR;
                            break;
                    }
                    return color;
                }
            },
            {
                getNewIcon: function (item) {
                    var html = '';
                    if (item.visites === 0) {
                        html += '<i style="color:' + _this.FINISHED_COLOR + '" class="fa fa-exclamation-circle"></i> ';
                    }
                    switch (item.status) {
                        case 'running':
                            html += '<i style="color:' + _this.RUNING_COLOR + '" class="fa fa-cog"></i>';
                            break;
                        case 'queued':
                            html += '<i style="color:' + _this.QUEUED_COLOR + '" class="fa fa-clock-o"></i>';
                            break;
                        case 'finished':
                            html += '<i style="color:' + _this.FINISHED_COLOR + '" class="fa fa-check-circle"></i>';
                            break;
                        case 'execution_error':
                        case 'queue_error':
                            html += '<i style="color:' + _this.ERROR_COLOR + '" class="fa fa-times-circle"></i>';
                            break;
                    }
                    return html;
                }
            },
            {
                getClass: function (item) {
                    return item.toolName.replace('.', '_');
                }
            }
        ]);

        this.store = Ext.create('Ext.data.Store', {
            fields: ['commandLine', 'date', 'description', 'diskUsage', 'status', 'finishTime', 'inputData', 'jobId', 'message', 'name', 'outputData', 'ownerId', 'percentage', 'projectId', 'toolName', 'visites'],
            sorters: [
                { property: 'date', direction: 'DESC'}
            ],
            autoLoad: false
        });

        var view = Ext.create('Ext.view.View', {
            padding: 15,
            store: this.store,
            tpl: tpl,
            trackOver: true,
            autoScroll: true,
            overItemCls: 'ocb-job-list-widget-item-hover',
            itemSelector: '.ocb-job-list-widget-item',
            listeners: {
                itemclick: function (este, record) {
                    console.log(record.data);
                    console.log(record.data.id);
                    _this.trigger('item:click', {sender: _this, item: record});
                },
                itemcontextmenu: function (este, record, item, index, e) {
                    e.stopEvent();
                    var event = {sender: _this, record: record, originalEvent: e};
                    _this._itemContextMenuHandler(event);
                    _this.trigger('item:contextmenu', event);
                    return false;
                }
            }
        });

        /**TEXT SEARCH FILTER**/
        this.searchField = Ext.create('Ext.form.field.Text', {
            emptyText: 'search...',
            enableKeyEvents: true,
            flex: 1,
            listeners: {
                change: function () {
                    _this._setFilters();
                }
            }
        });


        //    this.projectFilterButton = Ext.create("Ext.button.Button", {
//        id: this.btnActivePrjId,
//        iconCls: 'icon-project-all',
//        tooltip: 'Toggle jobs from all projects or active project',
//        enableToggle: true,
//        pressed: false,
//        listeners: {
//            toggle: function () {
//                //_this.selectProjectData();
//                _this.render();
//            }
//        }
//    });


        this.btnAllId = this.id + "_btnAll";
//        this.btnActivePrjId = this.id + "_btnActivePrj";
        this.btnFinishedId = this.id + "_btnFinished";
        this.btnVisitedId = this.id + "_btnVisited";
        this.btnRunningId = this.id + "_btnRunning";
        this.btnQueuedId = this.id + "_btnQueued";
        this.btnErrorId = this.id + "_btnError";

        var panel = Ext.create('Ext.panel.Panel', {
            height: '80vh',
            width: '250px',
            layout: 'fit',
            items: [
                view
            ],
            dockedItems: [
                {
                    xtype: 'toolbar',
                    dock: 'top',
                    height: 40,
                    items: [
                        {
                            xtype: 'button',
                            id: this.id + 'btnSort',
                            tooltip: 'Change order',
                            text: '<i class="fa fa-sort"></i>',
                            handler: function () {
                                if (_this.sort == "DESC") {
                                    _this.sort = "ASC";
                                    _this.store.sort('date', 'ASC');
                                }
                                else {
                                    _this.sort = "DESC";
                                    _this.store.sort('date', 'DESC');
                                }
                            }
                        },
                        {
                            xtype: 'button',
                            id: this.id + 'btnClear',
//							    iconCls: 'icon-delete',
                            text: '<i class="fa fa-eraser"></i>',
                            tooltip: 'Clear search box',
                            handler: function () {
                                _this.searchField.setValue('');
                            }
                        },
                        this.searchField,

                    ]
                },
                {
                    xtype: 'toolbar',
                    docked: 'top',
                    height: 39,
                    items: [
                        //this.projectFilterButton,
                        {
                            id: this.btnAllId,
                            text: ' ',
                            tooltip: 'Total jobs',
                            handler: function () {
                                _this._setButtonFilterFunction(this);
                            }
                        },
                        {
                            id: this.btnFinishedId,
                            text: ' ',
                            tooltip: 'Finished jobs',
                            handler: function () {
                                _this._setButtonFilterFunction(this);
                            }
                        },
                        {
                            id: this.btnVisitedId,
                            text: ' ',
                            tooltip: 'Visited jobs',
                            handler: function () {
                                _this._setButtonFilterFunction(this);
                            }
                        },
                        {
                            id: this.btnRunningId,
                            text: ' ',
                            tooltip: 'Running jobs',
                            handler: function () {
                                _this._setButtonFilterFunction(this);
                            }
                        },
                        {
                            id: this.btnQueuedId,
                            text: ' ',
                            tooltip: 'Queued jobs',
                            handler: function () {
                                _this._setButtonFilterFunction(this);
                            }
                        },
                        {
                            id: this.btnErrorId,
                            text: ' ',
                            tooltip: 'Error jobs',
                            handler: function () {
                                _this._setButtonFilterFunction(this);
                            }
                        }
                    ]
                }
            ]
        });

        return panel;
    },
    _setButtonFilterFunction: function (button) {
        switch (button.id) {
            case this.btnFinishedId:
                this.buttonFilterFunction = function (item) {
                    return item.data.visites == 0;
                };
                break;
            case this.btnVisitedId:
                this.buttonFilterFunction = function (item) {
                    return item.data.visites > 0 && item.data.status.indexOf('error') === -1;
                };
                break;
            case this.btnRunningId:
                this.buttonFilterFunction = function (item) {
                    return item.data.visites == -1;
                };
                break;
            case this.btnQueuedId:
                this.buttonFilterFunction = function (item) {
                    return item.data.visites == -2;
                };
                break;
            case this.btnErrorId:
                this.buttonFilterFunction = function (item) {
                    return item.data.status.indexOf('error') != -1;
                };
                break;
            default:
                this.buttonFilterFunction = null;
                break;
        }
        this._setFilters();
    },
    _setFilters: function () {
        this.store.clearFilter();
        if (typeof this.buttonFilterFunction === 'function') {
            this.store.addFilter([this.buttonFilterFunction, this.textFilterFunction]);
        } else {
            this.store.addFilter(this.textFilterFunction);
        }
    },
    _updateButtons: function (jobs) {
        var jobcount = this._getJobCounter(jobs);

        if (jobcount.all == 0) {
            Ext.getCmp(this.btnAllId).hide();
        } else {
            Ext.getCmp(this.btnAllId).show();
        }
        if (jobcount.finished == 0) {
            Ext.getCmp(this.btnFinishedId).hide();
        } else {
            Ext.getCmp(this.btnFinishedId).show();
        }
        if (jobcount.visited == 0) {
            Ext.getCmp(this.btnVisitedId).hide();
        } else {
            Ext.getCmp(this.btnVisitedId).show();
        }
        if (jobcount.running == 0) {
            Ext.getCmp(this.btnRunningId).hide();
        } else {
            Ext.getCmp(this.btnRunningId).show();
        }
        if (jobcount.queued == 0) {
            Ext.getCmp(this.btnQueuedId).hide();
        } else {
            Ext.getCmp(this.btnQueuedId).show();
        }
        if (jobcount.error == 0) {
            Ext.getCmp(this.btnErrorId).hide();
        } else {
            Ext.getCmp(this.btnErrorId).show();
        }

        Ext.getCmp(this.btnAllId).setText(jobcount.all);
        Ext.getCmp(this.btnFinishedId).setText('<i style="color:' + this.FINISHED_COLOR + '" class="fa fa-exclamation-circle"></i> ' + jobcount.finished);
        Ext.getCmp(this.btnVisitedId).setText('<i style="color:' + this.FINISHED_COLOR + '" class="fa fa-check-circle"></i> ' + jobcount.visited);
        Ext.getCmp(this.btnRunningId).setText('<i style="color:' + this.RUNING_COLOR + '" class="fa fa-cog"></i> ' + jobcount.running);
        Ext.getCmp(this.btnQueuedId).setText('<i style="color:' + this.QUEUED_COLOR + '" class="fa fa-clock-o"></i> ' + jobcount.queued);
        Ext.getCmp(this.btnErrorId).setText('<i style="color:' + this.ERROR_COLOR + '" class="fa fa-times-circle"></i> ' + jobcount.error);
    },
    _getJobCounter: function (jobs) {
        var finished = 0;
        var visited = 0;
        var running = 0;
        var queued = 0;
        var error = 0;

        for (var i = 0; i < jobs.length; i++) {
            var job = jobs[i];
            if (job.visites > 0) {
                if (job.status.indexOf('error') != -1) {
                    error++;
                } else {
                    visited++;
                }
            } else {
                if (job.visites == 0) {
                    if (job.status.indexOf('error') != -1) {
                        error++;
                    } else {
                        finished++;
                    }
                }
                if (job.visites == -1) {
                    running++;
                }
                if (job.visites == -2) {
                    queued++;
                }
            }
        }
        return {all: jobs.length, visited: visited, finished: finished, running: running, queued: queued, error: error};
    },
    _itemContextMenuHandler: function (e) {
        var record = e.record;
        var contextMenu = Ext.create('Ext.menu.Menu', {
            plain: true,
            items: [
                {
                    text: 'Delete Job',
                    icon: Utils.images.del,
                    handler: function (w, e) {
                        if (record) {
                            Ext.Msg.confirm("Delete job", "Are you sure you want to delete this job?", function (btnClicked) {
                                if (btnClicked == "yes") {
                                    OpencgaManager.deleteJob({
                                        accountId: $.cookie('bioinfo_account'),
                                        sessionId: $.cookie('bioinfo_sid'),
                                        jobId: record.data.id,
                                        success: function (response) {
                                            if (response.errorMsg === '') {
                                                Utils.msg('Delete job', '</span class="emph">' + response.result[0].msg + '</span>');
                                            } else {
                                                Ext.Msg.alert('Delete job, try again later.', response.errorMsg);
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    }
                }
            ]
        });
        contextMenu.showAt(e.originalEvent.getXY());
    }
};

/////*HARDCODED check job status*/
////	var checkJobsStatus = function(){
////		if(_this.accountData != null){
////			var opencgaManager = new OpencgaManager();
////			for ( var i = 0; i < _this.accountData.jobs.length; i++) {
////				if(_this.tools.indexOf(_this.accountData.jobs[i].toolName) != -1){
////					if(_this.accountData.jobs[i].visites<0){
////						opencgaManager.jobStatus($.cookie("bioinfo_account"), $.cookie("bioinfo_sid"), _this.accountData.jobs[i].id);
////					}
////				}
////			}
////		}
////	}
////
////	this.accountInfoInterval = setInterval(function(){checkJobsStatus();}, 4000);
////
/////*HARDCODED check job status*/


/**Filters**/
//var functionAssertion = function(item){return item.data.visites > 2;};

//JobListWidget.prototype.selectProjectData = function () {
//    if (!this.projectFilterButton.pressed) {
//        for (var i = 0; i < this.allData.length; i++) {
//            if (this.allData[i].active) {
//                this.data = this.allData[i].jobs;
//                break;
//            }
//        }
//    } else {
//        var allJobs = new Array();
//        for (var i = 0; i < this.allData.length; i++) {
//            if (this.allData[i].jobs != null) {
//                for (var j = 0; j < this.allData[i].jobs.length; j++) {
//
//                    //TODO care with date order
//                    allJobs.push(this.allData[i].jobs[j]);
//                }
//            }
//        }
//        this.data = allJobs;
//    }
//    if (this.data == null) {
//        this.data = [];
//    }
//    this.pagedListViewWidget.draw(this.getData());
//};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function LoginWidget(args) {

    _.extend(this, Backbone.Events);
    this.id = Utils.genId("LoginWidget");

    this.suiteId;

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }
}

LoginWidget.prototype = {
    show: function () {
        this.panel.show();
    },
    hide: function () {
        this.panel.hide();
        this.ShowBack();
    },
    render: function () {
        var _this = this;

        /***************************/
        this.loginSuccess = function (response) {
            if (_this.panel != null) {
                _this.panel.setLoading(false);
            }
            console.log(response);
            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                Cookies.set('bioinfo_sid', response.response[0].result[0].sessionId);
                Cookies.set('bioinfo_user', response.response[0].result[0].userId);
                _this.trigger('session:initiated', {sender: _this});
            } else {
                Ext.getCmp(_this.labelEmailId).setText('<span class="err">' + response.response[0].errorMsg + '</span>', false);
                //Delete all cookies
                Cookies.expire('bioinfo_sid');
                Cookies.expire('bioinfo_user');
            }
        };

        this.createUserSuccess = function (response) {
            _this.panel.setLoading(false);

            if (response.response[0].errorMsg === '') {
                var userId = response.response[0].result[0].id;
                Ext.getCmp(_this.labelEmailId).setText('<span class="ok">' + userId + ' created</span>', false);
            } else {
                Ext.getCmp(_this.labelEmailId).setText('<span class="err">' + response.response[0].errorMsg + '</span>', false);
                //Delete all cookies
                Cookies.expire('bioinfo_sid');
                Cookies.expire('bioinfo_user');
            }
        };

        this.resetPasswordSuccess = function (response) {
            _this.panel.setLoading(false);
            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                Ext.getCmp(_this.labelEmailId).setText('<span class="emph">' + 'OK' + '</span>', false);
            } else {
                Ext.getCmp(_this.labelEmailId).setText('<span class="err">' + response.response[0].errorMsg + '</span>', false);
            }
        };

        /***************************/


        /**ID**/
        this.labelEmailId = this.id + "labelEmail";
        this.labelPassId = this.id + "labelPass";

        this.fldEmailId = this.id + "fldEmail";
        this.fldPasswordId = this.id + "fldPassword";
        this.fldNpass1Id = this.id + "fldNpass1";
        this.fldNpass2Id = this.id + "fldNpass2";

        this.btnSignId = this.id + "fldSign";
        this.btnAnonymousId = this.id + "btnAnonymous";
        this.btnForgotId = this.id + "btnForgot";
        this.btnNewaccId = this.id + "btnNewacc";

        this.btnSendId = this.id + "btnSend";
        this.btnBackId = this.id + "btnBack";

        this.btnRegisterId = this.id + "btnRegister";

        this.rendered = true;
    },
    draw: function () {
        var _this = this;
        if (!this.rendered) {
            console.info('Login Widget is not rendered yet');
            return;
        }

        /* Panel */
        this.panel = this._createPanel(this.targetId);
//        this.panel.show();
    },
    _createPanel: function (targetId) {
        var _this = this;

        var labelEmail = Ext.create('Ext.toolbar.TextItem', {
            id: this.labelEmailId,
            padding: 3,
            text: '<span class="info">Type your user ID and password</span>'
        });
        var pan = Ext.create('Ext.form.Panel', {
            id: this.id + "formPanel",
            bodyPadding: 20,
            height: 225,
            width: 350,
            border: 0,
            bbar: {items: [labelEmail]},
            items: [
                {
                    id: this.id + "userId",
                    xtype: 'textfield',
                    value: Cookies('bioinfo_user'),
                    fieldLabel: 'user ID',
                    hidden: false,
//		        enableKeyEvents: true,
                    listeners: {
                        scope: this,
                        change: this.checkUserId
                    }
                },
                {
                    id: this.fldPasswordId,
                    xtype: 'textfield',
                    fieldLabel: 'password',
                    inputType: 'password',
//		        emptyText:'please enter your password',
                    listeners: {
                        specialkey: function (field, e) {
                            if (e.getKey() == e.ENTER) {
                                _this.sign();
                            }
                        }
                    }
                },
                {
                    id: this.fldEmailId,
                    xtype: 'textfield',
                    fieldLabel: 'e-mail',
                    hidden: true,
//		        enableKeyEvents: true,
//		        emptyText:'please enter your email',
                    listeners: {
                        change: function () {
                            _this.checkemail();
                        },
                        specialkey: function (field, e) {
                            if (e.getKey() == e.ENTER) {
                                _this.sign();
                            }
                        }
                    }
                },
                {
                    id: this.id + "userName",
                    xtype: 'textfield',
                    fieldLabel: 'name',
                    hidden: true,
//		        enableKeyEvents: true,
                    listeners: {
                        scope: this,
                        change: this.checkName
                    }
                },
                {
                    id: this.fldNpass1Id,
                    xtype: 'textfield',
                    fieldLabel: 'password',
                    inputType: 'password',
                    hidden: true,
//		        enableKeyEvents: true,
                    listeners: {
                        scope: this,
                        change: this.checkpass
                    }
                },
                {
                    id: this.fldNpass2Id,
                    xtype: 'textfield',
                    fieldLabel: 're-password',
                    inputType: 'password',
                    hidden: true,
//		        enableKeyEvents: true,
                    listeners: {
                        scope: this,
                        change: this.checkpass
                    }
                },
                {
                    id: this.btnAnonymousId,
                    xtype: 'checkboxfield',
                    padding: "10 0 0 0",
                    boxLabel: 'Anonymous login <p class="tip s90">Your work will be lost after logout</p>',
                    margin: "0 0 0 50",
                    listeners: {
                        change: function (me, newValue, oldValue, eOpts) {
                            if (newValue) {
                                Ext.getCmp(_this.id + "userId").disable();
                                Ext.getCmp(_this.fldPasswordId).disable();
                            } else {
                                Ext.getCmp(_this.id + "userId").enable();
                                Ext.getCmp(_this.fldPasswordId).enable();
                            }
                        }
                    }
                }
            ]
        });

        var panel = Ext.create('Ext.window.Window', {
            id: this.id + "windowPanel",
            title: 'Sign in',
            resizable: false,
            minimizable: true,
            constrain: true,
            closable: false,
            modal: true,
            items: {
                border: 0,
                layout: { type: 'vbox', align: 'stretch'},
                items: [pan],
                bbar: {
                    layout: {
                        pack: 'center'
                    },
                    items: [
                        {
                            id: this.btnSignId,
                            text: 'Sign in'
                        },
                        {
                            id: this.btnForgotId,
                            text: 'Forgot yout password?'
                        },
                        {
                            id: this.btnNewaccId,
                            text: 'New user'
                        },
                        {
                            id: this.btnSendId,
                            text: 'Send',
                            hidden: true
                        },
                        {
                            id: this.btnRegisterId,
                            text: 'Register',
                            hidden: true
                        },
                        {
                            id: this.btnBackId,
                            text: 'Back',
                            hidden: true
                        }
                    ]
                }
            },
            listeners: {
                minimize: function () {
                    _this.panel.hide();
                }
            }
        });

        Ext.getCmp(this.btnForgotId).on('click', this.ShowForgot, this);
        Ext.getCmp(this.btnBackId).on('click', this.ShowBack, this);
        Ext.getCmp(this.btnNewaccId).on('click', this.ShowNewacc, this);

        Ext.getCmp(this.btnSignId).on('click', this.sign, this);
        Ext.getCmp(this.btnSendId).on('click', this.sendRecover, this);
        Ext.getCmp(this.btnRegisterId).on('click', this.register, this);
        Ext.getCmp(this.btnAnonymousId).on('change', this.anonymousSelected, this);

        return panel;
    }
};

LoginWidget.prototype.sign = function () {
    var _this = this;
    if (Ext.getCmp(this.btnAnonymousId).getValue()) {
        this.anonymousSign();
        this.panel.setLoading('Waiting server...');
    } else {
        if (this.checkUserId()) {
            OpencgaManager.users.login({
                id: this.getLogin(),
                query: {
                    password: this.getPassword()
                },
                request: {
                    success: this.loginSuccess
                }
            });
            this.panel.setLoading('Waiting server...');

            Cookies.set('bioinfo_user', this.getLogin());
        }
    }
};

LoginWidget.prototype.anonymousSign = function () {
    //TODO new opencga
    //OpencgaManager.login({
    //    userId: "anonymous",
    //    password: "",
    //    suiteId: this.suiteId,
    //    success: this.loginSuccess
    //});
};

LoginWidget.prototype.register = function () {
    if (this.checkUserId() && this.checkemail() && this.checkName() && this.checkpass()) {
        OpencgaManager.users.create({
            query: {
                userId: this.getLogin(),
                name: this.getUserName(),
                email: this.getEmail(),
                password: this.getPasswordReg()
            },
            request: {
                success: this.createUserSuccess
            }
        });
    } else {
        Ext.getCmp(this.labelEmailId).setText('<span class="info">Fill all fields</span>', false);
    }
};

LoginWidget.prototype.sendRecover = function () {
    if (this.checkUserId() && this.checkemail()) {
        OpencgaManager.users.resetPassword({
            id: this.getLogin(),
            query: {
                email: this.getEmail()
            },
            request: {
                success: this.resetPasswordSuccess
            }
        });
        this.panel.setLoading('Waiting server...');
    }
};

LoginWidget.prototype.getLogin = function () {
    return Ext.getCmp(this.id + "userId").getValue();
};
LoginWidget.prototype.getUserName = function () {
    return Ext.getCmp(this.id + "userName").getValue();
};
LoginWidget.prototype.getEmail = function () {
    return Ext.getCmp(this.fldEmailId).getValue();
};

LoginWidget.prototype.getPassword = function () {
    return CryptoJS.SHA1(Ext.getCmp(this.fldPasswordId).getValue()).toString();
};

LoginWidget.prototype.getPasswordReg = function () {
    return CryptoJS.SHA1(Ext.getCmp(this.fldNpass1Id).getValue()).toString();
};

//LoginWidget.prototype.draw = function () {
//    this.render();
//};

LoginWidget.prototype.ShowForgot = function () {
    Ext.getCmp(this.fldEmailId).reset();
    Ext.getCmp(this.fldEmailId).show();
    Ext.getCmp(this.fldPasswordId).reset();
    Ext.getCmp(this.btnAnonymousId).reset();
    Ext.getCmp(this.fldNpass1Id).reset();
    Ext.getCmp(this.fldNpass2Id).reset();

    Ext.getCmp(this.fldPasswordId).hide();
    Ext.getCmp(this.btnAnonymousId).hide();
    Ext.getCmp(this.fldNpass1Id).hide();
    Ext.getCmp(this.fldNpass2Id).hide();

    Ext.getCmp(this.btnSignId).hide();
    Ext.getCmp(this.btnForgotId).hide();
    Ext.getCmp(this.btnNewaccId).hide();

    Ext.getCmp(this.btnSendId).show();
    Ext.getCmp(this.btnBackId).show();
    Ext.getCmp(this.btnRegisterId).hide();

    Ext.getCmp(this.id + "userId").reset();
    Ext.getCmp(this.id + "userName").hide();

    Ext.getCmp(this.labelEmailId).setText('<span class="info">Type your user ID and email to send a new password</span>', false);

    Ext.getCmp(this.id + "userId").setFieldLabel('user ID', false);
    Ext.getCmp(this.fldEmailId).setFieldLabel('e-mail', false);
};
LoginWidget.prototype.ShowBack = function () {
    Ext.getCmp(this.fldEmailId).hide();
    Ext.getCmp(this.fldPasswordId).reset();
    Ext.getCmp(this.btnAnonymousId).reset();
    Ext.getCmp(this.fldNpass1Id).reset();
    Ext.getCmp(this.fldNpass2Id).reset();

    Ext.getCmp(this.fldPasswordId).show();
    Ext.getCmp(this.btnAnonymousId).show();
    Ext.getCmp(this.fldNpass1Id).hide();
    Ext.getCmp(this.fldNpass2Id).hide();

    Ext.getCmp(this.btnSignId).show();
    Ext.getCmp(this.btnForgotId).show();
    Ext.getCmp(this.btnNewaccId).show();

    Ext.getCmp(this.btnSendId).hide();
    Ext.getCmp(this.btnBackId).hide();
    Ext.getCmp(this.btnRegisterId).hide();

    Ext.getCmp(this.id + "userId").reset();
    Ext.getCmp(this.id + "userName").hide();

    Ext.getCmp(this.labelEmailId).setText('<span class="info">Type your user ID and password</span>', false);

    Ext.getCmp(this.id + "userId").setFieldLabel('user ID', false);
};
LoginWidget.prototype.ShowNewacc = function () {

    Ext.getCmp(this.fldEmailId).reset();
    Ext.getCmp(this.fldEmailId).show();
    Ext.getCmp(this.fldPasswordId).reset();
    Ext.getCmp(this.btnAnonymousId).reset();
    Ext.getCmp(this.fldNpass1Id).reset();
    Ext.getCmp(this.fldNpass2Id).reset();

    Ext.getCmp(this.fldPasswordId).hide();
    Ext.getCmp(this.btnAnonymousId).hide();
    Ext.getCmp(this.fldNpass1Id).show();
    Ext.getCmp(this.fldNpass2Id).show();

    Ext.getCmp(this.btnSignId).hide();
    Ext.getCmp(this.btnForgotId).hide();
    Ext.getCmp(this.btnNewaccId).hide();

    Ext.getCmp(this.btnSendId).hide();
    Ext.getCmp(this.btnBackId).show();
    Ext.getCmp(this.btnRegisterId).show();

    Ext.getCmp(this.id + "userId").reset();
    Ext.getCmp(this.id + "userName").reset();
    Ext.getCmp(this.id + "userName").show();

    Ext.getCmp(this.labelEmailId).setText('&nbsp;', false);

    Ext.getCmp(this.id + "userName").setFieldLabel('name', false);
    Ext.getCmp(this.id + "userId").setFieldLabel('user ID', false);
    Ext.getCmp(this.fldEmailId).setFieldLabel('e-mail', false);
    Ext.getCmp(this.fldNpass1Id).setFieldLabel('password', false);
    Ext.getCmp(this.fldNpass2Id).setFieldLabel('re-password', false);
    Ext.getCmp(this.id + "userId").setValue("");
};

LoginWidget.prototype.checkpass = function () {
    var passwd1 = Ext.getCmp(this.fldNpass1Id).getValue();
    var passwd2 = Ext.getCmp(this.fldNpass2Id).getValue();
    var patt = new RegExp("[ *]");

    if (!patt.test(passwd1) && passwd1.length > 3) {
        if (passwd1 == passwd2) {
            Ext.getCmp(this.fldNpass1Id).setFieldLabel('<span class="ok">password</span>', false);
            Ext.getCmp(this.fldNpass2Id).setFieldLabel('<span class="ok">re-password</span>', false);
            Ext.getCmp(this.labelEmailId).setText('&nbsp;', false);
            return true;
        } else {
            Ext.getCmp(this.fldNpass1Id).setFieldLabel('<span class="err">password</span>', false);
            Ext.getCmp(this.fldNpass2Id).setFieldLabel('<span class="err">re-password</span>', false);
            Ext.getCmp(this.labelEmailId).setText('<span class="err">Password does not match</span>', false);
            return false;
        }
    } else {
        Ext.getCmp(this.fldNpass1Id).setFieldLabel('<span class="err">password</span>', false);
        Ext.getCmp(this.fldNpass2Id).setFieldLabel('<span class="err">re-password</span>', false);
        Ext.getCmp(this.labelEmailId).setText('<span class="err">Password minimum length is 4</span>', false);
        return false;
    }
};

LoginWidget.prototype.anonymousSelected = function (este, value) {
    if (value) {
        Ext.getCmp(this.labelEmailId).setText('<span class="ok">Anonymous selected</span>', false);
    } else {
        Ext.getCmp(this.labelEmailId).setText('<span class="info">Type your user ID and password</span>', false);
    }

};

LoginWidget.prototype.checkemail = function (a, b, c) {
    Ext.getCmp(this.btnAnonymousId).reset();
    var email = Ext.getCmp(this.fldEmailId).getValue();
    var patt = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

    if (patt.test(email)) {
        Ext.getCmp(this.fldEmailId).setFieldLabel('<span class="ok">e-mail</span>', false);
        return true;
    } else {
        Ext.getCmp(this.fldEmailId).setFieldLabel('<span class="err">e-mail</span>', false);
        return false;
    }
};
LoginWidget.prototype.checkName = function (a, b, c) {
    var name = Ext.getCmp(this.id + "userName").getValue();
    if (name != "" && name != null) {
        Ext.getCmp(this.id + "userName").setFieldLabel('<span class="ok">name</span>', false);
        return true;
    } else {
        Ext.getCmp(this.id + "userName").setFieldLabel('<span class="err">name</span>', false);
        return false;
    }
};
LoginWidget.prototype.checkUserId = function (a, b, c) {
    var userId = Ext.getCmp(this.id + "userId").getValue();
    if (userId != "" && userId != null) {
        Ext.getCmp(this.id + "userId").setFieldLabel('<span class="ok">user ID</span>', false);
        return true;
    } else {
        Ext.getCmp(this.id + "userId").setFieldLabel('<span class="err">user ID</span>', false);
        return false;
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function OpencgaBrowserWidget(args) {
    var _this = this;

    _.extend(this, Backbone.Events);
    this.id = Utils.genId("uploadWidget");

    this.targetId;
    this.suiteId;
    this.chunkedUpload = false;
    this.width = 800;
    this.height = 575;
    this.title = 'Cloud data';
    this.enableTextModeUW = true; // Enable Text Mode in the Upload Widget


    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }
}

OpencgaBrowserWidget.prototype = {
    show: function (args) {
        if (!_.isUndefined(args)) {
            this.mode = args.mode;
            this.allowedTypes = args.allowedTypes;
        }
        console.log(this.mode)
        console.log(this.allowedTypes)
        this.panel.show();
    },
    hide: function () {
        this.panel.hide();
    },
    render: function () {
        var _this = this;

        /**ID**/
        this.searchFieldId = this.id + "_searchField";

        this.rendered = true;
    },
    draw: function () {
        var _this = this;
        if (!this.rendered) {
            console.info('Login Widget is not rendered yet');
            return;
        }

        /* Upload Widget */
        this.uploadWidget = this._createUploadWidget();

        /* Panel */
        this.panel = this._createPanel(this.targetId);
//        this.panel.show();
    },
    _createUploadWidget: function () {
        var _this = this;
        var uploadWidget = new UploadWidget({
            suiteId: this.suiteId,
            opencgaBrowserWidget: this,
            chunkedUpload: this.chunkedUpload,
            enableTextMode: this.enableTextModeUW,
            handlers: {
                'object:upload': function (e) {
                    if (e.data.status == 'done') {
                        _this.trigger('need:refresh', {sender: _this});
                    }
                }
            }
        });
        return uploadWidget;
    },
    _createPanel: function (targetId) {
        var _this = this;

        this.filesStore = Ext.create('Ext.data.Store', {
            fields: ['oid', 'fileBioType', 'fileType', 'fileFormat', 'fileName', 'multiple', 'diskUsage', 'creationTime', 'responsible', 'organization', 'date', 'description', 'status', 'statusMessage', 'members'],
            data: []
        });

        this.refreshBucketAction = Ext.create('Ext.Action', {
            icon: Utils.images.refresh,
            text: 'Refresh bucket',
            handler: function (widget, event) {
                var record = _this.folderTree.getSelectionModel().getSelection()[0];
                if (record) {
                    if (record.data.isBucket) {
                        OpencgaManager.refreshBucket({
                            accountId: $.cookie("bioinfo_account"),
                            bucketId: record.data.text,
                            sessionId: $.cookie("bioinfo_sid"),
                            success: function (response) {
                                if (response.errorMsg === '') {
                                    Utils.msg('Refresh Bucket', '</span class="emph">' + response.result[0].msg + '</span>');
                                    _this.trigger('need:refresh', {sender: _this});
                                } else {
                                    Ext.Msg.alert("Refresh bucket", response.errorMsg);
                                }
                            }
                        });

                    }
                }
            }
        });

        this.renameBucketAction = Ext.create('Ext.Action', {
//            icon: Utils.images.refresh,
            text: 'Rename bucket',
            handler: function (widget, event) {
                var record = _this.folderTree.getSelectionModel().getSelection()[0];
                if (record) {
                    if (record.data.isBucket) {
                        Ext.Msg.prompt('Rename bucket', 'Please enter a new name:', function (btn, text) {
                            if (btn == 'ok') {
                                text = text.replace(/[^a-z0-9-_.\/\s]/gi, '').trim();

                                OpencgaManager.renameBucket({
                                    accountId: $.cookie("bioinfo_account"),
                                    bucketId: record.data.bucketId,
                                    newBucketId: text,
                                    sessionId: $.cookie("bioinfo_sid"),
                                    success: function (response) {
                                        if (response.errorMsg === '') {
                                            _this.trigger('need:refresh', {sender: _this});
                                            Utils.msg('Rename bucket', '</span class="emph">' + response.result[0].msg + '</span>');
                                        } else {
                                            Ext.Msg.alert('Rename bucket', response.errorMsg);
                                        }
                                    }
                                });
                            }
                        }, null, null, "new name");
                    }
                }
            }
        });

        /*Files grid*/
        var indexAction = Ext.create('Ext.Action', {
            icon: Utils.images.info,  // Use a URL in the icon config
            text: 'Create index',
//            disabled: true,
            handler: function (widget, event) {
                var record = _this.filesGrid.getSelectionModel().getSelection()[0];
                if (record) {

                    OpencgaManager.indexer({
                        accountId: $.cookie("bioinfo_account"),
                        sessionId: $.cookie("bioinfo_sid"),
                        bucketId: record.data.bucketId,
                        objectId: record.data.oid,
                        success: function (response) {
                            console.log(response);
                            Utils.msg("indexer", response);
                            record.data.indexerId = response;
//                                if (response.indexOf("ERROR:") != -1){
//                                }else{
//                                    //delete complete
////                                    record.destroy();
//                                    _this.trigger('need:refresh',{sender:_this});
//                                }
                        }
                    });


//                    console.log(record.data.status);
//                    if (record.data.status.indexOf('indexer') == -1) {
//                        opencgaManager.onIndexer.addEventListener(function (sender, response) {
//                            console.log(response)
//                            Utils.msg("indexer", response);
//                            record.data.indexerId = response;
////                                if (response.indexOf("ERROR:") != -1){
////                                }else{
////                                    //delete complete
//////                                    record.destroy();
////                                    _this.trigger('need:refresh',{sender:_this});
////                                }
//                        });
//                        opencgaManager.indexer($.cookie("bioinfo_account"), $.cookie("bioinfo_sid"), record.data.bucketId, record.data.oid);
//                    } else {
//                        Utils.msg('Indexer', 'The file is already being indexed');
//                        opencgaManager.onIndexerStatus.addEventListener(function (sender, response) {
//                            console.log(response)
//                            Utils.msg("indexer status", response);
////                                if (response.indexOf("ERROR:") != -1){
////                                }else{
////                                    //delete complete
//////                                    record.destroy();
////                                    _this.trigger('need:refresh',{sender:_this});
////                                }
//                        });
//                        opencgaManager.indexerStatus($.cookie("bioinfo_account"), $.cookie("bioinfo_sid"), record.data.bucketId, record.data.oid, record.data.status);
//                    }
                }
            }
        });
        var showName = Ext.create('Ext.Action', {
//            icon: Utils.images.info,
            text: 'Show name',
//            disabled: true,
            handler: function (widget, event) {
                var rec = _this.filesGrid.getSelectionModel().getSelection()[0];
                if (rec) {
                    Utils.msg('objectId', '' + rec.get('oid'));
                }
            }
        });

        var deleteAction = Ext.create('Ext.Action', {
            icon: Utils.images.del,
            text: 'Delete this file',
//            disabled: true,
            handler: function (widget, event) {
                var record = _this.filesGrid.getSelectionModel().getSelection()[0];
                if (record) {
                    Ext.MessageBox.confirm('Confirm', 'Are you sure you want to delete this file?<p class="emph">' + record.data.fileName + '<p>', function (answer) {
                        if (answer == "yes") {
                            console.log("deleting")

                            OpencgaManager.deleteObjectFromBucket({
                                accountId: $.cookie("bioinfo_account"),
                                sessionId: $.cookie("bioinfo_sid"),
                                bucketId: record.data.bucketId,
                                objectId: record.data.oid,
                                success: function (response) {
                                    if (response.errorMsg === '') {
                                        Utils.msg('Deleting', '</span class="emph">' + response.result[0].msg + '</span>');
                                        _this.filesGrid.store.remove(record);
                                    } else {
                                        Ext.Msg.alert('Deleting', response.errorMsg);
                                    }
                                }
                            });
                        }
                    });
                }
            }
        });

        this.filesGrid = Ext.create('Ext.grid.Panel', {
            store: this.filesStore,
            flex: 3,
            border: false,
            viewConfig: {
//                stripeRows: true,
                listeners: {
                    itemcontextmenu: function (este, record, item, index, e) {
                        e.stopEvent();
//                        var items = [showName];
                        var items = [];
                        console.log(record)
                        if (record.data.fileFormat == 'bam' || record.data.fileFormat == 'vcf') {
                            items.push(indexAction);
                        }
                        items.push(deleteAction);
                        var contextMenu = Ext.create('Ext.menu.Menu', {
                            plain: true,
                            items: items
                        });
                        contextMenu.showAt(e.getXY());
                        return false;
                    }
                }
            },
            selModel: {
                mode: 'SINGLE',
                //allowDeselect:true,
                listeners: {
                    selectionchange: function (este, item) {
                        _this.selectButton.disable();
                        if (item.length > 0) {//se compr
                            _this.selectedFileNode = item[0].data;
                            var type = item[0].data.fileType;
                            var fileFormat = item[0].data.fileFormat;
                            if (_this.mode === "fileSelection" && type === "dir") {
                                return;
                            }
                            console.log(_this.allowedTypes)
                            if (typeof _this.allowedTypes != 'undefined' && _this.allowedTypes.indexOf(fileFormat) == -1) {
                                _this.selectButton.disable();
                                console.log('file format NOT allowed -' + fileFormat + '- ')
                                return;
                            }
                            if (_this.mode === "folderSelection" && type !== "dir") {
                                return;
                            }

                            console.log('file format allowed -' + fileFormat + '- ');
                            _this.selectButton.enable();
                            //this.selectedLabel.setText('<p>The selected file <span class="emph">'+item[0].data.fileName.substr(0,40)+'</span><span class="ok"> is allowed</span>.</p>',false);
                            //TODO por defecto cojo el primero pero que pasa si el data contiene varios ficheros??
                        } else {
                            _this.selectButton.disable();
                        }
                    }
                }
            },
            columns: [
                { text: 'File type', xtype: 'actioncolumn', menuDisabled: true, align: 'center', width: 54, icon: Utils.images.bluebox,
                    renderer: function (value, metaData, record) {
                        this.icon = Utils.images[record.data.fileType];
                        this.tooltip = record.data.fileType;
                    }
                },
                { text: 'Name', dataIndex: 'fileName', flex: 2 },
                { text: 'Creation time', dataIndex: 'creationTime', flex: 1 }
            ]
        });
        /**/


        this.container = Ext.create('Ext.panel.Panel', {
            title: ' ',
            border: false,
            minWidth: 125,
            flex: 3,
            layout: {
                type: 'hbox',
                align: 'stretch'
            },
            items: [this.folderTree, this.filesGrid]
        });

        this.selectButton = Ext.create('Ext.button.Button', {
            text: 'Ok',
            disabled: true,
            handler: function () {
                var idQuery = _this.selectedFileNode.oid.replace(/\//g, ":");
                _this.trigger('select', {
                    id: _this.selectedFileNode.oid,
                    idQuery: idQuery,
                    pathQuery: 'buckets:' + _this.selectedFileNode.bucketId + ':' + idQuery,
                    path: 'buckets/' + _this.selectedFileNode.bucketId + '/' + _this.selectedFileNode.oid,
                    bucketId: _this.selectedFileNode.bucketId
                });
                _this.panel.hide();
            }
        });

        this.activeUploadsCont = Ext.create('Ext.panel.Panel', {
            title: 'Active uploads',
            animCollapse: false,
            hidden: true,
            bodyPadding: '10 0 10 0',
            autoScroll: true,
            height: 125,
            border: 0,
            cls: 'ocb-border-top-lightgrey',
            items: []
        });


        /**MAIN PANEL**/
//		this.height=205+(26*suites.length);//segun el numero de suites

        var tbarObj = {items: []};
        switch (this.mode) {
            case "folderSelection" :
                var item;
                item = {text: 'New folder', handler: function () {
                    _this.createFolder();
                }};
                tbarObj.items.splice(0, 0, item);
                item = {text: 'New bucket', handler: function () {
                    _this.createBucket();
                }};
                tbarObj.items.splice(0, 0, item);
                this.filesStore.filter("fileType", /dir/);
                break;
            case "manager" :
                var item;
                item = {text: 'Upload local file', handler: function () {
                    _this.drawUploadWidget();
                }};
                tbarObj.items.splice(0, 0, item);
                item = {text: 'New folder', handler: function () {
                    _this.createFolder();
                }};
                tbarObj.items.splice(0, 0, item);
                item = {text: 'New bucket', handler: function () {
                    _this.createBucket();
                }};
                tbarObj.items.splice(0, 0, item);
                this.selectButton.hide();
                break;

            default :
                var item;
                item = {text: 'Upload local file', handler: function () {
                    _this.drawUploadWidget();
                }};
                tbarObj.items.push(item);
                item = {text: 'New folder', handler: function () {
                    _this.createFolder();
                }};
                tbarObj.items.push(item);
                item = {text: 'New bucket', handler: function () {
                    _this.createBucket();
                }};
                tbarObj.items.push(item);
                break;
        }

        if (this.chunkedUpload == true) {
            tbarObj.items.push({
                id: this.id + 'activeUploadsButton',
                text: 'Active uploads',
                enableToggle: true,
                pressed: false,
                toggleHandler: function () {
                    if (this.pressed) {
                        _this.activeUploadsCont.show();
                        //                    _this.viewUploads();
                    } else {
                        _this.activeUploadsCont.hide();
                        //                    _this.viewBuckets();
                    }
                }
            });
        }
        var panel = Ext.create('Ext.window.Window', {
            title: 'Upload & Manage',
            resizable: false,
            minimizable: true,
            constrain: true,
            closable: false,
            modal: true,
            height: this.height,
            minHeight: this.height,
            width: this.width,
            minWidth: this.width,
            resizable: true,
            layout: 'fit',
            items: {
                border: 0,
                layout: { type: 'vbox', align: 'stretch'},
                items: [
                    this.container,
                    this.activeUploadsCont
                ],
                tbar: tbarObj,
                bbar: {
                    layout: {
                        pack: 'end'
                    },
                    defaults: {
                        width: 100
                    },
                    items: [
                        {
                            text: 'Close',
                            handler: function () {
                                _this.filesGrid.getSelectionModel().deselectAll();
                                _this.trigger('select');
                                _this.panel.hide();
                            }
                        },
                        this.selectButton
                    ]
                }
            },
            listeners: {
                scope: this,
                minimize: function () {
                    this.panel.hide();
                },
                destroy: function () {
                    delete this.panel;
                }
            }
        });

        this._updateFolderTree();
        return panel;
    },

    setUserData: function (data) {
        this.accountData = data;
        if (this.rendered) {
            this._updateFolderTree();
        }
    },

    removeUserData: function () {
        this.folderStore.getRootNode().removeAll();
        this.allStore.getRootNode().removeAll();
        this.filesStore.removeAll();
    },

    _updateFolderTree: function () {
        var _this = this;
//        console.log("updating folder tree");
        var find = function (str, arr) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i].text == str) {
                    return i;
                }
            }
            return -1;
        };

        var folderNodes = [];
        var filesNodes = [];

        if (this.accountData != null && this.accountData.accountId != null) {
//            console.log('generating tree..')
//            this.folderStore.getRootNode().removeAll();
//            this.allStore.getRootNode().removeAll();
            this.filesStore.removeAll();
//            this.folderTree.getSelectionModel().deselectAll();
            for (var i = 0; i < this.accountData.buckets.length; i++) {
                var files = [];
                var folders = [];
                for (var j = 0; j < this.accountData.buckets[i].objects.length; j++) {
                    var data = this.accountData.buckets[i].objects[j];
                    data["bucketId"] = this.accountData.buckets[i].id;
                    //sencha uses id so need to rename to oid, update: sencha can use id but dosent like char '/' on the id string

                    if (data.id != null) {
                        data["oid"] = data.id;
                        delete data.id;
                    }
                    var pathArr = data.oid.split("/");
                    if (data.fileType == "dir") {
                        data["expanded"] = true;
                        data["icon"] = Utils.images.dir;
                    } else {
                        data["leaf"] = true;
                        data["icon"] = Utils.images.r;
                    }
                    //console.log(pathArr)

                    var currentFiles = files;
                    var currentFolders = folders;

                    for (var k = 0; k < pathArr.length; k++) {
                        var found = find(pathArr[k], currentFiles);
                        if (found != -1) {
                            currentFiles = currentFiles[found].children;
                        } else {
                            var children = [];
                            var idx = currentFiles.push({text: pathArr[k], children: children}) - 1;
                            if (typeof pathArr[k + 1] == 'undefined') {//isLast
                                for (key in data) {
                                    if (key != "children") {
                                        currentFiles[idx][key] = data[key];
                                    }
                                }
                            }

                            currentFiles = children;
                        }

                        //ignore files, only folders
                        var found = find(pathArr[k], currentFolders);
                        if (found != -1) {
                            currentFolders = currentFolders[found].children;
                        } else {
                            var children = [];
                            if (data.fileType == "dir") {
                                var idx = currentFolders.push({text: pathArr[k], children: children}) - 1;
                                if (typeof pathArr[k + 1] == 'undefined') {//isLast
                                    for (key in data) {
                                        if (key != "children") {
                                            currentFolders[idx][key] = data[key];
                                        }
                                    }
                                }
                            }

                            currentFolders = children;
                        }

                    }
                }

                filesNodes.push({
                    text: this.accountData.buckets[i].name,
                    bucketId: this.accountData.buckets[i].name,
                    oid: "",
//                    icon: Utils.images.bucket,
                    expanded: true,
                    isBucket: true,
                    children: files
                })
//                this.allStore.getRootNode().appendChild();
                folderNodes.push({
                    text: this.accountData.buckets[i].name,
                    bucketId: this.accountData.buckets[i].name,
                    oid: "",
//                    icon: Utils.images.bucket,
                    expanded: true,
                    isBucket: true,
                    children: folders
                })
//                this.folderStore.getRootNode().appendChild();
            }
        }
        this._createFolderTree(folderNodes, filesNodes);

        //reselect nodes after account update
        if (this.selectedFolderNode != null) { //devuelve el value y el field porque el bucket no tiene oid
            var lastNode = this.folderTree.getRootNode().findChild(this.selectedFolderNode.field, this.selectedFolderNode.value, true);
            if (lastNode != null) {
                this.folderTree.getSelectionModel().select(lastNode);
            }
        }
        if (this.selectedFileNode != null) { //devuelve el value y el field porque el bucket no tiene oid
            var index = this.filesGrid.getStore().findExact('oid', this.selectedFileNode.oid);
            if (index != -1) {
                this.filesGrid.getSelectionModel().select(index);
            }
        }
    },

    addUpload: function (file, fileuploadWorker) {
        var pbar = Ext.create('Ext.ProgressBar', {
            text: 'Ready',
            width: 250,
            margin: '4 6 0 6'
        });
        var nameBox = Ext.create('Ext.Component', {
            html: file.name.substr(0, 67),
            width: 430,
            margin: '7 6 0 6'
        });
//        #ffffd6  amarillete
        // #1155cc azulete
        var btn = Ext.create('Ext.Button', {
            text: '<span style="color:#1155cc">Cancel</span>',
            margin: '3 6 0 4',
            width: 50,
            handler: function () {
                fileuploadWorker.terminate();
                cont.destroy();
            }
        });
        var cont = Ext.create('Ext.container.Container', {
            padding: '3 6 0 6',
            layout: 'hbox',
            items: [nameBox, pbar, btn]
        });
        fileuploadWorker.onmessage = function (e) {
            var res = e.data;
            console.log("@@@@@@@@@@@@@@@@ WORKER event message");
            console.log(res);
            pbar.updateProgress((res.chunkId + 1) / res.total, 'uploading part ' + (res.chunkId + 1) + ' of ' + res.total, false);
            if (res.finished == true) {
                btn.setText('<span style="color:#1155cc">Done </span>');
            }
//            _this.adapter.onIndexer(function(data){
//                console.log(data);
//            });
//            _this.adapter.indexer($.cookie("bioinfo_account"),objectId);
        };
        this.activeUploadsCont.add(cont);
        Ext.getCmp(this.id + 'activeUploadsButton').toggle(true);
    },
    viewBuckets: function () {
        var _this = this;
        _this.panel.removeAll(false);
        _this.panel.add(_this.container);
    },
    viewUploads: function () {
        var _this = this;
        _this.panel.removeAll(false);
        _this.panel.add(_this.activeUploadsCont);
    }
    //endclass
};


OpencgaBrowserWidget.prototype.setFilter = function () {
    var _this = this;
    var recordOrigin = this.viewOrigin.getSelectionModel().getSelection()[0];
    var recordSuite = this.viewSuite.getSelectionModel().getSelection()[0];

    this.folderStore.clearFilter();

    if (recordOrigin != null) {
        switch (recordOrigin.data.suiteId) {
            case  "all":
                break;
            case  "Uploaded Data":
                this.folderStore.filter(function (item) {
                    return item.data.jobId < 0;
                });
                break;
            case  "Job Generated":
                this.folderStore.filter(function (item) {
                    return item.data.jobId > 0;
                });
                break;
        }
    }
    if (recordSuite != null) {
        switch (recordSuite.data.suiteId) {
            case  1:
                break;
            default :
                this.folderStore.filter(function (item) {
                    return item.data.suiteId == recordSuite.data.suiteId;
                });
        }
    }

    this.folderStore.filter(function (item) {
        var str = Ext.getCmp(_this.searchFieldId).getValue().toLowerCase();
        if (item.data.name.toLowerCase().indexOf(str) < 0) {
            return false;
        }
        return true;
    });
};

OpencgaBrowserWidget.prototype.checkTags = function (tags) {
    for (var i = 0; i < this.tags.length; i++) {
        if (this.tags[i].indexOf('|') > -1) {
            var orTags = this.tags[i].split('|');
            var orMatch = false;
            for (var j = 0; j < orTags.length; j++) {
                if (tags.indexOf(orTags[j]) > -1) {
                    orMatch = true;
                }
            }
            if (!orMatch) {
                return false;
            }
        } else {
            if (tags.indexOf(this.tags[i]) == -1) {
                return false;
            }
        }
    }
    return true;

};


OpencgaBrowserWidget.prototype.createBucket = function () {
    var _this = this;
    Ext.Msg.prompt('New Bucket', 'Please enter a name and description for the new bucket:', function (btn, text) {
        if (btn == 'ok') {
            text = text.replace(/[^a-z0-9-_.\s]/gi, '').trim();

            OpencgaManager.createBucket({
                bucketId: text,
                description: '',
                accountId: $.cookie("bioinfo_account"),
                sessionId: $.cookie("bioinfo_sid"),
                success: function (response) {
                    if (response.errorMsg === '') {
                        _this.trigger('need:refresh', {sender: _this});
                    } else {
                        Utils.msg("Create project", response.errorMsg);
                    }
                    _this.panel.setLoading(false);
                    Ext.getBody().unmask();
                }
            });

        }
    }, null, null, "New bucket");
};

OpencgaBrowserWidget.prototype._getFolderTreeSelection = function () {
    var selectedBuckets = this.folderTree.getSelectionModel().getSelection();
    if (selectedBuckets.length < 1) {
        Utils.msg('No folder selected', 'Please select a bucket or a folder.');
        return null;
    } else {
        var record = selectedBuckets[0];
        var bucketName;
        var parent = '';
        if (record.data.fileType != null && record.data.fileType == "dir") {
            var path = record.getPath("text", "/").substr(1);
            var pathArr = path.split("/", 2);
            parent = path.replace(pathArr.join("/"), "").substr(1) + "/";
            bucketName = pathArr[1];
        } else {
            bucketName = record.data.text;
        }
        return {bucketId: bucketName, directory: parent};
    }
};

OpencgaBrowserWidget.prototype.drawUploadWidget = function () {
    var _this = this;
    var folderSelection = this._getFolderTreeSelection();
    if (folderSelection != null) {
        _this.uploadWidget.draw(folderSelection);
    }
};

OpencgaBrowserWidget.prototype.createFolder = function () {
    var _this = this;
    if (this.accountData.buckets.length < 1) {
        Ext.MessageBox.alert('No buckets found', 'Please create and select a bucket.');
    } else {
        var folderSelection = this._getFolderTreeSelection();
        if (folderSelection != null) {
            Ext.Msg.prompt('New folder', 'Please enter a name for the new folder:', function (btn, text) {
                if (btn == 'ok') {
                    text = text.replace(/[^a-z0-9-_.\s]/gi, '');
                    text = text.trim() + "/";

                    OpencgaManager.createDirectory({
                        accountId: $.cookie("bioinfo_account"),
                        sessionId: $.cookie("bioinfo_sid"),
                        bucketId: folderSelection.bucketId,
                        objectId: folderSelection.directory + text,
                        success: function (response) {
                            if (response.errorMsg === '') {
                                Utils.msg('Create folder', '</span class="emph">' + response.result[0].msg + '</span>');
                                _this.trigger('need:refresh', {sender: _this});
                            } else {
                                Ext.Msg.alert('Create folder', response.errorMsg);
                            }
                        }
                    });

                }
            }, null, null, "New Folder");
        }
    }
};


OpencgaBrowserWidget.prototype._createFolderTree = function (data, allData) {
    var _this = this;


    if (this.container) {

        var tree = this.container.child('treepanel');
        if (tree) {
            this.container.remove(tree, false).destroy();
        }


        this.allStore = Ext.create('Ext.data.TreeStore', {
            id: this.id + 'allStore',
            fields: ['text', 'oid'],
            root: {
                expanded: true,
                text: 'Drive',
                children: allData
            }
        });

        var folderStore = Ext.create('Ext.data.TreeStore', {
            fields: ['text', 'oid'],
            root: {
                expanded: true,
                text: 'Drive',
                children: data
            },
            listeners: {
                beforeinsert: function (este, node) {
                    if (node.isLeaf()) {
//                        console.log(node.data.oid + " is a file");
                        return false; //cancel append because is leaf
                    }
                }
            }
        });
        this.folderStore = folderStore;


        var folderTree = Ext.create('Ext.tree.Panel', {
            //xtype:"treepanel",
//            title: "Folders",
//            bodyPadding: 2,
            border: false,
            autoScroll: true,
            useArrows: true,
            rootVisible: false,
            hideHeaders: true,
            expanded: true,
            flex: 1,
            style: {
                borderColor: 'lightgray',
                borderStyle: 'solid',
                borderWidth: '0px 1px 0 0'

            },
//			selType: 'cellmodel',
            //plugins: [Ext.create('Ext.grid.plugin.CellEditing', {clicksToEdit: 2,listeners:{
            //edit:function(editor, e, eOpts){
            //var record = e.record; //en la vista del cliente
            /*todo, ahora q llame la servidor. y lo actualize*/
            //}
            //}})],
            columns: [
                {
                    xtype: 'treecolumn',
                    dataIndex: 'text',
                    flex: 1,
                    editor: {xtype: 'textfield', allowBlank: false}
                }
            ],
            viewConfig: {
                markDirty: false,
                plugins: {
                    ptype: 'treeviewdragdrop'
                },
                listeners: {
                    drop: function (node, data, overModel, dropPosition, eOpts) {
                        var record = data.records[0];
                        //check if is leaf and if the record has a new index
                        if (record.isLeaf() && record.data.index != record.removedFrom && record.data.checked) {
                            var id = record.data.trackId;
                            _this.setTrackIndex(id, record.data.index);
                        }
                    },
                    itemcontextmenu: function (este, record, item, index, e) {
                        e.stopEvent();
                        var items = [];
                        console.log(record)
                        if (record.data.isBucket) {
                            items.push(_this.refreshBucketAction);
                            items.push(_this.renameBucketAction);
                            var contextMenu = Ext.create('Ext.menu.Menu', {
                                plain: true,
                                items: items
                            });
                            contextMenu.showAt(e.getXY());
                        }
                        return false;
                    }
                }
            },
            listeners: {
                selectionchange: function (este, selected, eOpts) {
                    var record = selected[0];
                    if (typeof record != 'undefined') {//avoid deselection
                        var field, deep;
                        if (record.data.isBucket != null) {//is a bucket
                            field = 'text';
                            deep = false;
                        } else {
                            field = 'oid';
                            deep = true;
                        }
                        var node = _this.allStore.getRootNode().findChild(field, record.data[field], deep);
                        var childs = [];
                        _this.selectedFolderNode = {value: node.data[field], field: field};

                        for (var index in node.data.children) {
                            childs.push(node.data.children[index]);
                        }

//                        node.eachChild(function (n) {
//                            childs.push(n.data);
//                        });
                        _this.container.setTitle(node.getPath("text", " / "));
                        _this.filesStore.loadData(childs);
                        if (_this.mode == "folderSelection") {
                            _this.selectedFileNode = node.data;
                            _this.selectButton.enable();
                        }
                    }
                },
                viewready: function (este, eOpts) {//Fires when the grid view is available (use this for selecting a default row).
                    if (typeof _this.selectedFolderNode === 'undefined') {
//                        setTimeout(function () { // forced to do this because some ExtJS 4.2.0 event problem
                        var node = este.getRootNode().getChildAt(0);
                        if (typeof node != 'undefined') {
                            este.getSelectionModel().select(node);
                        }
//                        }, 0);
                    }
                },
                checkchange: function (node, checked) {
                },
                itemmouseenter: function (este, record) {
                },
                itemmouseleave: function (este, record) {
                }
            },
            store: folderStore
        });

        this.folderTree = folderTree;
    }

    if (this.container) {
        this.container.getLayout().animate = false;
        this.container.insert(0, folderTree);
        folderTree.expand();
        this.container.getLayout().animate = true;
    }
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function ProfileWidget(args) {

    _.extend(this, Backbone.Events);
    this.id = Utils.genId("ProfileWidget");

    this.suiteId;

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rendered = false;
    if (this.autoRender) {
        this.render(this.targetId);
    }
}

ProfileWidget.prototype = {
    show: function () {
        this.panel.show();
    },
    hide: function () {
        this.panel.hide();
    },
    render: function () {
        var _this = this;

        /**************/
        this.changePasswordSuccess = function (response) {
            _this.panel.setLoading(false);
            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                Ext.getCmp(_this.id + 'fldOld').setValue(null);
                Ext.getCmp(_this.id + 'fldNew1').setValue(null);
                Ext.getCmp(_this.id + 'fldNew2').setValue(null);
                Ext.getCmp(_this.id + 'labelPass').update('<span class="info">' + 'OK' + '</span>', false);
            } else {
                Ext.getCmp(_this.id + 'labelPass').update('<span class="err">' + response.response[0].errorMsg + '</span>', false);
            }
        };
        this.changeEmailSuccess = function (response) {
            _this.panel.setLoading(false);
            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                Ext.getCmp(_this.id + 'fldEmail').setValue(null);
                Ext.getCmp(_this.id + 'fldEmail').setFieldLabel('e-mail', false);
                Ext.getCmp(_this.id + 'labelPass').update('<span class="info">' + 'OK' + '</span>', false);
            } else {
                Ext.getCmp(_this.id + 'labelPass').update('<span class="err">' + response.response[0].errorMsg + '</span>', false);
            }
        };
        /**************/

        this.rendered = true;
    },
    draw: function () {
        var _this = this;
        if (!this.rendered) {
            console.info('Login Widget is not rendered yet');
            return;
        }

        /* Panel */
        this.panel = this._createPanel(this.targetId);
//        this.panel.show();
    },
    _createPanel: function (targetId) {
        var _this = this;
//        console.log(this.id + ' CREATING PANEL');

        var labelPass = Ext.create('Ext.Component', {
            width: 200,
            id: this.id + 'labelPass',
            html: 'Modify your password or email.'
        });
        var changePasswordForm = Ext.create('Ext.form.Panel', {
            title: 'Change password',
            bodyPadding: 15,
            width: 350,
            border: false,
            items: [
                {
                    id: this.id + "fldOld",
                    name: 'password',
                    xtype: 'textfield',
                    fieldLabel: 'Old password',
                    inputType: 'password'
                },
                {
                    id: this.id + "fldNew1",
                    name: 'new_password1',
                    xtype: 'textfield',
                    fieldLabel: 'New password',
                    inputType: 'password',
//		        enableKeyEvents: true,
                    listeners: {
                        scope: this,
                        change: this.checkpass
                    }
                },
                {
                    id: this.id + "fldNew2",
                    name: 'new_password2',
                    xtype: 'textfield',
                    fieldLabel: 'Confirm new',
                    inputType: 'password',
//		        enableKeyEvents: true,
                    listeners: {
                        scope: this,
                        change: this.checkpass
                    }
                },
                {
                    xtype: 'button',
                    text: 'Change', margin: '0 0 0 105',
                    handler: function () {
                        _this.changePassword();
                    }
                }
            ]
        });
        var changeEmailForm = Ext.create('Ext.form.Panel', {
            title: 'Change email',
            bodyPadding: 15,
            width: 350,
            border: false,
            items: [
                {
                    id: this.id + "fldEmail",
                    name: 'new_email',
                    xtype: 'textfield',
                    fieldLabel: 'e-mail',
//		        enableKeyEvents: true,
//		        emptyText:'please enter your email',
                    listeners: {
                        change: function () {
                            _this.checkemail();
                        }
                    }
                },
                {
                    xtype: 'button',
                    text: 'Change', margin: '0 0 0 105',
                    handler: function () {
                        _this.changeEmail();
                    }
                }
            ]
        });
        var profilePanel = Ext.create('Ext.panel.Panel', {
            width: 350,
            border: false,
            layout: 'accordion',
            items: [changePasswordForm, changeEmailForm],
            listeners: {
                tabchange: function () {
                    _this.clearAllFields();
                }
            }
        });
        var panel = Ext.create('Ext.window.Window', {
            title: 'Profile',
            resizable: false,
            minimizable: true,
            constrain: true,
            height: 350,
            layout: 'fit',
            closable: false,
            modal: true,
            items: {
                border: 0,
                layout: 'fit',
                items: [profilePanel],
                bbar: {
                    layout: {
                        pack: 'start'
                    },
                    items: [
                        labelPass,
                        '->',
                        {
                            text: 'Close',
                            handler: function () {
                                _this.panel.hide();
                            }
                        }
                    ]
                }
            },
            listeners: {
                minimize: function () {
                    _this.panel.hide();
                }
            }
        });
        return panel;
    },

    getOldPassword: function () {
        return CryptoJS.SHA1(Ext.getCmp(this.id + 'fldOld').getValue()).toString();
    },
    getNewPassword: function () {
        return CryptoJS.SHA1(Ext.getCmp(this.id + 'fldNew1').getValue()).toString();
    },
    getEmail: function () {
        return Ext.getCmp(this.id + 'fldEmail').getValue();
    },
    clearAllFields: function () {
        Ext.getCmp(this.id + 'fldOld').setValue(null);
        Ext.getCmp(this.id + 'fldNew1').setValue(null);
        Ext.getCmp(this.id + 'fldNew2').setValue(null);
        Ext.getCmp(this.id + 'fldEmail').setValue(null);
        Ext.getCmp(this.id + 'labelPass').update('&nbsp', false);
    },
    changeEmail: function () {
        if (this.checkemail()) {
            OpencgaManager.users.req({
                path: {
                    id: Cookies('bioinfo_user'),
                    action: 'change-email'
                },
                query: {
                    nemail: this.getEmail(),
                    sid: Cookies('bioinfo_sid')
                },
                request: {
                    success: this.changeEmailSuccess
                }
            });
            this.panel.setLoading('Waiting for the server to respond...');
        }
    },
    changePassword: function () {
        if (this.checkpass()) {
            OpencgaManager.users.req({
                path: {
                    id: Cookies('bioinfo_user'),
                    action: 'change-password'
                },
                query: {
                    password: this.getOldPassword(),
                    npassword: this.getNewPassword(),
                    sid: Cookies('bioinfo_sid')
                },
                request: {
                    success: this.changePasswordSuccess
                }
            });
            this.panel.setLoading('Waiting for the server to respond...');
        }
    },
    checkpass: function () {
        var passwd1 = Ext.getCmp(this.id + 'fldNew1').getValue();
        var passwd2 = Ext.getCmp(this.id + 'fldNew2').getValue();
        var oldPass = Ext.getCmp(this.id + 'fldOld').getValue();
        var patt = new RegExp("[ *]");

        if (oldPass != '') {
            if (!patt.test(passwd1) && passwd1.length > 3) {
                if (passwd1 == passwd2) {
                    Ext.getCmp(this.id + 'labelPass').update('<span class="ok">Passwords match</span>', false);
                    return true;
                } else {
                    Ext.getCmp(this.id + 'labelPass').update('<span class="err">Passwords does not match</span>', false);
                    return false;
                }
            } else {
                Ext.getCmp(this.id + 'labelPass').update('<span class="err">Password must be at least 4 characters</span>', false);
                return false;
            }
        } else {
            Ext.getCmp(this.id + 'labelPass').update('<span class="err">Old password is empty</span>', false);
            return false;
        }

    },
    checkemail: function () {
        var email = Ext.getCmp(this.id + 'fldEmail').getValue();
        var patt = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

        if (patt.test(email)) {
            Ext.getCmp(this.id + 'fldEmail').setFieldLabel('<span class="ok">e-mail</span>', false);
            return true;
        } else {
            Ext.getCmp(this.id + 'fldEmail').setFieldLabel('<span class="err">e-mail</span>', false);
            if (email == '') {
                Ext.getCmp(this.id + 'fldEmail').setFieldLabel('e-mail', false);
            }
            return false;
        }
    }
};


/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function ResultTable(jobId, filename, tags, args) {
    var _this = this;
    this.id = "ResultTable" + Math.round(Math.random() * 10000000);
    this.targetId = null;

    this.jobId = jobId;
    this.fileName = filename;
    this.tags = tags;
    this.numRows = 10;
    this.flex = null;
    this.collapsible = true;
    this.border = true;
    this.cls = null;

    if (typeof args != 'undefined') {
        this.targetId = args.targetId || this.targetId;
        this.numRows = args.numRows || this.numRows;
        this.flex = args.flex || this.flex;
        this.collapsible = args.collapsible || this.collapsible;
        this.border = args.border || this.border;
        this.cls = args.cls || this.cls;
        this.tableLayout = args.tableLayout || this.tableLayout;
    }

    this.table = null;

//    this.onRendered = new Event();
//	this.onRendered.addEventListener(function (sender, targetId){
//		_this.draw();
//	});
};


ResultTable.prototype.draw = function () {
    this.render();
};

ResultTable.prototype.render = function () {
    var _this = this;

    var rows = null;

    var filteredGridNames = new Array();
    var filteredColNames = new Array();
//	for( var i =0; i < tables.length; i++){
//		if (this.tags.indexOf(tables[i].name)!= -1){//me quedo con la primera que encuentro
//			this.tableSkel = tables[i];
//			this.colNames = tables[i].colNames;
//			this.colVisibilty = tables[i].colVisibility;
//			this.colTypes = tables[i].colTypes;
//			rows = tables[i].numRows;
//
//			filteredGridNames = new Array();
//			filteredColNames = new Array();
//			for (var j=0;j<this.colNames.length; j++){
//				if (this.colVisibilty[j]==1){
//					filteredGridNames.push({header:this.colNames[j],dataIndex:this.colNames[j], flex:1});
//					filteredColNames.push({name:this.colNames[j],type:this.colTypes[j]});
//				}
//			}
//		break;
//		}
//	}
    this.tableSkel = this.tableLayout;
    this.colNames = this.tableSkel.colNames;
    this.colVisibilty = this.tableSkel.colVisibility;
    this.colTypes = this.tableSkel.colTypes;
    rows = this.tableSkel.numRows;

    filteredGridNames = new Array();
    filteredColNames = new Array();
    for (var j = 0; j < this.colNames.length; j++) {
        if (this.colVisibilty[j] == 1) {
            filteredGridNames.push({header: this.colNames[j], dataIndex: this.colNames[j], width: ((this.colNames[j].length * 10) + 30)});
            filteredColNames.push({name: this.colNames[j], type: this.colTypes[j]});
        }
    }


    if (this.tableSkel.type == "text") {

        var adapterPoll = new WumAdapter();
        adapterPoll.onPoll.addEventListener(function (sender, data) {
            var altura = 75 + 22 * 2;

            var lines = _this.parse(data);
            var items = [];
            for (var i = 0; i < lines.length; i++) {
                var cont = Ext.create('Ext.container.Container', {
                    data: lines[0],
                    tpl: _this.getTemplate(_this.tableSkel.colNames)
                });
                items.push(cont);
            }

            this.table = Ext.create('Ext.container.Container', {
                items: items,
                margin: "0 0 0 50",
                renderTo: _this.targetId
            });

        });
        adapterPoll.poll(this.jobId, this.fileName, false, $.cookie('bioinfo_sid'));

    } else {
        //accountId, sessionId, bucketname, jobId, filename, colNames, colVisibilty, sessionId
        //var url = this.adapter.tableurl(this.jobId,this.fileName,this.colNames,this.colVisibilty,$.cookie('bioinfo_sid'));


        var url = OpencgaManager.tableurl({
            accountId: $.cookie("bioinfo_account"),
            sessionId: $.cookie('bioinfo_sid'),
            jobId: this.jobId,
            filename: this.fileName
//            colNames: this.colNames,
//            colVisibility: this.colVisibilty
        });
        console.log(url);

        /*
         http://ws.bioinfo.cipf.es/opencga/rest/job/86232/table?
         sessionid=QtjXeeOwKsRdTcyCF1vOiM2xbIC57fhlNvXafCjZMXCAFH2M6iZPfEXETt1Lp7F4
         &filename=significant_your_annotation_0.1.txt
         &colNames=Term,Term%20size,Term%20size%20(in%20genome),List1%20annotateds,List1%20unannotateds,list1_per,List2%20annotateds,List2%20unannotateds,list2_per,List1%20annotated%20genes,List2%20annotated%20genes,Odds%20ratio%20(log%20e),pvalue,Adjusted%20pvalue,Term%20annotation%20%%20per%20list,Annotated%20ids
         &colVisibility=1,0,0,1,1,0,1,1,0,0,0,1,1,1,0,0
         &_dc=1326109874569
         &page=1
         &start=0
         &limit=10
         &sort=%5B%7B%22property%22%3A%22List1%20unannotateds%22%2C%22direction%22%3A%22DESC%22%7D%5D
         &callback=Ext.data.JsonP.callback5

         http://ws.bioinfo.cipf.es/opencga-beta/rest/job/42/table?
         sessionid=6tpGsjjphxDMkCG74E89qMZTYTU26WGTXXoDLApUYoOJL07WyM2NGd0SbMhKe2Ll
         &filename=significant_your_annotation_0.1.txt
         &colNames=Term,Term%20size,Term%20size%20(in%20genome),List1%20annotateds,List1%20unannotateds,list1_per,List2%20annotateds,List2%20unannotateds,list2_per,List1%20annotated%20genes,List2%20annotated%20genes,Odds%20ratio%20(log%20e),pvalue,Adjusted%20pvalue,Term%20annotation%20%%20per%20list,Annotated%20ids
         &colVisibility=1,0,0,1,1,0,1,1,0,0,0,1,1,1,0,0
         &_dc=1326278871739
         &page=1
         &start=0
         &limit=5
         &filter=%5B%7B%22property%22%3A%22Term%22%2C%22value%22%3Aundefined%7D%2C%7B%22property%22%3A%22Term%22%2C%22value%22%3Aundefined%7D%5D
         &callback=Ext.data.JsonP.callback3
         http://ws.bioinfo.cipf.es/opencga-beta/rest/job/42/table?sessionid=6tpGsjjphxDMkCG74E89qMZTYTU26WGTXXoDLApUYoOJL07WyM2NGd0SbMhKe2Ll&filename=significant_your_annotation_0.1.txt&colNames=Term,Term%20size,Term%20size%20(in%20genome),List1%20annotateds,List1%20unannotateds,list1_per,List2%20annotateds,List2%20unannotateds,list2_per,List1%20annotated%20genes,List2%20annotated%20genes,Odds%20ratio%20(log%20e),pvalue,Adjusted%20pvalue,Term%20annotation%20%%20per%20list,Annotated%20ids&colVisibility=1,0,0,1,1,0,1,1,0,0,0,1,1,1,0,0&_dc=1326279241960&page=1&start=0&limit=5
         &filter=%5B%7B%22property%22%3A%22Term%22%2C%22value%22%3Aundefined%7D%5D
         &callback=Ext.data.JsonP.callback7
         http://ws.bioinfo.cipf.es/opencga-beta/rest/job/42/table?sessionid=6tpGsjjphxDMkCG74E89qMZTYTU26WGTXXoDLApUYoOJL07WyM2NGd0SbMhKe2Ll&filename=significant_your_annotation_0.1.txt&colNames=Term,Term%20size,Term%20size%20(in%20genome),List1%20annotateds,List1%20unannotateds,list1_per,List2%20annotateds,List2%20unannotateds,list2_per,List1%20annotated%20genes,List2%20annotated%20genes,Odds%20ratio%20(log%20e),pvalue,Adjusted%20pvalue,Term%20annotation%20%%20per%20list,Annotated%20ids&colVisibility=1,0,0,1,1,0,1,1,0,0,0,1,1,1,0,0&_dc=1326279394677&page=1&start=0&limit=5
         &filter=%5B%7B%22property%22%3A%22Term%22%2C%22value%22%3Aundefined%7D%5D&callback=Ext.data.JsonP.callback2
         *
         */
        if (rows == null) {
            rows = this.numRows;
        }
        var itemsPerPage = rows;

        this.st = Ext.create('Ext.data.Store', {
            fields: filteredColNames, //las colNames no pueden tener el caracter "."
            pageSize: itemsPerPage,
            remoteSort: false,
//		    remoteFilter:true,//TODO o no
            proxy: {
                url: url,
                type: 'ajax',
                reader: {
                    type: 'json',
                    root: 'items',
                    totalProperty: 'total'
                },
                extraParams: {
                    colNames: this.colNames.join(','),
                    colVisibility: this.colVisibilty.join(',')
                },
                actionMethods: {
                    read: 'POST'
                }
            }
        });
        this.st.loadPage(1);

        var altura = 75 + 30 * itemsPerPage;
        this.table = Ext.create('Ext.grid.Panel', {
            title: /*this.tableName+" - "+*/this.fileName,
            collapsible: this.collapsible,
            flex: this.flex,
            store: this.st,
            border: this.border,
            cls: this.cls,
            columns: filteredGridNames,
            height: altura,
//			selType: 'cellmodel',
            dockedItems: [
                {
                    xtype: 'pagingtoolbar',
                    store: this.st,   // same store GridPanel is using
                    dock: 'top',
                    displayInfo: true
                }
            ],
            renderTo: this.targetId
        });

    }
};

/***/
ResultTable.prototype.parse = function (data) {
    var _this = this;
    var lines = data.split("\n");
    var objLines = [];
    for (var i = 0; i < lines.length; i++) {
        if (lines[i].charAt(0) != "#" && lines[i] != "") {
            var fields = lines[i].split("\t");
            var obj = {};
            for (var j = 0; j < fields.length; j++) {
                if (fields[j] != "") {
                    obj[_this.tableSkel.colNames[j].replace(/ /g, "_")] = fields[j];
                }
            }
            objLines.push(obj);
        }
    }
    return objLines;
};
ResultTable.prototype.getTemplate = function (keys) {
    var str = "<p>";
    for (var i = 0; i < keys.length; i++) {
        str += '<span class="dis s90">' + keys[i] + ' </span> {' + keys[i].replace(/ /g, "_") + '} &nbsp; &nbsp; &nbsp;';
    }
    str += "</p>";
    return  new Ext.XTemplate(str);
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function ResultWidget(args) {
    var _this = this;

    //set default args
    this.extItems = [];

    this.collapseInformation = false;
    this.drawIndex = true;
    this.drawInformation = true;
    this.title = '';
    this.height;
    this.width;

    //set instantiation args, must be last
    _.extend(this, args);

    this.panelId = null;
    this.type;
    this.networkViewerId = null;
    this.genomeMapsId = null;
}

ResultWidget.prototype = {
    id: "ResultWidget" + Math.round(Math.random() * 10000),
    draw: function (sid, record) {
        var _this = this;
        this.job = record.data;

        this.job['command'] = Utils.parseJobCommand(this.job);

        this.jobId = this.job.id;
        this.id = this.jobId + this.id;
        this.panelId = "ResultWidget_" + this.jobId;

        this.panel = Ext.getCmp(this.panelId);

        var title = this.title;
        if (this.title === '') {
            title = this.job.name;
        } else {
            title = this.title + ' - ' + this.job.name
        }


        if (this.panel == null) {
            if (this.type == "window") {
                this.panel = Ext.create('Ext.window.Window', {
                    id: this.panelId,
                    bodyStyle: 'background:white;',
                    title: title,
                    closable: true,
                    height: this.height,
                    width: this.width,
                    autoScroll: true,
                    overflowY: 'auto',
                    maximizable: true,
                    layout: {
                        type: 'vbox',
                        align: 'stretch'
                    }
                });
            } else {
                this.panel = Ext.create('Ext.panel.Panel', {
                    id: this.panelId,
                    border: 0,
                    title: title,
                    closable: true,
                    autoScroll: true,
                    layout: {
                        type: 'vbox',
                        align: 'stretch'
                    }
                });
                Ext.getCmp(this.targetId).add(this.panel);
            }
            this.panel.setLoading("Loading job info...");


            /* Check job status before get result.js */
            if (this.job.status.indexOf('error') !== -1) {
                this.panel.add(this._getJobInfo());
                this.panel.add(this._getErrorInfo());

                OpencgaManager.jobInfo({
                    accountId: $.cookie("bioinfo_account"),
                    sessionId: sid,
                    jobId: this.jobId,
                    success: function (job) {

                    }
                });

                this.panel.setLoading(false);
            } else {
                /* Get result.js */
                var url = OpencgaManager.jobResultUrl({
                    accountId: $.cookie("bioinfo_account"),
                    sessionId: sid,
                    jobId: this.jobId,
                    format: "json"
                });
                console.log(url);
                $.getScript(url, function () {
                    _this.panel.setLoading(false);
                    _this.result = RESULT;
                    var layout = _this.result[_this.layoutName].layout;
                    layout.outputItems = _this.job.outputData.sort(layout.sortOutputItems);
                    layout.job = _this.job;

                    /**/
                    if (typeof layout.oldXML !== 'undefined') {
                        _this._parseOldXML(layout);
                    }
                    /**/

                    _this.render(_this.result);


                    if (_this.type == "window") {
                        _this.panel.show();
                    } else {
                        Ext.getCmp(_this.targetId).setActiveTab(_this.panel);
                    }
                });
            }

        } else {
            if (this.type == "window") {
                this.panel.show();
            } else {
                Ext.getCmp(this.targetId).setActiveTab(this.panel);
            }

        }
    },
    render: function (resultData) {
        var _this = this;
        console.log(this.application);

        var getResultIndex = function (children) {
            var boxes = [];
            for (var i = 0; i < children.length; i++) {
                boxes.push(Ext.create('Ext.Component', {
                    cls: 'ocb-pointer',
                    overCls: 'u err',
                    resultId: _this.jobId + children[i].title.replace(/ /g, ''),
                    html: children[i].title,
                    listeners: {
                        afterrender: function (este) {
                            this.getEl().on("click", function () {
                                var pos = $('#' + este.resultId).position();
                                if (typeof pos != 'undefined') {
                                    var top = pos.top;
                                    $(_this.panel.getEl().dom).children().scrollTop(top - 10);
                                }

                                var tab = Ext.getCmp(este.resultId);//for tab mode
                                var parent = tab.up();
                                if (parent.isXType('tabpanel')) {
                                    parent.setActiveTab(tab);
                                }
                            });
                        }
                    }
                }));
            }
            return Ext.create('Ext.panel.Panel', {
                title: 'Result index',
                header: {
                    baseCls: 'ocb-panel-title'
                },
                border: false,
                collapsible: true,
                titleCollapse: true,
                margin: 10,
                bodyPadding: 10,
                items: boxes
            });
        };

        var itemTpl = new Ext.XTemplate(
            '<span class="s120">{title}</span>',
            '<span class="ok"> {pathi} </span>',
            '<span class="info"> {date}</span><br>'
        );

        var processLeafItem = function (item) {
            var boxes = [];
            var itemBox;
            for (var j = 0; j < item.renderers.length; j++) {
                var renderer = item.renderers[j];
                itemBox = _this._processRenderer(item, renderer);
                boxes.push(itemBox);
            }
            return Ext.create('Ext.container.Container', {
                title: item.title,
                margin: '0 0 5 0',
                items: boxes
            });
        };

        /* Process recursively the result structure */
        var getDetailsAsDocument = function (item, isRoot) {
            var boxes;
            if (typeof item.children != 'undefined') {
                if (typeof item.children == 'function') {
                    item.children = item.children();
                }
                boxes = [];
                for (var i = 0; i < item.children.length; i++) {
                    boxes.push(getDetailsAsDocument(item.children[i]));
                }
                if (isRoot == true) {
                    var detailsItemsContainer;
                    if (item.presentation == 'tabs') {
                        detailsItemsContainer = Ext.create('Ext.tab.Panel', {
                            plain: true,
                            border: 0,
                            layout: {
                                type: 'vbox',
                                align: 'stretch'
                            },
                            defaults: {
                                padding: 10
                            },
                            items: boxes
//                            listeners:{
//                                tabchange:function(tabPanel, newTab){
//                                    newTab.getHeight();
//                                }
//                            }
                        });
                    } else {
                        detailsItemsContainer = Ext.create('Ext.container.Container', {
                            items: boxes
                        });
                    }
                    return Ext.create('Ext.panel.Panel', {
                        title: 'Result details',
//                        title: item.title,
                        header: {
                            baseCls: 'ocb-panel-title'
                        },
                        border: false,
                        collapsible: true,
                        titleCollapse: true,
                        margin: 10,
                        bodyPadding: 10,
                        items: [
                            detailsItemsContainer
                        ]
                    });
                } else {

                    if (_.isUndefined(item.title)) {

                        debugger
                    }

                    return Ext.create('Ext.panel.Panel', {
                        id: _this.jobId + item.title.replace(/ /g, ''),
                        title: item.title,
                        border: false,
                        header: {
                            baseCls: 'ocb-panel-title',
                        },
                        margin: '0 0 20 0',
                        bodyPadding: 5,
                        items: [
//                            {
//                                xtype: 'box',
//                                overCls: 'ocb-pointer',
//                                cls: 'panel-border-bottom',
//                                margin: '0 20 10 0',
//                                data: item, tpl: itemTpl,
//                                listeners: {
//                                    afterrender: function () {
//                                        this.getEl().on("click", function () {
//                                            $(_this.panel.getEl().dom).children().scrollTop(0);
//                                        });
//                                    }
//                                }
//                            },
                            {
                                xtype: 'container',
                                items: boxes
                            }
                        ]
                    });
                }
            } else {
                return processLeafItem(item);
            }
        };

        var detailedResutls;
        var root = resultData[this.layoutName].layout;
        if (root.presentation === 'custom') {
            if ('children' in root) {
                if (typeof root.children == 'function') {
                    root.children = root.children();
                    this._processCustomItem(root.children);
                    detailedResutls = root.children;
                }
            }
        } else {
            detailedResutls = getDetailsAsDocument(root, true);
        }
        if (this.drawInformation === true) {
            this.panel.add(this._getJobInfo());
        }
        this.panel.add(this._getJobActions({items: this.args}));
        if (this.drawIndex === true) {
            var indexResutl = getResultIndex(resultData[this.layoutName].layout.children);
            this.panel.insert(indexResutl);
        }
        this.panel.add(detailedResutls);

    },//end render


    _processRenderer: function (item, renderer) {
        var _this = this;
        var itemBox;
        switch (renderer.type) {
            case 'note':
                itemBox = Ext.create('Ext.Component', {
                    html: renderer.html,
                    item: item,
//                            overCls: 'encima',
                    cls: 'inlineblock whiteborder'
                });
                break;
            case 'message':
                itemBox = Ext.create('Ext.Component', {
                    html: '<div class="alert alert-' + item.type + '" style="text-align: center;font-size: 20px">' + item.title + '</div>',
                    item: item,
                    padding: 3
                });
                break;
            case 'html':
                itemBox = Ext.create('Ext.Component', {
                    html: renderer.html
                });
                break;
            case 'text':
                itemBox = Ext.create('Ext.Component', {
                    html: '<span class="key">' + item.title + ': </span> <span class="emph">' + item.file + '</span>',
                    item: item,
//                            overCls: 'encima',
                    cls: 'inlineblock whiteborder'
                });
                break;
            case 'file':
                itemBox = Ext.create('Ext.Component', {
                    html: '<span class="key">' + item.title + '</span><span class="file">' + item.file + '</span>',
                    item: item,
                    padding: 3,
                    overCls: 'encima',
                    cls: 'inlineblock whiteborder',
                    listeners: {
                        afterrender: function () {
                            var item = this.item;
                            this.getEl().on("click", function () {
                                console.log(item);
                                OpencgaManager.poll({
                                    accountId: $.cookie('bioinfo_account'),
                                    sessionId: $.cookie('bioinfo_sid'),
                                    jobId: _this.jobId,
                                    filename: item.file,
                                    zip: true
                                });
                            });
                        }
                    }
                });
                break;
            case 'image':
                var url = OpencgaManager.pollurl({
                    accountId: $.cookie('bioinfo_account'),
                    sessionId: $.cookie('bioinfo_sid'),
                    jobId: _this.jobId,
                    filename: item.file
                });
                itemBox = Ext.create('Ext.Img', {
                    src: url,
                    listeners: {
                        render: function (imgCmp) {
                            this.mon(this.getEl(), 'load', function (e) {
                                imgCmp.setWidth(this.getWidth());
                                imgCmp.setHeight(this.getHeight());
                            });
                        }
                    }
                });
                break;
            case 'piechart':

                var url = OpencgaManager.pollurl({
                    accountId: $.cookie('bioinfo_account'),
                    sessionId: $.cookie('bioinfo_sid'),
                    jobId: _this.jobId,
                    filename: item.file
                });

                var imgURL;
                $.ajax({
                    type: "GET",
                    async: false,
                    url: url,
                    success: function (data) {
                        if (data != "") {
                            var lines = data.split("\n");
                            var fields = [];
                            var names = [];
                            var values = [];
                            var normValues = [];
                            var total = 0;
                            for (var i = 0; i < lines.length; i++) {
                                fields.push(lines[i].split("\t"));
                                if (fields[i][0] != "") {
                                    names.push(fields[i][0]);
                                }
                                if (fields[i][1] != null) {
                                    total = total + parseFloat(fields[i][1]);
                                    values.push(fields[i][1]);
                                }
                            }
                            for (var i = 0; i < values.length; i++) {
                                normValues.push(Math.round(parseFloat(values[i]) / total * 100));
                            }
                            names = names.toString().replace(/,/gi, "|");
                            imgURL = 'https://chart.googleapis.com/chart?cht=p&chs=600x300&chd=t:' + normValues + '&chl=' + names + '&chtt=Consequence+types&chts=000000,14.5';
                        }
                    }
                });

//                        itemBox = Ext.create('Ext.Component', {
//                            html: '<div>' + img + '</div>',
//                        });

                itemBox = Ext.create('Ext.Img', {
                    src: imgURL,
                    listeners: {
                        render: function (imgCmp) {
                            this.mon(this.getEl(), 'load', function (e) {
                                imgCmp.setWidth(this.getWidth());
                                imgCmp.setHeight(this.getHeight());
                            });
                        }
                    }
                });
                break;
            case 'scatter':
                var url = OpencgaManager.pollurl({
                    accountId: $.cookie('bioinfo_account'),
                    sessionId: $.cookie('bioinfo_sid'),
                    jobId: _this.jobId,
                    filename: item.file
                });
                var data = [];
                $.ajax({
                    type: "GET",
                    async: false,
                    url: url,
                    success: function (d) {
                        var d = JSON.parse(d);
                        if (typeof renderer.processData === 'function') {
                            data = renderer.processData(d);
                        } else {
                            data = d;
                        }
                    }
                });
                var store = Ext.create('Ext.data.JsonStore', {
                    fields: renderer.fields,
                    data: data
                });


                var chart = Ext.create('Ext.chart.Chart', {
                    renderTo: Ext.getBody(),
                    width: 500,
                    height: 200,
                    animate: false,
//                            theme: 'Category1',
                    store: store,
                    axes: [
                        {
                            type: 'Numeric',
                            position: 'left',
                            fields: renderer.y.fields,
                            title: renderer.y.title,
                            grid: true,
                            maximum: renderer.y.max
                        },
                        {
                            type: 'Numeric',
                            position: 'bottom',
                            fields: renderer.x.fields,
                            title: renderer.x.title,
                            grid: true
                        }
                    ],
                    series: [
                        {
                            tips: {
                                trackMouse: true,
                                style: {
                                    backgroundColor: 'white'
                                },
                                renderer: function (este, item) {
                                    var xValue = item.storeItem.get(renderer.x.field);
                                    var yValue = item.storeItem.get(renderer.y.field);
                                    var html = '<div>' + renderer.x.field + ': <span style="font-weight: bold">' + xValue + '</span></div>' +
                                        '<div>' + renderer.y.field + ': <span style="font-weight: bold">' + yValue + '</span></div>';
                                    this.update(html);
                                }
                            },
                            type: 'scatter',
                            renderer: function (sprite, record, attributes, index, store) {
                                if (typeof renderer.config !== 'undefined') {
                                    return Ext.apply(attributes, renderer.config(record.data));
                                }
                            },
                            markerConfig: {
                                type: 'circle',
                                radius: 2,
                                size: 5
                            },
                            axis: 'left',
                            xField: renderer.x.field,
                            yField: renderer.y.field
                        }
                    ]
                });

                itemBox = Ext.create('Ext.container.Container', {
                    margin: '10 0 0 0',
                    items: [
                        {
                            xtype: 'box',
                            html: '<span class="key s120">' + item.title + '</span>'
                        },
                        chart
                    ]
                });
                break;
            case 'memory-grid':
                //Renderer must provide a data function and a field function
                var url = OpencgaManager.pollurl({
                    accountId: $.cookie('bioinfo_account'),
                    sessionId: $.cookie('bioinfo_sid'),
                    jobId: _this.jobId,
                    filename: item.file
                });
                var data = [];
                var fields = [];
                $.ajax({
                    type: "GET",
                    async: false,
                    url: url,
                    success: function (d) {
                        var d = JSON.parse(d);
                        data = renderer.data(d);
                        fields = renderer.fields(d);
                    }
                });
                var store = Ext.create('Ext.data.Store', {
                    pageSize: 50,
                    proxy: {
                        type: 'memory'
                    },
                    fields: fields,
                    data: data
                });
                var columns = [];
                for (var i = 0; i < fields.length; i++) {
                    columns.push({
                        "header": fields[i], "dataIndex": fields[i], flex: 1
                    });
                }
                itemBox = Ext.create('Ext.grid.Panel', {
                    title: item.title,
                    flex: 1,
                    store: store,
                    height: 200,
                    width: 400,
                    loadMask: true,
                    plugins: ['bufferedrenderer'],
                    columns: columns
                });
                break;
            case 'grid':
                var id = 'resultTable_' + _this.jobId + item.file;
                var resultTable = new ResultTable(_this.jobId, item.file, item.tags, {targetId: id, tableLayout: renderer.tableLayout});
                itemBox = Ext.create('Ext.Component', {
                    flex: 1,
                    resultTable: resultTable,
                    html: '<div id="' + id + '" style="padding:5px;"> </div>',
                    listeners: {
                        afterrender: function (este) {
                            este.resultTable.draw();
                        }
                    }
                });
                break;
            case 'file-paging-grid':
                var filteredFields = [];
                var filteredColumns = [];
                var fields = renderer.tableLayout.fields;
                var columns = renderer.tableLayout.columns;
                var visibility = renderer.tableLayout.visibility;
                var types = renderer.tableLayout.types;
                var order = renderer.tableLayout.order;
                for (var i = 0; i < fields.length; i++) {
                    if (visibility[i] == 1) {
                        var field = fields[i];
                        var column = columns[i];
                        column.width = (field.length * 10) + 30;
                        filteredFields.push({name: field, type: types[i]});
                        filteredColumns.push(column);

//                                filteredFields.push({header: fields[i], dataIndex: fields[i], width: ((fields[i].length * 10) + 30)});
//                                filteredColumns.push();
                    }
                }
                var url = OpencgaManager.tableurl({
                    accountId: $.cookie("bioinfo_account"),
                    sessionId: $.cookie('bioinfo_sid'),
                    jobId: _this.jobId,
                    filename: item.file
                });
                var store = Ext.create('Ext.data.Store', {
                    pageSize: 10,
                    fields: filteredFields,
                    remoteSort: true,
                    proxy: {
                        url: url,
                        type: 'ajax',
                        reader: {
                            root: 'items',
                            totalProperty: 'total',
                            transform: function (response) {
                                return response;
                            }
                        },
                        extraParams: {
                            colNames: fields.join(','),
                            colVisibility: visibility.join(',')
                        },
                        actionMethods: {create: 'GET', read: 'GET', update: 'GET', destroy: 'GET'}
                    }
                });
                store.load();

                var paging = Ext.create('Ext.PagingToolbar', {
                    store: store,
                    pageSize: 10,
                    displayInfo: true,
                    displayMsg: 'Rows {0} - {1} of {2}',
                    emptyMsg: "No rows to display"
                });
                itemBox = Ext.create('Ext.grid.Panel', {
                        title: item.title,
                        store: store,
                        border: true,
                        header: {
                            baseCls: 'ocb-panel-title'
                        },
                        loadMask: true,
                        columns: filteredColumns,
                        plugins: 'bufferedrenderer',
                        height: renderer.height,
                        width: renderer.width,
                        features: [
                            {ftype: 'summary'}
                        ],
                        viewConfig: {
                            emptyText: 'No records to display',
                            enableTextSelection: true
                        },
                        tbar: paging
                    }
                );
                break;
            case 'vcf-grid':
                var id = 'resultTable_' + _this.jobId + item.file;

                var table = {
                    name: "Stats Samples Table",
                    colNames: ["CHROM", "POS", "ID", "REF", "ALT", "QUAL", "FILTER", "INFO", "FORMAT"],
                    colTypes: ["string", "int", "string", "string", "string", "string", "string", "string", "string"],
                    colVisibility: [1, 1, 1, 1, 1, 1, 1, 1, 1],
                    colOrder: [0, 1, 2, 3, , 4, 5, 6, 7, 8, 9]
                };


                var session_id = $.cookie('bioinfo_sid');
                var accountId = $.cookie('bioinfo_account');

                OpencgaManager.jobFileGrep({
                    pattern: "^#CHR.*",
                    ignoreCase: "true",
                    multi: false,
                    filename: item.file,
                    sessionId: session_id,
                    accountId: accountId,
                    jobId: _this.jobId,
                    async: false,
                    success: function (data, textStatus, jqXHR) {
                        var fields = data.trim().split("\t");

                        for (var i = 9; i < fields.length; i++) {
                            table.colNames.push(fields[i]);
                            table.colTypes.push("string");
                            table.colVisibility.push(1);
                            table.colOrder.push((fields[i - 1] + 1));
                        }

                        var resultTable = new ResultTable(_this.jobId, item.file, item.tags, {targetId: id, tableLayout: table});
                        itemBox = Ext.create('Ext.Component', {
                            flex: 1,
                            resultTable: resultTable,
                            html: '<div id="' + id + '" style="padding:5px;"> </div>',
                            listeners: {
                                afterrender: function (este) {
                                    este.resultTable.draw();
                                }
                            }
                        });
                    }
                });


                break;
            case 'table':
                var url = OpencgaManager.pollurl({
                    accountId: $.cookie('bioinfo_account'),
                    sessionId: $.cookie('bioinfo_sid'),
                    jobId: _this.jobId,
                    filename: item.file
                });
                $.ajax({
                    type: "GET",
                    async: false,
                    url: url,
                    success: function (data) {
                        var tableHtml = '<table class="ocb-attributes-table"><tbody>';
                        var lines = data.split('\n');

                        try {
                            var firstLine = lines[0];
                            if (renderer.header && firstLine.charAt(0) === '#') {
                                firstLine = firstLine.substr(1);
                                var fields = firstLine.split('\t');
                                tableHtml += '<thead>';
                                for (var j = 0; j < fields.length; j++) {
                                    var field = fields[j];
                                    tableHtml += '<td class="header">' + field + '</td>';
                                }
                                tableHtml += '</thead>';
                            }
                        } catch (e) {

                        }

                        tableHtml += '<tbody>';
                        for (var i = 0; i < lines.length; i++) {
                            var line = lines[i];
                            if (line.charAt(0) != '#' && line.trim() != '') {
                                tableHtml += '<tr>';
                                var fields = line.split('\t');
                                for (var j = 0; j < fields.length; j++) {
                                    var field = fields[j];
                                    tableHtml += '<td>' + field + '</td>';
                                }
                                tableHtml += '</tr>';
                            }
                        }
                        tableHtml += '</tbody></table>';

                        itemBox = Ext.create('Ext.Component', {
                            flex: 1,
                            html: tableHtml
                        });

                    }
                });
                break;
            case 'network-viewer':
                var div = _this._createNetworkViewer(item, renderer);
                itemBox = Ext.create("Ext.container.Container", {
                    contentEl: div
                });
                break;
            case 'genome-viewer':
                var div = document.createElement('div');
                $(div).css({
                    height: '1200px'
                });
                var gmDiv = document.createElement('div');
                $(gmDiv).css({
                    width: '1500px',
                    marginTop: '10px',
                    border: '1px solid lightgray'
                });
                var vfwDiv = document.createElement('div');
                $(vfwDiv).css({
                    width: '1500px',
                    height: '300px'
                });
                div.appendChild(vfwDiv);
                div.appendChild(gmDiv);
//                        var gm_id = Utils.genId('gm');
//                        var vfw_id = Utils.genId('vfw');
//                        var html =
//                            '<div style="width:1500px;height:1200px;">' +
//                            '<div id="' + vfw_id + '" style="width:1500px;">' +
//                            '</div>' +
//                            '<div id="' + gm_id + '" style="width:1500px;height:800px;">' +
//                            '</div>' +
//                            '</div>';
                itemBox = Ext.create('Ext.Component', {
                    flex: 1,
                    contentEl: div,
                    listeners: {
                        afterrender: function () {
                            var gv = _this._createGenomeViewer(gmDiv);
                            _this._createVariantFilterWidget(vfwDiv, gv, _this.result[_this.layoutName].layout.variantFilterFiles, renderer.tableLayout);
                        }
                    }
                });
                break;
            case 'variant-stats-widget':
                var height = 800;
                itemBox = Ext.create('Ext.container.Container', {
                    height: height,
                    width: '95%',
                    style: {
                        position: 'relative'
                    },
                    listeners: {
                        afterrender: function () {
                            var variantStatsWidget = new VariantStatsWidget({
                                targetId: itemBox,
                                height: height,
                                closable: false,
                                border: true,
//                                        title:  _this.job.name,
                                job: _this.job,
                                autoRender: true
                            });
                            variantStatsWidget.draw();
                        }
                    }
                });

                break;

            case 'variant-widget':
                var height = 800;
                itemBox = Ext.create('Ext.container.Container', {
                    height: height,
                    width: '95%',
                    style: {
                        position: 'relative'
                    },
                    listeners: {
                        afterrender: function () {

                            var url = OpencgaManager.getJobAnalysisUrl($.cookie("bioinfo_account"), _this.job.id) + '/variantsMongo';
                            console.log("URL: " + url);

                            var variantWidget = new VariantWidget({
                                targetId: itemBox,
                                height: height,
                                closable: false,
                                border: true,
                                url: url,
//                                        title:  _this.job.name,
                                job: _this.job,
                                autoRender: true
                            });
                            variantWidget.draw();
                        }
                    }
                });

                break;
        }
        return itemBox;
    },
    _processCustomItem: function (item) {
        // Not ExtJS Component
        if ('renderers' in item) {
            var newItems = [];
            for (var j = 0; j < item.renderers.length; j++) {
                var renderer = item.renderers[j];
                newItems.push(this._processRenderer(item, renderer));
            }
            delete item.renderers;
            item.xtype = 'container';
            item.margin = 5;
            item.items = newItems;
        } else {
            if ('items' in item) {
                for (var j = 0; j < item.items.length; j++) {
                    this._processCustomItem(item.items[j]);
                }
            }
        }


    },

    _getErrorInfo: function () {
        var container = Ext.create('Ext.container.Container', {
            margin: 10
        });

        $.ajax({
            type: "GET",
            async: false,
            url: OpencgaManager.pollurl({
                accountId: $.cookie('bioinfo_account'),
                sessionId: $.cookie('bioinfo_sid'),
                jobId: this.jobId,
                filename: 'sge_err.log'
            }),
            success: function (d) {
                container.add({
                    title: 'Error log',
                    bodyPadding: '0 10',
                    border: false,
                    header: {
                        baseCls: 'ocb-panel-title'
                    },
                    style: {
                        borderBottom: '1px solid lightgray'
                    },
                    maxHeight: 400,
                    overflowY: true,
                    html: '<pre>' + d + '</pre>'
                })
            }
        });
        $.ajax({
            type: "GET",
            async: false,
            url: OpencgaManager.pollurl({
                accountId: $.cookie('bioinfo_account'),
                sessionId: $.cookie('bioinfo_sid'),
                jobId: this.jobId,
                filename: 'sge_out.log'
            }),
            success: function (d) {
                container.add({
                    title: 'Out log',
                    bodyPadding: '0 10',
                    margin: '20 0 0 0',
                    border: false,
                    header: {
                        baseCls: 'ocb-panel-title'
                    },
                    style: {
                        borderBottom: '1px solid lightgray'
                    },
                    maxHeight: 400,
                    overflowY: true,
                    html: '<pre>' + d + '</pre>'
                })
            }
        });

        return container;
    },

    _getJobInfo: function () {
        var _this = this;
        var itemTpl = new Ext.XTemplate(
            '<div class="s110">',
            '<div style="display:inline-block;color:steelblue;width: 45px;">Id: </div>{id}<br>',
            '<div style="display:inline-block;color:steelblue;width: 45px;">Name: </div>{name}<br>',
            '<div style="display:inline-block;color:steelblue;width: 45px;">Tool: </div>{toolName}<br>',
            '<div style="display:inline-block;color:steelblue;width: 45px;">Date: </div>{date}<br>',
            '</div>',
            '<p class="tip emph">{description}</p>',
            '<p class="">{command.html}</p>'
        );
        var container = Ext.create('Ext.panel.Panel', {
            title: 'Information',
            header: {
                baseCls: 'ocb-panel-title'
            },
            border: false,
            collapsible: true,
            titleCollapse: true,
            collapsed: this.collapseInformation,
            margin: 10,
            bodyPadding: 10,
            items: [
                {
                    xtype: 'box',
                    data: this.job,
                    tpl: itemTpl
                }
            ]
        });
        return container;
    },
    _getJobActions: function (args) {
        var _this = this;
        var args = args || {};
        var container = Ext.create('Ext.container.Container', {
            margin: 10,
            bodyPadding: 10,
            layout: {
                type: 'hbox',
                align: 'stretch'
            },
            defaults: {margin: '0 5 0 5'},
            items: [
                {
                    xtype: 'button',
                    text: 'download',
                    handler: function () {
                        OpencgaManager.downloadJob({
                            accountId: $.cookie('bioinfo_account'),
                            sessionId: $.cookie('bioinfo_sid'),
                            jobId: _this.jobId
                        })
                    }
                },
                {
                    xtype: 'button',
                    text: 'delete',
                    handler: function () {
                        Ext.Msg.confirm("Delete job", "Are you sure you want to delete this job?", function (btnClicked) {
                            if (btnClicked == "yes") {
                                OpencgaManager.deleteJob({
                                    accountId: $.cookie('bioinfo_account'),
                                    sessionId: $.cookie('bioinfo_sid'),
                                    jobId: this.jobId,
                                    success: function (response) {
                                        if (response.errorMsg === '') {
                                            Utils.msg('Delete job', '</span class="emph">' + response.result[0].msg + '</span>');
                                        } else {
                                            Ext.Msg.alert('Delete job, try again later.', response.errorMsg);
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
            ]
        });
        if (typeof args.items != 'undefined') {
            container.add(args.items);
        }
        return container;
    },

    _createGenomeViewer: function (target) {
        var _this = this;
        var genomeViewer = new GenomeViewer({
            cellBaseHost: 'http://bioinfo.hpc.cam.ac.uk/cellbase/webservices/rest',
            cellBaseVersion: 'v3',
            target: target,
            width: $(target).width(),
            region: new Region(DEFAULT_SPECIES.region),
            availableSpecies: AVAILABLE_SPECIES,
            species: DEFAULT_SPECIES,
            sidePanel: false,
            resizable: false,
//        quickSearchResultFn:quickSearchResultFn,
//        quickSearchDisplayKey:,
            karyotypePanelConfig: {
                collapsed: false,
                collapsible: true
            },
            chromosomePanelConfig: {
                collapsed: false,
                collapsible: true
            },
            navigationBarConfig: {
                componentsConfig: {
//                restoreDefaultRegionButton:false,
//                regionHistoryButton:false,
//                speciesButton:false,
//                chromosomesButton:false,
//                karyotypeButton:false,
//                chromosomeButton:false,
//                regionButton:false,
//                zoomControl:false,
//                windowSizeControl:false,
//                positionControl:false,
//                moveControl:false,
//                autoheightButton:false,
//                compactButton:false,
//                searchControl:false
                }
            },
            handlers: {
                'region:change': function (e) {
                    console.log(e)
                }
            }
//        chromosomeList:[]
//            trackListTitle: ''
//            drawNavigationBar = true;
//            drawKaryotypePanel: false,
//            drawChromosomePanel: false,
//            drawOverviewTrackListPanel: false

        }); //the div must exist

        var tracks = [];
        this.sequence = new SequenceTrack({
//        title: 'Sequence',
            height: 30,
            visibleRegionSize: 200,

            renderer: new SequenceRenderer(),

            dataAdapter: new SequenceAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "sequence",
                species: genomeViewer.species
            })
        });

        tracks.push(this.sequence);

        this.gene = new GeneTrack({
            title: 'Gene',
            minHistogramRegionSize: 20000000,
            maxLabelRegionSize: 10000000,
            minTranscriptRegionSize: 200000,
            height: 140,

            renderer: new GeneRenderer(),

            dataAdapter: new CellBaseAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "gene",
                species: genomeViewer.species,
                params: {
                    exclude: 'transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence'
                },
                cacheConfig: {
                    chunkSize: 100000
                }
            })
        });

        tracks.push(this.gene);


        var renderer = new FeatureRenderer(FEATURE_TYPES.gene);
        renderer.on({
            'feature:click': function (event) {
                // feature click event example
                console.log(event)
            }
        });
        var gene = new FeatureTrack({
//        title: 'Gene overview',
            minHistogramRegionSize: 20000000,
            maxLabelRegionSize: 10000000,
            height: 100,

            renderer: renderer,

            dataAdapter: new CellBaseAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "gene",
                params: {
                    exclude: 'transcripts,chunkIds'
                },
                species: genomeViewer.species,
                cacheConfig: {
                    chunkSize: 100000
                }
            })
        });
        genomeViewer.addOverviewTrack(gene);

        this.snp = new FeatureTrack({
            title: 'SNP',
            featureType: 'SNP',
            minHistogramRegionSize: 10000,
            maxLabelRegionSize: 3000,
            height: 100,

            renderer: new FeatureRenderer(FEATURE_TYPES.snp),

            dataAdapter: new CellBaseAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "snp",
                params: {
                    exclude: 'transcriptVariations,xrefs,samples'
                },
                species: genomeViewer.species,
                cacheConfig: {
                    chunkSize: 10000
                }
            })
        });

        tracks.push(this.snp);


        genomeViewer.addTrack(tracks);


        genomeViewer.draw();


//        var genomeViewer = new GenomeViewer({
//            handlers: {
//                'species:change': function (event) {
////            _this._setTracks();
////            _this.setTracksMenu();
//                    _this.species = event.species;
//                    var text = _this.species.text + ' <span style="color: #8396b2">' + _this.species.assembly + '</span>';
//                    _this.headerWidget.setDescription(text);
////                    _this._refreshInitialTracksConfig();
//                }
//            }
//        });


        genomeViewer.chromosomePanel.hide();
        genomeViewer.karyotypePanel.hide();


        var filteredFile = this.result[_this.layoutName].layout.filteredFile;
        if (!_.isUndefined(filteredFile)) {
            OpencgaManager.poll({
                accountId: $.cookie('bioinfo_account'),
                sessionId: $.cookie('bioinfo_sid'),
                jobId: _this.jobId,
                filename: filteredFile,
                zip: false,
                success: function (data) {
                    if (data.indexOf("ERROR") != -1) {
                        console.error(data);
                    }
                    var vcfDataAdapter = new VCFDataAdapter(new StringDataSource(data), {async: false, species: genomeViewer.species});

                    var fileTrack = new FeatureTrack({
                        targetId: null,
                        id: "VCF file",
                        title: filteredFile,
                        height: 150,
                        minHistogramRegionSize: 12000,
                        maxLabelRegionSize: 3000,
                        renderer: new FeatureRenderer(FEATURE_TYPES.vcf),
                        dataAdapter: vcfDataAdapter
                    });

                    genomeViewer.addTrack(fileTrack);
                }
            });
        } else {
            console.log("No filtered VCF file.");
        }

        return genomeViewer;
    },
    _createVariantFilterWidget: function (target, gv, variantFilterFiles, tableLayout) {
        var variantFilterWidget = new VariantFilterWidget(this.jobId, {
            width: $(target).width(),
            height: $(target).height(),
            targetId: target,
            viewer: gv,
//            fileNames:_this.variantFiles
            fileNames: variantFilterFiles,
            tableLayout: tableLayout
        });
        variantFilterWidget.getPanel(target);

        return variantFilterWidget;
    },

    _createNetworkViewer: function (item, renderer) {
        var _this = this;
        var div = document.createElement('div');
        div.style.width = renderer.width + 2 + 'px';
        div.style.height = renderer.height + 2 + 'px';
        div.style.border = '1px solid lightgray';
        div.style.marginTop = '10px';

        var networkViewer = new NetworkViewer({
            target: div,
            autoRender: true,
            sidePanel: false,
            border: false,
            width: renderer.width,
            height: renderer.height,
            session: new NetworkSession(),
            handlers: {
                'select:vertices': function (e) {
//                    _this.vertexAttributeEditWidget.checkSelectedFilter();
                },
                'select:edges': function (e) {
//                    _this.edgeAttributeEditWidget.checkSelectedFilter();
                },
                'change:vertexAttributes': function (e) {
//                    _this.toolbar.setVertexAttributes(e.sender);
                },
                'change:edgeAttributes': function (e) {

                }
            }
        });
        networkViewer.draw();


        if('utils' in renderer){
            $.ajax({
                type: "POST",
                url: OpencgaManager.getUtilsUrl() + renderer.utils.name,
                data:  renderer.utils.params,
                dataType: 'json',
                success: function (data, textStatus, jqXHR) {
                    renderer.utils.success(data, networkViewer);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('error')
                }
            });
        }
        return div;
    },

    /*************************************/
    /*************************************/
    /*************************************/
    _parseOldXML: function (layout) {

        OpencgaManager.poll({
            accountId: $.cookie('bioinfo_account'),
            sessionId: $.cookie('bioinfo_sid'),
            jobId: layout.job.id,
            filename: layout.oldXML,
            zip: false,
            async: false,
            success: function (data) {
                var xmlDoc = $.parseXML(data);
                layout.xml = $(xmlDoc);
            }
        });
    }

};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function UploadWidget(args) {
    var _this = this;
    _.extend(this, Backbone.Events);
    this.id = Utils.genId("uploadWidget");

    this.targetId = null;
    this.suiteId = null;
    this.chunkedUpload = false;
    this.enableTextMode = true;

    if (typeof args !== 'undefined') {
        this.targetId = args.targetId || this.targetId;
        this.suiteId = args.suiteId || this.suiteId;
        this.opencgaBrowserWidget = args.opencgaBrowserWidget || this.opencgaBrowserWidget;
        this.chunkedUpload = args.chunkedUpload || this.chunkedUpload;
    }
    this.uploadObjectToBucketSuccess = function (response) {
        if (response.errorMsg === '') {
            Utils.msg('Object upload', '</span class="emph">' + response.result[0].msg + '</span>');
            _this.uploadComplete(response.result[0].msg);
        } else {
            Ext.Msg.alert('Object upload', response.errorMsg);
            _this.uploadFailed(response.errorMsg);
        }
        _this.trigger('object:upload', {sender: _this, data: response.result[0].msg });
    };

    this.uploadButtonId = this.id + '_uploadButton';
    this.uploadFieldId = this.id + '_uploadField';

    this.selectedDataType = null;

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

}

//UploadWidget.prototype.getsdf = function(){
//	return this.id+'_uploadButton';
//};

UploadWidget.prototype = {
    getTypeValidation: function (types) {
        return function (filename) {
            var regex = new RegExp('^.*\\.(' + types + ')$', 'i');
            return regex.test(filename);
        }
    }
};


UploadWidget.prototype.draw = function (opencgaLocation) {
    this.opencgaLocation = opencgaLocation;
    var dataTypes = {
        "9": [
            { text: "ID List", children: [
                { text: "SNP", tag: "idlist:snp"},//el tag es para introducirlo en la base de datos al subir los datos
                { text: "Gene/Transcript", tag: "idlist:gene:transcript"}//si son varios van separados por ->  :
            ] },
            { text: "Feature", children: [
                { text: "VCF 4.0", tag: "vcf", validate: this.getTypeValidation('vcf')},
//		                { text: "Tabix index", tag:"tbi"},
                { text: "GFF2", tag: "gff2"},
                { text: "GFF3", tag: "gff3"},
                { text: "GTF", tag: "gtf"},
                { text: "BED", tag: "bed"},
                { text: "BAM", tag: "bam", validate: this.getTypeValidation('bam')},
                { text: "BAI", tag: "bai", validate: this.getTypeValidation('bai')},
                { text: "Expression", tag: "expression"}
            ] }
        ],
        "6": [
            { text: "Feature", children: [
                { text: "VCF 4.0", tag: "vcf"},
                { text: "GFF2", tag: "gff2"},
                { text: "GFF3", tag: "gff3"},
                { text: "GTF", tag: "gtf"},
                { text: "BED", tag: "bed"},
                { text: "PED", tag: "ped"}
            ] }
        ],
        "11": [
            {text: "Annotation", tag: "annotation"},
            {text: "ID List", children: [
                { text: "Gene", tag: "idlist:gene"    },
                { text: "Ranked", tag: "ranked"    }
            ]
            }
        ],
        "12": [
            {text: "Abundances", tag: "abundances"}
        ],
        "100": [
            {text: "Sequence", tag: "sequence"}
        ],
        "22": [
            {text: "Tabbed text file", tag: "txt", validate: this.getTypeValidation('txt|text')},
            {text: "CEL compressed file", tag: "cel", validate: this.getTypeValidation('zip|tar|tar.gz|tgz')}
        ],
        "85": [
            { text: "Feature", children: [
                { text: "VCF 4.0", tag: "vcf", validate: this.getTypeValidation('vcf')},
                { text: "PED", tag: "ped", validate: this.getTypeValidation('ped')}
            ] }
        ],
        "cellmaps": [
            { text: "Network", children: [
                { text: "SIF", tag: "sif", validate: this.getTypeValidation('sif')},
                { text: "Expresion matrix", tag: "txt", validate: this.getTypeValidation('txt')},
                { text: "Text", tag: "txt", validate: this.getTypeValidation('txt')}
            ] }
        ]
    };

    if (typeof dataTypes[this.suiteId] === 'undefined') {
        this.render([
            {text: "No data types defined"}
        ]);
    } else {
        this.checkDataTypes(dataTypes[this.suiteId]);
        this.render(dataTypes[this.suiteId]);
    }

//    switch (this.suiteId) {
//        case 9:
//            this.checkDataTypes(dataTypes["9"]);
//            this.render(dataTypes["9"]);
//            break;
//        case 6:
//            this.checkDataTypes(dataTypes["6"]);
//            this.render(dataTypes["6"]);
//            break;
//        case 11:
//            this.checkDataTypes(dataTypes["11"]);
//            this.render(dataTypes["11"]);
//            break;
//        case 12:
//            this.checkDataTypes(dataTypes["12"]);
//            this.render(dataTypes["12"]);
//            break;
//        case 22:
//            this.checkDataTypes(dataTypes["22"]);
//            this.render(dataTypes["22"]);
//            break;
//        case 85:
//            this.checkDataTypes(dataTypes["85"]);
//            this.render(dataTypes["85"]);
//            break;
//        case 100:
//            this.checkDataTypes(dataTypes["100"]);
//            this.render(dataTypes["100"]);
//            break;
//        case "cellmaps":
//            this.checkDataTypes(dataTypes["cellmaps"]);
//            this.render(dataTypes["cellmaps"]);
//            break;
//    }
};

UploadWidget.prototype.clean = function () {
    if (this.panel != null) {
        this.panel.destroy();
        delete this.panel;
        console.log(this.id + ' PANEL DELETED');
    }
};

UploadWidget.prototype.checkDataTypes = function (dataTypes) {
    for (var i = 0; i < dataTypes.length; i++) {
        if (dataTypes[i]["children"] != null) {
//            dataTypes[i]["iconCls"] = 'icon-box';
            dataTypes[i]["expanded"] = true;
            this.checkDataTypes(dataTypes[i]["children"]);
        } else {
//            dataTypes[i]["iconCls"] = 'icon-blue-box';
            dataTypes[i]["leaf"] = true;
        }
    }
};

UploadWidget.prototype.render = function (dataTypes) {
    var _this = this;
    if (this.panel == null) {
        var store = Ext.create('Ext.data.TreeStore', {
            root: {
                expanded: true,
                text: "Data type",
                children: dataTypes
            }
        });
//        var height = Object.keys(store.tree.nodeHash).length * 23;
//        if (height < 250) {
//            height = 250;
//        }

        var height = 400;

        var pan1Width = 250;
        var pan1 = Ext.create('Ext.tree.Panel', {
            header: {
                baseCls: 'header-form'
            },
            title: 'Select your data type <span style="color:gray">(req)</span>',
            bodyPadding: '10 0 0 0',
            height: height,
            border: false,
            width: pan1Width,
            store: store,
            useArrows: true,
            rootVisible: false,
            listeners: {
                scope: this,
                itemclick: function (este, record) {
                    if (record.data.leaf) {
                        this.selectedDataType = record.data.tag;
                        this.selectedDataTypeObj = record.data;
                        this.dataTypeLabel.update('<span class="info">Type:</span><span class="ok"> OK </span>');
                    } else {
                        this.selectedDataType = undefined;
                        this.selectedDataTypeObj = undefined;
                        this.dataTypeLabel.update('<span class="info">Select a data type</span><span class="err"> !!!</span>');
                    }
                    this.validate();
                }
            }
        });

        this.nameField = Ext.create('Ext.form.field.Text', {
            name: 'datalabel',
            fieldLabel: 'Data name',
            labelWidth: 110,
            msgTarget: 'side',
            //allowBlank: false,
            enableKeyEvents: true,
            listeners: {
                scope: this,
                change: function (el) {
                    if (el.getValue() != "") {
                        this.dataNameLabel.update('<span class="info">Name:</span><span class="ok"> OK </span>');
                    } else {
                        this.dataNameLabel.update('<span class="info">Enter the data name</span><span class="err"> !!!</span>');
                    }
                    this.validate();
                }
            }
        });
        this.textArea = Ext.create('Ext.form.field.TextArea', {
            name: 'datadescription',
            fieldLabel: 'Data description',
            labelWidth: 110,
            msgTarget: 'side'
        });
        this.organizationField = Ext.create('Ext.form.field.Text', {
            name: 'organization',
            fieldLabel: 'Organization',
            labelWidth: 110,
            msgTarget: 'side'
        });
        this.responsableField = Ext.create('Ext.form.field.Text', {
            name: 'responsable',
            fieldLabel: 'Responsible',
            labelWidth: 110,
            msgTarget: 'side'
        });
        this.acquisitiondate = Ext.create('Ext.form.field.Text', {
            name: 'acquisitiondate',
            fieldLabel: 'Acquisition date',
            labelWidth: 110,
            msgTarget: 'side'
        });

        var pan2Width = 350;
        var pan2 = Ext.create('Ext.panel.Panel', {
            title: 'Aditional information',
            header: {
                baseCls: 'header-form'
            },
            width: pan2Width,
            border: false,
//            cls: 'panel-border-top',
            height: height,
            bodyPadding: 15,
            items: [this.nameField, this.textArea, this.organizationField, this.responsableField, this.acquisitiondate]

        });

        this.dataTypeLabel = Ext.create('Ext.Component', {
            html: '<span class="info">Select a data type</span>'
        });
        this.dataNameLabel = Ext.create('Ext.Component', {
            html: '<span class="info">Enter the data name</span>'
        });
        this.dataFieldLabel = Ext.create('Ext.Component', {
            html: '<span class="info">Select a data file</span>'
        });
        this.originCheck = Ext.create('Ext.form.field.Checkbox', {
            xtype: 'checkbox',
            hidden: !this.enableTextMode,
            boxLabel: 'Text mode',
            margin: '0 0 0 0',
            listeners: {
                scope: this,
                change: function () {
                    if (this.originCheck.getValue()) {
                        this.dataFieldLabel.update('<span class="ok">' + this.editor.getValue().length + '</span><span class="info"> chars</span>');
                        this.uploadField.hide();
                        this.editor.show();
                        this.uploadField.setRawValue(null);
                    } else {
                        this.dataFieldLabel.update('<span class="info">Select a data file</span>');
                        this.editor.hide();
                        this.uploadField.show();
                        this.editor.setRawValue(null);
                    }
                    this.validate();
                }
            }
        });
        var uploadButton = Ext.create('Ext.button.Button', {
            id: this.uploadButtonId,
            text: 'Upload',
            disabled: true,
            handler: function () {
//				_this.uploadMsg =  Ext.Msg.show({
//					 closable:false,
//				     title:'Uploading file',
//				     msg: 'Please wait...'
//				});
                if (_this.chunkedUpload) {
                    _this.uploadFile2();
                } else {
                    _this.uploadFile();
                }
            }
        });


        this.editor = Ext.create('Ext.form.field.TextArea', {
            xtype: 'textarea',
            emptyText: 'Paste or write your file directly',
            hidden: true,
            name: 'file',
            width:'100%',
            height:100,
            enableKeyEvents: true,
            listeners: {
                scope: this,
                change: function () {
                    this.dataFieldLabel.update('<span class="ok">' + this.editor.getValue().length + '</span> <span class="info"> chars</span>');
                    this.validate();
                }

            }
        });


        this.createUploadField();
        this.pan3 = Ext.create('Ext.panel.Panel', {
            title: 'Data file',
            header: {
                baseCls: 'header-form'
            },
            colspan: 2,
            border: false,
            padding: 5,
            bodyPadding: 15,
            width: pan1Width + pan2Width,
            items: [this.editor, this.uploadField]
        });

        this.panel = Ext.create('Ext.window.Window', {
            title: 'Upload a data file',// + ' -  <span class="err">ZIP files will be allowed shortly</span>',
            iconCls: 'icon-upload',
            resizable: false,
//		    minimizable :true,
            constrain: true,
            closable: false,
            modal: true,
            items: {
                border: 0,
                layout: {
                    type: 'vbox',
                    align: 'stretch'
                },
                items: [
                    this.pan3,
                    {
                        xtype: 'container',
                        padding: 5,
                        layout: {
                            type: 'hbox',
                            align: 'stretch'
                        },
                        items: [pan1, pan2]
                    },
                ],
                dockedItems: [
                    {
                        xtype: 'toolbar',
                        dock: 'bottom',
                        layout: {
                            pack: 'end'
                        },
                        defaults: {
                            width: 100
                        },
                        items: [
                            {
                                text: "Close",
                                handler: function () {
                                    _this.panel.minimize();
                                }
                            },
                            uploadButton
                        ]
                    },
                    {
                        xtype: 'toolbar',
                        dock: 'bottom',
                        items: [this.originCheck, '->', this.dataTypeLabel, /*this.dataNameLabel,'-',*/this.dataFieldLabel, ]
                    },
                ]
            },
            listeners: {
                scope: this,
                minimize: function () {
                    this.panel.hide();
                    this.uploadField.setRawValue(null);
                    this.editor.setRawValue(null);
                    this.originCheck.setValue(false);
                }
            }
        });
    }
    this.panel.show();
};


UploadWidget.prototype.createUploadField = function () {
    this.uploadField = Ext.create('Ext.form.field.File', {
        id: this.uploadFieldId,
        xtype: 'filefield',
        name: 'file',
        msgTarget: 'side',
        emptyText: 'Choose a file',
        width: 500,
        allowBlank: false,
        buttonText: 'Upload local file...',
        buttonAlign: 'left',
        rtl: false,
        listeners: {
            scope: this,
            change: function () {
                this.fileSelected();
                this.validate();
            }
        }
    });
};

UploadWidget.prototype.validate = function () {
//	console.log(this.selectedDataType != null);
//	console.log(this.nameField.getValue() !="");
//	console.log((this.uploadField.getRawValue()!="" || this.editor.getValue()!=""));

    var extensionValid = true;
    if (typeof this.selectedDataTypeObj !== 'undefined') {
        if (typeof this.selectedDataTypeObj.validate !== 'undefined') {
            extensionValid = this.selectedDataTypeObj.validate(Ext.getCmp(this.uploadFieldId).getValue());
        }
    }

    if (extensionValid && this.selectedDataType != null /*&& this.nameField.getValue() !=""*/ && (this.uploadField.getRawValue() != "" || this.editor.getValue() != "")) {
        Ext.getCmp(this.uploadButtonId).enable();
        this.dataTypeLabel.update('<span class="info">Type:</span><span class="ok"> OK </span>');
    } else {
        Ext.getCmp(this.uploadButtonId).disable();
        this.dataTypeLabel.update('<span class="info">Type:</span><span class="err"> Not valid </span>');
    }

    if (this.originCheck.getValue()) {
        if (this.nameField.getValue() == '') {
            Ext.getCmp(this.uploadButtonId).disable();
        } else {
            Ext.getCmp(this.uploadButtonId).enable();
        }
    }
};


UploadWidget.prototype.fileSelected = function () {
    var inputId = this.uploadField.fileInputEl.id;
    var file = document.getElementById(inputId).files[0];
    if (file) {
        var fileSize = 0;
        if (file.size > 1024 * 1024)
            fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
        else
            fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';


        this.dataFieldLabel.update('<span class="info">Size: </span><span class="ok">' + fileSize + '</span>');
//          document.getElementById('fileName').innerHTML = '<b>Name</b>: ' + file.name;
//          document.getElementById('fileSize').innerHTML = '<b>Size</b>: ' + fileSize;
//          document.getElementById('fileType').innerHTML = '<b>Type</b>: ' + file.type;
    }
};

UploadWidget.prototype.uploadFile = function () {
    var _this = this;
    Ext.getBody().mask('Uploading file...');
    this.panel.disable();

    var fd = new FormData();
    var inputFileName = null;
    if (this.originCheck.getValue()) {
        inputFileName = this.nameField.getValue();
        fd.append("file", this.editor.getValue());
    } else {
        var inputFile = document.getElementById(Ext.getCmp(this.uploadFieldId).fileInputEl.id).files[0];
        inputFileName = inputFile.name;
        fd.append("file", inputFile);
    }
    var sessionId = $.cookie('bioinfo_sid');
    var objectId = this.opencgaLocation.directory + inputFileName;
    objectId = objectId.replace(new RegExp("/", "gi"), ":");

    fd.append("name", this.nameField.getValue());
    fd.append("fileFormat", this.selectedDataType);
    fd.append("responsible", this.responsableField.getValue());
    fd.append("organization", this.organizationField.getValue());
    fd.append("date", this.acquisitiondate.getValue());
    fd.append("description", this.textArea.getValue());
    fd.append("objectid", objectId);
    fd.append("sessionid", sessionId);


    //TODO DELETE THIS
    this.objectID = this.opencgaLocation.bucketId + ":" + objectId;

    //accountid, sessionId, projectname, formData


    OpencgaManager.uploadObjectToBucket({
        accountId: $.cookie("bioinfo_account"),
        sessionId: sessionId,
        bucketId: this.opencgaLocation.bucketId,
        objectId: objectId,
        formData: fd,
        success: this.uploadObjectToBucketSuccess
    });

};

UploadWidget.prototype.uploadFile2 = function () {
    var _this = this;

    var inputFile = document.getElementById(Ext.getCmp(this.uploadFieldId).fileInputEl.id).files[0];

    var objectId = this.opencgaLocation.directory + inputFile.name;
    objectId = objectId.replace(new RegExp("/", "gi"), ":");

    var fileuploadWorker = new Worker(WORKERS_PATH + 'worker-fileupload.js');
    this.opencgaBrowserWidget.addUpload(inputFile, fileuploadWorker);
    fileuploadWorker.postMessage({
        'host': OPENCGA_HOST,
        'accountId': $.cookie("bioinfo_account"),
        'sessionId': $.cookie("bioinfo_sid"),
        'file': inputFile,
        'objectId': objectId,
        'fileFormat': this.selectedDataType,
        'bucketId': this.opencgaLocation.bucketId,
        'resume': true
    });
    this.panel.hide();
};

//UploadWidget.prototype.uploadProgress = function(evt)  {
//	console.log("Progress...");
//    if (evt.lengthComputable) {
//      var percentComplete = Math.round(evt.loaded * 100 / evt.total);
//  		console.log(percentComplete);
////      document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
//    }
//    else {
//    	console.log('unable to compute');
////      document.getElementById('progressNumber').innerHTML = 'unable to compute';
//    }
//};

UploadWidget.prototype.uploadComplete = function (msg) {
    Ext.Msg.show({
        title: 'Upload status',
        msg: msg
    });
    this.panel.enable();
    Ext.getBody().unmask();
    this.panel.hide();
};

UploadWidget.prototype.uploadFailed = function (response) {
    Ext.Msg.show({
        title: 'Upload status',
        msg: 'There was an error attempting to upload the file.'
    });
    this.panel.enable();
    Ext.getBody().unmask();
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function CircosVertexRenderer(args) {
    var _this = this;

    //defaults
    this.shape = 'circle';
    this.size = 30;
    this.color = '#FAFAFA';
    this.strokeSize = 2;
    this.strokeColor = '#888888';
    this.opacity = 0.8;
    this.labelSize = 12;
    this.labelColor = '#111111';
    this.labelPositionX = 0;
    this.labelPositionY = 0;
    this.labelText = '';
    this.area = 1;
    this.strokeArea = 1;
    this.xAttribute = 'x';
    this.yAttribute = 'y';
    this.labelAdjust;

    this.pieSlices = [
        //        {size: this.size, area: this.sliceArea, color: this.color, labelSize: this.labelSize, labelOffset: 0}
    ];
    this.donutSlices = [
        //        {size: this.strokeSize, area: this.sliceArea, color: this.strokeColor, labelSize: this.labelSize, labelOffset: 0}
    ];

    this.shapeEl;
    this.vertexEl;
    this.targetEl;
    this.selectEl;
    this.groupEl;
    this.vertex;
    this.selected = false;

    //draw parameters
    this.labelX = 0;
    this.labelY = 0;

    //set instantiation args, must be last
    for (var prop in args) {
        if (hasOwnProperty.call(args, prop)) {
            if (args[prop] != null) {
                if (!isNaN(args[prop])) {
                    this[prop] = parseFloat(args[prop]);
                } else {
                    this[prop] = args[prop];
                }
            }
        }
    }
}

CircosVertexRenderer.prototype = {
    get: function (attr) {
        return this[attr];
    },
    set: function (attr, value, update) {
        if (!isNaN(value)) {
            value = parseFloat(value);
        }
        this[attr] = value;

        if (this._checkListProperties()) {
            this.complex = true;
            this.update();
        } else {
            this.complex = false;
            switch (attr) {
            case 'opacity':
                this.opacity = parseFloat(this.opacity);
                this.groupEl.setAttribute('opacity', this.opacity);
                break;
            case "labelSize":
            case "labelPositionY":
            case "labelPositionX":
                this.labelPositionX = parseFloat(this.labelPositionX);
                this.labelPositionY = parseFloat(this.labelPositionY);
                this.labelSize = parseFloat(this.labelSize);
                this._renderLabelEl();
                break;
            case "shape":
            case 'color':
            case 'strokeSize':
            case 'size':
            case 'strokeColor':
            case 'area':
            case 'strokeArea':
            default:
                this.size = parseInt(this.size);
                this.strokeSize = parseInt(this.strokeSize);
                this.area = parseInt(this.area);
                this.strokeArea = parseInt(this.strokeArea);
                if (update !== false) {
                    this.update();
                }
            }
        }

    },
    _checkListProperties: function () {
        /** Detect array values **/
        var minPieLength = 0;
        var minDonutLength = 0;
        if (Array.isArray(this.color)) {
            if (minPieLength == 0) {
                minPieLength = this.color.length;
            }
        }
        if (Array.isArray(this.size)) {
            if (minPieLength == 0 || minPieLength == 1) {
                minPieLength = this.size.length;
            }
            if (this.size.length != 1 && this.size.length < minPieLength) {
                minPieLength = this.size.length;
            }
        }
        if (Array.isArray(this.area)) {
            if (minPieLength == 0 || minPieLength == 1) {
                minPieLength = this.area.length;
            }
            if (this.area.length != 1 && this.area.length < minPieLength) {
                minPieLength = this.area.length;
            }
        }
        if (Array.isArray(this.strokeColor)) {
            if (minDonutLength == 0) {
                minDonutLength = this.strokeColor.length;
            }
        }
        if (Array.isArray(this.strokeSize)) {
            if (minDonutLength == 0 || minDonutLength == 1) {
                minDonutLength = this.strokeSize.length;
            }
            if (this.strokeSize.length != 1 && this.strokeSize.length < minDonutLength) {
                minDonutLength = this.strokeSize.length;
            }
        }
        if (Array.isArray(this.strokeArea)) {
            if (minDonutLength == 0 || minDonutLength == 1) {
                minDonutLength = this.strokeArea.length;
            }
            if (this.strokeArea.length != 1 && this.strokeArea.length < minDonutLength) {
                minDonutLength = this.strokeArea.length;
            }
        }
        this.pieSlices = [];
        var slice;
        if (minPieLength > 0) {
            for (var i = 0; i < minPieLength; i++) {
                slice = {};
                if (Array.isArray(this.color)) {
                    if (this.color.length == 1) {
                        slice.color = this.color[0];
                    } else {
                        slice.color = this.color[i];
                    }
                } else {
                    slice.color = this.color;
                }
                if (Array.isArray(this.size)) {
                    if (this.size.length == 1) {
                        slice.size = this.size[0];
                    } else {
                        slice.size = this.size[i];
                    }
                } else {
                    slice.size = this.size;
                }
                if (Array.isArray(this.area)) {
                    if (this.area.length == 1) {
                        slice.area = this.area[0];
                    } else {
                        slice.area = this.area[i];
                    }
                } else {
                    slice.area = this.area;
                }
                slice.labelSize = this.labelSize;
                slice.labelOffset = 0;
                this.pieSlices.push(slice);
            }
        }
        this.donutSlices = [];
        if (minDonutLength > 0) {
            for (var i = 0; i < minDonutLength; i++) {
                slice = {};
                if (Array.isArray(this.strokeColor)) {
                    if (this.strokeColor.length == 1) {
                        slice.color = this.strokeColor[0];
                    } else {
                        slice.color = this.strokeColor[i];
                    }
                } else {
                    slice.color = this.strokeColor;
                }
                if (Array.isArray(this.strokeSize)) {
                    if (this.strokeSize.length == 1) {
                        slice.size = this.strokeSize[0];
                    } else {
                        slice.size = this.strokeSize[i];
                    }
                } else {
                    slice.size = this.strokeSize;
                }
                if (Array.isArray(this.strokeArea)) {
                    if (this.strokeArea.length == 1) {
                        slice.size = this.strokeArea[0];
                    } else {
                        slice.area = this.strokeArea[i];
                    }
                } else {
                    slice.area = this.strokeArea;
                }
                slice.labelSize = this.labelSize;
                slice.labelOffset = 0;
                this.donutSlices.push(slice);
            }
        }
        if (this.pieSlices.length != 0 || this.donutSlices.length != 0) {
            if (this.pieSlices.length == 0) {
                this.pieSlices.push({
                    color: this.color,
                    size: this.size,
                    area: this.area,
                    labelSize: this.labelSize,
                    labelOffset: 0
                });
            }
            if (this.donutSlices.length == 0) {
                this.donutSlices.push({
                    color: this.strokeColor,
                    size: this.strokeSize,
                    area: this.strokeArea,
                    labelSize: this.labelSize,
                    labelOffset: 0
                });
            }
            return true;
        } else {
            return false;
        }
        /** **/
    },
    render: function (args) {
        this.targetEl = args.target;
        //this.vertex = args.vertex;
        //this.coords = args.coords;
        this._setLabelText(this.vertex.id);

        if (this._checkListProperties()) {
            this.complex = true;
            this._render();
        } else {
            this._render();
        }
    },
    remove: function () {
        if (this.groupEl && this.groupEl.parentNode) {
            this.groupEl.parentNode.removeChild(this.groupEl);
        }
    },
    update: function () {
        this.remove();
        this._render();
        // console.log("update")
    },
    select: function (color) {
        if (color) {
            this.selectEl.setAttribute('fill', color);
        }
        this.groupEl.insertBefore(this.selectEl, this.groupEl.firstChild);
        if (this.groupEl && this.groupEl.parentNode) {
            this.groupEl.parentNode.appendChild(this.groupEl);
        }
        this.selected = true;
    },
    deselect: function () {
        this._removeSelect();
        this.selected = false;
    },
    move: function () {
        var mid = this._getMidSize();
        this.groupEl.setAttribute('transform', "translate(" + [this.coords.x - mid, this.coords.y - mid].join(',') + ")");
    },
    setLabelContent: function (text) {
        if (text == null) {
            text = '';
        }
        this._setLabelText(text);
        if (this.labelEl) {
            this.update();
            // this._renderLabelEl();
        }
    },
    getSize: function () {
        return this._getFigureSize();
    },
    toJSON: function () {
        return {
            shape: this.shape,
            size: this.size,
            color: this.color,
            strokeSize: this.strokeSize,
            strokeColor: this.strokeColor,
            opacity: this.opacity,
            labelSize: this.labelSize,
            labelColor: this.labelColor,
            labelPositionX: this.labelPositionX,
            labelPositionY: this.labelPositionY,
            labelText: this.labelText,
            area: this.area,
            strokeArea: this.strokeArea,
            pieSlices: this.pieSlices,
            donutSlices: this.donutSlices
        };
    },

    /* Private methods */
    _setLabelText: function (text) {
        this.labelText = text.toString();
        this.labelLines = this.labelText.split(/\\n/);
        this.labelLinesLength = this.labelLines.length;
        var maxLabelWidth = 0;
        for (var i = 0; i < this.labelLinesLength; i++) {
            var line = this.labelLines[i];
            var textWidth = this._textWidthBySize(line, this.labelSize);
            if (textWidth > maxLabelWidth) {
                maxLabelWidth = textWidth;
            }
        }
        this._textWidth = maxLabelWidth * 1.2;
        this._textHeight = this.labelLinesLength * this.labelSize * 1.2;
    },
    _getMidSize: function () {
        var size = (Array.isArray(this.size)) ? this._slicesMax(this.pieSlices) : this.size;
        var strokeSize = (Array.isArray(this.strokeSize)) ? this._slicesMax(this.donutSlices) : this.strokeSize;
        if (this.size < 0) {
            var size = Math.max(this._textWidth, this._textHeight);
            return (size + strokeSize) / 2;
        } else {
            return (this.size + strokeSize) / 2;
        }
    },
    _getFigureSize: function () {
        var size = (Array.isArray(this.size)) ? this._slicesMax(this.pieSlices) : this.size;
        var strokeSize = (Array.isArray(this.strokeSize)) ? this._slicesMax(this.donutSlices) : this.strokeSize;
        if (this.size < 0) {
            var size = Math.max(this._textWidth, this._textHeight);
            return size + (strokeSize * 2);
        } else {
            return this.size + (strokeSize * 2);
        }
    },
    _textWidthBySize: function (text, pixelFontSize) {
        return ((text.length * pixelFontSize / 2) + (text.length * pixelFontSize / 10)); //round up
    },
    _renderLabelEl: function () {
        var mid = this._getMidSize();
        if (this.labelEl == null) {
            this.labelEl = SVG.create("text", {
                'network-type': 'vertex-label'
            });
        } else if (this.groupEl.contains(this.labelEl)) {
            this.groupEl.removeChild(this.labelEl);
        }
        this.labelEl.setAttribute('font-size', this.labelSize);
        this.labelEl.setAttribute('fill', this.labelColor);

        this.labelEl.textContent = "";
        var linesCount = this.labelLines.length;
        var yStart = this.labelPositionY + mid + (this.labelSize / 3) - ((linesCount - 1) * this.labelSize / 2);
        for (var i = 0; i < linesCount; i++) {
            var line = this.labelLines[i];
            var textWidth = this._textWidthBySize(line, this.labelSize);
            var tspan = SVG.addChild(this.labelEl, "tspan", {
                'network-type': 'vertex-label',
                x: this.labelPositionX + mid - (textWidth / 2),
                y: yStart + (i * this.labelSize)
            });
            tspan.textContent = line;
        }

        this.groupEl.appendChild(this.labelEl);
    },

    _drawSelectShape: function () {
        if (this.complex === true) {
            this._drawSelectCircleShape();
        } else {
            switch (this.shape) {
            case "circle":
                this._drawSelectCircleShape();
                break;
            case "ellipse":
                this._drawSelectEllipseShape();
                break;
            case "square":
                this._drawSelectSquareShape();
                break;
            case "rectangle":
                this._drawSelectRectangleShape();
                break;
            case "textfit":
                this._drawSelectRectangleShape();
                break;
            }
        }
    },
    _drawSelectCircleShape: function () {
        var mid = this._getMidSize();
        var figureSize = this._getFigureSize();
        this.selectEl = SVG.create("circle", {
            r: figureSize / 2 * 1.30,
            cx: mid,
            cy: mid,
            opacity: '0.5',
            fill: '#999999',
            'network-type': 'select-vertex'
        });
    },
    _drawSelectEllipseShape: function () {
        var mid = this._getMidSize();
        var figureSize = this._getFigureSize();
        var rx = figureSize;
        var ry = figureSize * 0.65;
        if (this.size < 0) {
            rx = this._textWidth + this.strokeSize;
            ry = this._textHeight + this.strokeSize;
        }
        this.selectEl = SVG.create("ellipse", {
            cx: mid,
            cy: mid,
            rx: rx,
            ry: ry,
            opacity: '0.5',
            fill: '#999999',
            'network-type': 'select-vertex'
        });
    },
    _drawSelectSquareShape: function () {
        var mid = this._getMidSize();
        var figureSize = this._getFigureSize();
        this.selectEl = SVG.create("rect", {
            x: mid - (mid * 2.6 / 2),
            y: mid - (mid * 2.6 / 2),
            width: mid * 2.6,
            height: mid * 2.6,
            opacity: '0.5',
            fill: '#999999',
            'network-type': 'select-vertex'
        });
    },
    _drawSelectRectangleShape: function () {
        var mid = this._getMidSize();
        var w = mid * 3 * 1.3;
        var h = mid * 2 * 1.3;
        if (this.size < 0) {
            w = (this._textWidth + this.strokeSize) * 1.2 * 1.3;
            h = (this._textHeight + this.strokeSize) * 1.2 * 1.3;
        }
        this.selectEl = SVG.create("rect", {
            x: mid - (w / 2),
            y: mid - (h / 2),
            width: w,
            height: h,
            opacity: '0.5',
            fill: '#999999',
            'network-type': 'select-vertex'
        });
    },
    _removeSelect: function () {
        if (this.selectEl && this.selectEl.parentNode) {
            this.selectEl.parentNode.removeChild(this.selectEl);
        }
    },
    _render: function () {
        if (this.complex === true) {
            this._renderSlices();
            this._drawSelectShape();
            this._renderLabelEl();
        } else {
            var mid = this._getMidSize();
            var figureSize = this._getFigureSize();
            this._drawSelectShape();
            this.groupEl = SVG.create('g', {
                "id": this.vertex.id,
                "transform": "translate(" + [this.coords.x - mid, this.coords.y - mid].join(',') + ")",
                "cursor": "pointer",
                opacity: this.opacity,
                'network-type': 'vertex-g'
            });
            this._renderLabelEl();
            // var textAdjustWidth = rr.maxTextWidth * 1.2;
            // var textAdjustHeight = rr.linesCount * this.labelSize * 1.2;
            // if (this.size < 0) {
            //     figure = SVG.create("rect", {
            //         x: this.mid - (w / 2),
            //         y: this.mid - (h / 2),
            //         width: w,
            //         height: h,
            //         stroke: this.strokeColor,
            //         'stroke-width': this.strokeSize,
            //         fill: this.color,
            //         'network-type': 'vertex'
            //     });
            // }
            var figure;
            switch (this.shape) {
            case "circle":
                figure = SVG.create('circle', {
                    r: mid,
                    cx: mid,
                    cy: mid,
                    stroke: this.strokeColor,
                    'stroke-width': this.strokeSize,
                    fill: this.color,
                    'network-type': 'vertex'
                });
                break;
            case "ellipse":
                var rx = mid * 1.5;
                var ry = mid;
                if (this.size < 0) {
                    rx = this._textWidth * 0.7;
                    ry = this._textHeight * 0.7;
                }
                figure = SVG.create("ellipse", {
                    cx: mid,
                    cy: mid,
                    rx: rx,
                    ry: ry,
                    stroke: this.strokeColor,
                    'stroke-width': this.strokeSize,
                    fill: this.color,
                    'network-type': 'vertex'
                });
                break;
            case "square":
                figure = SVG.create("rect", {
                    x: 0,
                    y: 0,
                    width: mid * 2,
                    height: mid * 2,
                    stroke: this.strokeColor,
                    'stroke-width': this.strokeSize,
                    fill: this.color,
                    'network-type': 'vertex'
                });
                break;
            case "rectangle":
                var w = mid * 3;
                var h = mid * 2;
                if (this.size < 0) {
                    w = this._textWidth * 1.2;
                    h = this._textHeight * 1.2;
                }
                figure = SVG.create("rect", {
                    x: mid - (w / 2),
                    y: mid - (h / 2),
                    width: w,
                    height: h,
                    stroke: this.strokeColor,
                    'stroke-width': this.strokeSize,
                    fill: this.color,
                    'network-type': 'vertex'
                });
                break;
            }
            this.groupEl.insertBefore(figure, this.labelEl);
        }
        this.targetEl.appendChild(this.groupEl);
        if (this.selected) {
            this.select();
        }
    },
    _renderSlices: function () {
        maxPieSize = this._slicesMax(this.pieSlices);
        if(maxPieSize < 0){
            maxPieSize = Math.max(this._textWidth, this._textHeight);
        }
        maxDonutSize = this._slicesMax(this.donutSlices);
        var figureSize = (maxPieSize + (maxDonutSize));
        var mid = figureSize / 2;

        this.groupEl = SVG.create('g', {
            "id": this.vertex.id,
            "transform": "translate(" + [this.coords.x - mid, this.coords.y - mid].join(',') + ")",
            "cursor": "pointer",
            opacity: this.opacity,
            'network-type': 'vertex-g'
        });

        var totalAreas = this._sumAreas(this.pieSlices);
        var c = 359.999 / totalAreas;
        var angleOffset = 0;
        for (var i = 0; i < this.pieSlices.length; i++) {
            var slice = this.pieSlices[i];
            var sliceSize = slice.size;
            if (slice.size < 0) {
                sliceSize = maxPieSize;
            }
            var angleSize = slice.area * c;
            var angleStart = angleOffset;
            var angleEnd = angleStart + angleSize;
            angleOffset += angleSize;
            var slice_d = SVG.describeArc(mid, mid, sliceSize / 2 + 0.2, angleStart, angleEnd);
            var curve = SVG.addChild(this.groupEl, "path", {
                "d": slice_d + ['L', mid, mid].join(' '),
                "fill": slice.color,
                'network-type': 'vertex'
            });
            if (typeof slice.text !== 'undefined') {
                var angle = angleStart + angleSize / 2;
                var l1 = SVG._polarToCartesian(mid, mid, maxPieSize / 2, angle);
                var l2 = SVG._polarToCartesian(mid, mid, mid + slice.labelOffset, angle);
                var labelWidth = this._textWidthBySize(slice.text, slice.labelSize);
                var textX, textY;
                if (l2.x > l1.x) {
                    if (l1.y > l2.y) {
                        //Quadrant I
                        textX = l2.x;
                        textY = l2.y;
                    } else {
                        //Quadrant IV
                        textX = l2.x;
                        textY = l2.y + slice.labelSize * 0.7;
                    }
                } else {
                    if (l1.y > l2.y) {
                        //Quadrant II
                        textX = l2.x - labelWidth - 1;
                        textY = l2.y;
                    } else {
                        //Quadrant III
                        textX = l2.x - labelWidth - 1;
                        textY = l2.y + slice.labelSize * 0.7;
                    }
                }
                if (slice.labelOffset >= 0) {
                    var line = SVG.addChild(this.groupEl, "line", {
                        "x1": l1.x,
                        "y1": l1.y,
                        "x2": l2.x,
                        "y2": l2.y,
                        'stroke': '#999999',
                        'stroke-width': '0.7',
                        'network-type': 'vertex-label'
                    });
                }
                var label = SVG.addChild(this.groupEl, "text", {
                    "x": textX,
                    "y": textY,
                    "font-size": slice.labelSize,
                    "fill": this.labelColor,
                    'network-type': 'vertex-label'
                });
                label.textContent = slice.text;
            }
        }

        var totalAreas = this._sumAreas(this.donutSlices);
        var c = 359.9999 / totalAreas;
        var angleOffset = 0;
        for (var i = 0; i < this.donutSlices.length; i++) {
            var slice = this.donutSlices[i];

            var angleSize = slice.area * c;
            var angleStart = angleOffset;
            var angleEnd = angleStart + angleSize;
            angleOffset += angleSize;
            var slice_d = SVG.describeArc(mid, mid, (maxPieSize / 2) + (slice.size / 2), angleStart, angleEnd);
            var curve = SVG.addChild(this.groupEl, "path", {
                "d": slice_d,
                "stroke": slice.color,
                "stroke-width": slice.size,
                "fill": "none",
                'network-type': 'vertex'
            }, 0);
            if (typeof slice.text !== 'undefined') {
                var angle = angleStart + angleSize / 2;
                var l1 = SVG._polarToCartesian(mid, mid, mid + slice.labelOffset, angle);
                var l2 = SVG._polarToCartesian(mid, mid, mid + slice.labelOffset, angle);
                var labelWidth = this._textWidthBySize(slice.text, slice.labelSize);
                var textX, textY;
                if (l2.x > l1.x) {
                    if (l1.y > l2.y) {
                        //Quadrant I
                        textX = l2.x;
                        textY = l2.y;
                    } else {
                        //Quadrant IV
                        textX = l2.x;
                        textY = l2.y + slice.labelSize / 2;
                    }
                } else {
                    if (l1.y > l2.y) {
                        //Quadrant II
                        textX = l2.x - labelWidth - 3;
                        textY = l2.y;
                    } else {
                        //Quadrant III
                        textX = l2.x - labelWidth - 3;
                        textY = l2.y + slice.labelSize / 2;
                    }
                }
                if (slice.labelOffset >= 0) {
                    var line = SVG.addChild(this.groupEl, "line", {
                        "x1": l1.x,
                        "y1": l1.y,
                        "x2": l2.x,
                        "y2": l2.y,
                        'stroke': '#999999',
                        'stroke-width': '0.7',
                        'network-type': 'vertex-label'
                    });
                }
                var label = SVG.addChild(this.groupEl, "text", {
                    "x": textX,
                    "y": textY,
                    "font-size": slice.labelSize,
                    "fill": this.labelColor,
                    'network-type': 'vertex-label'
                });
                label.textContent = slice.text;
            }
        }
    },
    _sumAreas: function (items) {
        var total = 0;
        for (var i = 0; i < items.length; i++) {
            var item = items[i];
            total += parseFloat(item.area);
        }
        return total;
    },
    _slicesMax: function (items) {
        var max = -1;
        for (var i = 0; i < items.length; i++) {
            max = Math.max(max, parseFloat(items[i].size));
        }
        return max;
    },
    /*********/
    /*********/
    /*********/
    /*********/
    drawLink: function (args) {
        //        var angleStart1 = args.angleStart1;
        //        var angleEnd1 = args.angleEnd1;
        //        var angleStart2 = args.angleStart2;
        //        var angleEnd2 = args.angleEnd2;

        var angleStart1 = 30;
        var angleEnd1 = 60;
        var angleStart2 = 270;
        var angleEnd2 = 290;

        var coords = args.coords;
        var targetSvg = args.target;

        var d = '';

        var r = this.radius - 10;

        var coordsStart1 = SVG._polarToCartesian(coords.x, coords.y, r, angleStart1);
        var coordsEnd1 = SVG._polarToCartesian(coords.x, coords.y, r, angleEnd1);

        var coordsStart2 = SVG._polarToCartesian(coords.x, coords.y, r, angleStart2);
        var coordsEnd2 = SVG._polarToCartesian(coords.x, coords.y, r, angleEnd2);

        d += SVG.describeArc(coords.x, coords.y, r, angleStart1, angleEnd1) + ' ';
        d += ['Q', coords.x, coords.y, coordsEnd2.x, coordsEnd2.y, ' '].join(' ');
        d += SVG.describeArc(coords.x, coords.y, r, angleStart2, angleEnd2) + ' ';
        d += ['Q', coords.x, coords.y, coordsEnd1.x, coordsEnd1.y, ' '].join(' ');

        var curve = SVG.addChild(targetSvg, 'path', {
            d: d,
            'stroke': 'red',
            'stroke-width': 2,
            'opacity': 1,
            'fill': 'crimson',
            'visibility': 'visible',
            'opacity': 0.7,
            'z-index': 10,
            'network-type': 'vertex'
        });

    },
    drawSectors: function (args) {
        var coords = args.coords;
        var color = args.color;
        var targetSvg = args.target;

        var separationPixels = 4;
        var separation = (separationPixels * 360) / (2 * Math.PI * this.radius);

        var totalSize = this._calculateTotalSize(this.sectors);
        var c = 360 / totalSize;
        var angleOffset = 0;
        var genome_d = [];
        var sector;
        for (var i = 0; i < this.sectors.length; i++) {
            sector = this.sectors[i];
            sector.angleSize = (sector.size * c) - separation;
            sector.angleStart = angleOffset + (separation / 2);
            sector.angleEnd = sector.angleStart + sector.angleSize;
            angleOffset += sector.angleSize + separation;

            genome_d.push(SVG.describeArc(coords.x, coords.y, this.radius, sector.angleStart, sector.angleEnd) + ' ');
        }

        for (var i = 0; i < genome_d.length; i++) {
            var curve = SVG.addChild(targetSvg, "path", {
                "d": genome_d[i],
                //                "stroke": 'lightblue',
                //                "stroke": Utils.colorLuminance(color, i/5),
                "stroke": this.sectors[i].color,
                "stroke-width": 10,
                "fill": "none",
                'network-type': 'vertex'
            });
        }
    }
}

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function DefaultEdgeRenderer(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    //defaults
    this.shape = 'directed';
    this.shaft = 'line';
    this.bidirectional = 'false';
    this.size = 1;
    this.color = '#cccccc';
    this.strokeSize = 2;
    this.strokeColor = '#aaaaaa';
    this.opacity = 1;
    this.labelSize = 0;
    this.labelColor = '#111111';
    this.labelText = '';
    //    this.labelPositionX = 5;
    //    this.labelPositionY = 45;

    this.el;
    this.edgeEl;
    this.labelEl;
    this.targetEl;
    this.edge;
    this.selected = false;

    this.sourceCoords;
    this.targetCoords;
    this.sourceRenderer;
    this.targetRenderer;

    //set instantiation args, must be last
    for (var prop in args) {
        if (hasOwnProperty.call(args, prop)) {
            if (args[prop] != null) {
                this[prop] = args[prop];
            }
        }
    }

    this.size = parseFloat(this.size);
    this.strokeSize = parseFloat(this.strokeSize);
    this.opacity = parseFloat(this.opacity);
    this.labelSize = parseFloat(this.labelSize);

}

DefaultEdgeRenderer.prototype = {
    get: function (attr) {
        return this[attr];
    },
    set: function (attr, value) {
        if (!isNaN(value)) {
            value = parseFloat(value);
        }
        this[attr] = value;
        switch (attr) {
        case "color":
            this.edgeEl.setAttribute('stroke', this.color);
            this.updateShape();
            break;
        case "size":
            this.size = parseInt(this.size);
            this.edgeEl.setAttribute('stroke-width', this._getStrokeWidth());
            this.updateShape();
            break;
        case "bidirectional":
        case "shape":
            this.updateShape();
            break;
        case "shaft":
            this.updateShaft();
            break;
        case "labelSize":
            this.labelSize = parseInt(this.labelSize);
            this.setLabelContent(this.labelText);
            break;
        case "opacity":
            this.edgeEl.setAttribute('opacity', this.opacity);
            break;
        default:
            this.update();
        }
    },
    _getStrokeWidth: function () {
        return 1 + (this.size / 2);
    },
    //setConfig: function (args) {
    //    if (args.size) {
    //        args.size = parseInt(args.size);
    //    }
    //    if (args.opacity) {
    //        args.opacity = parseFloat(args.opacity);
    //    }
    //    if (args.labelSize) {
    //        args.labelSize = parseInt(args.labelSize);
    //    }
    //    if (args.labelPositionX) {
    //        args.labelPositionX = parseInt(args.labelPositionX);
    //    }
    //    if (args.labelPositionY) {
    //        args.labelPositionY = parseInt(args.labelPositionY);
    //    }
    //    _.extend(this, args);
    //    this.edgeEl.setAttribute('opacity', this.opacity);
    //},
    render: function (args) {
        //this.edge = args.edge;
        this.targetEl = args.target;
        this.sourceCoords = this.edge.source.position;
        this.targetCoords = this.edge.target.position;
        this.sourceRenderer = this.edge.source.renderer;
        this.targetRenderer = this.edge.target.renderer;
        this._render();
    },
    remove: function () {
        if (this.el && this.el.parentNode) {
            this.el.parentNode.removeChild(this.el);
        }
    },
    update: function () {
        this.edgeEl.setAttribute('stroke', this.color);
        this.edgeEl.setAttribute('stroke-width', this._getStrokeWidth());
        if (this.labelSize <= 0) {
            this.labelEl.setAttribute('font-size', 1);
            this.labelEl.setAttribute('fill', 'transparent');
        } else {
            this.labelEl.setAttribute('font-size', this.labelSize);
            this.labelEl.setAttribute('fill', this.labelColor);
        }
        this.updateShaft();
        this.updateShape();
    },
    updateShape: function () {
        if (!this.edgeEl) {
            debugger
        }
        if (this.shape === 'undirected') {
            this.edgeEl.removeAttribute('marker-end');
            this.edgeEl.removeAttribute('marker-start');
        } else {
            if (this.bidirectional == 'true') {
                this.edgeEl.setAttribute('marker-end', "url(" + this._getMarkerArrowId("end") + ")");
                this.edgeEl.setAttribute('marker-start', "url(" + this._getMarkerArrowId("start") + ")");
            } else {
                this.edgeEl.setAttribute('marker-end', "url(" + this._getMarkerArrowId("end") + ")");
                this.edgeEl.removeAttribute('marker-start');
            }
        }

        this.move();
    },
    updateShaft: function () {
        if (!this.edgeEl) {
            debugger
        }
        if (this.selected) {
            this._renderSelect();
        }
        if (!this.selected) {
            this._removeSelect();
        }
    },
    select: function () {
        if (!this.selected) {
            this._renderSelect();
        }
    },
    deselect: function () {
        if (this.selected) {
            this._removeSelect();
        }
    },
    setLabelContent: function (text) {
        if (text == null) {
            text = '';
        }
        this._setLabelText(text);
        this._renderLabelEl();
        //var splitted = text.split("\\n");
        //var line, lineEl;
        //for (var i = 0; i < splitted.length; i++) {
        //    line = splitted[i];
        //    lineEl = SVG.addChild(this.labelEl, "tspan", {
        //        "dy": this.labelSize,
        //        "x": this.labelEl.getAttribute("x")
        //    });
        //    lineEl.textContent = line;
        //}
    },
    //    moveSourceOff: function (coords) {
    //        var linkLine = $(this.el).find('line[network-type="edge"]')[0];
    //        linkLine.setAttribute('x1', coords.x);
    //        linkLine.setAttribute('y1', coords.y);
    //
    //        var x1 = parseFloat(linkLine.getAttribute('x1'));
    //        var y1 = parseFloat(linkLine.getAttribute('y1'));
    //        var x2 = parseFloat(linkLine.getAttribute('x2'));
    //        var y2 = parseFloat(linkLine.getAttribute('y2'));
    //
    //        var x = (x1 + x2) / 2;
    //        var y = (y1 + y2) / 2;
    //
    //        var text = $(this.el).find('text[network-type="edge-label"]')[0];
    //        text.setAttribute('x', x);
    //        text.setAttribute('y', y);
    //    },
    //    moveTargetOff: function (coords) {
    //        var linkLine = $(this.el).find('line[network-type="edge"]')[0];
    //        linkLine.setAttribute('x2', coords.x);
    //        linkLine.setAttribute('y2', coords.y);
    //
    //        var x1 = parseFloat(linkLine.getAttribute('x1'));
    //        var y1 = parseFloat(linkLine.getAttribute('y1'));
    //        var x2 = parseFloat(linkLine.getAttribute('x2'));
    //        var y2 = parseFloat(linkLine.getAttribute('y2'));
    //
    //        var x = (x1 + x2) / 2;
    //        var y = (y1 + y2) / 2;
    //
    //        var text = $(this.el).find('text[network-type="edge-label"]')[0];
    //        text.setAttribute('x', x);
    //        text.setAttribute('y', y);
    //
    //    },
    move: function () {
        var val = this._calculateEdgePath();
        this.edgeEl.setAttribute('d', val.d);
        this._renderLabelEl(val);
    },
    _calculateEdgePath: function () {
        var d, labelX, labelY;
        if (this.edge.source === this.edge.target) {
            //calculate self edge
            var length1 = this.sourceRenderer.getSize() * 0.6;
            var length2 = this.sourceRenderer.getSize() * 1.8;
            labelX = this.sourceCoords.x - this.sourceRenderer.getSize();
            labelY = this.sourceCoords.y - this.sourceRenderer.getSize();

            var rSize = this.sourceRenderer.getSize() / 2;

            d = ['M', this.sourceCoords.x - rSize, this.sourceCoords.y,
                'L', this.sourceCoords.x - length1, this.sourceCoords.y,
                'C', this.sourceCoords.x - length2, this.sourceCoords.y, this.sourceCoords.x, this.sourceCoords.y - length2,
                this.sourceCoords.x, this.sourceCoords.y - length1,
                'L', this.targetCoords.x, this.targetCoords.y - rSize
            ].join(' ');
        } else {
            //calculate bezier line
            var deltaX = this.targetCoords.x - this.sourceCoords.x;
            var deltaY = this.targetCoords.y - this.sourceCoords.y;
            var angle = Math.atan(deltaY / deltaX);
            if (isNaN(angle)) {
                angle = 0;
            }

            var midX = (this.sourceCoords.x + this.targetCoords.x) / 2;
            var midY = (this.sourceCoords.y + this.targetCoords.y) / 2;
            var controlPath = '';
            if (this.edge.overlapCount === 0) {
                labelX = midX - (Math.sin(angle));
                labelY = midY + (Math.cos(angle));
            } else {
                var separation = 15;
                var remainder = this.edge.overlapCount % 2;
                var sum = 1;
                var sign = 1;
                if (remainder === 0) {
                    sum = 0;
                    sign = -1
                }
                var controlPointOffset = (this.edge.overlapCount + sum) / 2 * separation * (sign);
                var controlPointOffsetLabel = controlPointOffset / 1.33;
                var controlX = midX - (Math.sin(angle) * controlPointOffset);
                var controlY = midY + (Math.cos(angle) * controlPointOffset);
                labelX = midX - (Math.sin(angle) * controlPointOffsetLabel);
                labelY = midY + (Math.cos(angle) * controlPointOffsetLabel);
                controlPath = ['C', controlX, controlY, controlX, controlY].join(' ');
            }
            var pp = this._getPerimeterPositions(angle);

            //            d = ['M', this.sourceCoords.x, this.sourceCoords.y, 'C', controlX, controlY, controlX, controlY, this.targetCoords.x, this.targetCoords.y].join(' ');

            d = ['M', pp.sx, pp.sy, controlPath, pp.tx, pp.ty].join(' ');
        }
        return {
            d: d,
            xl: labelX,
            yl: labelY
        };
    },
    _getPerimeterPositions: function (angle) {
        // Calculate source and target points of the perimeter
        var sign = this.targetCoords.x >= this.sourceCoords.x ? 1 : -1;
        var srHalfSize = this.sourceRenderer.getSize() / 2;
        var trHalfSize = this.targetRenderer.getSize() / 2;

        var srTextWidth = this.sourceRenderer._textWidth + this.sourceRenderer.strokeSize;
        var srTextHeight = this.sourceRenderer._textHeight + this.sourceRenderer.strokeSize;
        var trTextWidth = this.targetRenderer._textWidth + this.targetRenderer.strokeSize;
        var trTextHeight = this.targetRenderer._textHeight + this.targetRenderer.strokeSize;

        var cosAngle = Math.cos(angle);
        var sinAngle = Math.sin(angle);
        var absCosAngle = Math.abs(cosAngle);
        var absSinAngle = Math.abs(sinAngle);
        var sx, sy, tx, ty, magnitudeCos, magnitudeSin, magnitude;

        //circle
        // x = cx + r * cos(a)
        // y = cy + r * sin(a)

        //Square
        // center + (cos(angle), sin(angle))*magnitude

        //Source
        if (this.sourceRenderer.complex == true) {
            sx = this.sourceCoords.x + (sign * cosAngle * srHalfSize);
            sy = this.sourceCoords.y + (sign * sinAngle * srHalfSize);
        } else {
            switch (this.sourceRenderer.shape) {
            case 'square':
                magnitudeCos = srHalfSize / absCosAngle;
                magnitudeSin = srHalfSize / absSinAngle;
                magnitude = (magnitudeCos <= magnitudeSin) ? magnitudeCos : magnitudeSin;
                sx = this.sourceCoords.x + (sign * cosAngle * magnitude);
                sy = this.sourceCoords.y + (sign * sinAngle * magnitude);
                break;
            case 'rectangle':
                if (this.sourceRenderer.size < 0) {
                    magnitudeCos = srTextWidth * 0.6 / absCosAngle;
                    magnitudeSin = srTextHeight * 0.6 / absSinAngle;
                } else {
                    magnitudeCos = srHalfSize * 1.5 / absCosAngle;
                    magnitudeSin = srHalfSize / absSinAngle;
                }
                magnitude = (magnitudeCos <= magnitudeSin) ? magnitudeCos : magnitudeSin;
                sx = this.sourceCoords.x + (sign * cosAngle * magnitude);
                sy = this.sourceCoords.y + (sign * sinAngle * magnitude);
                break;
            case 'ellipse':
                if (this.sourceRenderer.size < 0) {
                    sx = this.sourceCoords.x + (sign * cosAngle * srTextWidth * 0.7);
                    sy = this.sourceCoords.y + (sign * sinAngle * srTextHeight * 0.7);
                } else {
                    sx = this.sourceCoords.x + (sign * cosAngle * srHalfSize * 1.5);
                    sy = this.sourceCoords.y + (sign * sinAngle * srHalfSize);
                }
                break;
            case 'circle':
            default:
                sx = this.sourceCoords.x + (sign * cosAngle * srHalfSize);
                sy = this.sourceCoords.y + (sign * sinAngle * srHalfSize);
            }
        }
        //Target
        if (this.targetRenderer.complex == true) {
            tx = this.targetCoords.x - (sign * cosAngle * trHalfSize);
            ty = this.targetCoords.y - (sign * sinAngle * trHalfSize);
        } else {
            switch (this.targetRenderer.shape) {
            case 'square':
                magnitudeCos = trHalfSize / absCosAngle;
                magnitudeSin = trHalfSize / absSinAngle;
                magnitude = (magnitudeCos <= magnitudeSin) ? magnitudeCos : magnitudeSin;
                tx = this.targetCoords.x - (sign * cosAngle * magnitude);
                ty = this.targetCoords.y - (sign * sinAngle * magnitude);
                break;
            case 'rectangle':
                if (this.targetRenderer.size < 0) {
                    magnitudeCos = trTextWidth * 0.6 / absCosAngle;
                    magnitudeSin = trTextHeight * 0.6 / absSinAngle;
                } else {
                    magnitudeCos = trHalfSize * 1.5 / absCosAngle;
                    magnitudeSin = trHalfSize / absSinAngle;
                }
                magnitude = (magnitudeCos <= magnitudeSin) ? magnitudeCos : magnitudeSin;
                tx = this.targetCoords.x - (sign * cosAngle * magnitude);
                ty = this.targetCoords.y - (sign * sinAngle * magnitude);
                break;
            case 'ellipse':
                if (this.targetRenderer.size < 0) {
                    tx = this.targetCoords.x - (sign * cosAngle * trTextWidth * 0.7);
                    ty = this.targetCoords.y - (sign * sinAngle * trTextHeight * 0.7);
                } else {
                    tx = this.targetCoords.x - (sign * cosAngle * trHalfSize * 1.5);
                    ty = this.targetCoords.y - (sign * sinAngle * trHalfSize);
                }
                break;
            case 'circle':
            default:
                tx = this.targetCoords.x - (sign * cosAngle * trHalfSize);
                ty = this.targetCoords.y - (sign * sinAngle * trHalfSize);
            }
        }
        return {
            sx: sx,
            sy: sy,
            tx: tx,
            ty: ty
        };
    },
    /* Private */
    _render: function () {
        this.el = SVG.create('g', {
            "cursor": "pointer",
            "id": this.edge.id,
            opacity: this.opacity,
            'network-type': 'edge-g'
        });

        var val = this._calculateEdgePath();

        this.edgeEl = SVG.addChild(this.el, "path", {
            "d": val.d,
            opacity: this.opacity,
            "stroke": this.color,
            "stroke-width": this._getStrokeWidth(),
            //"stroke-linecap": "round",
            //"stroke-linejoin": "miter",
            "cursor": "pointer",
            fill: 'none',
            'network-type': 'edge'
        }, 1);

        if (this.shape === 'undirected') {
            this.edgeEl.removeAttribute('marker-end');
            this.edgeEl.removeAttribute('marker-start');
        } else {
            if (this.bidirectional == 'true') {
                this.edgeEl.setAttribute('marker-end', "url(" + this._getMarkerArrowId("end") + ")");
                this.edgeEl.setAttribute('marker-start', "url(" + this._getMarkerArrowId("start") + ")");
            } else {
                this.edgeEl.setAttribute('marker-end', "url(" + this._getMarkerArrowId("end") + ")");
                this.edgeEl.removeAttribute('marker-start');
            }
        }

        this._setLabelText(this.edge.id);
        this._renderLabelEl(val);

        SVG._insert(this.targetEl, this.el, 1);

        if (this.selected) {
            this._renderSelect();
        }
        if (!this.selected) {
            this._removeSelect();
        }
    },
    _setLabelText: function (text) {
        this.labelText = text;
        this.labelLines = this.labelText.split(/\\n/);
    },
    _renderLabelEl: function (val) {
        if (val == null) {
            val = this._calculateEdgePath();
        }
        if (this.labelEl == null) {
            this.labelEl = SVG.create("text", {
                'network-type': 'edge-label'
            });
        } else if (this.el.contains(this.labelEl)) {
            this.el.removeChild(this.labelEl);
        }
        this.labelEl.setAttribute('font-size', this.labelSize);
        if (this.labelSize <= 0) {
            this.labelEl.setAttribute('font-size', 1);
            this.labelEl.setAttribute('fill', 'transparent');
        } else {
            this.labelEl.setAttribute('font-size', this.labelSize);
            this.labelEl.setAttribute('fill', this.labelColor);
        }

        this.labelEl.textContent = "";
        var linesCount = this.labelLines.length;
        var yStart = val.yl - ((linesCount - 1) * this.labelSize / 2);
        for (var i = 0; i < linesCount; i++) {
            var line = this.labelLines[i];
            var tspan = SVG.addChild(this.labelEl, "tspan", {
                'network-type': 'edge-label',
                x: val.xl,
                y: yStart + (i * this.labelSize)
            });
            tspan.textContent = line;
        }

        this.el.appendChild(this.labelEl);
    },

    _renderSelect: function () {
        this.edgeEl.setAttribute('stroke-dasharray', '10, 5');

        this.selected = true;
    },
    _removeSelect: function () {
        if (this.shaft !== 'dashed') {
            this.edgeEl.removeAttribute('stroke-dasharray');
        } else {
            this.edgeEl.setAttribute('stroke-dasharray', '3, 2');
        }
        this.selected = false;
    },
    /**/
    _getMarkerArrowId: function (markerLocation) {
        var offset = (this.size * -2) - 1;
        // if not exists this marker, add new one to defs
        var markerArrowId = "arrow-" + this.shape + "-" + offset.toString().replace(".", "_") + '-' + this.size.toString().replace(".", "_") + '-' + this.color.replace('#', '') + markerLocation;
        var markerArrowIdSel = '#' + markerArrowId;
        if (!this.targetEl.querySelector(markerArrowIdSel)) {
            this._addArrowShape(this.shape, offset, this.color, this.size, this.targetEl, markerArrowId, markerLocation);
        }
        return markerArrowIdSel;
    },
    _addArrowShape: function (type, offset, color, edgeSize, targetSvg, markerArrowId, markerLocation) {
        var defsEl = targetSvg.querySelector('defs');
        if (!defsEl) {
            defsEl = SVG.addChild(targetSvg, "defs", {}, 0);
        }
        if (typeof color === 'undefined') {
            color = '#000000';
        }
        var sign = 1;
        if (markerLocation == "start") {
            sign = -1;
        }
        var sw = this._getStrokeWidth();
        var swh = sw / 2;
        var w = 8 + edgeSize;
        var h = 3 + edgeSize;
        var marker = SVG.addChild(defsEl, "marker", {
            "id": markerArrowId,
            "orient": "auto",
            "refX": (w) * sign,
            "refY": h,
            'markerUnits': "userSpaceOnUse",
            "style": "overflow:visible;"
        });
        switch (type) {
        case "directed":
            var d = ['M0,0', 'L', 1 * sign, h, 'L', 0, h * 2, 'L', w * sign, h + swh, 'L', w * sign, h - swh, 'Z'].join(' ') //"M0,0 V10 L5,5 Z"
                //var d = ['M0,0', 'L', 1 * sign, h, 'L', 0, h * 2, 'L', w * sign, h, 'Z'].join(' ')//"M0,0 V10 L5,5 Z"
            var arrow = SVG.addChild(marker, "path", {
                "fill": color,
                "d": d
            });
            break;
        case "inhibited":
            var x = w / 2;
            var y = h + swh;
            var x2 = w;
            var y2 = h * 3 + swh;
            var arrow = SVG.addChild(marker, "path", {
                "fill": color,
                "d": ['M', sign * x, -y, 'L', sign * x, y2, 'L', sign * x2, y2, 'L', sign * x2, -y, 'Z'].join(' ')
            });
            break;
        case "dot":
            var arrow = SVG.addChild(marker, "circle", {
                "fill": color,
                "cx": sign * w / 2,
                "cy": h,
                "r": w / 2
            });
            break;
        case "odot":
            var arrow = SVG.addChild(marker, "circle", {
                "fill": color,
                "cx": sign * w / 2,
                "cy": h,
                "r": w / 2
            });
            var arrow = SVG.addChild(marker, "circle", {
                "fill": 'white',
                "cx": sign * w / 2,
                "cy": h,
                "r": (w / 2) - sw
            });
            break;
        }
    },
    toJSON: function () {
        return {
            shape: this.shape,
            shaft: this.shaft,
            bidirectional: this.bidirectional,
            size: this.size,
            color: this.color,
            strokeSize: this.strokeSize,
            strokeColor: this.strokeColor,
            opacity: this.opacity,
            labelSize: this.labelSize,
            labelColor: this.labelColor,
            labelText: this.labelText
        };
    }
}

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function DefaultVertexRenderer(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    //defaults
    this.shape = 'circle';
    this.size = 20;
    this.color = '#9fc6e7';
    this.strokeSize = 1;
    this.strokeColor = '#9fc6e7';
    this.opacity = 0.8;
    this.labelSize = 12;
    this.labelColor = '#111111';
//    this.labelPositionX = 5;
//    this.labelPositionY = 45;
    this.labelText = '';

    this.el;
    this.vertexEl;
    this.targetEl;
    this.selectEl;
    this.groupEl;
    this.vertex;
    this.selected = false;
    //set instantiation args, must be last
    _.extend(this, args);

}

DefaultVertexRenderer.prototype = {
    get: function (attr) {
        return this[attr];
    },
    set: function (attr, value) {
        this[attr] = value;
        switch (attr) {
            case "color":
                this.vertexEl.setAttribute('fill', this.color);
                break;
            case "strokeColor":
                this.vertexEl.setAttribute('stroke', this.strokeColor);
                break;
            case "opacity":
                this.groupEl.setAttribute('opacity', this.opacity);
                break;
            case "labelSize":
                this.labelEl.setAttribute('font-size', this.labelSize);
                this._calculateLabelX();
                break;
            case "size":
            case "strokeSize":
                switch (this.shape) {
                    case "circle":
                        this._updateCircleSize();
                        break;
                    case "ellipse":
                        this._updateEllipseSize();
                        break;
                    case "square":
                        this._updateSquareSize();
                        break;
                    case "rectangle":
                        this._updateRectangleSize();
                        break;
                }
                break;
            default:
                console.log('update')
                this.update();
        }
    },
    setConfig: function (args) {
        _.extend(this, args);
    },
    render: function (args) {
        this.targetEl = args.target;
        this.vertex = args.vertex;
        this.coords = args.coords;
        this._render();
    },
    remove: function () {
        $(this.el).remove();
    },
    update: function () {
        this.remove();
        this._render();
    },
    select: function () {
        if (!this.selected) {
            this._renderSelect();
        }
    },
    deselect: function () {
        if (this.selected) {
            this._removeSelect();
        }
    },
    move: function (dispX, dispY) {
        var currentX = parseFloat(this.el.getAttribute('x'));
        var currentY = parseFloat(this.el.getAttribute('y'));
        this.el.setAttribute('x', currentX + dispX);
        this.el.setAttribute('y', currentY + dispY);
    },
    setLabelContent: function (text) {
        if (typeof this.labelEl !== 'undefined') {
            if ($.type(text) === 'string' && text.length > 0) {
                this.labelText = text;
                this.labelEl.textContent = text;
            }
            this._calculateLabelX();
        }
    },
    getSize: function () {
        return this.size + this.strokeSize;
    },
    /* Private */
    _render: function () {
        switch (this.shape) {
            case "circle":
                this._drawCircleShape();
                break;
            case "ellipse":
                this._drawEllipseShape();
                break;
            case "square":
                this._drawSquareShape();
                break;
            case "rectangle":
                this._drawRectangleShape();
                break;
        }
        if (this.selected) {
            this._renderSelect();
        }
    },
    _renderSelect: function () {
        switch (this.shape) {
            case "circle":
                this._drawSelectCircleShape();
                break;
            case "ellipse":
                this._drawSelectEllipseShape();
                break;
            case "square":
                this._drawSelectSquareShape();
                break;
            case "rectangle":
                this._drawSelectRectangleShape();
                break;
        }
        this.selected = true;
    },
    _removeSelect: function () {
        $(this.el).find('[network-type="select-vertex"]').remove();
        this.selected = false;
    },

    _calculateOffset: function () {
        var size = this.size + this.strokeSize;
        var size = size + (size * 0.3);
        var midOffset = size / 2;
        return {size: size, midOffset: midOffset};
    },
    _calculateLabelX: function (o) {
        if (typeof o === 'undefined') {
            o = this._calculateOffset();
        }
        var x = o.midOffset - (this.labelEl.textContent.length * this.labelSize / 4);
        x = (x < 0) ? 0 : x;

        var y = o.midOffset + this.labelSize / 3;

        this.labelEl.setAttribute('x', x);
        this.labelEl.setAttribute('y', y);
    },

    /** CIRCLE METHODS **/
    _drawCircleShape: function () {
        var o = this._calculateOffset();

        var vertexSvg = SVG.create("svg", {
            "id": this.vertex.id,
            "cursor": "pointer",
            x: this.coords.x - o.midOffset,
            y: this.coords.y - o.midOffset,
            'network-type': 'vertex-svg'
        });
        var groupSvg = SVG.addChild(vertexSvg, 'g', {
            opacity: this.opacity
        });
        var circle = SVG.addChild(groupSvg, 'circle', {
            cx: o.midOffset,
            cy: o.midOffset,
            r: this.size / 2,
            stroke: this.strokeColor,
            'stroke-width': this.strokeSize,
            fill: this.color,
            'network-type': 'vertex'
        });
        this.labelEl = SVG.addChild(vertexSvg, "text", {
//                "x": 5,
//                "y": this.labelSize + o.size,
            "x": o.midOffset,
            "y": o.midOffset,
            "font-size": this.labelSize,
            "fill": this.labelColor,
            'network-type': 'vertex-label'
        });
        var label = this.vertex.id;
        if ($.type(this.labelText) === 'string' && this.labelText.length > 0) {
            label = this.labelText;
        }
        this.labelEl.textContent = label;
        this._calculateLabelX(o);

        this.el = vertexSvg;
        this.groupEl = groupSvg;
        this.vertexEl = circle;
        this.targetEl.appendChild(vertexSvg);
    },
    _updateCircleSize: function () {

        var o = this._calculateOffset();
        this.el.setAttribute('x', this.coords.x - o.midOffset);
        this.el.setAttribute('y', this.coords.y - o.midOffset);

        this.vertexEl.setAttribute('stroke-width', this.strokeSize);
        this.vertexEl.setAttribute('r', this.size / 2);
        this.vertexEl.setAttribute('cx', o.midOffset);
        this.vertexEl.setAttribute('cy', o.midOffset);

        if (this.labelSize > 0) {
            this._calculateLabelX(o);
        }
        if (this.selected) {
            this._updateSelectShapeSize(o);
        }
    },
    /* END CIRCLE METHODS */

    /** ELLIPSE METHODS **/
    _drawEllipseShape: function () {

        var o = this._calculateOffset();

        var vertexSvg = SVG.create("svg", {
            "id": this.vertex.id,
            "cursor": "pointer",
            x: this.coords.x - o.midOffset,
            y: this.coords.y - o.midOffset,
            'network-type': 'vertex-svg'
        });
        var groupSvg = SVG.addChild(vertexSvg, 'g', {
            opacity: this.opacity
        });
        var ellipse = SVG.addChild(groupSvg, 'ellipse', {
            cx: o.midOffset,
            cy: o.midOffset,
            rx: this.size / 1.7,
            ry: this.size / 2.5,
            stroke: this.strokeColor,
            'stroke-width': this.strokeSize,
            fill: this.color,
            'network-type': 'vertex'
        });
        this.labelEl = SVG.addChild(vertexSvg, "text", {
            "x": 5,
            "y": this.labelSize + o.size,
            "font-size": this.labelSize,
            "fill": this.labelColor,
            'network-type': 'vertex-label'
        });
        var label = this.vertex.id;
        if ($.type(this.labelText) === 'string' && this.labelText.length > 0) {
            label = this.labelText;
        }
        this.labelEl.textContent = label;
        this._calculateLabelX(o);

        this.el = vertexSvg;
        this.groupEl = groupSvg;
        this.vertexEl = ellipse;
        this.targetEl.appendChild(vertexSvg);
    },
    _updateEllipseSize: function () {

        var o = this._calculateOffset();
        this.el.setAttribute('x', this.coords.x - o.midOffset);
        this.el.setAttribute('y', this.coords.y - o.midOffset);

        this.vertexEl.setAttribute('stroke-width', this.strokeSize);
        this.vertexEl.setAttribute('cx', o.midOffset);
        this.vertexEl.setAttribute('cy', o.midOffset);
        this.vertexEl.setAttribute('rx', this.size / 1.7);
        this.vertexEl.setAttribute('ry', this.size / 2.5);

        if (this.labelSize > 0) {
            this._calculateLabelX(o);
        }
        if (this.selected) {
            this._updateSelectShapeSize(o);
        }
    },
    /* END ELLIPSE METHODS */

    /** SQUARE METHODS **/
    _drawSquareShape: function () {

        var o = this._calculateOffset();

        var vertexSvg = SVG.create("svg", {
            "id": this.vertex.id,
            "cursor": "pointer",
            x: this.coords.x - o.midOffset,
            y: this.coords.y - o.midOffset,
            'network-type': 'vertex-svg'
        });
        var groupSvg = SVG.addChild(vertexSvg, 'g', {
            opacity: this.opacity
        });
        var rect = SVG.addChild(groupSvg, 'rect', {
            x: o.midOffset - this.size / 2,
            y: o.midOffset - this.size / 2,
            width: this.size,
            height: this.size,
            stroke: this.strokeColor,
            'stroke-width': this.strokeSize,
            fill: this.color,
            'network-type': 'vertex'
        });
        this.labelEl = SVG.addChild(vertexSvg, "text", {
            "x": 5,
            "y": this.labelSize + o.size,
            "font-size": this.labelSize,
            "fill": this.labelColor,
            'network-type': 'vertex-label'
        });
        var label = this.vertex.id;
        if ($.type(this.labelText) === 'string' && this.labelText.length > 0) {
            label = this.labelText;
        }
        this.labelEl.textContent = label;
        this._calculateLabelX(o);

        this.el = vertexSvg;
        this.groupEl = groupSvg;
        this.vertexEl = rect;
        this.targetEl.appendChild(vertexSvg);
    },
    _updateSquareSize: function () {

        var o = this._calculateOffset();
        this.el.setAttribute('x', this.coords.x - o.midOffset);
        this.el.setAttribute('y', this.coords.y - o.midOffset);

        this.vertexEl.setAttribute('stroke-width', this.strokeSize);
        this.vertexEl.setAttribute('x', o.midOffset - this.size / 2);
        this.vertexEl.setAttribute('y', o.midOffset - this.size / 2);
        this.vertexEl.setAttribute('width', this.size);
        this.vertexEl.setAttribute('height', this.size);

        if (this.labelSize > 0) {
            this._calculateLabelX(o);
        }
        if (this.selected) {
            this._updateSelectShapeSize(o);
        }
    },
    /* END SQUARE METHODS */

    /** RECTANGLE METHODS **/
    _drawRectangleShape: function () {

        var o = this._calculateOffset();

        var s1 = (this.size * 0.3);
        var s2 = s1 / 2;

        var vertexSvg = SVG.create("svg", {
            "id": this.vertex.id,
            "cursor": "pointer",
            x: this.coords.x - o.midOffset,
            y: this.coords.y - o.midOffset,
            'network-type': 'vertex-svg'
        });
        var groupSvg = SVG.addChild(vertexSvg, 'g', {
            opacity: this.opacity
        });
        var rect = SVG.addChild(groupSvg, 'rect', {
            x: o.midOffset - this.size / 2 - s2,
            y: o.midOffset - this.size / 2 + s2,
            width: this.size + s1,
            height: this.size - s1,
            stroke: this.strokeColor,
            'stroke-width': this.strokeSize,
            fill: this.color,
            'network-type': 'vertex'
        });
        this.labelEl = SVG.addChild(vertexSvg, "text", {
            "x": 5,
            "y": this.labelSize + o.size,
            "font-size": this.labelSize,
            "fill": this.labelColor,
            'network-type': 'vertex-label'
        });
        var label = this.vertex.id;
        if ($.type(this.labelText) === 'string' && this.labelText.length > 0) {
            label = this.labelText;
        }
        this.labelEl.textContent = label;
        this._calculateLabelX(o);

        this.el = vertexSvg;
        this.groupEl = groupSvg;
        this.vertexEl = rect;
        this.targetEl.appendChild(vertexSvg);
    },
    _updateRectangleSize: function () {

        var o = this._calculateOffset();
        var s1 = (this.size * 0.3);
        var s2 = s1 / 2;

        this.el.setAttribute('x', this.coords.x - o.midOffset);
        this.el.setAttribute('y', this.coords.y - o.midOffset);

        this.vertexEl.setAttribute('stroke-width', this.strokeSize);
        this.vertexEl.setAttribute('x', o.midOffset - this.size / 2 - s2);
        this.vertexEl.setAttribute('y', o.midOffset - this.size / 2 + s2);
        this.vertexEl.setAttribute('width', this.size + s1);
        this.vertexEl.setAttribute('height', this.size - s1);

        if (this.labelSize > 0) {
            this._calculateLabelX(o);
        }
        if (this.selected) {
            this._updateSelectShapeSize(o);
        }
    },
    /* END RECTANGLE METHODS */

    _drawSelectCircleShape: function () {
        var attr = this._calculateOffset();
        this.selectEl = SVG.addChild(this.el, "circle", {
            r: attr.midOffset,
            cx: attr.midOffset,
            cy: attr.midOffset,
            opacity: '0.5',
            fill: '#777777',
            'network-type': 'select-vertex'
        }, 0);
    },
    _updateSelectShapeSize: function (o) {
        this.selectEl.setAttribute('r', o.midOffset);
        this.selectEl.setAttribute('cx', o.midOffset);
        this.selectEl.setAttribute('cy', o.midOffset);
    },
    _drawSelectEllipseShape: function () {
        //TODO
        this._drawSelectCircleShape();
    },
    _drawSelectSquareShape: function () {
        //TODO
        this._drawSelectCircleShape();
    },
    _drawSelectRectangleShape: function () {
        //TODO
        this._drawSelectCircleShape();
    },
    toJSON: function () {
        return {
            shape: this.shape,
            size: this.size,
            color: this.color,
            strokeSize: this.strokeSize,
            strokeColor: this.strokeColor,
            opacity: this.opacity,
            labelSize: this.labelSize,
            labelColor: this.labelColor,
            labelText: this.labelText
        };
    }
}
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function Edge(args) {

    this.id = 'e' + Utils.genId();

    this.relation = '';
    this.source;
    this.target;
    this.weight;
    this.directed;
    this.overlapCount;

    this.attributes = {};

    this.renderer = new DefaultEdgeRenderer();
    //set instantiation args, must be last
    for (var prop in args) {
        if (hasOwnProperty.call(args, prop)) {
            this[prop] = args[prop];
        }
    }

    if (this.renderer) {
        this.renderer.edge = this;
    }
}

Edge.prototype = {
    getSource: function () {
        return this.source;
    },
    setSource: function (vertex) {
        this.source = vertex;
    },
    getTarget: function () {
        return this.target;
    },
    setTarget: function (vertex) {
        this.target = vertex;
    },
    render: function (args) {
        this.renderer.render(args)
    },
    setRenderer: function (renderer) {
        if (renderer) {
            this.renderer = renderer;
            this.renderer.edge = this;
        }
    },
    toJSON: function () {
        return {
            id: this.id,
            source: this.source,
            target: this.target,
            weight: this.weight,
            directed: this.directed,
            relation: this.relation,
            renderer: this.renderer,
            attributes: this.attributes
        }
    }
}
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//function GraphLayout(args) {
//    _.extend(this, Backbone.Events);
//    this.id = Utils.genId('GraphLayout');
//
//    this.verticesList = [];
//
//    //set instantiation args, must be last
//    _.extend(this, args);
//
//    this.vertices = {};
//
//    this._init();
//
//    this.on(this.handlers);
//}

GraphLayout = {
    _init: function () {
        for (var i in this.verticesList) {
            var vertex = this.verticesList[i];
            if (typeof vertex.x === 'undefined') {
                vertex.x = 0;
            }
            if (typeof vertex.y === 'undefined') {
                defda
                vertex.y = 0;
            }
            if (typeof vertex.z === 'undefined') {
                vertex.z = 0;
            }
            this.vertices[vertex.id] = vertex;
        }
    },
    getRandomArbitrary: function (min, max) {
        return Math.random() * (max - min) + min;
    },
    applyRandom3d: function () {
        for (var i in this.vertices) {
            var vertex = this.vertices[i];
            vertex.x = this.getRandomArbitrary(-300, 300);
            vertex.y = this.getRandomArbitrary(-300, 300);
            vertex.z = this.getRandomArbitrary(10, 600);
        }
    },
    sphereSurface: function (vertices, network, radius, offsetZ) {

        //        θ = theta
        //        φ = phi
        var n = vertices.length;

        for (var i = 0; i < vertices.length; i++) {
            var vertex = vertices[i];
            var vertexConfig = network.config.getVertexConfig(vertex);
            var coords = vertexConfig.coords;

            var phi = Math.acos(-1 + (2 * i) / n);
            var theta = Math.sqrt(n * Math.PI) * phi;
            coords.x = radius * Math.cos(theta) * Math.sin(phi);
            coords.y = radius * Math.sin(theta) * Math.sin(phi);
            coords.z = radius * Math.cos(phi) + offsetZ;
        }
    },
    random2d: function (network, width, height) {
        var vertices = network.graph.vertices;
        var x, y;
        for (var i = 0, l = vertices.length; i < l; i++) {
            var vertex = vertices[i];
            x = this.getRandomArbitrary(0, width);
            y = this.getRandomArbitrary(0, height);
            vertex.position.x = x;
            vertex.position.y = y;
            vertex.renderer.move();
            network._updateEdgeCoords(vertex);
        }
    },
    circle: function (network, width, height, orderedVertices) {
        var vertices = network.graph.vertices;
        if (typeof orderedVertices !== 'undefined') {
            vertices = orderedVertices;
        }

        var radius = (height - 100) / 2;
        var centerX = width / 2;
        var centerY = height / 2;
        var x, y, vertex;
        for (var i = 0, l = vertices.length; i < l; i++) {
            var vertex = network.graph.getVertexById(vertices[i].id);
            x = centerX + radius * Math.sin(i * 2 * Math.PI / vertices.length);
            y = centerY + radius * Math.cos(i * 2 * Math.PI / vertices.length);
            vertex.position.x = x;
            vertex.position.y = y;
            vertex.renderer.move();
            network._updateEdgeCoords(vertex);
        }
    },
    force: function (args) {
        var network = args.network;
        var graph = args.network.graph;
        var vAttr = args.network.vAttr;
        var eAttr = args.network.eAttr;
        var width = args.width;
        var height = args.height;
        var friction = args.friction;
        var gravity = args.gravity;
        var chargeDistance = args.chargeDistance;

        var linkStrength = args.linkStrength;
        var linkDistance = args.linkDistance;
        var charge = args.charge;

        var attributes = args.attributes;

        var endFunction = args.end;
        var simulation = args.simulation;

        var config = typeof args.config === 'undefined' ? {
            vertices: {},
            edges: {}
        } : args.config;

        if (typeof network === 'undefined') {
            console.log('graph not defined');
            return;
        }
        var verticesArray = [];
        var verticesMap = [];
        var edgesArray = [];

        var force = d3.layout.force();

        //Global parameters
        force.size([width, height]);
        if (typeof friction !== 'undefined') {
            force.friction(friction);

        }
        if (typeof gravity !== 'undefined') {
            force.gravity(gravity);

        }
        if (typeof chargeDistance !== 'undefined') {
            force.chargeDistance(chargeDistance);

        }

        var vertices = network.graph.vertices;
        var edges = network.graph.edges;

        /*------------------------------------------*/
        /*------------------------------------------*/
        console.time('Force directed preload');

        //set node and edge arrays for D3
        for (var i = 0, l = vertices.length; i < l; i++) {
            var vertex = vertices[i];
            var v = {
                id: vertex.id,
                index: i,
                x: vertex.position.x,
                y: vertex.position.y
            };
            verticesArray.push(v);
            verticesMap[vertex.id] = v;
        }
        force.nodes(verticesArray);
        for (var i = 0, l = edges.length; i < l; i++) {
            var edge = edges[i];
            if (typeof edge !== 'undefined') {
                edgesArray.push({
                    id: edge.id,
                    source: verticesMap[edge.source.id],
                    target: verticesMap[edge.target.id]
                });
            }
        }
        force.links(edgesArray);

        /* Node and Edge specific parameters */
        //Link Distance
        if (typeof linkDistance !== 'undefined') {
            if (!attributes || attributes.linkDistance == 'none') {
                force.linkDistance(linkDistance);
            } else {
                force.linkDistance(function (e) {
                    var edge = graph.getEdgeById(e.id);
                    var value = vAttr.getRow(edge.id)[attributes.linkDistance];
                    var ld = isNaN(value) ? (edge.source.renderer.getSize() + edge.target.renderer.getSize()) * 1.7 : value * linkDistance;
                    return ld;
                });
            }
        } else {
            force.linkDistance(function (e) {
                var edge = graph.getEdgeById(e.id);
                return edge.source.renderer.getSize() + edge.target.renderer.getSize() * 1.7;
            })
        }
        //Link Strength
        if (typeof linkStrength !== 'undefined') {
            if (!attributes || attributes.linkStrength == 'none') {
                force.linkStrength(linkStrength);
            } else {
                //is and attributName
                force.linkStrength(function (e) {
                    var value = vAttr.getRow(e.id)[attributes.linkStrength];
                    var ls = isNaN(value) ? 1 : value * linkStrength;
                    return ls;
                });
            }
        }
        //Node Charge
        if (typeof charge !== 'undefined') {
            if (!attributes || attributes.charge == 'none') {
                force.charge(charge);
            } else {
                //is and attributName
                force.charge(function (v) {
                    var vertex = graph.getVertexById(v.id);
                    var value = eAttr.getRow(vertex.id)[attributes.charge];
                    var c = isNaN(value) ? vertex.renderer.getSize() * -13 : value * charge;
                    return c;
                });
            }
        } else {
            force.charge(function (v) {
                var vertex = graph.getVertexById(v.id);
                return vertex.renderer.getSize() * -13;
            });
        }
        console.timeEnd('Force directed preload');
        /*------------------------------------------*/
        /*------------------------------------------*/

        force.on('end', function (o) {
            console.log(o)
            endFunction(verticesArray);
        });

        if (simulation === true) {
            force.on('tick', function (o) {
                endFunction(verticesArray);
                console.log(force.alpha())
                if (force.alpha() < 0.025) {
                    force.stop()
                }
            });
            force.start();
        } else {
            console.time('D3 Force directed layout');
            force.start();
            var safety = 0;
            while (force.alpha() > 0.025) { // You'll want to try out different, "small" values for this
                force.tick();
                if (safety++ > 1000) {
                    break; // Avoids infinite looping in case this solution was a bad idea
                }
            }
            //            console.log(safety);
            force.stop();
            console.timeEnd('D3 Force directed layout');
        }

    },
    tree: function (args) {
        var network = args.network;
        var graph = network.graph;
        var vAttr = network.vAttr;
        var eAttr = network.eAttr;
        var width = args.width;
        var height = args.height;
        var vertices = graph.vertices;
        var edges = graph.edges;

        var rootNode = {
            name: args.root.id,
            vertex: args.root,
            children: null
        };
        var visited = {};
        //visited[args.root.id] = true;
        this._getTreeNode(rootNode, visited);

        var tree = d3.layout.tree()
            .sort(null)
            .size([width, height]);
        var nodes = tree.nodes(rootNode);

        args.end(nodes);

        //var links = tree.links(nodes);

    },
    _getTreeNode: function (node, visited) {
        //if (node.vertex.id == "GO:0042802") {
        //    debugger
        //}
        visited[node.vertex.id] = true;
        for (var i = 0; i < node.vertex.edges.length; i++) {
            var edge = node.vertex.edges[i];
            if (edge.target !== node.vertex && visited[edge.target.id] != true) {
                var childVertex = edge.target;
                if (node.children == null) {
                    node.children = [];
                }
                //var childVertexParents = [];
                var notVisitedParentsCount = 0;
                for (var j = 0; j < childVertex.edges.length; j++) {
                    var childEdge = childVertex.edges[j];
                    if (childEdge.target === childVertex) {
                        if (visited[childEdge.source.id] != true) {
                            notVisitedParentsCount++;
                        }
                    }
                }
                if (notVisitedParentsCount == 0) {
                    node.children.push({
                        name: childVertex.id,
                        size: childVertex.renderer.size,
                        vertex: childVertex,
                        children: null
                    });
                }
            }

            //
            //if (edge.target !== vertex && visited[edge.target.id] != true) {
            //    children.push(this._getTreeNode(edge.target, visited));
            //}
            //if (edge.source !== vertex && visited[edge.source.id] != true) {
            //    children.push(this._getTreeNode(edge.source, visited));
            //}
        }
        if (node.children != null) {
            for (var i = 0; i < node.children.length; i++) {
                var childNode = node.children[i];
                this._getTreeNode(childNode, visited)
            }
        }
    },

    /**/
    /**/
    /**/

    forceTree: function (args) {
        /*TODO not ready*/
        var network = args.network;
        var graph = network.graph;
        var vAttr = network.vAttr;
        var eAttr = network.eAttr;
        var width = args.width;
        d3
        var force = d3.layout.force();
        force.size([width, height]);
        force.charge(-320)
        force.linkDistance(50)

        /* set node and edge arrays for D3 */
        var verticesMap = [];
        var edgesArray = [];
        var verticesArray = [];
        for (var i = 0, l = vertices.length; i < l; i++) {
            var vertex = vertices[i];
            var v = {
                id: vertex.id,
                index: i,
                x: vertex.position.x,
                y: vertex.position.y
            };
            verticesArray.push(v);
            verticesMap[vertex.id] = v;
        }
        force.nodes(verticesArray);
        for (var i = 0, l = edges.length; i < l; i++) {
            var edge = edges[i];
            if (typeof edge !== 'undefined') {
                edgesArray.push({
                    id: edge.id,
                    source: verticesMap[edge.source.id],
                    target: verticesMap[edge.target.id]
                });
            }
        }
        force.links(edgesArray);

        force.on('end', function (o) {
            console.log(o)
            endFunction(verticesArray);
        });
        console.time('D3 Force directed layout');
        force.start();
        var safety = 0;
        while (force.alpha() > 0.025) { // You'll want to try out different, "small" values for this
            force.tick();
            var k = 8 * force.alpha();
            edgesArray.forEach(function (d, i) {
                d.source.y -= k;
                d.target.y += k;
            });
            if (safety++ > 1000) {
                break; // Avoids infinite looping in case this solution was a bad idea
            }
        }
        //            console.log(safety);
        force.stop();
        console.timeEnd('D3 Force directed layout');

    },

    tree2: function (args) {
        /* TODO not ready */
        var network = args.network;
        var graph = network.graph;
        var vAttr = network.vAttr;
        var eAttr = network.eAttr;
        var width = args.width;
        var height = args.height;
        var vertices = graph.vertices;
        var edges = graph.edges;
        var endFunction = args.end;

        var force = d3.layout.force()
            .charge(function (d) {
                return d._children ? -d.size / 100 : d.children ? -100 : -30;
            })
            .linkDistance(function (d) {
                return d.target._children ? 50 : 30;
            })
            .size([width, height]);

        var rootNode = {
            name: args.root.id,
            vertex: args.root,
            fixed: true,
            size: args.root.renderer.size,
            px: 0,
            py: 0,
            children: null
        };
        var visited = {};
        //visited[args.root.id] = true;
        this._getTreeNode(rootNode, visited);

        var nodes = this._flatten(rootNode, width, height);
        //var links = d3.layout.hierarchy().links(nodes);
        var links = d3.layout.tree().links(nodes);
        // make sure we set .px/.py as well as node.fixed will use those .px/.py to 'stick' the node to:
        if (!rootNode.px) {
            // root have not be set / dragged / moved: set initial root position
            rootNode.px = rootNode.x = width / 2;
            rootNode.py = rootNode.y = (rootNode.children ? 4.5 : Math.sqrt(rootNode.size) / 10) + 2;
        }
        force
            .nodes(nodes)
            .links(links);

        force.on('end', function (o) {
            console.log(o)
            debugger
            endFunction(nodes);
        });
        console.time('D3 Force directed layout');
        force.start();
        var safety = 0;
        while (force.alpha() > 0.025) { // You'll want to try out different, "small" values for this
            force.tick();

            // Apply the constraints:
            force.nodes().forEach(function (d) {
                if (!d.fixed) {
                    var r = (d.children ? 4.5 : Math.sqrt(d.size) / 10) + 4,
                        dx, dy, ly = 30;

                    // #1: constraint all nodes to the visible screen:
                    //d.x = Math.min(width - r, Math.max(r, d.x));
                    //d.y = Math.min(height - r, Math.max(r, d.y));

                    // #1.0: hierarchy: same level nodes have to remain with a 1 LY band vertically:
                    if (d.children || d._children) {
                        var py = 0;
                        if (d.parent) {
                            py = d.parent.y;
                        }
                        d.py = d.y = py + d.depth * ly + r;
                    }

                    // #1a: constraint all nodes to the visible screen: links
                    dx = Math.min(0, width - r - d.x) + Math.max(0, r - d.x);
                    dy = Math.min(0, height - r - d.y) + Math.max(0, r - d.y);
                    d.x += 2 * Math.max(-ly, Math.min(ly, dx));
                    d.y += 2 * Math.max(-ly, Math.min(ly, dy));
                    // #1b: constraint all nodes to the visible screen: charges ('repulse')
                    dx = Math.min(0, width - r - d.px) + Math.max(0, r - d.px);
                    dy = Math.min(0, height - r - d.py) + Math.max(0, r - d.py);
                    d.px += 2 * Math.max(-ly, Math.min(ly, dx));
                    d.py += 2 * Math.max(-ly, Math.min(ly, dy));

                    // #2: hierarchy means childs must be BELOW parents in Y direction:
                    if (d.parent) {
                        d.y = Math.max(d.y, d.parent.y + ly);
                        d.py = Math.max(d.py, d.parent.py + ly);
                    }
                }
            });

            if (safety++ > 1000) {
                break; // Avoids infinite looping in case this solution was a bad idea
            }
        }
        //            console.log(safety);
        force.stop();
        console.timeEnd('D3 Force directed layout');

    },
    _flatten: function (root, width, height) {
        var nodes = [],
            i = 0,
            depth = 0,
            level_widths = [1],
            max_width, max_depth = 1,
            kx, ky;

        function recurse(node, parent, depth, x) {
            if (node.children) {
                var w = level_widths[depth + 1] || 0;
                level_widths[depth + 1] = w + node.children.length;
                max_depth = Math.max(max_depth, depth + 1);
                node.size = node.children.reduce(function (p, v, i) {
                    return p + recurse(v, node, depth + 1, w + i);
                }, 0);
            }
            if (!node.id) node.id = ++i;
            node.parent = parent;
            node.depth = depth;
            if (!node.px) {
                node.y = depth;
                node.x = x;
            }
            nodes.push(node);
            return node.size;
        }

        root.size = recurse(root, null, 0);

        // now correct/balance the x positions:
        max_width = 1;
        for (i = level_widths.length; --i > 0;) {
            max_width = Math.max(max_width, level_widths[i]);
        }
        kx = (width - 20) / max_width;
        ky = (height - 20) / max_depth;
        for (i = nodes.length; --i >= 0;) {
            var node = nodes[i];
            if (!node.px) {
                node.y *= ky;
                node.y += 10 + ky / 2;
                node.x *= kx;
                node.x += 10 + kx / 2;
            }
        }

        return nodes;
    },
    grid: function (args) {
        this._doCytoscapeLayout(args, 'grid');
    },
    breadthfirst: function (args) {
        this._doCytoscapeLayout(args, 'breadthfirst');
    },
    _doCytoscapeLayout: function (args, layoutName, layoutArgs) {
        if (layoutArgs == null) {
            layoutArgs = {};
        }

        var network = args.network;
        var graph = args.network.graph;
        var width = args.width;
        var height = args.height;
        var vertices = network.graph.vertices;
        var edges = network.graph.edges;

        var endFunction = args.end;

        var cy = cytoscape({});

        //set node and edge arrays
        var eles = this._createCytoscapeEles(vertices, edges);
        eles = cy.add(eles);

        layoutArgs["name"] = layoutName;
        layoutArgs["boundingBox"] = {
            x1: 0,
            y1: 0,
            w: width,
            h: height
        };
        eles.layout(layoutArgs);
        endFunction(eles);
    },
    _createCytoscapeEles: function (vertices, edges) {
        var eles = [];
        for (var i = 0, l = vertices.length; i < l; i++) {
            var vertex = vertices[i];
            eles.push({
                group: "nodes",
                data: {
                    id: vertex.id
                }
            });
        }
        for (var i = 0, l = edges.length; i < l; i++) {
            var edge = edges[i];
            eles.push({
                group: "edges",
                data: {
                    id: edge.id,
                    source: edge.source.id,
                    target: edge.target.id
                }
            });
        }
        return eles
    },
    concentric: function (args) {
        var network = args.network;
        var graph = args.network.graph;
        var width = args.width;
        var height = args.height;
        var vertices = network.graph.vertices;
        var edges = network.graph.edges;

        var endFunction = args.end;

        var ca = args.concentricAttribute;

        var cy = cytoscape({});
        var eles = [];
        for (var i = 0, l = vertices.length; i < l; i++) {
            var vertex = vertices[i];
            var c = 0;
            if (ca != null && ca != 'none' && !isNaN(parseFloat(vertex.attributes[ca]))) {
                c = parseFloat(vertex.attributes[ca]);
            }
            var n = {
                group: "nodes",
                data: {
                    id: vertex.id,
                    concentric: c
                }
            };
            eles.push(n);
        }
        for (var i = 0, l = edges.length; i < l; i++) {
            var edge = edges[i];
            var e = {
                group: "edges",
                data: {
                    id: edge.id,
                    source: edge.source.id,
                    target: edge.target.id
                }
            };
            eles.push(e);
        }
        eles = cy.add(eles);
        var layoutConfig = {
            name: 'concentric',
            boundingBox: {
                x1: 0,
                y1: 0,
                w: width,
                h: height
            },
            minNodeSpacing: 30
        }
        if (args.concentricAttribute != null && args.concentricAttribute != 'none') {
            layoutConfig["concentric"] = function (node) {
                return node.data('concentric');
            }
        }
        if (args.startAngle != null) {
            layoutConfig["startAngle"] = parseFloat(args.startAngle);
        }
        if (args.sweep != null) {
            layoutConfig["sweep"] = parseFloat(args.sweep);
        }
        if (args.minNodeSpacing != null) {
            layoutConfig["minNodeSpacing"] = parseFloat(args.minNodeSpacing);
        }
        if (args.clockwise != null) {
            layoutConfig["clockwise"] = args.clockwise;
        }
        if (args.equidistant != null) {
            layoutConfig["equidistant"] = args.equidistant;
        }
        if (args.avoidOverlap != null) {
            layoutConfig["avoidOverlap"] = args.avoidOverlap;
        }
        console.log(layoutConfig);
        eles.layout(layoutConfig);
        endFunction(eles);
    },
    cose: function (args) {
        var network = args.network;
        var graph = args.network.graph;
        var width = args.width;
        var height = args.height;
        var vertices = network.graph.vertices;
        var edges = network.graph.edges;

        var endFunction = args.end;

        var nra = args.nodeRepulsionAttribute;
        var iela = args.idealEdgeLengthAttribute;
        var eea = args.edgeElasticityAttribute;

        var cy = cytoscape({});

        //set node and edge arrays
        var eles = [];
        for (var i = 0, l = vertices.length; i < l; i++) {
            var vertex = vertices[i];
            var nr = 400000;
            if (!isNaN(parseFloat(args.nodeRepulsion))) {
                nr = parseFloat(args.nodeRepulsion);
            }
            if (nra != null && nra != 'none' && !isNaN(parseFloat(vertex.attributes[nra]))) {
                nr = parseFloat(vertex.attributes[nra]);
            }
            var n = {
                group: "nodes",
                data: {
                    id: vertex.id,
                    nodeRepulsion: nr
                }
            };
            eles.push(n);
        }
        for (var i = 0, l = edges.length; i < l; i++) {
            var edge = edges[i];
            var iel = 10,
                ee = 100;
            if (!isNaN(parseFloat(args.idealEdgeLength))) {
                iel = parseFloat(args.idealEdgeLength);
            }
            if (iela != null && iela != 'none' && !isNaN(parseFloat(edge.attributes[iela]))) {
                iel = parseFloat(edge.attributes[iela]);
            }
            if (!isNaN(parseFloat(args.edgeElasticity))) {
                ee = parseFloat(args.edgeElasticity);
            }
            if (eea != null && eea != 'none' && !isNaN(parseFloat(edge.attributes[eea]))) {
                ee = parseFloat(edge.attributes[eea]);
            }
            var e = {
                group: "edges",
                data: {
                    id: edge.id,
                    source: edge.source.id,
                    target: edge.target.id,
                    idealEdgeLength: iel,
                    edgeElasticity: ee
                }
            };
            eles.push(e);
        }
        eles = cy.add(eles);
        var layoutConfig = {
            name: 'cose',
            boundingBox: {
                x1: 0,
                y1: 0,
                w: width,
                h: height
            },
            refresh: 1,
            fit: true,
            animate: false,
            nodeRepulsion: function (node) {
                return parseFloat(node.data('nodeRepulsion'));
            },
            idealEdgeLength: function (edge) {
                return parseFloat(edge.data('idealEdgeLength'));
            },
            edgeElasticity: function (edge) {
                return parseFloat(edge.data('edgeElasticity'));
            },
            ready: function () {
                endFunction(eles);
            }
        }
        if (args.componentSpacing != null) {
            layoutConfig["componentSpacing"] = parseFloat(args.componentSpacing);
        }
        if (args.nodeOverlap != null) {
            layoutConfig["nodeOverlap"] = parseFloat(args.nodeOverlap);
        }
        if (args.nestingFactor != null) {
            layoutConfig["nestingFactor"] = parseFloat(args.nestingFactor);
        }
        if (args.gravity != null) {
            layoutConfig["gravity"] = parseFloat(args.gravity);
        }
        console.log(layoutConfig);
        eles.layout(layoutConfig);
    }
}

Point = function (x, y, z) {

    this.x = x || 0;
    this.y = y || 0;
    this.z = z || 0;

};

Point.prototype = {
    set: function (x, y, z) {

        this.x = x;
        this.y = y;
        this.z = z;

        return this;

    },

    setX: function (x) {

        this.x = x;

        return this;

    },

    setY: function (y) {

        this.y = y;

        return this;

    },

    setZ: function (z) {

        this.z = z;

        return this;

    },
    toJSON: function () {
        return {x: this.x, y: this.y, z: this.z}
    }
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function Vertex(args) {
    this.id = 'v' + Utils.genId();

    this.edges = [];
    this.edgesIndex = {};

    this.position = new Point();
    this.renderer = new CircosVertexRenderer();
    this.attributes = {};

    //set instantiation args, must be last
    for (var prop in args) {
        if (hasOwnProperty.call(args, prop)) {
            this[prop] = args[prop];
        }
    }

    if (this.renderer) {
        this.renderer.coords = this.position;
        this.renderer.vertex = this;
    }
}

Vertex.prototype = {
    removeEdge: function (edge) {
        for (var i = 0; i < this.edges.length; i++) {
            if (this.edges[i].id === edge.id) {
                this.edges.splice(i, 1);
                delete this.edgesIndex[edge.id];
                break;
            }
        }
    },
    removeEdges: function () {
        this.edges = [];
        this.edgesIndex = {};
    },
    addEdge: function (edge) {
        if (this.containsEdge(edge) === false) {
            this.edges.push(edge);
            this.edgesIndex[edge.id] = edge;
        }
    },
    containsEdge: function (edge) {
        if (typeof this.edgesIndex[edge.id] !== 'undefined') {
            return true;
        } else {
            return false;
        }
    },
    render: function (args) {
        this.renderer.render(args)
    },
    setRenderer: function (renderer) {
        if (renderer) {
            this.renderer = renderer;
            this.renderer.coords = this.position;
            this.renderer.vertex = this;
        }
    },
    toJSON: function () {
        return {
            id: this.id,
            position: this.position,
            renderer: this.renderer,
            attributes: this.attributes
        }
    }
}
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function DataSource() {
	
};

DataSource.prototype.fetch = function(){

};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

FileDataSource.prototype.fetch = DataSource.prototype.fetch;

function FileDataSource(args) {
    DataSource.prototype.constructor.call(this);

    _.extend(this, Backbone.Events);

    this.file;
    this.maxSize = 500 * 1024 * 1024;
    this.type = 'text';

    //set instantiation args, must be last
    _.extend(this, args);
};

FileDataSource.prototype.error = function () {
    alert("File is too big. Max file size is " + this.maxSize + " bytes");
};

FileDataSource.prototype.fetch = function (async) {
    var _this = this;
    if (this.file.size <= this.maxSize) {
        if (async) {
            var reader = new FileReader();
            reader.onload = function (evt) {
                _this.trigger('success', evt.target.result);
            };
            return this.readAs(this.type, reader);
        } else {
            // FileReaderSync web workers only
            var reader = new FileReaderSync();
            return this.readAs(this.type, reader);
        }
    } else {
        _this.error();
        _this.trigger('error', {sender: this});
    }
};


FileDataSource.prototype.readAs = function (type, reader) {
    switch (type) {
        case 'binary':
            return reader.readAsBinaryString(this.file);
            break;
        case 'text':
        default:
            return reader.readAsText(this.file, "UTF-8");
    }
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

StringDataSource.prototype.fetch = DataSource.prototype.fetch;

function StringDataSource(str) {
	DataSource.prototype.constructor.call(this);

    _.extend(this, Backbone.Events);
	this.str = str;
};

StringDataSource.prototype.fetch = function(async){
	if(async){
		this.trigger('success',this.str);
	}else{
		return this.str;
	}
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function TabularDataAdapter(dataSource, args){
	var _this = this;
	
	this.dataSource = dataSource;
	this.async = true;

	if (args != null){
		if(args.async != null){
			this.async = args.async;
		}
	}
	
	this.fileLines = [];
	
	if(this.async){
		this.dataSource.success.addEventListener(function(sender,data){
			_this.parse(data);
			_this.onLoad.notify();
		});
		this.dataSource.fetch(this.async);
	}else{
		var data = this.dataSource.fetch(this.async);
		this.parse(data);
	}
	
	this.onLoad = new Event();	
};

TabularDataAdapter.prototype.getLines = function(){
	return this.fileLines;
};

TabularDataAdapter.prototype.parse = function(data){
	var _this = this;
	var lines = data.split("\n");
//	console.log("creating objects");
	for (var i = 0; i < lines.length; i++){
		var line = lines[i].replace(/^\s+|\s+$/g,"");
		line = line.replace(/\//gi,"");//TODO DONE   /  is not allowed in the call
		if ((line != null)&&(line.length > 0) && line.charAt(0)!="#"){
			var fields = line.split("\t");
			this.fileLines.push(fields);
		}
	}
};

//
TabularDataAdapter.prototype.getLinesCount = function(){
	return this.fileLines.length;
};

TabularDataAdapter.prototype.getValuesByColumnIndex = function(columnIndex){
	var result = new Array();
	for (var i = 0; i < this.getLinesCount(); i++) {
		if (this.getLines()[i][columnIndex] != null){
			result.push(this.getLines()[i][columnIndex]);
		}
	}
	return result;
};

/** Returns: 'numeric' || 'string **/
TabularDataAdapter.prototype.getHeuristicTypeByColumnIndex = function(columnIndex){
	return this.getHeuristicTypeByValues(this.getValuesByColumnIndex(columnIndex));
};

TabularDataAdapter.prototype.getHeuristicTypeByValues = function(values){
	var regExp = /^[-+]?[0-9]*\.?[0-9]+$/;
	for (var i = 0; i < values.length; i++) {
		if(!regExp.test(new String(values[i]).replace(",", "."))){
			return 'string';
		}
	}
	return 'numeric';
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

UrlDataSource.prototype.fetch = DataSource.prototype.fetch;

function UrlDataSource(url, args) {
	DataSource.prototype.constructor.call(this);
	
	this.url = url;
	this.proxy = CELLBASE_HOST+"/latest/utils/proxy?url=";
	if(args != null){
		if(args.proxy != null){
			if(typeof(args.proxy) == "boolean"){
				if(args.proxy == false){
					this.proxy = false;
				}
				else{
					this.url = this.proxy + url;
				}
			}else if(typeof(args.proxy) == "string"){
				this.url = args.proxy + url;
			}
		}
	}
	this.success = new Event();
	this.error = new Event();
};

UrlDataSource.prototype.fetch = function(async){
	var _this = this;
	
	var datos = null;
	
	if(this.url){
		$.ajax({
			type : "GET",
			url : this.url,
			async : async,
			success : function(data, textStatus, jqXHR) {
				if(async){
					_this.success.notify(data);
				}else{
					datos = data;
				}
			},
			error : function(jqXHR, textStatus, errorThrown){
				console.log("URL Data source: Ajax call returned : "+errorThrown+'\t'+textStatus+'\t'+jqXHR.statusText+" END");
				_this.error.notify();
			}
		});
		
		return datos;
	}
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function FeatureDataAdapter(dataSource, args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    this.dataSource = dataSource;
    this.gzip = true;

    this.params = {};
    if (args != null) {
        if (args.gzip != null) {
            this.gzip = args.gzip;
        }
        if (args.species != null) {
            this.species = args.species;
        }
        if (args.params != null) {
            this.params = args.params;
        }
    }

    this.featureCache = new FileFeatureCache({chunkSize: 10000, gzip: this.gzip});

//	this.onLoad = new Event();
//	this.onGetData = new Event();

    //chromosomes loaded
    this.chromosomesLoaded = {};
}

FeatureDataAdapter.prototype.getData = function (args) {
    console.log("TODO comprobar histograma");
    console.log(args.region);
    this.params["dataType"] = "data";
    this.params["chromosome"] = args.region.chromosome;

    //check if the chromosome has been already loaded
    if (this.chromosomesLoaded[args.region.chromosome] != true) {
        this._fetchData(args.region);
        this.chromosomesLoaded[args.region.chromosome] = true;
    }

    var itemList = this.featureCache.getFeatureChunksByRegion(args.region);
    if (itemList != null) {
        this.trigger('data:ready', {items: itemList, params: this.params, chunkSize: this.featureCache.chunkSize, cached: true, sender: this});
    }
    args.done();
};

FeatureDataAdapter.prototype._fetchData = function (region) {
    var _this = this;
    if (this.dataSource != null) {//could be null in expression genomic attributer widget 59
        if (this.async) {
            this.dataSource.on('success', function (data) {
                _this.parse(data, region);
//				_this.onLoad.notify();
                _this.trigger('file:load', {sender: _this});


                var itemList = _this.featureCache.getFeatureChunksByRegion(region);
                if (itemList != null) {
                    _this.trigger('data:ready', {items: itemList, params: _this.params, chunkSize: _this.featureCache.chunkSize, cached: true, sender: _this});
                }

            });
            this.dataSource.fetch(this.async);
        } else {
            var data = this.dataSource.fetch(this.async);
            this.parse(data, region);
        }
    }
}

FeatureDataAdapter.prototype.addFeatures = function (features) {
    this.featureCache.putFeatures(features, "data");
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function BamAdapter(args){

    _.extend(this, Backbone.Events);

    if(typeof args != 'undefined'){
        this.host = args.host || this.host;
        this.category = args.category || this.category;
		this.resource = args.resource || this.resource;
		this.params = args.params || this.params;
		this.filters = args.filters || this.filters;
		this.options = args.options || this.options;
        this.species = args.species || this.species;
        var argsFeatureCache = args.featureCache || {};
    }
	if (args != null){
		if(args.featureConfig != null){
			if(args.featureConfig.filters != null){
				this.filtersConfig = args.featureConfig.filters;
			}
			if(args.featureConfig.options != null){//apply only check boxes
				this.optionsConfig = args.featureConfig.options;
				for(var i = 0; i < this.optionsConfig.length; i++){
					if(this.optionsConfig[i].checked == true){
						this.options[this.optionsConfig[i].name] = true;
						this.params[this.optionsConfig[i].name] = true;
					}				
				}
			}
		}
	}

	this.featureCache = new BamCache(argsFeatureCache);
//	this.onGetData = new Event();
}

BamAdapter.prototype = {
    host : null,
    gzip : true,
    params : {}
};

BamAdapter.prototype.clearData = function(){
	this.featureCache.clear();
};

BamAdapter.prototype.setFilters = function(filters){
	this.clearData();
	this.filters = filters;
	for(filter in filters){
		var value = filters[filter].toString();
		delete this.params[filter];
		if(value != ""){
			this.params[filter] = value;
		}
	}
};
BamAdapter.prototype.setOption = function(opt, value){
	if(opt.fetch){
		this.clearData();
	}
	this.options[opt.name] = value;
	for(option in this.options){
		if(this.options[opt.name] != null){
			this.params[opt.name] = this.options[opt.name];
		}else{
			delete this.params[opt.name];
		}
	}
};


BamAdapter.prototype.getData = function(args){
	var _this = this;
	//region check
	this.params["histogram"] = args.histogram;
	this.params["histogramLogarithm"] = args.histogramLogarithm;
	this.params["histogramMax"] = args.histogramMax;
	this.params["interval"] = args.interval;
	this.params["transcript"] = args.transcript;
	this.params["chromosome"] = args.chromosome;
	this.params["resource"] = this.resource.id;
	this.params["category"] = this.category;
	this.params["species"] = Utils.getSpeciesCode(this.species.text);


	if(args.start<1){
		args.start=1;
	}
	if(args.end>300000000){
		args.end=300000000;
	}
	
	var dataType = "data";
	if(args.histogram){
		dataType = "histogram"+args.interval;
	}

	this.params["dataType"] = dataType;
	
	var firstChunk = this.featureCache._getChunk(args.start);
	var lastChunk = this.featureCache._getChunk(args.end);
	var chunks = [];
	var itemList = [];
	for(var i=firstChunk; i<=lastChunk; i++){
		var key = args.chromosome+":"+i;
		if(this.featureCache.cache[key] == null || this.featureCache.cache[key][dataType] == null) {
			chunks.push(i);
		}else{
			var item = this.featureCache.getFeatureChunk(key);
			itemList.push(item);
		}
	}

    var regionSuccess = function (data) {
		var splitDots = data.query.split(":");
		var splitDash = splitDots[1].split("-");
		var query = {chromosome:splitDots[0],start:splitDash[0],end:splitDash[1]};


		var dataType = "data";
		if(data.params.histogram){
			dataType = "histogram"+data.params.interval;
		    _this.featureCache.putHistogramFeaturesByRegion(data.result, query, data.resource, dataType);
		}else{
		    _this.featureCache.putFeaturesByRegion(data.result, query, data.resource, dataType);
        }

		var items = _this.featureCache.getFeatureChunksByRegion(query, dataType);
		itemList = itemList.concat(items);
		if(itemList.length > 0){
            _this.trigger('data:ready',{items:itemList, params:_this.params, cached:false, sender:_this});
//			_this.onGetData.notify({items:itemList, params:_this.params, cached:false});
		}
	};

	var querys = [];
	var updateStart = true;
	var updateEnd = true;
	if(chunks.length > 0){//chunks needed to retrieve
//		console.log(chunks);
		
		for ( var i = 0; i < chunks.length; i++) {
			
			if(updateStart){
				var chunkStart = parseInt(chunks[i] * this.featureCache.chunkSize);
				updateStart = false;
			}
			if(updateEnd){
				var chunkEnd = parseInt((chunks[i] * this.featureCache.chunkSize) + this.featureCache.chunkSize-1);
				updateEnd = false;
			}
			
			if(chunks[i+1]!=null){
				if(chunks[i]+1==chunks[i+1]){
					updateEnd =true;
				}else{
					var query = args.chromosome+":"+chunkStart+"-"+chunkEnd;
					querys.push(query);
					updateStart = true;
					updateEnd = true;
				}
			}else{
				var query = args.chromosome+":"+chunkStart+"-"+chunkEnd;
				querys.push(query);
				updateStart = true;
				updateEnd = true;
			}
		}
//		console.log(querys);
		for ( var i = 0, li = querys.length; i < li; i++) {
			console.time("dqs");
			//accountId, sessionId, bucketname, objectname, region,
            var cookie = $.cookie("bioinfo_sid");
            cookie = ( cookie != '' && cookie != null ) ?  cookie : 'dummycookie';
            OpencgaManager.region({
                accountId: this.resource.account,
                sessionId: cookie,
                bucketId: this.resource.bucketId,
                objectId: this.resource.oid,
                region: querys[i],
                queryParams: this.params,
                success:regionSuccess
            });
		}
	}else{//no server call
		if(itemList.length > 0){
            _this.trigger('data:ready',{items:itemList, params:this.params, cached:false, sender:this});
//			this.onGetData.notify({items:itemList, params:this.params});
		}
	}
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

BEDDataAdapter.prototype.getData = FeatureDataAdapter.prototype.getData;
BEDDataAdapter.prototype._fetchData = FeatureDataAdapter.prototype._fetchData;

function BEDDataAdapter(dataSource, args) {
    FeatureDataAdapter.prototype.constructor.call(this, dataSource, args);
    var _this = this;

    this.async = true;

    this.parseFunction;
    if (args != null) {
        if (args.parseFunction != null) {
            this.parseFunction = args.parseFunction;
        }
    }

    //stat atributes
    this.featuresCount = 0;
    this.featuresByChromosome = {};

    if (args != null) {
        if (args.async != null) {
            this.async = args.async;
        }
    }
};

BEDDataAdapter.prototype.parse = function (data, region) {
    if (this.parseFunction){
        this.parseFunction(data, region);
    }else{
        this._defaultParse(data, region);
    }
};

BEDDataAdapter.prototype._defaultParse = function (data, region) {

    var _this = this;
    var dataType = "value";
    var lines = data.split("\n");
//	console.log("creating objects");
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].replace(/^\s+|\s+$/g, "");
        if ((line != null) && (line.length > 0)) {
            var fields = line.split("\t");
            var chromosome = fields[0].replace("chr", "");
            if (chromosome == region.chromosome) {// load only one chromosome on the cache

                var feature = {
                    "label": fields[3],
                    "chromosome": chromosome,
                    "start": parseFloat(fields[1]),
                    "end": parseFloat(fields[2]),
                    "score": fields[4],
                    "strand": fields[5],
                    "thickStart": fields[6],
                    "thickEnd": fields[7],
                    "itemRgb": fields[8],
                    "blockCount": fields[9],
                    "blockSizes": fields[10],
                    "blockStarts": fields[11],
                    "featureType": "bed"
                };

                this.featureCache.putFeatures(feature, dataType);

                if (this.featuresByChromosome[chromosome] == null) {
                    this.featuresByChromosome[chromosome] = 0;
                }
                this.featuresByChromosome[chromosome]++;
                this.featuresCount++;
            }
        }
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function CellBaseAdapter(args) {

    _.extend(this, Backbone.Events);

    _.extend(this, args);

    this.on(this.handlers);

    this.configureCache();

    this.debug = false;
}

CellBaseAdapter.prototype = {
    setSpecies: function(species) {
        this.species = species;
        this.configureCache();
    },
    setHost: function(host) {
        this.configureCache();
        this.host = host;
    },
    deleteCache:function(){
        this.cache.delete();
    },
    configureCache: function() {
        var host = this.host || CellBaseManager.host;
        var speciesString = this.species.id + this.species.assembly.name.replace(/[/_().\ -]/g, '');
        var cacheId = host + speciesString;
        if (!this.cacheConfig) {
            this.cacheConfig = {
                //    //subCacheId: this.resource + this.params.keys(),
                chunkSize: 3000
            }
        }
        this.cacheConfig.cacheId = cacheId;
        this.cache = new FeatureChunkCache(this.cacheConfig);
    },

    getData: function(args) {
        var _this = this;

        var params = {};
        //histogram: (dataType == 'histogram')
        _.extend(params, this.params);
        _.extend(params, args.params);

        /** 1 region check **/
        var region = args.region;
        if (region.start > 300000000 || region.end < 1) {
            return;
        }
        region.start = (region.start < 1) ? 1 : region.start;
        region.end = (region.end > 300000000) ? 300000000 : region.end;

        /** 2 category check **/
        var categories = [this.category + this.subCategory + this.resource + Utils.queryString(params)];

        /** 3 dataType check **/
        var dataType = args.dataType;
        if (_.isUndefined(dataType)) {
            console.log("dataType must be provided!!!");
        }

        /** 4 chunkSize check **/
        var chunkSize = params.interval ? params.interval : this.cacheConfig.chunkSize; // this.cache.defaultChunkSize should be the same
        if (this.debug) {
            console.log(chunkSize);
        }

        /**
         * Get the uncached regions (uncachedRegions) and cached chunks (cachedChunks).
         * Uncached regions will be used to query cellbase. The response data will be converted in chunks
         * by the Cache TODO????
         * Cached chunks will be returned by the args.dataReady Callback.
         */
        this.cache.get(region, categories, dataType, chunkSize, function(cachedChunks, uncachedRegions) {

            var category = categories[0];
            var categoriesName = "";
            for (var j = 0; j < categories.length; j++) {
                categoriesName += "," + categories[j];
            }
            categoriesName = categoriesName.slice(1);   // to remove first ','

            var chunks = cachedChunks[category];
            // TODO check how to manage multiple regions
            var queriesList = _this._groupQueries(uncachedRegions[category]);

            /** Uncached regions found **/
            if (queriesList.length > 0) {
                args.webServiceCallCount = 0;
                for (var i = 0; i < queriesList.length; i++) {
                    args.webServiceCallCount++;
                    var queryRegion = queriesList[i];

                    // Get CellBase data
                    CellBaseManager.get({
                        host: _this.host,
                        version: _this.version,
                        species: _this.species,
                        category: _this.category,
                        subCategory: _this.subCategory,
                        query: queryRegion.toString(),
                        resource: _this.resource,
                        params: params,
                        success: function(response) {
                            var responseChunks = _this._cellbaseSuccess(response, categories, dataType, chunkSize);
                            args.webServiceCallCount--;

                            chunks = chunks.concat(responseChunks);
                            if (args.webServiceCallCount === 0) {
                                chunks.sort(function(a, b) {
                                    return a.chunkKey.localeCompare(b.chunkKey)
                                });
                                args.done({
                                    items: chunks, dataType: dataType, chunkSize: chunkSize, sender: _this
                                });
                            }
                        },
                        error: function() {
                            console.log('Server error');
                            args.done();
                        }
                    });
                }
            } else
            /** All regions are cached **/
            {
                args.done({
                    items: chunks, dataType: dataType, chunkSize: chunkSize, sender: _this
                });
            }
        });
    },

    _cellbaseSuccess: function(data, categories, dataType, chunkSize) {
        var timeId = Utils.randomString(4) + this.resource + " save";
        console.time(timeId);
        /** time log **/

        var regions = [];
        var chunks = [];
        for (var i = 0; i < data.response.length; i++) {    // TODO test what do several responses mean
            var queryResult = data.response[i];
            if (dataType == "histogram") {
                for (var j = 0; j < queryResult.result.length; j++) {
                    var interval = queryResult.result[j];
                    var region = new Region(interval);
                    regions.push(region);
                    chunks.push(interval);
                }
            } else {
                regions.push(new Region(queryResult.id));
                chunks.push(queryResult.result);
            }
        }
        var items = this.cache.putByRegions(regions, chunks, categories, dataType, chunkSize);

        /** time log **/
        console.timeEnd(timeId);

        return items;
    },

    /**
     * Transform the list on a list of lists, to limit the queries
     * [ r1,r2,r3,r4,r5,r6,r7,r8 ]
     * [ [r1,r2,r3,r4], [r5,r6,r7,r8] ]
     */
    _groupQueries: function(uncachedRegions) {
        var groupSize = 50;
        var queriesLists = [];
        while (uncachedRegions.length > 0) {
            queriesLists.push(uncachedRegions.splice(0, groupSize).toString());
        }
        return queriesLists;
    },


};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function DasAdapter(args){

    var _this=this;

    _.extend(this, Backbone.Events);

    this.id = Utils.genId('DasAdapter');

	this.gzip = true;
	this.proxy = CELLBASE_HOST+"/latest/utils/proxy?url=";
	this.url;
	this.species;
	this.featureCache;
	this.params = {};

    _.extend(this, args);
    
    this.on(this.handlers);

	this.featureCache =  new FeatureCache(this.featureCache);
};

DasAdapter.prototype.getData = function(args){
//	console.time("all");
	var _this = this;
	//region check
	
	this.params["histogram"] = args.histogram;
	this.params["interval"] = args.interval;
	this.params["transcript"] = args.transcript;
	
	if(args.start<1){
		args.start=1;
	}
	if(args.end>300000000){
		args.end=300000000;
	}
	
	var dataType = "data";
	if(args.histogram){
		dataType = "histogram"+args.interval;
	}

	this.params["dataType"] = dataType;
	
	var firstChunk = this.featureCache._getChunk(args.start);
	var lastChunk = this.featureCache._getChunk(args.end);

	var chunks = [];
	var itemList = [];
	for(var i=firstChunk; i<=lastChunk; i++){
		var key = args.chromosome+":"+i;
		if(this.featureCache.cache[key] == null || this.featureCache.cache[key][dataType] == null) {
			chunks.push(i);
		}else{
			var item = this.featureCache.getFeatureChunk(key);
//			console.time("concat");
			itemList.push(item);
//			console.timeEnd("concat");
		}
	}
//	//notify all chunks
	if(itemList.length>0){
		this.trigger('data:ready',{items:itemList, params:this.params, cached:true});
	}
	
	
	//data process
	var updateStart = true;
	var updateEnd = true;
	if(chunks.length > 0){
//		console.log(chunks);
		
		for ( var i = 0; i < chunks.length; i++) {
			var query = null;
			
			if(updateStart){
				var chunkStart = parseInt(chunks[i] * this.featureCache.chunkSize);
				updateStart = false;
			}
			if(updateEnd){
				var chunkEnd = parseInt((chunks[i] * this.featureCache.chunkSize) + this.featureCache.chunkSize-1);
				updateEnd = false;
			}
			
			if(chunks[i+1]!=null){
				if(chunks[i]+1==chunks[i+1]){
					updateEnd =true;
				}else{
					query = args.chromosome+":"+chunkStart+","+chunkEnd;
					updateStart = true;
					updateEnd = true;
				}
			}else{
				query = args.chromosome+":"+chunkStart+","+chunkEnd;
				updateStart = true;
				updateEnd = true;
			}

			if(query){
				var fullURL = this.proxy + this.url + "?segment=" + query;
				console.log("fullURL: "+fullURL);

				$.ajax({
					url: fullURL,
					type: 'GET',
					dataType:"xml",
					error: function(){
						alert("error");
						_this.trigger('error',"It is not allowed by Access-Control-Allow-Origin " );
					},

					success: function(data){
						_this.xml =   (new XMLSerializer()).serializeToString(data);
						var xmlStringified =  (new XMLSerializer()).serializeToString(data); //data.childNodes[2].nodeValue;
						var data = xml2json.parser(xmlStringified);

						if(data.dasgff != null){//Some times DAS server does not respond
							var result = new Array();
								
							if (typeof(data.dasgff.gff.segment)  != 'undefined'){
								if (typeof(data.dasgff.gff.segment.feature)  != 'undefined'){	  
									result = data.dasgff.gff.segment.feature;	
								}
								else if (typeof(data.dasgff.gff.segment[0])  != 'undefined'){
									if (data.dasgff.gff.segment[0].feature != null){
										for ( var i = 0; i < data.dasgff.gff.segment.length; i++) {
											for ( var j = 0; j < data.dasgff.gff.segment[i].feature.length; j++) {
												data.dasgff.gff.segment[i].feature[j]["chromosome"] = args.chromosome;
												result.push(data.dasgff.gff.segment[i].feature[j]);
											}
										}
									}
									else{
										result.push([]);
									}
								}
							}
							var region = {chromosome:args.chromosome, start:chunkStart, end:chunkEnd};
							var resource = "das";
							_this.featureCache.putFeaturesByRegion(result, region, resource, dataType);
							console.log(_this.featureCache.cache);
							var items = _this.featureCache.getFeatureChunksByRegion(region);
							if(items != null){
								_this.trigger('data:ready',{items:items, params:_this.params, cached:false});
							}
						}
					}
				});
			}
		}
	}
};

DasAdapter.prototype.checkUrl = function(){
	var _this = this;
	var fullURL = this.proxy + this.url + "?segment=1:1,1";
	console.log("Checking URL: "+fullURL);

	$.ajax({
		url: fullURL,
		type: 'GET',
		dataType:"xml",
		error: function(){
			alert("error");
			_this.trigger('error',"It is not allowed by Access-Control-Allow-Origin " );
		},
		success: function(data){
			_this.xml = (new XMLSerializer()).serializeToString(data);
			_this.trigger('url:check',{data:_this.xml});
		}
	});
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function EnsemblAdapter(args) {

    _.extend(this, Backbone.Events);

    _.extend(this, args);

    this.on(this.handlers);

    this.cache = new FeatureChunkCache(this.cacheConfig);
}

EnsemblAdapter.prototype = {

    getData: function (args) {
        var _this = this;
        args.webServiceCallCount = 0;

        var params = {};
//                    histogram: (dataType == 'histogram')
        _.extend(params, this.params);
        _.extend(params, args.params);

        /** 1 region check **/
        var region = args.region;
        if (region.start > 300000000 || region.end < 1) {
            return;
        }
        region.start = (region.start < 1) ? 1 : region.start;
        region.end = (region.end > 300000000) ? 300000000 : region.end;

        /** 3 dataType check **/
        var dataType = args.dataType;
        if (_.isUndefined(dataType)) {
            console.log("dataType must be provided!!!");
        }

        /** 2 category check **/
        var categories = [dataType];

        /** 4 chunkSize check **/
        var chunkSize = args.params.interval? args.params.interval : this.cacheConfig.chunkSize; // this.cache.defaultChunkSize should be the same
        if (this.debug) {
            console.log(chunkSize);
        }

        /**
         * Get the uncached regions (uncachedRegions) and cached chunks (cachedChunks).
         * Uncached regions will be used to query cellbase. The response data will be converted in chunks
         * by the Cache TODO????
         * Cached chunks will be returned by the args.dataReady Callback.
         */
        this.cache.get(region, categories, dataType, chunkSize, function (cachedChunks, uncachedRegions) {

            if (uncachedRegions.length > 0) {
                var queryRegionStrings = uncachedRegions;
                for (var i = 0; i < queryRegionStrings.length; i++) {
                    args.webServiceCallCount++;
                    _this._get(queryRegionStrings[i], params, categories, chunkSize, args);
                }
            }
            // Get chunks from cache
            if (cachedChunks.length > 0) {
                if (args.webServiceCallCount === 0) {
                    args.done();
                }
                _this.trigger('data:ready', {items: cachedChunks[categories[0]], dataType: dataType, chunkSize: chunkSize, sender: _this});
            }
        });
    },

    _get: function (query, params, categories, chunkSize, args) {
        var _this = this;
        EnsemblManager.get({
            host: _this.host,
            species: _this.species,
            category: _this.category,
            subCategory: _this.subCategory,
            query: query,
            params: params,
            success: function (data) {
                var transformedData = _this._transformResponse(data, query);
                _this._success(transformedData, categories, undefined, chunkSize, args);
            }
        });
    },

    _success: function (data, categories, dataType, chunkSize, args) {
        args.webServiceCallCount--;
        var timeId = Utils.randomString(4) + this.resource + " save";
        console.time(timeId);
        /** time log **/

        var regions = [];
        var chunks = [];
        for (var i = 0; i < data.response.length; i++) {
            var queryResult = data.response[i];
            regions.push(new Region(queryResult.id));
            chunks.push(queryResult.result);
        }
        var items = this.cache.putByRegions(regions, chunks, categories, dataType, chunkSize);

        /** time log **/
        console.timeEnd(timeId);

        if (args.webServiceCallCount === 0) {
            args.done();
        }

        if (items.length > 0) {
            this.trigger('data:ready', {items: items, dataType: dataType, chunkSize: chunkSize, sender: _this});
        }
    },

    _transformResponse: function (data, query) {
//        id: "ENSG00000189167"
//        source: "Ensembl"
//        name: "ZAR1L"
//        biotype: "protein_coding"
//        status: "KNOWN"
//        chromosome: "13"
//        start: 32877837
//        end: 32889481
//        strand: "-"
//        description: "zygote arrest 1-like [Source:HGNC Symbol;Acc:37116]"


//        ID: "ENSG00000073910"
//        source: "ensembl"
//        external_name: "FRY"
//        logic_name: "ensembl_havana_gene"
//        feature_type: "gene"
//        description: "furry homolog (Drosophila) [Source:HGNC Symbol;Acc:20367]"
//        biotype: "protein_coding"
//        end: 32870794
//        seq_region_name: "13"
//        strand: 1
//        start: 32605437

        for (var i = 0; i < data.length; i++) {
            var f = data[i];
            f.id = f.ID;
            delete f.ID;
            f.name = f.external_name;
            delete f.external_name;
            f.chromosome = f.seq_region_name;
            delete f.seq_region_name;
        }

        var r = {
            response: []
        };
        var result = {
            id: query,
            result: data
        };
        r.response.push(result);
        return  r;
    }
};


/*
 * Copyright (c) 2015 Francisco Salavert (DCG-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

/**
 * ** Generic adapter to any uri

 new FeatureTemplateAdapter({
    uriTemplate: 'http://host/webserver/{customVar}/{species}/{region}',
    templateVariables: {
        customVar: 'info',
    },
    species: genomeViewer.species,
    parse: function (response) {
        var itemsArray = [];
        for (var i = 0; i < response.response.length; i++) {
            var r = response.response[i];
            itemsArray.push(r.result);
        }
        return itemsArray;
    }
 })

 * ** templateVariables is used for custom variables in the uri. region and species will be ignored
 * ** as will be configured automatically

 * ** The species config is the current species should not appear in templateVariables
 * ** The region in the uriTemplate is provided by the track so should not appear in templateVariables
 * ** The parse function is used to adapt de features from the response

 */

function FeatureTemplateAdapter(args) {

    _.extend(this, Backbone.Events);

    this.templateVariables = {};
    this.multiRegions = true;
    this.histogramMultiRegions = true;
    this.chromosomeSizes;

    _.extend(this, args);

    this.configureCache();

    this.debug = false;
}

FeatureTemplateAdapter.prototype = {
    setSpecies: function (species) {
        this.species = species;
        this.configureCache();
    },
    setHost: function (host) {
        this.configureCache();
        this.host = host;
    },
    deleteCache:function(){
        this.cache.delete();
    },
    configureCache: function () {
        var speciesString = '';
        if (this.species != null) {
            var speciesString = this.species.id + this.species.assembly.name.replace(/[/_().\ -]/g, '');
        }
        var cacheId = this.uriTemplate + speciesString;
        if (!this.cacheConfig) {
            this.cacheConfig = {
                //    //subCacheId: this.resource + this.params.keys(),
                chunkSize: 3000
            }
        }
        this.cacheConfig.cacheId = cacheId;
        this.cache = new FeatureChunkCache(this.cacheConfig);
    },

    getData: function (args) {
        var _this = this;

        var params = {};
        //histogram: (dataType == 'histogram')
        _.extend(params, this.params);
        _.extend(params, args.params);

        /** 1 region check **/
        var region = args.region;
        var limitedRegion = this._computeLimitedRegion(region.chromosome);
        if (region.start > limitedRegion || region.end < 1) {
            return;
        }
        region.start = (region.start < 1) ? 1 : region.start;
        region.end = (region.end > limitedRegion) ? limitedRegion : region.end;

        /** 2 category check **/
        var categories = ["cat_" + Utils.queryString(this.templateVariables) + Utils.queryString(params)];

        /** 3 dataType check **/
        var dataType = args.dataType;
        if (_.isUndefined(dataType)) {
            console.log("dataType must be provided!!!");
        }

        /** 4 chunkSize check **/
        var chunkSize = params.interval ? params.interval : this.cacheConfig.chunkSize; // this.cache.defaultChunkSize should be the same
        if (this.debug) {
            console.log(chunkSize);
        }

        /**
         * Get the uncached regions (uncachedRegions) and cached chunks (cachedChunks).
         * Uncached regions will be used to query cellbase. The response data will be converted in chunks
         * by the Cache TODO????
         * Cached chunks will be returned by the args.dataReady Callback.
         */
        this.cache.get(region, categories, dataType, chunkSize, function (cachedChunks, uncachedRegions) {

            var category = categories[0];
            var categoriesName = "";
            for (var j = 0; j < categories.length; j++) {
                categoriesName += "," + categories[j];
            }
            categoriesName = categoriesName.slice(1); // to remove first ','

            var chunks = cachedChunks[category];
            // TODO check how to manage multiple regions

            var queriesList;
            if (dataType !== 'histogram') {
                if (_this.multiRegions === false) {
                    queriesList = _this._singleQueries(uncachedRegions[category]);
                } else {
                    queriesList = _this._groupQueries(uncachedRegions[category]);
                }
            } else {
                if (_this.histogramMultiRegions === false) {
                    queriesList = _this._singleQueries(uncachedRegions[category]);
                } else {
                    queriesList = _this._groupQueries(uncachedRegions[category]);
                }
            }

            /** Uncached regions found **/
            if (queriesList.length > 0) {
                args.webServiceCallCount = 0;
                for (var i = 0; i < queriesList.length; i++) {
                    args.webServiceCallCount++;
                    var queryRegion = queriesList[i];

                    var request = new XMLHttpRequest();

                    /** Temporal fix save queried region **/
                    request._queryRegion = queryRegion;
                    request._originalRegion = region;

                    request.onload = function () {
                        args.webServiceCallCount--;
                        if (request.status !== 400 && request.status !== 500) {
                            var response;
                            try {
                                response = JSON.parse(this.response);
                            } catch (e) {
                                console.log('Warning: Response is not JSON');
                                response = this.response;
                            }

                            /** Process response **/
                            var responseChunks = _this._success(response, categories, dataType, this._queryRegion, this._originalRegion, chunkSize);
                            chunks = chunks.concat(responseChunks);
                        } else {
                            console.log("request.status: " + request.status);
                        }
                        if (args.webServiceCallCount === 0) {
                            chunks.sort(function (a, b) {
                                return a.chunkKey.localeCompare(b.chunkKey)
                            });
                            args.done({
                                items: chunks,
                                dataType: dataType,
                                chunkSize: chunkSize,
                                sender: _this
                            });
                        }
                    };
                    request.onerror = function () {
                        console.log('Server error');
                        args.done();
                    };
                    var uriTemplate = new URITemplate(_this.uriTemplate);
                    _this.templateVariables['region'] = queryRegion.toString();
                    _this.templateVariables['species'] = _this._getSpeciesQueryString(_this.species);

                    var url = uriTemplate.expand(_this.templateVariables);
                    url = Utils.addQueryParamtersToUrl(params, url);
                    request.open('GET', url, true);
                    console.log(url);
                    request.send();

                }
            } else
            /** All regions are cached **/
            {
                args.done({
                    items: chunks,
                    dataType: dataType,
                    chunkSize: chunkSize,
                    sender: _this
                });
            }
        });
    },

    _success: function (response, categories, dataType, queryRegion, originalRegion, chunkSize) {
        //var timeId = Utils.randomString(4) + this.resource + " save";
        //console.time(timeId);
        /** time log **/

        var regions = [];
        var chunks = [];
        if (dataType !== 'histogram') {
            if (typeof this.parse === 'function') {
                chunks = this.parse(response, dataType);
            } else {
                chunks = response;
            }
            regions = this._getRegionsFromQueryRegions(queryRegion);
        } else {
            if (typeof this.parseHistogram === 'function') {
                chunks = this.parseHistogram(response);
            } else {
                chunks = response;
            }
            regions = this._getRegionsFromHistogramChunks(chunks, originalRegion.chromosome);
        }

        var items = this.cache.putByRegions(regions, chunks, categories, dataType, chunkSize);

        /** time log **/
        //console.timeEnd(timeId);

        return items;
    },

    /**
     * Transform the list on a list of lists, to limit the queries
     * [ r1,r2,r3,r4,r5,r6,r7,r8 ]
     * [ [r1,r2,r3,r4], [r5,r6,r7,r8] ]
     */
    _groupQueries: function (uncachedRegions) {
        // modify region end to chromosome length.
        for (var i = 0; i < uncachedRegions.length; i++) {
            var r = uncachedRegions[i];
            this._computeRegionSize(r);
        }

        var groupSize = 50;
        var queriesLists = [];
        while (uncachedRegions.length > 0) {
            queriesLists.push(uncachedRegions.splice(0, groupSize).toString());
        }
        return queriesLists;
    },
    _singleQueries: function (uncachedRegions) {
        // modify region end to chromosome length.
        for (var i = 0; i < uncachedRegions.length; i++) {
            var r = uncachedRegions[i];
            this._computeRegionSize(r);
        }

        var queriesLists = [];
        for (var i = 0; i < uncachedRegions.length; i++) {
            var region = uncachedRegions[i];
            queriesLists.push(region.toString());
        }
        return queriesLists;
    },

    _getSpeciesQueryString: function (species) {
        if (species == null) {
            return '';
        }
        if (this.speciesParse != null) {
            return this.speciesParse(species);
        } else {
            return Utils.getSpeciesCode(species.scientificName)
        }
    },

    _getRegionsFromQueryRegions: function (queryRegion) {
        var regions = [];
        var regionSplit = queryRegion.split(',');
        for (var i = 0; i < regionSplit.length; i++) {
            var regionStr = regionSplit[i];
            regions.push(new Region(regionStr));
        }
        return regions;
    },

    _getRegionsFromHistogramChunks: function (intervals, chromosome) {
        var regions = [];
        for (var i = 0; i < intervals.length; i++) {
            var interval = intervals[i];
            var region = new Region(interval);
            region.chromosome = chromosome;
            regions.push(region);
        }
        return regions;
    },

    _computeLimitedRegion: function (chromosome) {
        var regionLimit = 300000000;

        if (this.species != null && this.species.chromosomes[chromosome] != null) {
            regionLimit = this.species.chromosomes[chromosome].end;
        }

        if (this.chromosomeSizes != null &&
            this.chromosomeSizes[chromosome] != null &&
            !isNaN(this.chromosomeSizes[chromosome])
        ) {
            regionLimit = this.chromosomeSizes[chromosome];
        }

        return regionLimit;
    },
    _computeRegionSize: function (region) {
        var limitedRegion = this._computeLimitedRegion(region.chromosome);
        if (region.end > limitedRegion) {
            region.end = limitedRegion;
        }
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

GFF2DataAdapter.prototype.getData = FeatureDataAdapter.prototype.getData;
GFF2DataAdapter.prototype._fetchData = FeatureDataAdapter.prototype._fetchData;

function GFF2DataAdapter(dataSource, args){
	FeatureDataAdapter.prototype.constructor.call(this, dataSource, args);
	var _this = this;
	
	this.async = true;
	
	//stat atributes
	this.featuresCount = 0;
	this.featuresByChromosome = {};

	if (args != null){
		if(args.async != null){
			this.async = args.async;
		}
	}
};

GFF2DataAdapter.prototype.parse = function(data, region){
	var _this = this;
	var dataType = "value";
	var lines = data.split("\n");
//	console.log("creating objects");
	for (var i = 0; i < lines.length; i++){
		var line = lines[i].replace(/^\s+|\s+$/g,"");
		if ((line != null)&&(line.length > 0)){
			var fields = line.split("\t");
			var chromosome = fields[0].replace("chr", "");
			if(chromosome == region.chromosome){// load only one chromosome on the cache

				//NAME  SOURCE  TYPE  START  END  SCORE  STRAND  FRAME  GROUP
				var feature = {
						"chromosome": chromosome, 
						"label": fields[2], 
						"start": parseInt(fields[3]), 
						"end": parseInt(fields[4]), 
						"score": fields[5],
						"strand": fields[6], 
						"frame": fields[7],
						"group": fields[8],
						"featureType":	"gff2"
				} ;

				this.featureCache.putFeatures(feature, dataType);
				
				if (this.featuresByChromosome[chromosome] == null){
					this.featuresByChromosome[chromosome] = 0;
				}
				this.featuresByChromosome[chromosome]++;
				this.featuresCount++;
			}
		}
	}
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

GFF3DataAdapter.prototype.getData = FeatureDataAdapter.prototype.getData;
GFF3DataAdapter.prototype._fetchData = FeatureDataAdapter.prototype._fetchData;

function GFF3DataAdapter(dataSource, args){
	FeatureDataAdapter.prototype.constructor.call(this, dataSource, args);
	var _this = this;
	
	this.async = true;

	//stat atributes
	this.featuresCount = 0;
	this.featuresByChromosome = {};

	if (args != null){
		if(args.async != null){
			this.async = args.async;
		}
	}
};

GFF3DataAdapter.prototype.parse = function(data, region){
	var _this = this;
	
	//parse attributes column
	var getAttr = function(column){
		var obj = {};
        if(typeof column !== 'undefined'){
            var arr = column.replace(/ /g,'').split(";");
            for (var i = 0, li = arr.length; i<li ; i++){
                var item = arr[i].split("=");
                obj[item[0]] = item[1];
            }
        }
		return obj;
	};
	var dataType = "value";
	var lines = data.split("\n");
//	console.log("creating objects");
	for (var i = 0; i < lines.length; i++){
		var line = lines[i].replace(/^\s+|\s+$/g,"");
		if ((line != null)&&(line.length > 0)){
			var fields = line.split("\t");
			var chromosome = fields[0].replace("chr", "");
			if(chromosome == region.chromosome){// load only one chromosome on the cache

				//NAME  SOURCE  TYPE  START  END  SCORE  STRAND  FRAME  GROUP
				var feature = {
						"chromosome": chromosome, 
						"label": fields[2], 
						"start": parseInt(fields[3]), 
						"end": parseInt(fields[4]), 
						"score": fields[5],
						"strand": fields[6], 
						"frame": fields[7],
						"attributes": getAttr(fields[8]),
						"featureType":	"gff3"
				} ;

				this.featureCache.putFeatures(feature, dataType);
				if (this.featuresByChromosome[chromosome] == null){
					this.featuresByChromosome[chromosome] = 0;
				}
				this.featuresByChromosome[chromosome]++;
				this.featuresCount++;

			}
		}
	}
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

GTFDataAdapter.prototype.getData = FeatureDataAdapter.prototype.getData;
GTFDataAdapter.prototype._fetchData = FeatureDataAdapter.prototype._fetchData;

function GTFDataAdapter(dataSource, args){
	FeatureDataAdapter.prototype.constructor.call(this, dataSource, args);
	var _this = this;
	
	this.async = true;
	
	//stat atributes
	this.featuresCount = 0;
	this.featuresByChromosome = {};

	if (args != null){
		if(args.async != null){
			this.async = args.async;
		}
	}
};

GTFDataAdapter.prototype.parse = function(data, region){
	var _this = this;
	
	//parse attributes column
	var getAttr = function(column){
		var arr = column.split(";");
		var obj = {};
		for (var i = 0, li = arr.length; i<li ; i++){
			var item = arr[i].split("=");
			obj[item[0]] = item[1];
		}
		return obj;
	};
	
	var dataType = "value";
	var lines = data.split("\n");
//	console.log("creating objects");
	for (var i = 0; i < lines.length; i++){
		var line = lines[i].replace(/^\s+|\s+$/g,"");
		if ((line != null)&&(line.length > 0)){
			var fields = line.split("\t");
			var chromosome = fields[0].replace("chr", "");
			if(chromosome == region.chromosome){// load only one chromosome on the cache
			
				//NAME  SOURCE  TYPE  START  END  SCORE  STRAND  FRAME  GROUP
				var feature = {
						"chromosome": chromosome, 
						"label": fields[2], 
						"start": parseInt(fields[3]), 
						"end": parseInt(fields[4]), 
						"score": fields[5],
						"strand": fields[6], 
						"frame": fields[7],
						"attributes": getAttr(fields[8]),
						"featureType":	"gtf"
				} ;

				this.featureCache.putFeatures(feature, dataType);
				if (this.featuresByChromosome[chromosome] == null){
					this.featuresByChromosome[chromosome] = 0;
				}
				this.featuresByChromosome[chromosome]++;
				this.featuresCount++;
			}
		}
	}
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function OpencgaAdapter(args) {

    _.extend(this, Backbone.Events);

    _.extend(this, args);

    this.on(this.handlers);

    this.configureCache();

    this.debug = false;
}

OpencgaAdapter.prototype = {
    setSpecies: function (species) {
        this.species = species;
    },
    configureCache: function () {
        var host = this.host || OpencgaManager.host;
        if (!this.cacheConfig) {
            this.cacheConfig = {
                // subCacheId: this.resource + this.params.keys(),
                chunkSize: 3000
            }
        }
        this.cacheConfig.cacheId = 'opencga' + this.resource.id;
        this.cache = new FeatureChunkCache(this.cacheConfig);
    },

    getData: function (args) {
        var _this = this;

        var params = {};
//                    histogram: (dataType == 'histogram')
        _.extend(params, this.params);
        _.extend(params, args.params);

        /** 1 region check **/
        var region = args.region;
        if (region.start > 300000000 || region.end < 1) {
            return;
        }
        region.start = (region.start < 1) ? 1 : region.start;
        region.end = (region.end > 300000000) ? 300000000 : region.end;


        /** 2 category check **/
        var categories = this.resource.id.toString().split(',');   // in this adapter each category is each file

        /** 3 dataType check **/
        var dataType = args.dataType;
        if (_.isUndefined(dataType)) {
            console.log("dataType must be provided!!!");
        }

        /** 4 chunkSize check **/
        var chunkSize = params.interval ? params.interval : this.cacheConfig.chunkSize; // this.cache.defaultChunkSize should be the same
        if (this.debug) {
            console.log(chunkSize);
        }

        /**
         * Get the uncached regions (uncachedRegions) and cached chunks (cachedChunks).
         * Uncached regions will be used to query OpenCGA. The response data will be converted in chunks
         * by the Cache TODO????
         * Cached chunks will be returned by the args.dataReady Callback.
         */
        this.cache.get(region, categories, dataType, chunkSize, function (cachedChunks, uncachedRegions) {

            var category = categories[0];
            var categoriesName = "";
            for (var j = 0; j < categories.length; j++) {
                categoriesName += "," + categories[j];
            }
            categoriesName = categoriesName.slice(1);   // to remove first ','

            var chunks = cachedChunks[category];
            // TODO check if OpenCGA allows multiple regions
            var queriesList = _this._groupQueries(uncachedRegions[category]);

            /** Uncached regions found **/
            if (queriesList.length > 0) {
                args.webServiceCallCount = 0;

                // TODO check how to manage multiple regions and multiple files ids
                for (var i = 0; i < queriesList.length; i++) {
                    args.webServiceCallCount++;
                    var queryRegion = queriesList[i];

                    params['region'] = queryRegion.toString();
                    params['interval'] = chunkSize;
                    params['histogram'] = (dataType == 'histogram');
                    params['process_differences'] = false;

                    OpencgaManager.files['fetch']({
                        id: categoriesName,
                        query: params,
                        request: {
                            success: function (response) {
                                var responseChunks = _this._opencgaSuccess(response, categories, dataType, chunkSize, args);
                                args.webServiceCallCount--;

                                chunks = chunks.concat(responseChunks);
                                if (args.webServiceCallCount === 0) {
                                    args.done({
                                        items: chunks, dataType: dataType, chunkSize: chunkSize, sender: _this
                                    });
                                }
                            },
                            error: function () {
                                console.log('Server error');
                                args.done();
                            }
                        }
                    });
                }

            }
            /** All regions are cached **/
            else {
                args.done({
                    items: chunks, dataType: dataType, chunkSize: chunkSize, sender: _this
                });
            }
        });
    },

    _opencgaSuccess: function (data, categories, dataType, chunkSize) {
        var timeId = this.cacheConfig.cacheId + " save " + data.response.length + " samples";
        console.time(timeId);
        /** time log **/

        if (categories.length != data.response.length) {
            console.log("ERROR: requested " + categories.length + "samples, but response has " + data.response.length);
            console.log(data);
//            debugger;
        }

        if (data.response[0] && data.response[0].result[0]) {
            var inferredChunkSize = data.response[0].result[0].end - data.response[0].result[0].start + 1;
            if (inferredChunkSize != chunkSize) {
                console.log("code smell: chunkSize requested: " + chunkSize + ", but obtained: " + inferredChunkSize);
//                chunkSize = inferredChunkSize;
            }
        }

        var responseItems = [];
        for (var i = 0; i < data.response.length; i++) {    // FIXME each response is a sample? in variant too?
            var queryResult = data.response[i];
            var items = this._adaptChunks(queryResult, categories[i], dataType, chunkSize);
            responseItems = responseItems.concat(items);
            //if (items.length > 0) {
            //    // if (data.encoded) {decrypt }
            //    args.dataReady({items: items, dataType: dataType, chunkSize: chunkSize, sender: this, category: categories[i]});
            //}
            //var decryptedChunks = this._decryptChunks(items, "mypassword");
        }

        /** time log **/
        console.timeEnd(timeId);

        return responseItems;

    },

    /**
     * Transform the list on a list of lists, to limit the queries
     * [ r1,r2,r3,r4,r5,r6,r7,r8 ]
     * [ [r1,r2,r3,r4], [r5,r6,r7,r8] ]
     */
    _groupQueries: function (uncachedRegions) {
        var groupSize = 50;
        var queriesLists = [];
        while (uncachedRegions.length > 0) {
            queriesLists.push(uncachedRegions.splice(0, groupSize).toString());
        }
        return queriesLists;
    },

    _decryptChunks: function (chunks, password) {
        var decryptedChunks = [];
        for (var i = 0; i < chunks.length; i++) {
            if (chunks[i].enc == true) {
                decryptedChunks.push(CryptoJS.AES.decrypt(chunks[i], password));
            } else {
                decryptedChunks.push(chunks[i]);
            }
        }
        return decryptedChunks;
    },

    _adaptChunks: function (queryResult, category, dataType, chunkSize) {
        var chunks;
        var regions;
        var items = [];
//        debugger
        if (queryResult.resultType == "org.opencb.biodata.models.variant.Variant") {
            chunks = [];
            regions = [];
            var keyToPair = {};
            for (var i = 0; i < queryResult.result.length; i++) {
                var variation = queryResult.result[i];
                var chunkId = this.cache.getChunkId(variation.start, chunkSize);
                var key = this.cache.getChunkKey(variation.chromosome,
                    chunkId,
                    dataType,
                    chunkSize);

                if (keyToPair[key] == undefined) {
                    keyToPair[key] = chunks.length;
                    regions.push(new Region({chromosome: variation.chromosome, start: chunkId * chunkSize, end: (chunkId + 1) * chunkSize - 1}));
                    chunks.push([]);
                }
                chunks[keyToPair[key]].push(variation);
            }

//            debugger
            items = this.cache.putByRegions(regions, chunks, category, dataType, chunkSize);
        } else { //if(queryResult.resultType == "org.opencb.biodata.models.alignment.AlignmentRegion") {
            regions = [];
            for (var j = 0; j < queryResult.result.length; j++) {
                regions.push(new Region(queryResult.result[j]));
            }
            chunks = queryResult.result;

//            if (data.response[i].result.length == 1) {
//            } else {
//                console.log("unexpected data structure");
//            }
            items = this.cache.putByRegions(regions, chunks, category, dataType, chunkSize);
        }
        return items;
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

VCFDataAdapter.prototype.getData = FeatureDataAdapter.prototype.getData;
VCFDataAdapter.prototype._fetchData = FeatureDataAdapter.prototype._fetchData;

function VCFDataAdapter(dataSource, args) {
    FeatureDataAdapter.prototype.constructor.call(this, dataSource, args);
    var _this = this;

    this.async = true;
    //stat atributes
    this.featuresCount = 0;
    this.featuresByChromosome = {};

    this.header = "";
    this.samples = [];

    if (args != null) {
        if (args.async != null) {
            this.async = args.async;
        }
    }
}

VCFDataAdapter.prototype.parse = function (data, region) {
//	console.log(data);
    var _this = this;
    var dataType = "value";
    var lines = data.split("\n");
//    debugger
//	console.log("creating objects");
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].replace(/^\s+|\s+$/g, "");
        if ((line != null) && (line.length > 0)) {

            var fields = line.split("\t");

            if (line.substr(0, 1) === "#") {
                if (line.substr(1, 1) === "#") {
                    this.header += line.replace(/</gi, "&#60;").replace(/>/gi, "&#62;") + "<br>";
                } else {
                    this.samples = fields.slice(9);
                }
            } else {

                var chrom = fields[0].replace(/chr/gi, "");
                if (chrom == region.chromosome) {// load only one chromosome on the cache

                    //				_this.addQualityControl(fields[5]);

                    var samples = [];
                    if(fields[9]){
                        samples = fields.slice(9);
                    }

                    var feature = {
                        "chromosome": chrom,
                        "position": parseInt(fields[1]),
                        "start": parseInt(fields[1]),//added
                        "end": parseInt(fields[1]),//added
                        "id": fields[2],
                        "reference": fields[3],
                        "alternate": fields[4],
                        "quality": fields[5],
                        "filter": fields[6],
                        "info": fields[7].replace(/;/gi, "<br>"),
                        "format": fields[8],
                        "sampleData": line,
                        "samples": samples,
                        //						"record":		fields,
                        //						"label": 		fields[2] + " " +fields[3] + "/" + fields[4] + " Q:" + fields[5],
                        "featureType": "vcf"
                    };

                    this.featureCache.putFeatures(feature, dataType);

                    if (this.featuresByChromosome[chrom] == null) {
                        this.featuresByChromosome[chrom] = 0;
                    }
                    this.featuresByChromosome[chrom]++;
                    this.featuresCount++;
                }
            }
        }
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function AttributeNetworkDataAdapter(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    this.dataSource;
    this.async = true;
    this.ignoreColumns = {};
    this.renameColumns = {};

    this.useFirstLineAsColumnNames = false;

    //set instantiation args, must be last
    _.extend(this, args);


    this.attributes = [];
    this.columns = [];

    this.on(this.handlers);

    if (this.async) {
        this.dataSource.on('success', function (data) {
            _this.parse(data);
        });
        this.dataSource.fetch(this.async);
    } else {
        var data = this.dataSource.fetch(this.async);
        _this.parse(data);
    }


};

AttributeNetworkDataAdapter.prototype.parse = function (data) {
    var _this = this;

//    var lines = data.split("\n");
//    if (lines.length > 2) {
//        var types = lines[0].substring(1).replace(/^\s+|\s+$/g, "").split("\t");
//        var defVal = lines[1].substring(1).replace(/^\s+|\s+$/g, "").split("\t");
//        var headers = lines[2].substring(1).replace(/^\s+|\s+$/g, "").split("\t");
//
//        for (var i = 0; i < headers.length; i++) {
//            this.attributes.push({
//                "name": headers[i],
//                "type": types[i],
//                "defaultValue": defVal[i]
//            });
//        }
//    }
//
//    for (var i = 3; i < lines.length; i++) {
//        var line = lines[i].replace(/^\s+|\s+$/g, "");
//        if ((line != null) && (line.length > 0)) {
//            var fields = line.split("\t");
//            if (fields[0].substr(0, 1) != "#") {
//                this.data.push(fields);
//            }
//        }
//    }

    try {
        data = data.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
        var lines = data.split(/\n/);


        var firstLine = lines[0].trim();
        var columnNames = [];
        if (firstLine.substr(0, 1) === "#") {
            columnNames = firstLine.split(/\t/);

            //search for first non header line "#"
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (line.substr(0, 1) !== "#") {
                    firstLine = line;
                    break;
                }
            }

        }
        if (this.useFirstLineAsColumnNames) {
            columnNames = firstLine.split(/\t/);
            //first non header line
            firstLine = lines[1];

        }

        var finalColumnNames = [];
        var numColumns = firstLine.split(/\t/).length;
        for (var i = 0; i < numColumns; i++) {

            if (this.renameColumns[i]) {
                finalColumnNames[i] = this.renameColumns[i];
            } else {
                if (columnNames[i]) {
                    finalColumnNames[i] = columnNames[i];
                } else {
                    finalColumnNames[i] = "Column" + i;
                }
            }

            if (i == 0) {
                finalColumnNames[i] = "id";
            }
            if (this.ignoreColumns[i] !== true) {
                var column = {
                    name: finalColumnNames[i].toString(),
                    title: finalColumnNames[i].toString(),
                    type: "text",
                    formula: function(row) {
                        return row[this.name];
                    }
                };
                this.columns.push(column);
            }
        }


        //ignore attributes
        if (Object.keys(this.ignoreColumns).length > 0) {
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if ((line != null) &&
                    (line.length > 0) &&
                    line.substr(0, 1) != "#"
                ) {
                    if (i == 0 && this.useFirstLineAsColumnNames == true) continue;

                    var fields = line.split("\t");

                    var row = {};
                    for (var j = 0; j < fields.length; j++) {
                        if (this.ignoreColumns[j] !== true) {
                            row[finalColumnNames[j]] = fields[j].trim();
                        }
                    }
                    this.attributes.push(row);
                }
            }
        } else {
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if ((line != null) &&
                    (line.length > 0) &&
                    line.substr(0, 1) != "#"
                ) {
                    if (i == 0 && this.useFirstLineAsColumnNames == true) continue;

                    var fields = line.split("\t");

                    var row = {};
                    for (var j = 0; j < fields.length; j++) {
                        row[finalColumnNames[j]] = fields[j].trim();
                    }
                    this.attributes.push(row);
                }
            }
        }

        this.trigger('data:load', {columns: this.columns, attributes: this.attributes, sender: this});
    } catch (e) {
        console.log(e);
        console.log(e.stack);
        this.trigger('error:parse', {errorMsg: 'Parse error', sender: this});
    }


};

/*
 * Copyright (c) 2014 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2014 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2014 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//NetworkDataAdapter.prototype.getNetwork = NetworkDataAdapter.prototype.getNetwork;

function DOTDataAdapter(args) {
    NetworkDataAdapter.prototype.constructor.call(this, args);

    this.vertexSubgraph = {};

    this.addedVertex = {};
};

DOTDataAdapter.prototype.parse = function (data) {
    var _this = this;
    var sourceName, targetName, relation, relationType, fields, attrList, attrFields, metainfo, graphMetainfo, allNodesMetainfo, allEdgesMetainfo;

    var lines = data.split("\n");
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].replace(/^\s+|\s+$/g, "");
        if (line.substr(0, 1) != "#" && line.substr(0, 2) != "/*" && line.substr(0, 2) != "//") {
            var lastChar = line.substr(line.length - 1, line.length);

            // start graph definition
            if ((line.indexOf("graph") != -1 || line.indexOf("digraph") != -1 || line.indexOf("subgraph") != -1) && lastChar == '{') {
                if (line.indexOf("digraph") != -1) {
                    this.graph.setType("directed");
                }
                for (var j = i; j < lines.length; j++) {
                    i++;
                    line = lines[j].replace(/^\s+|\s+$/g, "");
                    if (line.substr(0, 1) != "#" && line.substr(0, 2) != "/*" && line.substr(0, 2) != "//") {
                        // relation definition
                        if ((line.indexOf("->") != -1 || line.indexOf("--") != -1)) {
                            if (line.indexOf("->") != -1) {
                                relation = "->";
                                relationType = "directed";
                            }
                            else {
                                relation = "--";
                                relationType = "undirected";
                            }

                            metainfo = {};
                            // the relation has attributes
                            if (line.indexOf("[") != -1 && line.indexOf("]") != -1) {

                                // extract attributes
                                attrList = line.substring(line.indexOf("[") + 1, line.indexOf("]")).split(',');
                                for (var c = 0, lenA = attrList.length; c < lenA; c++) {
                                    attrFields = attrList[c].split("=");
                                    metainfo[attrFields[0].replace(/^\s+|\s+$/g, "")] = attrFields[1].replace(/^\s+|\s+$/g, "");
                                }
                                line = line.substring(0, line.indexOf("["));
                            }
                            // relation without attributes
                            else {
                                line = line.substring(0, line.indexOf(";"));
                            }

                            // loop over relations
                            fields = line.split(relation);
                            for (var k = 0, len = fields.length; k < len - 1; k++) {
                                sourceName = fields[k].replace(/^\s+|\s+$/g, "").replace(/"/g, "");
                                targetName = fields[k + 1].replace(/^\s+|\s+$/g, "").replace(/"/g, "");

                                // add nodes to network
                                if (typeof this.addedVertex[sourceName] === 'undefined') {
                                    var vertexSource = new Vertex({
                                        name: sourceName
                                    });
                                    this.network.addVertex({
                                        vertex: vertexSource,
                                        vertexConfig: new VertexConfig({})
                                    });
                                    this.addedVertex[sourceName] = vertexSource;
                                }
                                if (typeof this.addedVertex[targetName] === 'undefined') {
                                    var vertexTarget = new Vertex({
                                        name: targetName
                                    });
                                    this.network.addVertex({
                                        vertex: vertexTarget,
                                        vertexConfig: new VertexConfig({})
                                    });
                                    this.addedVertex[targetName] = vertexTarget;
                                }
                                // add edge to network
                                var edge = new Edge({
                                    source: this.addedVertex[sourceName],
                                    target: this.addedVertex[targetName]
                                });
                                this.network.addEdge({
                                    edge: edge,
                                    edgeConfig: new EdgeConfig({
                                        type:relationType,
                                        renderer: new DefaultEdgeRenderer({
                                            shape: relationType
                                        })
                                    })
                                });
                                //TODO attributes from dot

                            }
                        }
                        // has attributes and not is a relation definition
                        else if (line.indexOf("[") != -1 && line.indexOf("]") != -1) {
                            // extract attributes
                            attrList = line.substring(line.indexOf("[") + 1, line.indexOf("]")).split(',');
                            metainfo = {};
                            for (var c = 0, lenA = attrList.length; c < lenA; c++) {
                                attrFields = attrList[c].split("=");
                                metainfo[attrFields[0].replace(/^\s+|\s+$/g, "")] = attrFields[1].replace(/^\s+|\s+$/g, "").replace(/"/g, "").replace(/'/g, "");
                            }

                            // attributes for the graph
                            if (line.indexOf("graph") != -1) {
                                graphMetainfo = metainfo;
                            }

                            // attributes for all nodes
                            else if (line.indexOf("node ") != -1) {
                                allNodesMetainfo = metainfo;
                            }

                            // attributes for all edges
                            else if (line.indexOf("edge") != -1) {
                                allEdgesMetainfo = metainfo;
                            }

                            // attributes for specific node
                            else {
                                var node = line.split("[")[0].replace(/^\s+|\s+$/g, "").replace(/"/g, "");

                                // check and modify if necesary color names
                                if (metainfo.color && metainfo.color.slice(0, 1) != '#' && !isNaN(metainfo.color.slice(-1))) {
                                    metainfo.color = metainfo.color.slice(0, -1);
                                }
                                if (metainfo.fillcolor && metainfo.fillcolor.slice(0, 1) != '#' && !isNaN(metainfo.fillcolor.slice(-1))) {
                                    metainfo.fillcolor = metainfo.fillcolor.slice(0, -1);
                                }

                                if (typeof this.addedVertex[node] === 'undefined') {
                                    var vertex = new Vertex({
                                        name: node
                                    });
                                    this.network.addVertex({
                                        vertex: vertex,
                                        vertexConfig: new VertexConfig({})
                                    });
                                    this.addedVertex[node] = vertex;
                                }

                            }
                        }
                        else if (line.indexOf("subgraph") != -1) {
                            lines[j] = lines[j].replace("subgraph", "graph");
                            var subgraphName = lines[j].replace(/^\s+|\s+$/g, "").split(" ")[1];
                            var subgraphLines = "";
                            var splitter;
                            for (var n = j, lenN = lines.length; n < lenN; n++) {
                                subgraphLines += lines[n] + "\n";
                                var lineN = lines[j].replace(/^\s+|\s+$/g, "");
                                if (lineN.substr(0, 1) != "#" && lineN.substr(0, 2) != "/*" && lineN.substr(0, 2) != "//") {
                                    if ((lineN.indexOf("->") != -1 || lineN.indexOf("--") != -1)) {
                                        if (lineN.indexOf("->") != -1) {
                                            splitter = "->";
                                        }
                                        else {
                                            splitter = "--";
                                        }

                                        // loop over relations
                                        var fieldsN = lineN.replace(/;/g, "").split(splitter);
                                        for (var k = 0, len = fieldsN.length; k < len - 1; k++) {
                                            source = fieldsN[k].replace(/^\s+|\s+$/g, "").replace(/"/g, "");
                                            target = fieldsN[k + 1].replace(/^\s+|\s+$/g, "").replace(/"/g, "");

                                            this.nodeSubgraph[source] = subgraphName;
                                            this.nodeSubgraph[target] = subgraphName;
                                        }

                                    }
                                }
                                if (lines[n].indexOf("}") != -1) {
                                    this.parse(subgraphLines);
                                    break;
                                }
                                else {
                                    j++;
                                    i++;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function JSONNetworkDataAdapter(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    this.dataSource;
    this.async = true;
    this.jsonObject;

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    if (this.async) {
        this.dataSource.on('success', function (data) {
            _this.parse(data);
        });
        this.dataSource.fetch(this.async);
    } else {
        var data = this.dataSource.fetch(this.async);
        this.jsonObject = JSON.parse(data);
    }
};

JSONNetworkDataAdapter.prototype.getJSON = function () {
    return this.jsonObject;
};


JSONNetworkDataAdapter.prototype.parse = function (data) {
    try {
        this.jsonObject = JSON.parse(data);
        this.trigger('data:load', {jsonObject:this.jsonObject});
    } catch (e) {
        console.log(e);
        this.trigger('error:parse', {errorMsg: 'Parse error', sender: this});
    }
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */
function SIFNetworkDataAdapter(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    this.dataSource;
    this.async = true;

    this.separator = "\t";
    this.graph = new JsoGraph();

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    if (this.async) {
        this.dataSource.on('success', function (data) {
            _this.parse(data);
        });
        this.dataSource.fetch(this.async);
    } else {
        var data = this.dataSource.fetch(this.async);
        this.parse(data);
    }

    this.addedVertex;
    this.addedEdges;

};

SIFNetworkDataAdapter.prototype.getGraph = function () {
    return this.graph;
};

SIFNetworkDataAdapter.prototype.parse = function (data) {
    var _this = this;

    try {
        /* Detect separator: if tab is found use tab, space instead*/
        if (data.indexOf('\t') != -1) {
            this.separator = '\t';
        } else {
            this.separator = ' ';
        }

        console.time("SIFParse");
        data = data.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
        var lines = data.split(/\n/);
        this.addedVertex = {};
        this.addedEdges = {};

        //        console.log('SIFParse number lines: ' + lines.length);
        //        console.log(lines);
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            if ((line != null) && (line.length > 0)) {
                var fields = line.split(this.separator);
                for (var j = 0; j < fields.length; j++) {
                    fields[j] = fields[j].trim();
                }

                if (fields[0].substr(0, 1) != "#") {

                    var sourceName = fields[0];
                    var edgeName = (fields[1] === '') ? "r" : fields[1];
                    var targetName;

                    /** create source vertex **/
                    if (typeof this.addedVertex[sourceName] === 'undefined') {
                        var sourceVertex = new Vertex({
                            id: sourceName
                        });
                        this.graph.addVertex(sourceVertex);
                        this.addedVertex[sourceName] = sourceVertex;
                    }

                    // multiple targets
                    for (var j = 2, len = fields.length; j < len; j++) {
                        targetName = fields[j];

                        /** create target vertex **/
                        if (typeof this.addedVertex[targetName] === 'undefined') {
                            var targetVertex = new Vertex({
                                id: targetName
                            });
                            this.graph.addVertex(targetVertex);
                            this.addedVertex[targetName] = targetVertex;
                        }

                        var edgeId = sourceName + '_' + edgeName + '_' + targetName;

                        /** create edge **/
                        if (typeof this.addedEdges[edgeId] === 'undefined') {
                            var edge = new Edge({
                                id: edgeId,
                                relation: edgeName,
                                source: this.addedVertex[sourceName],
                                target: this.addedVertex[targetName],
                                weight: 1,
                                directed: true
                            });
                            this.graph.addEdge(edge);
                            this.addedEdges[edgeId] = edge;
                        }
                    }
                }
            }
        }
        console.timeEnd("SIFParse");
        this.trigger('data:load', {
            graph: this.graph,
            sender: this
        });
    } catch (e) {
        console.log(e);
        this.trigger('error:parse', {
            errorMsg: 'Parse error',
            sender: this
        });
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */
function TextNetworkDataAdapter(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    this.dataSource;
    this.async = true;

    this.separator = /\t/;
    this.graph = new JsoGraph();


    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);

    this.rawData;

    if (this.async) {
        this.dataSource.on('success', function(data) {
            _this.rawData = data;
            _this.parse(data);
        });
        this.dataSource.fetch(this.async);
    } else {
        var data = this.dataSource.fetch(this.async);
        _this.rawData = data;
        this.parse(data);
    }

    this.columnLength;

    this.addedVertex;
    this.addedEdges;

};

TextNetworkDataAdapter.prototype.getGraph = function() {
    return this.graph;
};

TextNetworkDataAdapter.prototype.parse = function(data) {
    try {
        if (typeof data === 'undefined') {
            data = this.rawData;
        }
        data = data.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
        var lines = data.split(/\n/);
        this.lines = [];
        this.columnLength = 0;
        var firstLineColumnLength = 0;
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            if ((line != null) && (line.length > 0)) {
                var fields = line.split(this.separator);
                if (fields[0].substr(0, 1) != "#") {
                    this.lines.push(fields);

                    if (firstLineColumnLength === 0) {
                        firstLineColumnLength = fields.length;
                        this.columnLength = firstLineColumnLength;
                    }

                    if (fields.length !== firstLineColumnLength) {
                        this.trigger('error:parse', {
                            errorMsg: 'Different number of columns.',
                            sender: this
                        });
                    }
                }
            }
        }
        this.trigger('data:load', {
            lines: this.lines,
            sender: this
        });
    } catch (e) {
        console.log(e);
        this.trigger('error:parse', {
            errorMsg: 'Parse error',
            sender: this
        });
    }
};

TextNetworkDataAdapter.prototype.parseColumns = function(sourceIndex, targetIndex, relationIndex, relationDefaultName) {
    this.graph = new JsoGraph();
    this.addedVertex = {};
    this.addedEdges = {};

    for (var i = 0; i < this.lines.length; i++) {
        var fields = this.lines[i];
        for (var j = 0; j < fields.length; j++) {
            fields[j] = fields[j].trim();
        }


        var sourceName = fields[sourceIndex];
        var targetName = fields[targetIndex];
        var edgeName;
        if (relationIndex < 0) {
            edgeName = relationDefaultName;
        } else {
            edgeName = fields[relationIndex];
        }

        /** create source vertex **/
        if (typeof this.addedVertex[sourceName] === 'undefined') {
            var sourceVertex = new Vertex({
                id: sourceName
            });
            this.graph.addVertex(sourceVertex);
            this.addedVertex[sourceName] = sourceVertex;
        }

        /** Check if target column is not defined, so only the source will be added**/
        if (targetIndex > -1) {

            /** create target vertex **/
            if (typeof this.addedVertex[targetName] === 'undefined') {
                var targetVertex = new Vertex({
                    id: targetName
                });
                this.graph.addVertex(targetVertex);
                this.addedVertex[targetName] = targetVertex;
            }
            var edgeId = sourceName + '_' + edgeName + '_' + targetName;

            /** create edge **/
            if (typeof this.addedEdges[edgeId] === 'undefined') {
                var edge = new Edge({
                    id: edgeId,
                    relation: edgeName,
                    source: this.addedVertex[sourceName],
                    target: this.addedVertex[targetName],
                    weight: 1,
                    directed: true
                });
                this.graph.addEdge(edge);
                this.addedEdges[edgeId] = edge;
            }
        }


    }

    return this.graph;
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */
function XLSXNetworkDataAdapter(args) {
    var _this = this;
    _.extend(this, Backbone.Events);

    this.dataSource;
    this.async = true;

    this.graph = new JsoGraph();
    this.xlsx;

    //set instantiation args, must be last
    _.extend(this, args);

    this.on(this.handlers);


    if (this.async) {
        this.dataSource.on('success', function (data) {
            _this.parse(data);
        });
        this.dataSource.fetch(this.async);
    } else {
        var data = this.dataSource.fetch(this.async);
        this.parse(data);
    }


};

XLSXNetworkDataAdapter.prototype.parse = function (data) {
    try {
        this.xlsx = XLSX.read(data, {type: 'binary'});
        this.trigger('data:load', {workbook: this.xlsx, sender: this});
    } catch (e) {
        console.log(e);
        this.trigger('error:parse', {errorMsg: 'Parse error', sender: this});
    }
};
XLSXNetworkDataAdapter.prototype.parseSheet = function (sheetName) {
    var csv = XLSX.utils.sheet_to_csv(this.xlsx.Sheets[sheetName]);
    return csv;
};

/**
 * Created with IntelliJ IDEA.
 * User: imedina
 * Date: 10/8/13
 * Time: 12:42 AM
 *
 * This API is asynchronous. When a return value is expected, you must provide a callback function.
 *
 * This class works this way:
 *
 * before executing any request ( get, put, ...),
 * make sure the DataBase connection is alive (this.db) // TODO not yet
 * if the connection is dead: reconnect.
 * make the request to indexedDB.
 */


var iDBInstances = [];
var iDBVersion = 1;
function IndexedDBStore(args) {
    var _this = this;
    this.debug = false;
    this.profile = false;
//debugger
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.lru = [];

    this.cacheId = "DataBase";
//    this.objectStore = "ObjectStore";
    this.opening = false;
    this.timeout = 30;  // time to wait if the DB connection is being already opened
    // Now we set the args parameters
    // must be the last instruction in order to overwrite default attributes
    _.extend(this, args);

    window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
//    this.db = null;
    this.version = iDBVersion;

    if (!this.cacheId) {
        console.log("IndexedDBStore: not supplied cacheId to constructor. Using default DataBase...");
    }

    iDBInstances.push(this);
//        if (!window.indexedDB) {
//            window.alert("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.");
//        }
    /*
     this._getConnection(function (db) {
     console.log("obtained initial IndexedDB connection for " + _this.cacheId);
     console.log(db);
     });
     */
}

IndexedDBStore.prototype = {
    _getConnection: function (objectStoreName, callback, version) {
        var _this = this;
        if (_this.debug) {
            console.log(_this.cacheId + " opening? " + _this.opening);
            if (objectStoreName == undefined) {
                console.log("WARNING: requested to create objectStore 'undefined'");
                debugger
            }
//        debugger
        }
        if (_this.opening == true) {
            if (_this.debug) {
                console.log("Database " + _this.cacheId + " is already opening. To avoid block: waiting...");
            }
            setTimeout(_this._getConnection.bind(_this), _this.timeout * (1 + Math.random()*0.25), objectStoreName, callback, version);
            /*} else if (dbConnection && !dbConnection.closed && dbConnection.objectStoreNames.contains(objectStoreName)) { // recycle connections
             if (_this.debug) {
             console.log("Database already opened:", dbConnection);
             }
             callback(dbConnection);*/
        } else {
            try {
                if (_this.debug) {
                    console.log("trying opening Database:" + _this.cacheId);
                }
                var dbOpenRequest;
                _this.opening = true;
                if (_this.debug) {
                    console.log("lock:"+_this.cacheId + ", " + objectStoreName + " opening = "+ _this.opening + " version: " + version);
                }
                if (!_.isUndefined(version)) {
                    dbOpenRequest = window.indexedDB.open(_this.cacheId, version); // second parameter is the version. increase to modify tables.
                } else {
                    dbOpenRequest = window.indexedDB.open(_this.cacheId);
                }
                dbOpenRequest.onsuccess = function (event) {
                    _this.opening = false;
                    if (_this.debug) {
                        console.log("unlock:" + _this.cacheId + ", " + objectStoreName + " opening = " + _this.opening);
                    }
//                    if (dbConnection) {
//                        console.log("overwriting DB", dbConnection, " with", event.target.result);
//                        debugger;
//                        dbConnection.close();
//                        dbConnection.closed = true;
//                        dbConnection = undefined;
//                    }
                    var dbConnection = event.target.result;

                    dbConnection.onversionchange = function (e) {
                        if (_this.debug) {
                            console.log("Version change triggered, so closing database connection " + _this.cacheId + ", " + objectStoreName + " (old version, new version, db, event)", e.oldVersion, e.newVersion, dbConnection, e);
                        }
                        if (dbConnection) {
                            dbConnection.close();
                            dbConnection.closed = true;
                            dbConnection = undefined;
                        }
                    };

                    if (objectStoreName != "" && !dbConnection.objectStoreNames.contains(objectStoreName)) {
                        iDBVersion = Math.max(iDBVersion, dbConnection.version) + 1;
                        dbConnection.close();
                        dbConnection.closed = true;
                        dbConnection = undefined;
                        _this.version = iDBVersion;
                        if (_this.debug) {
                            console.log("needed ObjectStore " + objectStoreName + " in " + _this.cacheId + " creating version " + iDBVersion);
                        }
                        _this._getConnection(objectStoreName, callback, _this.version);
                    } else {
                        if (_this.debug) {
                            console.log("connection obtained for " + _this.cacheId + " and " + objectStoreName, dbConnection);
                        }
                        callback(dbConnection);
                    }
                };
                dbOpenRequest.onupgradeneeded = function (e) {
                    if (_this.debug) {
                        console.log("Database upgrade needed in " + _this.cacheId + ", " + objectStoreName);
                    }
                    dbConnection = e.target.result;

                    if (!dbConnection.objectStoreNames.contains(objectStoreName)) {
                        if (_this.debug) {
                            console.log("creating " + objectStoreName + " in Database " + _this.cacheId );
                        }
                        var objectStore = dbConnection.createObjectStore(objectStoreName);
                    }
                };
                dbOpenRequest.onerror = function (e) {
                    console.log("DB Open Request Error in " + _this.cacheId + ", " + objectStoreName);
                    console.log(e);
                };
                dbOpenRequest.onblocked = function (e) {
                    console.log("DB Open Request Blocked in " + _this.cacheId + ", " + objectStoreName, e);
//                    if (dbConnection) {
//                        dbConnection.close();
//                    }
                    _this._getConnection(objectStoreName, callback)
                };
            } catch (e) {
                console.log("catch error:");
                console.error(e);
            }
        }
    },

    clear: function (objectStoreName) {
//        this.db.deleteObjectStore(this.cacheId);

        var _this = this;
        _this._getConnection(objectStoreName, function(dbConnection){
            var transaction = dbConnection.transaction([objectStoreName], "readwrite");
            transaction.oncomplete = function(event) {
                console.log("IndexedDB " + _this.cacheId + ", " + objectStoreName + " clear success!");
            };
            var objectStore = transaction.objectStore(objectStoreName);
            var req = objectStore.clear();
            req.onerror = function (evt) {
                console.log("IndexedDB Error trying to clear the object store " + objectStoreName + " in " + _this.cacheId);
            }
        });
    },

    count: function (objectStoreName, callback) {
        var _this = this;
        _this._getConnection(objectStoreName, function(dbConnection){
            var transaction = dbConnection.transaction([objectStoreName], "readwrite");
            var objectStore = transaction.objectStore(objectStoreName);
            var req = objectStore.count();
            req.onerror = function (evt) {
                console.log("IndexedDB Error trying to count the object store " + objectStoreName + " in " + _this.cacheId);
            };
            req.onsuccess = function (event) {
                callback(event.target.result);
            }
        });
    },

    getObjectStoreNames: function (callback) {
        var _this = this;
        _this._getConnection("", function(dbConnection){
            callback(dbConnection.objectStoreNames);
        });
    },

    close: function () {
        var _this = this;
        _this._getConnection(objectStoreName, function(dbConnection){
            dbConnection.close();
            console.log("Database " + _this.cacheId + " closed");
            dbConnection.closed=true;
            dbConnection = undefined;
        });
    },

    destroyDB: function() {
        var _this = this;
        try {
            var dbDeleteRequest = window.indexedDB.deleteDatabase(_this.cacheId);
            dbDeleteRequest.onsuccess = function (e) {
                console.log("Database " + _this.cacheId + " successfully deleted");
            };
            dbDeleteRequest.onupgradeneeded = function (e) {
                var db = dbOpenRequest.result;
                console.log("Deleting Database upgrade needed");
                /* Code for ${db.upgrade} */
            };
            dbDeleteRequest.onerror = function (e) {
                console.log("Error deleting DB" + _this.cacheId);
                console.log(e);
            };
            dbDeleteRequest.onblocked = function (e) {
                console.log("Deleting DB Blocked. Try closing the database " + _this.cacheId + " and then deleting it");
            };
        } catch (e) {
            console.log(e);
        }

    },

    destroyDBs: function() {
        for (var i = 0; i < iDBInstances.length; i++){
            iDBInstances[i].close();
            iDBInstances[i].destroyDB();
        }
    },


    get: function(objectStoreName, key, callback) {
        var timeId;
        var _this = this;
        if (_this.debug) {
            timeId = "IndexedDBStore.get " + objectStoreName + key;
            console.time(timeId);
        }
        var result = null;
        _this._getConnection(objectStoreName, function (dbConnection) {
            var transaction = dbConnection.transaction([objectStoreName], "readonly");
            transaction.oncomplete = function(event) {
                if (_this.debug) {
                    console.timeEnd(timeId);
                }
                dbConnection.close();
                callback(result);
            };
            transaction.onerror = function (event) {
                console.log("There was an error in the transaction get (" + key + ")");
                console.log(event);
            };

            var objectStore = transaction.objectStore(objectStoreName);
            var request = objectStore.get(key);
            request.onsuccess = function (event) {
                result = event.target.result;
            };
        });
    },


    /**
     * Calls the callback ONCE. As a parameter there is an Array with all the values.
     * @param keyArray
     * @param callback (valuesArray) The order is the same as in the keyArray.
     */
    getAll: function(objectStoreName, keyArray, callback) {
        var _this = this;
        var timeId;
        if (_this.profile || _this.debug) {
            timeId = "IndexedDBStore.getAll " + objectStoreName + ", with " + keyArray.length + " keys.";
            console.time(timeId);
        }
        if (!(keyArray instanceof Array) || !callback) {
            console.error("Bad use of IndexedDBStore: getAll must receive an ObjectStoreName, an Array of keys and a callback function.");
            return;
        }
        var results = new Array(keyArray.length);

        _this._getConnection(objectStoreName, function (dbConnection) {
            var transaction = dbConnection.transaction([objectStoreName], "readonly");
            transaction.oncomplete = function(event) {
                if (_this.profile || _this.debug) {
                    console.timeEnd(timeId);
                }
                dbConnection.close();
                callback(results);
            };
            transaction.onerror = function (event) {
                console.log("There was an error in the transaction get (" + keyArray + ")");
                console.log(event);
            };

            var objectStore = transaction.objectStore(objectStoreName);

            for (var i = 0; i < keyArray.length; i++) {
                var request = objectStore.get(keyArray[i]);

                request.onsuccess = function (iteration) {
                    return function (event) {
                        results[iteration] = event.target.result;
                    };
                } (i);     // to force the closure to have each value of i, and not just the last one
            }
        });
    },

    /**
     * Calls the callback with the value of each key. The callback is called keyArray.length times.
     * @param callback (value, key, i) Receives as parameters the value, its key, and the position of the key in the keyArray.
     * @param whenCompletedCallback Optional. Receives no arguments. it is called when all callbacks have finished.
     */
    foreach: function(objectStoreName, keyArray, callback, whenCompletedCallback) {
        if (!(keyArray instanceof Array) || !callback) {
            console.error("Bad use of IndexedDBStore: foreach must receive an ObjectStoreName, an Array of keys and a callback function.");
            return;
        }
        var _this = this;
        var timeId;
        if (_this.profile || _this.debug) {
            timeId = "IndexedDBStore.getAll " + objectStoreName + ", with " + keyArray.length + " keys.";
            console.time(timeId);
        }

        _this._getConnection(objectStoreName, function (dbConnection) {
            var transaction = dbConnection.transaction([objectStoreName], "readonly");
            transaction.oncomplete = function(event) {
                dbConnection.close();
                if (_this.profile || _this.debug) {
                    console.timeEnd(timeId);
                }
                if (whenCompletedCallback) {
                    whenCompletedCallback();
                }
            };
            transaction.onerror = function (event) {
                console.log("There was an error in the transaction foreach (" + keyArray + ")");
                console.log(event);
            };

            var objectStore = transaction.objectStore(objectStoreName);

            for (var i = 0; i < keyArray.length; i++) {
                var request = objectStore.get(keyArray[i]);

                request.onsuccess = function (iteration) {
                    return function (event) {
                        callback(event.target.result, keyArray[iteration], iteration);
                    };
                } (i);     // to force the closure to have each value of i, and not just the last one
            }
        });
    },

    add: function(objectStoreName, key, value) {
        var _this = this;

        _this._getConnection(objectStoreName, function(dbConnection) {
            var transaction = dbConnection.transaction([objectStoreName], "readwrite");

            transaction.onerror = function (event) {
                console.log("There was an error in the transaction add (" + key + ", " + value + ")");
                console.log(event);
            };

            var objectStore = transaction.objectStore(objectStoreName);
            var request = objectStore.add(value, key);    // as the key is optional depending on the database scheme, it is the 2nd parameter
        });
    },

    put: function(objectStoreName, key, value) {
        var _this = this;
        var timeId;
        if (_this.debug) {
            timeId = "IndexedDBStore.put " + objectStoreName + key;
            console.time(timeId);
        }

        _this._getConnection(objectStoreName, function(dbConnection) {
            var transaction = dbConnection.transaction([objectStoreName], "readwrite");
            transaction.oncomplete = function(event) {
                if (_this.debug) {
                    console.timeEnd(timeId);
                }
                dbConnection.close();
                dbConnection.close = true;
            };
            transaction.onerror = function (event) {
                console.log("There was an error in the transaction put(" + key + ", ", value, ")");
                console.log(event);
            };

            var objectStore = transaction.objectStore(objectStoreName);
            var request = objectStore.put(value, key);    // as the key is optional depending on the database scheme, it is the 2nd parameter
        });
    },

    putAll: function(objectStoreName, keyArray, valueArray) {
        var _this = this;
        var timeId;
        if (_this.profile || _this.debug) {
            timeId = "IndexedDBStore.putAll " + objectStoreName + ", with " + keyArray.length;
            console.time(timeId);
        }

        if (!(keyArray instanceof Array) || !(valueArray instanceof Array) || (keyArray.length != valueArray.length)) {
            console.error("Bad use of IndexedDBStore: putAll must receive two Arrays of the same length.");
            return;
        }

        _this._getConnection(objectStoreName, function(dbConnection) {
            var transaction = dbConnection.transaction([objectStoreName], "readwrite");
            transaction.oncomplete = function(event) {
                if (_this.profile || _this.debug) {
                    console.timeEnd(timeId);
                }
                dbConnection.close();
                dbConnection.close = true;
            };
            transaction.onerror = function (event) {
                console.log("There was an error in the transaction put(" + key + ", ", value, ")");
                console.log(event);
            };

            var objectStore = transaction.objectStore(objectStoreName);

            for (var i = 0; i < keyArray.length; i++) {
                objectStore.put(valueArray[i], keyArray[i]);    // as the key is optional depending on the database scheme, it is the 2nd parameter
            }
        });
    },


    delete: function(objectStoreName, key) {
        var _this = this;

        _this._getConnection(objectStoreName, function(dbConnection) {
            var transaction = dbConnection.transaction([objectStoreName], "readwrite");
            transaction.onerror = function (event) {
                console.log("There was an error in the transaction delete (" + key + ")");
                console.log(event);
            };

            var objectStore = transaction.objectStore(objectStoreName);
            var request = objectStore.delete(key);    // as the key is optional depending on the database scheme, it is the 2nd parameter

        });
    }
};

IndexedDBTest = function () {
    var idb = new IndexedDBStore({cacheId: "test"});
    idb.put("os-a", "key-a", "value-a");
    idb.put("os-b", "key-b", "value-b");
};

IndexedDBTest();
//debugger

/**
 * Created with IntelliJ IDEA.
 * User: imedina
 * Date: 10/8/13
 * Time: 12:40 AM
 * To change this template use File | Settings | File Templates.
 */

/**
 * MemoryStore is a cache with items ordered with "least recently used" criterion (LRU). This allows to remove old data with the "shift" method.
 * The parameter "category" should be a string, and it is used as another level of classification.
 * "get", "getAll" and "foreach" methods can be used with callbacks or with return values.
 */
function MemoryStore(args) {

    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    // configurable parameters
    //    this.limit = 500;

    // Now we set the args parameters
    _.extend(this, args);

    this.init();
};

MemoryStore.prototype = {
    put: function (category, key, value) {
        if (typeof this.stores[category] === 'undefined') {
            this.init(category);
        }
        var item = {
            key: key,
            value: value
        };

        // a item can be overwritten
        this.stores[category][key] = item;

        if (this.tails[category]) {
            this.tails[category].newer = item;
            item.older = this.tails[category];
        } else {
            // the item is the first one
            this.heads[category] = item;
        }

        // add new item to the end of the linked list, it's now the freshest item.
        this.tails[category] = item;

        //        if (this.size === this.limit) {
        //            // we hit the limit, remove the head
        //            this.shift();
        //        } else {
        //            // increase the size counter
        //            this.size++;
        //        }
        this.sizes[category]++;

    },
    putAll: function (category, keyArray, valueArray) {
        for (var i = 0; i < keyArray.length; i++) {
            this.put(category, keyArray[i], valueArray[i]);
        }
    },

    shift: function (category) {
        if (typeof this.stores[category] === 'undefined') {
            this.init(category);
        }
        // todo: handle special case when limit == 1
        var item = this.heads[category];
        if (item) {
            if (this.heads[category].newer) {
                this.heads[category] = this.heads[category].newer;
                this.heads[category].older = undefined;
            } else {
                this.heads[category] = undefined;
            }
            // Remove last strong reference to <item> and remove links from the purged
            // item being returned:
            item.newer = item.older = undefined;
            // delete is slow, but we need to do this to avoid uncontrollable growth:
            delete this.stores[category][item.key];
        }
    },
    get: function (category, key, callback) {
        if (typeof this.stores[category] === 'undefined') {
            this.init(category);
        }
        // First, find our cache item
        var item = this.stores[category][key];
        if (item === undefined) {
            if (callback) {
                callback();
            }
            return; // Not cached. Sorry.
        }
        // As <key> was found in the cache, register it as being requested recently
        if (item === this.tails[category]) {
            // Already the most recenlty used item, so no need to update the list
            if (callback) {
                callback(item.value);
            }
            return item.value;
        }
        // HEAD--------------TAIL
        //   <.older   .newer>
        //  <--- add direction --
        //   A  B  C  <D>  E
        if (item.newer) {
            if (item === this.heads[category]) {
                this.heads[category] = item.newer;
            }
            item.newer.older = item.older; // C <-- E.
        }
        if (item.older) {
            item.older.newer = item.newer; // C. --> E
        }
        item.newer = undefined; // D --x
        item.older = this.tails[category]; // D. --> E
        if (this.tails[category])
            this.tails[category].newer = item; // E. <-- D
        this.tails[category] = item;
        if (callback) {
            callback(item.value);
        }
        return item.value;
    },

    getAll: function (category, keyArray, callback) {
        var valueArray = [];
        for (var i = 0; i < keyArray.length; i++) {
            valueArray[i] = this.get(category, keyArray[i]);
        }
        callback(valueArray);
    },

    foreach: function (category, keyArray, callback) {
        for (var i = 0; i < keyArray.length; i++) {
            callback(this.get(category, keyArray[i]), keyArray[i]);
        }
    },

    init: function (category) {
        if (category != undefined) {
            this.sizes[category] = 0;
            this.stores[category] = {};
            this.heads[category] = undefined;
            this.tails[category] = undefined;
        } else {
            this.sizes = {};
            this.stores = {};
            this.heads = {};
            this.tails = {};
        }
    },
    clear: function () {
        this.stores = null; // TODO delete?
        this.init();
    },
    
    delete: function () {
        this.clear();
    }

    //    get: function (key) {
    //        if (typeof this.dataStore === 'undefined') {
    //            return undefined;
    //        } else {
    //            var ms = this.counter++;
    //            this.dataStore[key].ms = ms;
    //            return this.dataStore[key].data;
    //        }
    //    },

    //    addCollection: function (key, featureArray) {
    //        // If 'featureArray' is an Array then we add all elements,
    //        // otherwise we call to add()
    //        if ($.isArray(featureArray)) {
    //            if (typeof this.dataStore === 'undefined') {
    //                this.dataStore = {};
    //            }
    //            for (var feature in featureArray) {
    //                this.dataStore[key] = feature;
    //                this.lru.push({key: key, ms: this.counter});
    //            }
    //        } else {
    //            this.add(key, featureArray);
    //        }
    //    },

    //    delete: function (key) {
    //        if (typeof this.dataStore !== 'undefined') {
    //            var aux = this.dataStore[key];
    //            delete this.dataStore[key];
    //            return aux;
    //        }
    //    },

    //    free: function () {
    //        this.lru = [];
    //        for (var i in this.dataStore) {
    //            this.lru.push({key: i, ms: this.dataStore[i].ms});
    //        }
    //        this.lru.sort(function (a, b) {
    //            return a.ms - b.ms;
    //        });
    //        this.delete(this.lru[0].key);
    //        this.lru.splice(0, 1);
    //    },
    //
    //    close: function () {
    //        this.dataStore = null;
    //    }
};

/**
 * Created with IntelliJ IDEA.
 * User: fsalavert
 * Date: 10/18/13
 * Time: 12:06 PM
 * To change this template use File | Settings | File Templates.
 */

function FeatureChunkCache(args) {
    _.extend(this, Backbone.Events);

    // Default values
    this.id = Utils.genId("FeatureChunkCache");

    this.defaultChunkSize = 50000;
    this.defaultCategory = "defaultCategory";
    this.limit;

    _.extend(this, args);

    if (this.storeType == "MemoryStore") {
        this.store = new MemoryStore({});
    } else {
        this.store = new IndexedDBStore({cacheId: this.cacheId});
    }

    this.verbose = false;
}


FeatureChunkCache.prototype = {
    /**
     *
     * @param region an object Region
     * @param categories approximately the table in the DB. May be an array
     * @param dataType another level of classification
     * @param chunkSize
     * @param callback receives two arguments: (cachedChunks, uncachedRegions) with this structure:
     * cachedChunks: {
     *     categories[0]: [chunk, chunk, chunk],
     *     categories[1]: [chunk, chunk, chunk],
     *     ...
     * }
     * uncachedRegions: {
     *     categories[0]: [region, region],
     *     categories[1]: [region, region],
     *     ...
     * }
     */
    get: function (region, categories, dataType, chunkSize, callback) {
        var _this = this;
        var temporalChunkSize = chunkSize ? chunkSize : this.defaultChunkSize;

        var firstChunkId = this.getChunkId(region.start, temporalChunkSize);
        var lastChunkId = this.getChunkId(region.end, temporalChunkSize);
        var keys = [];
        var chunksAndRegions = {cachedChunks: {}, uncachedRegions: {}};

        for (var chunkId = firstChunkId; chunkId <= lastChunkId; chunkId++) {
            keys.push(this.getChunkKey(region.chromosome, chunkId, dataType, temporalChunkSize));
        }

        if (!_.isArray(categories)) {
            categories = [categories];
        }
        var callbackCount = 0;
        for (var cat = 0; cat < categories.length; cat++) {
            callbackCount++;
            chunksAndRegions.cachedChunks[categories[cat]] = [];
            chunksAndRegions.uncachedRegions[categories[cat]] = [];
            this.getChunks(categories[cat], keys, function (iterCat) {
                return function (chunks) {
                    for (var i = 0; i < chunks.length; i++) {
                        var chunkRegionEnd = parseInt(((firstChunkId + i) * temporalChunkSize) + temporalChunkSize - 1);
                        var chunkRegionStart = parseInt((firstChunkId + i) * temporalChunkSize);
                        var chunkRegion = new Region({
                            chromosome: region.chromosome,
                            start: chunkRegionStart,
                            end: chunkRegionEnd
                        });

                        if (_.isUndefined(chunks[i])) {
                            chunksAndRegions.uncachedRegions[categories[iterCat]].push(chunkRegion);
                        } else {
                            chunksAndRegions.cachedChunks[categories[iterCat]].push(chunks[i]);
                        }
                    }
                    if (this.verbose) {
                        console.log(chunksAndRegions);
                    }
                    callbackCount--;
                    if (callbackCount == 0 && callback) {
                        callback(chunksAndRegions.cachedChunks, chunksAndRegions.uncachedRegions);
                    }
                }
            }(cat));     // to force the closure to have each value of cat, and not just the last one
        }
    },

    /*
     getChunk: function (chunkId) {
     return this.store.get(chunkId);
     },*/

    getChunk: function (category, chunkKey, callback) {
        if (!callback) {
            console.log("bad FeatureChunkCache usage: undefined callback");
        }
        if (!category) {
            category = this.defaultCategory;
        }
        this.store.get(category, chunkKey, callback);
    },

    getChunks: function (category, chunkKeysArray, callback) {
        if (!callback) {
            console.log("bad FeatureChunkCache usage: undefined callback");
        }
        if (!category) {
            category = this.defaultCategory;
        }
        this.store.getAll(category, chunkKeysArray, callback);
    },

    joinRegions: function (regions) {
        if (regions.length <= 1) {
            return regions;
        }
        // assert(regions.length >= 2)

        var joinedRegions = [];
        var regionStart = regions[0].start;
        var regionEnd = region[0].end;
        var regionChromosome = regions[0].chromosome;

        for (var i = 1; i < regions.length; i++) {
            if (regions[i].chromosome == regionChromosome && regions[i].start - 1 <= regionEnd) { // CAUTION: assuming inclusive intervals
                if (regions[i].end > regionEnd) {
                    regionEnd = regions[i].end;
                }
            } else {
                joinedRegions.push(new Region({chromosome: regionChromosome, start: regionStart, end: regionEnd}));
                regionChromosome = regions[i].chromosome;
                regionStart = regions[i].start;
                regionEnd = regions[i].end;
            }
        }

        joinedRegions.push(new Region({chromosome: regionChromosome, start: regionStart, end: regionEnd}));

        return joinedRegions;
    },

    /**
     * TODO: the regions must be equally long to the chunksize
     */
    putByRegions: function (regionArray, valueArray, category, dataType, chunkSize) { // encoded
        var temporalChunkSize = chunkSize ? chunkSize : this.defaultChunkSize;
        var chunkKeyArray = [];
        for (var i = 0; i < regionArray.length; i++) {
            var chunkId = this.getChunkId(regionArray[i].start, temporalChunkSize);
            var chunkKey = this.getChunkKey(regionArray[i].chromosome, chunkId, dataType, chunkSize);
            chunkKeyArray.push(chunkKey);
        }
        return this.putChunks(chunkKeyArray, regionArray, valueArray, category, false);
    },

    /** several chunks in one transaction. this is a fast put */
    putChunks: function (chunkKeyArray, regionArray, valueArray, category, encoded) {
        var valueStoredArray = [];
        for (var i = 0; i < valueArray.length; i++) {
            valueStoredArray.push(this.createEntryValue(chunkKeyArray[i], regionArray[i], valueArray[i], encoded));   // TODO add timestamp, last usage time, size, etc.
        }
        if (!category) {
            category = this.defaultCategory;
        }
        this.store.putAll(category, chunkKeyArray, valueStoredArray);
        return valueStoredArray;
    },

    createEntryValue: function (chunkKey, region, value, encoded) {
        var valueStored;
        if (encoded) {
            valueStored = {value: value, chunkKey: chunkKey, region: region, enc: encoded}; // TODO add timestamp, last usage time, size, etc.
        } else {
            valueStored = {value: value, chunkKey: chunkKey, region: region}; // TODO add timestamp, last usage time, size, etc.
        }
        return valueStored;
    },

    getChunkKey: function (chromosome, chunkId, dataType, chunkSize) {
        var keySuffix = dataType ? "_" + dataType : "";
        keySuffix += "_" + chunkSize;       // e.g. "_hist_1000"
        return chromosome + ":" + chunkId + keySuffix;
    },

    getChunkId: function (position, chunkSize) {
        return Math.floor(position / chunkSize);
    },


    getDefaultChunkSize: function () {
        return this.defaultChunkSize;
    },

    delete:function(){
        this.store.destroyDB();
    }

    /* TODO:
     visit: function (chunkKey) {
     var _this = this;
     this.getChunk(chunkKey, function(value){
     //            value.lastUsed = ...
     _this.putChunk(chunkKey, value);
     });
     },*/
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function FileFeatureCache(args) {
	this.args = args;
	this.id = Math.round(Math.random() * 10000000); // internal id for this class

	this.chunkSize = 50000;
	this.gzip = true;
	this.maxSize = 10*1024*1024;
	this.size = 0;
	
	if (args != null){
		if(args.chunkSize != null){
			this.chunkSize = args.chunkSize;
		}
		if(args.gzip != null){
			this.gzip = args.gzip;
		}
	}
	
	this.cache = {};
	this.chunksDisplayed = {};
	
	this.maxFeaturesInterval = 0;
	
	//XXX
	this.gzip = false;

};

FileFeatureCache.prototype._getChunk = function(position){
	return Math.floor(position/this.chunkSize);
};

FileFeatureCache.prototype.getChunkRegion = function(region){
	start = this._getChunk(region.start) * this.chunkSize;
	end = (this._getChunk(region.end) * this.chunkSize) + this.chunkSize-1;
	return {start:start,end:end};
};

FileFeatureCache.prototype.getFirstFeature = function(){
	var feature;
	if(this.gzip) {
		feature = JSON.parse(RawDeflate.inflate(this.cache[Object.keys(this.cache)[0]].data[0]));
	}else{
		feature = this.cache[Object.keys(this.cache)[0]].data[0];
	}
	return feature;
};


//new 
FileFeatureCache.prototype.getFeatureChunk = function(key){
	if(this.cache[key] != null) {
		return this.cache[key];
	}
	return null;
};
FileFeatureCache.prototype.getFeatureChunkByDataType = function(key,dataType){
	if(this.cache[key] != null) {
        if(this.cache[key][dataType] != null){
		    return this.cache[key][dataType];
        }
	}
	return null;
};
//new
FileFeatureCache.prototype.getFeatureChunksByRegion = function(region){
	var firstRegionChunk, lastRegionChunk,  chunks = [], key;
	firstRegionChunk = this._getChunk(region.start);
	lastRegionChunk = this._getChunk(region.end);
	for(var i=firstRegionChunk; i<=lastRegionChunk; i++){
		key = region.chromosome+":"+i;
		// check if this key exists in cache (features from files)
		if(this.cache[key] != null ){
			chunks.push(this.cache[key]);
		}
		
	}
	//if(chunks.length == 0){
		//return null;
	//}
	return chunks;
};


FileFeatureCache.prototype.putFeaturesByRegion = function(featureDataList, region, featureType, dataType){
	var key, firstRegionChunk, lastRegionChunk, firstChunk, lastChunk, feature, gzipFeature;


	//initialize region
	firstRegionChunk = this._getChunk(region.start);
	lastRegionChunk = this._getChunk(region.end);

	for(var i=firstRegionChunk; i<=lastRegionChunk; i++){
		key = region.chromosome+":"+i;
		if(this.cache[key]==null){
			this.cache[key] = {};
			this.cache[key].key = key;
		}
//        else{
//            // TODO
//            console.log(region.chromosome+region.start+region.end+'-'+featureType+'-'+dataType);
////            return;
//        }
		if(this.cache[key][dataType]==null){
			this.cache[key][dataType] = [];
		}
	}

    //Check if is a single object
    if(featureDataList.constructor != Array){
        featureDataList = [featureDataList];
    }

    //loop over features and set on corresponding chunks
	for(var index = 0, len = featureDataList.length; index<len; index++) {
		feature = featureDataList[index];
		feature.featureType = featureType;
		firstChunk = this._getChunk(feature.start);
		lastChunk = this._getChunk(feature.end);
		
		if(this.gzip) {
			gzipFeature = RawDeflate.deflate(JSON.stringify(feature));
		}else{
			gzipFeature = feature;
		}
		
		for(var i=firstChunk; i<=lastChunk; i++) {
			if(i >= firstRegionChunk && i<= lastRegionChunk){//only if is inside the called region
				key = region.chromosome+":"+i;
				this.cache[key][dataType].push(gzipFeature);
			}
		}
	}
//        console.log(this.cache[region.chromosome+":"+firstRegionChunk][dataType].length)
};


//used by BED, GFF, VCF
FileFeatureCache.prototype.putFeatures = function(featureDataList, dataType){
	var feature, key, firstChunk, lastChunk;

	//Check if is a single object
	if(featureDataList.constructor != Array){
		featureDataList = [featureDataList];
	}

	for(var index = 0, len = featureDataList.length; index<len; index++) {
		feature = featureDataList[index];
		firstChunk = this._getChunk(feature.start);
		lastChunk = this._getChunk(feature.end);
		for(var i=firstChunk; i<=lastChunk; i++) {
			key = feature.chromosome+":"+i;
			if(this.cache[key]==null){
				this.cache[key] = [];
				this.cache[key].key = key;
			}
			if(this.cache[key][dataType]==null){
				this.cache[key][dataType] = [];
			}
			if(this.gzip) {
				this.cache[key][dataType].push(RawDeflate.deflate(JSON.stringify(feature)));
			}else{
				this.cache[key][dataType].push(feature);
			}

		}
	}
};



FileFeatureCache.prototype.putChunk = function(key, item){
	this.cache[key] = item;
};

FileFeatureCache.prototype.getChunk = function(key){
	return this.cache[key];
};

FileFeatureCache.prototype.putCustom = function(f){
	f(this);
};

FileFeatureCache.prototype.getCustom = function(f){
	f(this);
};



FileFeatureCache.prototype.remove = function(region){
	var firstChunk = this._getChunk(region.start);
	var lastChunk = this._getChunk(region.end);
	for(var i=firstChunk; i<=lastChunk; i++){
		var key = region.chromosome+":"+i;
		this.cache[key] = null;
	}
};

FileFeatureCache.prototype.clear = function(){
		this.size = 0;		
		this.cache = {};
};


//END



//THOSE METHODS ARE NOT USED



/*
FileFeatureCache.prototype.getFeaturesByChunk = function(key, dataType){
	var features =  [];
	var feature, firstChunk, lastChunk;
	
	if(this.cache[key] != null && this.cache[key][dataType] != null) {
		for ( var i = 0, len = this.cache[key][dataType].length; i < len; i++) {
			if(this.gzip) {
				feature = JSON.parse(RawDeflate.inflate(this.cache[key][dataType][i]));
			}else{
				feature = this.cache[key][dataType][i];
			}
			
			//check if any feature chunk has been already displayed 
			var displayed = false;
			firstChunk = this._getChunk(feature.start);
			lastChunk = this._getChunk(feature.end);
			for(var f=firstChunk; f<=lastChunk; f++){
				var fkey = feature.chromosome+":"+f;
				if(this.chunksDisplayed[fkey+dataType]==true){
					displayed = true;
					break;
				}
			}
			
			if(!displayed){
				features.push(feature);
				returnNull = false;
			}
		}
		this.chunksDisplayed[key+dataType]=true;
		return features;
	}
	
	return null;
};


FileFeatureCache.prototype.getFeaturesByRegion = function(region, dataType){
	var firstRegionChunk, lastRegionChunk, firstChunk, lastChunk, features = [], feature, key, returnNull = true, displayed;
	firstRegionChunk = this._getChunk(region.start);
	lastRegionChunk = this._getChunk(region.end);
	for(var i=firstRegionChunk; i<=lastRegionChunk; i++){
		key = region.chromosome+":"+i;
		 //check if this key exists in cache (features from files)
		if(this.cache[key] != null && this.cache[key][dataType] != null){
			for ( var j = 0, len = this.cache[key][dataType].length; j < len; j++) {
				if(this.gzip) {
					try {
						feature = JSON.parse(RawDeflate.inflate(this.cache[key][dataType][j]));
					} catch (e) {
						//feature es "" 
						console.log(e)
						debugger
						
					}
					
				}else{
					feature = this.cache[key][dataType][j];
				}
				// we only get those features in the region AND check if chunk has been already displayed
				if(feature.end > region.start && feature.start < region.end){

			//		 check displayCheck argument 
					if(region.displayedCheck != false){
				//		check if any feature chunk has been already displayed 
						displayed = false;
						firstChunk = this._getChunk(feature.start);
						lastChunk = this._getChunk(feature.end);
						for(var f=firstChunk; f<=lastChunk; f++){
							var fkey = region.chromosome+":"+f;
							if(this.chunksDisplayed[fkey+dataType]==true){
								displayed = true;
								break;
							}
						}
						
						if(!displayed){
							features.push(feature);
							returnNull = false;
						}
					}else{
						features.push(feature);
						returnNull = false;
					}

					
				}
			}
		}
		 //check displayCheck argument 
		if(region.displayedCheck != false){
			this.chunksDisplayed[key+dataType]=true;//mark chunk as displayed
		}
	}
	if(returnNull){
		return null;
	}else{
		return features;
	}
};
*/




/*

FileFeatureCache.prototype.putChunk = function(featureDataList, chunkRegion, dataType){
	var feature, key, chunk;
	chunk = this._getChunk(chunkRegion.start);
	key = chunkRegion.chromosome+":"+chunk;

	if(this.cache[key]==null){
		this.cache[key] = [];
	}
	if(this.cache[key][dataType]==null){
		this.cache[key][dataType] = [];
	}

	if(featureDataList.constructor == Object){
		if(this.gzip) {
			this.cache[key][dataType].push(RawDeflate.deflate(JSON.stringify(featureDataList)));
		}else{
			this.cache[key][dataType].push(featureDataList);
		}
	}else{
		for(var index = 0, len = featureDataList.length; index<len; index++) {
			feature = featureDataList[index];
			if(this.gzip) {
				this.cache[key][dataType].push(RawDeflate.deflate(JSON.stringify(feature)));
			}else{
				this.cache[key][dataType].push(feature);
			}
		}
	}
	
};

*/


//NOT USED dev not tested
//FileFeatureCache.prototype.histogram = function(region, interval){
//
	//var intervals = (region.end-region.start+1)/interval;
	//var intervalList = [];
	//
	//for ( var i = 0; i < intervals; i++) {
		//var featuresInterval = 0;
		//
		//var intervalStart = i*interval;//deberia empezar en 1...
		//var intervalEnd = ((i+1)*interval)-1;
		//
		//var firstChunk = this._getChunk(intervalStart+region.start);
		//var lastChunk = this._getChunk(intervalEnd+region.start);
		//
		//console.log(this.cache);
		//for(var j=firstChunk; j<=lastChunk; j++){
			//var key = region.chromosome+":"+j;
			//console.log(key);
			//console.log(this.cache[key]);
			//for ( var k = 0, len = this.cache[key].length; k < len; k++) {
				//if(this.gzip) {
					//feature = JSON.parse(RawDeflate.inflate(this.cache[key][k]));
				//}else{
					//feature = this.cache[key][k];
				//}
				//if(feature.start > intervalStart && feature.start < intervalEnd);
				//featuresInterval++;
			//}
			//
		//}
		//intervalList[i]=featuresInterval;
		//
		//if(this.maxFeaturesInterval<featuresInterval){
			//this.maxFeaturesInterval = featuresInterval;
		//}
	//}
	//
	//for ( var inter in  intervalList) {
		//intervalList[inter]=intervalList[inter]/this.maxFeaturesInterval;
	//}
//};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

BamCache.prototype.putHistogramFeaturesByRegion = FileFeatureCache.prototype.putFeaturesByRegion;

function BamCache(args) {
	this.args = args;
	this.id = Math.round(Math.random() * 10000000); // internal id for this class

	this.chunkSize = 50000;
	this.gzip = true;
	this.maxSize = 10*1024*1024;
	this.size = 0;
	
	if (args != null){
		if(args.chunkSize != null){
			this.chunkSize = args.chunkSize;
		}
		if(args.gzip != null){
			this.gzip = args.gzip;
		}
	}
	
	this.cache = {};

	//deprecated trackSvg has this object now
	//this.chunksDisplayed = {};
	
	this.maxFeaturesInterval = 0;//for local histogram
	
	//XXX
	this.gzip = false;
};

BamCache.prototype._getChunk = function(position){
	return Math.floor(position/this.chunkSize);
};

//new 
BamCache.prototype.getFeatureChunk = function(key){
	if(this.cache[key] != null) {
		return this.cache[key];
	}
	return null;
};
//new
BamCache.prototype.getFeatureChunksByRegion = function(region){
	var firstRegionChunk, lastRegionChunk,  chunks = [], key;
	firstRegionChunk = this._getChunk(region.start);
	lastRegionChunk = this._getChunk(region.end);
	for(var i=firstRegionChunk; i<=lastRegionChunk; i++){
		key = region.chromosome+":"+i;
		// check if this key exists in cache (features from files)
		if(this.cache[key] != null ){
			chunks.push(this.cache[key]);
		}
		
	}
	//if(chunks.length == 0){
		//return null;
	//}
	return chunks;
};



BamCache.prototype.putFeaturesByRegion = function(resultObj, region, featureType, dataType){
	var key, firstChunk, lastChunk, firstRegionChunk, lastRegionChunk, read, gzipRead;
	var reads = resultObj.reads;
	var coverage = resultObj.coverage;
	
	//initialize region
	firstRegionChunk = this._getChunk(region.start);
	lastRegionChunk = this._getChunk(region.end);
	
	var chunkIndex = 0;
	console.time("BamCache.prototype.putFeaturesByRegion1")
	//TODO the region for now is a chunk region, so this for is always 1 loop
	for(var i=firstRegionChunk, c=0; i<=lastRegionChunk; i++, c++){
		key = region.chromosome+":"+i;
		if(this.cache[key]==null || this.cache[key][dataType] == null){
			this.cache[key] = {};
			this.cache[key][dataType] = [];
			this.cache[key].key = key;
			this.cache[key].start = parseInt(region.start)+(c*this.chunkSize);
			this.cache[key].end = parseInt(region.start)+((c+1)*this.chunkSize)-1;
		}
        if(dataType === 'data'){
            //divide the coverage array in multiple arrays of chunksize length
    //		var chunkCoverage = coverage.slice(chunkIndex,chunkIndex+this.chunkSize);
            var chunkCoverageAll = coverage.all.slice(chunkIndex,chunkIndex+this.chunkSize);
            var chunkCoverageA = coverage.a.slice(chunkIndex,chunkIndex+this.chunkSize);
            var chunkCoverageC = coverage.c.slice(chunkIndex,chunkIndex+this.chunkSize);
            var chunkCoverageG = coverage.g.slice(chunkIndex,chunkIndex+this.chunkSize);
            var chunkCoverageT = coverage.t.slice(chunkIndex,chunkIndex+this.chunkSize);
            var chunkCoverage = {
                "all":chunkCoverageAll,
                "a":chunkCoverageA,
                "c":chunkCoverageC,
                "g":chunkCoverageG,
                "t":chunkCoverageT
            };
        }

		if(this.gzip) {
			this.cache[key]["coverage"]=RawDeflate.deflate(JSON.stringify(chunkCoverage));
		}else{
			this.cache[key]["coverage"]=chunkCoverage;
		}
		chunkIndex+=this.chunkSize;
	}
	console.timeEnd("BamCache.prototype.putFeaturesByRegion1")
	console.time("BamCache.prototype.putFeaturesByRegion")
	var ssss = 0;


    if(dataType === 'data'){
        for(var index = 0, len = reads.length; index<len; index++) {
            read = reads[index];
            read.featureType = 'bam';
            firstChunk = this._getChunk(read.start);
            lastChunk = this._getChunk(read.end == 0?read.end=-1:read.end);//0 is not a position, i set to -1 to avoid enter in for
    //		Some reads has end = 0. So will not be drawn IGV does not draw those reads

            if(this.gzip) {
                gzipRead = RawDeflate.deflate(JSON.stringify(read));
                //ssss+= gzipRead.length;
            }else{
                gzipRead = read;
                //ssss+= JSON.stringify(gzipRead).length;
            }

            for(var i=firstChunk, c=0; i<=lastChunk; i++, c++) {
                if(i >= firstRegionChunk && i<= lastRegionChunk){//only if is inside the called region
                    key = read.chromosome+":"+i;
//                    if(this.cache[key].start==null){
//                        this.cache[key].start = parseInt(region.start)+(c*this.chunkSize);
//                    }
//                    if(this.cache[key].end==null){
//                        this.cache[key].end = parseInt(region.start)+((c+1)*this.chunkSize)-1;
//                    }
//                    if(this.cache[key][dataType] != null){
//                        this.cache[key][dataType] = [];
                        this.cache[key][dataType].push(gzipRead);
//                    }

                }
            }
        }
    }


	console.timeEnd("BamCache.prototype.putFeaturesByRegion");
	console.log("BamCache.prototype.putFeaturesByRegion"+ssss)
};

BamCache.prototype.clear = function(){
	this.size = 0;		
	this.cache = {};
	console.log("bamCache cleared")
};

/*
BamCache.prototype.getFeaturesByChunk = function(key, dataType){
	var features =  [];
	var feature, firstChunk, lastChunk, chunk;
	var chr = key.split(":")[0], chunkId = key.split(":")[1];
	var region = {chromosome:chr,start:chunkId*this.chunkSize,end:chunkId*this.chunkSize+this.chunkSize-1};
	
	if(this.cache[key] != null && this.cache[key][dataType] != null) {
		if(this.gzip) {
			coverage = JSON.parse(RawDeflate.inflate(this.cache[key]["coverage"]));
		}else{
			coverage = this.cache[key]["coverage"];
		}
		
		for ( var i = 0, len = this.cache[key]["data"].length; i < len; i++) {
			if(this.gzip) {
				feature = JSON.parse(RawDeflate.inflate(this.cache[key]["data"][i]));
			}else{
				feature = this.cache[key]["data"][i];
			}
			
			//check if any feature chunk has been already displayed 
			var displayed = false;
			firstChunk = this._getChunk(feature.start);
			lastChunk = this._getChunk(feature.end);
			for(var f=firstChunk; f<=lastChunk; f++){
				var fkey = feature.chromosome+":"+f;
				if(this.chunksDisplayed[fkey+dataType]==true){
					displayed = true;
					break;
				}
			}
			
			if(!displayed){
				features.push(feature);
				returnNull = false;
			}
		}
		this.chunksDisplayed[key+dataType]=true;
		chunk = {reads:features,coverage:coverage,region:region};
		return chunk;
	}
	
};

BamCache.prototype.getFeaturesByRegion = function(region, dataType){
	var firstRegionChunk, lastRegionChunk, firstChunk, lastChunk, chunks = [], feature, key, coverage, features = [], displayed;
	firstRegionChunk = this._getChunk(region.start);
	lastRegionChunk = this._getChunk(region.end);
	for(var i=firstRegionChunk; i<=lastRegionChunk; i++){
		key = region.chromosome+":"+i;
		if(this.cache[key] != null){
			if(this.gzip) {
				coverage = JSON.parse(RawDeflate.inflate(this.cache[key]["coverage"]));
			}else{
				coverage = this.cache[key]["coverage"];
			}

			for ( var j = 0, len = this.cache[key]["data"].length; j < len; j++) {
				if(this.gzip) {
					feature = JSON.parse(RawDeflate.inflate(this.cache[key]["data"][j]));
				}else{
					feature = this.cache[key]["data"][j];
				}
				
				
//				check if any feature chunk has been already displayed 
				displayed = false;
				firstChunk = this._getChunk(feature.start);
				lastChunk = this._getChunk(feature.end);
				for(var f=firstChunk; f<=lastChunk; f++){
					var fkey = region.chromosome+":"+f;
					if(this.chunksDisplayed[fkey+dataType]==true){
						displayed = true;
						break;
					}
				}
				
				if(!displayed){
					features.push(feature);
				}
				
			}
		}
		this.chunksDisplayed[key+dataType]=true;//mark chunk as displayed
		chunks.push({reads:features,coverage:coverage,region:region});
	}
	return chunks;
};
*/



//BamCache.prototype.remove = function(region){
//	var firstChunk = this._getChunk(region.start);
//	var lastChunk = this._getChunk(region.end);
//	for(var i=firstChunk; i<=lastChunk; i++){
//		var key = region.chromosome+":"+i;
//		this.cache[key] = null;
//	}
//};
//

//
//BamCache.prototype.clearType = function(dataType){
//	this.cache[dataType] = null;
//};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function NavigationBar(args) {

    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    var _this = this;

    this.id = Utils.genId("NavigationBar");

    this.target;
    this.autoRender = true;

    this.cellBaseHost = 'http://bioinfo.hpc.cam.ac.uk/cellbase';
    this.cellBaseVersion = 'v3';

    this.species = 'Homo sapiens';
    this.increment = 3;
    this.componentsConfig = {
        menuButton: false,
        leftSideButton: false,
        restoreDefaultRegionButton: true,
        regionHistoryButton: true,
        speciesButton: true,
        chromosomesButton: true,
        karyotypeButtonLabel: true,
        chromosomeButtonLabel: true,
        regionButtonLabel: true,
        zoomControl: true,
        windowSizeControl: true,
        positionControl: true,
        moveControl: true,
        autoheightButton: true,
        compactButton: true,
        searchControl: true
    };
    this.zoom = 100;

    this.quickSearchDisplayKey = 'name';


    _.extend(this.componentsConfig, args.componentsConfig);
    delete args.componentsConfig;

    //set instantiation args, must be last
    _.extend(this, args);


    //set new region object
    this.region = new Region(this.region);

    this.currentChromosomeList = [];

    this.on(this.handlers);


    this.els = {};
    this.zoomChanging = false;
    this.regionChanging = false;

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }
};

NavigationBar.prototype = {

    render: function() {
        var _this = this;


        var HTML = '' +
            '<div title="Restore previous region" style="margin-right: 5px;" id="leftSideButton" class="ocb-ctrl"><i class="fa fa-navicon"></i></div>' +
            '<div id="restoreDefaultRegionButton" class="ocb-ctrl"><i class="fa fa-repeat"></i></div>' +

            '<div title="Region history" class="ocb-dropdown" style="margin-left: 5px">' +
            '   <div tabindex="-1" id="regionHistoryButton" class="ocb-ctrl"><i class="fa fa-history"></i> <i class="fa fa-caret-down"></i></div>' +
            '   <ul id="regionHistoryMenu"></ul>' +
            '</div>' +

            '<div title="Species menu" class="ocb-dropdown" style="margin-left: 5px">' +
            '   <div tabindex="-1" id="speciesButton" class="ocb-ctrl"><span id="speciesText"></span> <i class="fa fa-caret-down"></i></div>' +
            '   <ul id="speciesMenu"></ul>' +
            '</div>' +

            '<div title="Chromosomes menu" class="ocb-dropdown" style="margin-left: 5px">' +
            '   <div tabindex="-1" id="chromosomesButton" class="ocb-ctrl"><span id="chromosomesText"></span> <i class="fa fa-caret-down"></i></div>' +
            '   <ul id="chromosomesMenu" style="height: 200px; overflow-y: auto;"></ul>' +
            '</div>' +

            '<div style="margin-left: 5px; float: left; " >' +
            '   <label title="Toggle karyotype panel" class="ocb-ctrl" id="karyotypeButtonLabel"><input id="karyotypeButton" type="checkbox"><span style="border-right: none"><span class="ocb-icon ocb-icon-karyotype"></span></span></label>' +
            '   <label title="Toggle chromosome panel" class="ocb-ctrl" id="chromosomeButtonLabel"><input id="chromosomeButton" type="checkbox"><span style="border-right: none"><span class="ocb-icon ocb-icon-chromosome"></span></span></label>' +
            '   <label title="Toggle overview panel" class="ocb-ctrl" id="regionButtonLabel"><input id="regionButton" type="checkbox"><span><span class="ocb-icon ocb-icon-region"></span></span></label>' +
            '</div>' +


            '<div id="zoomControl" style="float:left;">' +
            '<div title="Minimum window size" id="zoomMinButton" class="ocb-ctrl" style="margin-left: 5px;border-right: none;">Min</div>' +
            '<div title="Decrease window size" id="zoomOutButton" class="ocb-ctrl"><span class="fa fa-minus"></span></div>' +
            '<div id="progressBarCont" class="ocb-zoom-bar">' +
            '   <div id="progressBar" class="back"></div>' +
            '   <div id="progressBar" class="rect" style="width: ' + this.zoom + '%"></div>' +
            '   <div id="progressBarBall" class="ball" style="left: ' + this.zoom + '%"></div>' +
            '</div>' +
            '<div title="Increase window size" id="zoomInButton" class="ocb-ctrl" style="border-right: none;"><span class="fa fa-plus"></span></div>' +
            '<div title="Maximum window size" id="zoomMaxButton" class="ocb-ctrl">Max</div>' +
            '</div>' +


            '<div title="Window size (Nucleotides)" id="windowSizeControl" style="float:left;margin-left: 5px;">' +
                //'<div class="ocb-ctrl-label" style="border-right: none;">Window size:</div>' +
            '<input id="windowSizeField" class="ocb-ctrl"  type="text" style="width: 70px;">' +
            '</div>' +


            '<div title="Position" id="positionControl" style="float:left;margin-left: 5px">' +
                //'<div class="ocb-ctrl-label" id="regionLabel" style="border-right: none;margin-left: 5px;transition:all 0.5s">Position:</div>' +
            '<input id="regionField" class="ocb-ctrl" placeholder="1:10000-20000" type="text" style="width: 170px;">' +
            '<div id="goButton" class="ocb-ctrl" style="border-left: none;">Go!</div>' +
            '</div>' +


            '<div id="moveControl" style="float:left;font-size:18px;">' +
            '<div id="moveFurtherLeftButton" class="ocb-ctrl" style="border-right: none;margin-left: 5px;"><i class="fa fa-angle-double-left"></i></div>' +
            '<div id="moveLeftButton" class="ocb-ctrl" style="border-right: none;"><i class="fa fa-angle-left"></i></div>' +
            '<div id="moveRightButton" class="ocb-ctrl" style="border-right: none;"><i class="fa fa-angle-right"></i></div>' +
            '<div id="moveFurtherRightButton" class="ocb-ctrl"><i class="fa fa-angle-double-right"></i></div>' +
            '</div>' +


//            '<div id="autoheightButton" class="ocb-ctrl" style="margin-left: 5px;font-size:18px;"><i class="fa fa-compress"></i></div>' +
            '<label class="ocb-ctrl"><input type="checkbox" id="autoheightButton"><span style="margin-left: 5px;font-size:18px;"><i class="fa fa-compress"></i></span></label>' +
//            '<div id="compactButton" class="ocb-ctrl" style="margin-left: 5px;font-size:18px;"><i class="fa fa-expand"></i></div>' +


            '<div id="searchControl" style="float:left;">' +
            //'<div class="ocb-ctrl-label" style="border-right: none;margin-left: 5px;"></div>' +
            '<input id="searchField" class="ocb-ctrl"  list="searchDataList"  placeholder="gene" type="text" style="width: 90px;margin-left: 5px;">' +
            '       <datalist id="searchDataList">' +
            '       </datalist>' +
            '<div id="quickSearchButton" class="ocb-ctrl" style="border-left: none;"><i class="fa fa-search"></i></div>' +
            '</div>' +


            '<div style="float:right;margin-right:10px;" id="menuButton" class="ocb-ctrl"><i class="fa fa-navicon"></i> Configure</div>' +
            '';

        /**************/
        this.div = document.createElement('div');
        this.div.setAttribute('class', "ocb-gv-navigation-bar unselectable");
        this.div.innerHTML = HTML;

        var els = this.div.querySelectorAll('[id]');
        for (var i = 0; i < els.length; i++) {
            var elid = els[i].getAttribute('id');
            if (elid) {
                this.els[elid] = els[i];
            }
        }
        /**************/


        /**Check components config**/
        for (var key in this.componentsConfig) {
            if (!this.componentsConfig[key]) {
                this.els[key].classList.add('hidden');
            }
        }
        /*****/

        this.els.karyotypeButton.checked = (this.karyotypePanelConfig.hidden) ? false : true;
        this.els.chromosomeButton.checked = (this.chromosomePanelConfig.hidden) ? false : true;
        this.els.regionButton.checked = (this.regionPanelConfig.hidden) ? false : true;


        /*** ***/

        this.els.menuButton.addEventListener('click', function(e) {
            _this.trigger('menuButton:click', {clickEvent: e, sender: {}})
        });

        this.els.leftSideButton.addEventListener('click', function(e) {
            _this.trigger('leftSideButton:click', {clickEvent: e, sender: {}})
        });

        this.els.restoreDefaultRegionButton.addEventListener('click', function(e) {
            _this.trigger('restoreDefaultRegion:click', {clickEvent: e, sender: {}})
        });


        this._addRegionHistoryMenuItem(this.region);
        this._setChromosomeMenu();
        this._setSpeciesMenu();
        this.els.chromosomesText.textContent = this.region.chromosome;
        this.els.speciesText.textContent = this.species.scientificName;


        this.els.karyotypeButton.addEventListener('click', function() {
            _this.trigger('karyotype-button:change', {selected: this.checked, sender: _this});
        });
        this.els.chromosomeButton.addEventListener('click', function() {
            _this.trigger('chromosome-button:change', {selected: this.checked, sender: _this});
        });
        this.els.regionButton.addEventListener('click', function() {
            _this.trigger('region-button:change', {selected: this.checked, sender: _this});
        });


        this.els.zoomOutButton.addEventListener('click', function() {
            _this._handleZoomOutButton();
        });
        this.els.zoomInButton.addEventListener('click', function() {
            _this._handleZoomInButton();
        });
        this.els.zoomMaxButton.addEventListener('click', function() {
            _this._handleZoomSlider(100);
        });
        this.els.zoomMinButton.addEventListener('click', function() {
            _this._handleZoomSlider(0);
        });


        var zoomBarMove = function(e) {
            var progressBarCont = _this.els.progressBarCont;
            var br = progressBarCont.getBoundingClientRect();
            var offsetX = e.clientX - br.left;
            var zoom = 100 / parseInt(getComputedStyle(progressBarCont).width) * offsetX;
            if (zoom > 0 && zoom < 100) {
                _this.els.progressBarBall.style.left = zoom + '%';
            }
        };
        this.els.progressBarCont.addEventListener('click', function(e) {
            var br = this.getBoundingClientRect();
            var offsetX = e.clientX - br.left;
            var zoom = 100 / parseInt(getComputedStyle(this).width) * offsetX;
            _this._handleZoomSlider(zoom);

            this.removeEventListener('mousemove', zoomBarMove);
        });
        this.els.progressBarBall.addEventListener('mousedown', function(e) {
            _this.els.progressBarCont.addEventListener('mousemove', zoomBarMove);
        });
        this.els.progressBarBall.addEventListener('mouseleave', function(e) {
            _this.els.progressBarCont.removeEventListener('mousemove', zoomBarMove);
            _this.els.progressBarBall.style.left = _this.zoom + '%';
        });

        this.els.regionField.value = this.region.toString();
        this.els.regionField.addEventListener('keyup', function(event) {
            if (_this._checkRegion(this.value) && event.which === 13) {
                _this._triggerRegionChange({region: new Region(this.value), sender: this});
            }
        });
        this.els.goButton.addEventListener('click', function() {
            var value = _this.els.regionField.value;
            if (_this._checkRegion(value)) {
                _this._triggerRegionChange({region: new Region(value), sender: this});
            }
        });

        this.els.moveFurtherLeftButton.addEventListener('click', function() {
            _this._handleMoveRegion(10);
        });

        this.els.moveFurtherRightButton.addEventListener('click', function() {
            _this._handleMoveRegion(-10);
        });

        this.els.moveLeftButton.addEventListener('click', function() {
            _this._handleMoveRegion(1);
        });

        this.els.moveRightButton.addEventListener('click', function() {
            _this._handleMoveRegion(-1);
        });

//        this.els.autoheightButton.addEventListener('click', function (e) {
//            _this.trigger('autoHeight-button:click', {clickEvent: e, sender: _this});
//        });
        this.els.autoheightButton.addEventListener('click', function() {
            _this.trigger('autoHeight-button:change', {selected: this.checked, sender: _this});
        });

//        this.els.compactButton.addEventListener('click', function (e) {
//        });


        var lastQuery = '';
        this.els.searchField.addEventListener('keyup', function(event) {
            this.classList.remove('error');
            var query = this.value;
            if (query.length > 2 && lastQuery !== query && event.which !== 13) {
                _this._setQuickSearchMenu(query);
                lastQuery = query;
            }
            if (event.which === 13) {
                var item = _this.quickSearchDataset[query];
                if (item) {
                    _this.trigger('quickSearch:select', {item: item, sender: _this});
                } else {
                    this.classList.add('error');
                }
            }
        });

        this.els.quickSearchButton.addEventListener('click', function() {
            _this.els.searchField.classList.remove('error');
            var query = _this.els.searchField.value;
            var item = _this.quickSearchDataset[query];
            if (item) {
                _this.trigger('quickSearch:go', {item: item, sender: _this});
            } else {
                _this.els.searchField.classList.add('error');
            }
        });

        this.els.windowSizeField.value = this.region.length();
        this.els.windowSizeField.addEventListener('keyup', function(event) {
            var value = this.value;
            var pattern = /^([0-9])+$/;
            if (pattern.test(value)) {
                this.classList.remove('error');
                if (event.which === 13) {
                    var regionSize = parseInt(value);
                    var haflRegionSize = Math.floor(regionSize / 2);
                    var region = new Region({
                        chromosome: _this.region.chromosome,
                        start: _this.region.center() - haflRegionSize,
                        end: _this.region.center() + haflRegionSize
                    });
                    _this._triggerRegionChange({region: region, sender: _this})
                }
            } else {
                this.classList.add('error');
            }
        });
        this.rendered = true;
    },
    draw: function() {
        this.targetDiv = (this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);
    },

    _addRegionHistoryMenuItem: function(region) {
        var _this = this;
        var menuEntry = document.createElement('li');
        menuEntry.textContent = region.toString();
        this.els.regionHistoryMenu.appendChild(menuEntry);
        menuEntry.addEventListener('click', function() {
            _this._triggerRegionChange({region: new Region(this.textContent), sender: _this})
        });
    },

    _setQuickSearchMenu: function(query) {
        if (typeof this.quickSearchResultFn === 'function') {
            while (this.els.searchDataList.firstChild) {
                this.els.searchDataList.removeChild(this.els.searchDataList.firstChild);
            }
            this.quickSearchDataset = {};
            var items = this.quickSearchResultFn(query);
//            for (var i = 0; i < items.length; i++) {
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var value = item[this.quickSearchDisplayKey];
                this.quickSearchDataset[value] = item;
                var menuEntry = document.createElement('option');
                menuEntry.setAttribute('value', value);
                this.els.searchDataList.appendChild(menuEntry);
            }
        } else {
            console.log('the quickSearchResultFn function is not valid');
        }
    },

    _setChromosomeMenu: function() {
        var _this = this;

        while (this.els.chromosomesMenu.firstChild) {
            this.els.chromosomesMenu.removeChild(this.els.chromosomesMenu.firstChild);
        }

        //find species object
        //var list = [];
        //for (var i = 0; i < this.availableSpecies.items.length; i++) {
        //    for (var j = 0; j < this.availableSpecies.items[i].items.length; j++) {
        //        var species = this.availableSpecies.items[i].items[j];
        //        if (species.text === this.species.text) {
        //            list = species.chromosomes;
        //            break;
        //        }
        //    }

        //}
        //for (var i in this.availableSpecies.items) {
        //    for (var j in this.availableSpecies.items[i].items) {
        //        var species = this.availableSpecies.items[i].items[j];
        //        if (species.text === this.species.text) {
        //            list = species.chromosomes;
        //            break;
        //        }
        //    }
        //}

        var list = [];
        for (var chr in this.species.chromosomes) {
            list.push(chr);


            var menuEntry = document.createElement('li');
            menuEntry.textContent = chr;
            this.els.chromosomesMenu.appendChild(menuEntry);

            menuEntry.addEventListener('click', function() {
                var region = new Region({
                    chromosome: this.textContent,
                    start: _this.region.start,
                    end: _this.region.end
                });
                _this._triggerRegionChange({region: region, sender: _this})
            });

        }
        this.currentChromosomeList = list;


        //for (var i in list) {
        //    var menuEntry = document.createElement('li');
        //    menuEntry.textContent = list[i];
        //    this.els.chromosomesMenu.appendChild(menuEntry);
        //
        //    menuEntry.addEventListener('click', function () {
        //        var region = new Region({
        //            chromosome: this.textContent,
        //            start: _this.region.start,
        //            end: _this.region.end
        //        });
        //        _this._triggerRegionChange({region: region, sender: _this})
        //    });
        //}
    },

//    _setSpeciesMenu: function () {
//        var _this = this;
//
//        var createEntry = function (species) {
//            var menuEntry = document.createElement('li');
//            menuEntry.textContent = species.text;
//            _this.els.speciesMenu.appendChild(menuEntry);
//
//            menuEntry.addEventListener('click', function () {
//                _this.species = species;
//                _this.els.speciesText.textContent = this.textContent;
//                _this._setChromosomeMenu();
//                _this.trigger('species:change', {species: species, sender: _this});
//            });
//        };
//        //find species object
//        var list = [];
//        for (var i in this.availableSpecies.items) {
//            for (var j in this.availableSpecies.items[i].items) {
//                var species = this.availableSpecies.items[i].items[j];
//                createEntry(species);
//            }
//        }
//    },
    _setSpeciesMenu: function() {
        var _this = this;

        var createSpeciesEntry = function(species, ul) {
            var menuEntry = document.createElement('li');
            menuEntry.textContent = species.scientificName + ' (' + species.assembly.name + ')';
            ul.appendChild(menuEntry);

            menuEntry.addEventListener('click', function() {
                _this.trigger('species:change', {species: species, sender: _this});
            });
        };

        //var createAssemblyEntry = function(assembly, ul, species) {
        //    var menuEntry = document.createElement('li');
        //    menuEntry.textContent = assembly.name;
        //    ul.appendChild(menuEntry);
        //
        //    menuEntry.addEventListener('click', function() {
        //        _this.trigger('species:change', {species: species, sender: _this});
        //    });
        //};

        var createTaxonomy = function(taxonomy) {
            var menuEntry = document.createElement('li');
            menuEntry.setAttribute('data-sub', true);
            menuEntry.textContent = taxonomy;
            _this.els.speciesMenu.appendChild(menuEntry);

            var ul = document.createElement('ul');
            menuEntry.appendChild(ul);

            return ul;
        };

        //find species object
        //var list = [];
        for (var taxonomy in this.availableSpecies) {
            var taxUl = createTaxonomy(taxonomy);
            for (var i = 0; i < this.availableSpecies[taxonomy].length; i++) {
                var species = this.availableSpecies[taxonomy][i];
                createSpeciesEntry(species, taxUl);
            }
        }
        //for (var i = 0; i < this.availableSpecies.items.length; i++) {
        //    var taxonomy = this.availableSpecies.items[i];
        //    var taxUl = createTaxonomy(taxonomy);
        //
        //    for (var j = 0; j < taxonomy.items.length; j++) {
        //        var species = taxonomy.items[j];
        //        createEntry(species, taxUl);
        //    }
        //}
    },
    _checkRegion: function(value) {
        var reg = new Region(value);
        if (!reg.parse(value) || reg.start < 0 || reg.end < 0 || _.indexOf(this.currentChromosomeList, reg.chromosome) == -1) {
            this.els.regionField.classList.add('error');
            return false;
        } else {
            this.els.regionField.classList.remove('error');
            return true;
        }
    },

    _handleZoomOutButton: function() {
        this._handleZoomSlider(Math.max(0, this.zoom - 5));
    },
    _handleZoomSlider: function(value) {
        var _this = this;
        if (!_this.zoomChanging) {
            _this.zoomChanging = true;
            /**/
            _this.zoom = 5 * (Math.round(value / 5));
            _this.trigger('zoom:change', {zoom: _this.zoom, sender: _this});
            /**/
            setTimeout(function() {
                _this.zoomChanging = false;
            }, 700);
        }
    },
    _handleZoomInButton: function() {
        this._handleZoomSlider(Math.min(100, this.zoom + 5));
    },

    _handleMoveRegion: function(positions) {
        var pixelBase = (this.width - this.svgCanvasWidthOffset) / this.region.length();
        var disp = Math.round((positions * 10) / pixelBase);
        this.region.start -= disp;
        this.region.end -= disp;
        this.els.regionField.value = this.region.toString();
        this.trigger('region:move', {region: this.region, disp: disp, sender: this});
    },

    setVisible: function(obj) {
        for (key in obj) {
            var el = this.els[key];
            if (obj[key]) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }
    },

    setRegion: function(region, zoom) {
        this.region.load(region);
        if (zoom) {
            this.zoom = 5 * (Math.round(zoom / 5));
        }
        this.updateRegionControls();
        this._addRegionHistoryMenuItem(region);
    },
    moveRegion: function(region) {
        this.region.load(region);
        this.els.chromosomesText.textContent = this.region.chromosome;
        this.els.regionField.value = this.region.toString()
    },

    setSpecies: function(species) {
        this.species = species;
        this.els.speciesText.textContent = this.species.scientificName;
        this._setChromosomeMenu();
    },

    setWidth: function(width) {
        this.width = width;
    },
    _triggerRegionChange: function(event) {
        var _this = this;
        if (!this.regionChanging) {
            this.regionChanging = true;
            /**/
            this.trigger('region:change', event);
            /**/
            setTimeout(function() {
                _this.regionChanging = false;
            }, 700);
        } else {
            this.updateRegionControls();
        }
    },
    updateRegionControls: function() {
        this.els.chromosomesText.textContent = this.region.chromosome;
        this.els.regionField.value = this.region.toString();
        this.els.windowSizeField.value = this.region.length();
        this.els.regionField.classList.remove('error');
        this.els.progressBar.style.width = this.zoom + '%';
        this.els.progressBarBall.style.left = this.zoom + '%';
    },
    setCellBaseHost: function(host) {
        this.cellBaseHost = host;
    }

}

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function ChromosomePanel(args) {

    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.id = Utils.genId('ChromosomePanel');

    this.target;
    this.autoRender = true;
    this.cellBaseHost = 'http://bioinfo.hpc.cam.ac.uk/cellbase';
    this.cellBaseVersion = 'v3';

    this.pixelBase;
    this.species = 'hsapiens';
    this.width = 600;
    this.height = 75;
    this.collapsed = false;
    this.collapsible = false;
    this.hidden = false;

    //set instantiation args, must be last
    _.extend(this, args);

    //set own region object
    this.region = new Region(this.region);


    this.lastChromosome = "";
    this.data;

    this.on(this.handlers);

    this.regionChanging = false;

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }
};

ChromosomePanel.prototype = {
    show: function () {
        $(this.div).css({display: 'block'});
        this.hidden = false;
    },
    hide: function () {
        $(this.div).css({display: 'none'});
        this.hidden = true;
    },
    setVisible: function (bool) {
        if (bool) {
            this.show()
        } else {
            this.hide()
        }
    },
    showContent: function () {
        $(this.svg).css({display: 'inline'});
        this.collapsed = false;
        $(this.collapseDiv).removeClass('active');
        $(this.collapseDiv).children().first().removeClass('fa-plus');
        $(this.collapseDiv).children().first().addClass('fa-minus');
    },
    hideContent: function () {
        $(this.svg).css({display: 'none'});
        this.collapsed = true;
        $(this.collapseDiv).addClass('active');
        $(this.collapseDiv).children().first().removeClass('fa-minus');
        $(this.collapseDiv).children().first().addClass('fa-plus');
    },
    setTitle: function (title) {
        if ('titleDiv' in this) {
            $(this.titleTextDiv).html(title);
        }
    },
    setWidth: function (width) {
        this.width = width;
        this.svg.setAttribute("width", width);
//        this.tracksViewedRegion = this.width / Utils.getPixelBaseByZoom(this.zoom);

        if (typeof this.data !== 'undefined') {
            this.clean();
            this._drawSvg(this.data);
        }
    },

    render: function () {
        var _this = this;

        this.div = $('<div id="chromosome-panel"></div>')[0];

        if ('title' in this && this.title !== '') {
            var titleDiv = $('<div id="tl-title" class="ocb-gv-panel-title unselectable"></div>')[0];
            $(this.div).append(titleDiv);

            if (this.collapsible == true) {
                this.collapseDiv = $('<div class="ocb-gv-panel-collapse-control"><span class="fa fa-minus"></span></div>');
                $(titleDiv).dblclick(function () {
                    if (_this.collapsed) {
                        _this.showContent();
                    } else {
                        _this.hideContent();
                    }
                });
                $(this.collapseDiv).click(function () {
                    if (_this.collapsed) {
                        _this.showContent();
                    } else {
                        _this.hideContent();
                    }
                });
                $(titleDiv).append(this.collapseDiv);
            }

            this.titleTextDiv = $('<div class="ocb-gv-panel-text">' + this.title + '</div>');
            $(titleDiv).append(this.titleTextDiv);
        }

        this.svg = SVG.init(this.div, {
            "width": this.width,
            "height": this.height
        });
        $(this.div).addClass('unselectable');

        this.colors = {gneg: "#eeeeee", stalk: "#666666", gvar: "#CCCCCC", gpos25: "silver", gpos33: "lightgrey", gpos50: "gray", gpos66: "dimgray", gpos75: "darkgray", gpos100: "black", gpos: "gray", acen: "blue", clementina: '#ffc967'};


        this.setVisible(!this.hidden);
        this.rendered = true;
    },

    setSpecies: function (species) {
        this.species = species;
    },
    clean: function () {
        $(this.svg).empty();
    },
    draw: function () {
        var _this = this;
        this.targetDiv = ( this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.clean();

        CellBaseManager.get({
            host: this.cellBaseHost,
            version: this.cellBaseVersion,
            species: this.species,
            category: 'genomic',
            subCategory: 'chromosome',
            query: this.region.chromosome,
            resource: 'info',
            async: false,
            success: function (data) {
                _this.data = data.response[0].result[0].chromosomes[0];
                _this.data.cytobands.sort(function (a, b) {
                    return (a.start - b.start);
                });
                _this._drawSvg(_this.data);
            }
        });

        this.lastChromosome = this.region.chromosome;

        if (this.collapsed) {
            _this.hideContent();
        }
    },
    _drawSvg: function (chromosome) {
        // This method uses less svg elements
        var _this = this;
        var offset = 20;
        var group = SVG.addChild(_this.svg, "g", {"cursor": "pointer"});
        this.chromosomeLength = chromosome.size;
        this.pixelBase = (this.width - 40) / this.chromosomeLength;

        /**/
        /*Draw Chromosome*/
        /**/
        var backrect = SVG.addChild(group, 'rect', {
            'x': offset,
            'y': 4,
            'width': this.width - 40 + 1,
            'height': 22,
            'fill': '#555555'
        });

        var cytobandsByStain = {};
        var textDrawingOffset = offset;
        for (var i = 0; i < chromosome.cytobands.length; i++) {
            var cytoband = chromosome.cytobands[i];
            cytoband.pixelStart = cytoband.start * this.pixelBase;
            cytoband.pixelEnd = cytoband.end * this.pixelBase;
            cytoband.pixelSize = cytoband.pixelEnd - cytoband.pixelStart;

            if (typeof cytobandsByStain[cytoband.stain] == 'undefined') {
                cytobandsByStain[cytoband.stain] = [];
            }
            cytobandsByStain[cytoband.stain].push(cytoband);

            var middleX = textDrawingOffset + (cytoband.pixelSize / 2);
            var textY = 28;
            var text = SVG.addChild(group, "text", {
                "x": middleX,
                "y": textY,
                "font-size": 10,
                "transform": "rotate(90, " + middleX + ", " + textY + ")",
                "fill": "black"
            });
            text.textContent = cytoband.name;
            textDrawingOffset += cytoband.pixelSize;
        }

        for (var cytobandStain in cytobandsByStain) {
            var cytobands_d = '';
            if (cytobandStain != 'acen') {
                for (var j = 0; j < cytobandsByStain[cytobandStain].length; j++) {
                    var cytoband = cytobandsByStain[cytobandStain][j];
                    cytobands_d += 'M' + (cytoband.pixelStart + offset + 1) + ',15' + ' L' + (cytoband.pixelEnd + offset) + ',15 ';
                }
                var path = SVG.addChild(group, 'path', {
                    "d": cytobands_d,
                    "stroke": this.colors[cytobandStain],
//                "stroke": 'red',
                    "stroke-width": 20,
                    "fill": 'none'
                });
            }
        }

        if (typeof cytobandsByStain['acen'] !== 'undefined') {
            var firstStain = cytobandsByStain['acen'][0];
            var lastStain = cytobandsByStain['acen'][1];
            var backrect = SVG.addChild(group, 'rect', {
                'x': (firstStain.pixelStart + offset + 1),
                'y': 4,
                'width': (lastStain.pixelEnd + offset) - (firstStain.pixelStart + offset + 1),
                'height': 22,
                'fill': 'white'
            });
            var firstStainXStart = (firstStain.pixelStart + offset + 1);
            var firstStainXEnd = (firstStain.pixelEnd + offset);
            var lastStainXStart = (lastStain.pixelStart + offset + 1);
            var lastStainXEnd = (lastStain.pixelEnd + offset);
            var path = SVG.addChild(group, 'path', {
                'd': 'M' + firstStainXStart + ',4' + ' L' + (firstStainXEnd - 5) + ',4 ' + ' L' + firstStainXEnd + ',15 ' + ' L ' + (firstStainXEnd - 5) + ',26 ' + ' L ' + firstStainXStart + ',26 z',
                'fill': this.colors['acen']
            });
            var path = SVG.addChild(group, 'path', {
                'd': 'M' + lastStainXStart + ',15' + ' L' + (lastStainXStart + 5) + ',4 ' + ' L' + lastStainXEnd + ',4 ' + ' L ' + lastStainXEnd + ',26 ' + ' L ' + (lastStainXStart + 5) + ',26 z',
                'fill': this.colors['acen']
            });
        }


        /**/
        /* Resize elements and events*/
        /**/
        var status = '';
        var centerPosition = _this.region.center();
        var pointerPosition = (centerPosition * _this.pixelBase) + offset;
        $(this.svg).on('mousedown', function (event) {
            status = 'setRegion';
        });

        // selection box, will appear when selection is detected
        this.selBox = SVG.addChild(this.svg, "rect", {
            "x": 0,
            "y": 2,
            "stroke-width": "2",
            "stroke": "deepskyblue",
            "opacity": "0.5",
            "fill": "honeydew"
        });


        var positionBoxWidth = _this.region.length() * _this.pixelBase;
        var positionGroup = SVG.addChild(group, 'g');
        this.positionBox = SVG.addChild(positionGroup, 'rect', {
            'x': pointerPosition - (positionBoxWidth / 2),
            'y': 2,
            'width': positionBoxWidth,
            'height': _this.height - 3,
            'stroke': 'orangered',
            'stroke-width': 2,
            'opacity': 0.5,
            'fill': 'navajowhite',
            'cursor': 'move'
        });
        $(this.positionBox).on('mousedown', function (event) {
            status = 'movePositionBox';
        });


        this.resizeLeft = SVG.addChild(positionGroup, 'rect', {
            'x': pointerPosition - (positionBoxWidth / 2),
            'y': 2,
            'width': 7,
            'height': _this.height - 3,
            'opacity': 0.5,
            'fill': 'orangered',
            'visibility': 'hidden'
        });
        $(this.resizeLeft).on('mousedown', function (event) {
            status = 'resizePositionBoxLeft';
        });

        this.resizeRight = SVG.addChild(positionGroup, 'rect', {
            'x': positionBoxWidth - 5,
            'y': 2,
            'width': 7,
            'height': _this.height - 3,
            'opacity': 0.5,
            'fill': 'orangered',
            'visibility': 'hidden'
        });
        $(this.resizeRight).on('mousedown', function (event) {
            status = 'resizePositionBoxRight';
        });

        $(this.positionBox).off('mouseenter');
        $(this.positionBox).off('mouseleave');

        $(positionGroup).mouseenter(function (event) {
            _this._recalculateResizeControls();
            _this._showResizeControls();
        });
        $(positionGroup).mouseleave(function (event) {
            _this._hideResizeControls();
        });


        /*Remove event listeners*/
        $(this.svg).off('contextmenu');
        $(this.svg).off('mousedown');
        $(this.svg).off('mouseup');
        $(this.svg).off('mousemove');
        $(this.svg).off('mouseleave');

        //Prevent browser context menu
        $(this.svg).contextmenu(function (e) {
            e.preventDefault();
        });
        var downY, downX, moveX, moveY, lastX, increment;

        $(this.svg).mousedown(function (event) {

            downX = (event.clientX - $(this).parent().offset().left); //using parent offset works well on firefox and chrome. Could be because it is a div instead of svg
            _this.selBox.setAttribute("x", downX);
            lastX = _this.positionBox.getAttribute("x");
            if (status == '') {
                status = 'setRegion'
            }
            _this._hideResizeControls();
            $(this).mousemove(function (event) {
                moveX = (event.clientX - $(this).parent().offset().left); //using parent offset works well on firefox and chrome. Could be because it is a div instead of svg
                _this._hideResizeControls();
                switch (status) {
                    case 'resizePositionBoxLeft' :
                        var inc = moveX - downX;
                        var newWidth = parseInt(_this.positionBox.getAttribute("width")) - inc;
                        if (newWidth > 0) {
                            _this.positionBox.setAttribute("x", parseInt(_this.positionBox.getAttribute("x")) + inc);
                            _this.positionBox.setAttribute("width", newWidth);
                        }
                        downX = moveX;
                        break;
                    case 'resizePositionBoxRight' :
                        var inc = moveX - downX;
                        SVG
                        var newWidth = parseInt(_this.positionBox.getAttribute("width")) + inc;
                        if (newWidth > 0) {
                            _this.positionBox.setAttribute("width", newWidth);
                        }
                        downX = moveX;
                        break;
                    case 'movePositionBox' :
                        var inc = moveX - downX;
                        _this.positionBox.setAttribute("x", parseInt(_this.positionBox.getAttribute("x")) + inc);
                        downX = moveX;
                        break;
                    case 'setRegion':
                    case 'selectingRegion' :
                        status = 'selectingRegion';
                        if (moveX < downX) {
                            _this.selBox.setAttribute("x", moveX);
                        }
                        _this.selBox.setAttribute("width", Math.abs(moveX - downX));
                        _this.selBox.setAttribute("height", _this.height - 3);
                        break;
                }

            });
        });


        $(this.svg).mouseup(function (event) {

            $(this).off('mousemove');
            if (downX != null) {

                switch (status) {
                    case 'resizePositionBoxLeft' :
                    case 'resizePositionBoxRight' :
                    case 'movePositionBox' :
                        if (moveX != null) {
                            var w = parseInt(_this.positionBox.getAttribute("width"));
                            var x = parseInt(_this.positionBox.getAttribute("x"));

                            var pixS = x;
                            var pixE = x + w;
                            var bioS = (pixS - offset) / _this.pixelBase;
                            var bioE = (pixE - offset) / _this.pixelBase;

                            _this._triggerRegionChange({region: new Region({chromosome: _this.region.chromosome, start: bioS, end: bioE}), sender: _this});
                        }
                        break;
                    case 'setRegion' :
                        if (downX > offset && downX < (_this.width - offset)) {
                            var w = _this.positionBox.getAttribute("width");

                            var pixS = downX - (w / 2);
                            var pixE = downX + (w / 2);
                            var bioS = (pixS - offset) / _this.pixelBase;
                            var bioE = (pixE - offset) / _this.pixelBase;

                            _this._triggerRegionChange({region: new Region({chromosome: _this.region.chromosome, start: bioS, end: bioE}), sender: _this});
                        }
                        break;
                    case 'selectingRegion' :
                        var bioS = (downX - offset) / _this.pixelBase;
                        var bioE = (moveX - offset) / _this.pixelBase;
                        var start = Math.min(bioS, bioE);
                        var end = Math.max(bioS, bioE);

                        _this.selBox.setAttribute("width", 0);
                        _this.selBox.setAttribute("height", 0);
                        _this._triggerRegionChange({region: new Region({chromosome: _this.region.chromosome, start: start, end: end}), sender: _this});
                        break;
                }
                status = '';

            }
            downX = null;
            moveX = null;
            lastX = _this.positionBox.getAttribute("x");
        });
        $(this.svg).mouseleave(function (event) {
            $(this).off('mousemove')
            if (lastX != null) {
                _this.positionBox.setAttribute("x", lastX);
            }
            _this.selBox.setAttribute("width", 0);
            _this.selBox.setAttribute("height", 0);
            downX = null;
            moveX = null;
            lastX = null;
            overPositionBox = false;
            movingPositionBox = false;
            selectingRegion = false;
        });
    },

    _triggerRegionChange: function (event) {
        var _this = this;
        if (!this.regionChanging) {
            this.regionChanging = true;

            /**/
            this._limitRegionToChromosome(event.region);
            this.trigger('region:change', event);
            /**/
            setTimeout(function () {
                _this.regionChanging = false;
            }, 700);
        } else {
            this.updateRegionControls();
        }
    },


    _recalculatePositionBox: function (region) {
        var genomicLength = region.length();
        var pixelWidth = genomicLength * this.pixelBase;
        var x = (region.start * this.pixelBase) + 20;//20 is the margin
        this.positionBox.setAttribute("x", x);
        this.positionBox.setAttribute("width", pixelWidth);
    },
    _recalculateSelectionBox: function (region) {
        var genomicLength = region.length();
        var pixelWidth = genomicLength * this.pixelBase;
        var x = (region.start * this.pixelBase) + 20;//20 is the margin
        this.selBox.setAttribute("x", x);
        this.selBox.setAttribute("width", pixelWidth);
    },
    _recalculateResizeControls: function () {
        var postionBoxX = parseInt(this.positionBox.getAttribute('x'));
        var postionBoxWidth = parseInt(this.positionBox.getAttribute('width'));
        this.resizeLeft.setAttribute('x', postionBoxX - 5);
        this.resizeRight.setAttribute('x', (postionBoxX + postionBoxWidth));
        $(this.resizeLeft).css({"cursor": "ew-resize"});
        $(this.resizeRight).css({"cursor": "ew-resize"});
    },
    _hideResizeControls: function () {
        this.resizeLeft.setAttribute('visibility', 'hidden');
        this.resizeRight.setAttribute('visibility', 'hidden');
    },
    _showResizeControls: function () {
        this.resizeLeft.setAttribute('visibility', 'visible');
        this.resizeRight.setAttribute('visibility', 'visible');
    },
    _limitRegionToChromosome: function (region) {
        region.start = (region.start < 1) ? 1 : region.start;
        region.end = (region.end > this.chromosomeLength) ? this.chromosomeLength : region.end;
    },

    updateRegionControls: function () {
        this.selBox.setAttribute("width", 0);
        this.selBox.setAttribute("height", 0);
        this._recalculatePositionBox(this.region);
        this._recalculateResizeControls();
    },

    setRegion: function (region) {//item.chromosome, item.region

        console.log('region modified chromosome')
        this.region.load(region);
        var needDraw = false;

        if (this.lastChromosome != this.region.chromosome) {
            needDraw = true;
        }
        if (needDraw) {
            this.draw();
        }

        this.updateRegionControls();
    },
    setCellBaseHost: function (host) {
        this.cellBaseHost = host;
    }
};
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function KaryotypePanel(args) {
    // Using Underscore 'extend' function to extend and add Backbone Events

    _.extend(this, Backbone.Events);

    this.target;
    this.autoRender = true;
    this.id = Utils.genId('KaryotypePanel');

    this.cellBaseHost = 'http://bioinfo.hpc.cam.ac.uk/cellbase';
    this.cellBaseVersion = 'v3';

    this.pixelBase;
    this.species;
    this.width = 600;
    this.height = 75;
    this.collapsed = false;
    this.collapsible = true;
    this.hidden = false;


//set instantiation args, must be last
    _.extend(this, args);

    //set own region object
    this.region = new Region(this.region);

    this.lastSpecies = this.species;

    this.chromosomeList;
    this.data2;

    this.on(this.handlers);

    this.regionChanging = false;

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }
};

KaryotypePanel.prototype = {
    show: function () {
        $(this.div).css({display: 'block'});
        this.hidden = false;
    },
    hide: function () {
        $(this.div).css({display: 'none'});
        this.hidden = true;
    },
    setVisible: function (bool) {
        if (bool) {
            this.show()
        } else {
            this.hide()
        }
    },
    showContent: function () {
        $(this.svg).css({display: 'inline'});
        this.collapsed = false;
        $(this.collapseDiv).removeClass('active');
        $(this.collapseDiv).children().first().removeClass('fa-plus');
        $(this.collapseDiv).children().first().addClass('fa-minus');
    },
    hideContent: function () {
        $(this.svg).css({display: 'none'});
        this.collapsed = true;
        $(this.collapseDiv).addClass('active');
        $(this.collapseDiv).children().first().removeClass('fa-minus');
        $(this.collapseDiv).children().first().addClass('fa-plus');
    },
    setTitle: function (title) {
        if ('titleDiv' in this) {
            $(this.titleTextDiv).html(title);
        }
    },
    setWidth: function (width) {
        this.width = width;
        this.svg.setAttribute("width", width);


        if (typeof this.chromosomeList !== 'undefined') {
            this.clean();
            this._drawSvg(this.chromosomeList, this.data2);
        }
    },

    render: function () {
        var _this = this;

        this.div = $('<div id="karyotype-panel"></div>')[0];

        if ('title' in this && this.title !== '') {

            var titleDiv = $('<div id="tl-title" class="ocb-gv-panel-title unselectable"></div>')[0];
            $(this.div).append(titleDiv);

            if (this.collapsible == true) {
                this.collapseDiv = $('<div class="ocb-gv-panel-collapse-control"><span class="fa fa-minus"></span></div>');
                $(titleDiv).dblclick(function () {
                    if (_this.collapsed) {
                        _this.showContent();
                    } else {
                        _this.hideContent();
                    }
                });
                $(this.collapseDiv).click(function () {
                    if (_this.collapsed) {
                        _this.showContent();
                    } else {
                        _this.hideContent();
                    }
                });
                $(titleDiv).append(this.collapseDiv);
            }

            this.titleTextDiv = $('<div class="ocb-gv-panel-text">' + this.title + '</div>');
            $(titleDiv).append(this.titleTextDiv);
        }

        this.svg = SVG.init(this.div, {
            "width": this.width,
            "height": this.height
        });
        this.markGroup = SVG.addChild(this.svg, "g", {"cursor": "pointer"});
        $(this.div).addClass('unselectable');

        this.colors = {gneg: "white", stalk: "#666666", gvar: "#CCCCCC", gpos25: "silver", gpos33: "lightgrey", gpos50: "gray", gpos66: "dimgray", gpos75: "darkgray", gpos100: "black", gpos: "gray", acen: "blue"};


        this.setVisible(!this.hidden);

        this.rendered = true;
    },

    setSpecies: function (species) {
        this.lastSpecies = this.species;
        this.species = species;
    },
    clean: function () {
        $(this.svg).empty();
    },
    draw: function () {
        var _this = this;
        this.targetDiv = ( this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.clean();

        var sortfunction = function (a, b) {
            var IsNumber = true;
            for (var i = 0; i < a.name.length && IsNumber == true; i++) {
                if (isNaN(a.name[i])) {
                    IsNumber = false;
                }
            }
            if (!IsNumber) return 1;
            return (a.name - b.name);
        };

        CellBaseManager.get({
            host: this.cellBaseHost,
            version: this.cellBaseVersion,
            species: this.species,
            category: 'genomic',
            subCategory: 'chromosome',
            resource: 'all',
            async: false,
            success: function (data) {
                _this.chromosomeList = data.response[0].result[0].chromosomes;
                _this.chromosomeList.sort(sortfunction);
                _this._drawSvg(_this.chromosomeList);
            }
        });

        if (this.collapsed) {
            _this.hideContent();
        }
    },

    _drawSvg: function (chromosomeList) {
        var _this = this;

        var x = 20;
        var xOffset = _this.width / chromosomeList.length;
        var yMargin = 2;

        ///////////
        var biggerChr = 0;
        for (var i = 0, len = chromosomeList.length; i < len; i++) {
            var size = chromosomeList[i].size;
            if (size > biggerChr) {
                biggerChr = size;
            }
        }
        _this.pixelBase = (_this.height - 10) / biggerChr;
        _this.chrOffsetY = {};
        _this.chrOffsetX = {};

        for (var i = 0, len = chromosomeList.length; i < len; i++) { //loop over chromosomes
            var chromosome = chromosomeList[i];

            var chrSize = chromosome.size * _this.pixelBase;
            var y = yMargin + (biggerChr * _this.pixelBase) - chrSize;
            _this.chrOffsetY[chromosome.name] = y;
            var firstCentromere = true;


            var group = SVG.addChild(_this.svg, "g", {"cursor": "pointer", "chr": chromosome.name});
            $(group).click(function (event) {
                var chrClicked = this.getAttribute("chr");
                //			for ( var k=0, len=chromosomeList.length; k<len; k++) {
                //			var offsetX = (event.pageX - $(_this.svg).offset().left);
                //			if(offsetX > _this.chrOffsetX[chromosomeList[k]]) chrClicked = chromosomeList[k];
                //			}

                var offsetY = (event.pageY - $(_this.svg).offset().top);
                //			var offsetY = event.originalEvent.layerY - 3;

                var clickPosition = parseInt((offsetY - _this.chrOffsetY[chrClicked]) / _this.pixelBase);
                var region = new Region({
                    chromosome: chrClicked,
                    start: clickPosition,
                    end: clickPosition
                });
                _this._triggerRegionChange({region: region, sender: _this});
            });

            for (var j = 0, lenJ = chromosome.cytobands.length; j < lenJ; j++) { //loop over chromosome objects
                var cytoband = chromosome.cytobands[j];
                var height = _this.pixelBase * (cytoband.end - cytoband.start);
                var width = 13;

                var color = _this.colors[cytoband.stain];
                if (color == null) color = "purple";

                if (cytoband.stain == "acen") {
                    var points = "";
                    var middleX = x + width / 2;
                    var middleY = y + height / 2;
                    var endX = x + width;
                    var endY = y + height;
                    if (firstCentromere) {
                        points = x + "," + y + " " + endX + "," + y + " " + endX + "," + middleY + " " + middleX + "," + endY + " " + x + "," + middleY;
                        firstCentromere = false;
                    } else {
                        points = x + "," + endY + " " + x + "," + middleY + " " + middleX + "," + y + " " + endX + "," + middleY + " " + endX + "," + endY;
                    }
                    SVG.addChild(group, "polyline", {
                        "points": points,
                        "stroke": "black",
                        "opacity": 0.8,
                        "fill": color
                    });
                } else {
                    SVG.addChild(group, "rect", {
                        "x": x,
                        "y": y,
                        "width": width,
                        "height": height,
                        "stroke": "grey",
                        "opacity": 0.8,
                        "fill": color
                    });
                }

                y += height;
            }
            var text = SVG.addChild(_this.svg, "text", {
                "x": x + 1,
                "y": _this.height,
                "font-size": 9,
                "fill": "black"
            });
            text.textContent = chromosome.name;

            _this.chrOffsetX[chromosome.name] = x;
            x += xOffset;
        }


        this.positionBox = SVG.addChild(this.svg, "line", {
            "x1": 0,
            "y1": 0,
            "x2": 0,
            "y2": 0,
            "stroke": "orangered",
            "stroke-width": 2,
            "opacity": 0.5
        });
        this._recalculatePositionBox(this.region);


        this.rendered = true;
        this.trigger('after:render', {sender: this});
    },


    _triggerRegionChange: function (event) {
        var _this = this;
        if (!this.regionChanging) {
            this.regionChanging = true;
            /**/
            this.trigger('region:change', event);
            /**/
            setTimeout(function () {
                _this.regionChanging = false;
            }, 700);
        } else {
            this.updateRegionControls();
        }
    },
    _recalculatePositionBox: function (region) {
        var centerPosition = region.center();
        var pointerPosition = centerPosition * this.pixelBase + this.chrOffsetY[region.chromosome];
        this.positionBox.setAttribute("x1", this.chrOffsetX[region.chromosome] - 10);
        this.positionBox.setAttribute("x2", this.chrOffsetX[region.chromosome] + 23);
        this.positionBox.setAttribute("y1", pointerPosition);
        this.positionBox.setAttribute("y2", pointerPosition);
    },
    updateRegionControls: function () {
        this._recalculatePositionBox(this.region);
    },

    setRegion: function (region) {//item.chromosome, item.position, item.species
        this.region.load(region);
        var needDraw = false;

        if (this.lastSpecies != this.species) {
            needDraw = true;
            this.lastSpecies = this.species;
        }
        if (needDraw) {
            this.draw();
        }

        this.updateRegionControls();
    },


//    updatePositionBox: function () {
//        this.positionBox.setAttribute("x1", this.chrOffsetX[this.region.chromosome] - 10);
//        this.positionBox.setAttribute("x2", this.chrOffsetX[this.region.chromosome] + 23);
//
//        var centerPosition = Utils.centerPosition(this.region);
//        var pointerPosition = centerPosition * this.pixelBase + this.chrOffsetY[this.region.chromosome];
//        this.positionBox.setAttribute("y1", pointerPosition);
//        this.positionBox.setAttribute("y2", pointerPosition);
//    },

    addMark: function (item) {//item.chromosome, item.position
        var _this = this;

        var mark = function () {
            if (_this.region.chromosome != null && _this.region.start != null) {
                if (_this.chrOffsetX[_this.region.chromosome] != null) {
                    var x1 = _this.chrOffsetX[_this.region.chromosome] - 10;
                    var x2 = _this.chrOffsetX[_this.region.chromosome];
                    var y1 = (_this.region.start * _this.pixelBase + _this.chrOffsetY[_this.region.chromosome]) - 4;
                    var y2 = _this.region.start * _this.pixelBase + _this.chrOffsetY[_this.region.chromosome];
                    var y3 = (_this.region.start * _this.pixelBase + _this.chrOffsetY[_this.region.chromosome]) + 4;
                    var points = x1 + "," + y1 + " " + x2 + "," + y2 + " " + x1 + "," + y3 + " " + x1 + "," + y1;
                    SVG.addChild(_this.markGroup, "polyline", {
                        "points": points,
                        "stroke": "black",
                        "opacity": 0.8,
                        "fill": "#33FF33"
                    });
                }
            }
        };

        if (this.rendered) {
            mark();
        } else {
            _this.on('after:render', function (e) {
                mark();
            });
        }
    },

    unmark: function () {
        $(this.markGroup).empty();
    },

    setCellBaseHost: function (host) {
        this.cellBaseHost = host;
    }

}

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function StatusBar(args) {

    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    var _this = this;

    this.id = Utils.genId("StatusBar");

    this.target;
    this.autoRender = true;

    //set instantiation args, must be last
    _.extend(this, args);

    //set new region object
    this.region = new Region(this.region);

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }
};

StatusBar.prototype = {
    render: function () {

        this.div = $('<div id="' + this.id + '" class="ocb-gv-status-bar"></div>')[0];

        this.rightDiv = $('<div class="ocb-gv-status-right" id="' + this.id + 'position"</div>')[0];
        this.leftDiv = $('<div class="ocb-gv-status-left" id="' + this.id + 'position"></div>')[0];
        $(this.div).append(this.leftDiv);
        $(this.div).append(this.rightDiv);

        this.mousePositionEl = $('<span id="' + this.id + 'position"></span>')[0];
        this.mousePositionBase = document.createElement('span');
        this.mousePositionBase.style.marginRight = '5px';
        this.mousePositionRegion = document.createElement('span');
        this.mousePositionEl.appendChild(this.mousePositionBase);
        this.mousePositionEl.appendChild(this.mousePositionRegion);

        this.versionEl = $('<span id="' + this.id + 'version">' + this.version + '</span>')[0];
        $(this.rightDiv).append(this.mousePositionEl);
        $(this.leftDiv).append(this.versionEl);

        this.rendered = true;
    },
    draw: function () {
        var _this = this;
        this.targetDiv = (this.target instanceof HTMLElement) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);
    },
    setRegion: function (event) {
        this.region.load(event.region);
        this.mousePositionBase.textContent = "";
        this.mousePositionRegion.textContent = this.region.chromosome + ':' + Utils.formatNumber(event.region.center());
    },
    setMousePosition: function (event) {
        this.mousePositionBase.style.color = SEQUENCE_COLORS[event.base];
        this.mousePositionBase.textContent = event.base;

        this.mousePositionRegion.textContent = this.region.chromosome + ':' + Utils.formatNumber(event.mousePos);
    }

}

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function TrackListPanel(args) { //parent is a DOM div element
    var _this = this;

    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.cellBaseHost = 'http://bioinfo.hpc.cam.ac.uk/cellbase';
    this.cellBaseVersion = 'v3';

    //set default args
    this.target;
    this.autoRender = true;
    this.id = Utils.genId("TrackListPanel");
    this.collapsed = false;
    this.collapsible = false;
    this.hidden = false;

    this.tracks = [];
    this.tracksIndex = {};

    this.parentLayout;
    this.mousePosition;
    this.windowSize;

    this.zoomMultiplier = 1;
    this.showRegionOverviewBox = false;


    this.height = 0;

    //set instantiation args, must be last
    _.extend(this, args);

    //set new region object
    this.region = new Region(this.region);
    this.width -= 18;


    this.status;

    //this region is used to do not modify original region, and will be used by trackSvg
    this.visualRegion = new Region(this.region);

    /********/
    this._setPixelBase();
    /********/

    this.on(this.handlers);

    this.regionChanging = false;

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }

};

TrackListPanel.prototype = {
    show: function() {
        $(this.div).css({
            display: 'block'
        });
        this.hidden = false;
    },

    hide: function() {
        $(this.div).css({
            display: 'none'
        });
        this.hidden = true;
    },
    setVisible: function(bool) {
        if (bool) {
            this.show()
        } else {
            this.hide()
        }
    },
    setTitle: function(title) {
        if ('titleDiv' in this) {
            $(this.titleDiv).html(title);
        }
    },
    showContent: function() {
        $(this.tlHeaderDiv).css({
            display: 'block'
        });
        $(this.panelDiv).css({
            display: 'block'
        });
        this.collapsed = false;
        $(this.collapseDiv).removeClass('active');
        $(this.collapseDiv).children().first().removeClass('fa-plus');
        $(this.collapseDiv).children().first().addClass('fa-minus');
    },
    hideContent: function() {
        $(this.tlHeaderDiv).css({
            display: 'none'
        });
        $(this.panelDiv).css({
            display: 'none'
        });
        this.collapsed = true;
        $(this.collapseDiv).addClass('active');
        $(this.collapseDiv).children().first().removeClass('fa-minus');
        $(this.collapseDiv).children().first().addClass('fa-plus');
    },
    render: function() {
        var _this = this;

        this.div = document.createElement('div');
        this.div.classList.add('ocb-gv-tracklist')

        this.windowSizeDiv = document.createElement('div');
        this.windowSizeDiv.classList.add('ocb-gv-tracklist-windowsize');

        if ('title' in this && this.title !== '') {

            var titleDiv = document.createElement('div');
            titleDiv.classList.add('ocb-gv-panel-title', 'unselectable');

            titleDiv.appendChild(this.windowSizeDiv);

            if (this.collapsible == true) {
                this.collapseDiv = document.createElement('div');
                this.collapseDiv.classList.add('ocb-gv-panel-collapse-control');

                var collapseSpan = document.createElement('span');
                collapseSpan.classList.add('fa', 'fa-minus');

                this.collapseDiv.appendChild(collapseSpan);

                $(titleDiv).dblclick(function() {
                    if (_this.collapsed) {
                        _this.showContent();
                    } else {
                        _this.hideContent();
                    }
                });
                $(this.collapseDiv).click(function() {
                    if (_this.collapsed) {
                        _this.showContent();
                    } else {
                        _this.hideContent();
                    }
                });
                titleDiv.appendChild(this.collapseDiv);
            }

            var titleTextDiv = document.createElement('div');
            titleTextDiv.classList.add('ocb-gv-panel-text');
            titleTextDiv.textContent = this.title;
            titleDiv.appendChild(titleTextDiv);


            this.div.appendChild(titleDiv);
        }

        var tlHeaderDiv = $('<div id="tl-header" class="unselectable"></div>')[0];

        var panelDiv = $('<div id="tl-panel"></div>')[0];
        $(panelDiv).css({
            position: 'relative',
            width: '100%'
        });


        this.tlTracksDiv = $('<div id="tl-tracks"></div>')[0];
        $(this.tlTracksDiv).css({
            position: 'relative',
            'z-index': 3
        });


        $(this.div).append(tlHeaderDiv);
        $(this.div).append(panelDiv);

        $(panelDiv).append(this.tlTracksDiv);


        //Main SVG and its events

        //Position div
        this.positionDiv = document.createElement('div');
        this.positionDiv.classList.add('ocb-gv-tracklist-position');

        this.positionLeftDiv = document.createElement('div');
        this.positionLeftDiv.classList.add('ocb-gv-tracklist-position-left');
        this.positionNucleotidDiv = document.createElement('div');
        this.positionNucleotidDiv.classList.add('ocb-gv-tracklist-position-mid-nt');
        this.positionMidPosDiv = document.createElement('div');
        this.positionMidPosDiv.classList.add('ocb-gv-tracklist-position-mid-pos');
        this.positionMidDiv = document.createElement('div');
        this.positionMidDiv.classList.add('ocb-gv-tracklist-position-mid');
        this.positionRightDiv = document.createElement('div');
        this.positionRightDiv.classList.add('ocb-gv-tracklist-position-right');

        this.positionDiv.appendChild(this.positionLeftDiv);
        this.positionDiv.appendChild(this.positionNucleotidDiv);
        this.positionMidDiv.appendChild(this.positionNucleotidDiv);
        this.positionMidDiv.appendChild(this.positionMidPosDiv);
        this.positionDiv.appendChild(this.positionMidDiv);
        this.positionDiv.appendChild(this.positionRightDiv);
        tlHeaderDiv.appendChild(this.positionDiv);


        var mid = this.width / 2;
        this._setTextPosition();


        this.centerLine = $('<div id="' + this.id + 'centerLine"></div>')[0];
        $(panelDiv).append(this.centerLine);
        $(this.centerLine).css({
            'z-index': 2,
            'position': 'absolute',
            'left': mid - 1,
            'top': 0,
            'width': Math.floor(this.pixelBase), //this.pixelBase + 1,
            //            'height': '100%',
            'height': 'calc(100% - 8px)',
            'opacity': 0.5,
            'border': '1px solid orangered',
            'background-color': 'orange'
        });


        this.mouseLine = $('<div id="' + this.id + 'mouseLine"></div>')[0];
        $(panelDiv).append(this.mouseLine);
        $(this.mouseLine).css({
            'z-index': 1,
            'position': 'absolute',
            'left': -20.5,
            'top': 0,
            'width': Math.floor(this.pixelBase), //this.pixelBase + 2,
            'height': 'calc(100% - 8px)',
            'border': '1px solid gray',
            'opacity': 0.7,
            'visibility': 'hidden',
            'background-color': 'gainsboro'
        });

        //allow selection in trackSvgLayoutOverview


        var selBox = $('<div id="' + this.id + 'selBox"></div>')[0];
        $(panelDiv).append(selBox);
        $(selBox).css({
            'z-index': 0,
            'position': 'absolute',
            'left': 0,
            'top': 0,
            'height': '100%',
            'border': '2px solid deepskyblue',
            'opacity': 0.5,
            'visibility': 'hidden',
            'background-color': 'honeydew'
        });

        if (this.showRegionOverviewBox) {
            var regionOverviewBoxLeft = $('<div id="' + this.id + 'regionOverviewBoxLeft"></div>')[0];
            var regionOverviewBoxRight = $('<div id="' + this.id + 'regionOverviewBoxRight"></div>')[0];
            $(panelDiv).append(regionOverviewBoxLeft);
            $(panelDiv).append(regionOverviewBoxRight);
            var regionOverviewBoxWidth = this.region.length() * this.pixelBase;
            var regionOverviewDarkBoxWidth = (this.width - regionOverviewBoxWidth) / 2;
            $(regionOverviewBoxLeft).css({
                'z-index': 0,
                'position': 'absolute',
                'left': 1,
                'top': 0,
                'width': regionOverviewDarkBoxWidth,
                'height': 'calc(100% - 8px)',
                //                'border': '1px solid gray',
                'opacity': 0.5,
                //            'visibility': 'hidden',
                'background-color': 'lightgray'
            });
            $(regionOverviewBoxRight).css({
                'z-index': 0,
                'position': 'absolute',
                'left': (regionOverviewDarkBoxWidth + regionOverviewBoxWidth),
                'top': 0,
                'width': regionOverviewDarkBoxWidth,
                'height': 'calc(100% - 8px)',
                //                'border': '1px solid gray',
                'opacity': 0.5,
                //            'visibility': 'hidden',
                'background-color': 'lightgray'
            });
            this.regionOverviewBoxLeft = regionOverviewBoxLeft;
            this.regionOverviewBoxRight = regionOverviewBoxRight;
        }


        $(this.div).mousemove(function(event) {
            var centerPosition = _this.region.center();
            var mid = _this.width / 2;
            var mouseLineOffset = _this.pixelBase / 2;
            var offsetX = (event.clientX - _this.tlTracksDiv.getBoundingClientRect().left);
            //debugger
            var cX = offsetX - mouseLineOffset;
            var rcX = (cX / _this.pixelBase) | 0;
            var pos = (rcX * _this.pixelBase) + (mid % _this.pixelBase) - 1;
            $(_this.mouseLine).css({
                'left': pos
            });
            //
            var posOffset = (mid / _this.pixelBase) | 0;
            _this.mousePosition = centerPosition + rcX - posOffset;
            _this.trigger('mousePosition:change', {
                mousePos: _this.mousePosition,
                chromosome: _this.region.chromosome,
                base: _this.getMousePosition(_this.mousePosition)
            });
        });

        $(this.tlTracksDiv).dblclick(function(event) {
            if (!_this.regionChanging) {
                _this.regionChanging = true;
                /**/
                /**/
                /**/
                var halfLength = _this.region.length() / 2;
                var mouseRegion = new Region({
                    chromosome: _this.region.chromosome,
                    start: _this.mousePosition - halfLength,
                    end: _this.mousePosition + halfLength
                })
                _this.trigger('region:change', {
                    region: mouseRegion,
                    sender: _this
                });
                /**/
                /**/
                /**/
                setTimeout(function() {
                    _this.regionChanging = false;
                }, 700);
            }
        });

        var downX, moveX;
        $(this.tlTracksDiv).mousedown(function(event) {
            $('html').addClass('unselectable');
            //                            $('.qtip').qtip('hide').qtip('disable'); // Hide AND disable all tooltips
            $(_this.mouseLine).css({
                'visibility': 'hidden'
            });

            var mouseState = event.which;
            if (event.ctrlKey) {
                mouseState = 'ctrlKey' + event.which;
            }
            switch (mouseState) {
                case 1: //Left mouse button pressed
                    $(this).css({
                        "cursor": "move"
                    });
                    downX = event.clientX;
                    var lastX = 0;
                    $(this).mousemove(function(event) {
                        var newX = (downX - event.clientX) / _this.pixelBase | 0; //truncate always towards zero
                        if (newX != lastX) {
                            var disp = lastX - newX;
                            var centerPosition = _this.region.center();
                            var p = centerPosition - disp;
                            if (p > 0) { //avoid 0 and negative positions
                                _this.region.start -= disp;
                                _this.region.end -= disp;
                                _this._setTextPosition();
                                //						_this.onMove.notify(disp);
                                _this.trigger('region:move', {
                                    region: _this.region,
                                    disp: disp,
                                    sender: _this
                                });
                                _this.trigger('trackRegion:move', {
                                    region: _this.region,
                                    disp: disp,
                                    sender: _this
                                });
                                lastX = newX;
                                //_this.setNucleotidPosition(p);
                            }
                        }
                    });

                    break;
                case 2: //Middle mouse button pressed
                case 'ctrlKey1': //ctrlKey and left mouse button
                    $(selBox).css({
                        'visibility': 'visible'
                    });
                    $(selBox).css({
                        'width': 0
                    });
                    downX = (event.pageX - $(_this.tlTracksDiv).offset().left);
                    $(selBox).css({
                        "left": downX
                    });
                    $(this).mousemove(function(event) {
                        moveX = (event.pageX - $(_this.tlTracksDiv).offset().left);
                        if (moveX < downX) {
                            $(selBox).css({
                                "left": moveX
                            });
                        }
                        $(selBox).css({
                            "width": Math.abs(moveX - downX)
                        });
                    });


                    break;
                case 3: //Right mouse button pressed
                    break;
                default: // other button?
            }


        });

        $(this.tlTracksDiv).mouseup(function(event) {
            $('html').removeClass("unselectable");
            $(this).css({
                "cursor": "default"
            });
            $(_this.mouseLine).css({
                'visibility': 'visible'
            });
            $(this).off('mousemove');

            var mouseState = event.which;
            if (event.ctrlKey) {
                mouseState = 'ctrlKey' + event.which;
            }
            switch (mouseState) {
                case 1: //Left mouse button pressed

                    break;
                case 2: //Middle mouse button pressed
                case 'ctrlKey1': //ctrlKey and left mouse button
                    $(selBox).css({
                        'visibility': 'hidden'
                    });
                    $(this).off('mousemove');
                    if (downX != null && moveX != null) {
                        var ss = downX / _this.pixelBase;
                        var ee = moveX / _this.pixelBase;
                        ss += _this.visualRegion.start;
                        ee += _this.visualRegion.start;
                        _this.region.start = parseInt(Math.min(ss, ee));
                        _this.region.end = parseInt(Math.max(ss, ee));
                        _this.trigger('region:change', {
                            region: _this.region,
                            sender: _this
                        });
                        moveX = null;
                    } else if (downX != null && moveX == null) {
                        var mouseRegion = new Region({
                            chromosome: _this.region.chromosome,
                            start: _this.mousePosition,
                            end: _this.mousePosition
                        })
                        _this.trigger('region:change', {
                            region: mouseRegion,
                            sender: _this
                        });
                    }
                    break;
                case 3: //Right mouse button pressed
                    break;
                default: // other button?
            }

        });

        $(this.tlTracksDiv).mouseleave(function(event) {
            $(this).css({
                "cursor": "default"
            });
            $(_this.mouseLine).css({
                'visibility': 'hidden'
            });
            $(this).off('mousemove');
            $("body").off('keydown.genomeViewer');

            $(selBox).css({
                'visibility': 'hidden'
            });
            downX = null;
            moveX = null;
        });

        $(this.tlTracksDiv).mouseenter(function(e) {
            //            $('.qtip').qtip('enable'); // To enable them again ;)
            $(_this.mouseLine).css({
                'visibility': 'visible'
            });
            $("body").off('keydown.genomeViewer');
            enableKeys();
        });

        var enableKeys = function() {
            //keys
            $("body").bind('keydown.genomeViewer', function(e) {
                var disp = 0;
                switch (e.keyCode) {
                    case 37: //left arrow
                        if (e.ctrlKey) {
                            disp = Math.round(100 / _this.pixelBase);
                        } else {
                            disp = Math.round(10 / _this.pixelBase);
                        }
                        break;
                    case 39: //right arrow
                        if (e.ctrlKey) {
                            disp = Math.round(-100 / _this.pixelBase)
                        } else {
                            disp = Math.round(-10 / _this.pixelBase);
                        }
                        break;
                }
                if (disp != 0) {
                    _this.region.start -= disp;
                    _this.region.end -= disp;
                    _this._setTextPosition();
                    //					_this.onMove.notify(disp);
                    _this.trigger('region:move', {
                        region: _this.region,
                        disp: disp,
                        sender: _this
                    });
                    _this.trigger('trackRegion:move', {
                        region: _this.region,
                        disp: disp,
                        sender: _this
                    });
                }
            });
        };

        this.tlHeaderDiv = tlHeaderDiv;
        this.panelDiv = panelDiv;


        this.setVisible(!this.hidden);
        this.rendered = true;
    },

    setHeight: function(height) {
        //        this.height=Math.max(height,60);
        //        $(this.tlTracksDiv).css('height',height);
        //        //this.grid.setAttribute("height",height);
        //        //this.grid2.setAttribute("height",height);
        //        $(this.centerLine).css("height",parseInt(height));//25 es el margen donde esta el texto de la posicion
        //        $(this.mouseLine).css("height",parseInt(height));//25 es el margen donde esta el texto de la posicion
    },

    setWidth: function(width) {
        console.log('trackListPanel setWidth ------> '+ width);
        this.width = width - 18;
    },

    highlight: function(event) {
        this.trigger('trackFeature:highlight', event)
    },


    moveRegion: function(event) {
        this.region.load(event.region);
        this.visualRegion.load(event.region);
        this._setTextPosition();
        this.trigger('trackRegion:move', event);
    },

    setSpecies: function(species) {
        this.species = species;
        //        this.trigger('trackSpecies:change', {species: species, sender: this});

        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            track.setSpecies(this.species);

        }
    },

    setRegion: function(region) { //item.chromosome, item.position, item.species
        console.log('trackListPanel setRegion region ------> '+ region);
        console.log('trackListPanel setRegion width ------> '+ this.width);
        var _this = this;
        var mid = this.width / 2;
        this.region.load(region);
        this.visualRegion.load(region);
        this._setPixelBase();
        //get pixelbase by Region


        $(this.centerLine).css({
            'left': mid - 1,
            'width': this.pixelBase
        });
        $(this.mouseLine).css({
            'width': this.pixelBase
        });

        this._setTextPosition();

        if (this.showRegionOverviewBox) {
            var regionOverviewBoxWidth = this.region.length() * this.pixelBase;
            var regionOverviewDarkBoxWidth = (this.width - regionOverviewBoxWidth) / 2;
            $(this.regionOverviewBoxLeft).css({
                'width': regionOverviewDarkBoxWidth
            });
            $(this.regionOverviewBoxRight).css({
                'left': (regionOverviewDarkBoxWidth + regionOverviewBoxWidth),
                'width': regionOverviewDarkBoxWidth
            });
        }


        this.trigger('window:size', {
            windowSize: this.windowSize
        });

        //        if (region.species != null) {
        //            //check species and modify CellBaseAdapter, clean cache
        //            for (i in this.tracks) {
        //                if (this.tracks[i].trackData.adapter instanceof CellBaseAdapter ||
        //                    this.tracks[i].trackData.adapter instanceof SequenceAdapter
        //                    ) {
        //                    this.tracks[i].trackData.adapter.species = region.species;
        //                    //this.tracks[i].trackData.adapter.featureCache.clear();
        //
        //                    this.tracks[i].trackData.adapter.clearData();
        //                }
        //            }
        //        }
        this.trigger('trackRegion:change', {
            region: this.visualRegion,
            sender: this
        })

        this.positionNucleotidDiv.textContent = ""; //remove base char, will be drawn later if needed

        this.status = 'rendering';

        //        this.onRegionChange.notify();

        //this.minRegionRect.setAttribute("width",this.minRectWidth);
        //this.minRegionRect.setAttribute("x",(this.width/2)-(this.minRectWidth/2)+6);
    },

    draw: function() {
        var _this = this;
        this.targetDiv = (this.target instanceof HTMLElement) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);

        this.trigger('track:draw', {
            sender: this
        });
    },
    _checkAllTrackStatus: function(status) {
        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            if (track.status != status) return false;
        }
        return true;
    },
    checkTracksReady: function() {
        return this._checkAllTrackStatus('ready');
        //        if (this._checkAllTrackStatus('ready')) {
        //            this.status = 'ready';
        //            console.log('all ready')
        //            this.trigger('tracks:ready', {sender: this});
        //        }
        //        var checkStatus = function () {
        //            if (checkAllTrackStatus('ready')) {
        //                _this.trigger('tracks:ready', {sender: _this});
        //            } else {
        //                setTimeout(checkStatus, 100);
        //            }
        //        };
        //        setTimeout(checkStatus, 10);
    },
    addTrack: function(track) {
        if (_.isArray(track)) {
            for (var i in track) {
                this._addTrack(track[i]);
            }
        } else {
            this._addTrack(track);
        }
    },
    _addTrack: function(track) {
        if (!this.rendered) {
            console.info(this.id + ' is not rendered yet');
            return;
        }
        var _this = this;

        if (track == null) {
            return false
        }
        // Check if already exists
        if (this.containsTrack(track)) {
            return false;
        }


        var length = this.tracks.push(track);
        var insertPosition = length - 1;
        this.tracksIndex[track.id] = insertPosition;


        if (typeof track.dataAdapter.host === 'undefined') {
            track.dataAdapter.host = this.cellBaseHost;
        }
        if (typeof track.dataAdapter.version === 'undefined') {
            track.dataAdapter.version = this.cellBaseVersion;
        }
        track.set('pixelBase', this.pixelBase);
        track.set('region', this.visualRegion);
        track.set('width', this.width);
        track.setSpecies(this.species);

        track.set('trackListPanel', this);

        // Track must be initialized after we have created
        // de DIV element in order to create the elements in the DOM
        if (!track.rendered) {
            track.render(this.tlTracksDiv);
        }

        // Once tack has been initialize we can call draw() function
        track.draw();


        //trackEvents
        track.set('track:draw', function(event) {
            track.draw();
        });


        //        track.set('trackSpecies:change', function (event) {
        //            track.setSpecies(event.species);
        //        });


        track.set('trackRegion:change', function(event) {
          console.log('trackListPanel trackRegion:change region ------> '+ event.region);
          console.log('trackListPanel trackRegion:change width ------> '+ _this.width);
            track.setWidth(_this.width);
            track.set('pixelBase', _this.pixelBase);
            track.set('region', event.region);
            track.draw();
        });


        track.set('trackRegion:move', function(event) {
            track.set('region', event.region);
            track.set('pixelBase', _this.pixelBase);
            track.move(event.disp);
        });


        //track.set('trackWidth:change', function (event) {
        //    track.setWidth(event.width);
        //    track.set('pixelBase', _this.pixelBase);
        //    track.draw();
        //});


        track.set('trackFeature:highlight', function(event) {


            var attrName = event.attrName || 'feature_id';
            if ('attrValue' in event) {
                event.attrValue = ($.isArray(event.attrValue)) ? event.attrValue : [event.attrValue];
                for (var key in event.attrValue) {
                    var queryStr = attrName + '~=' + event.attrValue[key];
                    var group = $(track.svgdiv).find('g[' + queryStr + ']')
                    $(group).each(function() {
                        var animation = $(this).find('animate');
                        if (animation.length == 0) {
                            animation = SVG.addChild(this, 'animate', {
                                'attributeName': 'opacity',
                                'attributeType': 'XML',
                                'begin': 'indefinite',
                                'from': '0.0',
                                'to': '1',
                                'begin': '0s',
                                'dur': '0.5s',
                                'repeatCount': '5'
                            });
                        } else {
                            animation = animation[0];
                        }
                        var y = $(group).find('rect').attr("y");
                        $(track.svgdiv).scrollTop(y);
                        animation.beginElement();
                    });
                }
            }
        });

        track.on('track:close', function(event) {
            _this.removeTrack(event.sender);
        });
        track.on('track:up', function(event) {
            _this._reallocateAbove(event.sender);
        });
        track.on('track:down', function(event) {
            _this._reallocateUnder(event.sender);
        });

        this.on('track:draw', track.get('track:draw'));
        //        this.on('trackSpecies:change', track.get('trackSpecies:change'));
        this.on('trackRegion:change', track.get('trackRegion:change'));
        this.on('trackRegion:move', track.get('trackRegion:move'));
        //this.on('trackWidth:change', track.get('trackWidth:change'));
        this.on('trackFeature:highlight', track.get('trackFeature:highlight'));

        //        track.on('track:ready', function () {
        //            _this.checkTracksReady();
        //        });
    },
    toggleAutoHeight: function(bool) {
        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            track.toggleAutoHeight(bool);
        }
    },
    updateHeight: function() {
        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            track.updateHeight(true);
        }
    },

    containsTrack: function(track) {
        if (typeof this.tracksIndex[track.id] !== 'undefined') {
            return true;
        } else {
            return false;
        }
    },
    getTrackIndex: function(track) {
        return this.tracksIndex[track.id];
    },
    _updateTracksIndex: function() {
        //update index with correct index after splice
        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            this.tracksIndex[track.id] = i;
        }
    },
    refreshTracksDom: function() {
        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            $(track.div).detach();
            $(this.tlTracksDiv).append(track.div);
        }
        this.trigger('tracks:refresh', {
            sender: this
        });
    },
    removeTrack: function(track) {
        if (!this.containsTrack(track)) {
            return false;
        }
        // first hide the track
        this.hideTrack(track);
        track.remove();

        var index = this.getTrackIndex(track);
        // remove track from list and hash data
        this.tracks.splice(index, 1)[0];
        delete this.tracksIndex[track.id];
        this._updateTracksIndex();

        // delete listeners

        track.off('track:close');
        track.off('track:up');
        track.off('track:down');


        this.off('track:draw', track.get('track:draw'));
        //        this.off('trackSpecies:change', track.get('trackSpecies:change'));
        this.off('trackRegion:change', track.get('trackRegion:change'));
        this.off('trackRegion:move', track.get('trackRegion:move'));
        //this.off('trackWidth:change', track.set('trackWidth:change'));
        this.off('trackFeature:highlight', track.get('trackFeature:highlight'));

        this.refreshTracksDom();
        return track;
    },

    restoreTrack: function(track, index) {
        if (this.containsTrack((track))) {
            return false;
        }

        this.addTrack(track);
        if (typeof index !== 'undefined') {
            this.setTrackIndex(track, index);
        }
        track.show();
        this.refreshTracksDom();
    },


    //This routine is called when track order is modified
    _reallocateAbove: function(track) {
        if (!this.containsTrack((track))) {
            return false;
        }

        var i = this.getTrackIndex(track);
        console.log(i + " wants to move up");
        if (i > 0) {
            var aboveTrack = this.tracks[i - 1];
            var underTrack = this.tracks[i];

            this.tracks[i] = aboveTrack;
            this.tracks[i - 1] = underTrack;
            this.tracksIndex[aboveTrack.id] = i;
            this.tracksIndex[underTrack.id] = i - 1;
            this.refreshTracksDom();
        } else {
            console.log("is at top");
        }
    },

    //This routine is called when track order is modified
    _reallocateUnder: function(track) {
        if (!this.containsTrack((track))) {
            return false;
        }

        var i = this.getTrackIndex(track);
        console.log(i + " wants to move down");
        if (i + 1 < this.tracks.length) {
            var aboveTrack = this.tracks[i];
            var underTrack = this.tracks[i + 1];

            this.tracks[i] = underTrack;
            this.tracks[i + 1] = aboveTrack;
            this.tracksIndex[underTrack.id] = i;
            this.tracksIndex[aboveTrack.id] = i + 1;
            this.refreshTracksDom();
        } else {
            console.log("is at bottom");
        }
    },

    setTrackIndex: function(track, newIndex) {
        if (!this.containsTrack((track))) {
            return false;
        }

        var oldIndex = this.getTrackIndex(track);

        //remove track from old index
        this.tracks.splice(oldIndex, 1)[0];

        //add track at new Index
        this.tracks.splice(newIndex, 0, track);

        this._updateTracksIndex();

        //update track div positions
        this.refreshTracksDom();
    },
    swapTracks: function(t1, t2) {
        if (!this.containsTrack((t1))) {
            return false;
        }
        if (!this.containsTrack((t2))) {
            return false;
        }
        var oldIndex1 = this.getTrackIndex(t1);
        var oldIndex2 = this.getTrackIndex(t2);

        this.tracks[oldIndex1] = t2;
        this.tracks[oldIndex2] = t1;
        this.tracksIndex[t1.id] = oldIndex2;
        this.tracksIndex[t2.id] = oldIndex1;
        this.refreshTracksDom();
    },

    scrollToTrack: function(track) {
        if (!this.containsTrack((track))) {
            return false;
        }

        var y = $(track.div).position().top;
        $(this.tlTracksDiv).scrollTop(y);
    },


    hideTrack: function(track) {
        if (!this.containsTrack((track))) {
            return false;
        }
        track.hide();
        this.refreshTracksDom();
    },

    showTrack: function(track) {
        if (!this.containsTrack((track))) {
            return false;
        }
        track.show();
        this.refreshTracksDom();
    },
    _setPixelBase: function() {
        this.pixelBase = this.width / this.region.length();
        this.pixelBase = this.pixelBase / this.zoomMultiplier;
        this.halfVirtualBase = (this.width * 3 / 2) / this.pixelBase;
    },

    _setTextPosition: function() {
        var centerPosition = this.region.center();
        var baseLength = parseInt(this.width / this.pixelBase); //for zoom 100
        var aux = Math.ceil((baseLength / 2) - 1);
        this.visualRegion.start = Math.floor(centerPosition - aux);
        this.visualRegion.end = Math.floor(centerPosition + aux);

        this.positionMidPosDiv.textContent = Utils.formatNumber(centerPosition);
        this.positionLeftDiv.textContent = Utils.formatNumber(this.visualRegion.start);
        this.positionRightDiv.textContent = Utils.formatNumber(this.visualRegion.end);


        this.windowSize = 'Window size: ' + Utils.formatNumber(this.visualRegion.length()) + ' nts';
        this.windowSizeDiv.innerHTML = this.windowSize;
    },

    getTrackById: function(trackId) {
        if (typeof this.tracksIndex[trackId] !== 'undefined') {
            var i = this.tracksIndex[trackId];
            return this.tracks[i];
        }
    },
    getSequenceTrack: function() {
        //if multiple, returns the first found
        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            if (track.renderer instanceof SequenceRenderer) {
                return track;
            }
        }
        return;
    },

    getMousePosition: function(position) {
        var base = '';
        if (position > 0) {
            base = this.getSequenceNucleotid(position);
        }
        //        this.mouseLine.setAttribute('stroke',SEQUENCE_COLORS[base]);
        //        this.mouseLine.setAttribute('fill',SEQUENCE_COLORS[base]);
        return base;
    },

    getSequenceNucleotid: function(position) {
        var seqTrack = this.getSequenceTrack();
        if (seqTrack) {
            var el = seqTrack.svgCanvasFeatures.querySelector('text[data-pos="' + position + '"]');
            if (el) {
                return el.textContent;
            }
        }
        return '';
    },

    setNucleotidPosition: function(position) {
        var base = this.getSequenceNucleotid(position);
        this.positionNucleotidDiv.style.color = SEQUENCE_COLORS[base];
        this.positionNucleotidDiv.textContent = base;
    },

    setCellBaseHost: function(host) {
        this.cellBaseHost = host;
        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            if (track.dataAdapter instanceof CellBaseAdapter) {
                track.dataAdapter.setHost(this.cellBaseHost);
            }
        }
    },
    deleteTracksCache:function(){
        for (var i = 0; i < this.tracks.length; i++) {
            var track = this.tracks[i];
            if(track.dataAdapter.deleteCache != null){
                track.dataAdapter.deleteCache()
            }
        }
    }

};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function Track(args) {

    this.id = Utils.genId('track');
    this.dataAdapter;
    this.renderer;
    this.histogramRendererName = "HistogramRenderer";
    this.resizable = true;
    this.autoHeight = false;
    this.targetId;
    this.title;
    this.minHistogramRegionSize = 300000000;
    this.maxLabelRegionSize = 300000000;
    this.width = 200;
    this.height = 100;
    this.visibleRegionSize;
    this.visible = true;
    this.contentVisible = true;
    this.closable = false;
    this.fontClass = 'ocb-font-roboto ocb-font-size-14';
    this.externalLink = '';

    _.extend(this, args);

    this.pixelBase;
    this.svgCanvasWidth = 500000; //mesa
    this.pixelPosition = this.svgCanvasWidth / 2;
    this.svgCanvasOffset;
    //    this.svgCanvasFeatures;
    this.status;
    this.histogram;
    this.histogramLogarithm;
    this.histogramMax;
    this.interval;

    this.svgCanvasLeftLimit;
    this.svgCanvasRightLimit;


    this.invalidZoomText;

    this.renderedArea = {}; //used for renders to store binary trees
    this.chunksDisplayed = {}; //used to avoid painting multiple times features contained in more than 1 chunk

    if ('handlers' in this) {
        for (eventName in this.handlers) {
            this.on(eventName, this.handlers[eventName]);
        }
    }

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }
};

Track.prototype = {

    get: function(attr) {
        return this[attr];
    },

    set: function(attr, value) {
        this[attr] = value;
    },
    hide: function() {
        this.visible = false;
        this.div.classList.add('hidden');
    },
    show: function() {
        this.visible = true;
        this.div.classList.remove('hidden');
        this.updateHeight();
    },
    toggle: function() {
        if (this.visible) {
            this.hide();
        } else {
            this.show();

        }
    },
    remove: function() {
        $(this.div).remove();
    },
    hideContent: function() {
        this.contentVisible = false;
        this.contentDiv.classList.add('hidden');
        this.resizeDiv.classList.add('hidden');

        this.iToggleEl.classList.remove('fa-minus');
        this.iToggleEl.classList.add('fa-plus');
    },
    showContent: function() {
        this.contentVisible = true;
        this.contentDiv.classList.remove('hidden');
        this.resizeDiv.classList.remove('hidden');

        this.iToggleEl.classList.remove('fa-plus');
        this.iToggleEl.classList.add('fa-minus');
        this.updateHeight();
    },
    toggleContent: function() {
        if (this.contentVisible) {
            this.hideContent();
        } else {
            this.showContent();

        }
    },
    close: function() {
        this.trigger('track:close', {
            sender: this
        });
    },
    up: function() {
        this.trigger('track:up', {
            sender: this
        });
    },
    down: function() {
        this.trigger('track:down', {
            sender: this
        });
    },
    setSpecies: function(species) {
        this.species = species;
        this.dataAdapter.setSpecies(this.species);
    },

    setWidth: function(width) {
        this._setWidth(width);
    },
    _setWidth: function(width) {
        this.width = width;
    },

    updateHeight: function() {
        this._updateHeight();
    },
    _updateHeight: function() {
        $(this.contentDiv).css({
            'height': this.height + 10
        });
    },
    enableAutoHeight: function() {
        console.log('enable autoHeigth');
        this.autoHeight = true;
        this.updateHeight();
    },
    disableAutoHeight: function() {
        console.log('disable autoHeigth');
        this.autoHeight = false;
        this.updateHeight();
    },
    toggleAutoHeight: function(bool) {
        if (bool == true) {
            this.enableAutoHeight();
            return;
        } else if (bool == false) {
            this.disableAutoHeight();
            return;
        }
        if (this.autoHeight == true) {
            this.disableAutoHeight();
            return;
        } else if (this.autoHeight == false) {
            this.enableAutoHeight();
            return;
        }
    },
    setTitle: function(title) {
        $(this.titleText).html(title);
    },

    setLoading: function(bool) {
        if (bool) {
            this.status = "rendering";
            $(this.loadingEl).html('&nbsp; &nbsp;<i class="fa fa-spinner fa-spin"></i> Loading...</span>');
        } else {
            this.status = "ready";
            $(this.loadingEl).html('');
        }
    },

    updateHistogramParams: function() {
        if (this.region.length() > this.minHistogramRegionSize) {
            this.histogram = true;
            this.histogramLogarithm = true;
            this.histogramMax = 500;
            this.interval = Math.ceil(10 / this.pixelBase); //server interval limit 512
            $(this.histogramEl).html('&nbsp;<i class="fa fa-signal"></i>');
        } else {
            this.histogram = undefined;
            this.histogramLogarithm = undefined;
            this.histogramMax = undefined;
            this.interval = undefined;
            $(this.histogramEl).html('');
        }

        //        if (this.histogramRenderer) {
        //            if (this.zoom <= this.histogramZoom) {
        //                this.histogramGroup.setAttribute('visibility', 'visible');
        //            } else {
        //                this.histogramGroup.setAttribute('visibility', 'hidden');
        //            }
        //        }
    },
    clean: function() {
        this._clean();
    },
    _clean: function() {
        //Must be called on child clean method
        this.chunksDisplayed = {};
        this.renderedArea = {};
    },
    initializeDom: function(targetId) {
        this._initializeDom(targetId);
    },
    _initializeDom: function(targetId) {

        var _this = this;
        var div = $('<div id="' + this.id + '-div"></div>')[0];
        div.classList.add('ocb-gv-track');
        var titleBarHtml = '';
        titleBarHtml += '   <div class="ocb-gv-track-title">';
        //      titleBarHtml+=       '   <button id="configBtn" type="button" class="btn btn-xs btn-primary"><span class="glyphicon glyphicon-cog"></span></button>' ;
        titleBarHtml += '   <div class="ocb-gv-track-title-el">';
        titleBarHtml += '       <span class="ocb-gv-track-title-text">' + this.title + '</span>';
        titleBarHtml += '       <span class="ocb-gv-track-title-histogram"></span>';
        titleBarHtml += '       <span class="ocb-gv-track-title-toggle"><i class="fa fa-minus"></i></span>';
        titleBarHtml += '       <span class="ocb-gv-track-title-down"><i class="fa fa-chevron-down"></i></span>';
        titleBarHtml += '       <span class="ocb-gv-track-title-up"><i class="fa fa-chevron-up"></i></span>';

        if (this.closable == true) {
            titleBarHtml += '       <span class="ocb-gv-track-title-close"><i class="fa fa-times"></i></span>';
        }

        if (this.externalLink !== '') {
            titleBarHtml += '       <span class="ocb-gv-track-title-external-link"><i class="fa fa-external-link"></i></span>';
        }

        titleBarHtml += '       <span class="ocb-gv-track-title-loading"></span>';
        titleBarHtml += '   </div>';
        titleBarHtml += '   </div>';


        var titleBardiv = $(titleBarHtml)[0];


        if (typeof this.title === 'undefined') {
            $(titleBardiv).addClass("hidden");
        }

        var titlediv = titleBardiv.querySelector('.ocb-gv-track-title');
        this.titleEl = titleBardiv.querySelector('.ocb-gv-track-title-el');

        this.titleText = titleBardiv.querySelector('.ocb-gv-track-title-text');
        this.histogramEl = titleBardiv.querySelector('.ocb-gv-track-title-histogram');
        this.toggleEl = titleBardiv.querySelector('.ocb-gv-track-title-toggle');
        this.iToggleEl = this.toggleEl.querySelector('i');
        this.loadingEl = titleBardiv.querySelector('.ocb-gv-track-title-loading');
        this.closeEl = titleBardiv.querySelector('.ocb-gv-track-title-close');
        this.upEl = titleBardiv.querySelector('.ocb-gv-track-title-up');
        this.downEl = titleBardiv.querySelector('.ocb-gv-track-title-down');
        this.externalLinkEl = titleBardiv.querySelector('.ocb-gv-track-title-external-link');

        var contentDiv = $('<div id="' + this.id + '-svgdiv"></div>')[0];
        $(contentDiv).css({
            'position': 'relative',
            'box-sizing': 'boder-box',
            'z-index': 3,
            'height': this.height,
            'overflow-y': (this.resizable) ? 'auto' : 'hidden',
            'overflow-x': 'hidden'
        });

        var resizediv = $('<div id="' + this.id + '-resizediv" class="ocb-track-resize"></div>')[0];

        $(targetId).addClass("unselectable");
        $(targetId).append(div);
        $(div).append(titleBardiv);
        $(div).append(contentDiv);
        $(div).append(resizediv);


        /** title div **/
        $(titleBardiv).css({
                'padding': '4px'
            })
            .on('dblclick', function(e) {
                e.stopPropagation();
            });
        //        $(this.titleText).click(function (e) {
        //            _this.toggleContent();
        //        });
        $(this.toggleEl).click(function(e) {
            _this.toggleContent();
        });
        $(this.closeEl).click(function(e) {
            _this.close();
        });
        $(this.upEl).click(function(e) {
            _this.up();
        });
        $(this.downEl).click(function(e) {
            _this.down();
        });
        $(this.externalLinkEl).click(function(e) {
            window.open(_this.externalLink);
        });

        if (this.resizable) {
            $(resizediv).mousedown(function(event) {
                $('html').addClass('unselectable');
                event.stopPropagation();
                var downY = event.clientY;
                $('html').bind('mousemove.genomeViewer', function(event) {
                    var despY = (event.clientY - downY);
                    var actualHeight = $(contentDiv).outerHeight();
                    var newHeight = actualHeight + despY;
                    if (newHeight > 0) {
                        _this.height = newHeight;
                        $(contentDiv).css({
                            height: _this.height
                        });
                    }
                    downY = event.clientY;
                    //                    _this.autoHeight = false;
                });
            });
            $('html').bind('mouseup.genomeViewer', function(event) {
                $('html').removeClass('unselectable');
                $('html').off('mousemove.genomeViewer');
            });
            $(contentDiv).closest(".trackListPanels").mouseup(function(event) {
                _this.updateHeight();
            });
        }


        //        var hoverRect = SVG.addChild(this.svgGroup, 'rect', {
        //            'x': 0,
        //            'y': 0,
        //            'width': this.width,
        //            'height': this.height,
        //            'opacity': '0.6',
        //            'fill': 'transparent'
        //        });

        //        this.fnTitleMouseEnter = function () {
        //            hoverRect.setAttribute('opacity', '0.1');
        //            hoverRect.setAttribute('fill', 'lightblue');
        //        };
        //        this.fnTitleMouseLeave = function () {
        //            hoverRect.setAttribute('opacity', '0.6');
        //            hoverRect.setAttribute('fill', 'transparent');
        //        };

        //        $(this.svgGroup).off('mouseenter');
        //        $(this.svgGroup).off('mouseleave');
        //        $(this.svgGroup).mouseenter(this.fnTitleMouseEnter);
        //        $(this.svgGroup).mouseleave(this.fnTitleMouseLeave);


        //        this.invalidZoomText = SVG.addChild(this.svgGroup, 'text', {
        //            'x': 154,
        //            'y': 18,
        //            'opacity': '0.6',
        //            'fill': 'black',
        //            'visibility': 'hidden',
        //            'class': this.fontClass
        //        });
        //        this.invalidZoomText.textContent = "No information available at this zoom";

        this.div = div;
        this.contentDiv = contentDiv;
        this.titlediv = titlediv;
        this.resizeDiv = resizediv;
        //        this.configBtn = configBtn;

        //        this.main = main;
        //        this.hoverRect = hoverRect;
        //        this.titleText = titleText;


        //        if (this.histogramRenderer) {
        //            this._drawHistogramLegend();
        //        }

        this.rendered = true;
        this.status = "ready";

    },
    _drawHistogramLegend: function() {
        var histogramHeight = this.histogramRenderer.histogramHeight;
        var multiplier = this.histogramRenderer.multiplier;

        this.histogramGroup = SVG.addChild(this.svgGroup, 'g', {
            'class': 'histogramGroup',
            'visibility': 'hidden'
        });
        var text = SVG.addChild(this.histogramGroup, "text", {
            "x": 21,
            "y": histogramHeight + 4,
            "font-size": 12,
            "opacity": "0.9",
            "fill": "orangered",
            'class': this.fontClass
        });
        text.textContent = "0-";
        var text = SVG.addChild(this.histogramGroup, "text", {
            "x": 14,
            "y": histogramHeight + 4 - (Math.log(10) * multiplier),
            "font-size": 12,
            "opacity": "0.9",
            "fill": "orangered",
            'class': this.fontClass
        });
        text.textContent = "10-";
        var text = SVG.addChild(this.histogramGroup, "text", {
            "x": 7,
            "y": histogramHeight + 4 - (Math.log(100) * multiplier),
            "font-size": 12,
            "opacity": "0.9",
            "fill": "orangered",
            'class': this.fontClass
        });
        text.textContent = "100-";
        var text = SVG.addChild(this.histogramGroup, "text", {
            "x": 0,
            "y": histogramHeight + 4 - (Math.log(1000) * multiplier),
            "font-size": 12,
            "opacity": "0.9",
            "fill": "orangered",
            'class': this.fontClass
        });
        text.textContent = "1000-";
    },

    //    showInfoWidget: function (args) {
    //        if (this.dataAdapter.species == "orange") {
    //            //data.resource+="orange";
    //            if (args.featureType.indexOf("gene") != -1)
    //                args.featureType = "geneorange";
    //            if (args.featureType.indexOf("transcript") != -1)
    //                args.featureType = "transcriptorange";
    //        }
    //        switch (args.featureType) {
    //            case "gene":
    //                new GeneInfoWidget(null, this.dataAdapter.species).draw(args);
    //                break;
    //            case "geneorange":
    //                new GeneOrangeInfoWidget(null, this.dataAdapter.species).draw(args);
    //                break;
    //            case "transcriptorange":
    //                new TranscriptOrangeInfoWidget(null, this.dataAdapter.species).draw(args);
    //                break;
    //            case "transcript":
    //                new TranscriptInfoWidget(null, this.dataAdapter.species).draw(args);
    //                break;
    //            case "snp" :
    //                new SnpInfoWidget(null, this.dataAdapter.species).draw(args);
    //                break;
    //            case "vcf" :
    //                new VCFVariantInfoWidget(null, this.dataAdapter.species).draw(args);
    //                break;
    //            default:
    //                break;
    //        }
    //    },

    draw: function() {

    },

    getFeaturesToRenderByChunk: function(response, filters) {
        //Returns an array avoiding already drawn features in this.chunksDisplayed

        var getChunkId = function(position) {
            return Math.floor(position / response.chunkSize);
        };
        var getChunkKey = function(chromosome, chunkId) {
            return chromosome + ":" + chunkId + "_" + response.dataType + "_" + response.chunkSize;
        };

        var chunks = response.items;
        var features = [];


        var feature, displayed, featureFirstChunk, featureLastChunk, features = [];
        for (var i = 0, leni = chunks.length; i < leni; i++) {
            if (this.chunksDisplayed[chunks[i].chunkKey] != true) { //check if any chunk is already displayed and skip it

                for (var j = 0, lenj = chunks[i].value.length; j < lenj; j++) {
                    feature = chunks[i].value[j];

                    //check if any feature has been already displayed by another chunk
                    displayed = false;
                    featureFirstChunk = getChunkId(feature.start);
                    featureLastChunk = getChunkId(feature.end);
                    for (var chunkId = featureFirstChunk; chunkId <= featureLastChunk; chunkId++) {
                        var chunkKey = getChunkKey(feature.chromosome, chunkId);
                        if (this.chunksDisplayed[chunkKey] == true) {
                            displayed = true;
                            break;
                        }
                    }
                    if (!displayed) {
                        //apply filter
                        // if(filters != null) {
                        //		var pass = true;
                        // 		for(filter in filters) {
                        // 			pass = pass && filters[filter](feature);
                        //			if(pass == false) {
                        //				break;
                        //			}
                        // 		}
                        //		if(pass) features.push(feature);
                        // } else {
                        features.push(feature);
                    }
                }
                this.chunksDisplayed[chunks[i].chunkKey] = true;
            }
        }
        return features;
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

AlignmentTrack.prototype = new Track({});

function AlignmentTrack(args) {
    Track.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    //set default args

    //save default render reference;
    this.defaultRenderer = this.renderer;
    this.histogramRenderer = new window[this.histogramRendererName](args);

    this.dataType = 'features';

    //set instantiation args, must be last
    _.extend(this, args);

};

AlignmentTrack.prototype.clean = function () {
    this._clean();

    //    console.time("-----------------------------------------empty");
    while (this.svgCanvasFeatures.firstChild) {
        this.svgCanvasFeatures.removeChild(this.svgCanvasFeatures.firstChild);
    }
    //    console.timeEnd("-----------------------------------------empty");
};

AlignmentTrack.prototype.updateHeight = function () {
    //    this._updateHeight();
    if (this.histogram) {
        this.contentDiv.style.height = this.histogramRenderer.histogramHeight + 5 + 'px';
        this.main.setAttribute('height', this.histogramRenderer.histogramHeight);
        return;
    }
    var renderedHeight = this.svgCanvasFeatures.getBoundingClientRect().height;
    this.main.setAttribute('height', renderedHeight);

    if (this.resizable) {
        if (this.autoHeight == false) {
            this.contentDiv.style.height = this.height + 10 + 'px';
        } else if (this.autoHeight == true) {
            var x = this.pixelPosition;
            var width = this.width;
            var lastContains = 0;
            for (var i in this.renderedArea) {
                if (this.renderedArea[i].contains({
                        start: x,
                        end: x + width
                    })) {
                    lastContains = i;
                }
            }
            var visibleHeight = parseInt(lastContains) + 30;
            this.contentDiv.style.height = visibleHeight + 10 + 'px';
            this.main.setAttribute('height', visibleHeight);
        }
    }
};

AlignmentTrack.prototype.setWidth = function (width) {
    this._setWidth(width);
    this.main.setAttribute("width", this.width);
};

AlignmentTrack.prototype.initializeDom = function (targetId) {
    this._initializeDom(targetId);

    this.main = SVG.addChild(this.contentDiv, 'svg', {
        'class': 'trackSvg',
        'x': 0,
        'y': 0,
        'width': this.width
    });
    this.svgCanvasFeatures = SVG.addChild(this.main, 'svg', {
        'class': 'features',
        'x': -this.pixelPosition,
        'width': this.svgCanvasWidth
    });
    this.updateHeight();
};

AlignmentTrack.prototype.render = function (targetId) {
    this.initializeDom(targetId);

    this.svgCanvasOffset = (this.width * 3 / 2) / this.pixelBase;
    this.svgCanvasLeftLimit = this.region.start - this.svgCanvasOffset * 2;
    this.svgCanvasRightLimit = this.region.start + this.svgCanvasOffset * 2
};

AlignmentTrack.prototype.getDataHandler = function (event) {
    var features;
    if (event.dataType == 'histogram') {
        this.renderer = this.histogramRenderer;
        features = event.items;
    } else {
        this.renderer = this.defaultRenderer;
        features = this._removeDisplayedChunks(event);
        //features = this.getFeaturesToRenderByChunk(event);
    }
    this.renderer.render(features, {
        cacheItems: event.items,
        svgCanvasFeatures: this.svgCanvasFeatures,
        featureTypes: this.featureTypes,
        renderedArea: this.renderedArea,
        pixelBase: this.pixelBase,
        position: this.region.center(),
        regionSize: this.region.length(),
        maxLabelRegionSize: this.maxLabelRegionSize,
        width: this.width,
        pixelPosition: this.pixelPosition,
        region: this.region,
        trackListPanel: this.trackListPanel
    });
    this.updateHeight();
};

AlignmentTrack.prototype.draw = function () {
    var _this = this;

    this.svgCanvasOffset = (this.width * 3 / 2) / this.pixelBase;
    this.svgCanvasLeftLimit = this.region.start - this.svgCanvasOffset * 2;
    this.svgCanvasRightLimit = this.region.start + this.svgCanvasOffset * 2

    this.updateHistogramParams();
    this.clean();

    this.dataType = 'features';
    if (this.histogram) {
        this.dataType = 'histogram';
    }

    if (typeof this.visibleRegionSize === 'undefined' || this.region.length() < this.visibleRegionSize) {
        this.setLoading(true);
        this.dataAdapter.getData({
            dataType: this.dataType,
            region: new Region({
                chromosome: this.region.chromosome,
                start: this.region.start - this.svgCanvasOffset * 2,
                end: this.region.end + this.svgCanvasOffset * 2
            }),
            params: {
                histogram: this.histogram,
                histogramLogarithm: this.histogramLogarithm,
                histogramMax: this.histogramMax,
                interval: this.interval
            },
            done: function (event) {
                _this.getDataHandler(event);
                _this.setLoading(false);
            }
        });
        //this.invalidZoomText.setAttribute("visibility", "hidden");
    } else {
        //this.invalidZoomText.setAttribute("visibility", "visible");
    }
    _this.updateHeight();
};

AlignmentTrack.prototype.move = function (disp) {
    var _this = this;

    this.dataType = 'features';
    if (this.histogram) {
        this.dataType = 'histogram';
    }

    _this.region.center();
    var pixelDisplacement = disp * _this.pixelBase;
    this.pixelPosition -= pixelDisplacement;

    //parseFloat important
    var move = parseFloat(this.svgCanvasFeatures.getAttribute("x")) + pixelDisplacement;
    this.svgCanvasFeatures.setAttribute("x", move);

    var virtualStart = parseInt(this.region.start - this.svgCanvasOffset);
    var virtualEnd = parseInt(this.region.end + this.svgCanvasOffset);

    if (typeof this.visibleRegionSize === 'undefined' || this.region.length() < this.visibleRegionSize) {

        if (disp > 0 && virtualStart < this.svgCanvasLeftLimit) {
            this.dataAdapter.getData({
                dataType: this.dataType,
                region: new Region({
                    chromosome: _this.region.chromosome,
                    start: parseInt(this.svgCanvasLeftLimit - this.svgCanvasOffset),
                    end: this.svgCanvasLeftLimit
                }),
                params: {
                    histogram: this.histogram,
                    histogramLogarithm: this.histogramLogarithm,
                    histogramMax: this.histogramMax,
                    interval: this.interval
                },
                done: function (event) {
                    _this.getDataHandler(event);
                }
            });
            this.svgCanvasLeftLimit = parseInt(this.svgCanvasLeftLimit - this.svgCanvasOffset);
        }

        if (disp < 0 && virtualEnd > this.svgCanvasRightLimit) {
            this.dataAdapter.getData({
                dataType: this.dataType,
                region: new Region({
                    chromosome: _this.region.chromosome,
                    start: this.svgCanvasRightLimit,
                    end: parseInt(this.svgCanvasRightLimit + this.svgCanvasOffset)
                }),
                params: {
                    histogram: this.histogram,
                    histogramLogarithm: this.histogramLogarithm,
                    histogramMax: this.histogramMax,
                    interval: this.interval
                },
                done: function (event) {
                    _this.getDataHandler(event);
                }
            });
            this.svgCanvasRightLimit = parseInt(this.svgCanvasRightLimit + this.svgCanvasOffset);
        }

    }

};

AlignmentTrack.prototype._removeDisplayedChunks = function (response) {
    //Returns an array avoiding already drawn features in this.chunksDisplayed

    var getChunkId = function (position) {
        return Math.floor(position / response.chunkSize);
    };
    var getChunkKey = function (chromosome, chunkId) {
        return chromosome + ":" + chunkId + "_" + response.dataType + "_" + response.chunkSize;
    };

    var chunks = response.items;
    var newChunks = [];

    var feature, displayed, featureFirstChunk, featureLastChunk, features = [];
    for (var i = 0, leni = chunks.length; i < leni; i++) { //loop over chunks
        if (this.chunksDisplayed[chunks[i].chunkKey] != true) { //check if any chunk is already displayed and skip it

            features = []; //initialize array, will contain features not drawn by other drawn chunks
            var alignments = chunks[i].value.alignments;
            if (alignments == null) {
                alignments = chunks[i].value;
            }
            for (var j = 0, lenj = alignments.length; j < lenj; j++) {
                feature = alignments[j];

                //check if any feature has been already displayed by another chunk
                displayed = false;
                featureFirstChunk = getChunkId(feature.start);
                featureLastChunk = getChunkId(feature.end);
                for (var chunkId = featureFirstChunk; chunkId <= featureLastChunk; chunkId++) { //loop over chunks touched by this feature
                    var chunkKey = getChunkKey(feature.chromosome, chunkId);
                    if (this.chunksDisplayed[chunkKey] == true) {
                        displayed = true;
                        break;
                    }
                }
                if (!displayed) {
                    features.push(feature);
                }
            }
            this.chunksDisplayed[chunks[i].chunkKey] = true;
            chunks[i].value.alignments = features; //update features array
            newChunks.push(chunks[i]);
        }
    }
    response.items = newChunks;
    return response;
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

FeatureTrack.prototype = new Track({});

function FeatureTrack(args) {
    Track.call(this, args);

    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    //set default args

    //save default render reference;
    this.defaultRenderer = this.renderer;
    //    this.histogramRenderer = new FeatureClusterRenderer();
    this.histogramRenderer = new window[this.histogramRendererName](args);

    this.featureType = 'Feature';
    //set instantiation args, must be last
    _.extend(this, args);

    this.resource = this.dataAdapter.resource;
    this.species = this.dataAdapter.species;

    this.dataType = 'features';
};

FeatureTrack.prototype.clean = function () {
    this._clean();

    //    console.time("-----------------------------------------empty");
    while (this.svgCanvasFeatures.firstChild) {
        this.svgCanvasFeatures.removeChild(this.svgCanvasFeatures.firstChild);
    }
    //    console.timeEnd("-----------------------------------------empty");
};

FeatureTrack.prototype.updateHeight = function () {
    //this._updateHeight();
    if (this.histogram) {
        this.contentDiv.style.height = this.histogramRenderer.histogramHeight + 5 + 'px';
        this.main.setAttribute('height', this.histogramRenderer.histogramHeight);
        return;
    }

    var renderedHeight = this.svgCanvasFeatures.getBoundingClientRect().height;
    this.main.setAttribute('height', renderedHeight);

    if (this.resizable) {
        if (this.autoHeight == false) {
            this.contentDiv.style.height = this.height + 10 + 'px';
        } else if (this.autoHeight == true) {
            var x = this.pixelPosition;
            var width = this.width;
            var lastContains = 0;
            for (var i in this.renderedArea) {
                if (this.renderedArea[i].contains({
                        start: x,
                        end: x + width
                    })) {
                    lastContains = i;
                }
            }
            var visibleHeight = parseInt(lastContains) + 30;
            this.contentDiv.style.height = visibleHeight + 10 + 'px';
            this.main.setAttribute('height', visibleHeight);
        }
    }
};

FeatureTrack.prototype.setWidth = function (width) {
    this._setWidth(width);
    this.main.setAttribute("width", this.width);
};

FeatureTrack.prototype.initializeDom = function (targetId) {
    this._initializeDom(targetId);

    this.main = SVG.addChild(this.contentDiv, 'svg', {
        'class': 'trackSvg',
        'x': 0,
        'y': 0,
        'width': this.width
    });
    this.svgCanvasFeatures = SVG.addChild(this.main, 'svg', {
        'class': 'features',
        'x': -this.pixelPosition,
        'width': this.svgCanvasWidth
    });
    this.updateHeight();
};

FeatureTrack.prototype.render = function (targetId) {
    this.initializeDom(targetId);

    this.svgCanvasOffset = (this.width * 3 / 2) / this.pixelBase;
    this.svgCanvasLeftLimit = this.region.start - this.svgCanvasOffset * 2;
    this.svgCanvasRightLimit = this.region.start + this.svgCanvasOffset * 2
};

FeatureTrack.prototype.getDataHandler = function (event) {
    var features;
    if (event.dataType == 'histogram') {
        this.renderer = this.histogramRenderer;
        features = event.items;
    } else {
        this.renderer = this.defaultRenderer;
        features = this.getFeaturesToRenderByChunk(event);
    }
    this.renderer.render(features, {
        cacheItems: event.items,
        svgCanvasFeatures: this.svgCanvasFeatures,
        featureTypes: this.featureTypes,
        renderedArea: this.renderedArea,
        pixelBase: this.pixelBase,
        position: this.region.center(),
        regionSize: this.region.length(),
        maxLabelRegionSize: this.maxLabelRegionSize,
        width: this.width,
        pixelPosition: this.pixelPosition,
        resource: this.resource,
        species: this.species,
        featureType: this.featureType
    });
    this.updateHeight();
};

FeatureTrack.prototype.draw = function () {
    var _this = this;

    this.svgCanvasOffset = (this.width * 3 / 2) / this.pixelBase;
    this.svgCanvasLeftLimit = this.region.start - this.svgCanvasOffset * 2;
    this.svgCanvasRightLimit = this.region.start + this.svgCanvasOffset * 2;

    this.updateHistogramParams();
    this.clean();

    this.dataType = 'features';
    if (this.histogram) {
        this.dataType = 'histogram';
    }

    if (typeof this.visibleRegionSize === 'undefined' || this.region.length() < this.visibleRegionSize) {
        this.setLoading(true);
        this.dataAdapter.getData({
            dataType: this.dataType,
            region: new Region({
                chromosome: this.region.chromosome,
                start: this.region.start - this.svgCanvasOffset * 2,
                end: this.region.end + this.svgCanvasOffset * 2
            }),
            params: {
                histogram: this.histogram,
                histogramLogarithm: this.histogramLogarithm,
                histogramMax: this.histogramMax,
                interval: this.interval
            },
            done: function (event) {
                _this.getDataHandler(event);
                _this.setLoading(false);
            }
        });

        //        this.invalidZoomText.setAttribute("visibility", "hidden");
    } else {
        //        this.invalidZoomText.setAttribute("visibility", "visible");
    }
    this.updateHeight();
};

FeatureTrack.prototype.move = function (disp) {
    var _this = this;

    this.dataType = 'features';
    if (this.histogram) {
        this.dataType = 'histogram';
    }

    _this.region.center();
    var pixelDisplacement = disp * _this.pixelBase;
    this.pixelPosition -= pixelDisplacement;

    //parseFloat important
    var move = parseFloat(this.svgCanvasFeatures.getAttribute("x")) + pixelDisplacement;
    this.svgCanvasFeatures.setAttribute("x", move);

    var virtualStart = parseInt(this.region.start - this.svgCanvasOffset);
    var virtualEnd = parseInt(this.region.end + this.svgCanvasOffset);

    if (typeof this.visibleRegionSize === 'undefined' || this.region.length() < this.visibleRegionSize) {

        if (disp > 0 && virtualStart < this.svgCanvasLeftLimit) {
            this.dataAdapter.getData({
                dataType: this.dataType,
                region: new Region({
                    chromosome: _this.region.chromosome,
                    start: parseInt(this.svgCanvasLeftLimit - this.svgCanvasOffset),
                    end: this.svgCanvasLeftLimit
                }),
                params: {
                    histogram: this.histogram,
                    histogramLogarithm: this.histogramLogarithm,
                    histogramMax: this.histogramMax,
                    interval: this.interval
                },
                done: function (event) {
                    _this.getDataHandler(event);
                }
            });
            this.svgCanvasLeftLimit = parseInt(this.svgCanvasLeftLimit - this.svgCanvasOffset);
        }

        if (disp < 0 && virtualEnd > this.svgCanvasRightLimit) {
            this.dataAdapter.getData({
                dataType: this.dataType,
                region: new Region({
                    chromosome: _this.region.chromosome,
                    start: this.svgCanvasRightLimit,
                    end: parseInt(this.svgCanvasRightLimit + this.svgCanvasOffset)
                }),
                params: {
                    histogram: this.histogram,
                    histogramLogarithm: this.histogramLogarithm,
                    histogramMax: this.histogramMax,
                    interval: this.interval
                },
                done: function (event) {
                    _this.getDataHandler(event);
                }

            });
            this.svgCanvasRightLimit = parseInt(this.svgCanvasRightLimit + this.svgCanvasOffset);
        }
    }

    if (this.autoHeight == true) {
        this.updateHeight();
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

GeneTrack.prototype = new Track({});

function GeneTrack(args) {
    Track.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    //set default args
    this.minTranscriptRegionSize;

    //save default render reference;
    this.defaultRenderer = this.renderer;
    //    this.histogramRenderer = new FeatureClusterRenderer();
    this.histogramRenderer = new HistogramRenderer(args);


    //set instantiation args, must be last
    _.extend(this, args);

    this.exclude;
};


GeneTrack.prototype.clean = function() {
    //    console.time("-----------------------------------------empty");
    while (this.svgCanvasFeatures.firstChild) {
        this.svgCanvasFeatures.removeChild(this.svgCanvasFeatures.firstChild);
    }
    //    console.timeEnd("-----------------------------------------empty");
    this._clean();
};

GeneTrack.prototype.updateHeight = function() {
    //    this._updateHeight();

    if (this.histogram) {
        this.contentDiv.style.height = this.histogramRenderer.histogramHeight + 5 + 'px';
        this.main.setAttribute('height', this.histogramRenderer.histogramHeight);
        return;
    }

    var renderedHeight = this.svgCanvasFeatures.getBoundingClientRect().height;
    this.main.setAttribute('height', renderedHeight);

    if (this.resizable) {
        if (this.autoHeight == false) {
            this.contentDiv.style.height = this.height + 10 + 'px';
        } else if (this.autoHeight == true) {
            var x = this.pixelPosition;
            var width = this.width;
            var lastContains = 0;
            for (var i in this.renderedArea) {
                if (this.renderedArea[i].contains({
                        start: x,
                        end: x + width
                    })) {
                    lastContains = i;
                }
            }
            var visibleHeight = parseInt(lastContains) + 30;
            this.contentDiv.style.height = visibleHeight + 10 + 'px';
            this.main.setAttribute('height', visibleHeight);
        }
    }
};

GeneTrack.prototype.setWidth = function(width) {
    this._setWidth(width);
    this.main.setAttribute("width", this.width);
};

GeneTrack.prototype.initializeDom = function(targetId) {
    this._initializeDom(targetId);

    this.main = SVG.addChild(this.contentDiv, 'svg', {
        'class': 'trackSvg',
        'x': 0,
        'y': 0,
        'width': this.width
    });
    this.svgCanvasFeatures = SVG.addChild(this.main, 'svg', {
        'class': 'features',
        'x': -this.pixelPosition,
        'width': this.svgCanvasWidth
    });
    this.updateHeight();
};

GeneTrack.prototype.render = function(targetId) {
    this.initializeDom(targetId);

    this.svgCanvasOffset = (this.width * 3 / 2) / this.pixelBase;
    this.svgCanvasLeftLimit = this.region.start - this.svgCanvasOffset * 2;
    this.svgCanvasRightLimit = this.region.start + this.svgCanvasOffset * 2
};

GeneTrack.prototype.getDataHandler = function(event) {
    var features;
    if (event.dataType == 'histogram') {
        this.renderer = this.histogramRenderer;
        features = event.items;
    } else {
        this.renderer = this.defaultRenderer;
        features = this.getFeaturesToRenderByChunk(event);
    }
    this.renderer.render(features, {
        cacheItems: event.items,
        svgCanvasFeatures: this.svgCanvasFeatures,
        renderedArea: this.renderedArea,
        pixelBase: this.pixelBase,
        position: this.region.center(),
        regionSize: this.region.length(),
        maxLabelRegionSize: this.maxLabelRegionSize,
        width: this.width,
        pixelPosition: this.pixelPosition

    });
    this.updateHeight();
};

GeneTrack.prototype.updateTranscriptParams = function() {
    if (this.region.length() < this.minTranscriptRegionSize) {
        this.exclude = this.dataAdapter.params.exclude;
    } else {
        this.exclude = 'transcripts,chunkIds';
    }
};

GeneTrack.prototype.draw = function() {
    var _this = this;

    this.svgCanvasOffset = (this.width * 3 / 2) / this.pixelBase;
    this.svgCanvasLeftLimit = this.region.start - this.svgCanvasOffset * 2;
    this.svgCanvasRightLimit = this.region.start + this.svgCanvasOffset * 2;

    this.updateTranscriptParams();
    this.updateHistogramParams();
    this.clean();

    var dataType = 'features';
    /*
     if (!_.isUndefined(this.exclude)) {
     dataType = 'features' + this.exclude.replace(/[,.]/gi,'');
     }*/

    if (this.histogram) {
        dataType = 'histogram';
    }


    if (typeof this.visibleRegionSize === 'undefined' || this.region.length() < this.visibleRegionSize) {
        this.setLoading(true);
        var data = this.dataAdapter.getData({
            dataType: dataType,
            region: new Region({
                chromosome: this.region.chromosome,
                start: this.region.start - this.svgCanvasOffset * 2,
                end: this.region.end + this.svgCanvasOffset * 2
            }),
            params: {
                histogram: this.histogram,
                histogramLogarithm: this.histogramLogarithm,
                histogramMax: this.histogramMax,
                interval: this.interval,
                exclude: this.exclude
            },
            done: function(event) {
                _this.getDataHandler(event);
                _this.setLoading(false);
            }
        });

        //        this.invalidZoomText.setAttribute("visibility", "hidden");
    } else {
        //        this.invalidZoomText.setAttribute("visibility", "visible");
    }
    this.updateHeight();
};


GeneTrack.prototype.move = function(disp) {
    var _this = this;

    this.dataType = 'features';

    if (!_.isUndefined(this.exclude)) {
        dataType = 'features' + this.exclude;
    }

    if (this.histogram) {
        this.dataType = 'histogram';
    }

    //    trackSvg.position = _this.region.center();
    _this.region.center();
    var pixelDisplacement = disp * _this.pixelBase;
    this.pixelPosition -= pixelDisplacement;

    //parseFloat important
    var move = parseFloat(this.svgCanvasFeatures.getAttribute("x")) + pixelDisplacement;
    this.svgCanvasFeatures.setAttribute("x", move);

    var virtualStart = parseInt(this.region.start - this.svgCanvasOffset);
    var virtualEnd = parseInt(this.region.end + this.svgCanvasOffset);
    // check if track is visible in this zoom

    //    console.log(virtualStart+'  ----  '+virtualEnd)
    //    console.log(this.svgCanvasLeftLimit+'  ----  '+this.svgCanvasRightLimit)
    //    console.log(this.svgCanvasOffset)

    if (typeof this.visibleRegionSize === 'undefined' || this.region.length() < this.visibleRegionSize) {

        if (disp > 0 && virtualStart < this.svgCanvasLeftLimit) {
            //          left
            this.dataAdapter.getData({
                dataType: this.dataType,
                region: new Region({
                    chromosome: _this.region.chromosome,
                    start: parseInt(this.svgCanvasLeftLimit - this.svgCanvasOffset),
                    end: this.svgCanvasLeftLimit
                }),
                params: {
                    histogram: this.histogram,
                    histogramLogarithm: this.histogramLogarithm,
                    histogramMax: this.histogramMax,
                    interval: this.interval,
                    exclude: this.exclude
                },
                done: function(event) {
                    _this.getDataHandler(event);
                }
            });
            this.svgCanvasLeftLimit = parseInt(this.svgCanvasLeftLimit - this.svgCanvasOffset);
        }

        if (disp < 0 && virtualEnd > this.svgCanvasRightLimit) {
            //          right
            this.dataAdapter.getData({
                dataType: this.dataType,
                region: new Region({
                    chromosome: _this.region.chromosome,
                    start: this.svgCanvasRightLimit,
                    end: parseInt(this.svgCanvasRightLimit + this.svgCanvasOffset)
                }),
                params: {
                    histogram: this.histogram,
                    histogramLogarithm: this.histogramLogarithm,
                    histogramMax: this.histogramMax,
                    interval: this.interval,
                    exclude: this.exclude
                },
                done: function(event) {
                    _this.getDataHandler(event);
                }
            });
            this.svgCanvasRightLimit = parseInt(this.svgCanvasRightLimit + this.svgCanvasOffset);
        }
    }

    if (this.autoHeight == true) {
        this.updateHeight();
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//Parent class for all renderers
function Renderer(args) {


};

Renderer.prototype = {

    render: function (items) {

    },

    getFeatureX: function (start, args) {//returns svg feature x value from feature genomic position
        var middle = args.width / 2;
        var x = args.pixelPosition + middle - ((args.position - start) * args.pixelBase);
        return x;
    },

    getDefaultConfig: function (type) {
        return FEATURE_TYPES[type];
    },
    getLabelWidth: function (label, args) {
        /* insert in dom to get the label width and then remove it*/
        var svgLabel = SVG.create("text", {
            'font-weight': 400,
            'class':this.fontClass
        });
        svgLabel.textContent = label;
        $(args.svgCanvasFeatures).append(svgLabel);
        var svgLabelWidth = $(svgLabel).width();
        $(svgLabel).remove();
        return svgLabelWidth;
    }
}
;
/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//any item with chromosome start end
AlignmentRenderer.prototype = new Renderer({});

function AlignmentRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.fontClass = 'ocb-font-roboto ocb-font-size-11';
    this.toolTipfontClass = 'ocb-tooltip-font';

    if (_.isObject(args)) {
        _.extend(this, args);
    }

    this.on(this.handlers);
};


AlignmentRenderer.prototype.render = function (response, args) {
    var _this = this;

    var sequenceDataAdapter = args.trackListPanel.getSequenceTrack().dataAdapter;

    //CHECK VISUALIZATON MODE
    if (_.isUndefined(response.params)) {
        response.params = {};
    }

    var viewAsPairs = false;
    if (response.params["view_as_pairs"] != null) {
        viewAsPairs = true;
    }
    console.log("viewAsPairs " + viewAsPairs);
    var insertSizeMin = 0;
    var insertSizeMax = 0;
    var variantColor = "orangered";
    if (response.params["insert_size_interval"] != null) {
        insertSizeMin = response.params["insert_size_interval"].split(",")[0];
        insertSizeMax = response.params["insert_size_interval"].split(",")[1];
    }
    console.log("insertSizeMin " + insertSizeMin);
    console.log("insertSizeMin " + insertSizeMax);

    //Prevent browser context menu
    $(args.svgCanvasFeatures).contextmenu(function (e) {
        console.log("click derecho")
        //e.preventDefault();
    });

    console.time("BamRender " + response.params.resource);

    var chunkList = response.items;

//    var middle = this.width / 2;

    var bamCoverGroup = SVG.addChild(args.svgCanvasFeatures, "g", {
        "class": "bamCoverage",
        "cursor": "pointer"
    });
    var bamReadGroup = SVG.addChild(args.svgCanvasFeatures, "g", {
        "class": "bamReads",
        "cursor": "pointer"
    });

    var drawCoverage = function (chunk) {
        //var coverageList = chunk.coverage.all;
        var coverageList = chunk.coverage.all;
        var coverageListA = chunk.coverage.a;
        var coverageListC = chunk.coverage.c;
        var coverageListG = chunk.coverage.g;
        var coverageListT = chunk.coverage.t;
        var start = parseInt(chunk.start);
        var end = parseInt(chunk.end);
        var pixelWidth = (end - start + 1) * args.pixelBase;

        var middle = args.width / 2;
        var points = "", pointsA = "", pointsC = "", pointsG = "", pointsT = "";
        var baseMid = (args.pixelBase / 2) - 0.5;//4.5 cuando pixelBase = 10

        var x, y, p = parseInt(chunk.start);
        var lineA = "", lineC = "", lineG = "", lineT = "";
        var coverageNorm = 200, covHeight = 50;
        for (var i = 0; i < coverageList.length; i++) {
            //x = _this.pixelPosition+middle-((_this.position-p)*_this.pixelBase)+baseMid;
            x = args.pixelPosition + middle - ((args.position - p) * args.pixelBase);
            xx = args.pixelPosition + middle - ((args.position - p) * args.pixelBase) + args.pixelBase;

            lineA += x + "," + coverageListA[i] / coverageNorm * covHeight + " ";
            lineA += xx + "," + coverageListA[i] / coverageNorm * covHeight + " ";
            lineC += x + "," + (coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineC += xx + "," + (coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineG += x + "," + (coverageListG[i] + coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineG += xx + "," + (coverageListG[i] + coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineT += x + "," + (coverageListT[i] + coverageListG[i] + coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineT += xx + "," + (coverageListT[i] + coverageListG[i] + coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";

            p++;
        }

        //reverse to draw the polylines(polygons) for each nucleotid
        var rlineC = lineC.split(" ").reverse().join(" ").trim();
        var rlineG = lineG.split(" ").reverse().join(" ").trim();
        var rlineT = lineT.split(" ").reverse().join(" ").trim();

        var firstPoint = args.pixelPosition + middle - ((args.position - parseInt(chunk.start)) * args.pixelBase) + baseMid;
        var lastPoint = args.pixelPosition + middle - ((args.position - parseInt(chunk.end)) * args.pixelBase) + baseMid;

        var polA = SVG.addChild(bamCoverGroup, "polyline", {
            "points": firstPoint + ",0 " + lineA + lastPoint + ",0",
            //"opacity":"1",
            //"stroke-width":"1",
            //"stroke":"gray",
            "fill": "green"
        });
        var polC = SVG.addChild(bamCoverGroup, "polyline", {
            "points": lineA + " " + rlineC,
            //"opacity":"1",
            //"stroke-width":"1",
            //"stroke":"black",
            "fill": "blue"
        });
        var polG = SVG.addChild(bamCoverGroup, "polyline", {
            "points": lineC + " " + rlineG,
            //"opacity":"1",
            //"stroke-width":"1",
            //"stroke":"black",
            "fill": "gold"
        });
        var polT = SVG.addChild(bamCoverGroup, "polyline", {
            "points": lineG + " " + rlineT,
            //"opacity":"1",
            //"stroke-width":"1",
            //"stroke":"black",
            "fill": "red"
        });

        var dummyRect = SVG.addChild(bamCoverGroup, "rect", {
            "x": args.pixelPosition + middle - ((args.position - start) * args.pixelBase),
            "y": 0,
            "width": pixelWidth,
            "height": covHeight,
            "opacity": "0.5",
            "fill": "lightgray",
            "cursor": "pointer"
        });


        $(dummyRect).qtip({
            content: " ",
            position: {target: 'mouse', adjust: {x: 15, y: 0}, viewport: $(window), effect: false},
            style: {width: true, classes: _this.toolTipfontClass + ' ui-tooltip-shadow'},
            show: {delay: 300},
            hide: {delay: 300}
        });


        args.trackListPanel.on('mousePosition:change', function (e) {
            var pos = e.mousePos - parseInt(chunk.start);
            //if(coverageList[pos]!=null){
            var str = 'depth: <span class="ssel">' + coverageList[pos] + '</span><br>' +
                '<span style="color:green">A</span>: <span class="ssel">' + chunk.coverage.a[pos] + '</span><br>' +
                '<span style="color:blue">C</span>: <span class="ssel">' + chunk.coverage.c[pos] + '</span><br>' +
                '<span style="color:darkgoldenrod">G</span>: <span class="ssel">' + chunk.coverage.g[pos] + '</span><br>' +
                '<span style="color:red">T</span>: <span class="ssel">' + chunk.coverage.t[pos] + '</span><br>';
            $(dummyRect).qtip('option', 'content.text', str);
            //}
        });
    };

    var drawSingleRead = function (feature) {
        //var start = feature.start;
        //var end = feature.end;
        var start = feature.unclippedStart;
        var end = feature.unclippedEnd;
        if (feature.end == 0) {
            end = start + feature.length - 1;
        }
        var length = (end - start) + 1;
        var differences = feature.differences;

        //get feature render configuration
        var color = _.isFunction(_this.color) ? _this.color(feature, args.region.chromosome) : _this.color;
        var strokeColor = _.isFunction(_this.strokeColor) ? _this.strokeColor(feature, args.region.chromosome) : _this.strokeColor;
        var label = _.isFunction(_this.label) ? _this.label(feature) : _this.label;
        var height = _.isFunction(_this.height) ? _this.height(feature) : _this.height;
        var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(feature) : _this.tooltipTitle;
        var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(feature) : _this.tooltipText;
        var strand = _.isFunction(_this.strand) ? _this.strand(feature) : _this.strand;
        var mateUnmappedFlag = _.isFunction(_this.mateUnmappedFlag) ? _this.mateUnmappedFlag(feature) : _this.mateUnmappedFlag;
        var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(feature) : _this.infoWidgetId;

        if (insertSizeMin != 0 && insertSizeMax != 0 && !mateUnmappedFlag) {
            if (Math.abs(feature.inferredInsertSize) > insertSizeMax) {
                color = 'maroon';
            }
            if (Math.abs(feature.inferredInsertSize) < insertSizeMin) {
                color = 'navy';
            }
        }

        //transform to pixel position
        var width = length * args.pixelBase;
        //calculate x to draw svg rect
        var x = _this.getFeatureX(start, args);
//		try{
//			var maxWidth = Math.max(width, /*settings.getLabel(feature).length*8*/0); //XXX cuidado : text.getComputedTextLength()
//		}catch(e){
//			var maxWidth = 72;
//		}
        maxWidth = width;
        //if(length <0){
        //    debugger
        //}
        console.log(length + ' in px: ' + width);


        var rowHeight = 16;
        var rowY = 70;
//		var textY = 12+settings.height;
        while (true) {
            if (args.renderedArea[rowY] == null) {
                args.renderedArea[rowY] = new FeatureBinarySearchTree();
            }
            var enc = args.renderedArea[rowY].add({start: x, end: x + maxWidth - 1});
            if (enc) {
                var featureGroup = SVG.addChild(bamReadGroup, "g", {'feature_id': feature.name});
                var points = {
                    "Reverse": x + "," + (rowY + (height / 2)) + " " + (x + 5) + "," + rowY + " " + (x + width) + "," + rowY + " " + (x + width) + "," + (rowY + height) + " " + (x + 5) + "," + (rowY + height),
                    "Forward": (x - 1) + "," + rowY + " " + (x + width - 5) + "," + rowY + " " + (x + width) + "," + (rowY + (height / 2)) + " " + (x + width - 5) + "," + (rowY + height) + " " + (x - 1) + "," + (rowY + height)
                }
                var poly = SVG.addChild(featureGroup, "polygon", {
                    "points": points[strand],
                    "stroke": color,
                    "stroke-width": 1,
                    "fill": color,
                    "cursor": "pointer"
                });

                $(featureGroup).qtip({
                    content: {text: tooltipText, title: tooltipTitle},
                    position: {target: "mouse", adjust: {x: 25, y: 15}},
                    style: {width: 300, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
                    show: 'mouseenter',
                    hide: 'mousedown mouseup mouseleave'
                });

                featureGroup.addEventListener('click', function (event) {
                    console.log(feature);
                    _this.trigger('feature:click', {
                        query: feature[infoWidgetId],
                        feature: feature,
                        featureType: feature.featureType,
                        clickEvent: event
                    })
                });

                //var rect = SVG.addChild(featureGroup,"rect",{
                //"x":x+offset[strand],
                //"y":rowY,
                //"width":width-4,
                //"height":settings.height,
                //"stroke": "white",
                //"stroke-width":1,
                //"fill": color,
                //"clip-path":"url(#"+_this.id+"cp)",
                //"fill": 'url(#'+_this.id+'bamStrand'+strand+')',
                //});
                //readEls.push(rect);

                //PROCESS differences
                if (differences != null && args.regionSize < 400) {
                    var region = new Region({chromosome: args.region.chromosome, start: start, end: end});
                    sequenceDataAdapter.getData({
                        region: region,
                        done: function (event) {
                            var referenceString = AlignmentRenderer._getReferenceString(event.items, region);
                            featureGroup.appendChild(AlignmentRenderer.drawBamDifferences(referenceString, differences, args.pixelBase, x, rowY + height));
                        }
                    });
                }

                break;
            }
            rowY += rowHeight;
//			textY += rowHeight;
        }
    };

    var drawPairedReads = function (read, mate) {
        var readStart = read.unclippedStart;
        var readEnd = read.unclippedEnd;
        var mateStart = mate.unclippedStart;
        var mateEnd = mate.unclippedEnd;
        var readDiff = read.diff;
        var mateDiff = mate.diff;
        /*get type settings object*/
        var readSettings = _this.types[read.featureType];
        var mateSettings = _this.types[mate.featureType];
        var readColor = readSettings.getColor(read, _this.region.chromosome);
        var mateColor = mateSettings.getColor(mate, _this.region.chromosome);
        var readStrand = readSettings.getStrand(read);
        var matestrand = mateSettings.getStrand(mate);

        if (insertSizeMin != 0 && insertSizeMax != 0) {
            if (Math.abs(read.inferredInsertSize) > insertSizeMax) {
                readColor = 'maroon';
                mateColor = 'maroon';
            }
            if (Math.abs(read.inferredInsertSize) < insertSizeMin) {
                readColor = 'navy';
                mateColor = 'navy';
            }
        }

        var pairStart = readStart;
        var pairEnd = mateEnd;
        if (mateStart <= readStart) {
            pairStart = mateStart;
        }
        if (readEnd >= mateEnd) {
            pairEnd = readEnd;
        }

        /*transform to pixel position*/
        var pairWidth = ((pairEnd - pairStart) + 1) * _this.pixelBase;
        var pairX = _this.pixelPosition + middle - ((_this.position - pairStart) * _this.pixelBase);

        var readWidth = ((readEnd - readStart) + 1) * _this.pixelBase;
        var readX = _this.pixelPosition + middle - ((_this.position - readStart) * _this.pixelBase);

        var mateWidth = ((mateEnd - mateStart) + 1) * _this.pixelBase;
        var mateX = _this.pixelPosition + middle - ((_this.position - mateStart) * _this.pixelBase);

        var rowHeight = 12;
        var rowY = 70;
//		var textY = 12+settings.height;

        while (true) {
            if (args.renderedArea[rowY] == null) {
                args.renderedArea[rowY] = new FeatureBinarySearchTree();
            }
            var enc = args.renderedArea[rowY].add({start: pairX, end: pairX + pairWidth - 1});
            if (enc) {
                var readEls = [];
                var mateEls = [];
                var readPoints = {
                    "Reverse": readX + "," + (rowY + (readSettings.height / 2)) + " " + (readX + 5) + "," + rowY + " " + (readX + readWidth - 5) + "," + rowY + " " + (readX + readWidth - 5) + "," + (rowY + readSettings.height) + " " + (readX + 5) + "," + (rowY + readSettings.height),
                    "Forward": readX + "," + rowY + " " + (readX + readWidth - 5) + "," + rowY + " " + (readX + readWidth) + "," + (rowY + (readSettings.height / 2)) + " " + (readX + readWidth - 5) + "," + (rowY + readSettings.height) + " " + readX + "," + (rowY + readSettings.height)
                }
                var readPoly = SVG.addChild(bamReadGroup, "polygon", {
                    "points": readPoints[readStrand],
                    "stroke": readSettings.getStrokeColor(read),
                    "stroke-width": 1,
                    "fill": readColor,
                    "cursor": "pointer"
                });
                readEls.push(readPoly);
                var matePoints = {
                    "Reverse": mateX + "," + (rowY + (mateSettings.height / 2)) + " " + (mateX + 5) + "," + rowY + " " + (mateX + mateWidth - 5) + "," + rowY + " " + (mateX + mateWidth - 5) + "," + (rowY + mateSettings.height) + " " + (mateX + 5) + "," + (rowY + mateSettings.height),
                    "Forward": mateX + "," + rowY + " " + (mateX + mateWidth - 5) + "," + rowY + " " + (mateX + mateWidth) + "," + (rowY + (mateSettings.height / 2)) + " " + (mateX + mateWidth - 5) + "," + (rowY + mateSettings.height) + " " + mateX + "," + (rowY + mateSettings.height)
                }
                var matePoly = SVG.addChild(bamReadGroup, "polygon", {
                    "points": matePoints[matestrand],
                    "stroke": mateSettings.getStrokeColor(mate),
                    "stroke-width": 1,
                    "fill": mateColor,
                    "cursor": "pointer"
                });
                mateEls.push(matePoly);

                var line = SVG.addChild(bamReadGroup, "line", {
                    "x1": (readX + readWidth),
                    "y1": (rowY + (readSettings.height / 2)),
                    "x2": mateX,
                    "y2": (rowY + (readSettings.height / 2)),
                    "stroke-width": "1",
                    "stroke": "gray",
                    //"stroke-color": "black",
                    "cursor": "pointer"
                });

                if (args.regionSize < 400) {
                    if (readDiff != null) {
                        var readPath = SVG.addChild(bamReadGroup, "path", {
                            "d": Utils.genBamVariants(readDiff, _this.pixelBase, readX, rowY),
                            "fill": variantColor
                        });
                        readEls.push(readPath);
                    }
                    if (mateDiff != null) {
                        var matePath = SVG.addChild(bamReadGroup, "path", {
                            "d": Utils.genBamVariants(mateDiff, _this.pixelBase, mateX, rowY),
                            "fill": variantColor
                        });
                        mateEls.push(matePath);
                    }
                }

                $(readEls).qtip({
                    content: {text: readSettings.getTipText(read), title: readSettings.getTipTitle(read)},
                    position: {target: "mouse", adjust: {x: 15, y: 0}, viewport: $(window), effect: false},
                    style: {width: 280, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
                    show: 'click',
                    hide: 'click mouseleave'
                });
                $(readEls).click(function (event) {
                    console.log(read);
                    _this.showInfoWidget({
                        query: read[readSettings.infoWidgetId],
                        feature: read,
                        featureType: read.featureType,
                        adapter: _this.trackData.adapter
                    });
                });
                $(mateEls).qtip({
                    content: {text: mateSettings.getTipText(mate), title: mateSettings.getTipTitle(mate)},
                    position: {target: "mouse", adjust: {x: 15, y: 0}, viewport: $(window), effect: false},
                    style: {width: 280, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
                    show: 'click',
                    hide: 'click mouseleave'
                });
                $(mateEls).click(function (event) {
                    console.log(mate);
                    _this.showInfoWidget({
                        query: mate[mateSettings.infoWidgetId],
                        feature: mate,
                        featureType: mate.featureType,
                        adapter: _this.trackData.adapter
                    });
                });
                break;
            }
            rowY += rowHeight;
//			textY += rowHeight;
        }
    };

    var drawChunk = function (chunk) {
        drawCoverage(chunk.value);
        var alignments = chunk.value.alignments;
        for (var i = 0, li = alignments.length; i < li; i++) {
            var alignment = alignments[i];
            if (viewAsPairs) {
                var nextRead = alignments[i + 1];
                if (nextRead != null) {
                    if (alignment.name == nextRead.name) {
                        drawPairedReads(alignment, nextRead);
                        i++;
                    } else {
                        drawSingleRead(alignment);
                    }
                }
            } else {
                drawSingleRead(alignment);
            }
        }
    };

    //process features
    if (chunkList.length > 0) {
        for (var i = 0, li = chunkList.length; i < li; i++) {
            drawChunk(chunkList[i]);
        }
//        var newHeight = Object.keys(this.renderedArea).length * 24;
//        if (newHeight > 0) {
//            this.setHeight(newHeight + /*margen entre tracks*/10 + 70);
//        }
        //TEST
//        this.setHeight(200);
    }
    console.timeEnd("BamRender " + response.params.resource);
};

/**
 * @Deprecated
 * **/
AlignmentRenderer.genBamVariants = function (differences, size, mainX, y) {

    var s = size / 6;
    var d = "";
    for (var i = 0; i < differences.length; i++) {
        var difference = differences[i];

        switch (difference.op) {
            case "S" :
                var x = mainX + (size * difference.pos);
                for (var j = 0; j < difference.length; j++) {
                    var char = difference.seq[j];
                    switch (char) {
                        case "A" :
                            d += "M" + ((2.5 * s) + x) + "," + (y) +
                                "l-" + (2.5 * s) + "," + (6 * s) +
                                "l" + s + ",0" +
                                "l" + (0.875 * s) + ",-" + (2 * s) +
                                "l" + (2.250 * s) + ",0" +
                                "l" + (0.875 * s) + "," + (2 * s) +
                                "l" + s + ",0" +
                                "l-" + (2.5 * s) + ",-" + (6 * s) +
                                "l-" + (0.5 * s) + ",0" +
                                "l0," + s +
                                "l" + (0.75 * s) + "," + (2 * s) +
                                "l-" + (1.5 * s) + ",0" +
                                "l" + (0.75 * s) + ",-" + (2 * s) +
                                "l0,-" + s +
                                " ";
                            break;
                        case "T" :
                            d += "M" + ((0.5 * s) + x) + "," + (y) +
                                "l0," + s +
                                "l" + (2 * s) + ",0" +
                                "l0," + (5 * s) +
                                "l" + s + ",0" +
                                "l0,-" + (5 * s) +
                                "l" + (2 * s) + ",0" +
                                "l0,-" + s +
                                " ";
                            break;
                        case "C" :
                            d += "M" + ((5 * s) + x) + "," + ((0 * s) + y) +
                                "l-" + (2 * s) + ",0" +
                                "l-" + (1.5 * s) + "," + (0.5 * s) +
                                "l-" + (0.5 * s) + "," + (1.5 * s) +
                                "l0," + (2 * s) +
                                "l" + (0.5 * s) + "," + (1.5 * s) +
                                "l" + (1.5 * s) + "," + (0.5 * s) +
                                "l" + (2 * s) + ",0" +
                                "l0,-" + s +
                                "l-" + (2 * s) + ",0" +
                                "l-" + (0.75 * s) + ",-" + (0.25 * s) +
                                "l-" + (0.25 * s) + ",-" + (0.75 * s) +
                                "l0,-" + (2 * s) +
                                "l" + (0.25 * s) + ",-" + (0.75 * s) +
                                "l" + (0.75 * s) + ",-" + (0.25 * s) +
                                "l" + (2 * s) + ",0" +
                                " ";
                            break;
                        case "G" :
                            d += "M" + ((5 * s) + x) + "," + ((0 * s) + y) +
                                "l-" + (2 * s) + ",0" +
                                "l-" + (1.5 * s) + "," + (0.5 * s) +
                                "l-" + (0.5 * s) + "," + (1.5 * s) +
                                "l0," + (2 * s) +
                                "l" + (0.5 * s) + "," + (1.5 * s) +
                                "l" + (1.5 * s) + "," + (0.5 * s) +
                                "l" + (2 * s) + ",0" +
                                "l0,-" + (3 * s) +
                                "l-" + (s) + ",0" +
                                "l0," + (2 * s) +
                                "l-" + (s) + ",0" +
                                "l-" + (0.75 * s) + ",-" + (0.25 * s) +
                                "l-" + (0.25 * s) + ",-" + (0.75 * s) +
                                "l0,-" + (2 * s) +
                                "l" + (0.25 * s) + ",-" + (0.75 * s) +
                                "l" + (0.75 * s) + ",-" + (0.25 * s) +
                                "l" + (2 * s) + ",0" +
                                " ";
//                d += "M" + ((5 * s) + x) + "," + ((0 * s) + y) +
//                    "l-" + (2 * s) + ",0" +
//                    "l-" + (2 * s) + "," + (2 * s) +
//                    "l0," + (2 * s) +
//                    "l" + (2 * s) + "," + (2 * s) +
//                    "l" + (2 * s) + ",0" +
//                    "l0,-" + (3 * s) +
//                    "l-" + (1 * s) + ",0" +
//                    "l0," + (2 * s) +
//                    "l-" + (0.5 * s) + ",0" +
//                    "l-" + (1.5 * s) + ",-" + (1.5 * s) +
//                    "l0,-" + (1 * s) +
//                    "l" + (1.5 * s) + ",-" + (1.5 * s) +
//                    "l" + (1.5 * s) + ",0" +
//                    " ";
                            break;
                        case "N" :
                            d += "M" + ((0.5 * s) + x) + "," + ((0 * s) + y) +
                                "l0," + (6 * s) +
                                "l" + s + ",0" +
                                "l0,-" + (4.5 * s) +
                                "l" + (3 * s) + "," + (4.5 * s) +
                                "l" + s + ",0" +
                                "l0,-" + (6 * s) +
                                "l-" + s + ",0" +
                                "l0," + (4.5 * s) +
                                "l-" + (3 * s) + ",-" + (4.5 * s) +
                                " ";
                            break;
                        case "d" :
                            d += "M" + ((0 * s) + x) + "," + ((2.5 * s) + y) +
                                "l" + (6 * s) + ",0" +
                                "l0," + (s) +
                                "l-" + (6 * s) + ",0" +
                                "l0,-" + (s) +
                                " ";
                            break;
                        default:
                            d += "M0,0";
                            break;
                    }
                    x += size;
                }
                break;
        }

    }

    return d;
};

AlignmentRenderer.drawBamDifferences = function (refString, differences, size, mainX, y) {
    var text = SVG.create("text", {
        "x": mainX,
        "y": y - 2,
        "class": 'ocb-font-ubuntumono ocb-font-size-15'
    });
    for (var i = 0; i < differences.length; i++) {
        var difference = differences[i];

        switch (difference.op) {
            // M 0 alignment match (can be a sequence match or mismatch)
            // I 1 insertion to the reference
            // D 2 deletion from the reference
            // N 3 skipped region from the reference
            // S 4 soft clipping (clipped sequences present in SEQ)
            // H 5 hard clipping (clipped sequences NOT present in SEQ)
            //P 6 padding (silent deletion from padded reference)
            //= 7 sequence match
            // X 8 sequence mismatch

            case "I" :
                var x = mainX + (size * difference.pos) - size / 2;
                var t = SVG.addChild(text, "tspan", {
                    "x": x,
                    "font-weight": 'bold',
                    "textLength": size
                });
                t.textContent = '·';
                $(t).qtip({
                    content: {text: difference.seq, title: 'Insertion'},
                    position: {target: "mouse", adjust: {x: 25, y: 15}},
                    style: {classes: this.toolTipfontClass + ' qtip-dark qtip-shadow'}
                });
                break;
            case "D" :
                var x = mainX + (size * difference.pos);
                for (var j = 0; j < difference.length; j++) {
                    var t = SVG.addChild(text, "tspan", {
                        "x": x,
                        "font-weight": 'bold',
                        "textLength": size
                    });
                    t.textContent = '—';
                    x += size;
                }
                break;
            case "N" :
                var x = mainX + (size * difference.pos);
                for (var j = 0; j < difference.length; j++) {
                    var t = SVG.addChild(text, "tspan", {
                        "x": x,
                        "fill": "#888",
                        "textLength": size
                    });
                    t.textContent = '—';
                    x += size;
                }
                break;
            case "S" :
                var x = mainX + (size * difference.pos);
                for (var j = 0; j < difference.length; j++) {
                    var char = difference.seq[j];
                    var t = SVG.addChild(text, "tspan", {
                        "x": x,
                        "fill": "#aaa",
                        "textLength": size
                    });
                    t.textContent = char;
                    x += size;
                }
                break;
            case "H" :
                var x = mainX + (size * difference.pos);
                for (var j = 0; j < difference.length; j++) {
                    var t = SVG.addChild(text, "tspan", {
                        "x": x,
                        "fill": "#aaa",
                        "textLength": size
                    });
                    t.textContent = 'H';
                    x += size;
                }
                break;
            case "X" :
            case "M" :
                var x = mainX + (size * difference.pos);
                for (var j = 0; j < difference.length; j++) {
                    var char = difference.seq[j];
                    var refPos = difference.pos + j;
                    // console.log("ref:"+ refString.charAt(refPos)+" - "+"seq:"+char);
                    if (char != refString.charAt(refPos)) {
                        var t = SVG.addChild(text, "tspan", {
                            "x": x,
                            "fill": SEQUENCE_COLORS[char],
                            "textLength": size
                        });
                        t.textContent = char;
                    }
                    x += size;
                }
                break;
        }

    }

    return text;
};

AlignmentRenderer._getReferenceString = function (chunks, region) {
    var sequenceItems = [];
    var chunk;
    for (var i = 0; i < chunks.length; i++) {
        chunk = chunks[i];
        for (var j = 0; j < chunk.value.length; j++) {
            sequenceItems.push(chunk.value[j]);
        }
    }
    sequenceItems.sort(function (a, b) {
        return a.start - b.start;
    });
    var aux = [];
    var s = sequenceItems[0].start;
    var e = sequenceItems[sequenceItems.length - 1].end;
    for (var i = 0; i < sequenceItems.length; i++) {
        aux.push(sequenceItems[i].sequence);
    }
    var str = aux.join("");
    var i1 = region.start - s;
    var i2 = i1 + region.length();
    var substr = str.substring(i1, i2);

    return substr;
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//any item with chromosome start end
BamRenderer.prototype = new Renderer({});

function BamRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.fontClass = 'ocb-font-roboto ocb-font-size-11';
    this.toolTipfontClass = 'ocb-tooltip-font';

    if (_.isObject(args)) {
        _.extend(this, args);
    } else {
        _.extend(this, FEATURE_TYPES.bam)
    }

    this.on(this.handlers);
};

BamRenderer.prototype.render = function (response, args) {
    var _this = this;

    var sequenceDataAdapter = args.trackListPanel.getSequenceTrack().dataAdapter;
    var variantColor = "orangered";
    var chunkList = args.cacheItems;
    var viewAsPairs = false;

    var bamCoverGroup = SVG.addChild(args.svgCanvasFeatures, "g", {
        "class": "bamCoverage",
        "cursor": "pointer"
    });
    var bamReadGroup = SVG.addChild(args.svgCanvasFeatures, "g", {
        "class": "bamReads",
        "cursor": "pointer"
    });

    var drawCoverage = function (chunk) {
        //TODO !!! INSERTIONS AND DELETIONS NOT CONTEMPLED
        var cs = chunk.region.start;
        var ce = chunk.region.end;
        var cl = new Region(chunk.region).length();
        var reads = chunk.value;

        var coverageListA = Array.apply(null, Array(cl)).map(Number.prototype.valueOf, 0);
        var coverageListC = Array.apply(null, Array(cl)).map(Number.prototype.valueOf, 0);
        var coverageListG = Array.apply(null, Array(cl)).map(Number.prototype.valueOf, 0);
        var coverageListT = Array.apply(null, Array(cl)).map(Number.prototype.valueOf, 0);
        var coverageList = Array.apply(null, Array(cl)).map(Number.prototype.valueOf, 0);
        for (var i = 0; i < reads.length; i++) {
            var read = reads[i];
            BamRenderer._processRead(read);
            for (var j = 0; j < read.differences.length; j++) {
                var d = read.differences[j];
                if (d.op != "S" && d.op != "H" && d.op != "I" && d.seq != null) {
                    for (var k = 0; k < d.seq.length; k++) {
                        var nt = d.seq[k];
                        var ntPos = read.start + d.pos + k;
                        if (ntPos >= cs && ntPos <= ce) {
                            switch (nt) {
                            case "A":
                                coverageListA[ntPos - cs]++;
                                break;
                            case "C":
                                coverageListC[ntPos - cs]++;
                                break;
                            case "G":
                                coverageListG[ntPos - cs]++;
                                break;
                            case "T":
                                coverageListT[ntPos - cs]++;
                                break;
                            }
                        }
                    }
                }
            }
        }
        var pixelWidth = cl * args.pixelBase;

        var middle = args.width / 2;
        var points = "",
            pointsA = "",
            pointsC = "",
            pointsG = "",
            pointsT = "";
        var baseMid = (args.pixelBase / 2) - 0.5; //4.5 cuando pixelBase = 10

        var x, y, p = parseInt(cs);
        var lineA = "",
            lineC = "",
            lineG = "",
            lineT = "";
        var coverageNorm = 300,
            covHeight = 50;
        for (var i = 0; i < coverageList.length; i++) {
            //x = _this.pixelPosition+middle-((_this.position-p)*_this.pixelBase)+baseMid;
            x = args.pixelPosition + middle - ((args.position - p) * args.pixelBase);
            xx = args.pixelPosition + middle - ((args.position - p) * args.pixelBase) + args.pixelBase;

            lineA += x + "," + coverageListA[i] / coverageNorm * covHeight + " ";
            lineA += xx + "," + coverageListA[i] / coverageNorm * covHeight + " ";
            lineC += x + "," + (coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineC += xx + "," + (coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineG += x + "," + (coverageListG[i] + coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineG += xx + "," + (coverageListG[i] + coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineT += x + "," + (coverageListT[i] + coverageListG[i] + coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";
            lineT += xx + "," + (coverageListT[i] + coverageListG[i] + coverageListC[i] + coverageListA[i]) / coverageNorm * covHeight + " ";

            p++;
        }

        //Use reverse to draw the polylines(polygons) for each nucleotid
        var rlineC = lineC.split(" ").reverse().join(" ").trim();
        var rlineG = lineG.split(" ").reverse().join(" ").trim();
        var rlineT = lineT.split(" ").reverse().join(" ").trim();

        var firstPoint = args.pixelPosition + middle - ((args.position - parseInt(cs)) * args.pixelBase) + baseMid;
        var lastPoint = args.pixelPosition + middle - ((args.position - parseInt(ce)) * args.pixelBase) + baseMid;

        var polA = SVG.addChild(bamCoverGroup, "polyline", {
            "points": firstPoint + ",0 " + lineA + lastPoint + ",0",
            //"opacity":"1",
            //"stroke-width":"1",
            //"stroke":"gray",
            "fill": "green"
        });
        var polC = SVG.addChild(bamCoverGroup, "polyline", {
            "points": lineA + " " + rlineC,
            //"opacity":"1",
            //"stroke-width":"1",
            //"stroke":"black",
            "fill": "blue"
        });
        var polG = SVG.addChild(bamCoverGroup, "polyline", {
            "points": lineC + " " + rlineG,
            //"opacity":"1",
            //"stroke-width":"1",
            //"stroke":"black",
            "fill": "gold"
        });
        var polT = SVG.addChild(bamCoverGroup, "polyline", {
            "points": lineG + " " + rlineT,
            //"opacity":"1",
            //"stroke-width":"1",
            //"stroke":"black",
            "fill": "red"
        });

        // var dummyRect = SVG.addChild(bamCoverGroup, "rect", {
        //     "x": args.pixelPosition + middle - ((args.position - cs) * args.pixelBase),
        //     "y": 0,
        //     "width": pixelWidth,
        //     "height": bamCoverGroup.getBoundingClientRect().height,
        //     "opacity": "0.5",
        //     "fill": "lightgray",
        //     "cursor": "pointer"
        // });

        $(bamCoverGroup).qtip({
            content: " ",
            position: {
                target: 'mouse',
                adjust: {
                    x: 15,
                    y: 0
                },
                viewport: $(window),
                effect: false
            },
            style: {
                width: true,
                classes: _this.toolTipfontClass + ' ui-tooltip-shadow'
            },
            show: {
                delay: 300
            },
            hide: {
                delay: 300
            }
        });

        args.trackListPanel.on('mousePosition:change', function (e) {
            var pos = e.mousePos - parseInt(cs);
            //if(coverageList[pos]!=null){
            var str = 'depth: <span class="ssel">' + coverageList[pos] + '</span><br>' +
                '<span style="color:green">A</span>: <span class="ssel">' + coverageListA[pos] + '</span><br>' +
                '<span style="color:blue">C</span>: <span class="ssel">' + coverageListC[pos] + '</span><br>' +
                '<span style="color:darkgoldenrod">G</span>: <span class="ssel">' + coverageListG[pos] + '</span><br>' +
                '<span style="color:red">T</span>: <span class="ssel">' + coverageListT[pos] + '</span><br>';
            $(bamCoverGroup).qtip('option', 'content.text', str);
            //}
        });
    };

    var drawSingleRead = function (feature) {
        var start = feature.start;
        // var start = feature.unclippedStart;
        var end = feature.end;
        // var end = feature.unclippedEnd;
        // if (feature.end == 0) {
        //     end = start + feature.length - 1;
        // }
        var length = (end - start) + 1;

        //get feature render configuration
        var color = _.isFunction(_this.color) ? _this.color(feature, args.region.chromosome) : _this.color;
        var strokeColor = _.isFunction(_this.strokeColor) ? _this.strokeColor(feature, args.region.chromosome) : _this.strokeColor;
        var label = _.isFunction(_this.label) ? _this.label(feature) : _this.label;
        var height = _.isFunction(_this.height) ? _this.height(feature) : _this.height;
        var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(feature) : _this.tooltipTitle;
        var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(feature) : _this.tooltipText;
        var strand = _.isFunction(_this.strand) ? _this.strand(feature) : _this.strand;
        var mateUnmappedFlag = _.isFunction(_this.mateUnmappedFlag) ? _this.mateUnmappedFlag(feature) : _this.mateUnmappedFlag;
        var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(feature) : _this.infoWidgetId;

        // TODO CHECK
        // if (insertSizeMin != 0 && insertSizeMax != 0 && !mateUnmappedFlag) {
        //     if (Math.abs(feature.inferredInsertSize) > insertSizeMax) {
        //         color = 'maroon';
        //     }
        //     if (Math.abs(feature.inferredInsertSize) < insertSizeMin) {
        //         color = 'navy';
        //     }
        // }

        //transform to pixel position
        var width = length * args.pixelBase;
        //calculate x to draw svg rect
        var x = _this.getFeatureX(start, args);
        //		try{
        //			var maxWidth = Math.max(width, /*settings.getLabel(feature).length*8*/0); //XXX cuidado : text.getComputedTextLength()
        //		}catch(e){
        //			var maxWidth = 72;
        //		}
        maxWidth = width;
        //if(length <0){
        //    debugger
        //}
        // console.log(length + ' in px: ' + width);

        var rowHeight = 16;
        var rowY = bamCoverGroup.getBoundingClientRect().height + 10;
        //		var textY = 12+settings.height;
        while (true) {
            if (args.renderedArea[rowY] == null) {
                args.renderedArea[rowY] = new FeatureBinarySearchTree();
            }
            var enc = args.renderedArea[rowY].add({
                start: x,
                end: x + maxWidth - 1
            });
            if (enc) {
                var featureGroup = SVG.addChild(bamReadGroup, "g", {
                    'feature_id': feature.QNAME
                });
                var points = {
                    "Reverse": x + "," + (rowY + (height / 2)) + " " + (x + 5) + "," + rowY + " " + (x + width) + "," + rowY + " " + (x + width) + "," + (rowY + height) + " " + (x + 5) + "," + (rowY + height),
                    "Forward": (x - 1) + "," + rowY + " " + (x + width - 5) + "," + rowY + " " + (x + width) + "," + (rowY + (height / 2)) + " " + (x + width - 5) + "," + (rowY + height) + " " + (x - 1) + "," + (rowY + height)
                }
                var poly = SVG.addChild(featureGroup, "polygon", {
                    "points": points[strand],
                    "stroke": color,
                    "stroke-width": 1,
                    "fill": color,
                    "cursor": "pointer"
                });

                $(featureGroup).qtip({
                    content: {
                        text: tooltipText,
                        title: tooltipTitle
                    },
                    position: {
                        target: "mouse",
                        viewport: $(window),
                        adjust: {
                            x: 25,
                            y: 15
                        }
                    },
                    style: {
                        classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'
                    },
                    show: 'mouseenter',
                    hide: 'mousedown mouseup mouseleave'
                });

                featureGroup.addEventListener('click', function (event) {
                    console.log(feature);
                    _this.trigger('feature:click', {
                        query: feature[infoWidgetId],
                        feature: feature,
                        featureType: feature.featureType,
                        clickEvent: event
                    })
                });

                //var rect = SVG.addChild(featureGroup,"rect",{
                //"x":x+offset[strand],
                //"y":rowY,
                //"width":width-4,
                //"height":settings.height,
                //"stroke": "white",
                //"stroke-width":1,
                //"fill": color,
                //"clip-path":"url(#"+_this.id+"cp)",
                //"fill": 'url(#'+_this.id+'bamStrand'+strand+')',
                //});
                //readEls.push(rect);

                //PROCESS differences
                if (feature.differences != null && args.regionSize < 400) {
                    var region = new Region({
                        chromosome: args.region.chromosome,
                        start: start,
                        end: end
                    });
                    sequenceDataAdapter.getData({
                        region: region,
                        done: function (event) {
                            var referenceString = BamRenderer._getReferenceString(event.items, region);
                            featureGroup.appendChild(BamRenderer.drawBamDifferences(referenceString, feature.differences, args.pixelBase, x, rowY + height));
                        }
                    });
                }
                break;
            }
            rowY += rowHeight;
            //			textY += rowHeight;
        }
    };

    var drawPairedReads = function (read, mate) {
        var readStart = read.unclippedStart;
        var readEnd = read.unclippedEnd;
        var mateStart = mate.unclippedStart;
        var mateEnd = mate.unclippedEnd;
        var readDiff = read.diff;
        var mateDiff = mate.diff;
        /*get type settings object*/
        var readSettings = _this.types[read.featureType];
        var mateSettings = _this.types[mate.featureType];
        var readColor = readSettings.getColor(read, _this.region.chromosome);
        var mateColor = mateSettings.getColor(mate, _this.region.chromosome);
        var readStrand = readSettings.getStrand(read);
        var matestrand = mateSettings.getStrand(mate);

        if (insertSizeMin != 0 && insertSizeMax != 0) {
            if (Math.abs(read.inferredInsertSize) > insertSizeMax) {
                readColor = 'maroon';
                mateColor = 'maroon';
            }
            if (Math.abs(read.inferredInsertSize) < insertSizeMin) {
                readColor = 'navy';
                mateColor = 'navy';
            }
        }

        var pairStart = readStart;
        var pairEnd = mateEnd;
        if (mateStart <= readStart) {
            pairStart = mateStart;
        }
        if (readEnd >= mateEnd) {
            pairEnd = readEnd;
        }

        /*transform to pixel position*/
        var pairWidth = ((pairEnd - pairStart) + 1) * _this.pixelBase;
        var pairX = _this.pixelPosition + middle - ((_this.position - pairStart) * _this.pixelBase);

        var readWidth = ((readEnd - readStart) + 1) * _this.pixelBase;
        var readX = _this.pixelPosition + middle - ((_this.position - readStart) * _this.pixelBase);

        var mateWidth = ((mateEnd - mateStart) + 1) * _this.pixelBase;
        var mateX = _this.pixelPosition + middle - ((_this.position - mateStart) * _this.pixelBase);

        var rowHeight = 12;
        var rowY = 70;
        //		var textY = 12+settings.height;

        while (true) {
            if (args.renderedArea[rowY] == null) {
                args.renderedArea[rowY] = new FeatureBinarySearchTree();
            }
            var enc = args.renderedArea[rowY].add({
                start: pairX,
                end: pairX + pairWidth - 1
            });
            if (enc) {
                var readEls = [];
                var mateEls = [];
                var readPoints = {
                    "Reverse": readX + "," + (rowY + (readSettings.height / 2)) + " " + (readX + 5) + "," + rowY + " " + (readX + readWidth - 5) + "," + rowY + " " + (readX + readWidth - 5) + "," + (rowY + readSettings.height) + " " + (readX + 5) + "," + (rowY + readSettings.height),
                    "Forward": readX + "," + rowY + " " + (readX + readWidth - 5) + "," + rowY + " " + (readX + readWidth) + "," + (rowY + (readSettings.height / 2)) + " " + (readX + readWidth - 5) + "," + (rowY + readSettings.height) + " " + readX + "," + (rowY + readSettings.height)
                }
                var readPoly = SVG.addChild(bamReadGroup, "polygon", {
                    "points": readPoints[readStrand],
                    "stroke": readSettings.getStrokeColor(read),
                    "stroke-width": 1,
                    "fill": readColor,
                    "cursor": "pointer"
                });
                readEls.push(readPoly);
                var matePoints = {
                    "Reverse": mateX + "," + (rowY + (mateSettings.height / 2)) + " " + (mateX + 5) + "," + rowY + " " + (mateX + mateWidth - 5) + "," + rowY + " " + (mateX + mateWidth - 5) + "," + (rowY + mateSettings.height) + " " + (mateX + 5) + "," + (rowY + mateSettings.height),
                    "Forward": mateX + "," + rowY + " " + (mateX + mateWidth - 5) + "," + rowY + " " + (mateX + mateWidth) + "," + (rowY + (mateSettings.height / 2)) + " " + (mateX + mateWidth - 5) + "," + (rowY + mateSettings.height) + " " + mateX + "," + (rowY + mateSettings.height)
                }
                var matePoly = SVG.addChild(bamReadGroup, "polygon", {
                    "points": matePoints[matestrand],
                    "stroke": mateSettings.getStrokeColor(mate),
                    "stroke-width": 1,
                    "fill": mateColor,
                    "cursor": "pointer"
                });
                mateEls.push(matePoly);

                var line = SVG.addChild(bamReadGroup, "line", {
                    "x1": (readX + readWidth),
                    "y1": (rowY + (readSettings.height / 2)),
                    "x2": mateX,
                    "y2": (rowY + (readSettings.height / 2)),
                    "stroke-width": "1",
                    "stroke": "gray",
                    //"stroke-color": "black",
                    "cursor": "pointer"
                });

                if (args.regionSize < 400) {
                    if (readDiff != null) {
                        var readPath = SVG.addChild(bamReadGroup, "path", {
                            "d": Utils.genBamVariants(readDiff, _this.pixelBase, readX, rowY),
                            "fill": variantColor
                        });
                        readEls.push(readPath);
                    }
                    if (mateDiff != null) {
                        var matePath = SVG.addChild(bamReadGroup, "path", {
                            "d": Utils.genBamVariants(mateDiff, _this.pixelBase, mateX, rowY),
                            "fill": variantColor
                        });
                        mateEls.push(matePath);
                    }
                }

                $(readEls).qtip({
                    content: {
                        text: readSettings.getTipText(read),
                        title: readSettings.getTipTitle(read)
                    },
                    position: {
                        target: "mouse",
                        adjust: {
                            x: 15,
                            y: 0
                        },
                        viewport: $(window),
                        effect: false
                    },
                    style: {
                        classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'
                    },
                    show: 'click',
                    hide: 'click mouseleave'
                });
                $(readEls).click(function (event) {
                    console.log(read);
                    _this.showInfoWidget({
                        query: read[readSettings.infoWidgetId],
                        feature: read,
                        featureType: read.featureType,
                        adapter: _this.trackData.adapter
                    });
                });
                $(mateEls).qtip({
                    content: {
                        text: mateSettings.getTipText(mate),
                        title: mateSettings.getTipTitle(mate)
                    },
                    position: {
                        target: "mouse",
                        adjust: {
                            x: 15,
                            y: 0
                        },
                        viewport: $(window),
                        effect: false
                    },
                    style: {
                        classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'
                    },
                    show: 'click',
                    hide: 'click mouseleave'
                });
                $(mateEls).click(function (event) {
                    console.log(mate);
                    _this.showInfoWidget({
                        query: mate[mateSettings.infoWidgetId],
                        feature: mate,
                        featureType: mate.featureType,
                        adapter: _this.trackData.adapter
                    });
                });
                break;
            }
            rowY += rowHeight;
            //			textY += rowHeight;
        }
    };

    var drawChunk = function (chunk) {
        drawCoverage(chunk);
        var reads = chunk.value;
        for (var i = 0, li = reads.length; i < li; i++) {
            var read = reads[i];
            if (viewAsPairs) {
                var nextRead = reads[i + 1];
                if (nextRead != null) {
                    if (read.QNAME == nextRead.QNAME) {
                        drawPairedReads(read, nextRead);
                        i++;
                    } else {
                        drawSingleRead(read);
                    }
                }
            } else {
                drawSingleRead(read);
            }
        }
    };

    //process features
    if (chunkList.length > 0) {
        for (var i = 0, li = chunkList.length; i < li; i++) {
            var chunk = chunkList[i];
            drawChunk(chunk);
        }
        //        var newHeight = Object.keys(this.renderedArea).length * 24;
        //        if (newHeight > 0) {
        //            this.setHeight(newHeight + /*margen entre tracks*/10 + 70);
        //        }
        //TEST
        //        this.setHeight(200);
    }
    // console.timeEnd("BamRender " + response.params.resource);
};

BamRenderer._processRead = function (read) {
    // Sum of lengths of the M/I/S/=/X operations shall equal the length of SEQ.

    var enableSoftClipping = true;

    var readPos = parseInt(read.POS);
    var start = readPos;
    var end = readPos;

    var cigarList = read.CIGAR.match(/[0-9]+[MIDNSHPX=]/g);
    var differences = [];
    if (cigarList != null) {
        var seqIndex = 0;
        var posIndex = 0;
        for (var i = 0; i < cigarList.length; i++) {
            var cigar = cigarList[i];
            var op = cigar.match(/[MIDNSHPX=]/)[0];
            var len = parseInt(cigar.replace(op, ''));
            var pos, seq;

            switch (op) {
            case "H":
                break;
            case "D":
            case "N":
                seq = "";
                pos = posIndex;
                posIndex += len;

                end += len;
                break;
            case "S":
                seq = read.SEQ.substr(seqIndex, len);
                seqIndex += len;
                if (i == (cigarList.length - 1)) {
                    pos = posIndex;
                } else {
                    pos = posIndex - len;
                }
                break;
            case "I":
                seq = read.SEQ.substr(seqIndex, len);
                seqIndex += len;
                pos = posIndex;

                end += len;
                break
            case "M":
            case "=":
            case "X":
                seq = read.SEQ.substr(seqIndex, len);
                pos = posIndex;
                posIndex += len;
                seqIndex += len;

                end += len;
                break;
            }
            differences.push({
                op: op,
                pos: pos,
                seq: seq,
                length: len
            });
        }
    }

    read.chromosome = read.RNAME;
    read.start = start;
    read.end = end - 1;
    read.differences = differences;
};

BamRenderer.drawBamDifferences = function (refString, differences, size, mainX, y) {
    var text = SVG.create("text", {
        "x": mainX,
        "y": y - 2,
        "class": 'ocb-font-ubuntumono ocb-font-size-15'
    });
    for (var i = 0; i < differences.length; i++) {
        var difference = differences[i];

        switch (difference.op) {
            // M 0 alignment match (can be a sequence match or mismatch)
            // I 1 insertion to the reference
            // D 2 deletion from the reference
            // N 3 skipped region from the reference
            // S 4 soft clipping (clipped sequences present in SEQ)
            // H 5 hard clipping (clipped sequences NOT present in SEQ)
            //P 6 padding (silent deletion from padded reference)
            //= 7 sequence match
            // X 8 sequence mismatch

        case "I":
            var x = mainX + (size * difference.pos) - size / 2;
            var t = SVG.addChild(text, "tspan", {
                "x": x,
                "font-weight": 'bold',
                "textLength": size
            });
            t.textContent = '· ';
            $(t).qtip({
                content: {
                    text: difference.seq,
                    title: 'Insertion'
                },
                position: {
                    target: "mouse",
                    viewport: $(window),
                    adjust: {
                        x: 25,
                        y: 15
                    }
                },
                style: {
                    classes: this.toolTipfontClass + ' qtip-dark qtip-shadow'
                }
            });
            break;
        case "D":
            var x = mainX + (size * difference.pos);
            for (var j = 0; j < difference.length; j++) {
                var t = SVG.addChild(text, "tspan", {
                    "x": x,
                    "font-weight": 'bold',
                    "textLength": size
                });
                t.textContent = '—';
                x += size;
            }
            break;
        case "N":
            var x = mainX + (size * difference.pos);
            for (var j = 0; j < difference.length; j++) {
                var t = SVG.addChild(text, "tspan", {
                    "x": x,
                    "fill": "#888",
                    "textLength": size
                });
                t.textContent = '—';
                x += size;
            }
            break;
        case "S":
            break; // clipping disabled
            var x = mainX + (size * difference.pos);
            for (var j = 0; j < difference.length; j++) {
                var char = difference.seq[j];
                var t = SVG.addChild(text, "tspan", {
                    "x": x,
                    "fill": "#aaa",
                    "textLength": size
                });
                t.textContent = char;
                x += size;
            }
            break;
        case "H":
            break; // clipping disabled
            var x = mainX + (size * difference.pos);
            for (var j = 0; j < difference.length; j++) {
                var t = SVG.addChild(text, "tspan", {
                    "x": x,
                    "fill": "#aaa",
                    "textLength": size
                });
                t.textContent = 'H';
                x += size;
            }
            break;
        case "X":
        case "=":
        case "M":
            var x = mainX + (size * difference.pos);
            for (var j = 0; j < difference.length; j++) {
                var char = difference.seq[j];
                var refPos = difference.pos + j;
                // console.log("ref:"+ refString.charAt(refPos)+" - "+"seq:"+char);
                if (char != refString.charAt(refPos)) {
                    var t = SVG.addChild(text, "tspan", {
                        "x": x,
                        "fill": SEQUENCE_COLORS[char],
                        "textLength": size
                    });
                    t.textContent = char;
                }
                x += size;
            }
            break;
        }

    }

    return text;
};

BamRenderer._getReferenceString = function (chunks, region) {
    var sequenceItems = [];
    var chunk;
    for (var i = 0; i < chunks.length; i++) {
        chunk = chunks[i];
        for (var j = 0; j < chunk.value.length; j++) {
            sequenceItems.push(chunk.value[j]);
        }
    }
    sequenceItems.sort(function (a, b) {
        return a.start - b.start;
    });
    var aux = [];
    var s = sequenceItems[0].start;
    var e = sequenceItems[sequenceItems.length - 1].end;
    for (var i = 0; i < sequenceItems.length; i++) {
        aux.push(sequenceItems[i].sequence);
    }
    var str = aux.join("");
    var i1 = region.start - s;
    var i2 = i1 + region.length();
    var substr = str.substring(i1, i2);

    return substr;
};

/**
 * @Deprecated
 * **/
BamRenderer.genBamVariants = function (differences, size, mainX, y) {

    var s = size / 6;
    var d = "";
    for (var i = 0; i < differences.length; i++) {
        var difference = differences[i];

        switch (difference.op) {
        case "S":
            var x = mainX + (size * difference.pos);
            for (var j = 0; j < difference.length; j++) {
                var char = difference.seq[j];
                switch (char) {
                case "A":
                    d += "M" + ((2.5 * s) + x) + "," + (y) +
                        "l-" + (2.5 * s) + "," + (6 * s) +
                        "l" + s + ",0" +
                        "l" + (0.875 * s) + ",-" + (2 * s) +
                        "l" + (2.250 * s) + ",0" +
                        "l" + (0.875 * s) + "," + (2 * s) +
                        "l" + s + ",0" +
                        "l-" + (2.5 * s) + ",-" + (6 * s) +
                        "l-" + (0.5 * s) + ",0" +
                        "l0," + s +
                        "l" + (0.75 * s) + "," + (2 * s) +
                        "l-" + (1.5 * s) + ",0" +
                        "l" + (0.75 * s) + ",-" + (2 * s) +
                        "l0,-" + s +
                        " ";
                    break;
                case "T":
                    d += "M" + ((0.5 * s) + x) + "," + (y) +
                        "l0," + s +
                        "l" + (2 * s) + ",0" +
                        "l0," + (5 * s) +
                        "l" + s + ",0" +
                        "l0,-" + (5 * s) +
                        "l" + (2 * s) + ",0" +
                        "l0,-" + s +
                        " ";
                    break;
                case "C":
                    d += "M" + ((5 * s) + x) + "," + ((0 * s) + y) +
                        "l-" + (2 * s) + ",0" +
                        "l-" + (1.5 * s) + "," + (0.5 * s) +
                        "l-" + (0.5 * s) + "," + (1.5 * s) +
                        "l0," + (2 * s) +
                        "l" + (0.5 * s) + "," + (1.5 * s) +
                        "l" + (1.5 * s) + "," + (0.5 * s) +
                        "l" + (2 * s) + ",0" +
                        "l0,-" + s +
                        "l-" + (2 * s) + ",0" +
                        "l-" + (0.75 * s) + ",-" + (0.25 * s) +
                        "l-" + (0.25 * s) + ",-" + (0.75 * s) +
                        "l0,-" + (2 * s) +
                        "l" + (0.25 * s) + ",-" + (0.75 * s) +
                        "l" + (0.75 * s) + ",-" + (0.25 * s) +
                        "l" + (2 * s) + ",0" +
                        " ";
                    break;
                case "G":
                    d += "M" + ((5 * s) + x) + "," + ((0 * s) + y) +
                        "l-" + (2 * s) + ",0" +
                        "l-" + (1.5 * s) + "," + (0.5 * s) +
                        "l-" + (0.5 * s) + "," + (1.5 * s) +
                        "l0," + (2 * s) +
                        "l" + (0.5 * s) + "," + (1.5 * s) +
                        "l" + (1.5 * s) + "," + (0.5 * s) +
                        "l" + (2 * s) + ",0" +
                        "l0,-" + (3 * s) +
                        "l-" + (s) + ",0" +
                        "l0," + (2 * s) +
                        "l-" + (s) + ",0" +
                        "l-" + (0.75 * s) + ",-" + (0.25 * s) +
                        "l-" + (0.25 * s) + ",-" + (0.75 * s) +
                        "l0,-" + (2 * s) +
                        "l" + (0.25 * s) + ",-" + (0.75 * s) +
                        "l" + (0.75 * s) + ",-" + (0.25 * s) +
                        "l" + (2 * s) + ",0" +
                        " ";
                    //                d += "M" + ((5 * s) + x) + "," + ((0 * s) + y) +
                    //                    "l-" + (2 * s) + ",0" +
                    //                    "l-" + (2 * s) + "," + (2 * s) +
                    //                    "l0," + (2 * s) +
                    //                    "l" + (2 * s) + "," + (2 * s) +
                    //                    "l" + (2 * s) + ",0" +
                    //                    "l0,-" + (3 * s) +
                    //                    "l-" + (1 * s) + ",0" +
                    //                    "l0," + (2 * s) +
                    //                    "l-" + (0.5 * s) + ",0" +
                    //                    "l-" + (1.5 * s) + ",-" + (1.5 * s) +
                    //                    "l0,-" + (1 * s) +
                    //                    "l" + (1.5 * s) + ",-" + (1.5 * s) +
                    //                    "l" + (1.5 * s) + ",0" +
                    //                    " ";
                    break;
                case "N":
                    d += "M" + ((0.5 * s) + x) + "," + ((0 * s) + y) +
                        "l0," + (6 * s) +
                        "l" + s + ",0" +
                        "l0,-" + (4.5 * s) +
                        "l" + (3 * s) + "," + (4.5 * s) +
                        "l" + s + ",0" +
                        "l0,-" + (6 * s) +
                        "l-" + s + ",0" +
                        "l0," + (4.5 * s) +
                        "l-" + (3 * s) + ",-" + (4.5 * s) +
                        " ";
                    break;
                case "d":
                    d += "M" + ((0 * s) + x) + "," + ((2.5 * s) + y) +
                        "l" + (6 * s) + ",0" +
                        "l0," + (s) +
                        "l-" + (6 * s) + ",0" +
                        "l0,-" + (s) +
                        " ";
                    break;
                default:
                    d += "M0,0";
                    break;
                }
                x += size;
            }
            break;
        }

    }

    return d;
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

ConservedRenderer.prototype = new Renderer({});

function ConservedRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    //set default args
    //set instantiation args
    _.extend(this, args);

};

ConservedRenderer.prototype.render = function (chunks, args) {
    for (var i = 0; i < chunks.length; i++) {
        this._paintChunk(chunks[i], args);
    }
};

ConservedRenderer.prototype._paintChunk = function (chunk, args) {
    var middle = args.width / 2;
    var multiplier = 15;
    var histogramHeight = 75;
    var points = '';
    var width = args.pixelBase;

    var x = args.pixelPosition + middle - ((args.position - parseInt(chunk.start)) * args.pixelBase);

    for (var i = 0, len = chunk.values.length; i < len; i++) {
        var value = chunk.values[i];
        var height = value * multiplier;
        var s = chunk.start + i;
        var x = args.pixelPosition + middle - ((args.position - s) * args.pixelBase);
        points += (x) + "," + 0 + " ";
        points += (x) + "," + (histogramHeight - height) + " ";
        points += (x + width) + "," + (histogramHeight - height) + " ";
        points += (x + width) + "," + 0 + " ";
    }

    var pol = SVG.addChild(args.svgCanvasFeatures, "polyline", {
        "points": points,
        "stroke": "#000000",
        "stroke-width": 0.2,
        "fill": 'salmon',
        "cursor": "pointer"
    });


};


/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

FeatureClusterRenderer.prototype = new Renderer({});

function FeatureClusterRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    //set default args
    this.histogramHeight = 75;
    this.multiplier = 7;



//    this.maxValue = 100;
//    if (args != null) {
//        if (args.height != null) {
//            this.histogramHeight = args.height * 0.95;
//        }
//        if (args.histogramMaxFreqValue != null) {
//            this.maxValue = args.histogramMaxFreqValue;
//        }
//    }
//    this.multiplier = this.histogramHeight / this.maxValue;

    this.fontClass = 'ocb-font-roboto ocb-font-size-11';
    this.toolTipfontClass = 'ocb-tooltip-font';

    //set instantiation args
    _.extend(this, args);

};


FeatureClusterRenderer.prototype.render = function (features, args) {
    var _this = this;
    var middle = args.width / 2;
    var maxValue = 0;

    var drawFeature = function (feature) {
        var d = '';

        feature.start = parseInt(feature.start);
        feature.end = parseInt(feature.end);
        var width = (feature.end - feature.start);

        width = width * args.pixelBase;
        var x = _this.getFeatureX(feature.start, args);

        if (feature.features_count == null) {
//            var height = Math.log(features[i].absolute);
            if (feature.absolute != 0) {
                feature.features_count = Math.log(features[i].absolute);
            } else {
                feature.features_count = 0;
            }
        }

        var height = feature.features_count * _this.multiplier;

        var rect = SVG.addChild(args.svgCanvasFeatures, "rect", {
            'x': x + 1,
            'y': 0,
            'width': width - 1,
            'height': height,
            'stroke': 'smokewhite',
            'stroke-width': 1,
            'fill': '#9493b1',
            'cursor': 'pointer'
        });

        var getInfo = function (feature) {
            var resp = '';
            return resp += Math.round(Math.exp(feature.features_count));
        };


        var url = CellBaseManager.url({
            species: args.species,
            category: 'genomic',
            subCategory: 'region',
            query: new Region(feature).toString(),
            resource: args.resource,
            params: {
                include: 'chromosome,start,end,id',
                limit: 20
            },
            async: false
//            success:function(data){
//                str+=data.response[0].result.length+' cb';
//            }
        });

        $(rect).qtip({
            content: {
                text: 'Loading...', // The text to use whilst the AJAX request is loading
                ajax: {
                    url: url, // URL to the local file
                    type: 'GET', // POST or GET
                    success: function (data, status) {
                        var items = data.response[0].result;
                        var ids = '';
                        for (var i = 0; i < items.length; i++) {
                            var f = items[i];
                            var r = new Region(f);
                            ids += '<span class="emph">' + f.id + '</span> <span class="info">' + r.toString() + '</span><br>';
                        }
                        var fc = Math.round(Math.exp(feature.features_count));
                        if (fc <= 20) {
                            this.set('content.title', 'Count: ' + items.length);
                            this.set('content.text', ids);
                        } else {
                            this.set('content.title', 'Count: ' + fc);
                            this.set('content.text', ids + '...');
                        }
                    }
                }
            },
            position: {target: 'mouse', adjust: {x: 25, y: 15}},
            style: { width: true, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
            show: {delay: 300},
            hide: {delay: 300}
        });

//        $(rect).qtip({
//            content: {text: getInfo(feature), title: 'Count'},
//
//        });

//        $(rect).mouseenter(function(){
//            var str = '';
////            $(rect).qtip({
////                content: {text: str, title: 'Info'},
//////                position: {target: "mouse", adjust: {x: 25, y: 15}},
////                style: { width: true, classes: 'ui-tooltip ui-tooltip-shadow'}
////            });
//        });

    };

    for (var i = 0, len = features.length; i < len; i++) {
        drawFeature(features[i].value);
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//any item with chromosome start end
FeatureRenderer.prototype = new Renderer({});

function FeatureRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.fontClass = 'ocb-font-roboto ocb-font-size-11';
    this.toolTipfontClass = 'ocb-tooltip-font';

    if (args == null) {
        args = FEATURE_TYPES.undefined;
    }

    if (_.isObject(args)) {
        _.extend(this, args);
    }

    this.on(this.handlers);
};


FeatureRenderer.prototype.render = function (features, args) {
    var _this = this;
    var draw = function (feature, svgGroup) {

        if ('featureType' in feature) {
            _.extend(_this, FEATURE_TYPES[feature.featureType]);
        }
        if ('featureClass' in feature) {
            _.extend(_this, FEATURE_TYPES[feature.featureClass]);
        }

        //Temporal fix for clinical
        if (args.featureType == 'clinical') {
            if ('clinvarSet' in feature) {
                _.extend(_this, FEATURE_TYPES['Clinvar'])
            } else if ('mutationID' in feature) {
                _.extend(_this, FEATURE_TYPES['Cosmic'])
            }else{
                _.extend(_this, FEATURE_TYPES['GWAS'])
            }
        }


        ////check feature class
        //if (feature.featureClass != null) {//regulatory
        //    _.extend(_this, FEATURE_TYPES[feature.featureClass]);
        //} else if (feature.source != null) {//clinical
        //    _.extend(_this, FEATURE_TYPES[feature.source]);
        //}

        //get feature render configuration
        var color = _.isFunction(_this.color) ? _this.color(feature) : _this.color;
        var strokeColor = _.isFunction(_this.strokeColor) ? _this.color(feature) : _this.strokeColor;
        var label = _.isFunction(_this.label) ? _this.label(feature) : _this.label;
        var height = _.isFunction(_this.height) ? _this.height(feature) : _this.height;
        var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(feature) : _this.tooltipTitle;
        var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(feature) : _this.tooltipText;
        var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(feature) : _this.infoWidgetId;

        //get feature genomic information
        var start = feature.start;
        var end = feature.end;
        var length = (end - start) + 1;

        //check genomic length
        length = (length < 0) ? Math.abs(length) : length;
        length = (length == 0) ? 1 : length;

        //transform to pixel position
        var width = length * args.pixelBase;

//        var svgLabelWidth = _this.getLabelWidth(label, args);
        var svgLabelWidth = label.length * 6.4;

        //calculate x to draw svg rect
        var x = _this.getFeatureX(start, args);

        var maxWidth = Math.max(width, 2);
        var textHeight = 0;
        if (args.maxLabelRegionSize > args.regionSize) {
            textHeight = 9;
            maxWidth = Math.max(width, svgLabelWidth);
        }


        var rowY = 0;
        var textY = textHeight + height;
        var rowHeight = textHeight + height + 2;

        while (true) {
            if (!(rowY in args.renderedArea)) {
                args.renderedArea[rowY] = new FeatureBinarySearchTree();
            }
            var foundArea = args.renderedArea[rowY].add({start: x, end: x + maxWidth - 1});

            if (foundArea) {
                var featureGroup = SVG.addChild(svgGroup, "g", {'feature_id': feature.id});
                var rect = SVG.addChild(featureGroup, "rect", {
                    'x': x,
                    'y': rowY,
                    'width': width,
                    'height': height,
                    'stroke': strokeColor,
                    'stroke-width': 1,
                    'stroke-opacity': 0.7,
                    'fill': color,
                    'cursor': 'pointer'
                });
                if (args.maxLabelRegionSize > args.regionSize) {
                    var text = SVG.addChild(featureGroup, "text", {
                        'i': i,
                        'x': x,
                        'y': textY,
                        'font-weight': 400,
                        'opacity': null,
                        'fill': 'black',
                        'cursor': 'pointer',
                        'class': _this.fontClass
                    });
                    text.textContent = label;
                }

                if ('tooltipText' in _this) {
                    $(featureGroup).qtip({
                        content: {text: tooltipText, title: tooltipTitle},
//                        position: {target: "mouse", adjust: {x: 15, y: 0}, effect: false},
                        position: {viewport: $(window), target: "mouse", adjust: {x: 25, y: 15}},
                        style: {width: true, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
                        show: {delay: 300},
                        hide: {delay: 300}
                    });
                }

                $(featureGroup).mouseover(function (event) {
                    _this.trigger('feature:mouseover', {
                        query: feature[infoWidgetId],
                        feature: feature,
                        featureType: feature.featureType,
                        mouseoverEvent: event
                    })
                });

                $(featureGroup).click(function (event) {
                    _this.trigger('feature:click', {
                        query: feature[infoWidgetId],
                        feature: feature,
                        featureType: feature.featureType,
                        clickEvent: event
                    })
                });
                break;
            }
            rowY += rowHeight;
            textY += rowHeight;
        }
    };


    /****/
    var timeId = "write dom " + Utils.randomString(4);
    console.time(timeId);
    console.log(features.length);
    /****/


    var svgGroup = SVG.create('g');
    for (var i = 0, leni = features.length; i < leni; i++) {
        draw(features[i], svgGroup);
    }
    args.svgCanvasFeatures.appendChild(svgGroup);


    /****/
    console.timeEnd(timeId);
    /****/
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//any item with chromosome start end
GeneRenderer.prototype = new Renderer({});

function GeneRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.fontClass = 'ocb-font-roboto ocb-font-size-11';
    this.toolTipfontClass = 'ocb-tooltip-font';

    if (_.isObject(args)) {
        _.extend(this, args);
    }

    this.on(this.handlers);
};

GeneRenderer.prototype.setFeatureConfig = function (configObject) {
    _.extend(this, configObject);
};

GeneRenderer.prototype.render = function (features, args) {
    var _this = this;
    var draw = function (feature) {
        //get feature render configuration

        //get feature render configuration
        _this.setFeatureConfig(FEATURE_TYPES.gene);
        var color = _.isFunction(_this.color) ? _this.color(feature) : _this.color;
        var label = _.isFunction(_this.label) ? _this.label(feature) : _this.label;
        var height = _.isFunction(_this.height) ? _this.height(feature) : _this.height;
        var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(feature) : _this.tooltipTitle;
        var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(feature) : _this.tooltipText;
        var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(feature) : _this.infoWidgetId;


        //get feature genomic information
        var start = feature.start;
        var end = feature.end;
        var length = (end - start) + 1;

        //transform to pixel position
        var width = length * args.pixelBase;


        // var svgLabelWidth = _this.getLabelWidth(label, args);
        var svgLabelWidth = label.length * 6.4;

        //calculate x to draw svg rect
        var x = _this.getFeatureX(start, args);

        var maxWidth = Math.max(width, 2);
        var textHeight = 0;
        if (args.maxLabelRegionSize > args.regionSize) {
            textHeight = 9;
            maxWidth = Math.max(width, svgLabelWidth);
        }

        var rowY = 0;
        var textY = textHeight + height + 1;
        var rowHeight = textHeight + height + 5;

        while (true) {
            if (!(rowY in args.renderedArea)) {
                args.renderedArea[rowY] = new FeatureBinarySearchTree();
            }

            var foundArea;//if true, i can paint

            //check if gene transcripts can be painted
            var checkRowY = rowY;
            var foundTranscriptsArea = true;
            if (!_.isEmpty(feature.transcripts)) {
                for (var i = 0, leni = feature.transcripts.length + 1; i < leni; i++) {
                    if (!(checkRowY in args.renderedArea)) {
                        args.renderedArea[checkRowY] = new FeatureBinarySearchTree();
                    }
                    if (args.renderedArea[checkRowY].contains({start: x, end: x + maxWidth - 1})) {
                        foundTranscriptsArea = false;
                        break;
                    }
                    checkRowY += rowHeight;
                }
                if (foundTranscriptsArea == true) {
                    foundArea = args.renderedArea[rowY].add({start: x, end: x + maxWidth - 1});
                }
            } else {
                foundArea = args.renderedArea[rowY].add({start: x, end: x + maxWidth - 1});
            }

            //paint genes
            if (foundArea) {
                var featureGroup = SVG.addChild(args.svgCanvasFeatures, "g", {
                    'feature_id': feature.id
                });
                var rect = SVG.addChild(featureGroup, 'rect', {
                    'x': x,
                    'y': rowY,
                    'width': width,
                    'height': height,
                    'stroke': '#3B0B0B',
                    'stroke-width': 0.5,
                    'fill': color,
                    'cursor': 'pointer'
                });

                if (args.maxLabelRegionSize > args.regionSize) {
                    var text = SVG.addChild(featureGroup, 'text', {
                        'i': i,
                        'x': x,
                        'y': textY,
                        'fill': 'black',
                        'cursor': 'pointer',
                        'class': _this.fontClass
                    });
                    text.textContent = label;
                }

                $(featureGroup).qtip({
                    content: {text: tooltipText, title: tooltipTitle},
                    // position: {target: "mouse", adjust: {x: 15, y: 0}, viewport: $(window), effect: false},
                    position: {target: "mouse", adjust: {x: 25, y: 15}},
                    style: {width: true, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
                    show: {delay: 300},
                    hide: {delay: 300}
                });


                featureGroup.addEventListener('click', function (e) {
                    _this.trigger('feature:click', {
                        query: feature[infoWidgetId],
                        feature: feature,
                        featureType: 'gene',
                        clickEvent: e
                    });
                });

                //paint transcripts
                var checkRowY = rowY + rowHeight;
                var checkTextY = textY + rowHeight;
                if (!_.isEmpty(feature.transcripts)) {
                    for (var i = 0, leni = feature.transcripts.length; i < leni; i++) { /*Loop over transcripts*/
                        if (!(checkRowY in args.renderedArea)) {
                            args.renderedArea[checkRowY] = new FeatureBinarySearchTree();
                        }
                        var transcript = feature.transcripts[i];
                        var transcriptX = _this.getFeatureX(transcript.start, args);
                        var transcriptWidth = (transcript.end - transcript.start + 1) * ( args.pixelBase);

                        //get type settings object
                        _this.setFeatureConfig(FEATURE_TYPES.transcript);
                        var transcriptColor = _.isFunction(_this.color) ? _this.color(transcript) : _this.color;
                        var label = _.isFunction(_this.label) ? _this.label(transcript) : _this.label;
                        var height = _.isFunction(_this.height) ? _this.height(transcript) : _this.height;
                        var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(transcript) : _this.tooltipTitle;
                        var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(transcript) : _this.tooltipText;
                        var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(transcript) : _this.infoWidgetId;

                        //  se resta el trozo del final del gen hasta el principio del transcrito y se le suma el texto del transcrito
                        // var svgLabelWidth = _this.getLabelWidth(label, args);
                        var svgLabelWidth = label.length * 6.4;
                        var maxWidth = Math.max(width, width - ((feature.end - transcript.start) * ( args.pixelBase)) + svgLabelWidth);


                        //add to the tree the transcripts size
                        args.renderedArea[checkRowY].add({start: x, end: x + maxWidth - 1});


                        var transcriptGroup = SVG.addChild(args.svgCanvasFeatures, 'g', {
                            "data-widget-id": transcript[infoWidgetId],
                            "data-transcript-idx": i
                        });


                        var rect = SVG.addChild(transcriptGroup, 'rect', {//this rect its like a line
                            'x': transcriptX,
                            'y': checkRowY + 1,
                            'width': transcriptWidth,
                            'height': height,
                            'fill': 'gray',
                            'cursor': 'pointer',
                            'feature_id': transcript.id
                        });
                        var text = SVG.addChild(transcriptGroup, 'text', {
                            'x': transcriptX,
                            'y': checkTextY,
                            'fill': 'black',
                            'cursor': 'pointer',
                            'class': _this.fontClass
                        });
                        text.textContent = label;


                        $(transcriptGroup).qtip({
                            content: {text: tooltipText, title: tooltipTitle},
                            // position: {target: 'mouse', adjust: {x: 15, y: 0}, viewport: $(window), effect: false},
                            position: {target: "mouse", adjust: {x: 25, y: 15}},
                            style: {width: true, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
                            show: {delay: 300},
                            hide: {delay: 300}
                        });
                        transcriptGroup.addEventListener('click', function (e) {
                            var query = this.getAttribute('data-widget-id');
                            var idx = this.getAttribute("data-transcript-idx");
                            _this.trigger('feature:click', {
                                query: query,
                                feature: feature.transcripts[idx],
                                featureType: 'transcript',
                                clickEvent: event
                            });
                        });


                        //paint exons
                        for (var e = 0, lene = feature.transcripts[i].exons.length; e < lene; e++) {
                            var exon = feature.transcripts[i].exons[e];
                            var exonStart = parseInt(exon.start);
                            var exonEnd = parseInt(exon.end);
                            var middle = args.width / 2;

                            var exonX = args.pixelPosition + middle - ((args.position - exonStart) * args.pixelBase);
                            var exonWidth = (exonEnd - exonStart + 1) * ( args.pixelBase);


                            _this.setFeatureConfig(FEATURE_TYPES.exon);
                            var color = _.isFunction(_this.color) ? _this.color(exon) : _this.color;
                            var label = _.isFunction(_this.label) ? _this.label(exon) : _this.label;
                            var height = _.isFunction(_this.height) ? _this.height(exon) : _this.height;
                            var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(exon) : _this.tooltipTitle;
                            var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(exon, transcript) : _this.tooltipText;
                            var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(exon) : _this.infoWidgetId;

                            var exonGroup = SVG.addChild(args.svgCanvasFeatures, "g", {
                                "class": "ocb-coding",
                                "data-id": exon.id
                            });

                            $(exonGroup).qtip({
                                content: {text: tooltipText, title: tooltipTitle},
                                // position: {target: 'mouse', adjust: {x: 15, y: 0}, viewport: $(window), effect: false},
                                position: {target: "mouse", adjust: {x: 25, y: 15}},
                                style: {width: true, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
                                show: {delay: 300},
                                hide: {delay: 300}
                            });
                            exonGroup.addEventListener('click', function (e) {
                                // console.log(this.dataset.id);
                            });


                            // Paint exons in white without coding region
                            var eRect = SVG.addChild(exonGroup, "rect", {
                                "i": i,
                                "x": exonX,
                                "y": checkRowY - 1,
                                "width": exonWidth,
                                "height": height,
                                "stroke": "gray",
                                "stroke-width": 1,
                                "fill": "white",
                                "cursor": "pointer"
                            });

                            var codingLength = exon.genomicCodingEnd - exon.genomicCodingStart;
                            var codingX = args.pixelPosition + middle - ((args.position - exon.genomicCodingStart) * args.pixelBase);
                            var codingReverseX = args.pixelPosition + middle - ((args.position - exon.genomicCodingEnd) * args.pixelBase);
                            var codingWidth = (codingLength + 1) * (args.pixelBase);
                            if (codingLength > 0) {
                                var cRect = SVG.addChild(exonGroup, "rect", {
                                    "i": i,
                                    "x": codingX,
                                    "y": checkRowY - 1,
                                    "width": codingWidth,
                                    "height": height,
                                    "stroke": transcriptColor,
                                    "stroke-width": 1,
                                    "fill": transcriptColor,
                                    "cursor": "pointer"
                                });
                                if (args.pixelBase > 9.5 && transcript.proteinSequence != null && exon.phase != null) {
                                    if (exon.strand == '+') {
                                        var proteinString = transcript.proteinSequence.substring(Math.floor(exon.cdsStart / 3), Math.floor(exon.cdsEnd / 3));
                                        var proteinPhaseOffset = codingX - (((3 - exon.phase) % 3) * args.pixelBase);
                                        var sign = 1;

                                    } else if (exon.strand == '-') {
                                        var proteinString = transcript.proteinSequence.substring(Math.floor(exon.cdsStart / 3), Math.ceil(exon.cdsEnd / 3));
                                        var proteinPhaseOffset = codingReverseX - (args.pixelBase * 2) - (exon.phase * args.pixelBase);
                                        var sign = -1;
                                    }
                                    for (var j = 0; j < proteinString.length; j++) {
                                        var codonRect = SVG.addChild(exonGroup, "rect", {
                                            "x": proteinPhaseOffset + (sign * args.pixelBase * 3 * j ),
                                            "y": checkRowY - 1,
                                            "width": (args.pixelBase * 3),
                                            "height": height,
                                            'stroke': '#3B0B0B',
                                            'stroke-width': 0.5,
                                            "fill": CODON_CONFIG[proteinString.charAt(j)].color,
                                            "class": 'ocb-codon'
                                        });
                                        var codonText = SVG.addChild(exonGroup, "text", {
                                            "x": proteinPhaseOffset + (sign * args.pixelBase * j * 3) + args.pixelBase / 3,
                                            "y": checkRowY - 3,
                                            "width": (args.pixelBase * 3),
                                            "class": 'ocb-font-ubuntumono ocb-font-size-16 ocb-codon'
                                        });
                                        codonText.textContent = CODON_CONFIG[proteinString.charAt(j)].text;
                                    }
                                }

                                // Draw phase only at zoom 100, where this.pixelBase < 11
                                //if (args.pixelBase < 11 && exon.phase != null && exon.phase != -1) {
                                //    for (var p = 0, lenp = 3 - exon.phase; p < lenp; p++) {
                                //        SVG.addChild(exonGroup, "rect", {
                                //            "i": i,
                                //            "x": codingX + (p * args.pixelBase),
                                //            "y": checkRowY - 1,
                                //            "width": args.pixelBase,
                                //            "height": height,
                                //            "stroke": color,
                                //            "stroke-width": 1,
                                //            "fill": 'white',
                                //            "cursor": "pointer"
                                //        });
                                //    }
                                //}
                            }
                        }
                        checkRowY += rowHeight;
                        checkTextY += rowHeight;
                    }
                }// if transcrips != null
                break;
            }
            rowY += rowHeight;
            textY += rowHeight;
        }
    };

    //process features
    for (var i = 0, leni = features.length; i < leni; i++) {
        draw(features[i]);
    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

HistogramRenderer.prototype = new Renderer({});

function HistogramRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    //set default args
    this.histogramHeight = 75;
    this.histogramColor = '#428bca';
    //    this.multiplier = 7;

    this.maxValue = 10;
    this.updateScale(args);
    //set instantiation args
    _.extend(this, args);

};

HistogramRenderer.prototype._checkFeatureValue = function (feature) {
    if (feature.features_count == null) {
        //            var height = Math.log(features[i].absolute);
        if (feature.absolute != 0 && feature.absolute > 0) {
            // take care of feature.absolute==1 counts and set scaled value to 0.2 as log(2) ~= 0.3
            feature.features_count = Math.max(0.2, Math.log(feature.absolute));
        } else {
            feature.features_count = 0;
        }
    }

    //        var height = features[i].features_count;
    //        if (height == null) {
    //            height = features[i].value;
    //            height = this.histogramHeight * height;
    //        } else {
    //        }
}

/**
 * updates "this.multiplier" using "histogramMaxFreqValue" and "height"
 * @param args
 */
HistogramRenderer.prototype.updateScale = function (args) {
    if (args != null) {
        if (args.height != null) {
            this.histogramHeight = args.height * 0.95;
        }
        if (args.histogramMaxFreqValue != null) {
            this.maxValue = args.histogramMaxFreqValue;
        }
    }
    //this.multiplier = 7;
    this.multiplier = this.histogramHeight / this.maxValue;
};

HistogramRenderer.prototype.render = function (features, args) {
    features.sort(function (a, b) {
        return a.value.start - b.value.start;
    });

    var middle = args.width / 2;
    //console.log(middle);
    var points = '';

    this.updateScale(args);

    if (features.length > 0) {
        var firstFeature = features[0].value;
        var width = (firstFeature.end - firstFeature.start + 1) * args.pixelBase;
        var x = args.pixelPosition + middle - ((args.position - parseInt(firstFeature.start)) * args.pixelBase);

        this._checkFeatureValue(firstFeature);
        var height = firstFeature.features_count * this.multiplier;

        points = (x - (width / 2)).toFixed(1) + ',' + this.histogramHeight.toFixed(1) + ' ';
        points += (x - (width / 2)).toFixed(1) + ',' + (this.histogramHeight - height).toFixed(1) + ' ';
    }
    for (var i = 0, len = features.length; i < len; i++) {
        var feature = features[i].value;
        feature.start = parseInt(feature.start);
        feature.end = parseInt(feature.end);
        var width = (feature.end - feature.start + 1) * args.pixelBase;
        var x = args.pixelPosition + middle - ((args.position - feature.start) * args.pixelBase);

        this._checkFeatureValue(feature);
        var height = feature.features_count * this.multiplier;

        points += (x + (width / 2)).toFixed(1) + "," + (this.histogramHeight - height).toFixed(1) + " ";
    }
    if (features.length > 0) {
        var lastFeature = features[features.length - 1].value;
        var width = (lastFeature.end - lastFeature.start + 1) * args.pixelBase;
        var x = args.pixelPosition + middle - ((args.position - parseInt(lastFeature.start)) * args.pixelBase);

        this._checkFeatureValue(lastFeature);
        var height = lastFeature.features_count * this.multiplier;

        points += (x + (width)).toFixed(1) + ',' + (this.histogramHeight - height).toFixed(1) + ' ';
        points += (x + (width)).toFixed(1) + ',' + this.histogramHeight.toFixed(1) + ' ';
    }

    if (points !== '') {
        SVG.addChild(args.svgCanvasFeatures, "polyline", {
            "points": points,
            //        "stroke": "#000000",
            //        "stroke-width": 0.2,
            "fill": this.histogramColor,
            "cursor": "pointer"
        });

    }
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

SequenceRenderer.prototype = new Renderer({});

function SequenceRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.fontClass = 'ocb-font-ubuntumono ocb-font-size-16';
    this.toolTipfontClass = 'ocb-tooltip-font';

    _.extend(this, args);

};


SequenceRenderer.prototype.render = function (chunks, args) {
    for (var i = 0; i < chunks.length; i++) {
        this._paintSequenceChunk(chunks[i], args);
    }
};


SequenceRenderer.prototype._paintSequenceChunk = function (chunk, args) {
    /* Time */
    var timeId = new Region(chunk).toString();
    console.time("Sequence render " + timeId);
    /**/

    var middle = args.width / 2;

    var start = chunk.start;
    var seqStart = chunk.start;
    var seqString = chunk.sequence;

    for (var i = 0; i < seqString.length; i++) {
        var x = args.pixelPosition + middle - ((args.position - start) * args.pixelBase);
        var text = SVG.addChild(args.svgCanvasFeatures, "text", {
            'x': x + 1,
            'y': 12,
            'fill': SEQUENCE_COLORS[seqString.charAt(i)],
            'data-pos': start,
            'class': this.fontClass
        });
        start++;
        text.textContent = seqString.charAt(i);
        $(text).qtip({
            content: seqString.charAt(i) + " " + (seqStart + i).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,")/*+'<br>'+phastCons[i]+'<br>'+phylop[i]*/,
            position: {target: "mouse", adjust: {x: 25, y: 15}},
            style: {width: true, classes: this.toolTipfontClass + ' qtip-light qtip-shadow'},
            show: {delay: 300},
            hide: {delay: 300}
        });
    }

//    this.trackSvgLayout.setNucleotidPosition(this.position);

    /* Time */
    console.timeEnd("Sequence render " + timeId);
    /**/

};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

/**
 * Stateless (or almost) object to render variants.
 *
 * If you have a svg element where you want to draw, pass it to VariantRenderer.init()
 * and later, in each VariantRenderer.render() as args.svgCanvasFeatures.
 *
 * @type {Renderer}
 */
VariantRenderer.prototype = new Renderer({});

function VariantRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.fontClass = 'ocb-font-roboto ocb-font-size-11';
    this.toolTipfontClass = 'ocb-tooltip-font';

    if (_.isObject(args)) {
        _.extend(this, args);
    }

    this.on(this.handlers);
};


VariantRenderer.prototype.init = function (svgGroup, sample) {
    //Prevent browser context menu
    $(svgGroup).contextmenu(function (e) {
        console.log("right click");
        e.preventDefault();
    });
};

VariantRenderer.prototype.render = function (features, args) {

    for (var i = 0, leni = features.length; i < leni; i++) {
        for (var j = 0; j < features[i].length; j++) {
            var feature = features[i][j];
            this.draw(feature, args);
        }
    }
};

VariantRenderer.prototype.draw = function (feature, args) {
    var _this = this;
    //get feature render configuration
    var color = _.isFunction(_this.color) ? _this.color(feature) : _this.color;
    var label = _.isFunction(_this.label) ? _this.label(feature) : _this.label;
    var height = _.isFunction(_this.height) ? _this.height(feature) : _this.height;
    var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(feature) : _this.tooltipTitle;
    var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(feature) : _this.tooltipText;
    var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(feature) : _this.infoWidgetId;

    //get feature genomic information
    var start = feature.start;
    var end = feature.end;
    var length = (end - start) + 1;

    //check genomic length
    length = (length < 0) ? Math.abs(length) : length;
    length = (length == 0) ? 1 : length;

    //transform to pixel position
    var width = length * args.pixelBase;

    var svgLabelWidth = _this.getLabelWidth(label, args);

    //calculate x to draw svg rect
    var x = _this.getFeatureX(start, args);

    var maxWidth = Math.max(width, 2);
    var textHeight = 0;
    if (args.regionSize < args.maxLabelRegionSize) {
        textHeight = 9;
        maxWidth = Math.max(width, svgLabelWidth);
    }


    var rowY = 0;
    var textY = textHeight + height;
    var rowHeight = textHeight + height + 2;


//        azul osucuro: 0/0
//        negro: ./.
//        rojo: 1/1
//        naranja 0/1

    var d00 = '';
    var dDD = '';
    var d11 = '';
    var d01 = '';
    var xs = x; // x start
    var xe = x + width; // x end
    var ys = 1; // y
    var yi = 6; //y increment
    var yi2 = 10; //y increment

//    debugger
//    for (var i = 0, leni = feature.samples.length; i < leni; i++) {
    var samplesCount = 0;
//    var indices = [];
    for (var i in feature.files) {
        for (var j in feature.files[i].samplesData) {
//            indices.push(j);
            args.renderedArea[ys] = new FeatureBinarySearchTree();
            args.renderedArea[ys].add({start: xs, end: xe});
//            var genotype = Math.round(Math.random()) + "/" + Math.round(Math.random()); // FIXME put in real values

            var genotype = feature.files[i].samplesData[j].GT;
            switch (genotype) {
                case '0|0':
                case '0/0':
                    d00 += 'M' + xs + ',' + ys + ' L' + xe + ',' + ys + ' ';
                    d00 += 'L' + xe + ',' + (ys + yi) + ' L' + xs + ',' + (ys + yi) + ' z ';
                    break;
                case '.|.':
                case './.':
                    dDD += 'M' + xs + ',' + ys + ' L' + xe + ',' + ys + ' ';
                    dDD += 'L' + xe + ',' + (ys + yi) + ' L' + xs + ',' + (ys + yi) + ' z ';
                    break;
                case '1|1':
                case '1/1':
                    d11 += 'M' + xs + ',' + ys + ' L' + xe + ',' + ys + ' ';
                    d11 += 'L' + xe + ',' + (ys + yi) + ' L' + xs + ',' + (ys + yi) + ' z ';
                    break;
                case '0|1':
                case '0/1':
                case '1|0':
                case '1/0':
                    d01 += 'M' + xs + ',' + ys + ' L' + xe + ',' + ys + ' ';
                    d01 += 'L' + xe + ',' + (ys + yi) + ' L' + xs + ',' + (ys + yi) + ' z ';
                    break;
            }
            samplesCount++;
            ys += yi2;
        }
    }
    var featureGroup = SVG.addChild(args.svgCanvasFeatures, "g", {'feature_id': feature.id});
    var dummyRect = SVG.addChild(featureGroup, "rect", {
        'x': xs,
        'y': 1,
        'width': width,
        'height': ys,
        'fill': 'transparent',
        'cursor': 'pointer'
    });
    if (d00 != '') {
        var path = SVG.addChild(featureGroup, "path", {
            'd': d00,
            'fill': 'blue',
            'cursor': 'pointer'
        });
    }
    if (dDD != '') {
        var path = SVG.addChild(featureGroup, "path", {
            'd': dDD,
            'fill': 'black',
            'cursor': 'pointer'
        });
    }
    if (d11 != '') {
        var path = SVG.addChild(featureGroup, "path", {
            'd': d11,
            'fill': 'red',
            'cursor': 'pointer'
        });
    }
    if (d01 != '') {
        var path = SVG.addChild(featureGroup, "path", {
            'd': d01,
            'fill': 'orange',
            'cursor': 'pointer'
        });
    }

//debugger
    var lastSampleIndex = 0;
    $(featureGroup).qtip({
//        content: {text: tooltipText + '<br>' + feature.files[lastSampleIndex], title: tooltipTitle},
        content: {text: tooltipText + '<br>' + samplesCount + " samples", title: tooltipTitle},
//                        position: {target: "mouse", adjust: {x: 15, y: 0}, effect: false},
        position: {target: "mouse", adjust: {x: 25, y: 15}},
        style: { width: true, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
        show: {delay: 300},
        hide: {delay: 300}
    });
    $(featureGroup).mousemove(function (event) {
        var sampleIndex = parseInt(event.offsetY / yi2);
        if (sampleIndex != lastSampleIndex) {
            console.log(sampleIndex);
            samplesCount = 0;
            var sampleName = "";
            var found = false;
            for (var i in feature.files) {
                for (var j in feature.files[i].samplesData) {   // better search it up than storing it? memory could be an issue.
                    if (sampleIndex == samplesCount) {
                        found = true;
                        sampleName = j;
                    }
                    samplesCount++;
                }
            }
            $(featureGroup).qtip('option', 'content.text', tooltipText + '<br>' + sampleName);
        }
        lastSampleIndex = sampleIndex;
    });
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

//any item with chromosome start end
VcfMultisampleRenderer.prototype = new Renderer({});

function VcfMultisampleRenderer(args) {
    Renderer.call(this, args);
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    this.fontClass = 'ocb-font-roboto ocb-font-size-11';
    this.toolTipfontClass = 'ocb-tooltip-font';

    _.extend(this, FEATURE_TYPES.variant);

    this.on(this.handlers);
};


VcfMultisampleRenderer.prototype.render = function (features, args) {
    for (var i = 0, leni = features.length; i < leni; i++) {
        this._drawFeature(features[i], args);
    }
};

VcfMultisampleRenderer.prototype._drawFeature = function (feature, args) {
    var _this = this;

    var color = _.isFunction(_this.color) ? _this.color(feature) : _this.color;
    var label = _.isFunction(_this.label) ? _this.label(feature) : _this.label;
    var height = _.isFunction(_this.height) ? _this.height(feature) : _this.height;
    var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(feature) : _this.tooltipTitle;
    var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(feature) : _this.tooltipText;
    var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(feature) : _this.infoWidgetId;

    //get feature genomic information
    var start = feature.start;
    var end = feature.end;
    var length = (end - start) + 1;

    //check genomic length
    length = (length < 0) ? Math.abs(length) : length;
    length = (length == 0) ? 1 : length;

    //transform to pixel position
    var width = length * args.pixelBase;

    var svgLabelWidth = label.length * 6.4;

    //calculate x to draw svg rect
    var x = _this.getFeatureX(start, args);

    var maxWidth = Math.max(width, 2);
    var textHeight = 0;
    if (args.maxLabelRegionSize > args.regionSize) {
        textHeight = 9;
        maxWidth = Math.max(width, svgLabelWidth);
    }

    var rowY = 0;
    var textY = textHeight + height;
    var rowHeight = textHeight + height + 2;

    while (true) {
        if (!(rowY in args.renderedArea)) {
            args.renderedArea[rowY] = new FeatureBinarySearchTree();
        }
        var foundArea = args.renderedArea[rowY].add({start: x, end: x + maxWidth - 1});

        if (foundArea) {
            var featureGroup = SVG.addChild(args.svgCanvasFeatures, "g", {'feature_id': feature.id});
            var rect = SVG.addChild(featureGroup, "rect", {
                'x': x,
                'y': rowY,
                'width': width,
                'height': height,
                'stroke': '#3B0B0B',
                'stroke-width': 1,
                'stroke-opacity': 0.7,
                'fill': color,
                'cursor': 'pointer'
            });
            if (args.maxLabelRegionSize > args.regionSize) {
                var text = SVG.addChild(featureGroup, "text", {
                    'x': x,
                    'y': textY,
                    'font-weight': 400,
                    'opacity': null,
                    'fill': 'black',
                    'cursor': 'pointer',
                    'class': _this.fontClass
                });
                text.textContent = label;
            }

            if ('tooltipText' in _this) {
                $(featureGroup).qtip({
                    content: {text: tooltipText, title: tooltipTitle},
//                        position: {target: "mouse", adjust: {x: 15, y: 0}, effect: false},
                    position: {target: "mouse", adjust: {x: 25, y: 15}},
                    style: {width: true, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
                    show: {delay: 300},
                    hide: {delay: 300}
                });
            }

            $(featureGroup).mouseover(function (event) {
                _this.trigger('feature:mouseover', {
                    query: feature[infoWidgetId],
                    feature: feature,
                    featureType: feature.featureType,
                    mouseoverEvent: event
                })
            });

            $(featureGroup).click(function (event) {
                _this.trigger('feature:click', {
                    query: feature[infoWidgetId],
                    feature: feature,
                    featureType: feature.featureType,
                    clickEvent: event
                })
            });
            break;
        }
        rowY += rowHeight;
        textY += rowHeight;
    }
};

VcfMultisampleRenderer.prototype._drawFeatureMultiSample = function (feature, args) {
    //TODO fix with new data structure
    var _this = this;
    //get feature render configuration
    var color = _.isFunction(_this.color) ? _this.color(feature) : _this.color;
    var label = _.isFunction(_this.label) ? _this.label(feature) : _this.label;
    var height = _.isFunction(_this.height) ? _this.height(feature) : _this.height;
    var tooltipTitle = _.isFunction(_this.tooltipTitle) ? _this.tooltipTitle(feature) : _this.tooltipTitle;
    var tooltipText = _.isFunction(_this.tooltipText) ? _this.tooltipText(feature) : _this.tooltipText;
    var infoWidgetId = _.isFunction(_this.infoWidgetId) ? _this.infoWidgetId(feature) : _this.infoWidgetId;

    //get feature genomic information
    var start = feature.start;
    var end = feature.end;
    var length = (end - start) + 1;

    //check genomic length
    length = (length < 0) ? Math.abs(length) : length;
    length = (length == 0) ? 1 : length;

    //transform to pixel position
    var width = length * args.pixelBase;

    var svgLabelWidth = _this.getLabelWidth(label, args);

    //calculate x to draw svg rect
    var x = _this.getFeatureX(start, args);

    var maxWidth = Math.max(width, 2);
    var textHeight = 0;
    if (args.regionSize < args.maxLabelRegionSize) {
        textHeight = 9;
        maxWidth = Math.max(width, svgLabelWidth);
    }


    var rowY = 0;
    var textY = textHeight + height;
    var rowHeight = textHeight + height + 2;


//        azul osucuro: 0/0
//        negro: ./.
//        rojo: 1/1
//        naranja 0/1

    var d00 = '';
    var dDD = '';
    var d11 = '';
    var d01 = '';
    var xs = x; // x start
    var xe = x + width; // x end
    var ys = 1; // y
    var yi = 6; //y increment
    var yi2 = 10; //y increment
    for (var i = 0, leni = feature.samples.length; i < leni; i++) {
        args.renderedArea[ys] = new FeatureBinarySearchTree();
        args.renderedArea[ys].add({start: xs, end: xe});
        var genotype = feature.samples[i].split(':')[0];
        switch (genotype) {
            case '0|0':
            case '0/0':
                d00 += 'M' + xs + ',' + ys + ' L' + xe + ',' + ys + ' ';
                d00 += 'L' + xe + ',' + (ys + yi) + ' L' + xs + ',' + (ys + yi) + ' z ';
                break;
            case '.|.':
            case './.':
                dDD += 'M' + xs + ',' + ys + ' L' + xe + ',' + ys + ' ';
                dDD += 'L' + xe + ',' + (ys + yi) + ' L' + xs + ',' + (ys + yi) + ' z ';
                break;
            case '1|1':
            case '1/1':
                d11 += 'M' + xs + ',' + ys + ' L' + xe + ',' + ys + ' ';
                d11 += 'L' + xe + ',' + (ys + yi) + ' L' + xs + ',' + (ys + yi) + ' z ';
                break;
            case '0|1':
            case '0/1':
            case '1|0':
            case '1/0':
                d01 += 'M' + xs + ',' + ys + ' L' + xe + ',' + ys + ' ';
                d01 += 'L' + xe + ',' + (ys + yi) + ' L' + xs + ',' + (ys + yi) + ' z ';
                break;
        }
        ys += yi2;
    }
    var featureGroup = SVG.addChild(args.svgCanvasFeatures, "g", {'feature_id': feature.id});
    var dummyRect = SVG.addChild(featureGroup, "rect", {
        'x': xs,
        'y': 1,
        'width': width,
        'height': ys,
        'fill': 'transparent',
        'cursor': 'pointer'
    });
    if (d00 != '') {
        var path = SVG.addChild(featureGroup, "path", {
            'd': d00,
            'fill': 'blue',
            'cursor': 'pointer'
        });
    }
    if (dDD != '') {
        var path = SVG.addChild(featureGroup, "path", {
            'd': dDD,
            'fill': 'black',
            'cursor': 'pointer'
        });
    }
    if (d11 != '') {
        var path = SVG.addChild(featureGroup, "path", {
            'd': d11,
            'fill': 'red',
            'cursor': 'pointer'
        });
    }
    if (d01 != '') {
        var path = SVG.addChild(featureGroup, "path", {
            'd': d01,
            'fill': 'orange',
            'cursor': 'pointer'
        });
    }


    var lastSampleIndex = 0;
    $(featureGroup).qtip({
        content: {text: tooltipText + '<br>' + feature.samples[lastSampleIndex], title: tooltipTitle},
//                        position: {target: "mouse", adjust: {x: 15, y: 0}, effect: false},
        position: {target: "mouse", adjust: {x: 25, y: 15}},
        style: {width: true, classes: _this.toolTipfontClass + ' ui-tooltip ui-tooltip-shadow'},
        show: {delay: 300},
        hide: {delay: 300}
    });
    $(featureGroup).mousemove(function (event) {
        var sampleIndex = parseInt(event.offsetY / yi2);
        if (sampleIndex != lastSampleIndex) {
            console.log(sampleIndex);
            $(featureGroup).qtip('option', 'content.text', tooltipText + '<br>' + feature.samples[sampleIndex]);
        }
        lastSampleIndex = sampleIndex;
    });
};

/*
 * Copyright (c) 2012 Francisco Salavert (ICM-CIPF)
 * Copyright (c) 2012 Ruben Sanchez (ICM-CIPF)
 * Copyright (c) 2012 Ignacio Medina (ICM-CIPF)
 *
 * This file is part of JS Common Libs.
 *
 * JS Common Libs is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * JS Common Libs is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with JS Common Libs. If not, see <http://www.gnu.org/licenses/>.
 */

function GenomeViewer(args) {
    // Using Underscore 'extend' function to extend and add Backbone Events
    _.extend(this, Backbone.Events);

    var _this = this;
    this.id = Utils.genId("GenomeViewer");

    //set default args
    this.autoRender = true;
    this.version = 'Powered by <a target="_blank" href="http://www.genomemaps.org/">Genome Maps</a>';
    this.target;

    this.width;
    this.height;

    this.cellBaseHost = 'http://bioinfo.hpc.cam.ac.uk/cellbase';
    this.cellBaseVersion = 'v3';

    this.quickSearchResultFn;
    this.quickSearchDisplayKey = 'name';

    this.drawNavigationBar = true;
    this.drawKaryotypePanel = true;
    this.drawChromosomePanel = true;
    this.drawOverviewTrackListPanel = true;
    this.overviewZoomMultiplier = 8;
    this.karyotypePanelConfig = {
        hidden: false,
        collapsed: false,
        collapsible: true
    };
    this.chromosomePanelConfig = {
        hidden: false,
        collapsed: false,
        collapsible: true
    };
    this.regionPanelConfig = {
        hidden: false,
        collapsed: false,
        collapsible: true
    };
    this.navigationBarConfig = {};
    this.drawStatusBar = true;
    this.resizable = true;
    this.sidePanel = true;//enable or disable sidePanel at construction
    this.trackListTitle = 'Detailed information';//enable or disable sidePanel at construction
    this.trackPanelScrollWidth = 18;

    this.zoom;

    this.chromosomes;
    this.chromosomeList;

    //set instantiation args, must be last
    _.extend(this, args);

    this.chromosomes = this.getChromosomes();
    this.species.chromosomes = this.chromosomes;

    this.defaultRegion = new Region(this.region);

    this.sidePanelWidth = (this.sidePanel) ? 25 : 0;


    //events attachments
    this.on(this.handlers);

    this.fullscreen = false;
    this.resizing = false;

    this.changingRegion = false;

    this.rendered = false;
    if (this.autoRender) {
        this.render();
    }
}

GenomeViewer.prototype = {
    render: function () {
        console.log("Initializing Genome Viewer");

        //HTML skel
        this.div = document.createElement('div');
        this.div.setAttribute('id', this.id);
        this.div.setAttribute('class', 'ocb-gv ocb-box-vertical');

        this.navigationbarDiv = document.createElement('div');
        this.navigationbarDiv.setAttribute('class', 'ocb-gv-navigation');
        this.div.appendChild(this.navigationbarDiv);

        this.centerPanelDiv = document.createElement('div');
        this.centerPanelDiv.setAttribute('class', 'ocb-gv-center');
        this.div.appendChild(this.centerPanelDiv);

        this.statusbarDiv = document.createElement('div');
        this.statusbarDiv.setAttribute('class', 'ocb-gv-status');
        this.div.appendChild(this.statusbarDiv);


        this.rightSidebarDiv = document.createElement('div');
        this.rightSidebarDiv.setAttribute('class', 'ocb-gv-right-side');
        this.centerPanelDiv.appendChild(this.rightSidebarDiv);

        this.leftSidebarDiv = document.createElement('div');
        this.leftSidebarDiv.setAttribute('class', 'ocb-gv-left-side');
        this.centerPanelDiv.appendChild(this.leftSidebarDiv);


        this.karyotypeDiv = document.createElement('div');
        this.karyotypeDiv.setAttribute('class', 'ocb-gv-karyotype');
        this.centerPanelDiv.appendChild(this.karyotypeDiv);

        this.chromosomeDiv = document.createElement('div');
        this.chromosomeDiv.setAttribute('class', 'ocb-gv-chromosome');
        this.centerPanelDiv.appendChild(this.chromosomeDiv);


        this.trackListPanelsDiv = document.createElement('div');
        this.trackListPanelsDiv.setAttribute('class', 'ocb-gv-tracklist-target');
        this.centerPanelDiv.appendChild(this.trackListPanelsDiv);

        this.regionDiv = document.createElement('div');
        this.regionDiv.setAttribute('class', 'ocb-gv-overview');
        this.trackListPanelsDiv.appendChild(this.regionDiv);

        this.tracksDiv = document.createElement('div');
        this.tracksDiv.setAttribute('class', 'ocb-gv-detailed');
        this.trackListPanelsDiv.appendChild(this.tracksDiv);


        this._init();

        this.rendered = true;
    },

    _init: function () {
        var _this = this;
        this._checkAndSetMinimumRegion(this.region, this.getSVGCanvasWidth());
        this.zoom = this._calculateZoomByRegion(this.region);

//        // Resize
//        if (this.resizable) {
//            $(window).resize(function (event) {
//                if (event.target == window) {
//                    if (!_this.resizing) {//avoid multiple resize events
//                        _this.resizing = true;
//                        _this.setWidth($(_this.targetDiv).width());
//                        setTimeout(function () {
//                            _this.resizing = false;
//                        }, 400);
//                    }
//                }
//            });
////            $(this.targetDiv).resizable({
////                handles: 'e',
////                ghost: true,
////                stop: function (event, ui) {
////                    _this._setWidth($(_this.targetDiv).width());
////                }
////            });
//        }

        /* Navigation Bar */
        if (this.drawNavigationBar) {
            this.navigationBar = this._createNavigationBar(this.navigationbarDiv);
        }


        /*karyotype Panel*/
        if (this.drawKaryotypePanel) {
            this.karyotypePanel = this._drawKaryotypePanel(this.karyotypeDiv);
        }

        /* Chromosome Panel */
        if (this.drawChromosomePanel) {
            this.chromosomePanel = this._drawChromosomePanel(this.chromosomeDiv);
        }

        /* Region Panel, is a TrackListPanel Class */
        if (this.drawOverviewTrackListPanel) {
            this.overviewTrackListPanel = this._createOverviewTrackListPanel(this.regionDiv);
        }
        /*TrackList Panel*/
        this.trackListPanel = this._createTrackListPanel(this.tracksDiv);

        /*Status Bar*/
        if (this.drawStatusBar) {
            this.statusBar = this._createStatusBar(this.statusbarDiv);
        }


        this.on('region:change region:move', function (event) {
            if (event.sender != _this) {
                _this.region.load(event.region);
            }
        });
        this.on('width:change', function (event) {
            if (event.sender != _this) {
                _this.width = event.width;
                $(_this.div).width(event.width);
                $(_this.targetDiv).width(event.width);
            }
        });
        //this.on('species:change', function (event) {
        //    _this.species = event.species;
        //    _this.chromosomes = _this.getChromosomes();
        //});

        $("html").bind('keydown.genomeViewer', function (e) {
            switch (e.keyCode) {
                case 40://down arrow
                case 109://minus key
                    if (e.shiftKey) {
                        _this.increaseZoom(-10);
                    }
                    break;
                case 38://up arrow
                case 107://plus key
                    if (e.shiftKey) {
                        _this.increaseZoom(10);
                    }
                    break;
            }
        });
    },

    draw: function () {
        this.targetDiv = ( this.target instanceof HTMLElement ) ? this.target : document.querySelector('#' + this.target);
        if (!this.targetDiv) {
            console.log('target not found');
            return;
        }
        this.targetDiv.appendChild(this.div);
    },
    destroy: function () {
        $(this.div).remove();
        this.off();
        this.rendered = false;
        $("html").unbind(".genomeViewer");
        $("body").unbind(".genomeViewer");
        delete this;
    },
    getChromosomes: function () {
        var saveChromosomes = function (chromsomeList) {
            var chromosomes = {};
            for (var i = 0; i < chromsomeList.length; i++) {
                var chromosome = chromsomeList[i];
                chromosomes[chromosome.name] = chromosome;
            }
            return chromosomes;
        }

        var chromosomes;
        if (typeof this.chromosomeList !== 'undefined') {
            chromosomes = saveChromosomes(this.chromosomeList);
        } else {
            CellBaseManager.get({
                host: this.cellBaseHost,
                version: this.cellBaseVersion,
                species: this.species,
                category: 'genomic',
                subCategory: 'chromosome',
                resource: 'all',
                async: false,
                success: function (data) {
                    chromosomes = saveChromosomes(data.response[0].result[0].chromosomes);
                    for (var i = 0; i < chromosomes.length; i++) {
                        var chr = chromosomes[i];
                        debugger
                    }
                },
                error: function (data) {
                    console.log('Could not get chromosome list');
                }
            });
        }
        return chromosomes;
    },
    /**/
    /*Components*/
    /**/

    _createNavigationBar: function (target) {
        var _this = this;

        if (!$.isFunction(this.quickSearchResultFn)) {
            this.quickSearchResultFn = function (query) {
                var results = [];
                var speciesCode = Utils.getSpeciesCode(this.species.scientificName);

                CellBaseManager.get({
                    host: _this.cellBaseHost,
                    version: _this.cellBaseVersion,
//                    host: 'http://ws.bioinfo.cipf.es/cellbase/rest',
                    species: speciesCode,
                    category: 'feature',
                    subCategory: 'id',
                    query: query,
                    resource: 'starts_with',
                    params: {
                        limit: 10
                    },
                    async: false,
                    success: function (data, textStatus, jqXHR) {
                        results = data.response[0].result;
//                        var features = data.response[0].result;
//                        for (var i = 0; i < features.length; i++) {
//                            results.push(features[i].name)
//                        }
                    }
                });
                return results;
            };
        }

        var goFeature = function (feature) {
            _this._regionChangeHandler({region: new Region(feature)});
//            if (featureName != null) {
//                if (featureName.slice(0, "rs".length) == "rs" || featureName.slice(0, "AFFY_".length) == "AFFY_" || featureName.slice(0, "SNP_".length) == "SNP_" || featureName.slice(0, "VAR_".length) == "VAR_" || featureName.slice(0, "CRTAP_".length) == "CRTAP_" || featureName.slice(0, "FKBP10_".length) == "FKBP10_" || featureName.slice(0, "LEPRE1_".length) == "LEPRE1_" || featureName.slice(0, "PPIB_".length) == "PPIB_") {
//                    this.openSNPListWidget(featureName);
//                } else {
//                    console.log(featureName);
//                    CellBaseManager.get({
//                        host: _this.cellBaseHost,
//                        version: _this.cellBaseVersion,
//                        species: _this.species,
//                        category: 'feature',
//                        subCategory: 'id',
//                        query: featureName,
//                        resource: 'info',
//                        params: {
//                            include: 'chromosome,start,end'
//                        },
//                        success: function (data) {
//                            debugger
//                            var feat = data.response[0].result[0];
//                            var region = new Region(feat);
//                            _this._regionChangeHandler({region: region});
//                        }
//                    });
//                }
//            }
        };

        var navigationBar = new NavigationBar({
            target: target,
            cellBaseHost: this.cellBaseHost,
            cellBaseVersion: this.cellBaseVersion,
            availableSpecies: this.availableSpecies,
            species: this.species,
            region: this.region,
            width: this.width,
            svgCanvasWidthOffset: this.trackPanelScrollWidth + this.sidePanelWidth,
            zoom: this.zoom,
            quickSearchResultFn: this.quickSearchResultFn,
            quickSearchDisplayKey: this.quickSearchDisplayKey,
            componentsConfig: this.navigationBarConfig.componentsConfig,
            karyotypePanelConfig: this.karyotypePanelConfig,
            chromosomePanelConfig: this.chromosomePanelConfig,
            regionPanelConfig: this.regionPanelConfig,
            handlers: {
                'region:change': function (event) {
                    _this._regionChangeHandler(event);
                },
                'region:move': function (event) {
                    _this._regionMoveHandler(event);
                },
                'zoom:change': function (event) {
                    _this._zoomChangeHandler(event);
                },
                'species:change': function (event) {
                    _this._speciesChangeHandler(event);
                },

                'karyotype-button:change': function (event) {
                    if (event.selected) {
                        _this.karyotypePanel.show();
                    } else {
                        _this.karyotypePanel.hide();
                    }
                },
                'chromosome-button:change': function (event) {
                    if (event.selected) {
                        _this.chromosomePanel.show();
                    } else {
                        _this.chromosomePanel.hide();
                    }
                },
                'region-button:change': function (event) {
                    if (event.selected) {
                        _this.overviewTrackListPanel.show();
                    } else {
                        _this.overviewTrackListPanel.hide();
                    }
                },
                'fullscreen:click': function (event) {
                    if (_this.fullscreen) {
                        $(_this.div).css({width: 'auto'});
                        Utils.cancelFullscreen();//no need to pass the dom object;
                        _this.fullscreen = false;
                    } else {
                        $(_this.div).css({width: screen.width});
                        Utils.launchFullScreen(_this.div);
                        _this.fullscreen = true;
                    }
                },
                'restoreDefaultRegion:click': function (event) {
                    event.region = _this.defaultRegion;
                    _this._regionChangeHandler(event);
                },
                'autoHeight-button:change': function (event) {
                    _this.toggleAutoHeight(event.selected);
                },
                'quickSearch:select': function (event) {
                    goFeature(event.item);
                    _this.trigger('quickSearch:select', event);
                },
                'quickSearch:go': function (event) {
                    goFeature(event.item);
                }
            }
        });

        this.on('region:change', function (event) {
//            if (event.sender != navigationBar) {
            _this.navigationBar.setRegion(event.region, _this.zoom);
//            }
        });
        this.on('region:move', function (event) {
            if (event.sender != navigationBar) {
                _this.navigationBar.moveRegion(event.region);
            }
        });
        this.on('width:change', function (event) {
            _this.navigationBar.setWidth(event.width);
        });

        navigationBar.draw();

        return navigationBar;
    },

    _drawKaryotypePanel: function (target) {
        var _this = this;
        var karyotypePanel = new KaryotypePanel({
            target: target,
            cellBaseHost: this.cellBaseHost,
            cellBaseVersion: this.cellBaseVersion,
            width: this.width - this.sidePanelWidth,
            height: 125,
            species: this.species,
            title: 'Karyotype',
            collapsed: this.karyotypePanelConfig.collapsed,
            collapsible: this.karyotypePanelConfig.collapsible,
            hidden: this.karyotypePanelConfig.hidden,
            region: this.region,
            autoRender: true,
            handlers: {
                'region:change': function (event) {
                    _this._regionChangeHandler(event);
                }
            }
        });

        this.on('region:change region:move', function (event) {
//            if (event.sender != karyotypePanel) {
            karyotypePanel.setRegion(event.region);
//            }
        });
        this.on('width:change', function (event) {
            karyotypePanel.setWidth(event.width - _this.sidePanelWidth);
        });
//        this.on('species:change', function (event) {
//            karyotypePanel.setSpecies(event.species);
//        });

        karyotypePanel.draw();

        return karyotypePanel;
    },

    _drawChromosomePanel: function (target) {
        var _this = this;

        var chromosomePanel = new ChromosomePanel({
            target: target,
            cellBaseHost: this.cellBaseHost,
            cellBaseVersion: this.cellBaseVersion,
            autoRender: true,
            width: this.width - this.sidePanelWidth,
            height: 65,
            species: this.species,
            title: 'Chromosome',
            collapsed: this.chromosomePanelConfig.collapsed,
            collapsible: this.chromosomePanelConfig.collapsible,
            hidden: this.chromosomePanelConfig.hidden,
            region: this.region,
            handlers: {
                'region:change': function (event) {
                    _this._regionChangeHandler(event);
                }
            }
        });

        this.on('region:change region:move', function (event) {
//            if (event.sender != chromosomePanel) {
            chromosomePanel.setRegion(event.region);
//            }
        });
        this.on('width:change', function (event) {
            chromosomePanel.setWidth(event.width - _this.sidePanelWidth);
        });
//        this.on('species:change', function (event) {
//            chromosomePanel.setSpecies(event.species);
//        });

        chromosomePanel.draw();

        return chromosomePanel;
    },

    _createOverviewTrackListPanel: function (target) {
        var _this = this;
        var trackListPanel = new TrackListPanel({
            cellBaseHost: this.cellBaseHost,
            cellBaseVersion: this.cellBaseVersion,
            target: target,
            autoRender: true,
            width: this.width - this.sidePanelWidth,
            zoomMultiplier: this.overviewZoomMultiplier,
            title: 'Region overview',
            showRegionOverviewBox: true,
            collapsible: this.regionPanelConfig.collapsible,
            region: this.region,
            species: this.species,
            handlers: {
                'region:change': function (event) {
                    event.sender = undefined;
                    _this._regionChangeHandler(event);
                },
                'region:move': function (event) {
                    _this._regionMoveHandler(event);
                }
            }
        });

        this.on('region:change', function (event) {
            if (event.sender != trackListPanel) {
                trackListPanel.setRegion(event.region);
            }
        });
        this.on('region:move', function (event) {
            if (event.sender != trackListPanel) {
                trackListPanel.moveRegion(event);
            }
        });
        this.on('width:change', function (event) {
            trackListPanel.setWidth(event.width - _this.sidePanelWidth);
        });
//        this.on('species:change', function (event) {
//            trackListPanel.setSpecies(event.species);
//        });

        trackListPanel.draw();

        return trackListPanel;
    },

    _createTrackListPanel: function (target) {
        var _this = this;
        var trackListPanel = new TrackListPanel({
            target: target,
            cellBaseHost: this.cellBaseHost,
            cellBaseVersion: this.cellBaseVersion,
            autoRender: true,
            width: this.width - this.sidePanelWidth,
            title: this.trackListTitle,
            region: this.region,
            species: this.species,
            hidden: this.regionPanelConfig.hidden,
            handlers: {
                'region:change': function (event) {
                    event.sender = undefined;
                    _this._regionChangeHandler(event);
                },
                'region:move': function (event) {
                    _this._regionMoveHandler(event);
                }
            }
        });

        this.on('region:change', function (event) {
            if (event.sender != trackListPanel) {
                trackListPanel.setRegion(event.region);
            }
        });
        this.on('region:move', function (event) {
            if (event.sender != trackListPanel) {
                trackListPanel.moveRegion(event);
            }
        });
        this.on('width:change', function (event) {
            trackListPanel.setWidth(event.width - _this.sidePanelWidth);
        });
//        this.on('species:change', function (event) {
//            trackListPanel.setSpecies(event.species);
//        });

        this.on('feature:highlight', function (event) {
            trackListPanel.highlight(event);
        });

        trackListPanel.draw();

        return trackListPanel;
    },

    _createStatusBar: function (target) {
        var _this = this;
        var statusBar = new StatusBar({
            target: target,
            autoRender: true,
            region: this.region,
            width: this.width,
            version: this.version
        });

        this.on('region:change', function (event) {
            statusBar.setRegion(event);
        });


        this.trackListPanel.on('mousePosition:change', function (event) {
            statusBar.setMousePosition(event);
        });

        statusBar.draw();
        return statusBar;
    },


    /*****************/
    /** PRIVATE HELPER METHODS **/
    /*****************/
    _checkAndSetNewChromosomeRegion: function (region) {
        var newChr = this.chromosomes[region.chromosome];
        if (region.chromosome !== this.region.chromosome) {
            if (region.start > newChr.size || region.end > newChr.size) {
                region.start = Math.round(newChr.size / 2);
                region.end = Math.round(newChr.size / 2);
            }
        }
    },
    _checkAndSetMinimumRegion: function (region, width) {
        var minLength = Math.floor(width / 10);
        if (region.length() < minLength) {
            var centerPosition = region.center();
            var aux = Math.ceil((minLength / 2) - 1);
            region.start = Math.floor(centerPosition - aux);
            region.end = Math.floor(centerPosition + aux);
        }
    },
    _calculateRegionByZoom: function (zoom) {
        // mrl = minimum region length
        // zlm = zoom level multiplier

        // mrl * zlm ^ 100 = chr.size
        // zlm = (chr.size/mrl)^(1/100)
        // zlm = (chr.size/mrl)^0.01

        var minNtPixels = 10; // 10 is the minimum pixels per nt
        var chr = this.chromosomes[this.region.chromosome];
        var minRegionLength = this.getSVGCanvasWidth() / minNtPixels;
        var zoomLevelMultiplier = Math.pow(chr.size / minRegionLength, 0.01); // 0.01 = 1/100  100 zoom levels

//      regionLength = mrl * (Math.pow(zlm,ZOOM))
        var regionLength = minRegionLength * (Math.pow(zoomLevelMultiplier, 100 - zoom)); // invert   100 - zoom

        var centerPosition = this.region.center();
        var aux = Math.ceil((regionLength / 2) - 1);
        var start = Math.floor(centerPosition - aux);
        var end = Math.floor(centerPosition + aux);

        return {start: start, end: end};
    },
    _calculateZoomByRegion: function (region) {
        var minNtPixels = 10; // 10 is the minimum pixels per nt
        var chr = this.chromosomes[region.chromosome];
        var minRegionLength = this.getSVGCanvasWidth() / minNtPixels;
        var zoomLevelMultiplier = Math.pow(chr.size / minRegionLength, 0.01); // 0.01 = 1/100  100 zoom levels

        var regionLength = region.length();

//      zoom = Math.log(REGIONLENGTH/mrl) / Math.log(zlm);
        var zoom = Math.log(regionLength / minRegionLength) / Math.log(zoomLevelMultiplier);
        return 100 - Math.round(zoom);
    },
    /*****************/
    /*****************/
    /*****************/



    /*****************/
//    _startRegionChange: function () {
//        if (this.changingRegion === true) {
////            return false;
//            return true
//        } else {
//            this.changingRegion = true;
//            return true;
//        }
//    },
//    _endRegionChange: function () {
//        this.changingRegion = false;
//    },

//    _checkStatus: function () {
//        var ok = true;
//        if (typeof this.overviewTrackListPanel !== 'undefined') {
//            if (this.overviewTrackListPanel.status !== 'ready') {
//                ok = false;
//            }
//        }
//        if (typeof this.trackListPanel !== 'undefined') {
//            if (this.trackListPanel.status !== 'ready') {
//                ok = false;
//            }
//        }
//        if (ok) {
//            this._endRegionChange();
//        }
//    },
//    checkTrackListReady: function () {
//        var _this = this;
//        var checkAllTrackListStatus = function (status) {
//            if (_this.overviewTrackListPanel && _this.overviewTrackListPanel.status != status) {
//                return false;
//            }
//            if (_this.trackListPanel.status != status) {
//                return false;
//            }
//            return true;
//        };
//        if (checkAllTrackListStatus('ready')) {
////            console.log('-------------all tracklist ready')
//            _this.trigger('tracks:ready', {sender: _this});
//        }
////        var checkStatus = function () {
////            if (checkAllTrackStatus('ready')) {
////                _this.trigger('tracks:ready', {sender: _this});
////            } else {
////                setTimeout(checkStatus, 100);
////            }
////        };
////        setTimeout(checkStatus, 10);
//    },

    _checkChangingRegion: function () {
        if (typeof this.overviewTrackListPanel !== 'undefined') {
            if (!this.overviewTrackListPanel.checkTracksReady()) {
                return false;
            }
        }
        if (typeof this.trackListPanel !== 'undefined') {
            if (!this.trackListPanel.checkTracksReady()) {
                return false;
            }
        }
        return true;
    },

    /*****************/




    /*****************/
    /** EVENT METHODS **/
    /*****************/
    _regionChangeHandler: function (event) {
        if (this._checkChangingRegion()) {

            /**/
            this._checkAndSetNewChromosomeRegion(event.region);
            this._checkAndSetMinimumRegion(event.region, this.getSVGCanvasWidth());
            this.zoom = this._calculateZoomByRegion(event.region);
            //Relaunch
            this.trigger('region:change', event);
            /**/
            return true;
        } else {
            if (event.sender) {
                if (event.sender.updateRegionControls) {
                    event.sender.updateRegionControls();
                }
            }
            console.log('****************************');
            console.log('**************************** region change already in progress');
            console.log('****************************');
            return false;
        }
    },
    _regionMoveHandler: function (event) {
        //Relaunch
        this.trigger('region:move', event);
    },
    _zoomChangeHandler: function (event) {
        event.zoom = Math.min(100, event.zoom);
        event.zoom = Math.max(0, event.zoom);
        this.zoom = event.zoom;
        this.region.load(this._calculateRegionByZoom(event.zoom));
        this.setRegion(this.region);
    },
    _speciesChangeHandler: function (event) {
        //Relaunch
        this.trigger('species:change', event);
        this._updateSpecies(event.species);


        var firstGeneRegion;
        CellBaseManager.get({
            host: this.cellBaseHost,
            async: false,
            category: 'feature',
            subCategory: 'gene',
            resource: 'first',
            species: event.species,
            params: {
                include: 'chromosome,start,end'
            },
            success: function (r) {
                firstGeneRegion = r.response[0].result[0];
            }
        });


        var region = new Region(firstGeneRegion);
        this.setRegion(region);
    },
    _updateSpecies: function (species) {
        this.species = species;
        this.chromosomes = this.getChromosomes();
        this.species.chromosomes = this.chromosomes;

        if (this.overviewTrackListPanel) {
            this.overviewTrackListPanel.setSpecies(species);
        }
        if (this.trackListPanel) {
            this.trackListPanel.setSpecies(species);
        }
        if (this.chromosomePanel) {
            this.chromosomePanel.setSpecies(species);
        }
        if (this.karyotypePanel) {
            this.karyotypePanel.setSpecies(species);
        }
        if (this.navigationBar) {
            this.navigationBar.setSpecies(species);
        }
    },
    _getSpeciesByTaxonomy: function (taxonomyCode) {
        //find species object
        var speciesObject = null;
        for (var i = 0; i < this.availableSpecies.items.length; i++) {
            for (var j = 0; j < this.availableSpecies.items[i].items.length; j++) {
                var species = this.availableSpecies.items[i].items[j];
                var taxonomy = Utils.getSpeciesCode(species.scientificName);
                if (taxonomy === taxonomyCode) {
                    speciesObject = species;
                    break;
                }
            }
        }
        return speciesObject;
    },

    /*****************/
    /*****************/
    /*****************/
    /*****************/
    /** API METHODS **/
    /*****************/
    setSpeciesByTaxonomy: function (taxonomyCode) {
        var species = this._getSpeciesByTaxonomy(taxonomyCode);
        if (species != null) {
            this._speciesChangeHandler({species: species});
        } else {
            console.log("Species taxonomy not found on availableSpecies.")
        }
    },
    setRegion: function (region, taxonomy) {
        if (taxonomy != null) {
            var species = this._getSpeciesByTaxonomy(taxonomy);
            this._updateSpecies(species);
        }
        return this._regionChangeHandler({region: new Region(region)});
    },
    moveRegion: function (disp) {
        this.region.start += disp;
        this.region.end += disp;
        this.trigger('region:move', {region: this.region, disp: -disp, sender: this});
    },
    setWidth: function (width) {
        var me = this;
        var newRegion = new Region(this.region);
        var newLength = width * this.region.length() / this.width;
        var centerPosition = this.region.center();
        var aux = Math.ceil((newLength / 2) - 1);
        newRegion.start = Math.floor(centerPosition - aux);
        newRegion.end = Math.floor(centerPosition + aux);

        this.width = width;

        if (this.overviewTrackListPanel) {
            this.overviewTrackListPanel.setWidth(width);
        }
        if (this.trackListPanel) {
            this.trackListPanel.setWidth(width);
        }
        if (this.chromosomePanel) {
            this.chromosomePanel.setWidth(width);
        }
        if (this.karyotypePanel) {
            this.karyotypePanel.setWidth(width);
        }
        if (this.navigationBar) {
            this.navigationBar.setWidth(width);
        }

        var hasChanged = this._regionChangeHandler({
            region: newRegion
        });
    },
    setZoom: function (zoom) {
        zoom = Math.min(100, zoom);
        zoom = Math.max(0, zoom);
        this.zoom = zoom;
        this.region.load(this._calculateRegionByZoom(zoom));
        this.setRegion(this.region);
    },
    increaseZoom: function (zoomToIncrease) {
        var zoom = this.zoom + zoomToIncrease;
        this.setZoom(zoom);
    },
    setCellBaseHost: function (host) {
        if (host != this.cellBaseHost) {
            this.cellBaseHost = host;
            this.navigationBar.setCellBaseHost(this.cellBaseHost);
            this.chromosomePanel.setCellBaseHost(this.cellBaseHost);
            this.karyotypePanel.setCellBaseHost(this.cellBaseHost);
            this.trackListPanel.setCellBaseHost(this.cellBaseHost);
            this.overviewTrackListPanel.setCellBaseHost(this.cellBaseHost);

            this._updateSpecies(this.species);
            this.setRegion(new Region(this.region));
        }
    },

    /*****************/
    /*****************/
    getSVGCanvasWidth: function () {
        return this.width - this.trackPanelScrollWidth - this.sidePanelWidth;
    },
    /*****************/
    /*****************/
    /*****************/







    mark: function (args) {
        var attrName = args.attrName || 'feature_id';
        var cssClass = args.class || 'ocb-feature-mark';
        if ('attrValues' in args) {
            args.attrValues = ($.isArray(args.attrValues)) ? args.attrValues : [args.attrValues];
            for (var key in args.attrValues) {
                $('rect[' + attrName + '~=' + args.attrValues[key] + ']').attr('class', cssClass);
            }

        }
    },
    unmark: function (args) {
        var attrName = args.attrName || 'feature_id';
        if ('attrValues' in args) {
            args.attrValues = ($.isArray(args.attrValues)) ? args.attrValues : [args.attrValues];
            for (var key in args.attrValues) {
                $('rect[' + attrName + '~=' + args.attrValues[key] + ']').attr('class', '');
            }

        }
    },

    highlight: function (args) {
        this.trigger('feature:highlight', args);
    },


    getRightSidePanelId: function () {
        return $(this.rightSidebarDiv).attr('id');
    },
    getLeftSidePanelId: function () {
        return $(this.leftSidebarDiv).attr('id');
    },
    getNavigationPanelId: function () {
        return $(this.navigationbarDiv).attr('id');
    },
    getStatusPanelId: function () {
        return $(this.statusbarDiv).attr('id');
    },
    setNavigationBar: function (navigationBar) {
        this.navigationBar = navigationBar;
        var config = {
            availableSpecies: this.availableSpecies,
            species: this.species,
            region: this.region,
            width: this.width,
            svgCanvasWidthOffset: this.trackPanelScrollWidth + this.sidePanelWidth
        };
        _.extend(this.navigationBar, config);
        navigationBar.render(this.getNavigationPanelId());
    },

    toggleAutoHeight: function (bool) {
        this.trackListPanel.toggleAutoHeight(bool);
        this.overviewTrackListPanel.toggleAutoHeight(bool);
    },
    updateHeight: function () {
        this.trackListPanel.updateHeight();
        this.overviewTrackListPanel.updateHeight();
    },


    setSpeciesVisible: function (bool) {
        this.navigationBar.setSpeciesVisible(bool);
    },

    setChromosomesVisible: function (bool) {
        this.navigationBar.setChromosomeMenuVisible(bool);
    },

    setKaryotypePanelVisible: function (bool) {
        this.karyotypePanel.setVisible(bool);
        this.navigationBar.setVisible({'karyotype': bool});
    },

    setChromosomePanelVisible: function (bool) {
        this.chromosomePanel.setVisible(bool);
        this.navigationBar.setVisible({'chromosome': bool});
    },

    setRegionOverviewPanelVisible: function (bool) {
        this.overviewTrackListPanel.setVisible(bool);
        this.navigationBar.setVisible({'region': bool});
    },
    setRegionTextBoxVisible: function (bool) {
        this.navigationBar.setRegionTextBoxVisible(bool);
    },
    setSearchVisible: function (bool) {
        this.navigationBar.setSearchVisible(bool);
    },
    setFullScreenVisible: function (bool) {
        this.navigationBar.setFullScreenButtonVisible(bool);
    },

    /*Track management*/
    addOverviewTrack: function (track) {
        this.overviewTrackListPanel.addTrack(track);
    },

    addTrack: function (track) {
        this.trackListPanel.addTrack(track);
    },

    getTrackById: function (trackId) {
        return this.trackListPanel.getTrackById(trackId);
    },

    removeTrack: function (track) {
        return this.trackListPanel.removeTrack(track);
    },

    restoreTrack: function (track, index) {
        return this.trackListPanel.restoreTrack(track, index);
    },

    setTrackIndex: function (track, newIndex) {
        return this.trackListPanel.setTrackIndex(track, newIndex);
    },

    scrollToTrack: function (track) {
        return this.trackListPanel.scrollToTrack(track);
    },

    showTrack: function (track) {
        this.trackListPanel.showTrack(track);
    },

    hideTrack: function (track) {
        this.trackListPanel.hideTrack(track);
    },
    containsTrack: function (track) {
        return this.trackListPanel.containsTrack(track);
    },
    containsTrackById: function (trackId) {
        return (this.getTrackById(trackId) != null) ? true : false;
    },
    deleteTracksCache:function(){
         this.overviewTrackListPanel.deleteTracksCache();
         this.trackListPanel.deleteTracksCache();
    },

    // TODO - DEPRECATED
    checkRenderedTrack: function (trackId) {
        console.log('DEPRECATED METHOD')
        console.log(this.checkRenderedTrack);
        this.trackExists(trackId);
    }
};
