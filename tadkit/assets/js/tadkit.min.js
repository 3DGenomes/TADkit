!function(){"use strict";angular.module("TADkit",["TADkit.datasets","TADkit.layers","ui.router","ngMaterial","uuid4","d3js","threejs","generic","ui","bioinformatics","browsers","modeling","visualization"])}(),function(){"use strict";angular.module("TADkit").constant("NAME","TADkit").constant("VERSION","0.3.0").constant("ENV","production").constant("VERBOSE",!1).constant("ONLINE",!1)}(),function(){"use strict";function t(t,e,n,r,o){e.debugEnabled("development"===t),"development"===t&&console.log("TADkit Environment: "+t),r.theme("default").primaryPalette("green").accentPalette("lime",{"default":"500"}).warnPalette("red").backgroundPalette("grey"),r.theme("darkKit").dark(),o.decorator("mdButtonDirective",["$delegate",function(t){var e=t[0].template;return t[0].template=function(t,n){return"file"===n.type?'<label class="md-button" ng-transclude></label>':e(t,n)},t}])}angular.module("TADkit").config(t),t.$inject=["ENV","$logProvider","$locationProvider","$mdThemingProvider","$provide"]}(),function(){"use strict";function t(t,e,n,r,o,i,a){i.info(t+" "+e),i.debug("Environment: "+n+", "+r+", "+o+" "),a.$on("$stateChangeError",function(t,e,n,r,o,a){i.error("Resolve Error: ",a)})}angular.module("TADkit").run(t),t.$inject=["NAME","VERSION","ENV","VERBOSE","ONLINE","$log","$rootScope"]}(),function(){"use strict";function t(t,e){e.otherwise("/project/loader/"),t.state("main",{controller:"MainController","abstract":!0,url:"",templateUrl:"assets/templates/main.html",resolve:{initialData:["App",function(t){return new t}]}}).state("project",{parent:"main",url:"/project",data:{cssClassnames:"main"},views:{"topbar@main":{templateUrl:"assets/templates/topbar.html",controller:"TopbarController"},"sidebar-left@main":{templateUrl:"assets/templates/sidebar.project.html",controller:"ProjectController"},"content@main":{templateUrl:"assets/templates/project-content.html",controller:"ProjectContentController"},"sidebar-right@main":{templateUrl:"assets/templates/sidebar.user.html",controller:"SidebarUserController"}}}).state("loader",{parent:"project",url:"/loader/:loadDataset",data:{cssClassnames:"loader"},views:{"topbar@main":{templateUrl:"assets/templates/topbar.html",controller:"TopbarController"},"content@main":{templateUrl:"assets/templates/project-loader.html",controller:"ProjectLoaderController"},"sidebar-right@main":{templateUrl:"assets/templates/sidebar.user.html",controller:"SidebarUserController"}}}).state("dataset",{parent:"project",url:"/dataset",data:{cssClassnames:"dataset"},views:{"content@main":{templateUrl:"assets/templates/project-dataset.html",controller:"ProjectDatasetController"}}}).state("layer",{parent:"project",url:"/layer",data:{cssClassnames:"layer"},views:{"content@main":{templateUrl:"assets/templates/project-layer.html",controller:"ProjectController"}}}).state("storyboard",{parent:"project",url:"/storyboard",data:{cssClassnames:"storyboard"},views:{"content@main":{templateUrl:"assets/templates/project-storyboard.html",controller:"ProjectController"}}}).state("browser",{parent:"project",url:"/browser",views:{"sidebar-left@main":{templateUrl:"assets/templates/sidebar.browser.html",controller:"SidebarBrowserController"},"content@main":{templateUrl:"assets/templates/storyboard.html",controller:"StoryboardController"}}}).state("data-import",{parent:"browser",url:"/data/import",views:{"modal@main":{templateUrl:"assets/templates/data-import.html",controller:"DataImportController"}}}).state("404",{url:"/404",templateUrl:"assets/templates/404.tpl.html",controller:"AppController"})}angular.module("TADkit").config(t),t.$inject=["$stateProvider","$urlRouterProvider"]}(),function(){"use strict";function t(t,e,n,r,o,i,a,s){function c(){t.debug("Dependencies loading...");var s=n.load(),c=o.load(),l=i.load(),u=a.load();return e.all([s,c,l,u]).then(function(e){return t.debug("Dependencies loaded OK!"),r.load(e[2].textures),e})}function l(){var t=s.defaults();return e.all([t]).then(function(t){return t})}return function(){return t.log("TADkit loading..."),c().then(l).then(function(){t.log("TADkit loaded OK!")})}}angular.module("TADkit").factory("App",t),t.$inject=["$log","$q","THREEService","THREETextures","d3Service","Settings","Components","Init"]}(),function(){"use strict";function t(t,e,n,r,o){var i={loaded:[],current:{index:0}};return{load:function(){var r=e.defer(),o="assets/defaults/tk-defaults-components.json";return i.loaded.length>0?r.resolve(i):n.get(o).success(function(e){i.loaded=e,t.debug("Components ("+e.length+") loaded from "+o),r.resolve(i)}),r.promise},add:function(t){t=t||["","","","","","",[]];var e={metadata:{version:1,type:"component",generator:"TADkit"},object:{uuid:r.generate(),id:t[0],title:t[1],type:t[2],state:{width:t[3],height:t[4],margin:t[5],position:t[6]}},view:t[7]};return i.loaded.push(e),i.current=i.loaded.length-1,i},remove:function(t){t=t||i.current.index;var e=i.loaded.indexOf(t);return i.loaded.splice(e,1),i},set:function(t){(void 0!==t||t!==!1)&&(i.current.index=t);var e=i.loaded[i.current.index];return e},init:function(e){return t.info("Component initialized!"),i},get:function(t){t=t||[];var e=[];if(t.length>0)for(var n=t.length-1;n>=0;n--)for(var r=t[n],o=i.loaded.length-1;o>=0;o--){var a=i.loaded[o];if(a.object.id===r){e.unshift(a);break}}else e=i.loaded;return e},getComponent:function(t){(void 0===t||t===!1)&&(t=i.current.index);var e=i.loaded[t];return e},getComponentById:function(e){var n,r;if(void 0===e&&e===!1)return t.warn("No valid component ID supplied.");for(var o=i.loaded.length-1;o>=0;o--)i.loaded[o].object.id===e&&(n=i.loaded[o],r=o,t.debug("Component '"+e+"' found!"));return r||(n=i.loaded[i.current.index],t.warn("Component '"+e+"' not found: returning current.")),n},getComponentByType:function(e){var n,r,o,a=this;if(void 0!==e||e!==!1)for(var s=i.loaded.length-1;s>=0;s--)i.loaded[s].object.type===e&&(n=i.loaded[s],o=s,t.debug("Component type '"+e+"' found!")),"default"===i.loaded[s].object.type&&(r=i.loaded[s]);return o||(n=r,t.warn("Component type '"+e+"' not found: returning default.")),a.init(n),n}}}angular.module("TADkit").factory("Components",t),t.$inject=["$log","$q","$http","uuid4","Settings"]}(),function(){"use strict";function t(t,e,n,r,o,i,a,s,c,l,u,d,p){function g(){t.debug("Default user initializing...");var e=n.getUser();"undefined"!=typeof e.projects&&0===e.projects.length&&(e.projects=r.get(),"undefined"!=typeof e.projects.loaded[0].datasets&&0===e.projects.loaded[0].datasets.length&&(e.projects.loaded[0].datasets=o.get()),"undefined"!=typeof e.projects.loaded[0].layers&&0===e.projects.loaded[0].layers.length&&(e.projects.loaded[0].layers=a.get()),"undefined"!=typeof e.projects.loaded[0].storyboards&&0===e.projects.loaded[0].storyboards.length&&(e.projects.loaded[0].storyboards=c.get())),t.debug("User interface initialized.")}function f(){t.debug("Default dataset initializing...");var n=o.getDataset();i.load(n);var r=i.getModelData();l.set(n);var s=u.set(r).distances,c=r.length/3,p=d.set(n.restraints,c),g=a.update(s,p);return e.all([g]).then(function(){t.debug("Default dataset initialized.")})}return{defaults:function(){t.debug("Defaults initializing...");var i=n.load(),s=r.load(),l=o.load(),u=a.load(),d=c.load(),m=p.load();return e.all([i,s,l,u,d,m]).then(g).then(f).then(function(){t.debug("Defaults initialized.")})}}}angular.module("TADkit").factory("Init",t),t.$inject=["$log","$q","Users","Projects","Datasets","Clusters","Layers","DataImport","Storyboards","Settings","Proximities","Restraints","EnsemblColors"]}(),function(){"use strict";function t(t,e,n,r){var o={loaded:[],current:{index:0}};return{load:function(){var r=e.defer(),i="assets/defaults/tk-defaults-projects.json";return o.loaded.length>0?r.resolve(o):n.get(i).success(function(e){o.loaded=e,t.debug("Projects ("+e.length+") loaded from "+i),r.resolve(o)}),r.promise},add:function(t){var e={metadata:{version:1,type:"project",generator:"TADkit"},object:{uuid:r.generate(),id:t[0],title:t[1],description:t[2],group:t[3],state:t[4]},datasets:t[5],layers:t[6],storyboards:t[7]};return o.loaded.push(e),o.current=o.loaded.length-1,o},remove:function(t){(void 0===t||t===!1)&&(t=o.current.index);var e=o.loaded.indexOf(t);return o.loaded.splice(e,1),o},set:function(t){(void 0!==t||t!==!1)&&(o.current.index=t);var e=o.loaded[o.current.index];return e},get:function(){return o},getProject:function(t){(void 0===t||t===!1)&&(t=o.current.index);var e=o.loaded[t];return e},getState:function(t){(void 0===t||t===!1)&&(t=o.current.index);var e=o.loaded[t].object.state;return e}}}angular.module("TADkit").factory("Projects",t),t.$inject=["$log","$q","$http","uuid4"]}(),function(){"use strict";function t(t,e,n,r){var o={};return{load:function(){var t=n.defer(),i="assets/defaults/tk-defaults-settings.json";return Object.getOwnPropertyNames(o).length>0?t.resolve(o):r.get(i).success(function(n){o=n,e.debug("Settings loaded from "+i),t.resolve(o)}),t.promise},set:function(t){var e=this,n=0;t.object.chromosomeIndex&&(n=t.object.chromosomeIndex),o.current.chrom=t.object.species,o.current.chrom=t.object.chrom[n],o.current.chromStart=t.object.chromStart[n],o.current.chromEnd=t.object.chromEnd[n],o.current.species=t.object.species,o.current.speciesUrl=t.object.speciesUrl,o.current.particleSegments=20,o.current.particlesCount=t.models[0].data.length/t.object.components,o.current.edgesCount=.5*(o.current.particlesCount*o.current.particlesCount-o.current.particlesCount),o.current.segmentsCount=o.current.particlesCount*o.current.particleSegments,o.current.segmentLength=t.object.resolution/o.current.particleSegments,o.current.position=o.current.chromStart+parseInt(.5*(o.current.chromEnd-o.current.chromStart)),o.current.particle=e.getParticle(),o.current.segment=e.getSegment(o.current.position),o.current.segmentLower=o.current.position-.5*o.current.segment,o.current.segmentUpper=o.current.position+.5*o.current.segment},setOnline:function(e){return e=e||t,o.app.online=e,o.online},add:function(t){return o},remove:function(t){return o},getState:function(t){var e=o[settingID].state;return e},get:function(){return o},getOnline:function(){var e=!1;return e=o.app?o.app.online:t},getAddress:function(){var t={};return t.species=o.current.species,t.speciesUrl=o.current.speciesUrl,t.chrom=o.current.chrom,t.chromStart=o.current.chromStart,t.chromEnd=o.current.chromEnd,t},getSegment:function(t){t=t||o.current.position;var e=this,n=e.getRange(o.current.chromStart,t),r=e.getRange(o.current.chromStart,o.current.chromEnd),i=Math.ceil(n*o.current.segmentsCount/r);return i},getParticle:function(t){t=t||o.current.position;var e=this,n=e.getRange(o.current.chromStart,t),r=e.getRange(o.current.chromStart,o.current.chromEnd),i=Math.ceil(n*o.current.particlesCount/r);return i},getRange:function(t,e){for(var n=0,r=t;e>=r;r++)n++;return n},toggle:function(t){return angular.forEach(o,function(e,n){t==e.id&&(e.state=!e.state)}),o}}}angular.module("TADkit").factory("Settings",t),t.$inject=["ONLINE","$log","$q","$http"]}(),function(){"use strict";function t(t,e,n,r,o,i,a){var s={loaded:[],current:{index:0}};return{load:function(){var t=n.defer(),o="assets/defaults/tk-defaults-storyboards.json";return s.loaded.length>0?(e.warn("Storyboards already loaded."),t.resolve(s)):r.get(o).success(function(n){s.loaded=n,e.debug("Storyboards ("+n.length+") loaded from "+o),t.resolve(s)}),t.promise},add:function(t){t=t||[""];var e={metadata:{version:1,type:"storyboard",generator:"TADkit"},object:{uuid:o.generate(),id:t[0],title:t[1],email:t[2],group:t[3],permissions:t[4]},data:t[5]};return s.loaded.push(e),s.current=s.loaded.length-1,s},addComponent:function(t,e,n){var r=this;e=e||"default",n=n||[];var s=i.get(),c=a.getComponentByType(t.object.type),l=angular.copy(c);l.object.uuid=o.generate(),l.object.id=t.object.id,l.object.title=t.object.id,l.object.dataset=t.object.id,l.view.settings.step=t.object.step,l.view.settings.color=t.object.color,l.view.viewpoint.species=s.current.species,l.view.viewpoint.chrom=s.current.chrom,l.view.viewpoint.chromStart=s.current.chromStart,l.view.viewpoint.chromEnd=s.current.chromEnd,l.view.viewpoint.scale=s.views.scale,l.view.viewtype=t.object.type+"-"+t.object.stepType,l.data=t.data,l.layer=t;var u=r.getStoryboardById(e);return u.components.push(l),l},defaultComponents:function(t){var n=this;t=t||"current";var r;for(r="current"==t?n.getStoryboard():n.getStoryboardById(t);r.components.length>6;)e.warn("Popping to default components..."),s.loaded[s.current.index].components.pop();return s},remove:function(t){(void 0===t||t===!1)&&(t=s.current.index);var e=s.loaded.indexOf(t);return s.loaded.splice(e,1),s},removeComponentById:function(t){var e=this;if(void 0!==t||t!==!1){var n=e.getStoryboard();n.components.splice(component.index,1)}return s},set:function(t){(void 0!==t||t!==!1)&&(s.current.index=t);var e=s.loaded[s.current.index];return e},setComponents:function(){var t=this,e=t.getStoryboard(),n=a.get(e.componentList);return e.components=n,n},setViewpoint:function(){var n=i.get(),r=s.loaded[s.current.index].components;return t&&e.debug(r),angular.forEach(r,function(t,e){var r=n.views.scale||1;if(t.view.viewpoint.species=n.current.species,t.view.viewpoint.chrom=n.current.chrom,t.view.viewpoint.chromStart=n.current.chromStart,t.view.viewpoint.chromEnd=n.current.chromEnd,"scene"===t.object.type||"scene-clusters"===t.object.type){var o=t.view.viewpoint.fov/2,i=.6;r=Math.tan(o).toFixed(2)*i}t.view.viewpoint.scale=r}),s},update:function(t){var e=this,n=e.getStoryboard().components;angular.forEach(n,function(e,n){("track-genes"==e.object.type||"panel-inspector"==e.object.type)&&(e.data=t.data,e.layer=t)})},get:function(){return s},getStoryboard:function(t){(void 0===t||t===!1)&&(t=s.current.index);var e=s.loaded[t];return e},getStoryboardById:function(t){var n,r;if(void 0!==t||t!==!1)for(var o=s.loaded.length-1;o>=0;o--)s.loaded[o].object.id===t&&(n=s.loaded[o],n.index=o,r=!0,e.debug('Layer "'+t+'" found!'));return r||(n=s.loaded[s.current.index],n.index=s.current.index,e.warn("Storyboard '"+t+"' not found: returning current.")),n},getComponents:function(){var t=this,e=t.getStoryboard().components;return e}}}angular.module("TADkit").factory("Storyboards",t),t.$inject=["VERBOSE","$log","$q","$http","uuid4","Settings","Components"]}(),function(){"use strict";function t(t,e,n,r){var o={loaded:[],current:{index:0}};return{load:function(){var r=e.defer(),i="assets/defaults/tk-defaults-users.json";return o.loaded.length>0?r.resolve(o):n.get(i).success(function(e){o.loaded=e,t.debug("Users ("+e.length+") loaded from "+i),r.resolve(o)}),r.promise},add:function(t){t=t||["id","Name Surname","email@company.com","Group","edit",["default"]];var e={metadata:{version:1,type:"user",generator:"TADkit"},object:{uuid:r.generate(),id:t[0],title:t[1],email:t[2],group:t[3],permissions:t[4]},projects:t[5]};return o.loaded.push(e),o.current=o.loaded.length-1,o},remove:function(t){(void 0===t||t===!1)&&(t=o.current.index);var e=o.loaded.indexOf(t);return o.loaded.splice(e,1),o},set:function(t){(void 0!==t||t!==!1)&&(o.current.index=t);var e=o.loaded[o.current.index];return e},get:function(){return o},getUser:function(t){(void 0===t||t===!1)&&(t=o.current.index);var e=o.loaded[t];return e},getPermissions:function(t){(void 0===t||t===!1)&&(t=o.current.index);var e=o.loaded[t].permissions;return e}}}angular.module("TADkit").factory("Users",t),t.$inject=["$log","$q","$http","uuid4"]}(),function(){"use strict";angular.module("TADkit.datasets",[])}(),function(){"use strict";function t(t,e,n,r,o){return{"import":function(t){t=t||{};var e=this,n={};if(angular.isObject(t)||(t=angular.fromJson(t)),t.metadata&&"dataset"==t.metadata.type&&"TADbit"==t.metadata.generator)n=t,n.object=e.detail(t);else{var i=e.validate(t.data),a=e.filter(i,t.selection),s=e.detail(t);n=e.create(a,s)}return n.clusters?(console.log("Clusters found :)"),r.load(n)):(console.log("No clusters :("),o["import"](n)),n},parse:function(t){Papa.DefaultDelimiter=" ";var e=Papa.parse(t,{dynamicTyping:!0,skipEmptyLines:!0,fastMode:!0});return e.data},validate:function(t){var e,n=!0;return e=t,n?e:void 0},filter:function(t,e){var n=[];if(0===e.rows.length&&0===e.cols.length)n=t;else for(var r=e.rows.length,o=e.cols.length,i=0;r>i;i++){var a=[];if(e.rows[i]){for(var s=0;o>s;s++)e.cols[s]&&a.push(t[i][s]);n.push(a)}}return n},detail:function(t){var e={};if(t.object)e=t.object;else{var n={uuid:"00000000-0000-0000-0000-000000000000",id:"default",title:"Default",description:"Default description",source:"Default",assembly:"Default",experimentType:"Default",project:"Default",domain:"Default",organism:"Default",species:"Default",cellType:"Default",chrom:["X"],chromStart:[0],chromEnd:[1e3],resolution:1e3,datatype:"default",components:2,dependencies:{}};e=n}var r=e.species,o=r.replace(/[^a-z0-9]/gi,"_").toLowerCase();e.speciesUrl=o;for(var i=e.chrom.length-1;i>=0;i--)e.chrom[i].toLowerCase();return e.region=e.chrom+":"+e.chromStart+"-"+e.chromEnd,e},create:function(n,r){var o={metadata:{version:t,type:"dataset",generator:e},object:r,data:n};return o}}}angular.module("TADkit.datasets").factory("DataImport",t),t.$inject=["VERSION","NAME","$log","Clusters","Layers"]}(),function(){"use strict";function t(t,e,n,r,o,i){var a={loaded:[],current:{index:0}};return{load:function(t,e){t=t||"tk-example-dataset",e=e||!1;var o=this;e&&o.clear();var i="examples",s=n.defer(),c="assets/"+i+"/"+t+".json";return r.get(c).success(function(e){e.object.filename=t,o["import"](e),s.resolve(a)}),s.promise},preview:function(t,e){var n={data:{},selection:{rows:[],cols:[]},details:{}};n.data=i.parse(t);for(var r=n.data.length;--r>=0;)n.selection.rows[r]=!0;for(var o=n.data[0].length;--o>=0;)n.selection.cols[o]=!0;return n},"import":function(t){t=t||"error";var e=this,n=i["import"](t);return n=e.unique(n),e.add(n),n},unique:function(t){var n=1e3,r=!1;if(a.loaded.length>0){for(;n>1||!r;){for(var i=0,s=o.generate(),c=a.loaded.length-1;c>=0;c--)if(a.loaded[c].uuid==s){i++;var l={};t==l?e.info("Dataset already loaded."):e.warn("Not a unique ID")}0===i&&(r=!0),n--}r||0!==n||e.warn("Timeout searching for unique UUID")}return t},add:function(t){return a.loaded.push(t),a.current.index=a.loaded.length-1,e.info("Dataset "+t.object.species+" "+t.object.region+" loaded from file."),a},clear:function(){for(;a.loaded.length>0;)a.loaded.shift();return e.info("Datasets Object cleared!")},remove:function(t){(void 0===t||t===!1)&&(t=a.current.index);var n=a.loaded.indexOf(t),r=n.title;return a.loaded.splice(n,1),e.info("Dataset "+r+"at index "+t+" removed!"),a},set:function(t){(void 0!==t||t!==!1)&&(a.current.index=t);var e=a.loaded[a.current.index];return e},get:function(){return a},getDataset:function(t){(void 0===t||t===!1)&&(t=a.current.index);var e=a.loaded[t];return e},getModel:function(t){t=t||1;for(var e,n=a.loaded[a.current.index].length-1;n>=0;n--)a.loaded[a.current.index].models[n].ref==t&&(e=a.loaded[a.current.index].models[n]);return e}}}angular.module("TADkit.datasets").factory("Datasets",t),t.$inject=["VERBOSE","$log","$q","$http","uuid4","DataImport"]}(),function(){"use strict";angular.module("TADkit.layers",[])}(),function(){"use strict";function t(t,e,n,r){return{build:function(t){var e,n,o,i=["#227c4f","#e71818","#8ece0d","#6666ff","#424242"],a=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],s=[],c=0,l=1,u=0,d=1,p=t[c].length,g=t[l][d]-t[l][u]+1,f=t[l+1][d]-t[l+1][u]+1;g==f?(e="wiggle_0",n="fixed",o="fixed"):(e="bedgraph",n="variable",o="variable");var m=!1;if(7==p){for(var h=0,v=2;p>v;v++){var w=t[c][v].toLowerCase();("hp1"==w||"brm"==w||"mrg15"==w||"pc"==w||"h1"==w)&&h++}5==h&&(m=!0)}for(var b=p-1;b>=2;b--){var y;y=m?i[b-2]:a[b],s.unshift({metadata:{version:1,type:"layer",generator:"TADkit"},object:{uuid:r.generate(),id:t[c][b],title:t[c][b],source:"Research output",url:"local",description:"center_label",type:e,format:n,components:2,name:t[c][b],visibility:"full",color:y,altColor:"#cccccc",priority:"100",stepType:o,chrom:"",start:t[l][u],step:g,state:{index:0,overlaid:!1}},palette:[y,"#cccccc"],data:[],colors:{particles:[],chromatin:[],network:{RGB:[],alpha:[]}}});for(var x=t.length-1;x>=1;x--)"variable"==n?s[0].data.unshift({start:t[x][u],end:t[x][d],read:t[x][b]}):s[0].data.unshift(t[x][b])}return s}}}angular.module("TADkit.layers").factory("LayerAnnotations",t),t.$inject=["$log","$q","$http","uuid4"]}(),function(){"use strict";function t(){return{build:function(t){}}}angular.module("TADkit.layers").factory("LayerName",t)}(),function(){"use strict";function t(t,e,n,r,o,i,a,s,c,l,u){var d={loaded:[],current:{index:0}};return{load:function(){var t=n.defer(),o="assets/defaults/tk-defaults-layers.json";return d.loaded.length>0?t.resolve(d):r.get(o).success(function(n){d.loaded=n,e.debug("Layers ("+n.length+") loaded from "+o),t.resolve(d)}),t.promise},"import":function(t){var e,n,r,i=this,a=t.data,s=["#227c4f","#e71818","#8ece0d","#6666ff","#424242"],c=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],l=[],u=0,d=1,p=0,g=1,f=a[u].length,m=a[d][g]-a[d][p]+1,h=a[d+1][g]-a[d+1][p]+1;m==h?(e="wiggle_0",n="fixed",r="fixed"):(e="bedgraph",n="variable",r="variable");var v=!1;if(7==f){for(var w=0,b=2;f>b;b++){var y=a[u][b].toLowerCase();("hp1"==y||"brm"==y||"mrg15"==y||"pc"==y||"h1"==y)&&w++}5==w&&(v=!0)}for(var x=f-1;x>=2;x--){var k;k=v?s[x-2]:c[x],l.unshift({metadata:{version:1,type:"layer",generator:"TADkit"},object:{uuid:o.generate(),id:a[u][x],title:a[u][x],source:"Research output",url:"local",description:"center_label",type:e,format:n,components:2,name:a[u][x],visibility:"full",color:k,altColor:"#cccccc",priority:"100",stepType:r,chrom:"",start:a[d][p],step:m,state:{index:0,overlaid:!1}},palette:[k,"#cccccc"],data:[],colors:{particles:[],chromatin:[],network:{RGB:[],alpha:[]}}});for(var C=a.length-1;C>=1;C--)"variable"==n?l[0].data.unshift({start:a[C][p],end:a[C][g],read:a[C][x]}):l[0].data.unshift(a[C][x])}return console.log(l),i.add(l),l},add:function(t){var e=this,n=[],r=d.loaded.length-1;return angular.forEach(t,function(t,e){var o=!1;o||(r++,t.object.state.index=r,t.object.state.overlaid=!1,n.push(t),a.addComponent(t))}),d.loaded=d.loaded.concat(n),e.segment(),n},clear:function(){for(;d.loaded.length>0;)d.loaded.shift()},defaults:function(){for(;d.loaded.length>4;)d.loaded.pop(),a.defaultComponents()},remove:function(t){(void 0===t||t===!1)&&(t=d.current.index);var e=d.loaded.indexOf(t);return d.loaded.splice(e,1),d},set:function(t){(void 0!==t||t!==!1)&&(d.current.index=t);var e=d.loaded[d.current.index];return e},setOverlaid:function(t){return t=t||"",angular.forEach(d.loaded,function(e){e.object.state.index===t?e.object.state.overlaid=!0:e.object.state.overlaid=!1}),t},update:function(t,e){var r=this,o=[],c=[];return angular.forEach(d.loaded,function(t,e){if("ensembl"==t.object.type){var n=i.getAddress(),r=s.load(t,n);o.push(r),c.push(t)}}),n.all(o).then(function(t){for(var e=0;e<c.length;e++){var n=c[e];a.update(n)}return r.segment(),t})},segment:function(){var t=this,n=i.get();return angular.forEach(d.loaded,function(r,o){var i=!0;if(i){var a=r.object.type,s=r.object.format;if("gradient"==a&&"hex"==s)r.colors.particles=l.gradientHCL(r,n.current.particlesCount),r.colors.chromatin=l.gradientHCL(r,n.current.segmentsCount),r.colors.network.RGB=u.lineSegmentsRGB(r,n.current.edgesCount),r.colors.network.alpha=u.lineSegmentsAlpha(r,n.current.edgesCount);else if("wiggle_0"==a&&"fixed"==s)r.colors.particles=l.bicolor(r,n.current.particlesCount),r.colors.chromatin=l.bicolor(r,n.current.segmentsCount),r.colors.network.RGB=u.lineSegmentsRGB(r,n.current.edgesCount),r.colors.network.alpha=u.lineSegmentsAlpha(r,n.current.edgesCount);else if("wiggle_0"==a&&"variable"==s);else if("bedgraph"==a)r.colors.particles=l.bicolorVariable(r,n.current.chromStart,n.current.particlesCount,1),r.colors.chromatin=l.bicolorVariable(r,n.current.chromStart,n.current.segmentsCount,n.current.segmentLength),r.colors.network.RGB=u.lineSegmentsRGB(r,n.current.edgesCount),r.colors.network.alpha=u.lineSegmentsAlpha(r,n.current.edgesCount);else if("matrix"==a)r.colors.particlesMatrix=l.matrix(r,1),r.colors.chromatinMatrix=l.matrix(r,n.current.particleSegments),r.colors.networkMatrix=r.colors.particlesMatrix,t.at(1,n.current.particlesCount,n.current.particleSegments);else if("misc"==a&&"variable"==s)r.colors.particles=[],r.colors.chromatin=[],r.colors.network.RGB=u.lineSegmentsRGB(r,n.current.edgesCount),r.colors.network.alpha=u.lineSegmentsAlpha(r,n.current.edgesCount);else if("ensembl"==a&&"json"==s){var d=c.get("gene"),p=1;r.colors.particles=l.features(r,n.current.chromStart,n.current.particlesCount,p,d),r.colors.chromatin=l.features(r,n.current.chromStart,n.current.segmentsCount,n.current.segmentLength,d),r.colors.network.RGB=u.lineSegmentsRGB(r,n.current.edgesCount),r.colors.network.alpha=u.lineSegmentsAlpha(r,n.current.edgesCount)}}else e.warn("Layer '"+r.object.title+"' already segmented as color array matching current dataset length")}),d},at:function(t){var e=i.get();return angular.forEach(d.loaded,function(n,r){var o=n.object.type;if("matrix"==o){var i=(t-1)*e.current.particlesCount,a=t*e.current.particlesCount,s=i*e.current.particleSegments,c=a*e.current.particleSegments;n.colors.particles=n.colors.particlesMatrix.slice(i,a),n.colors.chromatin=n.colors.chromatinMatrix.slice(s,c),n.colors.network=n.colors.networkMatrix.slice(i,a)}}),d},get:function(){return d},getLayer:function(t){(void 0===t||t===!1)&&(t=d.current.index);var e=d.loaded[t];return e},getLayerById:function(n){var r,o;if(void 0!==n||n!==!1)for(var i=d.loaded.length-1;i>=0;i--)d.loaded[i].object.id===n&&(r=d.loaded[i],r.object.state.index=i,o=!0,e.debug('Layer "'+n+'" found!'));return o||(r=d.loaded[d.current.index],r.object.state.index=d.current.index,e.debug('Layer "'+n+'" not found: returning current.')),t&&e.debug(r),r},getCurrentIndex:function(){return d.current.index}}}angular.module("TADkit.layers").factory("Layers",t),t.$inject=["VERBOSE","$log","$q","$http","uuid4","Settings","Storyboards","FeaturesEnsembl","EnsemblColors","Segments","Networks"]}(),function(){"use strict";function t(t,e,n){return{restrict:"EA",link:function(r,o,i){t&&e.debug(r),r.component.object.idIndex=r.component.object.id+"-"+r.$index;var a="<data-tk-component-"+r.component.object.type+' id="{{component.object.idIndex}}" type="component.object.type" title="{{component.object.title}}" state="component.object.state" settings="settings" view="component.view" currentparticle="currentParticle"currentposition="currentPosition"currentmodel="current.model" currentlayer="current.layer" data="component.data" proximities="component.proximities" layer="component.layer"togglelayer="toggleLayer(index)" style="margin: {{component.object.state.margin}}; background-color: {{component.view.settings.background}}" class="component '+r.component.object.type+'"></data-tk-component-'+r.component.object.type+">";o.replaceWith(n(a)(r))}}}angular.module("TADkit").directive("tkComponent",t),t.$inject=["VERBOSE","$log","$compile"]}(),function(){"use strict";function t(t,e){return{restrict:"E",templateUrl:"assets/templates/browser.html",link:function(t,e,n){console.log(t.component.view.viewpoint.chromStart);new Browser({pageName:e[0].firstChild.id,chr:"1",viewStart:t.component.view.viewpoint.chromStart,viewEnd:t.component.view.viewpoint.chromEnd,cookieKey:"human",coordSystem:{speciesName:"Human",taxon:9606,auth:"NCBI",version:"36",ucscName:"hg18"},sources:[{name:"Genome",uri:"http://www.derkholm.net:8080/das/hg18comp/",tier_type:"sequence",provides_entrypoints:!0},{name:"Genes",desc:"Gene structures from Ensembl 54",uri:"http://www.derkholm.net:8080/das/hsa_54_36p/",collapseSuperGroups:!0,provides_karyotype:!0,provides_search:!0},{name:"Repeats",uri:"http://www.derkholm.net:8080/das/hsa_54_36p/",stylesheet_uri:"http://www.derkholm.net/dalliance-test/stylesheets/ens-repeats.xml"},{name:"MeDIP raw",uri:"http://www.derkholm.net:8080/das/medipseq_reads"},{name:"MeDIP-seq",uri:"http://www.ebi.ac.uk/das-srv/genomicdas/das/batman_seq_SP/"}]})}}}angular.module("TADkit").directive("tkComponentBrowserBiodalliance",t),t.$inject=["VERBOSE","$log"]}(),function(){"use strict";function t(t,e,n){return{restrict:"E",templateUrl:"assets/templates/browser.html",link:function(t,r,o){var i="{container:'#"+t.component.object.idIndex+"'";i+=",genome:'grch38'",i+=",chr:1",i+=",start:"+t.component.view.viewpoint.chromStart,i+=",end:"+t.component.view.viewpoint.chromEnd,i+=",plugins:['fileDrop']",i+=",tracks:[",i+="Genoverse.Track.Scalebar,",i+="Genoverse.Track.extend({name:'Sequence',controller:Genoverse.Track.Controller.Sequence,model:Genoverse.Track.Model.Sequence.Ensembl,view:Genoverse.Track.View.Sequence,100000:false,resizable:'auto'}),",i+="Genoverse.Track.Gene,",i+="Genoverse.Track.extend({name:'RegulatoryFeatures',url:'http://rest.ensembl.org/overlap/region/human/__CHR__:__START__-__END__?feature=regulatory;content-type=application/json',resizable:'auto',model:Genoverse.Track.Model.extend({dataRequestLimit:5000000}),setFeatureColor:function(f){f.color='#AAA';}}),",i+="Genoverse.Track.dbSNP",i+="]}",n.load(i).then(function(t){e.debug(window.Genoverse)})}}}angular.module("TADkit").directive("tkComponentBrowserGenoverse",t),t.$inject=["VERBOSE","$log","GenoverseService"]}(),function(){"use strict";function t(t,e,n){return{restrict:"E",templateUrl:"assets/templates/browser.html",link:function(t,r,o){function i(){var t={text:"Species",items:[]};return angular.forEach(SPECIES,function(e,n){var r={text:n,items:e};t.items.push(r)}),t}var a=t.component.object.idIndex+"-holder",s=parseInt(t.component.view.settings.margin),c={top:parseInt(t.component.view.settings.padding.top),right:parseInt(t.component.view.settings.padding.right),bottom:parseInt(t.component.view.settings.padding.bottom),left:parseInt(t.component.view.settings.padding.left)},l=parseInt(t.component.view.settings.heightInner),u=(t.component.view.settings.color,r[0].parentNode),d=u.clientWidth-2*s-c.left-c.right,p=(l-c.top-c.bottom,null);n.load().then(function(){for(var n={},r=i(),o=t.component.view.viewpoint.species.toLowerCase(),s=r.items.length-1;s>=0;s--)for(var c=r.items[s].items,l=c.length-1;l>=0;l--){var u=c[l],g=u.scientificName.toLowerCase();g==o&&(n=u,e.info("Cellbase: Found species: "+g+" (id: "+u.id+")"))}n||(n=r.metazoa.items[1],e.warn("Cellbase: Species not found! Returning: "+n.scientificName));var f=new Region({chromosome:t.component.view.viewpoint.chrom,start:t.component.view.viewpoint.chromStart,end:t.component.view.viewpoint.chromEnd}),m="https://wwwdev.ebi.ac.uk/cellbase/webservices/rest";p=new GenomeViewer({cellBaseHost:m,cellBaseVersion:"v3",target:a,width:d,region:f,availableSpecies:r,species:n.id,sidePanel:!1,autoRender:!0,resizable:!0,karyotypePanelConfig:{collapsed:!1,collapsible:!0},chromosomePanelConfig:{collapsed:!1,collapsible:!0},navigationBarConfig:{componentsConfig:{}},handlers:{"region:change":function(t){console.log(t)}}}),e.debug(p),e.info("Browser directive loaded")})}}}angular.module("TADkit").directive("tkComponentBrowserJsorolla",t),t.$inject=["VERBOSE","$log","JsorollaService"]}(),function(){"use strict";function t(t,e,n){return{restrict:"E",templateUrl:"assets/templates/browser.html",link:function(t,r,o){var i=t.component.object.idIndex+"-holder",a=parseInt(t.component.view.settings.margin),s={top:parseInt(t.component.view.settings.padding.top),right:parseInt(t.component.view.settings.padding.right),bottom:parseInt(t.component.view.settings.padding.bottom),left:parseInt(t.component.view.settings.padding.left)},c=parseInt(t.component.view.settings.heightInner),l=(t.component.view.settings.color,r[0].parentNode),u=l.clientWidth-2*a-s.left-s.right,d=(c-s.top-s.bottom,
t.component.view.viewpoint.species.toLowerCase()),p=t.component.view.viewpoint.chrom,g=t.component.view.viewpoint.chromStart,f=t.component.view.viewpoint.chromEnd;n.load().then(function(){function t(t){CellBaseManager.get({host:a,category:"meta",subCategory:"species",success:function(e){var n=e.response[0].result[0];for(var r in n){for(var o=[],i=0;i<n[r].length;i++)for(var a=n[r][i],s=0;s<a.assemblies.length;s++){var c=Utils.clone(a);c.assembly=a.assemblies[s],delete c.assemblies,o.push(c)}n[r]=o}t(n)}})}function n(){var t;for(var n in o)for(var l=o[n],p=l.length-1;p>=0;p--){var g=l[p];g.scientificName.toLowerCase()==d&&(t=g,e.info("Cellbase: Found species: "+g.scientificName+" (id: "+g.id+")"))}t||(t=o.metazoa.items[1],e.warn("Cellbase: Species not found! Returning: "+t.scientificName)),r=new GenomeViewer({cellBaseHost:a,cellBaseVersion:s,target:i,width:u+18,region:c,availableSpecies:o,species:t,sidePanel:!1,autoRender:!0,resizable:!0,karyotypePanelConfig:{collapsed:!1,collapsible:!1},chromosomePanelConfig:{collapsed:!1,collapsible:!1},navigationBarConfig:{componentsConfig:{}},handlers:{"region:change":function(t){}},trackListTitle:"",drawNavigationBar:!1,drawKaryotypePanel:!1,drawChromosomePanel:!1,drawOverviewTrackListPanel:!1});var f=[],m=new GeneTrack({title:void 0,minHistogramRegionSize:2e7,maxLabelRegionSize:1e7,minTranscriptRegionSize:2e5,height:100,renderer:new GeneRenderer({handlers:{"feature:click":function(t){}}}),dataAdapter:new CellBaseAdapter({category:"genomic",subCategory:"region",resource:"gene",species:r.species,params:{exclude:"transcripts"},cacheConfig:{chunkSize:1e5}})});f.push(m),r.addTrack(f),r.draw(),e.debug(r),e.info("Browser directive loaded")}var r,o,a="http://bioinfodev.hpc.cam.ac.uk/cellbase",s="v3",c=new Region({chromosome:p,start:g,end:f});t(function(t){o=t,n()})})}}}angular.module("TADkit").directive("tkComponentBrowserJsorolla",t),t.$inject=["VERBOSE","$log","JsorollaService"]}(),function(){"use strict";function t(t,e){}angular.module("TADkit").controller("BrowserController",t),t.$inject=["$log","$scope"]}(),function(){"use strict";function t(t){t.species=t.current.dataset.object.species,t.region=t.current.dataset.object.region}angular.module("TADkit").controller("PanelInfoboxController",t),t.$inject=["$scope"]}(),function(){"use strict";function t(){return{restrict:"C",templateUrl:"assets/templates/panel-infobox.html",link:function(t,e,n){}}}angular.module("TADkit").directive("tkComponentPanelInfobox",t)}(),function(){"use strict";function t(t,e){t.optionsState=!1,t.toggleOptions=function(){t.optionsState=!t.optionsState},t.toggle=function(t){t=!t},t.width=parseInt(t.state.width),t.height=parseInt(t.state.height),t.atPosition=function(e){return t.$parent.settings.current.segmentUpper>=e.start&&t.$parent.settings.current.segmentLower<=e.end?!0:!1},t.formatRegionName=function(t){return"Chromosome"==t?t:"chr"+t},t.featureTitle=function(t){return t.external_name?t.external_name:t.id},t.getDetails=function(t,n){e.show(e.alert().title("Details").content(t.description).ariaLabel("Item details").ok("Close").targetEvent(n))}}angular.module("TADkit").controller("PanelInspectorController",t),t.$inject=["$scope","$mdDialog"]}(),function(){"use strict";function t(t,e){return{restrict:"EA",scope:{id:"@",state:"=",view:"=",data:"=",settings:"="},templateUrl:"assets/templates/panel-inspector.html",link:function(n,r,o){t&&e.debug(n.data)}}}angular.module("TADkit").directive("tkComponentPanelInspector",t),t.$inject=["VERBOSE","$log"]}(),function(){"use strict";function t(t,r,o,i){return function(a,s,c){t&&r.debug(s);var l={visible:!0,genomeLength:816394,particles:0,particleSegments:5,curveSegments:1,radius:15,radiusSegments:16,endcap:!1,pathClosed:!1};c=c||{},angular.extend(this,angular.copy(l),c);for(var u=e(a),d=u.vertices.length-1;d>=0;d--){var p=new THREE.Color(s[20*d]);u.colors.unshift(p)}for(var g=i.cubic(u.vertices,this.pathClosed),f=new THREE.Geometry,m=0;m<g.vertices.length;m++){f.vertices.push(new THREE.Vector3(g.vertices[m].x,g.vertices[m].y,g.vertices[m].z||0));var h=g.colors[m];f.colors.push(h)}f.name="controlsGeom",0===this.particles&&(this.particles=u.vertices.length);var v=this.particles*this.particleSegments;this.pathSegments=v;for(var w=o.cubicBezier(g.vertices,v,this.pathClosed),b=w.createPointsGeometry(v),y=b.vertices.length-1;y>=0;y--){var x=new THREE.Color(s[y]);b.colors.unshift(x)}b.name="cubicGeom";var k=w.getLength(),C=15,E=11*this.genomeLength/1080;this.radius=k*C/E;for(var S=new THREE.Object3D,$=new THREE.Geometry,j=0;v>j;j++){this.endcap=0===j||j===v-1?!1:!0;var T=s[j],A=new THREE.MeshLambertMaterial({color:T,emissive:T,vertexColors:THREE.VertexColors,opacity:1,transparent:!1,wireframe:!1}),D=n(b.vertices[j],b.vertices[j+1],this);$.merge(D);var R=new THREE.Mesh(D,A);R.name="segment-"+(j+1),S.add(R)}return $.computeBoundingSphere(),S.boundingSphere=$.boundingSphere,S.name="Chromatin Fiber",S}}function e(t){for(var e,n=0,r=new THREE.Geometry,o=t.length;o>n;)e=new THREE.Vector3,e.x=t[n++],e.y=t[n++],e.z=t[n++],r.vertices.push(e);return r.name="Chromatin Geometry",r}function n(t,e,n){var r,o=(new THREE.Vector3).subVectors(e,t),i=new THREE.Matrix4;i.lookAt(t,e,(new THREE.Object3D).up);var a=new THREE.Matrix4;return a.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),i.multiply(a),i.setPosition(t.add(e).multiplyScalar(.5)),r=new THREE.CylinderGeometry(n.radius,n.radius,o.length(),n.radiusSegments,n.curveSegments,n.endcap),r.applyMatrix(i),r}angular.module("TADkit").factory("Chromatin",t),t.$inject=["VERBOSE","$log","Paths","PathControls"]}(),function(){"use strict";function t(t,n,r){return function(o,i,a,s){t&&n.debug(a);var c={visible:!0};s=s||{},angular.extend(this,angular.copy(c),s);for(var l=new THREE.BufferGeometry,u=r.THREEColorsFromHex(a),d=new THREE.Object3D,p=0;p<o.length;p++){var g=o[p];l.addAttribute("position",new THREE.BufferAttribute(g,3));var f=e(g);f.colors=u;var m=(a[p],new THREE.LineBasicMaterial({color:new THREE.Color(this.color),opacity:this.modelOpacity,transparent:this.transparent,linewidth:this.linewidth,fog:this.fog})),h=new THREE.LineBasicMaterial({opacity:this.centroidOpacity,transparent:this.transparent,linewidth:this.linewidth,vertexColors:THREE.VertexColors,fog:this.fog});p==i&&(m=h);var v=new THREE.Line(f,m);v.name="model-"+p,d.add(v)}return l.computeBoundingBox(),d.boundingBox=l.boundingBox,d.BufferGeometry=l,d.name="Cluster Ensemble",d}}function e(t){for(var e,n=0,r=new THREE.Geometry,o=t.length;o>n;)e=new THREE.Vector3,e.x=t[n++],e.y=t[n++],e.z=t[n++],r.vertices.push(e);return r}angular.module("TADkit").factory("Cluster",t),t.$inject=["VERBOSE","$log","Color"]}(),function(){"use strict";function t(t,e,n,r,o,i){return{restrict:"EA",scope:{title:"@",view:"=",clusters:"=",layer:"=",mousemove:"&"},templateUrl:"assets/templates/scene-clusters.html",link:function(a,s,c){t&&e.debug(a),r.load(["TrackballControls","OrbitControls"]).then(function(t){var r,c,l,u,d,p,g,f,m,h,v,w,b,y,x=n.getRenderer(),k=[];a.init=function(){r=s[0].children[0].children[3].children[0],c=s.parent().parent()[0];var e=parseInt(window.getComputedStyle(c,null).getPropertyValue("padding"));l=c.clientWidth-2*e,u=c.clientHeight-2*e,x.setSize(l,u),r.appendChild(x.domElement);var n=a.view.settings.rowHeight,C=n.split(":"),E=parseInt(C[0],10)/parseInt(C[1],10);v=parseInt(a.view.settings.gutter),h=a.view.settings.cols;var S=(h-1)/h,$=1/h,j=v*S;w=l*$-j,b=w,y=b*E,d=new t.PerspectiveCamera(a.view.viewpoint.fov,E,a.view.viewpoint.near,a.view.viewpoint.far),d.position.fromArray(a.view.viewpoint.camera),d.name="Scene Camera",m=new t.TrackballControls(d,x.domElement),angular.forEach(a.clusters,function(e,n){k[n]=new t.Scene;var r,s;r=new o(e.data[e.centroidIndex],a.layer,a.view.settings.particles),r.visible=a.view.settings.particles.visible,k[n].add(r),s=new i(e.data,e.centroidIndex,a.layer,a.view.settings.cluster),s.visible=a.view.settings.cluster.visible,s.name=s.name+" "+n,k[n].add(s)}),p=a.view.viewpoint.camera,g=a.view.viewpoint.target,f=a.view.viewpoint.translate,a.lookAtTarget(p,g,f)},a.lookAtTarget=function(e,n,r){e=e||new t.Vector3(5e4,5e4,5e4);var o=new t.Vector3(0,0,0);n=n||o,r=r||500,d.position.set(e.x,e.y,e.z),d.lookAt(o),d.translateZ(r),d.lookAt(n),d.updateMatrixWorld(),m.target.copy(e),m.update()};var C,E=0;a.animate=function(){E>=0&&1>E?(C=requestAnimationFrame(a.animate),m.update(),a.render(),E++,e.debug("AnimationFrame requested")):(cancelAnimationFrame(C),e.debug("AnimationFrame canceled"))},a.render=function(){var t=1,n=1;angular.forEach(a.clusters,function(e,r){0===r&&x.clear();var o=k[r];m.update();var i=(w+v)*(t-1),a=u-w*n;x.setViewport(i,a,b,y),x.setScissor(i,a,b,y),x.enableScissorTest(!0),x.setClearColor("#ffffff"),x.render(o,d,null,!0),t===h?(t=1,n++):t++}),e.debug(d)},angular.element(document).ready(function(){a.init(),a.animate()})})}}}angular.module("TADkit").directive("tkComponentSceneClusters",t),t.$inject=["VERBOSE","$log","THREEService","THREEPlugins","Particles","Cluster"]}(),function(){"use strict";function t(t,e,n){return{restrict:"EA",link:function(r,o,i){n.load(["TrackballControls","OrbitControls"]).then(function(n){var i,a,s,c,l,u,d,p,g=e.getRenderer();r.init=function(){i=o[0],a=i.clientWidth,g.setSize(a,a),i.appendChild(g.domElement),c=new n.Scene,s=new n.PerspectiveCamera(50,1,150,650),s.position.z=500,c.add(s),l=new n.TorusKnotGeometry(100,30,100,16),u=new n.MeshDepthMaterial({wireframe:!0}),d=new n.Mesh(l,u),d.name="Floating TAD",c.add(d)},t.$on("$stateChangeStart",function(){cancelAnimationFrame(p)}),r.animate=function(){p=requestAnimationFrame(r.animate),r.render()},r.render=function(){d.rotation.x+=.006,d.rotation.y+=.006,g.render(c,s,null,!0)},r.init(),r.animate()})}}}angular.module("TADkit").directive("tkComponentSceneFloatingtad",t),t.$inject=["$rootScope","THREEService","THREEPlugins"]}(),function(){"use strict";function t(t,n,r,o,i){return function(r,o,i){t&&n.debug(r),t&&n.debug(o);var a={color:"#ff0000",size:200,opacity:.8,map:"assets/img/sphere-glossy.png",depthtest:!0,alphatest:.5,transparent:!0,visible:!1};i=i||{},angular.extend(this,angular.copy(a),i);var s={},c={uniforms:s,vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:document.getElementById("fragmentShader").textContent,vertexColors:THREE.VertexColors,transparent:!0},l=new THREE.ShaderMaterial(c),u=r.length/3,d=.5*(u*u-u),p=e(r,d),g=o.RGB,f=o.alpha,m=new THREE.BufferGeometry;m.addAttribute("position",new THREE.BufferAttribute(p,3)),m.addAttribute("color",new THREE.BufferAttribute(g,3)),m.addAttribute("alpha",new THREE.BufferAttribute(f,1)),m.computeBoundingSphere();var h=null;if(this.map){var v=new THREE.TextureLoader;v.load(this.map,function(t){h=t},function(t){n.info(t.loaded/t.total*100+"% loaded")},function(t){n.error("An error happened")})}var w=(new THREE.PointsMaterial({color:this.color,vertexColors:THREE.VertexColors,size:this.size,opacity:this.opacity,map:h,depthTest:this.depthtest,alphaTest:this.alphatest,transparent:this.transparent}),new THREE.LineSegments(m,l));return w.name="Network Graph",t&&n.debug(w),w}}function e(t,e,n){for(var r=new Float32Array(6*n),o=0,i=0;i<e.length;i+=3)for(var a=i,s=i+3;s<e.length;s+=3){var c=s;t.debug(o),t.debug(e[a]+","+e[a+1]+","+e[a+2]),t.debug(e[c]+","+e[c+1]+","+e[c+2]),r[o]=e[a],o++,r[o]=e[a+1],o++,r[o]=e[a+2],o++,r[o]=e[c],o++,r[o]=e[c+1],o++,r[o]=e[c+2],o++}return r.name="Network Vertex Pairs",r}angular.module("TADkit").factory("Network",t),t.$inject=["VERBOSE","$log","Color","Particles","Networks"]}(),function(){"use strict";function t(t){return function(n,r,o){var i={particles:0,visible:!0,color:"#fff000",size:200,opacity:.8,map:"particle",depthtest:!0,alphatest:.5,transparent:!0};o=o||{},angular.extend(this,angular.copy(i),o);var a=e(n);a.computeBoundingSphere();for(var s=[],c=0;c<a.vertices.length;c++)s[c]=new THREE.Color("rgb(255,255,255)");a.colors=s;var l=t.get(this.map),u=new THREE.PointsMaterial({color:this.color,vertexColors:THREE.VertexColors,size:this.size,opacity:this.opacity,map:l,depthTest:this.depthtest,alphaTest:this.alphatest,transparent:this.transparent}),d=new THREE.Points(a,u);return d.name="Particles Cloud",d}}function e(t){for(var e,n=0,r=new THREE.Geometry,o=t.length;o>n;)e=new THREE.Vector3,e.x=t[n++],e.y=t[n++],e.z=t[n++],r.vertices.push(e);return r.name="Particles Geometry",r}angular.module("TADkit").factory("Particles",t),t.$inject=["THREETextures"]}(),function(){"use strict";function t(t,e,n,r){n.optionsState=!1,n.toggleOptions=function(){n.optionsState=!n.optionsState},n.toggle=function(e){e=!e,t.debug(e)},n.selectCluster=function(n){r.setCluster(n+1);var o=r.getCentroidRef();t.info("Current Cluster: "+(n+1)+" (Centroid Model: "+o+")"),e.go("browser")}}angular.module("TADkit").controller("SceneController",t),t.$inject=["$log","$state","$scope","Clusters"]}(),function(){"use strict";function t(t,e,n,r,o,i,a){return{restrict:"EA",scope:{type:"=",title:"@",settings:"=",view:"=",data:"=",layer:"=",state:"=",currentmodel:"=",proximities:"=",currentlayer:"="},templateUrl:"assets/templates/scene.html",link:function(s,c,l){r.load(["TrackballControls","OrbitControls"]).then(function(r){var l,u,d,p,g,f,m,h,v,w,b,y,x,k,C,E,S,$,j,T,A=n.getRenderer(),D=new r.Color,R=new r.Color,I=new r.Color("rgb(0,0,0)");s.init=function(){l=c[0].children[0].children[3],u=parseInt(s.state.width),d=parseInt(s.state.height);var t=s.view.settings.background;A.setSize(u,d),l.appendChild(A.domElement),v=new r.Scene,w=new r.PerspectiveCamera(s.view.viewpoint.fov,u/d,s.view.viewpoint.near,s.view.viewpoint.far),w.position.fromArray(s.view.viewpoint.camera),w.name="Scene Camera",v.add(w),S=new r.TrackballControls(w,A.domElement),E=new r.OrbitControls(w,A.domElement),E.autoRotate=s.view.controls.autoRotate,E.autoRotateSpeed=s.view.controls.autoRotateSpeed,E.enableZoom=!1,E.enableRotate=!1,E.enablePan=!1,E.enableKeys=!1;var e=new r.AxisHelper(s.view.settings.axis.size);e.visible=s.view.settings.axis.visible,e.name="Axis",v.add(e);var n=s.view.settings.lighting.ambient;k=new r.AmbientLight(n),k.name="Scene Ambient Light",$=new o(s.currentmodel.data,s.currentlayer.colors.particles,s.view.settings.particles),$.visible=s.view.settings.particles.visible,v.add($),j=new i(s.currentmodel.data,s.currentlayer.colors.chromatin,s.view.settings.chromatin),j.visible=s.view.settings.chromatin.visible,v.add(j),s.view.settings.chromatin.radius=j.boundingSphere.radius,T=new a(s.data,s.layer.colors.network,s.view.settings.network),T.visible=s.view.settings.network.visible,v.add(T),b=j.boundingSphere.center,y=j.boundingSphere.center,x=j.boundingSphere.radius*s.view.viewpoint.scale,s.lookAtTAD(b,y,x);var p=s.view.settings.lighting.color,g=s.view.settings.lighting.intensity;C=new r.PointLight(p,g),C.name="Scene Light",w.add(C);var f=.5*x;C.position.set(f,f,-1*f);var m=100,h=(new r.PointLightHelper(C,m),x*s.view.viewpoint.fogNear),B=x*s.view.viewpoint.fogFar;s.view.viewpoint.fog&&(v.fog=new r.Fog(t,h,B)),s.$watch("view.controls.autoRotate",function(t,e){t!==e&&(E.autoRotate=s.view.controls.autoRotate)}),s.$watch("view.settings.axis.visible",function(t,n){t!==n&&(e.visible=!e.visible)}),s.$watch("view.settings.particles.visible",function(t,e){t!==e&&($.visible=!$.visible)}),s.$watch("view.settings.chromatin.visible",function(t,e){t!==e&&(j.visible=!j.visible)}),s.$watch("view.settings.network.visible",function(t,e){t!==e&&(T.visible=!T.visible)}),s.$watch("currentlayer.colors.chromatin",function(t,e){if(t!==e)for(var n=j.children.length,o=0;n>o;o++){var i=new r.Color(t[o]);j.children[o].material.color=i,j.children[o].material.emissive=i}}),s.$watch("currentlayer.colors.network",function(t,e){t!==e&&(T.geometry.addAttribute("color",new r.BufferAttribute(t.RGB,3)),T.geometry.addAttribute("alpha",new r.BufferAttribute(t.alpha,1)))}),s.$watch("settings.current.particle",function(t,e){t!==e&&(D&&($.geometry.colors[e-1]=D),D=$.geometry.colors[t-1],$.geometry.colors[t-1]=I,$.geometry.colorsNeedUpdate=!0)}),s.$watch("settings.current.segment",function(t,e){if(t!==e){var n=j.getObjectByName("segment-"+e);R&&(n.material.color=R,n.material.emissive=R);var r=j.getObjectByName("segment-"+t);R=r.material.color,r.material.color=I,r.material.emissive=I}})},s.onWindowResize=function(){s.resizeCanvas()},e.$on("$stateChangeStart",function(){t.info("$stateChangeStart")}),e.$on("$stateNotFound",function(){t.warn("$stateNotFound")}),e.$on("$stateChangeSuccess",function(){t.info("$stateChangeSuccess")}),e.$on("$stateChangeError",function(){t.warn("$stateChangeError")}),s.resizeCanvas=function(){p=.66*l.parentNode.clientWidth,g=.66*p,f=p/2,m=g/2,w.aspect=p/g,w.updateProjectionMatrix(),A.setSize(p,g)},s.lookAtTAD=function(t,e,n){t=t||new r.Vector3(5e4,5e4,5e4);var o=new r.Vector3(0,0,0);e=e||o,n=n||500,w.position.set(t.x,t.y,t.z),w.lookAt(o),w.translateZ(n),w.lookAt(e),w.updateMatrixWorld(),S.target.copy(t)},s.animate=function(){h=requestAnimationFrame(s.animate),S.update(),s.render()},s.render=function(){A.render(v,w,null,!0)},s.init(),s.animate()})}}}angular.module("TADkit").directive("tkComponentScene",t),t.$inject=["$log","$rootScope","THREEService","THREEPlugins","Particles","Chromatin","Network"]}(),function(){"use strict";function t(t,e,n,r){return{restrict:"EA",scope:{type:"=",title:"@",settings:"=",view:"=",data:"=",layer:"=",togglelayer:"&"},templateUrl:"assets/templates/track.html",link:function(o,i,a){t&&e.debug(o),n.load().then(function(t){o.safeApply=function(t){var e=this.$root.$$phase;"$apply"==e||"$digest"==e?t&&"function"==typeof t&&t():this.$apply(t)};var e,n,a,s,c,l,u,d,p,g,f,m,h,v=o.data,w=o.view.viewpoint.chromStart,b=o.view.viewpoint.chromEnd,y=o.settings.current.particlesCount,x=parseInt(o.view.settings.margin),k={top:parseInt(o.view.settings.padding.top),right:parseInt(o.view.settings.padding.right),bottom:parseInt(o.view.settings.padding.bottom),left:parseInt(o.view.settings.padding.left)},C=parseInt(o.view.settings.heightInner),E=(o.view.settings.color,o.layer.palette[0]),S=o.layer.palette[1],$=i[0].parentNode,j=i[0].children[0].children[3],T=t.select(j).append("svg");o.$watch(function(){var t=$.clientWidth,e=$.clientHeight;return t+e},function(){o.render(v)}),o.$watch("data.dimension",function(t,e){t!==e&&(v=o.data,o.render(v))}),o.$watch("settings.current.position",function(t,e){t!==e&&o.update()}),o.getColor=function(t){for(var e=[{type:"harmonic",code:"H",color:"#4CAF50"},{type:"upperBound",code:"L",color:"#0000ff"},{type:"lowerBound",code:"U",color:"#ff00ff"},{type:"contact",code:"C",color:"#00ff00"}],n="#ccc",r=e.length-1;r>=0;r--)t==e[r].code&&(n=e[r].color);return n},o.getOpacity=function(t){var e,n=t/5;return e=n*n},o.getStrokeWidth=function(t){var e=10,n=t/5;return e*=n},o.render=function(r){if(T.selectAll("*").remove(),r){var i=$.clientWidth-2*x-k.left-k.right,v=C-k.top-k.bottom,j=1*i/y,A=j;e=t.scale.linear().range([0,i]).domain([w,b]).clamp(!0),n=t.scale.linear().domain([-5,5]).range([0,v]),a=t.svg.axis().scale(n).orient("left").ticks(6).outerTickSize(1);var D=2;s=t.svg.brush().x(e).extent([0,0]).on("brush",o.brushed),c=T.attr("width",i+k.left+k.right).attr("height",v+k.top+k.bottom).append("g").attr("transform","translate("+k.left+","+k.top+")").call(s),c.append("g").attr("class","y axis").append("line").attr("y1",n(0)).attr("y2",n(0)).attr("x1",0).attr("x2",i),c.select(".background").attr("y",v/2).attr("height",v),l=c.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",i).attr("height",v).style("fill","white"),u=c.append("g").attr("class","focus"),d=u.append("g").attr("class","container").attr("clip-path","url(#clip)"),f=d.append("g").attr("class","harmonics"),m=d.append("g").attr("class","lowerbounds"),p=u.append("g").attr("class","axis y").call(a),g=c.append("g").attr("class","labels"),f.selectAll("rect").data(r.harmonics).enter().append("rect").attr("x",function(t){return t[1]*A}).attr("y",function(t){return n(t[3])}).attr("width",A).attr("height",function(t){return n(t[3])}).style("fill",E).style("stroke",E).style("stroke-width",0).append("svg:title").text(function(t,e){return e+":"+t}),m.selectAll("rect").data(r.lowerBounds).enter().append("rect").attr("x",function(t){return t[1]*A}).attr("y",function(t){return n(Math.max(0,-1*t[3]))}).attr("width",A).attr("height",function(t){return n(t[3])}).style("fill",S).style("stroke",S).style("stroke-width",0).append("svg:title").text(function(t,e){return e+":"+t}),h=c.append("rect").attr("id","highlight").attr("x",function(t){return e(o.settings.current.position)}).attr("y",0).attr("width",D).attr("height",C).attr("class","highlight-follow")}},o.update=function(t){T.select("#highlight").attr("x",function(t){return e(o.settings.current.position)})},o.brushed=function(){var n=this;o.safeApply(function(){var i=s.extent()[0];t.event.sourceEvent&&(i=parseInt(e.invert(t.mouse(n)[0])),s.extent([i,i])),h.attr("x",e(i)),o.settings.current.position=i,o.settings.current.particle=r.getParticle(),o.settings.current.segmentLower=o.settings.current.position-5*o.settings.current.segment,o.settings.current.segmentUpper=o.settings.current.position+5*o.settings.current.segment})},o.render(v)})}}}angular.module("TADkit").directive("tkComponentTrackBarchart",t),t.$inject=["VERBOSE","$log","d3Service","Settings"]}(),function(){"use strict";function t(t,e,n){return{restrict:"EA",scope:{type:"=",title:"@",settings:"=",view:"=",data:"=",layer:"=",togglelayer:"&"},templateUrl:"assets/templates/track.html",link:function(r,o,i){n.load().then(function(n){t&&e.debug(r);var i,a,s,c,l,u,d,p=r.data,g=r.view.settings.step,f=r.view.viewpoint.chromStart,m=r.view.viewpoint.chromEnd,h=m-f,v=parseInt(r.view.settings.margin),w={top:parseInt(r.view.settings.padding.top),right:parseInt(r.view.settings.padding.right),bottom:parseInt(r.view.settings.padding.bottom),left:parseInt(r.view.settings.padding.left)},b=parseInt(r.view.settings.heightInner),y=.5*b,x=.5*(b-y),k=(r.view.settings.color,o[0].parentNode),C=o[0].children[0].children[3],E=n.select(C).append("svg");r.$watch(function(){var t=k.clientWidth,e=k.clientHeight;return t+e},function(){r.render(p)}),r.$watch("settings.current.position",function(t){r.update()},!0);n.behavior.zoom().on("zoom",function(){r.update()});r.render=function(t){if(E.selectAll("*").remove(),t){var e=k.clientWidth-2*v-w.left-w.right,o=b-w.top-w.bottom;i=g*e/h,d=n.scale.linear().range([0,e]).clamp(!0),d.domain([f,m]),c=n.svg.axis().scale(d).orient("top").ticks(0).outerTickSize(0);var p=2;a=E.attr("width",e+w.left+w.right).attr("height",o+w.top+w.bottom).append("g").attr("transform","translate("+w.left+","+w.top+")"),s=a.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",e).attr("height",o).style("fill","white"),l=a.append("g").attr("class","focus"),u=l.append("g").attr("class","container").attr("clip-path","url(#clip)");a.append("g").attr("class","labels"),u.selectAll("rect").data(t).enter().append("rect").attr("x",function(t,e){return Math.floor(d(t.start))}).attr("y",x).attr("width",function(t){return Math.ceil(d(t.end)-d(t.start))}).attr("height",y).attr("class",function(t){return 1==t.read?r.title:void 0}).append("svg:title").text(function(t,e){return t.start+":"+t.end+"("+t.read+")"}),a.append("rect").attr("id","highlight").attr("x",function(t){return d(r.settings.current.position-.5*g)}).attr("y",0).attr("width",p).attr("height",b).attr("class","highlight-follow")}},r.update=function(){E.select("#highlight").attr("x",function(t){return d(r.settings.current.position-.5*g)})}})}}}angular.module("TADkit").directive("tkComponentBedgraph",t),t.$inject=["VERBOSE","$log","d3Service"]}(),function(){"use strict";function t(t,e){return{restrict:"EA",scope:{type:"=",title:"@",settings:"=",view:"=",data:"=",layer:"=",togglelayer:"&"},templateUrl:"assets/templates/track.html",link:function(t,n,r){e.load().then(function(e){function r(e){e["start-end"]=e.start+"-"+e.end,e.length=e.end-e.start;var n=["id","biotype","start-end","strand","length","assembly_name","description"],r=[];angular.forEach(e,function(t,e){e.toLowerCase();for(var o=n.length-1;o>=0;o--)if(n[o].toLowerCase(),e==n[o]){var i=e.replace("_name","");r.push({name:i,value:t})}}),t.safeApply(function(){t.tooltip.title=e.feature_type+": "+e.external_name,t.tooltip.content=r})}t.safeApply=function(t){var e=this.$root.$$phase;"$apply"==e||"$digest"==e?t&&"function"==typeof t&&t():this.$apply(t)};var o=t.data,i=32e8;t.settings.current.position||(t.settings.current.position=i/2);var a=t.view.viewpoint.chromStart,s=t.view.viewpoint.chromEnd,c=s-a,l=1e3,u=i/c,d=.05*u;u-=2*d;var p,g,f,m,h,v,w=.5*c,b=.5*i,y=parseInt(t.view.settings.margin),x={top:parseInt(t.view.settings.padding.top),right:parseInt(t.view.settings.padding.right),bottom:parseInt(t.view.settings.padding.bottom),left:parseInt(t.view.settings.padding.left)},k=parseInt(t.view.settings.heightInner),C=10,E=n[0].parentNode,S=n[0].getBoundingClientRect(),$=n[0].children[0].children[3],j=e.select($).append("svg");t.$watch(function(){var t=E.clientWidth,e=E.clientHeight;return t+e},function(){t.render(o),S=n[0].getBoundingClientRect()}),t.$watch("data",function(e,n){e!==n&&t.render(e)}),t.$watch("settings.current.position",function(e,n){e!==n&&t.update()});var T=180,A=10,D="rgb(76,175,80)";t.tooltip={title:"Gene",content:{},styling:{width:T,padding:A,background:D}};var R=e.select($).select("tk-tooltip");R.style("width",T+"px"),R.style("padding",A+"px");e.behavior.zoom().on("zoom",function(){t.update()});t.render=function(n){if(j.selectAll("*").remove(),n){var o=E.clientWidth-2*y-x.left-x.right,i=k-x.top-x.bottom;v=e.scale.linear().range([0,o]).clamp(!0),v.domain([a,s]),f=e.svg.axis().scale(v).orient("top").ticks(0).outerTickSize(0);var c=2;v(b)-v(w);p=j.attr("width",o+x.left+x.right).attr("height",i+x.top+x.bottom).append("g").attr("transform","translate("+x.left+","+x.top+")"),g=p.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",o).attr("height",i).style("fill","white"),m=p.append("g").attr("class","focus"),h=m.append("g").attr("class","container").attr("clip-path","url(#clip)");var u=(m.append("g").attr("class","x axis").attr("transform","translate(0,"+C+")").call(f),p.append("g").attr("class","labels"));u.append("text").attr("x",-18).attr("y",8).style("text-anchor","right").style("font-size","10px").text("<<"),u.append("text").attr("x",-18).attr("y",18).style("text-anchor","right").style("font-size","10px").text(">>");h.selectAll("rect").data(n).enter().append("rect").attr("x",function(t){return Math.floor(v(t.start))}).attr("y",function(e){return t.view.settings.sense&&e.strand<1?C:0}).attr("width",function(t){return Math.ceil(v(t.end)-v(t.start))}).attr("height",function(e){return t.view.settings.sense?C:2*C}).attr("class",function(t){var e=t.biotypeStyle;return e+=t.strand<1?" forward-strand":" reverse-strand"}).on("mouseover",function(t){r(t),R.transition().duration(200).style("opacity",.8),R.style("left",e.event.pageX-.5*T+"px")}).on("mouseout",function(t){R.transition().duration(200).style("opacity",0)}),p.append("rect").attr("id","highlight").attr("x",function(e){return v(t.settings.current.position-.5*l)}).attr("y",0).attr("width",c).attr("height",k).attr("class","highlight-follow")}},t.update=function(){j.select("g.x.axis").call(f),h.selectAll("rect").attr("x",function(t){return Math.floor(v(t.start))}).attr("y",function(e){return t.view.settings.sense&&e.strand<1?C:0}).attr("width",function(t){return Math.ceil(v(t.end)-v(t.start))}).attr("height",function(e){return t.view.settings.sense?C:2*C}),j.select("#highlight").attr("x",function(e){return v(t.settings.current.position-.5*l)})}})}}}angular.module("TADkit").directive("tkComponentTrackGenes",t),t.$inject=["$log","d3Service"]}(),function(){"use strict";function t(t,e,n,r){return{restrict:"EA",scope:{type:"=",title:"@",settings:"=",view:"=",data:"=",layer:"=",togglelayer:"&"},templateUrl:"assets/templates/track.html",link:function(o,i,a){t&&e.debug(o),n.load().then(function(t){o.safeApply=function(t){var e=this.$root.$$phase;"$apply"==e||"$digest"==e?t&&"function"==typeof t&&t():this.$apply(t)};var e,n,a,s,c,l,u,d,p,g,f=o.data.distances,m=o.view.viewpoint.chromStart,h=o.view.viewpoint.chromEnd,v=o.settings.current.particlesCount,w="clip"+o.title,b="url(#"+w+")",y=parseInt(o.view.settings.margin),x={top:parseInt(o.view.settings.padding.top),right:parseInt(o.view.settings.padding.right),bottom:parseInt(o.view.settings.padding.bottom),left:parseInt(o.view.settings.padding.left)},k=parseInt(o.view.settings.heightInner),C=.5*k,E=.5*(k-C),S=o.view.settings.color,$=i[0].parentNode,j=i[0].children[0].children[3],T=t.select(j).append("svg");o.$watch(function(){var t=$.clientWidth,e=$.clientHeight;return t+e},function(){o.render(f)}),o.$watch("data.dimension",function(t,e){t!==e&&(f=o.data.distances,o.render(f))}),o.$watch("settings.current.position",function(t,e){t!==e&&o.update()}),o.render=function(r){if(T.selectAll("*").remove(),r){var i=$.clientWidth-2*y-x.left-x.right,f=k-x.top-x.bottom,j=1*i/v;e=t.scale.linear().range([0,i]).clamp(!0),e.domain([m,h]),n=t.svg.axis().scale(e).orient("top").ticks(0).outerTickSize(0);var A=2;a=t.svg.brush().x(e).extent([0,0]).on("brush",o.brushed),s=T.attr("width",i+x.left+x.right).attr("height",f+x.top+x.bottom).append("g").attr("transform","translate("+x.left+","+x.top+")").call(a),s.select(".background").attr("y",f/2).attr("height",f),c=s.append("defs").append("clipPath").attr("id",w).append("rect").attr("width",i).attr("height",f).style("fill","white"),l=s.append("g").attr("class","focus"),u=l.append("g").attr("class","container").attr("clip-path",b),d=s.append("g").attr("class","labels"),p=u.selectAll("rect").data(r).enter().append("rect").attr("x",function(t,e){return e*j}).attr("y",E).attr("width",j).attr("height",C).style("fill",S).style("fill-opacity",function(t){return t*t}).style("stroke",S).style("stroke-width",0).append("svg:title").text(function(t,e){return e+":"+t}),g=s.append("rect").attr("id","highlight").attr("x",function(t){return e(o.settings.current.position)}).attr("y",0).attr("width",A).attr("height",k).attr("class","highlight-follow"),g.call(a.extent([o.settings.current.position,0])).call(a.event)}},o.update=function(){T.select("#highlight").attr("x",function(t){return e(o.settings.current.position)})},o.brushed=function(){var n=this;o.safeApply(function(){var i=a.extent()[0];t.event.sourceEvent&&(i=parseInt(e.invert(t.mouse(n)[0])),a.extent([i,i])),g.attr("x",e(i)),o.settings.current.position=i,o.settings.current.particle=r.getParticle(),o.settings.current.segmentLower=o.settings.current.position-5*o.settings.current.segment,o.settings.current.segmentUpper=o.settings.current.position+5*o.settings.current.segment})},o.render(f)})}}}angular.module("TADkit").directive("tkComponentTrackProximities",t),t.$inject=["VERBOSE","$log","d3Service","Settings"]}(),function(){"use strict";function t(t,e){return{restrict:"EA",scope:{type:"=",title:"@",settings:"=",view:"=",data:"=",layer:"=",togglelayer:"&"},templateUrl:"assets/templates/track.html",link:function(n,r,o){t.load().then(function(t){n.safeApply=function(t){var e=this.$root.$$phase;"$apply"==e||"$digest"==e?t&&"function"==typeof t&&t():this.$apply(t)};var o,i,a,s,c,l,u,d,p,g,f,m=n.data,h=n.view.viewpoint.chromStart,v=n.view.viewpoint.chromEnd,w=n.settings.current.particlesCount,b="clip"+n.title,y="url(#"+b+")",x=parseInt(n.view.settings.margin),k={top:parseInt(n.view.settings.padding.top),right:parseInt(n.view.settings.padding.right),bottom:parseInt(n.view.settings.padding.bottom),left:parseInt(n.view.settings.padding.left)},C=2,E=parseInt(n.view.settings.heightInner),S=n.view.settings.nodeSize,$=k.top+.5*S,j=(n.view.settings.color,n.layer.palette[0]),T=n.layer.palette[1],A=r[0].parentNode,D=r[0].children[0].children[3],R=t.select(D).append("svg");n.$watch(function(){var t=A.clientWidth,e=A.clientHeight;return t+e},function(){n.render(n.data)}),n.$watch("data.dimension",function(t,e){t!==e&&(m=n.data,n.render(m))}),n.$watch("settings.current.position",function(t,e){
t!==e&&n.update()}),n.getColor=function(t){for(var e=[{type:"harmonic",code:"H",color:"#4CAF50"},{type:"upperBound",code:"L",color:"#0000ff"},{type:"lowerBound",code:"U",color:"#ff00ff"},{type:"contact",code:"C",color:"#00ff00"}],n="#ccc",r=e.length-1;r>=0;r--)t==e[r].code&&(n=e[r].color);return n},n.getOpacity=function(t){var e,n=t/C;return e=n*n},n.getStrokeWidth=function(t){var e=5,n=t/5;return e*=n},n.render=function(e){if(R.selectAll("*").remove(),e){var r=A.clientWidth-2*x-k.left-k.right,m=E-k.top-k.bottom,C=1*r/w;o=t.scale.linear().range([0,r]).clamp(!0),o.domain([h,v]),i=t.svg.axis().scale(o).orient("top").ticks(0).outerTickSize(0),a=t.svg.axis().scale(o).orient("bottom").ticks(0).outerTickSize(0);var D=2;s=t.svg.brush().x(o).extent([0,0]).on("brush",n.brushed),c=R.attr("width",r+k.left+k.right).attr("height",m+k.top+k.bottom).append("g").attr("transform","translate("+k.left+","+k.top+")").call(s),c.select(".background").attr("y",m/2).attr("height",m),l=c.append("defs"),l.append("clipPath").attr("id",b).append("rect").attr("width",r).attr("height",m).style("fill","white"),u=c.append("g").attr("class","focus"),p=u.append("g").attr("class","harmonics").attr("clip-path",y),g=u.append("g").attr("class","lowerbounds").attr("clip-path",y),d=c.append("g").attr("class","labels"),p.append("rect").attr("x",e.dimension*C-C).attr("y",$-.5*S).attr("width",C).attr("height",S).style("fill",j).append("svg:title").text(e.dimension),p.selectAll("line").data(e.harmonics).enter().append("line").attr("x1",function(t){return t[0]*C-.5*C}).attr("y1",$).attr("x2",function(t){return t[1]*C-.5*C}).attr("y2",m-S).attr("marker-end","url(#harmonics-marker)").style("stroke",j).style("opacity",1).style("stroke-width",function(t){return n.getStrokeWidth(t[3])}).append("svg:title").text(function(t){return t[1]+":"+t[3]}),p.selectAll("circle").data(e.harmonics).enter().append("circle").attr("cx",function(t){return t[1]*C-.5*C}).attr("cy",m-S).attr("r",.5*S).style("opacity",function(t){return n.getOpacity(t[3])}).style("fill",j).append("svg:title").text(function(t){return t[0]+" : "+t[1]}),g.append("rect").attr("x",e.dimension*C-C).attr("y",m-1.5*S).attr("width",C).attr("height",S).style("fill",T).append("svg:title").text(e.dimension),g.selectAll("line").data(e.lowerBounds).enter().append("line").attr("x1",function(t){return t[0]*C-.5*C}).attr("y2",$).attr("x2",function(t){return t[1]*C-.5*C}).attr("y1",m-S).attr("marker-end","url(#lowerbounds-marker)").style("stroke",T).style("opacity",function(t){return n.getOpacity(t[3])}).style("stroke-width",function(t){return n.getStrokeWidth(t[3])}).append("svg:title").text(function(t){return t[1]+":"+t[3]}),g.selectAll("circle").data(e.lowerBounds).enter().append("circle").attr("cx",function(t){return t[1]*C-.5*C}).attr("cy",$).attr("r",.5*S).style("opacity",function(t){return n.getOpacity(t[3])}).style("fill",T).append("svg:title").text(function(t){return t[0]+" : "+t[1]}),f=c.append("rect").attr("id","highlight").attr("x",o(n.settings.current.position)).attr("y",0).attr("width",D).attr("height",E).attr("class","highlight-follow")}},n.update=function(t){R.select("#highlight").attr("x",function(t){return o(n.settings.current.position)})},n.brushed=function(){var r=this;n.safeApply(function(){var i=s.extent()[0];t.event.sourceEvent&&(i=parseInt(o.invert(t.mouse(r)[0])),s.extent([i,i])),f.attr("x",o(i)),n.settings.current.position=i,n.settings.current.particle=e.getParticle(),n.settings.current.segmentLower=n.settings.current.position-5*n.settings.current.segment,n.settings.current.segmentUpper=n.settings.current.position+5*n.settings.current.segment})},n.render(m)})}}}angular.module("TADkit").directive("tkComponentTrackRestraints",t),t.$inject=["d3Service","Settings"]}(),function(){"use strict";function t(t,e,n,r){return{restrict:"EA",scope:{type:"=",title:"@",settings:"=",view:"=",data:"=",layer:"=",togglelayer:"&"},templateUrl:"assets/templates/track.html",link:function(o,i,a){t&&e.debug(o),n.load().then(function(t){o.safeApply=function(t){var e=this.$root.$$phase;"$apply"==e||"$digest"==e?t&&"function"==typeof t&&t():this.$apply(t)};var n=(o.data,o.view.viewpoint.chromStart),a=o.view.viewpoint.chromEnd,s=(o.view.settings.cursorWidth,parseInt(o.view.settings.margin)),c={top:parseInt(o.view.settings.padding.top),right:parseInt(o.view.settings.padding.right),bottom:parseInt(o.view.settings.padding.bottom),left:parseInt(o.view.settings.padding.left)},l=parseInt(o.view.settings.heightInner),u=i[0].parentNode;e.debug(u.clientWidth);var d=i[0].children[0].children[3];e.debug(d.clientWidth);var p,g,f,m,h,v,w,b,y,x,k=t.select(d).append("svg");o.$watch(function(){var t=u.clientWidth,e=u.clientHeight;return t+e},function(){o.render()}),o.$watch("settings.current.position",function(t,e){t!==e&&o.update()}),o.render=function(){k.selectAll("*").remove();var e=u.clientWidth-2*s-c.left-c.right,r=l-c.bottom-c.top;g=t.scale.linear().range([0,e]).clamp(!0),g.domain([n,a]),w=t.svg.axis().scale(g).orient("bottom").ticks(4),f=t.svg.axis().orient("left"),m=t.svg.axis().orient("right"),h=.5*r,v=l,b=t.svg.brush().x(g).extent([0,0]).on("brush",o.brushed),p=k.attr("width",e+c.left+c.right).attr("height",r+c.top+c.bottom).append("g").attr("transform","translate("+c.left+", 0)");var i=p.append("g").attr("class","labels");i.append("text").attr("x",-16).attr("y",26).style("text-anchor","right").style("font-size","10px").text("3'"),i.append("text").attr("x",e+8).attr("y",26).style("text-anchor","left").style("font-size","10px").text("5'");p.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(w).select(".domain").select(function(){return this.parentNode.appendChild(this.cloneNode(!0))}).attr("class","halo");p.append("g").attr("class","slider").call(b),p.select(".background").attr("y",r/2).attr("height",r),y=p.append("circle").attr("id","handle").attr("class","handle").attr("cx",g(o.settings.current.position)).attr("cy",r).attr("r",.6*h),x=p.append("text").attr("id","position").attr("x",g(o.settings.current.position)-.5*h).attr("y",r-10).style("text-anchor","bottom").style("font-family","sans-serif").style("font-size","10px").style("color","#333").text(o.settings.current.particle),p.call(b.extent([o.settings.current.position,0])).call(b.event)},o.update=function(t){k.select("#handle").attr("cx",g(o.settings.current.position)),k.select("#position").attr("x",g(o.settings.current.position)-.5*h).text(o.settings.current.particle)},o.brushed=function(){var e=this;o.safeApply(function(){var n=b.extent()[0];t.event.sourceEvent&&(n=parseInt(g.invert(t.mouse(e)[0])),b.extent([n,n])),y.attr("cx",g(n)),o.settings.current.position=n,o.settings.current.particle=r.getParticle(),o.settings.current.segment=r.getSegment(),o.settings.current.segmentLower=o.settings.current.position-5*o.settings.current.segment,o.settings.current.segmentUpper=o.settings.current.position+5*o.settings.current.segment})}})}}}angular.module("TADkit").directive("tkComponentTrackSlider",t),t.$inject=["VERBOSE","$log","d3Service","Settings"]}(),function(){"use strict";function t(t){return{restrict:"EA",scope:{title:"=",content:"=",sorting:"=",styling:"="},templateUrl:"assets/templates/track-tooltip.html",link:function(t,e,n){if(t.content){t.title.replace("_name","");var r=angular.element(e).prop("offsetHeight");t.$watch(function(){r=angular.element(e).prop("offsetHeight"),angular.element(e).css("top","-"+r+"px")});var o=t.styling.width,i=t.styling.padding,a=.5*o-.5*i,s=t.styling.background;e.css({position:"absolute",display:"block",background:s,color:"white","border-radius":i+"pxñ    ",padding:i+"px",width:o+"px",opacity:0,"z-index":2}),t.tkTooltipTitle={"font-weight":"bold","margin-bottom":"10px","text-transform":"capitalize"},t.tkTooltipContent={"font-size":"0.7rem"},t.tkTooltipList={},t.tkTooltipTerm={"float":"left",clear:"left",width:"50px","font-weight":"bold"},t.tkTooltipDescription={margin:"0 0 0 50px",padding:"0 0 0.2em 0"},t.tkTooltipArrow={position:"absolute",bottom:"-"+i+"px",left:a+"px",width:0,height:0,"border-right":i+"px solid transparent","border-left":i+"px solid transparent","border-top":i+"px solid "+s,"font-size":0,"line-height":0}}}}}angular.module("TADkit").directive("tkTooltip",t),t.$inject=["$timeout"]}(),function(){"use strict";function t(t,e,n){return{restrict:"EA",scope:{type:"=",title:"@",settings:"=",view:"=",data:"=",layer:"=",togglelayer:"&"},templateUrl:"assets/templates/track.html",link:function(r,o,i){n.load().then(function(n){t&&e.debug(r);var i,a,s,c,l,u,d,p=r.data,g=r.view.settings.step,f=r.view.viewpoint.chromStart,m=r.view.viewpoint.chromEnd,h=m-f,v=parseInt(r.view.settings.margin),w={top:parseInt(r.view.settings.padding.top),right:parseInt(r.view.settings.padding.right),bottom:parseInt(r.view.settings.padding.bottom),left:parseInt(r.view.settings.padding.left)},b=parseInt(r.view.settings.heightInner),y=.5*b,x=.5*(b-y),k=r.view.settings.color,C=o[0].parentNode,E=o[0].children[0].children[3],S=n.select(E).append("svg");r.$watch(function(){var t=C.clientWidth,e=C.clientHeight;return t+e},function(){r.render(p)}),r.$watch("settings.current.position",function(t){r.update()},!0);n.behavior.zoom().on("zoom",function(){r.update()});r.render=function(t){if(S.selectAll("*").remove(),t){var e=C.clientWidth-2*v-w.left-w.right,o=b-w.top-w.bottom;i=g*e/h,d=n.scale.linear().range([0,e]).clamp(!0),d.domain([f,m]),c=n.svg.axis().scale(d).orient("top").ticks(0).outerTickSize(0);var p=2;a=S.attr("width",e+w.left+w.right).attr("height",o+w.top+w.bottom).append("g").attr("transform","translate("+w.left+","+w.top+")"),s=a.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",e).attr("height",o).style("fill","white"),l=a.append("g").attr("class","focus"),u=l.append("g").attr("class","container").attr("clip-path","url(#clip)");a.append("g").attr("class","labels"),u.selectAll("rect").data(t).enter().append("rect").attr("x",function(t,e){return(e+1)*i}).attr("y",x).attr("width",i).attr("height",y).style("fill",k).style("fill-opacity",function(t){return t}).style("stroke",k).style("stroke-width",0).append("svg:title").text(function(t,e){return e+":"+t}),a.append("rect").attr("id","highlight").attr("x",function(t){return d(r.settings.current.position-.5*g)}).attr("y",0).attr("width",p).attr("height",b).attr("class","highlight-follow")}},r.update=function(){S.select("#highlight").attr("x",function(t){return d(r.settings.current.position-.5*g)})}})}}}angular.module("TADkit").directive("tkComponentWiggle0",t),t.$inject=["VERBOSE","$log","d3Service"]}(),function(){"use strict";function t(t,e){e.optionsState=!1,e.toggleOptions=function(){e.optionsState=!e.optionsState}}angular.module("TADkit").controller("TrackController",t),t.$inject=["$log","$scope"]}(),function(){"use strict";function t(e,n,r,o,i,a,s,c){r.fileTitle="No file loaded",r.$on("$viewContentLoaded",function(){function i(t,n,r){e.debug(t),e.debug("Showing dialog")}var a=angular.element(document.body),s="assets/templates/"+n.current.name+".html";o.show({parent:a,templateUrl:s,controller:t,locals:{layers:r.$parent.layers},onComplete:i}).then(function(t){e.info('Dataset "'+t+'" added.')},function(){e.log("Layers import cancelled. No tracks added."),n.go("browser")})}),r.previewData=function(t){e.info("Previewing..."),r.preview=s.preview(t),e.info("Data fetched - pending selection...")},r.importData=function(){e.info("Import selected data...");var t=s["import"](r.preview);e.info("Import complete."),o.hide(t.object.title),n.go("browser")},r.cancel=function(){o.cancel()}}angular.module("TADkit").controller("DataImportController",t),t.$inject=["$log","$state","$scope","$mdDialog","$mdToast","DataImport","Datasets","Layers"]}(),function(){"use strict";function t(t,e){return{restrict:"A",scope:{tkDataImport:"&",filetitle:"="},link:function(e,n,r){n.on("change",function(n){var r=new FileReader;r.onload=function(n){e.$apply(function(){t.debug("Fetching Import results...."),e.tkDataImport({$fileContent:n.target.result})})},r.readAsText((n.srcElement||n.target).files[0]),e.filetitle=(n.srcElement||n.target).files[0].name})}}}angular.module("TADkit").directive("tkDataImport",t),t.$inject=["$log","$parse"]}(),function(){"use strict";function t(t,e,n){e.toggleSetting=function(t){e.settings=n.toggle(t)}}angular.module("TADkit").controller("SidebarBrowserController",t),t.$inject=["$log","$scope","Settings"]}(),function(){"use strict";function t(t,e,n,r,o,i,a,s,c){angular.element(e).on("resize",function(){n.$apply()}),n.settings.views.scale=1,o.setViewpoint(),n.allProximities=s.get(),n.currentProximities=s.get(n.settings.current.particle),n.currentRestraints=c.get(n.settings.current.particle),n.components=o.getComponents(),angular.forEach(n.components,function(t,e){var r;"scene"==t.object.type?(t.data=n.current.model.data,t.proximities=n.allProximities,t.layer=n.current.layer,t.layer.state={},t.layer.object.state.index=a.getCurrentIndex()):"track-genes"==t.object.type||"panel-inspector"==t.object.type?(r=a.getLayerById("genes"),t.data=r.data,t.layer=r):"track-proximities"==t.object.type?(t.data=n.currentProximities,r=a.getLayerById("proximities"),t.layer=r):"track-restraints"==t.object.type&&(t.data=n.currentRestraints,r=a.getLayerById("restraints"),t.layer=r)}),n.$watch("settings.current.particle",function(e,r){e!==r&&(n.currentProximities=s.get(e),n.currentRestraints=c.get(e),"matrix"==n.current.layer.object.type&&(a.at(e),n.current.layer=a.getLayer()),t.debug(n.currentProximities))}),n.layerOrig=n.current.layer,n.toggleLayer=function(e){n.overlaid=a.getLayer(e).object.state.overlaid,n.overlaid?(a.setOverlaid(n.layerOrig.object.state.index),a.set(n.layerOrig.object.state.index),n.current.layer=a.getLayer()):(a.setOverlaid(e),a.set(e),n.current.layer=a.getLayer(),t.debug(n.current.layer))},n.optionsState=!1,n.toggleOptions=function(){n.optionsState=!n.optionsState},n.toggle=function(e){e=!e,t.debug(e)},n.testfn=function(){t.debug("test worked")}}angular.module("TADkit").controller("StoryboardController",t),t.$inject=["$log","$window","$scope","Settings","Storyboards","Components","Layers","Proximities","Restraints"]}(),function(){"use strict";function t(t){}angular.module("TADkit").controller("HomeController",t),t.$inject=["$scope"]}(),function(){"use strict";function t(t,e,n,r,o,i,a){t.debug(n),n.clusterComponent=i.getComponentById("dataset-clusters");var s=o.getLayerById("gradient"),c=n.current.model.data.length/n.current.dataset.object.components,l=a.gradientHCL(s,c);n.clusterComponent.layer=l;for(var u=new THREE.BufferGeometry,d=n.current.dataset.models.length-1;d>=0;d--)u.addAttribute("position",new THREE.BufferAttribute(n.current.dataset.models[d].data,3));u.computeBoundingSphere(),t.debug(u.boundingSphere.center),t.debug(u.boundingSphere.radius),n.clusterComponent.view.viewpoint.camera=u.boundingSphere.center,n.clusterComponent.view.viewpoint.target=u.boundingSphere.center,n.clusterComponent.view.viewpoint.translate=u.boundingSphere.radius*u.boundingSphere.scale,n.clusters=r.get(),t.debug(n.clusters)}angular.module("TADkit").controller("ProjectDatasetController",t),t.$inject=["$log","$state","$scope","Clusters","Layers","Components","Segments"]}(),function(){"use strict";function t(t,e,n,r,o,i,a,s,c){o.updateCurrent=function(){o.current.dataset=i.getDataset(),o.current.model=a.getModel(),o.current.layer=s.getLayer(),t.info("Current dataset, model, layer and storyboard updated.")},o.loadDatasetFromParam=function(){var a=i.load(r.loadDataset);return e.all([a]).then(function(e){o.updateCurrent(),t.info("Dataset loaded: "+r.loadDataset),n.go("browser")})},r.loadDataset&&o.loadDatasetFromParam(),o.addDataset=function(r){var a=i["import"](r);return e.all([a]).then(function(e){o.updateCurrent(),t.info("Dataset added."),n.go("dataset")})}}angular.module("TADkit").controller("ProjectLoaderController",t),t.$inject=["$log","$q","$state","$stateParams","$scope","Datasets","Clusters","Layers","Storyboards"]}(),function(){"use strict";function t(t,e,n,r){t.setCurrentDataset=function(t){e.set(t)},t.setCurrentLayer=function(t){n.set(t)},t.setCurrentStoryboard=function(t){r.set(t)}}angular.module("TADkit").controller("ProjectController",t),t.$inject=["$scope","Datasets","Layers","Storyboards"]}(),function(){"use strict";function t(t,e,n,r,o,i,a,s,c,l){n.settings||(n.settings=r.get()),n.settings.app.isProject=t.is("project"),n.$on("$stateChangeSuccess",function(){n.settings.app.isProject=t.is("project")}),n.current={},n.current.dataset=a.getDataset(),n.current.model=s.getModel(),n.current.layer=c.getLayer()}angular.module("TADkit").controller("MainController",t),t.$inject=["$state","$stateParams","$scope","Settings","Users","Projects","Datasets","Clusters","Layers","Storyboards"]}(),function(){"use strict";function t(t){}angular.module("TADkit").controller("SidebarUserController",t),t.$inject=["$scope"]}(),function(){"use strict";function t(t,e,n){e.$state=t,e.toggleLeft=function(){n("left").toggle()},e.toggleRight=function(){n("right").toggle()}}angular.module("TADkit").controller("TopbarController",t),t.$inject=["$state","$scope","$mdSidenav"]}();